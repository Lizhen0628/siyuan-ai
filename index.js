"use strict";var Xw=Object.defineProperty;var Qw=(t,e,n)=>e in t?Xw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var Ie=(t,e,n)=>Qw(t,typeof e!="symbol"?e+"":e,n);const An=require("siyuan");var eT=Object.defineProperty,tT=(t,e,n)=>e in t?eT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,un=(t,e,n)=>tT(t,typeof e!="symbol"?e+"":e,n);function wb(t,e){return function(){return t.apply(e,arguments)}}const{toString:nT}=Object.prototype,{getPrototypeOf:Kh}=Object,_c=(t=>e=>{const n=nT.call(e);return t[n]||(t[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),zn=t=>(t=t.toLowerCase(),e=>_c(e)===t),yc=t=>e=>typeof e===t,{isArray:ga}=Array,Ti=yc("undefined");function rT(t){return t!==null&&!Ti(t)&&t.constructor!==null&&!Ti(t.constructor)&&dn(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const Tb=zn("ArrayBuffer");function sT(t){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(t):e=t&&t.buffer&&Tb(t.buffer),e}const aT=yc("string"),dn=yc("function"),Sb=yc("number"),Ec=t=>t!==null&&typeof t=="object",iT=t=>t===!0||t===!1,hu=t=>{if(_c(t)!=="object")return!1;const e=Kh(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},oT=zn("Date"),uT=zn("File"),cT=zn("Blob"),lT=zn("FileList"),dT=t=>Ec(t)&&dn(t.pipe),hT=t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||dn(t.append)&&((e=_c(t))==="formdata"||e==="object"&&dn(t.toString)&&t.toString()==="[object FormData]"))},fT=zn("URLSearchParams"),[mT,pT,gT,bT]=["ReadableStream","Request","Response","Headers"].map(zn),_T=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Qi(t,e,{allOwnKeys:n=!1}={}){if(t===null||typeof t>"u")return;let r,s;if(typeof t!="object"&&(t=[t]),ga(t))for(r=0,s=t.length;r<s;r++)e.call(null,t[r],r,t);else{const a=n?Object.getOwnPropertyNames(t):Object.keys(t),i=a.length;let o;for(r=0;r<i;r++)o=a[r],e.call(null,t[o],o,t)}}function Ab(t,e){e=e.toLowerCase();const n=Object.keys(t);let r=n.length,s;for(;r-- >0;)if(s=n[r],e===s.toLowerCase())return s;return null}const as=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Cb=t=>!Ti(t)&&t!==as;function Nd(){const{caseless:t}=Cb(this)&&this||{},e={},n=(r,s)=>{const a=t&&Ab(e,s)||s;hu(e[a])&&hu(r)?e[a]=Nd(e[a],r):hu(r)?e[a]=Nd({},r):ga(r)?e[a]=r.slice():e[a]=r};for(let r=0,s=arguments.length;r<s;r++)arguments[r]&&Qi(arguments[r],n);return e}const yT=(t,e,n,{allOwnKeys:r}={})=>(Qi(e,(s,a)=>{n&&dn(s)?t[a]=wb(s,n):t[a]=s},{allOwnKeys:r}),t),ET=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),wT=(t,e,n,r)=>{t.prototype=Object.create(e.prototype,r),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},TT=(t,e,n,r)=>{let s,a,i;const o={};if(e=e||{},t==null)return e;do{for(s=Object.getOwnPropertyNames(t),a=s.length;a-- >0;)i=s[a],(!r||r(i,t,e))&&!o[i]&&(e[i]=t[i],o[i]=!0);t=n!==!1&&Kh(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},ST=(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;const r=t.indexOf(e,n);return r!==-1&&r===n},AT=t=>{if(!t)return null;if(ga(t))return t;let e=t.length;if(!Sb(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},CT=(t=>e=>t&&e instanceof t)(typeof Uint8Array<"u"&&Kh(Uint8Array)),OT=(t,e)=>{const n=(t&&t[Symbol.iterator]).call(t);let r;for(;(r=n.next())&&!r.done;){const s=r.value;e.call(t,s[0],s[1])}},vT=(t,e)=>{let n;const r=[];for(;(n=t.exec(e))!==null;)r.push(n);return r},IT=zn("HTMLFormElement"),kT=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,r){return n.toUpperCase()+r}),Rm=(({hasOwnProperty:t})=>(e,n)=>t.call(e,n))(Object.prototype),NT=zn("RegExp"),Ob=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),r={};Qi(n,(s,a)=>{let i;(i=e(s,a,t))!==!1&&(r[a]=i||s)}),Object.defineProperties(t,r)},RT=t=>{Ob(t,(e,n)=>{if(dn(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const r=t[n];if(dn(r)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")})}})},PT=(t,e)=>{const n={},r=s=>{s.forEach(a=>{n[a]=!0})};return ga(t)?r(t):r(String(t).split(e)),n},xT=()=>{},LT=(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,pl="abcdefghijklmnopqrstuvwxyz",Pm="0123456789",vb={DIGIT:Pm,ALPHA:pl,ALPHA_DIGIT:pl+pl.toUpperCase()+Pm},DT=(t=16,e=vb.ALPHA_DIGIT)=>{let n="";const{length:r}=e;for(;t--;)n+=e[Math.random()*r|0];return n};function MT(t){return!!(t&&dn(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])}const BT=t=>{const e=new Array(10),n=(r,s)=>{if(Ec(r)){if(e.indexOf(r)>=0)return;if(!("toJSON"in r)){e[s]=r;const a=ga(r)?[]:{};return Qi(r,(i,o)=>{const u=n(i,s+1);!Ti(u)&&(a[o]=u)}),e[s]=void 0,a}}return r};return n(t,0)},FT=zn("AsyncFunction"),UT=t=>t&&(Ec(t)||dn(t))&&dn(t.then)&&dn(t.catch),Ib=((t,e)=>t?setImmediate:e?((n,r)=>(as.addEventListener("message",({source:s,data:a})=>{s===as&&a===n&&r.length&&r.shift()()},!1),s=>{r.push(s),as.postMessage(n,"*")}))(`axios@${Math.random()}`,[]):n=>setTimeout(n))(typeof setImmediate=="function",dn(as.postMessage)),jT=typeof queueMicrotask<"u"?queueMicrotask.bind(as):typeof process<"u"&&process.nextTick||Ib,j={isArray:ga,isArrayBuffer:Tb,isBuffer:rT,isFormData:hT,isArrayBufferView:sT,isString:aT,isNumber:Sb,isBoolean:iT,isObject:Ec,isPlainObject:hu,isReadableStream:mT,isRequest:pT,isResponse:gT,isHeaders:bT,isUndefined:Ti,isDate:oT,isFile:uT,isBlob:cT,isRegExp:NT,isFunction:dn,isStream:dT,isURLSearchParams:fT,isTypedArray:CT,isFileList:lT,forEach:Qi,merge:Nd,extend:yT,trim:_T,stripBOM:ET,inherits:wT,toFlatObject:TT,kindOf:_c,kindOfTest:zn,endsWith:ST,toArray:AT,forEachEntry:OT,matchAll:vT,isHTMLForm:IT,hasOwnProperty:Rm,hasOwnProp:Rm,reduceDescriptors:Ob,freezeMethods:RT,toObjectSet:PT,toCamelCase:kT,noop:xT,toFiniteNumber:LT,findKey:Ab,global:as,isContextDefined:Cb,ALPHABET:vb,generateString:DT,isSpecCompliantForm:MT,toJSONObject:BT,isAsyncFn:FT,isThenable:UT,setImmediate:Ib,asap:jT};function Ee(t,e,n,r,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),r&&(this.request=r),s&&(this.response=s,this.status=s.status?s.status:null)}j.inherits(Ee,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:j.toJSONObject(this.config),code:this.code,status:this.status}}});const kb=Ee.prototype,Nb={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Nb[t]={value:t}});Object.defineProperties(Ee,Nb);Object.defineProperty(kb,"isAxiosError",{value:!0});Ee.from=(t,e,n,r,s,a)=>{const i=Object.create(kb);return j.toFlatObject(t,i,function(o){return o!==Error.prototype},o=>o!=="isAxiosError"),Ee.call(i,t.message,e,n,r,s),i.cause=t,i.name=t.name,a&&Object.assign(i,a),i};const HT=null;function Rd(t){return j.isPlainObject(t)||j.isArray(t)}function Rb(t){return j.endsWith(t,"[]")?t.slice(0,-2):t}function xm(t,e,n){return t?t.concat(e).map(function(r,s){return r=Rb(r),!n&&s?"["+r+"]":r}).join(n?".":""):e}function $T(t){return j.isArray(t)&&!t.some(Rd)}const qT=j.toFlatObject(j,{},null,function(t){return/^is[A-Z]/.test(t)});function wc(t,e,n){if(!j.isObject(t))throw new TypeError("target must be an object");e=e||new FormData,n=j.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(p,f){return!j.isUndefined(f[p])});const r=n.metaTokens,s=n.visitor||c,a=n.dots,i=n.indexes,o=(n.Blob||typeof Blob<"u"&&Blob)&&j.isSpecCompliantForm(e);if(!j.isFunction(s))throw new TypeError("visitor must be a function");function u(p){if(p===null)return"";if(j.isDate(p))return p.toISOString();if(!o&&j.isBlob(p))throw new Ee("Blob is not supported. Use a Buffer instead.");return j.isArrayBuffer(p)||j.isTypedArray(p)?o&&typeof Blob=="function"?new Blob([p]):Buffer.from(p):p}function c(p,f,g){let b=p;if(p&&!g&&typeof p=="object"){if(j.endsWith(f,"{}"))f=r?f:f.slice(0,-2),p=JSON.stringify(p);else if(j.isArray(p)&&$T(p)||(j.isFileList(p)||j.endsWith(f,"[]"))&&(b=j.toArray(p)))return f=Rb(f),b.forEach(function(_,y){!(j.isUndefined(_)||_===null)&&e.append(i===!0?xm([f],y,a):i===null?f:f+"[]",u(_))}),!1}return Rd(p)?!0:(e.append(xm(g,f,a),u(p)),!1)}const l=[],d=Object.assign(qT,{defaultVisitor:c,convertValue:u,isVisitable:Rd});function m(p,f){if(!j.isUndefined(p)){if(l.indexOf(p)!==-1)throw Error("Circular reference detected in "+f.join("."));l.push(p),j.forEach(p,function(g,b){(!(j.isUndefined(g)||g===null)&&s.call(e,g,j.isString(b)?b.trim():b,f,d))===!0&&m(g,f?f.concat(b):[b])}),l.pop()}}if(!j.isObject(t))throw new TypeError("data must be an object");return m(t),e}function Lm(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function Yh(t,e){this._pairs=[],t&&wc(t,this,e)}const Pb=Yh.prototype;Pb.append=function(t,e){this._pairs.push([t,e])};Pb.toString=function(t){const e=t?function(n){return t.call(this,n,Lm)}:Lm;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};function VT(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function xb(t,e,n){if(!e)return t;const r=n&&n.encode||VT,s=n&&n.serialize;let a;if(s?a=s(e,n):a=j.isURLSearchParams(e)?e.toString():new Yh(e,n).toString(r),a){const i=t.indexOf("#");i!==-1&&(t=t.slice(0,i)),t+=(t.indexOf("?")===-1?"?":"&")+a}return t}class Dm{constructor(){this.handlers=[]}use(e,n,r){return this.handlers.push({fulfilled:e,rejected:n,synchronous:r?r.synchronous:!1,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){j.forEach(this.handlers,function(n){n!==null&&e(n)})}}const Lb={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},zT=typeof URLSearchParams<"u"?URLSearchParams:Yh,WT=typeof FormData<"u"?FormData:null,GT=typeof Blob<"u"?Blob:null,KT={isBrowser:!0,classes:{URLSearchParams:zT,FormData:WT,Blob:GT},protocols:["http","https","file","blob","url","data"]},Zh=typeof window<"u"&&typeof document<"u",Pd=typeof navigator=="object"&&navigator||void 0,YT=Zh&&(!Pd||["ReactNative","NativeScript","NS"].indexOf(Pd.product)<0),ZT=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",JT=Zh&&window.location.href||"http://localhost",XT=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Zh,hasStandardBrowserEnv:YT,hasStandardBrowserWebWorkerEnv:ZT,navigator:Pd,origin:JT},Symbol.toStringTag,{value:"Module"})),Qt={...XT,...KT};function QT(t,e){return wc(t,new Qt.classes.URLSearchParams,Object.assign({visitor:function(n,r,s,a){return Qt.isNode&&j.isBuffer(n)?(this.append(r,n.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},e))}function eS(t){return j.matchAll(/\w+|\[(\w*)]/g,t).map(e=>e[0]==="[]"?"":e[1]||e[0])}function tS(t){const e={},n=Object.keys(t);let r;const s=n.length;let a;for(r=0;r<s;r++)a=n[r],e[a]=t[a];return e}function Db(t){function e(n,r,s,a){let i=n[a++];if(i==="__proto__")return!0;const o=Number.isFinite(+i),u=a>=n.length;return i=!i&&j.isArray(s)?s.length:i,u?(j.hasOwnProp(s,i)?s[i]=[s[i],r]:s[i]=r,!o):((!s[i]||!j.isObject(s[i]))&&(s[i]=[]),e(n,r,s[i],a)&&j.isArray(s[i])&&(s[i]=tS(s[i])),!o)}if(j.isFormData(t)&&j.isFunction(t.entries)){const n={};return j.forEachEntry(t,(r,s)=>{e(eS(r),s,n,0)}),n}return null}function nS(t,e,n){if(j.isString(t))try{return(e||JSON.parse)(t),j.trim(t)}catch(r){if(r.name!=="SyntaxError")throw r}return(0,JSON.stringify)(t)}const eo={transitional:Lb,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){const n=e.getContentType()||"",r=n.indexOf("application/json")>-1,s=j.isObject(t);if(s&&j.isHTMLForm(t)&&(t=new FormData(t)),j.isFormData(t))return r?JSON.stringify(Db(t)):t;if(j.isArrayBuffer(t)||j.isBuffer(t)||j.isStream(t)||j.isFile(t)||j.isBlob(t)||j.isReadableStream(t))return t;if(j.isArrayBufferView(t))return t.buffer;if(j.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let a;if(s){if(n.indexOf("application/x-www-form-urlencoded")>-1)return QT(t,this.formSerializer).toString();if((a=j.isFileList(t))||n.indexOf("multipart/form-data")>-1){const i=this.env&&this.env.FormData;return wc(a?{"files[]":t}:t,i&&new i,this.formSerializer)}}return s||r?(e.setContentType("application/json",!1),nS(t)):t}],transformResponse:[function(t){const e=this.transitional||eo.transitional,n=e&&e.forcedJSONParsing,r=this.responseType==="json";if(j.isResponse(t)||j.isReadableStream(t))return t;if(t&&j.isString(t)&&(n&&!this.responseType||r)){const s=!(e&&e.silentJSONParsing)&&r;try{return JSON.parse(t)}catch(a){if(s)throw a.name==="SyntaxError"?Ee.from(a,Ee.ERR_BAD_RESPONSE,this,null,this.response):a}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Qt.classes.FormData,Blob:Qt.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};j.forEach(["delete","get","head","post","put","patch"],t=>{eo.headers[t]={}});const rS=j.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),sS=t=>{const e={};let n,r,s;return t&&t.split(`
`).forEach(function(a){s=a.indexOf(":"),n=a.substring(0,s).trim().toLowerCase(),r=a.substring(s+1).trim(),!(!n||e[n]&&rS[n])&&(n==="set-cookie"?e[n]?e[n].push(r):e[n]=[r]:e[n]=e[n]?e[n]+", "+r:r)}),e},Mm=Symbol("internals");function La(t){return t&&String(t).trim().toLowerCase()}function fu(t){return t===!1||t==null?t:j.isArray(t)?t.map(fu):String(t)}function aS(t){const e=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=n.exec(t);)e[r[1]]=r[2];return e}const iS=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function gl(t,e,n,r,s){if(j.isFunction(r))return r.call(this,e,n);if(s&&(e=n),!!j.isString(e)){if(j.isString(r))return e.indexOf(r)!==-1;if(j.isRegExp(r))return r.test(e)}}function oS(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,n,r)=>n.toUpperCase()+r)}function uS(t,e){const n=j.toCamelCase(" "+e);["get","set","has"].forEach(r=>{Object.defineProperty(t,r+n,{value:function(s,a,i){return this[r].call(this,e,s,a,i)},configurable:!0})})}let en=class{constructor(t){t&&this.set(t)}set(t,e,n){const r=this;function s(i,o,u){const c=La(o);if(!c)throw new Error("header name must be a non-empty string");const l=j.findKey(r,c);(!l||r[l]===void 0||u===!0||u===void 0&&r[l]!==!1)&&(r[l||o]=fu(i))}const a=(i,o)=>j.forEach(i,(u,c)=>s(u,c,o));if(j.isPlainObject(t)||t instanceof this.constructor)a(t,e);else if(j.isString(t)&&(t=t.trim())&&!iS(t))a(sS(t),e);else if(j.isHeaders(t))for(const[i,o]of t.entries())s(o,i,n);else t!=null&&s(e,t,n);return this}get(t,e){if(t=La(t),t){const n=j.findKey(this,t);if(n){const r=this[n];if(!e)return r;if(e===!0)return aS(r);if(j.isFunction(e))return e.call(this,r,n);if(j.isRegExp(e))return e.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,e){if(t=La(t),t){const n=j.findKey(this,t);return!!(n&&this[n]!==void 0&&(!e||gl(this,this[n],n,e)))}return!1}delete(t,e){const n=this;let r=!1;function s(a){if(a=La(a),a){const i=j.findKey(n,a);i&&(!e||gl(n,n[i],i,e))&&(delete n[i],r=!0)}}return j.isArray(t)?t.forEach(s):s(t),r}clear(t){const e=Object.keys(this);let n=e.length,r=!1;for(;n--;){const s=e[n];(!t||gl(this,this[s],s,t,!0))&&(delete this[s],r=!0)}return r}normalize(t){const e=this,n={};return j.forEach(this,(r,s)=>{const a=j.findKey(n,s);if(a){e[a]=fu(r),delete e[s];return}const i=t?oS(s):String(s).trim();i!==s&&delete e[s],e[i]=fu(r),n[i]=!0}),this}concat(...t){return this.constructor.concat(this,...t)}toJSON(t){const e=Object.create(null);return j.forEach(this,(n,r)=>{n!=null&&n!==!1&&(e[r]=t&&j.isArray(n)?n.join(", "):n)}),e}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([t,e])=>t+": "+e).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t,...e){const n=new this(t);return e.forEach(r=>n.set(r)),n}static accessor(t){const e=(this[Mm]=this[Mm]={accessors:{}}).accessors,n=this.prototype;function r(s){const a=La(s);e[a]||(uS(n,s),e[a]=!0)}return j.isArray(t)?t.forEach(r):r(t),this}};en.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);j.reduceDescriptors(en.prototype,({value:t},e)=>{let n=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(r){this[n]=r}}});j.freezeMethods(en);function bl(t,e){const n=this||eo,r=e||n,s=en.from(r.headers);let a=r.data;return j.forEach(t,function(i){a=i.call(n,a,s.normalize(),e?e.status:void 0)}),s.normalize(),a}function Mb(t){return!!(t&&t.__CANCEL__)}function ba(t,e,n){Ee.call(this,t??"canceled",Ee.ERR_CANCELED,e,n),this.name="CanceledError"}j.inherits(ba,Ee,{__CANCEL__:!0});function Bb(t,e,n){const r=n.config.validateStatus;!n.status||!r||r(n.status)?t(n):e(new Ee("Request failed with status code "+n.status,[Ee.ERR_BAD_REQUEST,Ee.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n))}function cS(t){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}function lS(t,e){t=t||10;const n=new Array(t),r=new Array(t);let s=0,a=0,i;return e=e!==void 0?e:1e3,function(o){const u=Date.now(),c=r[a];i||(i=u),n[s]=o,r[s]=u;let l=a,d=0;for(;l!==s;)d+=n[l++],l=l%t;if(s=(s+1)%t,s===a&&(a=(a+1)%t),u-i<e)return;const m=c&&u-c;return m?Math.round(d*1e3/m):void 0}}function dS(t,e){let n=0,r=1e3/e,s,a;const i=(o,u=Date.now())=>{n=u,s=null,a&&(clearTimeout(a),a=null),t.apply(null,o)};return[(...o)=>{const u=Date.now(),c=u-n;c>=r?i(o,u):(s=o,a||(a=setTimeout(()=>{a=null,i(s)},r-c)))},()=>s&&i(s)]}const Iu=(t,e,n=3)=>{let r=0;const s=lS(50,250);return dS(a=>{const i=a.loaded,o=a.lengthComputable?a.total:void 0,u=i-r,c=s(u),l=i<=o;r=i;const d={loaded:i,total:o,progress:o?i/o:void 0,bytes:u,rate:c||void 0,estimated:c&&o&&l?(o-i)/c:void 0,event:a,lengthComputable:o!=null,[e?"download":"upload"]:!0};t(d)},n)},Bm=(t,e)=>{const n=t!=null;return[r=>e[0]({lengthComputable:n,total:t,loaded:r}),e[1]]},Fm=t=>(...e)=>j.asap(()=>t(...e)),hS=Qt.hasStandardBrowserEnv?function(){const t=Qt.navigator&&/(msie|trident)/i.test(Qt.navigator.userAgent),e=document.createElement("a");let n;function r(s){let a=s;return t&&(e.setAttribute("href",a),a=e.href),e.setAttribute("href",a),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:e.pathname.charAt(0)==="/"?e.pathname:"/"+e.pathname}}return n=r(window.location.href),function(s){const a=j.isString(s)?r(s):s;return a.protocol===n.protocol&&a.host===n.host}}():function(){return function(){return!0}}(),fS=Qt.hasStandardBrowserEnv?{write(t,e,n,r,s,a){const i=[t+"="+encodeURIComponent(e)];j.isNumber(n)&&i.push("expires="+new Date(n).toGMTString()),j.isString(r)&&i.push("path="+r),j.isString(s)&&i.push("domain="+s),a===!0&&i.push("secure"),document.cookie=i.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function mS(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function pS(t,e){return e?t.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):t}function Fb(t,e){return t&&!mS(e)?pS(t,e):e}const Um=t=>t instanceof en?{...t}:t;function gs(t,e){e=e||{};const n={};function r(c,l,d){return j.isPlainObject(c)&&j.isPlainObject(l)?j.merge.call({caseless:d},c,l):j.isPlainObject(l)?j.merge({},l):j.isArray(l)?l.slice():l}function s(c,l,d){if(j.isUndefined(l)){if(!j.isUndefined(c))return r(void 0,c,d)}else return r(c,l,d)}function a(c,l){if(!j.isUndefined(l))return r(void 0,l)}function i(c,l){if(j.isUndefined(l)){if(!j.isUndefined(c))return r(void 0,c)}else return r(void 0,l)}function o(c,l,d){if(d in e)return r(c,l);if(d in t)return r(void 0,c)}const u={url:a,method:a,data:a,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:o,headers:(c,l)=>s(Um(c),Um(l),!0)};return j.forEach(Object.keys(Object.assign({},t,e)),function(c){const l=u[c]||s,d=l(t[c],e[c],c);j.isUndefined(d)&&l!==o||(n[c]=d)}),n}const Ub=t=>{const e=gs({},t);let{data:n,withXSRFToken:r,xsrfHeaderName:s,xsrfCookieName:a,headers:i,auth:o}=e;e.headers=i=en.from(i),e.url=xb(Fb(e.baseURL,e.url),t.params,t.paramsSerializer),o&&i.set("Authorization","Basic "+btoa((o.username||"")+":"+(o.password?unescape(encodeURIComponent(o.password)):"")));let u;if(j.isFormData(n)){if(Qt.hasStandardBrowserEnv||Qt.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((u=i.getContentType())!==!1){const[c,...l]=u?u.split(";").map(d=>d.trim()).filter(Boolean):[];i.setContentType([c||"multipart/form-data",...l].join("; "))}}if(Qt.hasStandardBrowserEnv&&(r&&j.isFunction(r)&&(r=r(e)),r||r!==!1&&hS(e.url))){const c=s&&a&&fS.read(a);c&&i.set(s,c)}return e},gS=typeof XMLHttpRequest<"u",bS=gS&&function(t){return new Promise(function(e,n){const r=Ub(t);let s=r.data;const a=en.from(r.headers).normalize();let{responseType:i,onUploadProgress:o,onDownloadProgress:u}=r,c,l,d,m,p;function f(){m&&m(),p&&p(),r.cancelToken&&r.cancelToken.unsubscribe(c),r.signal&&r.signal.removeEventListener("abort",c)}let g=new XMLHttpRequest;g.open(r.method.toUpperCase(),r.url,!0),g.timeout=r.timeout;function b(){if(!g)return;const y=en.from("getAllResponseHeaders"in g&&g.getAllResponseHeaders()),S={data:!i||i==="text"||i==="json"?g.responseText:g.response,status:g.status,statusText:g.statusText,headers:y,config:t,request:g};Bb(function(I){e(I),f()},function(I){n(I),f()},S),g=null}"onloadend"in g?g.onloadend=b:g.onreadystatechange=function(){!g||g.readyState!==4||g.status===0&&!(g.responseURL&&g.responseURL.indexOf("file:")===0)||setTimeout(b)},g.onabort=function(){g&&(n(new Ee("Request aborted",Ee.ECONNABORTED,t,g)),g=null)},g.onerror=function(){n(new Ee("Network Error",Ee.ERR_NETWORK,t,g)),g=null},g.ontimeout=function(){let y=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const S=r.transitional||Lb;r.timeoutErrorMessage&&(y=r.timeoutErrorMessage),n(new Ee(y,S.clarifyTimeoutError?Ee.ETIMEDOUT:Ee.ECONNABORTED,t,g)),g=null},s===void 0&&a.setContentType(null),"setRequestHeader"in g&&j.forEach(a.toJSON(),function(y,S){g.setRequestHeader(S,y)}),j.isUndefined(r.withCredentials)||(g.withCredentials=!!r.withCredentials),i&&i!=="json"&&(g.responseType=r.responseType),u&&([d,p]=Iu(u,!0),g.addEventListener("progress",d)),o&&g.upload&&([l,m]=Iu(o),g.upload.addEventListener("progress",l),g.upload.addEventListener("loadend",m)),(r.cancelToken||r.signal)&&(c=y=>{g&&(n(!y||y.type?new ba(null,t,g):y),g.abort(),g=null)},r.cancelToken&&r.cancelToken.subscribe(c),r.signal&&(r.signal.aborted?c():r.signal.addEventListener("abort",c)));const _=cS(r.url);if(_&&Qt.protocols.indexOf(_)===-1){n(new Ee("Unsupported protocol "+_+":",Ee.ERR_BAD_REQUEST,t));return}g.send(s||null)})},_S=(t,e)=>{const{length:n}=t=t?t.filter(Boolean):[];if(e||n){let r=new AbortController,s;const a=function(c){if(!s){s=!0,o();const l=c instanceof Error?c:this.reason;r.abort(l instanceof Ee?l:new ba(l instanceof Error?l.message:l))}};let i=e&&setTimeout(()=>{i=null,a(new Ee(`timeout ${e} of ms exceeded`,Ee.ETIMEDOUT))},e);const o=()=>{t&&(i&&clearTimeout(i),i=null,t.forEach(c=>{c.unsubscribe?c.unsubscribe(a):c.removeEventListener("abort",a)}),t=null)};t.forEach(c=>c.addEventListener("abort",a));const{signal:u}=r;return u.unsubscribe=()=>j.asap(o),u}},yS=function*(t,e){let n=t.byteLength;if(n<e){yield t;return}let r=0,s;for(;r<n;)s=r+e,yield t.slice(r,s),r=s},ES=async function*(t,e){for await(const n of wS(t))yield*yS(n,e)},wS=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const e=t.getReader();try{for(;;){const{done:n,value:r}=await e.read();if(n)break;yield r}}finally{await e.cancel()}},jm=(t,e,n,r)=>{const s=ES(t,e);let a=0,i,o=u=>{i||(i=!0,r&&r(u))};return new ReadableStream({async pull(u){try{const{done:c,value:l}=await s.next();if(c){o(),u.close();return}let d=l.byteLength;if(n){let m=a+=d;n(m)}u.enqueue(new Uint8Array(l))}catch(c){throw o(c),c}},cancel(u){return o(u),s.return()}},{highWaterMark:2})},Tc=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",jb=Tc&&typeof ReadableStream=="function",TS=Tc&&(typeof TextEncoder=="function"?(t=>e=>t.encode(e))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),Hb=(t,...e)=>{try{return!!t(...e)}catch{return!1}},SS=jb&&Hb(()=>{let t=!1;const e=new Request(Qt.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),Hm=64*1024,xd=jb&&Hb(()=>j.isReadableStream(new Response("").body)),ku={stream:xd&&(t=>t.body)};Tc&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!ku[e]&&(ku[e]=j.isFunction(t[e])?n=>n[e]():(n,r)=>{throw new Ee(`Response type '${e}' is not supported`,Ee.ERR_NOT_SUPPORT,r)})})})(new Response);const AS=async t=>{if(t==null)return 0;if(j.isBlob(t))return t.size;if(j.isSpecCompliantForm(t))return(await new Request(Qt.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(j.isArrayBufferView(t)||j.isArrayBuffer(t))return t.byteLength;if(j.isURLSearchParams(t)&&(t=t+""),j.isString(t))return(await TS(t)).byteLength},CS=async(t,e)=>j.toFiniteNumber(t.getContentLength())??AS(e),OS=Tc&&(async t=>{let{url:e,method:n,data:r,signal:s,cancelToken:a,timeout:i,onDownloadProgress:o,onUploadProgress:u,responseType:c,headers:l,withCredentials:d="same-origin",fetchOptions:m}=Ub(t);c=c?(c+"").toLowerCase():"text";let p=_S([s,a&&a.toAbortSignal()],i),f;const g=p&&p.unsubscribe&&(()=>{p.unsubscribe()});let b;try{if(u&&SS&&n!=="get"&&n!=="head"&&(b=await CS(l,r))!==0){let A=new Request(e,{method:"POST",body:r,duplex:"half"}),O;if(j.isFormData(r)&&(O=A.headers.get("content-type"))&&l.setContentType(O),A.body){const[w,L]=Bm(b,Iu(Fm(u)));r=jm(A.body,Hm,w,L)}}j.isString(d)||(d=d?"include":"omit");const _="credentials"in Request.prototype;f=new Request(e,{...m,signal:p,method:n.toUpperCase(),headers:l.normalize().toJSON(),body:r,duplex:"half",credentials:_?d:void 0});let y=await fetch(f);const S=xd&&(c==="stream"||c==="response");if(xd&&(o||S&&g)){const A={};["status","statusText","headers"].forEach(D=>{A[D]=y[D]});const O=j.toFiniteNumber(y.headers.get("content-length")),[w,L]=o&&Bm(O,Iu(Fm(o),!0))||[];y=new Response(jm(y.body,Hm,w,()=>{L&&L(),g&&g()}),A)}c=c||"text";let I=await ku[j.findKey(ku,c)||"text"](y,t);return!S&&g&&g(),await new Promise((A,O)=>{Bb(A,O,{data:I,headers:en.from(y.headers),status:y.status,statusText:y.statusText,config:t,request:f})})}catch(_){throw g&&g(),_&&_.name==="TypeError"&&/fetch/i.test(_.message)?Object.assign(new Ee("Network Error",Ee.ERR_NETWORK,t,f),{cause:_.cause||_}):Ee.from(_,_&&_.code,t,f)}}),Ld={http:HT,xhr:bS,fetch:OS};j.forEach(Ld,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const $m=t=>`- ${t}`,vS=t=>j.isFunction(t)||t===null||t===!1,$b={getAdapter:t=>{t=j.isArray(t)?t:[t];const{length:e}=t;let n,r;const s={};for(let a=0;a<e;a++){n=t[a];let i;if(r=n,!vS(n)&&(r=Ld[(i=String(n)).toLowerCase()],r===void 0))throw new Ee(`Unknown adapter '${i}'`);if(r)break;s[i||"#"+a]=r}if(!r){const a=Object.entries(s).map(([o,u])=>`adapter ${o} `+(u===!1?"is not supported by the environment":"is not available in the build"));let i=e?a.length>1?`since :
`+a.map($m).join(`
`):" "+$m(a[0]):"as no adapter specified";throw new Ee("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return r},adapters:Ld};function _l(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new ba(null,t)}function qm(t){return _l(t),t.headers=en.from(t.headers),t.data=bl.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),$b.getAdapter(t.adapter||eo.adapter)(t).then(function(e){return _l(t),e.data=bl.call(t,t.transformResponse,e),e.headers=en.from(e.headers),e},function(e){return Mb(e)||(_l(t),e&&e.response&&(e.response.data=bl.call(t,t.transformResponse,e.response),e.response.headers=en.from(e.response.headers))),Promise.reject(e)})}const qb="1.7.7",Jh={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{Jh[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});const Vm={};Jh.transitional=function(t,e,n){function r(s,a){return"[Axios v"+qb+"] Transitional option '"+s+"'"+a+(n?". "+n:"")}return(s,a,i)=>{if(t===!1)throw new Ee(r(a," has been removed"+(e?" in "+e:"")),Ee.ERR_DEPRECATED);return e&&!Vm[a]&&(Vm[a]=!0,console.warn(r(a," has been deprecated since v"+e+" and will be removed in the near future"))),t?t(s,a,i):!0}};function IS(t,e,n){if(typeof t!="object")throw new Ee("options must be an object",Ee.ERR_BAD_OPTION_VALUE);const r=Object.keys(t);let s=r.length;for(;s-- >0;){const a=r[s],i=e[a];if(i){const o=t[a],u=o===void 0||i(o,a,t);if(u!==!0)throw new Ee("option "+a+" must be "+u,Ee.ERR_BAD_OPTION_VALUE);continue}if(n!==!0)throw new Ee("Unknown option "+a,Ee.ERR_BAD_OPTION)}}const Dd={assertOptions:IS,validators:Jh},Pr=Dd.validators;let ls=class{constructor(t){this.defaults=t,this.interceptors={request:new Dm,response:new Dm}}async request(t,e){try{return await this._request(t,e)}catch(n){if(n instanceof Error){let r;Error.captureStackTrace?Error.captureStackTrace(r={}):r=new Error;const s=r.stack?r.stack.replace(/^.+\n/,""):"";try{n.stack?s&&!String(n.stack).endsWith(s.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+s):n.stack=s}catch{}}throw n}}_request(t,e){typeof t=="string"?(e=e||{},e.url=t):e=t||{},e=gs(this.defaults,e);const{transitional:n,paramsSerializer:r,headers:s}=e;n!==void 0&&Dd.assertOptions(n,{silentJSONParsing:Pr.transitional(Pr.boolean),forcedJSONParsing:Pr.transitional(Pr.boolean),clarifyTimeoutError:Pr.transitional(Pr.boolean)},!1),r!=null&&(j.isFunction(r)?e.paramsSerializer={serialize:r}:Dd.assertOptions(r,{encode:Pr.function,serialize:Pr.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let a=s&&j.merge(s.common,s[e.method]);s&&j.forEach(["delete","get","head","post","put","patch","common"],p=>{delete s[p]}),e.headers=en.concat(a,s);const i=[];let o=!0;this.interceptors.request.forEach(function(p){typeof p.runWhen=="function"&&p.runWhen(e)===!1||(o=o&&p.synchronous,i.unshift(p.fulfilled,p.rejected))});const u=[];this.interceptors.response.forEach(function(p){u.push(p.fulfilled,p.rejected)});let c,l=0,d;if(!o){const p=[qm.bind(this),void 0];for(p.unshift.apply(p,i),p.push.apply(p,u),d=p.length,c=Promise.resolve(e);l<d;)c=c.then(p[l++],p[l++]);return c}d=i.length;let m=e;for(l=0;l<d;){const p=i[l++],f=i[l++];try{m=p(m)}catch(g){f.call(this,g);break}}try{c=qm.call(this,m)}catch(p){return Promise.reject(p)}for(l=0,d=u.length;l<d;)c=c.then(u[l++],u[l++]);return c}getUri(t){t=gs(this.defaults,t);const e=Fb(t.baseURL,t.url);return xb(e,t.params,t.paramsSerializer)}};j.forEach(["delete","get","head","options"],function(t){ls.prototype[t]=function(e,n){return this.request(gs(n||{},{method:t,url:e,data:(n||{}).data}))}});j.forEach(["post","put","patch"],function(t){function e(n){return function(r,s,a){return this.request(gs(a||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:r,data:s}))}}ls.prototype[t]=e(),ls.prototype[t+"Form"]=e(!0)});let kS=class Vb{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(s){n=s});const r=this;this.promise.then(s=>{if(!r._listeners)return;let a=r._listeners.length;for(;a-- >0;)r._listeners[a](s);r._listeners=null}),this.promise.then=s=>{let a;const i=new Promise(o=>{r.subscribe(o),a=o}).then(s);return i.cancel=function(){r.unsubscribe(a)},i},e(function(s,a,i){r.reason||(r.reason=new ba(s,a,i),n(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const e=new AbortController,n=r=>{e.abort(r)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new Vb(function(n){e=n}),cancel:e}}};function NS(t){return function(e){return t.apply(null,e)}}function RS(t){return j.isObject(t)&&t.isAxiosError===!0}const Md={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Md).forEach(([t,e])=>{Md[e]=t});function zb(t){const e=new ls(t),n=wb(ls.prototype.request,e);return j.extend(n,ls.prototype,e,{allOwnKeys:!0}),j.extend(n,e,null,{allOwnKeys:!0}),n.create=function(r){return zb(gs(t,r))},n}const at=zb(eo);at.Axios=ls;at.CanceledError=ba;at.CancelToken=kS;at.isCancel=Mb;at.VERSION=qb;at.toFormData=wc;at.AxiosError=Ee;at.Cancel=at.CanceledError;at.all=function(t){return Promise.all(t)};at.spread=NS;at.isAxiosError=RS;at.mergeConfig=gs;at.AxiosHeaders=en;at.formToJSON=t=>Db(j.isHTMLForm(t)?new FormData(t):t);at.getAdapter=$b.getAdapter;at.HttpStatusCode=Md;at.default=at;const{Axios:CF,AxiosError:OF,CanceledError:vF,isCancel:IF,CancelToken:kF,VERSION:NF,all:RF,Cancel:PF,isAxiosError:xF,spread:LF,toFormData:DF,AxiosHeaders:PS,HttpStatusCode:Oo,formToJSON:MF,getAdapter:BF,mergeConfig:FF}=at;var js=null;typeof WebSocket<"u"?js=WebSocket:typeof MozWebSocket<"u"?js=MozWebSocket:typeof global<"u"?js=global.WebSocket||global.MozWebSocket:typeof window<"u"?js=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(js=self.WebSocket||self.MozWebSocket);const xS=js,Sc=typeof Buffer=="function";typeof TextDecoder=="function"&&new TextDecoder;typeof TextEncoder=="function"&&new TextEncoder;const LS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Ya=Array.prototype.slice.call(LS),vo=(t=>{let e={};return t.forEach((n,r)=>e[n]=r),e})(Ya),DS=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,mu=String.fromCharCode.bind(String),zm=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),MS=t=>t.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),Wb=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),BS=t=>{let e,n,r,s,a="";const i=t.length%3;for(let o=0;o<t.length;){if((n=t.charCodeAt(o++))>255||(r=t.charCodeAt(o++))>255||(s=t.charCodeAt(o++))>255)throw new TypeError("invalid character found");e=n<<16|r<<8|s,a+=Ya[e>>18&63]+Ya[e>>12&63]+Ya[e>>6&63]+Ya[e&63]}return i?a.slice(0,i-3)+"===".substring(i):a},FS=typeof btoa=="function"?t=>btoa(t):Sc?t=>Buffer.from(t,"binary").toString("base64"):BS,Wm=Sc?t=>Buffer.from(t).toString("base64"):t=>{let e=[];for(let n=0,r=t.length;n<r;n+=4096)e.push(mu.apply(null,t.subarray(n,n+4096)));return FS(e.join(""))},US=(t,e=!1)=>e?MS(Wm(t)):Wm(t),jS=t=>{if(t=t.replace(/\s+/g,""),!DS.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,n="",r,s;for(let a=0;a<t.length;)e=vo[t.charAt(a++)]<<18|vo[t.charAt(a++)]<<12|(r=vo[t.charAt(a++)])<<6|(s=vo[t.charAt(a++)]),n+=r===64?mu(e>>16&255):s===64?mu(e>>16&255,e>>8&255):mu(e>>16&255,e>>8&255,e&255);return n},HS=typeof atob=="function"?t=>atob(Wb(t)):Sc?t=>Buffer.from(t,"base64").toString("binary"):jS,$S=Sc?t=>zm(Buffer.from(t,"base64")):t=>zm(HS(t).split("").map(e=>e.charCodeAt(0))),qS=t=>$S(VS(t)),VS=t=>Wb(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),zS=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,WS=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,GS=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function KS(t,e){if(t==="__proto__"||t==="constructor"&&e&&typeof e=="object"&&"prototype"in e){YS(t);return}return e}function YS(t){console.warn(`[destr] Dropping "${t}" key to prevent prototype pollution.`)}function ZS(t,e={}){if(typeof t!="string")return t;const n=t.trim();if(t[0]==='"'&&t.endsWith('"')&&!t.includes("\\"))return n.slice(1,-1);if(n.length<=9){const r=n.toLowerCase();if(r==="true")return!0;if(r==="false")return!1;if(r==="undefined")return;if(r==="null")return null;if(r==="nan")return Number.NaN;if(r==="infinity")return Number.POSITIVE_INFINITY;if(r==="-infinity")return Number.NEGATIVE_INFINITY}if(!GS.test(t)){if(e.strict)throw new SyntaxError("[destr] Invalid JSON");return t}try{if(zS.test(t)||WS.test(t)){if(e.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(t,KS)}return JSON.parse(t)}catch(r){if(e.strict)throw r;return t}}const JS=/#/g,XS=/&/g,QS=/\//g,eA=/=/g,Xh=/\+/g,tA=/%5e/gi,nA=/%60/gi,rA=/%7c/gi,sA=/%20/gi;function aA(t){return encodeURI(""+t).replace(rA,"|")}function Bd(t){return aA(typeof t=="string"?t:JSON.stringify(t)).replace(Xh,"%2B").replace(sA,"+").replace(JS,"%23").replace(XS,"%26").replace(nA,"`").replace(tA,"^").replace(QS,"%2F")}function yl(t){return Bd(t).replace(eA,"%3D")}function Gb(t=""){try{return decodeURIComponent(""+t)}catch{return""+t}}function iA(t){return Gb(t.replace(Xh," "))}function oA(t){return Gb(t.replace(Xh," "))}function uA(t=""){const e={};t[0]==="?"&&(t=t.slice(1));for(const n of t.split("&")){const r=n.match(/([^=]+)=?(.*)/)||[];if(r.length<2)continue;const s=iA(r[1]);if(s==="__proto__"||s==="constructor")continue;const a=oA(r[2]||"");e[s]===void 0?e[s]=a:Array.isArray(e[s])?e[s].push(a):e[s]=[e[s],a]}return e}function cA(t,e){return(typeof e=="number"||typeof e=="boolean")&&(e=String(e)),e?Array.isArray(e)?e.map(n=>`${yl(t)}=${Bd(n)}`).join("&"):`${yl(t)}=${Bd(e)}`:yl(t)}function lA(t){return Object.keys(t).filter(e=>t[e]!==void 0).map(e=>cA(e,t[e])).filter(Boolean).join("&")}const dA=/^[\s\w\0+.-]{2,}:([/\\]{1,2})/,hA=/^[\s\w\0+.-]{2,}:([/\\]{2})?/,fA=/^([/\\]\s*){2,}[^/\\]/,mA=/^\.?\//;function Kb(t,e={}){return typeof e=="boolean"&&(e={acceptRelative:e}),e.strict?dA.test(t):hA.test(t)||(e.acceptRelative?fA.test(t):!1)}function pA(t="",e){return t.endsWith("/")}function gA(t="",e){return(pA(t)?t.slice(0,-1):t)||"/"}function bA(t="",e){return t.endsWith("/")?t:t+"/"}function _A(t,e){if(EA(e)||Kb(t))return t;const n=gA(e);return t.startsWith(n)?t:TA(n,t)}function yA(t,e){const n=SA(t),r={...uA(n.search),...e};return n.search=lA(r),AA(n)}function EA(t){return!t||t==="/"}function wA(t){return t&&t!=="/"}function TA(t,...e){let n=t||"";for(const r of e.filter(s=>wA(s)))if(n){const s=r.replace(mA,"");n=bA(n)+s}else n=r;return n}const Yb=Symbol.for("ufo:protocolRelative");function SA(t="",e){const n=t.match(/^[\s\0]*(blob:|data:|javascript:|vbscript:)(.*)/i);if(n){const[,d,m=""]=n;return{protocol:d.toLowerCase(),pathname:m,href:d+m,auth:"",host:"",search:"",hash:""}}if(!Kb(t,{acceptRelative:!0}))return Gm(t);const[,r="",s,a=""]=t.replace(/\\/g,"/").match(/^[\s\0]*([\w+.-]{2,}:)?\/\/([^/@]+@)?(.*)/)||[];let[,i="",o=""]=a.match(/([^#/?]*)(.*)?/)||[];r==="file:"&&(o=o.replace(/\/(?=[A-Za-z]:)/,""));const{pathname:u,search:c,hash:l}=Gm(o);return{protocol:r.toLowerCase(),auth:s?s.slice(0,Math.max(0,s.length-1)):"",host:i,pathname:u,search:c,hash:l,[Yb]:!r}}function Gm(t=""){const[e="",n="",r=""]=(t.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:e,search:n,hash:r}}function AA(t){const e=t.pathname||"",n=t.search?(t.search.startsWith("?")?"":"?")+t.search:"",r=t.hash||"",s=t.auth?t.auth+"@":"",a=t.host||"";return(t.protocol||t[Yb]?(t.protocol||"")+"//":"")+s+a+e+n+r}class CA extends Error{constructor(e,n){super(e,n),this.name="FetchError",n!=null&&n.cause&&!this.cause&&(this.cause=n.cause)}}function OA(t){var e,n,r,s,a;const i=((e=t.error)==null?void 0:e.message)||((n=t.error)==null?void 0:n.toString())||"",o=((r=t.request)==null?void 0:r.method)||((s=t.options)==null?void 0:s.method)||"GET",u=((a=t.request)==null?void 0:a.url)||String(t.request)||"/",c=`[${o}] ${JSON.stringify(u)}`,l=t.response?`${t.response.status} ${t.response.statusText}`:"<no response>",d=`${c}: ${l}${i?` ${i}`:""}`,m=new CA(d,t.error?{cause:t.error}:void 0);for(const p of["request","options","response"])Object.defineProperty(m,p,{get(){return t[p]}});for(const[p,f]of[["data","_data"],["status","status"],["statusCode","status"],["statusText","statusText"],["statusMessage","statusText"]])Object.defineProperty(m,p,{get(){return t.response&&t.response[f]}});return m}const vA=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function Km(t="GET"){return vA.has(t.toUpperCase())}function IA(t){if(t===void 0)return!1;const e=typeof t;return e==="string"||e==="number"||e==="boolean"||e===null?!0:e!=="object"?!1:Array.isArray(t)?!0:t.buffer?!1:t.constructor&&t.constructor.name==="Object"||typeof t.toJSON=="function"}const kA=new Set(["image/svg","application/xml","application/xhtml","application/html"]),NA=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function RA(t=""){if(!t)return"json";const e=t.split(";").shift()||"";return NA.test(e)?"json":kA.has(e)||e.startsWith("text/")?"text":"blob"}function PA(t,e,n,r){const s=xA((e==null?void 0:e.headers)??(t==null?void 0:t.headers),n==null?void 0:n.headers,r);let a;return(n!=null&&n.query||n!=null&&n.params||e!=null&&e.params||e!=null&&e.query)&&(a={...n==null?void 0:n.params,...n==null?void 0:n.query,...e==null?void 0:e.params,...e==null?void 0:e.query}),{...n,...e,query:a,params:a,headers:s}}function xA(t,e,n){if(!e)return new n(t);const r=new n(e);if(t)for(const[s,a]of Symbol.iterator in t||Array.isArray(t)?t:new n(t))r.set(s,a);return r}async function Io(t,e){if(e)if(Array.isArray(e))for(const n of e)await n(t);else await e(t)}const LA=new Set([408,409,425,429,500,502,503,504]),DA=new Set([101,204,205,304]);function Zb(t={}){const{fetch:e=globalThis.fetch,Headers:n=globalThis.Headers,AbortController:r=globalThis.AbortController}=t;async function s(o){const u=o.error&&o.error.name==="AbortError"&&!o.options.timeout||!1;if(o.options.retry!==!1&&!u){let l;typeof o.options.retry=="number"?l=o.options.retry:l=Km(o.options.method)?0:1;const d=o.response&&o.response.status||500;if(l>0&&(Array.isArray(o.options.retryStatusCodes)?o.options.retryStatusCodes.includes(d):LA.has(d))){const m=typeof o.options.retryDelay=="function"?o.options.retryDelay(o):o.options.retryDelay||0;return m>0&&await new Promise(p=>setTimeout(p,m)),a(o.request,{...o.options,retry:l-1})}}const c=OA(o);throw Error.captureStackTrace&&Error.captureStackTrace(c,a),c}const a=async function(o,u={}){const c={request:o,options:PA(o,u,t.defaults,n),response:void 0,error:void 0};c.options.method&&(c.options.method=c.options.method.toUpperCase()),c.options.onRequest&&await Io(c,c.options.onRequest),typeof c.request=="string"&&(c.options.baseURL&&(c.request=_A(c.request,c.options.baseURL)),c.options.query&&(c.request=yA(c.request,c.options.query),delete c.options.query),"query"in c.options&&delete c.options.query,"params"in c.options&&delete c.options.params),c.options.body&&Km(c.options.method)&&(IA(c.options.body)?(c.options.body=typeof c.options.body=="string"?c.options.body:JSON.stringify(c.options.body),c.options.headers=new n(c.options.headers||{}),c.options.headers.has("content-type")||c.options.headers.set("content-type","application/json"),c.options.headers.has("accept")||c.options.headers.set("accept","application/json")):("pipeTo"in c.options.body&&typeof c.options.body.pipeTo=="function"||typeof c.options.body.pipe=="function")&&("duplex"in c.options||(c.options.duplex="half")));let l;if(!c.options.signal&&c.options.timeout){const d=new r;l=setTimeout(()=>{const m=new Error("[TimeoutError]: The operation was aborted due to timeout");m.name="TimeoutError",m.code=23,d.abort(m)},c.options.timeout),c.options.signal=d.signal}try{c.response=await e(c.request,c.options)}catch(d){return c.error=d,c.options.onRequestError&&await Io(c,c.options.onRequestError),await s(c)}finally{l&&clearTimeout(l)}if((c.response.body||c.response._bodyInit)&&!DA.has(c.response.status)&&c.options.method!=="HEAD"){const d=(c.options.parseResponse?"json":c.options.responseType)||RA(c.response.headers.get("content-type")||"");switch(d){case"json":{const m=await c.response.text(),p=c.options.parseResponse||ZS;c.response._data=p(m);break}case"stream":{c.response._data=c.response.body||c.response._bodyInit;break}default:c.response._data=await c.response[d]()}}return c.options.onResponse&&await Io(c,c.options.onResponse),!c.options.ignoreResponseError&&c.response.status>=400&&c.response.status<600?(c.options.onResponseError&&await Io(c,c.options.onResponseError),await s(c)):c.response},i=async function(o,u){return(await a(o,u))._data};return i.raw=a,i.native=(...o)=>e(...o),i.create=(o={},u={})=>Zb({...t,...u,defaults:{...t.defaults,...u.defaults,...o}}),i}const Nu=function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")}(),MA=Nu.fetch?(...t)=>Nu.fetch(...t):()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!")),BA=Nu.Headers,FA=Nu.AbortController,Ym=Zb({fetch:MA,Headers:BA,AbortController:FA}),El={SCHEMA_DIR_RELATIVE_PATH:"./../schemas/",SCHEMA_FILENAME_PAYLOAD:"payload.schema.json",SCHEMA_FILENAME_RESPONSE:"response.schema.json",SIYUAN_DEFAULT_BASE_URL:"http://localhost:6806/",REQUEST_TIMEOUT:6e4};class UA extends Error{constructor(e){super(e.statusText),un(this,"status"),this.response=e,this.status=e.status}}class Zm extends Error{constructor(e,n){super(e.msg),un(this,"code"),un(this,"msg"),un(this,"data"),this.body=e,this.response=n,this.code=e.code,this.msg=e.msg,this.data=e.data}}var Jm,Xm,Qm,ep,tp;const Fd=class P{constructor(e={},n="xhr"){un(this,"_type","xhr"),un(this,"_baseURL",((Xm=(Jm=globalThis.top)==null?void 0:Jm.document)==null?void 0:Xm.baseURI)??((ep=(Qm=globalThis.parent)==null?void 0:Qm.document)==null?void 0:ep.baseURI)??((tp=globalThis.location)==null?void 0:tp.origin)??El.SIYUAN_DEFAULT_BASE_URL),un(this,"_token",null),un(this,"_ofetch_options",{baseURL:this._baseURL,headers:this._headers}),un(this,"_axios_options",{baseURL:this._baseURL,timeout:El.REQUEST_TIMEOUT,headers:this._headers}),un(this,"_fetch",Ym.create(this._ofetch_options)),un(this,"_axios",at.create(this._axios_options)),this._setClientType(n),this._updateOptions(e,n)}static headers2record(e){const n={};return e.forEach((r,s)=>{n[s]=r}),n}static headers2records(e){const n=[];return e.forEach((r,s)=>{n.push({[s]:r})}),n}static headers2entries(e){const n=[];return Object.entries(e).forEach(([r,s])=>{s.forEach(a=>n.push([r,a]))}),n}static entries2record(e){const n={};for(const[r,s]of e)n[r]=s;return n}get _authorization(){return`Token ${this._token}`}get _headers(){return this._token!==null?{Authorization:this._authorization}:{}}_setClientType(e){this._type=e}_updateOptions(e,n=this._type){switch(this._baseURL=e.baseURL??this._baseURL,e.token){case void 0:break;case null:default:this._token=e.token,delete e.token;break}switch(n){case"fetch":{const r=e;switch(!0){case Array.isArray(r.headers):{r.headers.find(([s])=>s.toLowerCase()==="Authorization".toLowerCase())||r.headers.push(["Authorization",this._authorization]);break}case r.headers instanceof Headers:{r.headers.has("Authorization")||r.headers.set("Authorization",this._authorization);break}case typeof r.headers=="object":{"Authorization"in r.headers||(r.headers.Authorization=this._authorization);break}default:{r.headers=this._headers;break}}this._ofetch_options=r,this._fetch=Ym.create(this._ofetch_options);break}case"xhr":default:{const r=e;if(r.headers)switch(!0){case r.headers instanceof PS:{r.headers.has("Authorization")||r.headers.set("Authorization",this._authorization);break}case typeof r.headers=="object":{switch(!0){case("common"in r.headers||"get"in r.headers||"post"in r.headers):{"common"in r.headers&&("Authorization"in r.headers.get||(r.headers.get.Authorization=this._authorization)),"get"in r.headers&&("Authorization"in r.headers.get||(r.headers.get.Authorization=this._authorization)),"post"in r.headers&&("Authorization"in r.headers.post||(r.headers.post.Authorization=this._authorization));break}default:{"Authorization"in r.headers||(r.headers.Authorization=this._authorization);break}}break}default:{r.headers=this._headers;break}}else r.headers=this._headers;this._axios_options=r,this._axios=at.create(this._axios_options);break}}}async $fetch(e,n){const r=new Request(e,n),s=await this.forwardProxy({url:r.url,method:r.method,headers:P.headers2records(r.headers),payload:US(new Uint8Array(await r.arrayBuffer())),timeout:El.REQUEST_TIMEOUT,contentType:"application/json",payloadEncoding:"base64",responseEncoding:"base64"});return new Response(qS(s.data.body),{status:s.data.status,statusText:s.msg,headers:new Headers(P.headers2entries(s.data.headers))})}broadcast(e,n,r){var s;const a=(r==null?void 0:r.baseURL)??this._baseURL,i=(r==null?void 0:r.token)??this._token,o=new URLSearchParams(e);i&&o.set("token",i);const u=new URL(a,(s=globalThis.location)==null?void 0:s.href);return u.protocol=u.protocol.replace(/^http/,"ws"),u.pathname=u.pathname.endsWith("/")?`${u.pathname}${P.ws.broadcast.pathname.substring(1)}`:`${u.pathname}${P.ws.broadcast.pathname}`,u.search=o.toString(),new xS(u,n)}async upload(e,n){const r=new FormData;return e.id!=null&&r.append("id",e.id),e.assetsDirPath!=null&&r.append("assetsDirPath",e.assetsDirPath),e.skipIfDuplicated!=null&&r.append("skipIfDuplicated",String(e.skipIfDuplicated)),e.files.forEach(s=>r.append("file[]",s)),await this._request(P.api.asset.upload.pathname,P.api.asset.upload.method,r,n)}async getBlockAttrs(e,n){return await this._request(P.api.attr.getBlockAttrs.pathname,P.api.attr.getBlockAttrs.method,e,n)}async getBookmarkLabels(e){return await this._request(P.api.attr.getBookmarkLabels.pathname,P.api.attr.getBookmarkLabels.method,void 0,e)}async setBlockAttrs(e,n){return await this._request(P.api.attr.setBlockAttrs.pathname,P.api.attr.setBlockAttrs.method,e,n)}async appendBlock(e,n){return await this._request(P.api.block.appendBlock.pathname,P.api.block.appendBlock.method,e,n)}async deleteBlock(e,n){return await this._request(P.api.block.deleteBlock.pathname,P.api.block.deleteBlock.method,e,n)}async foldBlock(e,n){return await this._request(P.api.block.foldBlock.pathname,P.api.block.foldBlock.method,e,n)}async getBlockBreadcrumb(e,n){return await this._request(P.api.block.getBlockBreadcrumb.pathname,P.api.block.getBlockBreadcrumb.method,e,n)}async getBlockDOM(e,n){return await this._request(P.api.block.getBlockDOM.pathname,P.api.block.getBlockDOM.method,e,n)}async getBlockInfo(e,n){return await this._request(P.api.block.getBlockInfo.pathname,P.api.block.getBlockInfo.method,e,n)}async getBlockKramdown(e,n){return await this._request(P.api.block.getBlockKramdown.pathname,P.api.block.getBlockKramdown.method,e,n)}async getChildBlocks(e,n){return await this._request(P.api.block.getChildBlocks.pathname,P.api.block.getChildBlocks.method,e,n)}async getDocInfo(e,n){return await this._request(P.api.block.getDocInfo.pathname,P.api.block.getDocInfo.method,e,n)}async insertBlock(e,n){return await this._request(P.api.block.insertBlock.pathname,P.api.block.insertBlock.method,e,n)}async moveBlock(e,n){return await this._request(P.api.block.moveBlock.pathname,P.api.block.moveBlock.method,e,n)}async prependBlock(e,n){return await this._request(P.api.block.prependBlock.pathname,P.api.block.prependBlock.method,e,n)}async transferBlockRef(e,n){return await this._request(P.api.block.transferBlockRef.pathname,P.api.block.transferBlockRef.method,e,n)}async unfoldBlock(e,n){return await this._request(P.api.block.unfoldBlock.pathname,P.api.block.unfoldBlock.method,e,n)}async updateBlock(e,n){return await this._request(P.api.block.updateBlock.pathname,P.api.block.updateBlock.method,e,n)}async getChannelInfo(e,n){return await this._request(P.api.broadcast.getChannelInfo.pathname,P.api.broadcast.getChannelInfo.method,e,n)}async getChannels(e){return await this._request(P.api.broadcast.getChannels.pathname,P.api.broadcast.getChannels.method,void 0,e)}async postMessage(e,n){return await this._request(P.api.broadcast.postMessage.pathname,P.api.broadcast.postMessage.method,e,n)}async pandoc(e,n){return await this._request(P.api.convert.pandoc.pathname,P.api.convert.pandoc.method,e,n)}async exportHTML(e,n){return await this._request(P.api.export.exportHTML.pathname,P.api.export.exportHTML.method,e,n)}async exportMdContent(e,n){return await this._request(P.api.export.exportMdContent.pathname,P.api.export.exportMdContent.method,e,n)}async exportResources(e,n){return await this._request(P.api.export.exportResources.pathname,P.api.export.exportResources.method,e,n)}async getFile(e,n="text",r){return await this._request(P.api.file.getFile.pathname,P.api.file.getFile.method,e,r,!1,n)}async putFile(e,n){e.file!==void 0&&!(e.file instanceof File)&&(e.file=new File([e.file],e.path.split("/").pop()));const r=new FormData;for(const[s,a]of Object.entries(e))a instanceof Blob?r.append(s,a):r.append(s,String(a));return await this._request(P.api.file.putFile.pathname,P.api.file.putFile.method,r,n)}async readDir(e,n){return await this._request(P.api.file.readDir.pathname,P.api.file.readDir.method,e,n)}async removeFile(e,n){return await this._request(P.api.file.removeFile.pathname,P.api.file.removeFile.method,e,n)}async renameFile(e,n){return await this._request(P.api.file.renameFile.pathname,P.api.file.renameFile.method,e,n)}async createDailyNote(e,n){return await this._request(P.api.filetree.createDailyNote.pathname,P.api.filetree.createDailyNote.method,e,n)}async createDocWithMd(e,n){return await this._request(P.api.filetree.createDocWithMd.pathname,P.api.filetree.createDocWithMd.method,e,n)}async getDoc(e,n){return await this._request(P.api.filetree.getDoc.pathname,P.api.filetree.getDoc.method,e,n)}async getHPathByID(e,n){return await this._request(P.api.filetree.getHPathByID.pathname,P.api.filetree.getHPathByID.method,e,n)}async getHPathByPath(e,n){return await this._request(P.api.filetree.getHPathByPath.pathname,P.api.filetree.getHPathByPath.method,e,n)}async getIDsByHPath(e,n){return await this._request(P.api.filetree.getIDsByHPath.pathname,P.api.filetree.getIDsByHPath.method,e,n)}async listDocsByPath(e,n){return await this._request(P.api.filetree.listDocsByPath.pathname,P.api.filetree.listDocsByPath.method,e,n)}async moveDocs(e,n){return await this._request(P.api.filetree.moveDocs.pathname,P.api.filetree.moveDocs.method,e,n)}async removeDoc(e,n){return await this._request(P.api.filetree.removeDoc.pathname,P.api.filetree.removeDoc.method,e,n)}async renameDoc(e,n){return await this._request(P.api.filetree.renameDoc.pathname,P.api.filetree.renameDoc.method,e,n)}async searchDocs(e,n){return await this._request(P.api.filetree.searchDocs.pathname,P.api.filetree.searchDocs.method,e,n)}async getDocHistoryContent(e,n){return await this._request(P.api.history.getDocHistoryContent.pathname,P.api.history.getDocHistoryContent.method,e,n)}async getHistoryItems(e,n){return await this._request(P.api.history.getHistoryItems.pathname,P.api.history.getHistoryItems.method,e,n)}async getShorthand(e,n){return await this._request(P.api.inbox.getShorthand.pathname,P.api.inbox.getShorthand.method,e,n)}async echo(e,n){if(e)switch(n??(n={type:this._type}),n==null?void 0:n.type){case"fetch":{const r={};e.headers&&(r.headers=e.headers),e.query&&(r.query=P.entries2record(e.query.entries())),n.options?Object.assign(r,n.options):n.options=r;break}case"xhr":{const r={};e.headers&&(r.headers=Array.isArray(e.headers)?P.entries2record(e.headers):e.headers instanceof Headers?P.headers2record(e.headers):e.headers),e.query&&(r.params=e.query),n.options?Object.assign(r,n.options):n.options=r;break}}return await this._request(P.api.network.echo.pathname,(e==null?void 0:e.method)??P.api.network.echo.method,e==null?void 0:e.body,n)}async forwardProxy(e,n){return await this._request(P.api.network.forwardProxy.pathname,P.api.network.forwardProxy.method,e,n)}async closeNotebook(e,n){return await this._request(P.api.notebook.closeNotebook.pathname,P.api.notebook.closeNotebook.method,e,n)}async createNotebook(e,n){return await this._request(P.api.notebook.createNotebook.pathname,P.api.notebook.createNotebook.method,e,n)}async getNotebookConf(e,n){return await this._request(P.api.notebook.getNotebookConf.pathname,P.api.notebook.getNotebookConf.method,e,n)}async lsNotebooks(e){return await this._request(P.api.notebook.lsNotebooks.pathname,P.api.notebook.lsNotebooks.method,void 0,e)}async openNotebook(e,n){return await this._request(P.api.notebook.openNotebook.pathname,P.api.notebook.openNotebook.method,e,n)}async removeNotebook(e,n){return await this._request(P.api.notebook.removeNotebook.pathname,P.api.notebook.removeNotebook.method,e,n)}async renameNotebook(e,n){return await this._request(P.api.notebook.renameNotebook.pathname,P.api.notebook.renameNotebook.method,e,n)}async setNotebookConf(e,n){return await this._request(P.api.notebook.setNotebookConf.pathname,P.api.notebook.setNotebookConf.method,e,n)}async pushErrMsg(e,n){return await this._request(P.api.notification.pushErrMsg.pathname,P.api.notification.pushErrMsg.method,e,n)}async pushMsg(e,n){return await this._request(P.api.notification.pushMsg.pathname,P.api.notification.pushMsg.method,e,n)}async getDocOutline(e,n){return await this._request(P.api.outline.getDocOutline.pathname,P.api.outline.getDocOutline.method,e,n)}async sql(e,n){return await this._request(P.api.query.sql.pathname,P.api.query.sql.method,e,n)}async openRepoSnapshotDoc(e,n){return await this._request(P.api.repo.openRepoSnapshotDoc.pathname,P.api.repo.openRepoSnapshotDoc.method,e,n)}async fullTextSearchBlock(e,n){return await this._request(P.api.search.fullTextSearchBlock.pathname,P.api.search.fullTextSearchBlock.method,e,n)}async getSnippet(e,n){return await this._request(P.api.snippet.getSnippet.pathname,P.api.snippet.getSnippet.method,e,n)}async setSnippet(e,n){return await this._request(P.api.snippet.setSnippet.pathname,P.api.snippet.setSnippet.method,e,n)}async flushTransaction(e){return await this._request(P.api.sqlite.flushTransaction.pathname,P.api.sqlite.flushTransaction.method,e)}async getLocalStorage(e){return await this._request(P.api.storage.getLocalStorage.pathname,P.api.storage.getLocalStorage.method,void 0,e)}async getRecentDocs(e){return await this._request(P.api.storage.getRecentDocs.pathname,P.api.storage.getRecentDocs.method,void 0,e)}async setLocalStorage(e,n){return await this._request(P.api.storage.setLocalStorage.pathname,P.api.storage.setLocalStorage.method,e,n)}async setLocalStorageVal(e,n){return await this._request(P.api.storage.setLocalStorageVal.pathname,P.api.storage.setLocalStorageVal.method,e,n)}async bootProgress(e){return await this._request(P.api.system.bootProgress.pathname,P.api.system.bootProgress.method,void 0,e)}async currentTime(e){return await this._request(P.api.system.currentTime.pathname,P.api.system.currentTime.method,void 0,e)}async exit(e,n){return await this._request(P.api.system.exit.pathname,P.api.system.exit.method,e,n)}async getConf(e){return await this._request(P.api.system.getConf.pathname,P.api.system.getConf.method,void 0,e)}async logoutAuth(e){return await this._request(P.api.system.logoutAuth.pathname,P.api.system.logoutAuth.method,void 0,e)}async version(e){return await this._request(P.api.system.version.pathname,P.api.system.version.method,void 0,e)}async render(e,n){return await this._request(P.api.template.render.pathname,P.api.template.render.method,e,n)}async renderSprig(e,n){return await this._request(P.api.template.renderSprig.pathname,P.api.template.renderSprig.method,e,n)}async _request(e,n,r,s,a=!0,i="json"){switch((s==null?void 0:s.type)??this._type){case"fetch":{const o=s==null?void 0:s.options;i=(()=>{switch(i){case"arraybuffer":return"arrayBuffer";case"document":return"text";default:return i}})();const u=await this._fetch(e,{method:n,body:r,responseType:i,onResponse:c=>{switch(c.response.status){case Oo.Ok:switch(i){case"blob":c.response._data.contentType=c.response.headers.get("content-type");break}break;case Oo.Accepted:e===P.api.file.getFile.pathname&&this._parseFetchResponse(c.response._data);break}},...o});return a&&i==="json"&&typeof u=="object"?this._parseFetchResponse(u):u}case"xhr":default:{const o=s==null?void 0:s.options;i=(()=>{switch(i){case"arrayBuffer":return"arraybuffer";default:return i}})();const u=await this._axios.request({url:e,method:n,data:r,responseType:i,...o});switch(u.status){case Oo.Ok:if(a&&i==="json"&&typeof u.data=="object")return this._parseAxiosResponse(u);switch(i){case"blob":"content-type"in u.headers&&(u.data.contentType=u.headers["content-type"]);break}return u.data;case Oo.Accepted:return e===P.api.file.getFile.pathname?this._parseAxiosResponse(u):u.data;default:throw new UA(u)}}}}_parseFetchResponse(e){if(e.code===0)return e;throw new Zm(e)}_parseAxiosResponse(e){if(e.data.code===0)return e.data;throw new Zm(e.data,e)}};un(Fd,"ws",{broadcast:{pathname:"/ws/broadcast"}}),un(Fd,"api",{asset:{upload:{pathname:"/api/asset/upload",method:"POST"}},attr:{getBlockAttrs:{pathname:"/api/attr/getBlockAttrs",method:"POST"},getBookmarkLabels:{pathname:"/api/attr/getBookmarkLabels",method:"POST"},setBlockAttrs:{pathname:"/api/attr/setBlockAttrs",method:"POST"}},block:{appendBlock:{pathname:"/api/block/appendBlock",method:"POST"},deleteBlock:{pathname:"/api/block/deleteBlock",method:"POST"},foldBlock:{pathname:"/api/block/foldBlock",method:"POST"},getBlockBreadcrumb:{pathname:"/api/block/getBlockBreadcrumb",method:"POST"},getBlockDOM:{pathname:"/api/block/getBlockDOM",method:"POST"},getBlockInfo:{pathname:"/api/block/getBlockInfo",method:"POST"},getBlockKramdown:{pathname:"/api/block/getBlockKramdown",method:"POST"},getChildBlocks:{pathname:"/api/block/getChildBlocks",method:"POST"},getDocInfo:{pathname:"/api/block/getDocInfo",method:"POST"},insertBlock:{pathname:"/api/block/insertBlock",method:"POST"},moveBlock:{pathname:"/api/block/moveBlock",method:"POST"},prependBlock:{pathname:"/api/block/prependBlock",method:"POST"},transferBlockRef:{pathname:"/api/block/transferBlockRef",method:"POST"},unfoldBlock:{pathname:"/api/block/unfoldBlock",method:"POST"},updateBlock:{pathname:"/api/block/updateBlock",method:"POST"}},broadcast:{getChannelInfo:{pathname:"/api/broadcast/getChannelInfo",method:"POST"},getChannels:{pathname:"/api/broadcast/getChannels",method:"POST"},postMessage:{pathname:"/api/broadcast/postMessage",method:"POST"}},convert:{pandoc:{pathname:"/api/convert/pandoc",method:"POST"}},export:{exportHTML:{pathname:"/api/export/exportHTML",method:"POST"},exportMdContent:{pathname:"/api/export/exportMdContent",method:"POST"},exportResources:{pathname:"/api/export/exportResources",method:"POST"}},file:{getFile:{pathname:"/api/file/getFile",method:"POST"},putFile:{pathname:"/api/file/putFile",method:"POST"},readDir:{pathname:"/api/file/readDir",method:"POST"},removeFile:{pathname:"/api/file/removeFile",method:"POST"},renameFile:{pathname:"/api/file/renameFile",method:"POST"}},filetree:{createDailyNote:{pathname:"/api/filetree/createDailyNote",method:"POST"},createDocWithMd:{pathname:"/api/filetree/createDocWithMd",method:"POST"},getDoc:{pathname:"/api/filetree/getDoc",method:"POST"},getHPathByID:{pathname:"/api/filetree/getHPathByID",method:"POST"},getHPathByPath:{pathname:"/api/filetree/getHPathByPath",method:"POST"},getIDsByHPath:{pathname:"/api/filetree/getIDsByHPath",method:"POST"},listDocsByPath:{pathname:"/api/filetree/listDocsByPath",method:"POST"},moveDocs:{pathname:"/api/filetree/moveDocs",method:"POST"},removeDoc:{pathname:"/api/filetree/removeDoc",method:"POST"},renameDoc:{pathname:"/api/filetree/renameDoc",method:"POST"},searchDocs:{pathname:"/api/filetree/searchDocs",method:"POST"}},history:{getDocHistoryContent:{pathname:"/api/history/getDocHistoryContent",method:"POST"},getHistoryItems:{pathname:"/api/history/getHistoryItems",method:"POST"}},inbox:{getShorthand:{pathname:"/api/inbox/getShorthand",method:"POST"}},network:{echo:{pathname:"/api/network/echo",method:"POST"},forwardProxy:{pathname:"/api/network/forwardProxy",method:"POST"}},notebook:{closeNotebook:{pathname:"/api/notebook/closeNotebook",method:"POST"},createNotebook:{pathname:"/api/notebook/createNotebook",method:"POST"},getNotebookConf:{pathname:"/api/notebook/getNotebookConf",method:"POST"},lsNotebooks:{pathname:"/api/notebook/lsNotebooks",method:"POST"},openNotebook:{pathname:"/api/notebook/openNotebook",method:"POST"},removeNotebook:{pathname:"/api/notebook/removeNotebook",method:"POST"},renameNotebook:{pathname:"/api/notebook/renameNotebook",method:"POST"},setNotebookConf:{pathname:"/api/notebook/setNotebookConf",method:"POST"}},notification:{pushErrMsg:{pathname:"/api/notification/pushErrMsg",method:"POST"},pushMsg:{pathname:"/api/notification/pushMsg",method:"POST"}},outline:{getDocOutline:{pathname:"/api/outline/getDocOutline",method:"POST"}},query:{sql:{pathname:"/api/query/sql",method:"POST"}},repo:{openRepoSnapshotDoc:{pathname:"/api/repo/openRepoSnapshotDoc",method:"POST"}},search:{fullTextSearchBlock:{pathname:"/api/search/fullTextSearchBlock",method:"POST"}},snippet:{getSnippet:{pathname:"/api/snippet/getSnippet",method:"POST"},setSnippet:{pathname:"/api/snippet/setSnippet",method:"POST"}},sqlite:{flushTransaction:{pathname:"/api/sqlite/flushTransaction",method:"POST"}},storage:{getLocalStorage:{pathname:"/api/storage/getLocalStorage",method:"POST"},getRecentDocs:{pathname:"/api/storage/getRecentDocs",method:"POST"},setLocalStorage:{pathname:"/api/storage/setLocalStorage",method:"POST"},setLocalStorageVal:{pathname:"/api/storage/setLocalStorageVal",method:"POST"}},system:{bootProgress:{pathname:"/api/system/bootProgress",method:"POST"},currentTime:{pathname:"/api/system/currentTime",method:"POST"},exit:{pathname:"/api/system/exit",method:"POST"},getConf:{pathname:"/api/system/getConf",method:"POST"},logoutAuth:{pathname:"/api/system/logoutAuth",method:"POST"},version:{pathname:"/api/system/version",method:"POST"}},template:{render:{pathname:"/api/template/render",method:"POST"},renderSprig:{pathname:"/api/template/renderSprig",method:"POST"}}});let jA=Fd;function Xn(t){if(typeof t!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(t))}function np(t,e){for(var n="",r=0,s=-1,a=0,i,o=0;o<=t.length;++o){if(o<t.length)i=t.charCodeAt(o);else{if(i===47)break;i=47}if(i===47){if(!(s===o-1||a===1))if(s!==o-1&&a===2){if(n.length<2||r!==2||n.charCodeAt(n.length-1)!==46||n.charCodeAt(n.length-2)!==46){if(n.length>2){var u=n.lastIndexOf("/");if(u!==n.length-1){u===-1?(n="",r=0):(n=n.slice(0,u),r=n.length-1-n.lastIndexOf("/")),s=o,a=0;continue}}else if(n.length===2||n.length===1){n="",r=0,s=o,a=0;continue}}e&&(n.length>0?n+="/..":n="..",r=2)}else n.length>0?n+="/"+t.slice(s+1,o):n=t.slice(s+1,o),r=o-s-1;s=o,a=0}else i===46&&a!==-1?++a:a=-1}return n}function HA(t,e){var n=e.dir||e.root,r=e.base||(e.name||"")+(e.ext||"");return n?n===e.root?n+r:n+t+r:r}var oi={resolve:function(){for(var t="",e=!1,n,r=arguments.length-1;r>=-1&&!e;r--){var s;r>=0?s=arguments[r]:(n===void 0&&(n=process.cwd()),s=n),Xn(s),s.length!==0&&(t=s+"/"+t,e=s.charCodeAt(0)===47)}return t=np(t,!e),e?t.length>0?"/"+t:"/":t.length>0?t:"."},normalize:function(t){if(Xn(t),t.length===0)return".";var e=t.charCodeAt(0)===47,n=t.charCodeAt(t.length-1)===47;return t=np(t,!e),t.length===0&&!e&&(t="."),t.length>0&&n&&(t+="/"),e?"/"+t:t},isAbsolute:function(t){return Xn(t),t.length>0&&t.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var t,e=0;e<arguments.length;++e){var n=arguments[e];Xn(n),n.length>0&&(t===void 0?t=n:t+="/"+n)}return t===void 0?".":oi.normalize(t)},relative:function(t,e){if(Xn(t),Xn(e),t===e||(t=oi.resolve(t),e=oi.resolve(e),t===e))return"";for(var n=1;n<t.length&&t.charCodeAt(n)===47;++n);for(var r=t.length,s=r-n,a=1;a<e.length&&e.charCodeAt(a)===47;++a);for(var i=e.length,o=i-a,u=s<o?s:o,c=-1,l=0;l<=u;++l){if(l===u){if(o>u){if(e.charCodeAt(a+l)===47)return e.slice(a+l+1);if(l===0)return e.slice(a+l)}else s>u&&(t.charCodeAt(n+l)===47?c=l:l===0&&(c=0));break}var d=t.charCodeAt(n+l),m=e.charCodeAt(a+l);if(d!==m)break;d===47&&(c=l)}var p="";for(l=n+c+1;l<=r;++l)(l===r||t.charCodeAt(l)===47)&&(p.length===0?p+="..":p+="/..");return p.length>0?p+e.slice(a+c):(a+=c,e.charCodeAt(a)===47&&++a,e.slice(a))},_makeLong:function(t){return t},dirname:function(t){if(Xn(t),t.length===0)return".";for(var e=t.charCodeAt(0),n=e===47,r=-1,s=!0,a=t.length-1;a>=1;--a)if(e=t.charCodeAt(a),e===47){if(!s){r=a;break}}else s=!1;return r===-1?n?"/":".":n&&r===1?"//":t.slice(0,r)},basename:function(t,e){if(e!==void 0&&typeof e!="string")throw new TypeError('"ext" argument must be a string');Xn(t);var n=0,r=-1,s=!0,a;if(e!==void 0&&e.length>0&&e.length<=t.length){if(e.length===t.length&&e===t)return"";var i=e.length-1,o=-1;for(a=t.length-1;a>=0;--a){var u=t.charCodeAt(a);if(u===47){if(!s){n=a+1;break}}else o===-1&&(s=!1,o=a+1),i>=0&&(u===e.charCodeAt(i)?--i===-1&&(r=a):(i=-1,r=o))}return n===r?r=o:r===-1&&(r=t.length),t.slice(n,r)}else{for(a=t.length-1;a>=0;--a)if(t.charCodeAt(a)===47){if(!s){n=a+1;break}}else r===-1&&(s=!1,r=a+1);return r===-1?"":t.slice(n,r)}},extname:function(t){Xn(t);for(var e=-1,n=0,r=-1,s=!0,a=0,i=t.length-1;i>=0;--i){var o=t.charCodeAt(i);if(o===47){if(!s){n=i+1;break}continue}r===-1&&(s=!1,r=i+1),o===46?e===-1?e=i:a!==1&&(a=1):e!==-1&&(a=-1)}return e===-1||r===-1||a===0||a===1&&e===r-1&&e===n+1?"":t.slice(e,r)},format:function(t){if(t===null||typeof t!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof t);return HA("/",t)},parse:function(t){Xn(t);var e={root:"",dir:"",base:"",ext:"",name:""};if(t.length===0)return e;var n=t.charCodeAt(0),r=n===47,s;r?(e.root="/",s=1):s=0;for(var a=-1,i=0,o=-1,u=!0,c=t.length-1,l=0;c>=s;--c){if(n=t.charCodeAt(c),n===47){if(!u){i=c+1;break}continue}o===-1&&(u=!1,o=c+1),n===46?a===-1?a=c:l!==1&&(l=1):a!==-1&&(l=-1)}return a===-1||o===-1||l===0||l===1&&a===o-1&&a===i+1?o!==-1&&(i===0&&r?e.base=e.name=t.slice(1,o):e.base=e.name=t.slice(i,o)):(i===0&&r?(e.name=t.slice(1,a),e.base=t.slice(1,o)):(e.name=t.slice(i,a),e.base=t.slice(i,o)),e.ext=t.slice(a,o)),i>0?e.dir=t.slice(0,i-1):r&&(e.dir="/"),e},sep:"/",delimiter:":",win32:null,posix:null};oi.posix=oi;async function vs(t,e){let n=await An.fetchSyncPost(t,e);return n.code===0?n.data:null}async function Jb(t){return vs("/api/block/getChildBlocks",{id:t})}async function $A(t){return vs("/api/block/getBlockIndex",{id:t})}async function Xs(t,e=7e3){return vs("/api/notification/pushMsg",{msg:t,timeout:e})}async function _a(t,e=7e3){return vs("/api/notification/pushErrMsg",{msg:t,timeout:e})}async function qA(){return vs("/api/notebook/lsNotebooks","")}function Xb(){var n;let t=((n=window.getSelection())==null?void 0:n.toString())||"";return t||(document.querySelectorAll(".protyle-wysiwyg--select").forEach(r=>{const s=r.textContent;t+=`
`+s}),t)}function Qb(){var r;let t="",e="";return t=(r=document.getElementsByClassName("protyle-title__input")[0])==null?void 0:r.textContent,document.querySelectorAll("[data-node-index]").forEach(s=>{e+=s.textContent+`
`}),{title:t,content:e}}function it(){}function Ru(t,e){for(const n in e)t[n]=e[n];return t}function e_(t){return t()}function rp(){return Object.create(null)}function ut(t){t.forEach(e_)}function t_(t){return typeof t=="function"}function ct(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function VA(t){return Object.keys(t).length===0}function Qh(t,e,n,r){if(t){const s=n_(t,e,n,r);return t[0](s)}}function n_(t,e,n,r){return t[1]&&r?Ru(n.ctx.slice(),t[1](r(e))):n.ctx}function ef(t,e,n,r){if(t[2]&&r){const s=t[2](r(n));if(e.dirty===void 0)return s;if(typeof s=="object"){const a=[],i=Math.max(e.dirty.length,s.length);for(let o=0;o<i;o+=1)a[o]=e.dirty[o]|s[o];return a}return e.dirty|s}return e.dirty}function tf(t,e,n,r,s,a){if(s){const i=n_(e,n,r,a);t.p(i,s)}}function nf(t){if(t.ctx.length>32){const e=[],n=t.ctx.length/32;for(let r=0;r<n;r++)e[r]=-1;return e}return-1}function sp(t){const e={};for(const n in t)n[0]!=="$"&&(e[n]=t[n]);return e}const zA=["",!0,1,"true","contenteditable"];function N(t,e){t.appendChild(e)}function pe(t,e,n){t.insertBefore(e,n||null)}function me(t){t.parentNode&&t.parentNode.removeChild(t)}function Ac(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function V(t){return document.createElement(t)}function cn(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function Qe(t){return document.createTextNode(t)}function se(){return Qe(" ")}function Cc(){return Qe("")}function ce(t,e,n,r){return t.addEventListener(e,n,r),()=>t.removeEventListener(e,n,r)}function WA(t){return function(e){return e.stopPropagation(),t.call(this,e)}}function v(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}const GA=["width","height"];function ap(t,e){const n=Object.getOwnPropertyDescriptors(t.__proto__);for(const r in e)e[r]==null?t.removeAttribute(r):r==="style"?t.style.cssText=e[r]:r==="__value"?t.value=t[r]=e[r]:n[r]&&n[r].set&&GA.indexOf(r)===-1?t[r]=e[r]:v(t,r,e[r])}function Ud(t){return t===""?null:+t}function KA(t){return Array.from(t.childNodes)}function St(t,e){e=""+e,t.data!==e&&(t.data=e)}function YA(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function ZA(t,e,n){~zA.indexOf(n)?YA(t,e):St(t,e)}function Dt(t,e){t.value=e??""}function jt(t,e,n,r){n==null?t.style.removeProperty(e):t.style.setProperty(e,n,"")}function ip(t,e,n){for(let r=0;r<t.options.length;r+=1){const s=t.options[r];if(s.__value===e){s.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function JA(t){const e=t.querySelector(":checked");return e&&e.__value}function Oe(t,e,n){t.classList.toggle(e,!!n)}function XA(t,e,{bubbles:n=!1,cancelable:r=!1}={}){return new CustomEvent(t,{detail:e,bubbles:n,cancelable:r})}let Si;function ui(t){Si=t}function rf(){if(!Si)throw new Error("Function called outside component initialization");return Si}function Oc(t){rf().$$.on_mount.push(t)}function QA(t){rf().$$.after_update.push(t)}function Nr(){const t=rf();return(e,n,{cancelable:r=!1}={})=>{const s=t.$$.callbacks[e];if(s){const a=XA(e,n,{cancelable:r});return s.slice().forEach(i=>{i.call(t,a)}),!a.defaultPrevented}return!0}}function e2(t,e){const n=t.$$.callbacks[e.type];n&&n.slice().forEach(r=>r.call(this,e))}const Hs=[],_e=[];let Qs=[];const jd=[],t2=Promise.resolve();let Hd=!1;function n2(){Hd||(Hd=!0,t2.then(r_))}function Pu(t){Qs.push(t)}function ke(t){jd.push(t)}const wl=new Set;let Rs=0;function r_(){if(Rs!==0)return;const t=Si;do{try{for(;Rs<Hs.length;){const e=Hs[Rs];Rs++,ui(e),r2(e.$$)}}catch(e){throw Hs.length=0,Rs=0,e}for(ui(null),Hs.length=0,Rs=0;_e.length;)_e.pop()();for(let e=0;e<Qs.length;e+=1){const n=Qs[e];wl.has(n)||(wl.add(n),n())}Qs.length=0}while(Hs.length);for(;jd.length;)jd.pop()();Hd=!1,wl.clear(),ui(t)}function r2(t){if(t.fragment!==null){t.update(),ut(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(Pu)}}function s2(t){const e=[],n=[];Qs.forEach(r=>t.indexOf(r)===-1?e.push(r):n.push(r)),n.forEach(r=>r()),Qs=e}const pu=new Set;let is;function Ar(){is={r:0,c:[],p:is}}function Cr(){is.r||ut(is.c),is=is.p}function oe(t,e){t&&t.i&&(pu.delete(t),t.i(e))}function he(t,e,n,r){if(t&&t.o){if(pu.has(t))return;pu.add(t),is.c.push(()=>{pu.delete(t),r&&(n&&t.d(1),r())}),t.o(e)}else r&&r()}function On(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function a2(t,e){t.d(1),e.delete(t.key)}function i2(t,e){he(t,1,1,()=>{e.delete(t.key)})}function s_(t,e,n,r,s,a,i,o,u,c,l,d){let m=t.length,p=a.length,f=m;const g={};for(;f--;)g[t[f].key]=f;const b=[],_=new Map,y=new Map,S=[];for(f=p;f--;){const w=d(s,a,f),L=n(w);let D=i.get(L);D?S.push(()=>D.p(w,e)):(D=c(L,w),D.c()),_.set(L,b[f]=D),L in g&&y.set(L,Math.abs(f-g[L]))}const I=new Set,A=new Set;function O(w){oe(w,1),w.m(o,l),i.set(w.key,w),l=w.first,p--}for(;m&&p;){const w=b[p-1],L=t[m-1],D=w.key,B=L.key;w===L?(l=w.first,m--,p--):_.has(B)?!i.has(D)||I.has(D)?O(w):A.has(B)?m--:y.get(D)>y.get(B)?(A.add(D),O(w)):(I.add(B),m--):(u(L,i),m--)}for(;m--;){const w=t[m];_.has(w.key)||u(w,i)}for(;p;)O(b[p-1]);return ut(S),b}function o2(t,e){const n={},r={},s={$$scope:1};let a=t.length;for(;a--;){const i=t[a],o=e[a];if(o){for(const u in i)u in o||(r[u]=1);for(const u in o)s[u]||(n[u]=o[u],s[u]=1);t[a]=o}else for(const u in i)s[u]=1}for(const i in r)i in n||(n[i]=void 0);return n}function Ne(t,e,n){const r=t.$$.props[e];r!==void 0&&(t.$$.bound[r]=n,n(t.$$.ctx[r]))}function Ye(t){t&&t.c()}function ze(t,e,n){const{fragment:r,after_update:s}=t.$$;r&&r.m(e,n),Pu(()=>{const a=t.$$.on_mount.map(e_).filter(t_);t.$$.on_destroy?t.$$.on_destroy.push(...a):ut(a),t.$$.on_mount=[]}),s.forEach(Pu)}function We(t,e){const n=t.$$;n.fragment!==null&&(s2(n.after_update),ut(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function u2(t,e){t.$$.dirty[0]===-1&&(Hs.push(t),n2(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function lt(t,e,n,r,s,a,i=null,o=[-1]){const u=Si;ui(t);const c=t.$$={fragment:null,ctx:[],props:a,update:it,not_equal:s,bound:rp(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(u?u.$$.context:[])),callbacks:rp(),dirty:o,skip_bound:!1,root:e.target||u.$$.root};i&&i(c.root);let l=!1;if(c.ctx=n?n(t,e.props||{},(d,m,...p)=>{const f=p.length?p[0]:m;return c.ctx&&s(c.ctx[d],c.ctx[d]=f)&&(!c.skip_bound&&c.bound[d]&&c.bound[d](f),l&&u2(t,d)),m}):[],c.update(),l=!0,ut(c.before_update),c.fragment=r?r(c.ctx):!1,e.target){if(e.hydrate){const d=KA(e.target);c.fragment&&c.fragment.l(d),d.forEach(me)}else c.fragment&&c.fragment.c();e.intro&&oe(t.$$.fragment),ze(t,e.target,e.anchor),r_()}ui(u)}class dt{constructor(){Ie(this,"$$");Ie(this,"$$set")}$destroy(){We(this,1),this.$destroy=it}$on(e,n){if(!t_(n))return it;const r=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return r.push(n),()=>{const s=r.indexOf(n);s!==-1&&r.splice(s,1)}}$set(e){this.$$set&&!VA(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const c2="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(c2);var l2=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function to(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var a_={exports:{}};(function(t,e){(function(n,r){t.exports=r()})(l2,function(){var n=1e3,r=6e4,s=36e5,a="millisecond",i="second",o="minute",u="hour",c="day",l="week",d="month",m="quarter",p="year",f="date",g="Invalid Date",b=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,_=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,y={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(x){var k=["th","st","nd","rd"],F=x%100;return"["+x+(k[(F-20)%10]||k[F]||k[0])+"]"}},S=function(x,k,F){var q=String(x);return!q||q.length>=k?x:""+Array(k+1-q.length).join(F)+x},I={s:S,z:function(x){var k=-x.utcOffset(),F=Math.abs(k),q=Math.floor(F/60),M=F%60;return(k<=0?"+":"-")+S(q,2,"0")+":"+S(M,2,"0")},m:function x(k,F){if(k.date()<F.date())return-x(F,k);var q=12*(F.year()-k.year())+(F.month()-k.month()),M=k.clone().add(q,d),z=F-M<0,X=k.clone().add(q+(z?-1:1),d);return+(-(q+(F-M)/(z?M-X:X-M))||0)},a:function(x){return x<0?Math.ceil(x)||0:Math.floor(x)},p:function(x){return{M:d,y:p,w:l,d:c,D:f,h:u,m:o,s:i,ms:a,Q:m}[x]||String(x||"").toLowerCase().replace(/s$/,"")},u:function(x){return x===void 0}},A="en",O={};O[A]=y;var w="$isDayjsObject",L=function(x){return x instanceof K||!(!x||!x[w])},D=function x(k,F,q){var M;if(!k)return A;if(typeof k=="string"){var z=k.toLowerCase();O[z]&&(M=z),F&&(O[z]=F,M=z);var X=k.split("-");if(!M&&X.length>1)return x(X[0])}else{var W=k.name;O[W]=k,M=W}return!q&&M&&(A=M),M||!q&&A},B=function(x,k){if(L(x))return x.clone();var F=typeof k=="object"?k:{};return F.date=x,F.args=arguments,new K(F)},ee=I;ee.l=D,ee.i=L,ee.w=function(x,k){return B(x,{locale:k.$L,utc:k.$u,x:k.$x,$offset:k.$offset})};var K=function(){function x(F){this.$L=D(F.locale,null,!0),this.parse(F),this.$x=this.$x||F.x||{},this[w]=!0}var k=x.prototype;return k.parse=function(F){this.$d=function(q){var M=q.date,z=q.utc;if(M===null)return new Date(NaN);if(ee.u(M))return new Date;if(M instanceof Date)return new Date(M);if(typeof M=="string"&&!/Z$/i.test(M)){var X=M.match(b);if(X){var W=X[2]-1||0,re=(X[7]||"0").substring(0,3);return z?new Date(Date.UTC(X[1],W,X[3]||1,X[4]||0,X[5]||0,X[6]||0,re)):new Date(X[1],W,X[3]||1,X[4]||0,X[5]||0,X[6]||0,re)}}return new Date(M)}(F),this.init()},k.init=function(){var F=this.$d;this.$y=F.getFullYear(),this.$M=F.getMonth(),this.$D=F.getDate(),this.$W=F.getDay(),this.$H=F.getHours(),this.$m=F.getMinutes(),this.$s=F.getSeconds(),this.$ms=F.getMilliseconds()},k.$utils=function(){return ee},k.isValid=function(){return this.$d.toString()!==g},k.isSame=function(F,q){var M=B(F);return this.startOf(q)<=M&&M<=this.endOf(q)},k.isAfter=function(F,q){return B(F)<this.startOf(q)},k.isBefore=function(F,q){return this.endOf(q)<B(F)},k.$g=function(F,q,M){return ee.u(F)?this[q]:this.set(M,F)},k.unix=function(){return Math.floor(this.valueOf()/1e3)},k.valueOf=function(){return this.$d.getTime()},k.startOf=function(F,q){var M=this,z=!!ee.u(q)||q,X=ee.p(F),W=function(In,yt){var Jn=ee.w(M.$u?Date.UTC(M.$y,yt,In):new Date(M.$y,yt,In),M);return z?Jn:Jn.endOf(c)},re=function(In,yt){return ee.w(M.toDate()[In].apply(M.toDate("s"),(z?[0,0,0,0]:[23,59,59,999]).slice(yt)),M)},be=this.$W,Pe=this.$M,Ae=this.$D,_t="set"+(this.$u?"UTC":"");switch(X){case p:return z?W(1,0):W(31,11);case d:return z?W(1,Pe):W(0,Pe+1);case l:var Ot=this.$locale().weekStart||0,Rr=(be<Ot?be+7:be)-Ot;return W(z?Ae-Rr:Ae+(6-Rr),Pe);case c:case f:return re(_t+"Hours",0);case u:return re(_t+"Minutes",1);case o:return re(_t+"Seconds",2);case i:return re(_t+"Milliseconds",3);default:return this.clone()}},k.endOf=function(F){return this.startOf(F,!1)},k.$set=function(F,q){var M,z=ee.p(F),X="set"+(this.$u?"UTC":""),W=(M={},M[c]=X+"Date",M[f]=X+"Date",M[d]=X+"Month",M[p]=X+"FullYear",M[u]=X+"Hours",M[o]=X+"Minutes",M[i]=X+"Seconds",M[a]=X+"Milliseconds",M)[z],re=z===c?this.$D+(q-this.$W):q;if(z===d||z===p){var be=this.clone().set(f,1);be.$d[W](re),be.init(),this.$d=be.set(f,Math.min(this.$D,be.daysInMonth())).$d}else W&&this.$d[W](re);return this.init(),this},k.set=function(F,q){return this.clone().$set(F,q)},k.get=function(F){return this[ee.p(F)]()},k.add=function(F,q){var M,z=this;F=Number(F);var X=ee.p(q),W=function(Pe){var Ae=B(z);return ee.w(Ae.date(Ae.date()+Math.round(Pe*F)),z)};if(X===d)return this.set(d,this.$M+F);if(X===p)return this.set(p,this.$y+F);if(X===c)return W(1);if(X===l)return W(7);var re=(M={},M[o]=r,M[u]=s,M[i]=n,M)[X]||1,be=this.$d.getTime()+F*re;return ee.w(be,this)},k.subtract=function(F,q){return this.add(-1*F,q)},k.format=function(F){var q=this,M=this.$locale();if(!this.isValid())return M.invalidDate||g;var z=F||"YYYY-MM-DDTHH:mm:ssZ",X=ee.z(this),W=this.$H,re=this.$m,be=this.$M,Pe=M.weekdays,Ae=M.months,_t=M.meridiem,Ot=function(yt,Jn,xa,Co){return yt&&(yt[Jn]||yt(q,z))||xa[Jn].slice(0,Co)},Rr=function(yt){return ee.s(W%12||12,yt,"0")},In=_t||function(yt,Jn,xa){var Co=yt<12?"AM":"PM";return xa?Co.toLowerCase():Co};return z.replace(_,function(yt,Jn){return Jn||function(xa){switch(xa){case"YY":return String(q.$y).slice(-2);case"YYYY":return ee.s(q.$y,4,"0");case"M":return be+1;case"MM":return ee.s(be+1,2,"0");case"MMM":return Ot(M.monthsShort,be,Ae,3);case"MMMM":return Ot(Ae,be);case"D":return q.$D;case"DD":return ee.s(q.$D,2,"0");case"d":return String(q.$W);case"dd":return Ot(M.weekdaysMin,q.$W,Pe,2);case"ddd":return Ot(M.weekdaysShort,q.$W,Pe,3);case"dddd":return Pe[q.$W];case"H":return String(W);case"HH":return ee.s(W,2,"0");case"h":return Rr(1);case"hh":return Rr(2);case"a":return In(W,re,!0);case"A":return In(W,re,!1);case"m":return String(re);case"mm":return ee.s(re,2,"0");case"s":return String(q.$s);case"ss":return ee.s(q.$s,2,"0");case"SSS":return ee.s(q.$ms,3,"0");case"Z":return X}return null}(yt)||X.replace(":","")})},k.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},k.diff=function(F,q,M){var z,X=this,W=ee.p(q),re=B(F),be=(re.utcOffset()-this.utcOffset())*r,Pe=this-re,Ae=function(){return ee.m(X,re)};switch(W){case p:z=Ae()/12;break;case d:z=Ae();break;case m:z=Ae()/3;break;case l:z=(Pe-be)/6048e5;break;case c:z=(Pe-be)/864e5;break;case u:z=Pe/s;break;case o:z=Pe/r;break;case i:z=Pe/n;break;default:z=Pe}return M?z:ee.a(z)},k.daysInMonth=function(){return this.endOf(d).$D},k.$locale=function(){return O[this.$L]},k.locale=function(F,q){if(!F)return this.$L;var M=this.clone(),z=D(F,q,!0);return z&&(M.$L=z),M},k.clone=function(){return ee.w(this.$d,this)},k.toDate=function(){return new Date(this.valueOf())},k.toJSON=function(){return this.isValid()?this.toISOString():null},k.toISOString=function(){return this.$d.toISOString()},k.toString=function(){return this.$d.toUTCString()},x}(),Q=K.prototype;return B.prototype=Q,[["$ms",a],["$s",i],["$m",o],["$H",u],["$W",c],["$M",d],["$y",p],["$D",f]].forEach(function(x){Q[x[1]]=function(k){return this.$g(k,x[0],x[1])}}),B.extend=function(x,k){return x.$i||(x(k,K,B),x.$i=!0),B},B.locale=D,B.isDayjs=L,B.unix=function(x){return B(1e3*x)},B.en=O[A],B.Ls=O,B.p={},B})})(a_);var d2=a_.exports;const h2=to(d2),$d="siyuan-ai-plugin-setting",i_="siyuan-ai-plugin-chat-history",qd="siyuan-ai-plugin-prompts",o_="siyuan-ai-plugin-blockid",Vd="siyuan-ai-plugin-document-vector",ko=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTYwNzg"),f2=atob("aHR0cHM6Ly9zZWFyY2guZ2Vla3NwaGVyZS5vbmxpbmUv"),op=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTMwNTkvY2Fs"),up=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTMwNTkvY2Fs");atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTA5ODE");atob("cm9vdDo3emFJR3RUTHUyIXc5IWlTXmE2OQ");const m2=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTMwNTk"),Tl=["qwen-vl-plus-latest","doubao-vision-pro-32k","qwen-vl-max-latest"];async function p2(t){let e={path:t},n="/api/file/getFile";return new Promise((r,s)=>{An.fetchPost(n,e,a=>{r(a)})})}async function g2(t,e,n){let r=new FormData;return r.append("path",t),r.append("isDir",e.toString()),r.append("modTime",Math.floor(Date.now()/1e3).toString()),r.append("file",n),vs("/api/file/putFile",r)}async function b2(t,e){return vs("/api/filetree/listDocTree",{notebook:t,path:e})}const $s="0.32.1";let cp=!1,ci,u_,zd,c_,l_,d_;function _2(t,e={auto:!1}){if(cp)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${t.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(ci)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${t.kind}'\` after \`import '@anthropic-ai/sdk/shims/${ci}'\``);cp=e.auto,ci=t.kind,u_=t.fetch,zd=t.File,c_=t.ReadableStream,l_=t.getDefaultAgent,d_=t.fileFromPath}let y2=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function E2({manuallyImported:t}={}){const e=t?"You may need to use polyfills":"Add one of these imports before your first `import  from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new y2(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:i=>!1}}ci||_2(E2(),{auto:!0});class je extends Error{}let gn=class Wd extends je{constructor(e,n,r,s){super(`${Wd.makeMessage(e,n,r)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["request-id"],this.error=n}static makeMessage(e,n,r){const s=n!=null&&n.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,n,r,s){if(!e)return new vc({message:r,cause:Kd(n)});const a=n;return e===400?new f_(e,a,r,s):e===401?new m_(e,a,r,s):e===403?new p_(e,a,r,s):e===404?new g_(e,a,r,s):e===409?new b_(e,a,r,s):e===422?new __(e,a,r,s):e===429?new y_(e,a,r,s):e>=500?new E_(e,a,r,s):new Wd(e,a,r,s)}},Mn=class extends gn{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},vc=class extends gn{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,n&&(this.cause=n)}},h_=class extends vc{constructor({message:e}={}){super({message:e??"Request timed out."})}},f_=class extends gn{constructor(){super(...arguments),this.status=400}},m_=class extends gn{constructor(){super(...arguments),this.status=401}},p_=class extends gn{constructor(){super(...arguments),this.status=403}},g_=class extends gn{constructor(){super(...arguments),this.status=404}},b_=class extends gn{constructor(){super(...arguments),this.status=409}},__=class extends gn{constructor(){super(...arguments),this.status=422}},y_=class extends gn{constructor(){super(...arguments),this.status=429}},E_=class extends gn{},no=class Gd{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let n=this.decodeText(e);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];const r=Gd.NEWLINE_CHARS.has(n[n.length-1]||"");let s=n.split(Gd.NEWLINE_REGEXP);return r&&s.pop(),s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new je(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new je(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new je("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};no.NEWLINE_CHARS=new Set([`
`,"\r"]);no.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let Ai=class Za{constructor(e,n){this.iterator=e,this.controller=n}static fromSSEResponse(e,n){let r=!1;async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const i of w2(e,n)){if(i.event==="completion")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event==="message_start"||i.event==="message_delta"||i.event==="message_stop"||i.event==="content_block_start"||i.event==="content_block_delta"||i.event==="content_block_stop")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event!=="ping"&&i.event==="error")throw gn.generate(void 0,`SSE Error: ${i.data}`,i.data,A_(e.headers))}a=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{a||n.abort()}}return new Za(s,n)}static fromReadableStream(e,n){let r=!1;async function*s(){const i=new no,o=sf(e);for await(const u of o)for(const c of i.decode(u))yield c;for(const u of i.flush())yield u}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of s())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||n.abort()}}return new Za(a,n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],n=[],r=this.iterator(),s=a=>({next:()=>{if(a.length===0){const i=r.next();e.push(i),n.push(i)}return a.shift()}});return[new Za(()=>s(e),this.controller),new Za(()=>s(n),this.controller)]}toReadableStream(){const e=this;let n;const r=new TextEncoder;return new c_({async start(){n=e[Symbol.asyncIterator]()},async pull(s){try{const{value:a,done:i}=await n.next();if(i)return s.close();const o=r.encode(JSON.stringify(a)+`
`);s.enqueue(o)}catch(a){s.error(a)}},async cancel(){var s;await((s=n.return)==null?void 0:s.call(n))}})}};async function*w2(t,e){if(!t.body)throw e.abort(),new je("Attempted to iterate over a response with no body");const n=new A2,r=new no,s=sf(t.body);for await(const a of T2(s))for(const i of r.decode(a)){const o=n.decode(i);o&&(yield o)}for(const a of r.flush()){const i=n.decode(a);i&&(yield i)}}async function*T2(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let a;for(;(a=S2(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}function S2(t){for(let r=0;r<t.length-2;r++){if(t[r]===10&&t[r+1]===10||t[r]===13&&t[r+1]===13)return r+2;if(t[r]===13&&t[r+1]===10&&r+3<t.length&&t[r+2]===13&&t[r+3]===10)return r+4}return-1}let A2=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,r,s]=C2(e,":");return s.startsWith(" ")&&(s=s.substring(1)),n==="event"?this.event=s:n==="data"&&this.data.push(s),null}};function C2(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}function sf(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n!=null&&n.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const O2=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function",v2=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&Ic(t),Ic=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function";async function I2(t,e,n){var s;if(t=await t,v2(t))return t;if(O2(t)){const a=await t.blob();e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=Ic(a)?[await a.arrayBuffer()]:[a];return new zd(i,e,n)}const r=await k2(t);if(e||(e=R2(t)??"unknown_file"),!(n!=null&&n.type)){const a=(s=r[0])==null?void 0:s.type;typeof a=="string"&&(n={...n,type:a})}return new zd(r,e,n)}async function k2(t){var n;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(Ic(t))e.push(await t.arrayBuffer());else if(P2(t))for await(const r of t)e.push(r);else throw new Error(`Unexpected data type: ${typeof t}; constructor: ${(n=t==null?void 0:t.constructor)==null?void 0:n.name}; props: ${N2(t)}`);return e}function N2(t){return`[${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}function R2(t){var e;return Sl(t.name)||Sl(t.filename)||((e=Sl(t.path))==null?void 0:e.split(/[\\/]/).pop())}const Sl=t=>{if(typeof t=="string")return t;if(typeof Buffer<"u"&&t instanceof Buffer)return String(t)},P2=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",lp=t=>t&&typeof t=="object"&&t.body&&t[Symbol.toStringTag]==="MultipartBody";var x2=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},L2=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},No;async function w_(t){const{response:e}=t;if(t.options.stream)return ea("response",e.status,e.url,e.headers,e.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(e,t.controller):Ai.fromSSEResponse(e,t.controller);if(e.status===204)return null;if(t.options.__binaryResponse)return e;const n=e.headers.get("content-type");if((n==null?void 0:n.includes("application/json"))||(n==null?void 0:n.includes("application/vnd.api+json"))){const a=await e.json();return ea("response",e.status,e.url,e.headers,a),a}const s=await e.text();return ea("response",e.status,e.url,e.headers,s),s}let T_=class S_ extends Promise{constructor(e,n=w_){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=n}_thenUnwrap(e){return new S_(this.responsePromise,async n=>e(await this.parseResponse(n),n))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},D2=class{constructor({baseURL:e,maxRetries:n=2,timeout:r=6e5,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=Al("maxRetries",n),this.timeout=Al("timeout",r),this.httpAgent=s,this.fetch=a??u_}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...H2(),...this.authHeaders(e)}}validateHeaders(e,n){}defaultIdempotencyKey(){return`stainless-node-retry-${W2()}`}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,r){return this.request(Promise.resolve(r).then(async s=>{const a=s&&Ic(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:n,...s,body:a}}))}getAPIList(e,n,r){return this.requestAPIList(n,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:n=0}={}){var g;const{method:r,path:s,query:a,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:lp(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(s,a);"timeout"in e&&Al("timeout",e.timeout);const l=e.timeout??this.timeout,d=e.httpAgent??this.httpAgent??l_(c),m=l+1e3;typeof((g=d==null?void 0:d.options)==null?void 0:g.timeout)=="number"&&m>(d.options.timeout??0)&&(d.options.timeout=m),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const p=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:n});return{req:{method:r,...o&&{body:o},headers:p,...d&&{agent:d},signal:e.signal??null},url:c,timeout:l}}buildHeaders({options:e,headers:n,contentLength:r,retryCount:s}){const a={};r&&(a["content-length"]=r);const i=this.defaultHeaders(e);return mp(a,i),mp(a,n),lp(e.body)&&ci!=="node"&&delete a["content-type"],pp(i,"x-stainless-retry-count")===void 0&&pp(n,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),this.validateHeaders(a,n),a}async prepareOptions(e){}async prepareRequest(e,{url:n,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(n=>[...n])):{...e}:{}}makeStatusError(e,n,r,s){return gn.generate(e,n,r,s)}request(e,n=null){return new T_(this.makeRequest(e,n))}async makeRequest(e,n){var d,m;const r=await e,s=r.maxRetries??this.maxRetries;n==null&&(n=s),await this.prepareOptions(r);const{req:a,url:i,timeout:o}=this.buildRequest(r,{retryCount:s-n});if(await this.prepareRequest(a,{url:i,options:r}),ea("request",i,r,a.headers),(d=r.signal)!=null&&d.aborted)throw new Mn;const u=new AbortController,c=await this.fetchWithTimeout(i,a,o,u).catch(Kd);if(c instanceof Error){if((m=r.signal)!=null&&m.aborted)throw new Mn;if(n)return this.retryRequest(r,n);throw c.name==="AbortError"?new h_:new vc({cause:c})}const l=A_(c.headers);if(!c.ok){if(n&&this.shouldRetry(c)){const y=`retrying, ${n} attempts remaining`;return ea(`response (error; ${y})`,c.status,i,l),this.retryRequest(r,n,l)}const p=await c.text().catch(y=>Kd(y).message),f=$2(p),g=f?void 0:p;throw ea(`response (error; ${n?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,g),this.makeStatusError(c.status,f,g,l)}return{response:c,options:r,controller:u}}requestAPIList(e,n){const r=this.makeRequest(n,null);return new B2(this,r,e)}buildURL(e,n){const r=V2(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return xu(s)||(n={...s,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(r.search=this.stringifyQuery(n)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([n,r])=>typeof r<"u").map(([n,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(n)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(n)}=`;throw new je(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,n,r,s){const{signal:a,...i}=n||{};a&&a.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,r){let s;const a=r==null?void 0:r["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(s=o)}const i=r==null?void 0:r["retry-after"];if(i&&!s){const o=parseFloat(i);Number.isNaN(o)?s=Date.parse(i)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(n,o)}return await z2(s),this.makeRequest(e,n-1)}calculateDefaultRetryTimeoutMillis(e,n){const a=n-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${$s}`}},M2=class{constructor(e,n,r,s){No.set(this,void 0),x2(this,No,e,"f"),this.options=s,this.response=n,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new je("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const n={...this.options};if("params"in e&&typeof n.query=="object")n.query={...n.query,...e.params};else if("url"in e){const r=[...Object.entries(n.query||{}),...e.url.searchParams.entries()];for(const[s,a]of r)e.url.searchParams.set(s,a);n.query=void 0,n.path=e.url.toString()}return await L2(this,No,"f").requestAPIList(this.constructor,n)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(No=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}},B2=class extends T_{constructor(e,n,r){super(n,async s=>new r(e,s.response,await w_(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}};const A_=t=>new Proxy(Object.fromEntries(t.entries()),{get(e,n){const r=n.toString();return e[r.toLowerCase()]||e[r]}}),F2={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Ro=t=>typeof t=="object"&&t!==null&&!xu(t)&&Object.keys(t).every(e=>C_(F2,e)),U2=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$s,"X-Stainless-OS":hp(Deno.build.os),"X-Stainless-Arch":dp(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$s,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$s,"X-Stainless-OS":hp(process.platform),"X-Stainless-Arch":dp(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const t=j2();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$s,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$s,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function j2(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const r=n.exec(navigator.userAgent);if(r){const s=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${s}.${a}.${i}`}}}return null}const dp=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",hp=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let fp;const H2=()=>fp??(fp=U2()),$2=t=>{try{return JSON.parse(t)}catch{return}},q2=new RegExp("^(?:[a-z]+:)?//","i"),V2=t=>q2.test(t),z2=t=>new Promise(e=>setTimeout(e,t)),Al=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new je(`${t} must be an integer`);if(e<0)throw new je(`${t} must be a positive integer`);return e},Kd=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null)try{return new Error(JSON.stringify(t))}catch{}return new Error(String(t))},Cl=t=>{var e,n,r,s,a;if(typeof process<"u")return((n=(e=process.env)==null?void 0:e[t])==null?void 0:n.trim())??void 0;if(typeof Deno<"u")return(a=(s=(r=Deno.env)==null?void 0:r.get)==null?void 0:s.call(r,t))==null?void 0:a.trim()};function xu(t){if(!t)return!0;for(const e in t)return!1;return!0}function C_(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function mp(t,e){for(const n in e){if(!C_(e,n))continue;const r=n.toLowerCase();if(!r)continue;const s=e[n];s===null?delete t[r]:s!==void 0&&(t[r]=s)}}function ea(t,...e){var n;typeof process<"u"&&((n=process==null?void 0:process.env)==null?void 0:n.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${t}`,...e)}const W2=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),G2=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",K2=t=>typeof(t==null?void 0:t.get)=="function",pp=(t,e)=>{var r;const n=e.toLowerCase();if(K2(t)){const s=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,i,o)=>i+o.toUpperCase());for(const a of[e,n,e.toUpperCase(),s]){const i=t.get(a);if(i)return i}}for(const[s,a]of Object.entries(t))if(s.toLowerCase()===n)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a};let Y2=class extends M2{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.first_id=r.first_id||null,this.last_id=r.last_id||null}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const n=Object.fromEntries(e.url.searchParams);return Object.keys(n).length?n:null}nextPageInfo(){var n;if((n=this.options.query)!=null&&n.before_id){const r=this.first_id;return r?{params:{before_id:r}}:null}const e=this.last_id;return e?{params:{after_id:e}}:null}},Is=class{constructor(e){this._client=e}};class af{constructor(e,n){this.iterator=e,this.controller=n}async*decoder(){const e=new no;for await(const n of this.iterator)for(const r of e.decode(n))yield JSON.parse(r);for(const n of e.flush())yield JSON.parse(n)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,n){if(!e.body)throw n.abort(),new je("Attempted to iterate over a response with no body");return new af(sf(e.body),n)}}let of=class extends Is{create(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages/batches?beta=true",{body:s,...n,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...n==null?void 0:n.headers}})}retrieve(e,n={},r){if(Ro(n))return this.retrieve(e,{},n);const{betas:s}=n;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...r,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}list(e={},n){if(Ro(e))return this.list({},e);const{betas:r,...s}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",uf,{query:s,...n,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...n==null?void 0:n.headers}})}cancel(e,n={},r){if(Ro(n))return this.cancel(e,{},n);const{betas:s}=n;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...r,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}async results(e,n={},r){if(Ro(n))return this.results(e,{},n);const s=await this.retrieve(e);if(!s.results_url)throw new je(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);const{betas:a}=n;return this._client.get(s.results_url,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers},__binaryResponse:!0})._thenUnwrap((i,o)=>af.fromResponse(o.response,o.controller))}};class uf extends Y2{}of.BetaMessageBatchesPage=uf;let kc=class extends Is{constructor(){super(...arguments),this.batches=new of(this._client)}create(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages?beta=true",{body:s,timeout:this._client._options.timeout??6e5,...n,headers:{...(r==null?void 0:r.toString())!=null?{"anthropic-beta":r==null?void 0:r.toString()}:void 0,...n==null?void 0:n.headers},stream:e.stream??!1})}countTokens(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:s,...n,headers:{"anthropic-beta":[...r??[],"token-counting-2024-11-01"].toString(),...n==null?void 0:n.headers}})}};kc.Batches=of;kc.BetaMessageBatchesPage=uf;const Z2=t=>{let e=0,n=[];for(;e<t.length;){let r=t[e];if(r==="\\"){e++;continue}if(r==="{"){n.push({type:"brace",value:"{"}),e++;continue}if(r==="}"){n.push({type:"brace",value:"}"}),e++;continue}if(r==="["){n.push({type:"paren",value:"["}),e++;continue}if(r==="]"){n.push({type:"paren",value:"]"}),e++;continue}if(r===":"){n.push({type:"separator",value:":"}),e++;continue}if(r===","){n.push({type:"delimiter",value:","}),e++;continue}if(r==='"'){let o="",u=!1;for(r=t[++e];r!=='"';){if(e===t.length){u=!0;break}if(r==="\\"){if(e++,e===t.length){u=!0;break}o+=r+t[e],r=t[++e]}else o+=r,r=t[++e]}r=t[++e],u||n.push({type:"string",value:o});continue}if(r&&/\s/.test(r)){e++;continue}let a=/[0-9]/;if(r&&a.test(r)||r==="-"||r==="."){let o="";for(r==="-"&&(o+=r,r=t[++e]);r&&a.test(r)||r===".";)o+=r,r=t[++e];n.push({type:"number",value:o});continue}let i=/[a-z]/i;if(r&&i.test(r)){let o="";for(;r&&i.test(r)&&e!==t.length;)o+=r,r=t[++e];if(o=="true"||o=="false"||o==="null")n.push({type:"name",value:o});else{e++;continue}continue}e++}return n},qs=t=>{if(t.length===0)return t;let e=t[t.length-1];switch(e.type){case"separator":return t=t.slice(0,t.length-1),qs(t);case"number":let n=e.value[e.value.length-1];if(n==="."||n==="-")return t=t.slice(0,t.length-1),qs(t);case"string":let r=t[t.length-2];if((r==null?void 0:r.type)==="delimiter")return t=t.slice(0,t.length-1),qs(t);if((r==null?void 0:r.type)==="brace"&&r.value==="{")return t=t.slice(0,t.length-1),qs(t);break;case"delimiter":return t=t.slice(0,t.length-1),qs(t)}return t},J2=t=>{let e=[];return t.map(n=>{n.type==="brace"&&(n.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),n.type==="paren"&&(n.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(n=>{n==="}"?t.push({type:"brace",value:"}"}):n==="]"&&t.push({type:"paren",value:"]"})}),t},X2=t=>{let e="";return t.map(n=>{switch(n.type){case"string":e+='"'+n.value+'"';break;default:e+=n.value;break}}),e},O_=t=>JSON.parse(X2(J2(qs(Z2(t)))));var Vt=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},xe=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},bn,xr,Po,xo,Da,Ma,Lo,Ba,mr,Fa,Do,Mo,Ps,Ol,gp,vl,Il,kl,Nl,bp;const _p="__json_buf";class Lu{constructor(){bn.add(this),this.messages=[],this.receivedMessages=[],xr.set(this,void 0),this.controller=new AbortController,Po.set(this,void 0),xo.set(this,()=>{}),Da.set(this,()=>{}),Ma.set(this,void 0),Lo.set(this,()=>{}),Ba.set(this,()=>{}),mr.set(this,{}),Fa.set(this,!1),Do.set(this,!1),Mo.set(this,!1),Ps.set(this,!1),vl.set(this,e=>{if(Vt(this,Do,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Mn),e instanceof Mn)return Vt(this,Mo,!0,"f"),this._emit("abort",e);if(e instanceof je)return this._emit("error",e);if(e instanceof Error){const n=new je(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new je(String(e)))}),Vt(this,Po,new Promise((e,n)=>{Vt(this,xo,e,"f"),Vt(this,Da,n,"f")}),"f"),Vt(this,Ma,new Promise((e,n)=>{Vt(this,Lo,e,"f"),Vt(this,Ba,n,"f")}),"f"),xe(this,Po,"f").catch(()=>{}),xe(this,Ma,"f").catch(()=>{})}static fromReadableStream(e){const n=new Lu;return n._run(()=>n._fromReadableStream(e)),n}static createMessage(e,n,r){const s=new Lu;for(const a of n.messages)s._addPromptCachingBetaMessageParam(a);return s._run(()=>s._createPromptCachingBetaMessage(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},xe(this,vl,"f"))}_addPromptCachingBetaMessageParam(e){this.messages.push(e)}_addPromptCachingBetaMessage(e,n=!0){this.receivedMessages.push(e),n&&this._emit("message",e)}async _createPromptCachingBetaMessage(e,n,r){var i;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),xe(this,bn,"m",Il).call(this);const a=await e.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)xe(this,bn,"m",kl).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new Mn;xe(this,bn,"m",Nl).call(this)}_connected(){this.ended||(xe(this,xo,"f").call(this),this._emit("connect"))}get ended(){return xe(this,Fa,"f")}get errored(){return xe(this,Do,"f")}get aborted(){return xe(this,Mo,"f")}abort(){this.controller.abort()}on(e,n){return(xe(this,mr,"f")[e]||(xe(this,mr,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=xe(this,mr,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(xe(this,mr,"f")[e]||(xe(this,mr,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{Vt(this,Ps,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){Vt(this,Ps,!0,"f"),await xe(this,Ma,"f")}get currentMessage(){return xe(this,xr,"f")}async finalMessage(){return await this.done(),xe(this,bn,"m",Ol).call(this)}async finalText(){return await this.done(),xe(this,bn,"m",gp).call(this)}_emit(e,...n){if(xe(this,Fa,"f"))return;e==="end"&&(Vt(this,Fa,!0,"f"),xe(this,Lo,"f").call(this));const r=xe(this,mr,"f")[e];if(r&&(xe(this,mr,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!xe(this,Ps,"f")&&!(r!=null&&r.length)&&Promise.reject(s),xe(this,Da,"f").call(this,s),xe(this,Ba,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!xe(this,Ps,"f")&&!(r!=null&&r.length)&&Promise.reject(s),xe(this,Da,"f").call(this,s),xe(this,Ba,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalPromptCachingBetaMessage",xe(this,bn,"m",Ol).call(this))}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),xe(this,bn,"m",Il).call(this),this._connected();const s=Ai.fromReadableStream(e,this.controller);for await(const i of s)xe(this,bn,"m",kl).call(this,i);if((a=s.controller.signal)!=null&&a.aborted)throw new Mn;xe(this,bn,"m",Nl).call(this)}[(xr=new WeakMap,Po=new WeakMap,xo=new WeakMap,Da=new WeakMap,Ma=new WeakMap,Lo=new WeakMap,Ba=new WeakMap,mr=new WeakMap,Fa=new WeakMap,Do=new WeakMap,Mo=new WeakMap,Ps=new WeakMap,vl=new WeakMap,bn=new WeakSet,Ol=function(){if(this.receivedMessages.length===0)throw new je("stream ended without producing a PromptCachingBetaMessage with role=assistant");return this.receivedMessages.at(-1)},gp=function(){if(this.receivedMessages.length===0)throw new je("stream ended without producing a PromptCachingBetaMessage with role=assistant");const n=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(n.length===0)throw new je("stream ended without producing a content block with type=text");return n.join(" ")},Il=function(){this.ended||Vt(this,xr,void 0,"f")},kl=function(n){if(this.ended)return;const r=xe(this,bn,"m",bp).call(this,n);switch(this._emit("streamEvent",n,r),n.type){case"content_block_delta":{const s=r.content.at(-1);n.delta.type==="text_delta"&&s.type==="text"?this._emit("text",n.delta.text,s.text||""):n.delta.type==="input_json_delta"&&s.type==="tool_use"&&s.input&&this._emit("inputJson",n.delta.partial_json,s.input);break}case"message_stop":{this._addPromptCachingBetaMessageParam(r),this._addPromptCachingBetaMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{Vt(this,xr,r,"f");break}}},Nl=function(){if(this.ended)throw new je("stream has ended, this shouldn't happen");const n=xe(this,xr,"f");if(!n)throw new je("request ended without sending any chunks");return Vt(this,xr,void 0,"f"),n},bp=function(n){let r=xe(this,xr,"f");if(n.type==="message_start"){if(r)throw new je(`Unexpected event order, got ${n.type} before receiving "message_stop"`);return n.message}if(!r)throw new je(`Unexpected event order, got ${n.type} before "message_start"`);switch(n.type){case"message_stop":return r;case"message_delta":return r.stop_reason=n.delta.stop_reason,r.stop_sequence=n.delta.stop_sequence,r.usage.output_tokens=n.usage.output_tokens,r;case"content_block_start":return r.content.push(n.content_block),r;case"content_block_delta":{const s=r.content.at(n.index);if((s==null?void 0:s.type)==="text"&&n.delta.type==="text_delta")s.text+=n.delta.text;else if((s==null?void 0:s.type)==="tool_use"&&n.delta.type==="input_json_delta"){let a=s[_p]||"";a+=n.delta.partial_json,Object.defineProperty(s,_p,{value:a,enumerable:!1,writable:!0}),a&&(s.input=O_(a))}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("streamEvent",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ai(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}let v_=class extends Is{create(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages?beta=prompt_caching",{body:s,timeout:this._client._options.timeout??6e5,...n,headers:{"anthropic-beta":[...r??[],"prompt-caching-2024-07-31"].toString(),...n==null?void 0:n.headers},stream:e.stream??!1})}stream(e,n){return Lu.createMessage(this,e,n)}};class cf extends Is{constructor(){super(...arguments),this.messages=new v_(this._client)}}cf.Messages=v_;let Nc=class extends Is{constructor(){super(...arguments),this.messages=new kc(this._client),this.promptCaching=new cf(this._client)}};Nc.Messages=kc;Nc.PromptCaching=cf;let I_=class extends Is{create(e,n){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...n,stream:e.stream??!1})}};var zt=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Le=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},_n,Lr,Bo,Fo,Ua,ja,Uo,Ha,pr,$a,jo,Ho,xs,Rl,yp,Pl,xl,Ll,Dl,Ep;const wp="__json_buf";class Du{constructor(){_n.add(this),this.messages=[],this.receivedMessages=[],Lr.set(this,void 0),this.controller=new AbortController,Bo.set(this,void 0),Fo.set(this,()=>{}),Ua.set(this,()=>{}),ja.set(this,void 0),Uo.set(this,()=>{}),Ha.set(this,()=>{}),pr.set(this,{}),$a.set(this,!1),jo.set(this,!1),Ho.set(this,!1),xs.set(this,!1),Pl.set(this,e=>{if(zt(this,jo,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Mn),e instanceof Mn)return zt(this,Ho,!0,"f"),this._emit("abort",e);if(e instanceof je)return this._emit("error",e);if(e instanceof Error){const n=new je(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new je(String(e)))}),zt(this,Bo,new Promise((e,n)=>{zt(this,Fo,e,"f"),zt(this,Ua,n,"f")}),"f"),zt(this,ja,new Promise((e,n)=>{zt(this,Uo,e,"f"),zt(this,Ha,n,"f")}),"f"),Le(this,Bo,"f").catch(()=>{}),Le(this,ja,"f").catch(()=>{})}static fromReadableStream(e){const n=new Du;return n._run(()=>n._fromReadableStream(e)),n}static createMessage(e,n,r){const s=new Du;for(const a of n.messages)s._addMessageParam(a);return s._run(()=>s._createMessage(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},Le(this,Pl,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,n=!0){this.receivedMessages.push(e),n&&this._emit("message",e)}async _createMessage(e,n,r){var i;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Le(this,_n,"m",xl).call(this);const a=await e.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)Le(this,_n,"m",Ll).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new Mn;Le(this,_n,"m",Dl).call(this)}_connected(){this.ended||(Le(this,Fo,"f").call(this),this._emit("connect"))}get ended(){return Le(this,$a,"f")}get errored(){return Le(this,jo,"f")}get aborted(){return Le(this,Ho,"f")}abort(){this.controller.abort()}on(e,n){return(Le(this,pr,"f")[e]||(Le(this,pr,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=Le(this,pr,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(Le(this,pr,"f")[e]||(Le(this,pr,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{zt(this,xs,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){zt(this,xs,!0,"f"),await Le(this,ja,"f")}get currentMessage(){return Le(this,Lr,"f")}async finalMessage(){return await this.done(),Le(this,_n,"m",Rl).call(this)}async finalText(){return await this.done(),Le(this,_n,"m",yp).call(this)}_emit(e,...n){if(Le(this,$a,"f"))return;e==="end"&&(zt(this,$a,!0,"f"),Le(this,Uo,"f").call(this));const r=Le(this,pr,"f")[e];if(r&&(Le(this,pr,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!Le(this,xs,"f")&&!(r!=null&&r.length)&&Promise.reject(s),Le(this,Ua,"f").call(this,s),Le(this,Ha,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!Le(this,xs,"f")&&!(r!=null&&r.length)&&Promise.reject(s),Le(this,Ua,"f").call(this,s),Le(this,Ha,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",Le(this,_n,"m",Rl).call(this))}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Le(this,_n,"m",xl).call(this),this._connected();const s=Ai.fromReadableStream(e,this.controller);for await(const i of s)Le(this,_n,"m",Ll).call(this,i);if((a=s.controller.signal)!=null&&a.aborted)throw new Mn;Le(this,_n,"m",Dl).call(this)}[(Lr=new WeakMap,Bo=new WeakMap,Fo=new WeakMap,Ua=new WeakMap,ja=new WeakMap,Uo=new WeakMap,Ha=new WeakMap,pr=new WeakMap,$a=new WeakMap,jo=new WeakMap,Ho=new WeakMap,xs=new WeakMap,Pl=new WeakMap,_n=new WeakSet,Rl=function(){if(this.receivedMessages.length===0)throw new je("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},yp=function(){if(this.receivedMessages.length===0)throw new je("stream ended without producing a Message with role=assistant");const n=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(n.length===0)throw new je("stream ended without producing a content block with type=text");return n.join(" ")},xl=function(){this.ended||zt(this,Lr,void 0,"f")},Ll=function(n){if(this.ended)return;const r=Le(this,_n,"m",Ep).call(this,n);switch(this._emit("streamEvent",n,r),n.type){case"content_block_delta":{const s=r.content.at(-1);n.delta.type==="text_delta"&&s.type==="text"?this._emit("text",n.delta.text,s.text||""):n.delta.type==="input_json_delta"&&s.type==="tool_use"&&s.input&&this._emit("inputJson",n.delta.partial_json,s.input);break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{zt(this,Lr,r,"f");break}}},Dl=function(){if(this.ended)throw new je("stream has ended, this shouldn't happen");const n=Le(this,Lr,"f");if(!n)throw new je("request ended without sending any chunks");return zt(this,Lr,void 0,"f"),n},Ep=function(n){let r=Le(this,Lr,"f");if(n.type==="message_start"){if(r)throw new je(`Unexpected event order, got ${n.type} before receiving "message_stop"`);return n.message}if(!r)throw new je(`Unexpected event order, got ${n.type} before "message_start"`);switch(n.type){case"message_stop":return r;case"message_delta":return r.stop_reason=n.delta.stop_reason,r.stop_sequence=n.delta.stop_sequence,r.usage.output_tokens=n.usage.output_tokens,r;case"content_block_start":return r.content.push(n.content_block),r;case"content_block_delta":{const s=r.content.at(n.index);if((s==null?void 0:s.type)==="text"&&n.delta.type==="text_delta")s.text+=n.delta.text;else if((s==null?void 0:s.type)==="tool_use"&&n.delta.type==="input_json_delta"){let a=s[wp]||"";a+=n.delta.partial_json,Object.defineProperty(s,wp,{value:a,enumerable:!1,writable:!0}),a&&(s.input=O_(a))}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("streamEvent",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ai(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}let k_=class extends Is{create(e,n){return e.model in Tp&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Tp[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??6e5,...n,stream:e.stream??!1})}stream(e,n){return Du.createMessage(this,e,n)}};const Tp={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024"};var N_;class tt extends D2{constructor({baseURL:e=Cl("ANTHROPIC_BASE_URL"),apiKey:n=Cl("ANTHROPIC_API_KEY")??null,authToken:r=Cl("ANTHROPIC_AUTH_TOKEN")??null,...s}={}){const a={apiKey:n,authToken:r,...s,baseURL:e||"https://api.anthropic.com"};if(!a.dangerouslyAllowBrowser&&G2())throw new je(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });

TODO: link!
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new I_(this),this.messages=new k_(this),this.beta=new Nc(this),this._options=a,this.apiKey=n,this.authToken=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,n){if(!(this.apiKey&&e["x-api-key"])&&n["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&n.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){const n=this.apiKeyAuth(e),r=this.bearerAuth(e);return n!=null&&!xu(n)?n:r!=null&&!xu(r)?r:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}}N_=tt;tt.Anthropic=N_;tt.HUMAN_PROMPT=`

Human:`;tt.AI_PROMPT=`

Assistant:`;tt.DEFAULT_TIMEOUT=6e5;tt.AnthropicError=je;tt.APIError=gn;tt.APIConnectionError=vc;tt.APIConnectionTimeoutError=h_;tt.APIUserAbortError=Mn;tt.NotFoundError=g_;tt.ConflictError=b_;tt.RateLimitError=y_;tt.BadRequestError=f_;tt.AuthenticationError=m_;tt.InternalServerError=E_;tt.PermissionDeniedError=p_;tt.UnprocessableEntityError=__;tt.toFile=I2;tt.fileFromPath=d_;tt.Completions=I_;tt.Messages=k_;tt.Beta=Nc;function Sp(t,e=lf){t=t.trim();const n=/```(json)?(.*)```/s.exec(t);return e(n?n[2]:t)}function lf(t){if(typeof t>"u")return null;try{return JSON.parse(t)}catch{}let e="";const n=[];let r=!1,s=!1;for(let a of t){if(r)a==='"'&&!s?r=!1:a===`
`&&!s?a="\\n":a==="\\"?s=!s:s=!1;else if(a==='"')r=!0,s=!1;else if(a==="{")n.push("}");else if(a==="[")n.push("]");else if(a==="}"||a==="]")if(n[n.length-1]===a)n.pop();else return null;e+=a}r&&(e+='"');for(let a=n.length-1;a>=0;a-=1)e+=n[a];try{return JSON.parse(e)}catch{return null}}var Q2=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const eC=to(Q2);var R_={exports:{}};const tC=/[\p{Lu}]/u,nC=/[\p{Ll}]/u,Ap=/^[\p{Lu}](?![\p{Lu}])/gu,P_=/([\p{Alpha}\p{N}_]|$)/u,x_=/[_.\- ]+/,rC=new RegExp("^"+x_.source),Cp=new RegExp(x_.source+P_.source,"gu"),Op=new RegExp("\\d+"+P_.source,"gu"),sC=(t,e,n)=>{let r=!1,s=!1,a=!1;for(let i=0;i<t.length;i++){const o=t[i];r&&tC.test(o)?(t=t.slice(0,i)+"-"+t.slice(i),r=!1,a=s,s=!0,i++):s&&a&&nC.test(o)?(t=t.slice(0,i-1)+"-"+t.slice(i-1),a=s,s=!1,r=!0):(r=e(o)===o&&n(o)!==o,a=s,s=n(o)===o&&e(o)!==o)}return t},aC=(t,e)=>(Ap.lastIndex=0,t.replace(Ap,n=>e(n))),iC=(t,e)=>(Cp.lastIndex=0,Op.lastIndex=0,t.replace(Cp,(n,r)=>e(r)).replace(Op,n=>e(n))),L_=(t,e)=>{if(!(typeof t=="string"||Array.isArray(t)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(t)?t=t.map(a=>a.trim()).filter(a=>a.length).join("-"):t=t.trim(),t.length===0)return"";const n=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),r=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return t.length===1?e.pascalCase?r(t):n(t):(t!==n(t)&&(t=sC(t,n,r)),t=t.replace(rC,""),e.preserveConsecutiveUppercase?t=aC(t,n):t=n(t),e.pascalCase&&(t=r(t.charAt(0))+t.slice(1)),iC(t,r))};R_.exports=L_;R_.exports.default=L_;function oC(t,e){return(e==null?void 0:e[t])||eC(t)}function uC(t,e,n){const r={};for(const s in t)Object.hasOwn(t,s)&&(r[e(s,n)]=t[s]);return r}function vp(t){return Array.isArray(t)?[...t]:{...t}}function cC(t,e){const n=vp(t);for(const[r,s]of Object.entries(e)){const[a,...i]=r.split(".").reverse();let o=n;for(const u of i.reverse()){if(o[u]===void 0)break;o[u]=vp(o[u]),o=o[u]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[s]})}return n}function D_(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}class Vr{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,D_(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...n){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Vr||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},n={},r=Object.keys(this.lc_kwargs).reduce((s,a)=>(s[a]=a in this?this[a]:this.lc_kwargs[a],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(n,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(n).forEach(s=>{let a=this,i=r;const[o,...u]=s.split(".").reverse();for(const c of u.reverse()){if(!(c in a)||a[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof a[c]=="object"&&a[c]!=null?i[c]={}:Array.isArray(a[c])&&(i[c]=[])),a=a[c],i=i[c]}o in a&&a[o]!==void 0&&(i[o]=i[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:uC(Object.keys(n).length?cC(r,n):r,oC,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function ya(t,e){return typeof t=="string"?typeof e=="string"?t+e:[{type:"text",text:t},...e]:Array.isArray(e)?Rc(t,e)??[...t,...e]:[...t,{type:"text",text:e}]}function lC(t,e){return t==="error"||e==="error"?"error":"success"}function dC(t,e){function n(r,s){if(typeof r!="object"||r===null||r===void 0)return r;if(s>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>n(i,s+1));const a={};for(const i of Object.keys(r))a[i]=n(r[i],s+1);return a}return JSON.stringify(n(t,0),null,2)}class Ea extends Vr{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}getType(){return this._getType()}constructor(e,n){typeof e=="string"&&(e={content:e,additional_kwargs:n,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const n=dC(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${n}`}}function Ht(t,e){const n={...t};for(const[r,s]of Object.entries(e))if(n[r]==null)n[r]=s;else{if(s==null)continue;if(typeof n[r]!=typeof s||Array.isArray(n[r])!==Array.isArray(s))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof n[r]=="string"){if(r==="type")continue;n[r]+=s}else if(typeof n[r]=="object"&&!Array.isArray(n[r]))n[r]=Ht(n[r],s);else if(Array.isArray(n[r]))n[r]=Rc(n[r],s);else{if(n[r]===s)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return n}function Rc(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t||e;{const n=[...t];for(const r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){const s=n.findIndex(a=>a.index===r.index);s!==-1?n[s]=Ht(n[s],r):n.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;n.push(r)}return n}}}function hC(t,e){if(!t&&!e)throw new Error("Cannot merge two undefined objects.");if(!t||!e)return t||e;if(typeof t!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof t}
Right ${typeof e}`);if(typeof t=="string"&&typeof e=="string")return t+e;if(Array.isArray(t)&&Array.isArray(e))return Rc(t,e);if(typeof t=="object"&&typeof e=="object")return Ht(t,e);if(t===e)return t;throw new Error(`Can not merge objects of different types.
Left ${t}
Right ${e}`)}class wa extends Ea{}function fC(t){return typeof t.role=="string"}function Pc(t){return typeof(t==null?void 0:t._getType)=="function"}function mC(t){return Pc(t)&&typeof t.concat=="function"}function pC(t){return t!=null&&typeof t=="object"&&"lc_direct_tool_output"in t&&t.lc_direct_tool_output===!0}class Yd extends Ea{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,n,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:n}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class df extends wa{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new df({content:ya(this.content,e.content),additional_kwargs:Ht(this.additional_kwargs,e.additional_kwargs),response_metadata:Ht(this.response_metadata,e.response_metadata),artifact:hC(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:lC(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function gC(t){const e=[],n=[];for(const r of t)if(r.function){const s=r.function.name;try{const a=JSON.parse(r.function.arguments),i={name:s||"",args:a||{},id:r.id};e.push(i)}catch{n.push({name:s,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,n]}class bs extends Ea{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,n){var s;let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:n??{}};else{r=e;const a=(s=r.additional_kwargs)==null?void 0:s.tool_calls,i=r.tool_calls;a!=null&&a.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&i===void 0){const[o,u]=gC(a);r.tool_calls=o??[],r.invalid_tool_calls=u??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function ro(t){return t._getType()==="ai"}function Ip(t){return t._getType()==="ai"}class Zt extends wa{constructor(e){let n;if(typeof e=="string")n={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)n={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const r=[],s=[];for(const a of e.tool_call_chunks){let i={};try{if(i=lf(a.args||"{}"),i===null||typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:a.name??"",args:i,id:a.id,type:"tool_call"})}catch{s.push({name:a.name,args:a.args,id:a.id,error:"Malformed args.",type:"invalid_tool_call"})}}n={...e,tool_calls:r,invalid_tool_calls:s,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=n.tool_call_chunks??this.tool_call_chunks,this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){var r,s,a,i,o,u,c,l,d,m,p,f,g,b,_,y,S,I,A,O,w,L,D,B,ee,K,Q,x,k,F,q,M,z,X,W,re,be,Pe,Ae,_t;const n={content:ya(this.content,e.content),additional_kwargs:Ht(this.additional_kwargs,e.additional_kwargs),response_metadata:Ht(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const Ot=Rc(this.tool_call_chunks,e.tool_call_chunks);Ot!==void 0&&Ot.length>0&&(n.tool_call_chunks=Ot)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){const Ot={...(((s=(r=this.usage_metadata)==null?void 0:r.input_token_details)==null?void 0:s.audio)!==void 0||((i=(a=e.usage_metadata)==null?void 0:a.input_token_details)==null?void 0:i.audio)!==void 0)&&{audio:(((u=(o=this.usage_metadata)==null?void 0:o.input_token_details)==null?void 0:u.audio)??0)+(((l=(c=e.usage_metadata)==null?void 0:c.input_token_details)==null?void 0:l.audio)??0)},...(((m=(d=this.usage_metadata)==null?void 0:d.input_token_details)==null?void 0:m.cache_read)!==void 0||((f=(p=e.usage_metadata)==null?void 0:p.input_token_details)==null?void 0:f.cache_read)!==void 0)&&{cache_read:(((b=(g=this.usage_metadata)==null?void 0:g.input_token_details)==null?void 0:b.cache_read)??0)+(((y=(_=e.usage_metadata)==null?void 0:_.input_token_details)==null?void 0:y.cache_read)??0)},...(((I=(S=this.usage_metadata)==null?void 0:S.input_token_details)==null?void 0:I.cache_creation)!==void 0||((O=(A=e.usage_metadata)==null?void 0:A.input_token_details)==null?void 0:O.cache_creation)!==void 0)&&{cache_creation:(((L=(w=this.usage_metadata)==null?void 0:w.input_token_details)==null?void 0:L.cache_creation)??0)+(((B=(D=e.usage_metadata)==null?void 0:D.input_token_details)==null?void 0:B.cache_creation)??0)}},Rr={...(((K=(ee=this.usage_metadata)==null?void 0:ee.output_token_details)==null?void 0:K.audio)!==void 0||((x=(Q=e.usage_metadata)==null?void 0:Q.output_token_details)==null?void 0:x.audio)!==void 0)&&{audio:(((F=(k=this.usage_metadata)==null?void 0:k.output_token_details)==null?void 0:F.audio)??0)+(((M=(q=e.usage_metadata)==null?void 0:q.output_token_details)==null?void 0:M.audio)??0)},...(((X=(z=this.usage_metadata)==null?void 0:z.output_token_details)==null?void 0:X.reasoning)!==void 0||((re=(W=e.usage_metadata)==null?void 0:W.output_token_details)==null?void 0:re.reasoning)!==void 0)&&{reasoning:(((Pe=(be=this.usage_metadata)==null?void 0:be.output_token_details)==null?void 0:Pe.reasoning)??0)+(((_t=(Ae=e.usage_metadata)==null?void 0:Ae.output_token_details)==null?void 0:_t.reasoning)??0)}},In=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},yt=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},Jn={input_tokens:In.input_tokens+yt.input_tokens,output_tokens:In.output_tokens+yt.output_tokens,total_tokens:In.total_tokens+yt.total_tokens,...Object.keys(Ot).length>0&&{input_token_details:Ot},...Object.keys(Rr).length>0&&{output_token_details:Rr}};n.usage_metadata=Jn}return new Zt(n)}}class so extends Ea{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return so}constructor(e,n){typeof e=="string"&&(e={content:e,role:n}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}}class xc extends wa{static lc_name(){return"ChatMessageChunk"}constructor(e,n){typeof e=="string"&&(e={content:e,role:n}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new xc({content:ya(this.content,e.content),additional_kwargs:Ht(this.additional_kwargs,e.additional_kwargs),response_metadata:Ht(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class Lc extends wa{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new Lc({content:ya(this.content,e.content),additional_kwargs:Ht(this.additional_kwargs,e.additional_kwargs),response_metadata:Ht(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class or extends Ea{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class Dc extends wa{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new Dc({content:ya(this.content,e.content),additional_kwargs:Ht(this.additional_kwargs,e.additional_kwargs),response_metadata:Ht(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class Zd extends Ea{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Ci extends wa{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Ci({content:ya(this.content,e.content),additional_kwargs:Ht(this.additional_kwargs,e.additional_kwargs),response_metadata:Ht(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function M_(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function hf(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}class B_ extends Error{constructor(e,n){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=n}}function bC(t){return hf(t)?t:typeof t.id=="string"&&t.type==="function"&&typeof t.function=="object"&&t.function!==null&&"arguments"in t.function&&typeof t.function.arguments=="string"&&"name"in t.function&&typeof t.function.name=="string"?{id:t.id,args:JSON.parse(t.function.arguments),name:t.function.name,type:"tool_call"}:t}function _C(t){return typeof t=="object"&&t!=null&&t.lc===1&&Array.isArray(t.id)&&t.kwargs!=null&&typeof t.kwargs=="object"}function Ml(t){let e,n;if(_C(t)){const r=t.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":e="unknown",n=t.kwargs}else{const{type:r,...s}=t;e=r,n=s}if(e==="human"||e==="user")return new or(n);if(e==="ai"||e==="assistant"){const{tool_calls:r,...s}=n;if(!Array.isArray(r))return new bs(n);const a=r.map(bC);return new bs({...s,tool_calls:a})}else{if(e==="system")return new Zd(n);if(e==="developer")return new Zd({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in n)return new Yd({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});throw M_(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(t,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Ja(t){if(typeof t=="string")return new or(t);if(Pc(t))return t;if(Array.isArray(t)){const[e,n]=t;return Ml({type:e,content:n})}else if(fC(t)){const{role:e,...n}=t;return Ml({...n,type:e})}else return Ml(t)}function F_(t,e="Human",n="AI"){const r=[];for(const s of t){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=n;else if(s._getType()==="system")a="System";else if(s._getType()==="function")a="Function";else if(s._getType()==="tool")a="Tool";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const i=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);r.push(`${a}: ${i}${o}`)}return r.join(`
`)}function yC(t){var n;const e=t._getType();if(e==="human")return new Dc({...t});if(e==="ai"){let r={...t};return"tool_calls"in r&&(r={...r,tool_call_chunks:(n=r.tool_calls)==null?void 0:n.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new Zt({...r})}else{if(e==="system")return new Ci({...t});if(e==="function")return new Lc({...t});if(so.isInstance(t))return new xc({...t});throw new Error("Unknown message type.")}}var Me;(function(t){t.assertEqual=s=>s;function e(s){}t.assertIs=e;function n(s){throw new Error}t.assertNever=n,t.arrayToEnum=s=>{const a={};for(const i of s)a[i]=i;return a},t.getValidEnumValues=s=>{const a=t.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),i={};for(const o of a)i[o]=s[o];return t.objectValues(i)},t.objectValues=s=>t.objectKeys(s).map(function(a){return s[a]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const a=[];for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&a.push(i);return a},t.find=(s,a)=>{for(const i of s)if(a(i))return i},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&isFinite(s)&&Math.floor(s)===s;function r(s,a=" | "){return s.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}t.joinValues=r,t.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(Me||(Me={}));var Jd;(function(t){t.mergeShapes=(e,n)=>({...e,...n})})(Jd||(Jd={}));const ne=Me.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Tr=t=>{switch(typeof t){case"undefined":return ne.undefined;case"string":return ne.string;case"number":return isNaN(t)?ne.nan:ne.number;case"boolean":return ne.boolean;case"function":return ne.function;case"bigint":return ne.bigint;case"symbol":return ne.symbol;case"object":return Array.isArray(t)?ne.array:t===null?ne.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?ne.promise:typeof Map<"u"&&t instanceof Map?ne.map:typeof Set<"u"&&t instanceof Set?ne.set:typeof Date<"u"&&t instanceof Date?ne.date:ne.object;default:return ne.unknown}},J=Me.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),EC=t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:");class hn extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const n=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,n):this.__proto__=n,this.name="ZodError",this.issues=e}format(e){const n=e||function(a){return a.message},r={_errors:[]},s=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(s);else if(i.code==="invalid_return_type")s(i.returnTypeError);else if(i.code==="invalid_arguments")s(i.argumentsError);else if(i.path.length===0)r._errors.push(n(i));else{let o=r,u=0;for(;u<i.path.length;){const c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(n(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return s(this),r}static assert(e){if(!(e instanceof hn))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Me.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=n=>n.message){const n={},r=[];for(const s of this.issues)s.path.length>0?(n[s.path[0]]=n[s.path[0]]||[],n[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:n}}get formErrors(){return this.flatten()}}hn.create=t=>new hn(t);const ia=(t,e)=>{let n;switch(t.code){case J.invalid_type:t.received===ne.undefined?n="Required":n=`Expected ${t.expected}, received ${t.received}`;break;case J.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(t.expected,Me.jsonStringifyReplacer)}`;break;case J.unrecognized_keys:n=`Unrecognized key(s) in object: ${Me.joinValues(t.keys,", ")}`;break;case J.invalid_union:n="Invalid input";break;case J.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${Me.joinValues(t.options)}`;break;case J.invalid_enum_value:n=`Invalid enum value. Expected ${Me.joinValues(t.options)}, received '${t.received}'`;break;case J.invalid_arguments:n="Invalid function arguments";break;case J.invalid_return_type:n="Invalid function return type";break;case J.invalid_date:n="Invalid date";break;case J.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(n=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(n=`${n} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?n=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?n=`Invalid input: must end with "${t.validation.endsWith}"`:Me.assertNever(t.validation):t.validation!=="regex"?n=`Invalid ${t.validation}`:n="Invalid";break;case J.too_small:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:n="Invalid input";break;case J.too_big:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?n=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:n="Invalid input";break;case J.custom:n="Invalid input";break;case J.invalid_intersection_types:n="Intersection results could not be merged";break;case J.not_multiple_of:n=`Number must be a multiple of ${t.multipleOf}`;break;case J.not_finite:n="Number must be finite";break;default:n=e.defaultError,Me.assertNever(t)}return{message:n}};let U_=ia;function wC(t){U_=t}function Mu(){return U_}const Bu=t=>{const{data:e,path:n,errorMaps:r,issueData:s}=t,a=[...n,...s.path||[]],i={...s,path:a};if(s.message!==void 0)return{...s,path:a,message:s.message};let o="";const u=r.filter(c=>!!c).slice().reverse();for(const c of u)o=c(i,{data:e,defaultError:o}).message;return{...s,path:a,message:o}},TC=[];function te(t,e){const n=Mu(),r=Bu({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,n,n===ia?void 0:ia].filter(s=>!!s)});t.common.issues.push(r)}class Mt{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,n){const r=[];for(const s of n){if(s.status==="aborted")return fe;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,n){const r=[];for(const s of n){const a=await s.key,i=await s.value;r.push({key:a,value:i})}return Mt.mergeObjectSync(e,r)}static mergeObjectSync(e,n){const r={};for(const s of n){const{key:a,value:i}=s;if(a.status==="aborted"||i.status==="aborted")return fe;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||s.alwaysSet)&&(r[a.value]=i.value)}return{status:e.value,value:r}}}const fe=Object.freeze({status:"aborted"}),Gs=t=>({status:"dirty",value:t}),$t=t=>({status:"valid",value:t}),Xd=t=>t.status==="aborted",Qd=t=>t.status==="dirty",_s=t=>t.status==="valid",Oi=t=>typeof Promise<"u"&&t instanceof Promise;function Fu(t,e,n,r){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(t)}function j_(t,e,n,r,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n}var ae;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(ae||(ae={}));var Xa,Qa;class hr{constructor(e,n,r,s){this._cachedPath=[],this.parent=e,this.data=n,this._path=r,this._key=s}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const kp=(t,e)=>{if(_s(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const n=new hn(t.common.issues);return this._error=n,this._error}}};function Te(t){if(!t)return{};const{errorMap:e,invalid_type_error:n,required_error:r,description:s}=t;if(e&&(n||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(i,o)=>{var u,c;const{message:l}=t;return i.code==="invalid_enum_value"?{message:l??o.defaultError}:typeof o.data>"u"?{message:(u=l??r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(c=l??n)!==null&&c!==void 0?c:o.defaultError}},description:s}}class ve{get description(){return this._def.description}_getType(e){return Tr(e.data)}_getOrReturnCtx(e,n){return n||{common:e.parent.common,data:e.data,parsedType:Tr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Mt,ctx:{common:e.parent.common,data:e.data,parsedType:Tr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const n=this._parse(e);if(Oi(n))throw new Error("Synchronous parse encountered promise.");return n}_parseAsync(e){const n=this._parse(e);return Promise.resolve(n)}parse(e,n){const r=this.safeParse(e,n);if(r.success)return r.data;throw r.error}safeParse(e,n){var r;const s={common:{issues:[],async:(r=n==null?void 0:n.async)!==null&&r!==void 0?r:!1,contextualErrorMap:n==null?void 0:n.errorMap},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tr(e)},a=this._parseSync({data:e,path:s.path,parent:s});return kp(s,a)}"~validate"(e){var n,r;const s={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tr(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:s});return _s(a)?{value:a.value}:{issues:s.common.issues}}catch(a){!((r=(n=a==null?void 0:a.message)===null||n===void 0?void 0:n.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),s.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:s}).then(a=>_s(a)?{value:a.value}:{issues:s.common.issues})}async parseAsync(e,n){const r=await this.safeParseAsync(e,n);if(r.success)return r.data;throw r.error}async safeParseAsync(e,n){const r={common:{issues:[],contextualErrorMap:n==null?void 0:n.errorMap,async:!0},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tr(e)},s=this._parse({data:e,path:r.path,parent:r}),a=await(Oi(s)?s:Promise.resolve(s));return kp(r,a)}refine(e,n){const r=s=>typeof n=="string"||typeof n>"u"?{message:n}:typeof n=="function"?n(s):n;return this._refinement((s,a)=>{const i=e(s),o=()=>a.addIssue({code:J.custom,...r(s)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,n){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof n=="function"?n(r,s):n),!1))}_refinement(e){return new qn({schema:this,typeName:$.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:n=>this["~validate"](n)}}optional(){return jn.create(this,this._def)}nullable(){return Kr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Un.create(this)}promise(){return ua.create(this,this._def)}or(e){return Ni.create([this,e],this._def)}and(e){return Ri.create(this,e,this._def)}transform(e){return new qn({...Te(this._def),schema:this,typeName:$.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const n=typeof e=="function"?e:()=>e;return new Mi({...Te(this._def),innerType:this,defaultValue:n,typeName:$.ZodDefault})}brand(){return new ff({typeName:$.ZodBranded,type:this,...Te(this._def)})}catch(e){const n=typeof e=="function"?e:()=>e;return new Bi({...Te(this._def),innerType:this,catchValue:n,typeName:$.ZodCatch})}describe(e){const n=this.constructor;return new n({...this._def,description:e})}pipe(e){return ao.create(this,e)}readonly(){return Fi.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const SC=/^c[^\s-]{8,}$/i,AC=/^[0-9a-z]+$/,CC=/^[0-9A-HJKMNP-TV-Z]{26}$/i,OC=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,vC=/^[a-z0-9_-]{21}$/i,IC=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,kC=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,NC=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,RC="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Bl;const PC=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,xC=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,LC=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,DC=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,MC=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,BC=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,H_="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",FC=new RegExp(`^${H_}$`);function $_(t){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`),e}function UC(t){return new RegExp(`^${$_(t)}$`)}function q_(t){let e=`${H_}T${$_(t)}`;const n=[];return n.push(t.local?"Z?":"Z"),t.offset&&n.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${n.join("|")})`,new RegExp(`^${e}$`)}function jC(t,e){return!!((e==="v4"||!e)&&PC.test(t)||(e==="v6"||!e)&&LC.test(t))}function HC(t,e){if(!IC.test(t))return!1;try{const[n]=t.split("."),r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||!s.typ||!s.alg||e&&s.alg!==e)}catch{return!1}}function $C(t,e){return!!((e==="v4"||!e)&&xC.test(t)||(e==="v6"||!e)&&DC.test(t))}class Bn extends ve{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==ne.string){const a=this._getOrReturnCtx(e);return te(a,{code:J.invalid_type,expected:ne.string,received:a.parsedType}),fe}const r=new Mt;let s;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:J.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:J.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(s=this._getOrReturnCtx(e,s),i?te(s,{code:J.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&te(s,{code:J.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),r.dirty())}else if(a.kind==="email")NC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"email",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="emoji")Bl||(Bl=new RegExp(RC,"u")),Bl.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"emoji",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="uuid")OC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"uuid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="nanoid")vC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"nanoid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid")SC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"cuid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid2")AC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"cuid2",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="ulid")CC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"ulid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),te(s,{validation:"url",code:J.invalid_string,message:a.message}),r.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"regex",code:J.invalid_string,message:a.message}),r.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),te(s,{code:J.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),r.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),te(s,{code:J.invalid_string,validation:{startsWith:a.value},message:a.message}),r.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),te(s,{code:J.invalid_string,validation:{endsWith:a.value},message:a.message}),r.dirty()):a.kind==="datetime"?q_(a).test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{code:J.invalid_string,validation:"datetime",message:a.message}),r.dirty()):a.kind==="date"?FC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{code:J.invalid_string,validation:"date",message:a.message}),r.dirty()):a.kind==="time"?UC(a).test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{code:J.invalid_string,validation:"time",message:a.message}),r.dirty()):a.kind==="duration"?kC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"duration",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="ip"?jC(e.data,a.version)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"ip",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="jwt"?HC(e.data,a.alg)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"jwt",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="cidr"?$C(e.data,a.version)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"cidr",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="base64"?MC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"base64",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="base64url"?BC.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"base64url",code:J.invalid_string,message:a.message}),r.dirty()):Me.assertNever(a);return{status:r.value,value:e.data}}_regex(e,n,r){return this.refinement(s=>e.test(s),{validation:n,code:J.invalid_string,...ae.errToObj(r)})}_addCheck(e){return new Bn({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...ae.errToObj(e)})}url(e){return this._addCheck({kind:"url",...ae.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...ae.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...ae.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...ae.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...ae.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...ae.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...ae.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...ae.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...ae.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...ae.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...ae.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...ae.errToObj(e)})}datetime(e){var n,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(n=e==null?void 0:e.offset)!==null&&n!==void 0?n:!1,local:(r=e==null?void 0:e.local)!==null&&r!==void 0?r:!1,...ae.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...ae.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...ae.errToObj(e)})}regex(e,n){return this._addCheck({kind:"regex",regex:e,...ae.errToObj(n)})}includes(e,n){return this._addCheck({kind:"includes",value:e,position:n==null?void 0:n.position,...ae.errToObj(n==null?void 0:n.message)})}startsWith(e,n){return this._addCheck({kind:"startsWith",value:e,...ae.errToObj(n)})}endsWith(e,n){return this._addCheck({kind:"endsWith",value:e,...ae.errToObj(n)})}min(e,n){return this._addCheck({kind:"min",value:e,...ae.errToObj(n)})}max(e,n){return this._addCheck({kind:"max",value:e,...ae.errToObj(n)})}length(e,n){return this._addCheck({kind:"length",value:e,...ae.errToObj(n)})}nonempty(e){return this.min(1,ae.errToObj(e))}trim(){return new Bn({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Bn({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Bn({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxLength(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}Bn.create=t=>{var e;return new Bn({checks:[],typeName:$.ZodString,coerce:(e=t==null?void 0:t.coerce)!==null&&e!==void 0?e:!1,...Te(t)})};function qC(t,e){const n=(t.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=n>r?n:r,a=parseInt(t.toFixed(s).replace(".","")),i=parseInt(e.toFixed(s).replace(".",""));return a%i/Math.pow(10,s)}class zr extends ve{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==ne.number){const a=this._getOrReturnCtx(e);return te(a,{code:J.invalid_type,expected:ne.number,received:a.parsedType}),fe}let r;const s=new Mt;for(const a of this._def.checks)a.kind==="int"?Me.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),te(r,{code:J.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:J.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:J.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?qC(e.data,a.value)!==0&&(r=this._getOrReturnCtx(e,r),te(r,{code:J.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),te(r,{code:J.not_finite,message:a.message}),s.dirty()):Me.assertNever(a);return{status:s.value,value:e.data}}gte(e,n){return this.setLimit("min",e,!0,ae.toString(n))}gt(e,n){return this.setLimit("min",e,!1,ae.toString(n))}lte(e,n){return this.setLimit("max",e,!0,ae.toString(n))}lt(e,n){return this.setLimit("max",e,!1,ae.toString(n))}setLimit(e,n,r,s){return new zr({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:ae.toString(s)}]})}_addCheck(e){return new zr({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:ae.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ae.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ae.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ae.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ae.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:ae.toString(n)})}finite(e){return this._addCheck({kind:"finite",message:ae.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ae.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ae.toString(e)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&Me.isInteger(e.value))}get isFinite(){let e=null,n=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(n===null||r.value>n)&&(n=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(n)&&Number.isFinite(e)}}zr.create=t=>new zr({checks:[],typeName:$.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...Te(t)});class Wr extends ve{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==ne.bigint)return this._getInvalidInput(e);let r;const s=new Mt;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:J.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:J.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),te(r,{code:J.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):Me.assertNever(a);return{status:s.value,value:e.data}}_getInvalidInput(e){const n=this._getOrReturnCtx(e);return te(n,{code:J.invalid_type,expected:ne.bigint,received:n.parsedType}),fe}gte(e,n){return this.setLimit("min",e,!0,ae.toString(n))}gt(e,n){return this.setLimit("min",e,!1,ae.toString(n))}lte(e,n){return this.setLimit("max",e,!0,ae.toString(n))}lt(e,n){return this.setLimit("max",e,!1,ae.toString(n))}setLimit(e,n,r,s){return new Wr({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:ae.toString(s)}]})}_addCheck(e){return new Wr({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ae.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ae.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ae.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ae.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:ae.toString(n)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}Wr.create=t=>{var e;return new Wr({checks:[],typeName:$.ZodBigInt,coerce:(e=t==null?void 0:t.coerce)!==null&&e!==void 0?e:!1,...Te(t)})};class vi extends ve{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==ne.boolean){const r=this._getOrReturnCtx(e);return te(r,{code:J.invalid_type,expected:ne.boolean,received:r.parsedType}),fe}return $t(e.data)}}vi.create=t=>new vi({typeName:$.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...Te(t)});class ys extends ve{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==ne.date){const a=this._getOrReturnCtx(e);return te(a,{code:J.invalid_type,expected:ne.date,received:a.parsedType}),fe}if(isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return te(a,{code:J.invalid_date}),fe}const r=new Mt;let s;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:J.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:J.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):Me.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ys({...this._def,checks:[...this._def.checks,e]})}min(e,n){return this._addCheck({kind:"min",value:e.getTime(),message:ae.toString(n)})}max(e,n){return this._addCheck({kind:"max",value:e.getTime(),message:ae.toString(n)})}get minDate(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e!=null?new Date(e):null}}ys.create=t=>new ys({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:$.ZodDate,...Te(t)});class Uu extends ve{_parse(e){if(this._getType(e)!==ne.symbol){const r=this._getOrReturnCtx(e);return te(r,{code:J.invalid_type,expected:ne.symbol,received:r.parsedType}),fe}return $t(e.data)}}Uu.create=t=>new Uu({typeName:$.ZodSymbol,...Te(t)});class Ii extends ve{_parse(e){if(this._getType(e)!==ne.undefined){const r=this._getOrReturnCtx(e);return te(r,{code:J.invalid_type,expected:ne.undefined,received:r.parsedType}),fe}return $t(e.data)}}Ii.create=t=>new Ii({typeName:$.ZodUndefined,...Te(t)});class ki extends ve{_parse(e){if(this._getType(e)!==ne.null){const r=this._getOrReturnCtx(e);return te(r,{code:J.invalid_type,expected:ne.null,received:r.parsedType}),fe}return $t(e.data)}}ki.create=t=>new ki({typeName:$.ZodNull,...Te(t)});class oa extends ve{constructor(){super(...arguments),this._any=!0}_parse(e){return $t(e.data)}}oa.create=t=>new oa({typeName:$.ZodAny,...Te(t)});class ds extends ve{constructor(){super(...arguments),this._unknown=!0}_parse(e){return $t(e.data)}}ds.create=t=>new ds({typeName:$.ZodUnknown,...Te(t)});class kr extends ve{_parse(e){const n=this._getOrReturnCtx(e);return te(n,{code:J.invalid_type,expected:ne.never,received:n.parsedType}),fe}}kr.create=t=>new kr({typeName:$.ZodNever,...Te(t)});class ju extends ve{_parse(e){if(this._getType(e)!==ne.undefined){const r=this._getOrReturnCtx(e);return te(r,{code:J.invalid_type,expected:ne.void,received:r.parsedType}),fe}return $t(e.data)}}ju.create=t=>new ju({typeName:$.ZodVoid,...Te(t)});class Un extends ve{_parse(e){const{ctx:n,status:r}=this._processInputParams(e),s=this._def;if(n.parsedType!==ne.array)return te(n,{code:J.invalid_type,expected:ne.array,received:n.parsedType}),fe;if(s.exactLength!==null){const i=n.data.length>s.exactLength.value,o=n.data.length<s.exactLength.value;(i||o)&&(te(n,{code:i?J.too_big:J.too_small,minimum:o?s.exactLength.value:void 0,maximum:i?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&n.data.length<s.minLength.value&&(te(n,{code:J.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&n.data.length>s.maxLength.value&&(te(n,{code:J.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),n.common.async)return Promise.all([...n.data].map((i,o)=>s.type._parseAsync(new hr(n,i,n.path,o)))).then(i=>Mt.mergeArray(r,i));const a=[...n.data].map((i,o)=>s.type._parseSync(new hr(n,i,n.path,o)));return Mt.mergeArray(r,a)}get element(){return this._def.type}min(e,n){return new Un({...this._def,minLength:{value:e,message:ae.toString(n)}})}max(e,n){return new Un({...this._def,maxLength:{value:e,message:ae.toString(n)}})}length(e,n){return new Un({...this._def,exactLength:{value:e,message:ae.toString(n)}})}nonempty(e){return this.min(1,e)}}Un.create=(t,e)=>new Un({type:t,minLength:null,maxLength:null,exactLength:null,typeName:$.ZodArray,...Te(e)});function Vs(t){if(t instanceof rt){const e={};for(const n in t.shape){const r=t.shape[n];e[n]=jn.create(Vs(r))}return new rt({...t._def,shape:()=>e})}else return t instanceof Un?new Un({...t._def,type:Vs(t.element)}):t instanceof jn?jn.create(Vs(t.unwrap())):t instanceof Kr?Kr.create(Vs(t.unwrap())):t instanceof fr?fr.create(t.items.map(e=>Vs(e))):t}class rt extends ve{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),n=Me.objectKeys(e);return this._cached={shape:e,keys:n}}_parse(e){if(this._getType(e)!==ne.object){const c=this._getOrReturnCtx(e);return te(c,{code:J.invalid_type,expected:ne.object,received:c.parsedType}),fe}const{status:r,ctx:s}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof kr&&this._def.unknownKeys==="strip"))for(const c in s.data)i.includes(c)||o.push(c);const u=[];for(const c of i){const l=a[c],d=s.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new hr(s,d,s.path,c)),alwaysSet:c in s.data})}if(this._def.catchall instanceof kr){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(c==="strict")o.length>0&&(te(s,{code:J.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const d=s.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new hr(s,d,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const d=await l.key,m=await l.value;c.push({key:d,value:m,alwaysSet:l.alwaysSet})}return c}).then(c=>Mt.mergeObjectSync(r,c)):Mt.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return ae.errToObj,new rt({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(n,r)=>{var s,a,i,o;const u=(i=(a=(s=this._def).errorMap)===null||a===void 0?void 0:a.call(s,n,r).message)!==null&&i!==void 0?i:r.defaultError;return n.code==="unrecognized_keys"?{message:(o=ae.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new rt({...this._def,unknownKeys:"strip"})}passthrough(){return new rt({...this._def,unknownKeys:"passthrough"})}extend(e){return new rt({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new rt({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:$.ZodObject})}setKey(e,n){return this.augment({[e]:n})}catchall(e){return new rt({...this._def,catchall:e})}pick(e){const n={};return Me.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(n[r]=this.shape[r])}),new rt({...this._def,shape:()=>n})}omit(e){const n={};return Me.objectKeys(this.shape).forEach(r=>{e[r]||(n[r]=this.shape[r])}),new rt({...this._def,shape:()=>n})}deepPartial(){return Vs(this)}partial(e){const n={};return Me.objectKeys(this.shape).forEach(r=>{const s=this.shape[r];e&&!e[r]?n[r]=s:n[r]=s.optional()}),new rt({...this._def,shape:()=>n})}required(e){const n={};return Me.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])n[r]=this.shape[r];else{let a=this.shape[r];for(;a instanceof jn;)a=a._def.innerType;n[r]=a}}),new rt({...this._def,shape:()=>n})}keyof(){return V_(Me.objectKeys(this.shape))}}rt.create=(t,e)=>new rt({shape:()=>t,unknownKeys:"strip",catchall:kr.create(),typeName:$.ZodObject,...Te(e)});rt.strictCreate=(t,e)=>new rt({shape:()=>t,unknownKeys:"strict",catchall:kr.create(),typeName:$.ZodObject,...Te(e)});rt.lazycreate=(t,e)=>new rt({shape:t,unknownKeys:"strip",catchall:kr.create(),typeName:$.ZodObject,...Te(e)});class Ni extends ve{_parse(e){const{ctx:n}=this._processInputParams(e),r=this._def.options;function s(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return n.common.issues.push(...o.ctx.common.issues),o.result;const i=a.map(o=>new hn(o.ctx.common.issues));return te(n,{code:J.invalid_union,unionErrors:i}),fe}if(n.common.async)return Promise.all(r.map(async a=>{const i={...n,common:{...n.common,issues:[]},parent:null};return{result:await a._parseAsync({data:n.data,path:n.path,parent:i}),ctx:i}})).then(s);{let a;const i=[];for(const u of r){const c={...n,common:{...n.common,issues:[]},parent:null},l=u._parseSync({data:n.data,path:n.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!a&&(a={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(a)return n.common.issues.push(...a.ctx.common.issues),a.result;const o=i.map(u=>new hn(u));return te(n,{code:J.invalid_union,unionErrors:o}),fe}}get options(){return this._def.options}}Ni.create=(t,e)=>new Ni({options:t,typeName:$.ZodUnion,...Te(e)});const _r=t=>t instanceof xi?_r(t.schema):t instanceof qn?_r(t.innerType()):t instanceof Li?[t.value]:t instanceof Gr?t.options:t instanceof Di?Me.objectValues(t.enum):t instanceof Mi?_r(t._def.innerType):t instanceof Ii?[void 0]:t instanceof ki?[null]:t instanceof jn?[void 0,..._r(t.unwrap())]:t instanceof Kr?[null,..._r(t.unwrap())]:t instanceof ff||t instanceof Fi?_r(t.unwrap()):t instanceof Bi?_r(t._def.innerType):[];class Mc extends ve{_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==ne.object)return te(n,{code:J.invalid_type,expected:ne.object,received:n.parsedType}),fe;const r=this.discriminator,s=n.data[r],a=this.optionsMap.get(s);return a?n.common.async?a._parseAsync({data:n.data,path:n.path,parent:n}):a._parseSync({data:n.data,path:n.path,parent:n}):(te(n,{code:J.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),fe)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,n,r){const s=new Map;for(const a of n){const i=_r(a.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,a)}}return new Mc({typeName:$.ZodDiscriminatedUnion,discriminator:e,options:n,optionsMap:s,...Te(r)})}}function eh(t,e){const n=Tr(t),r=Tr(e);if(t===e)return{valid:!0,data:t};if(n===ne.object&&r===ne.object){const s=Me.objectKeys(e),a=Me.objectKeys(t).filter(o=>s.indexOf(o)!==-1),i={...t,...e};for(const o of a){const u=eh(t[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(n===ne.array&&r===ne.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let a=0;a<t.length;a++){const i=t[a],o=e[a],u=eh(i,o);if(!u.valid)return{valid:!1};s.push(u.data)}return{valid:!0,data:s}}else return n===ne.date&&r===ne.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}class Ri extends ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=(a,i)=>{if(Xd(a)||Xd(i))return fe;const o=eh(a.value,i.value);return o.valid?((Qd(a)||Qd(i))&&n.dirty(),{status:n.value,value:o.data}):(te(r,{code:J.invalid_intersection_types}),fe)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([a,i])=>s(a,i)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}Ri.create=(t,e,n)=>new Ri({left:t,right:e,typeName:$.ZodIntersection,...Te(n)});class fr extends ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ne.array)return te(r,{code:J.invalid_type,expected:ne.array,received:r.parsedType}),fe;if(r.data.length<this._def.items.length)return te(r,{code:J.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),fe;!this._def.rest&&r.data.length>this._def.items.length&&(te(r,{code:J.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),n.dirty());const a=[...r.data].map((i,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new hr(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(a).then(i=>Mt.mergeArray(n,i)):Mt.mergeArray(n,a)}get items(){return this._def.items}rest(e){return new fr({...this._def,rest:e})}}fr.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new fr({items:t,typeName:$.ZodTuple,rest:null,...Te(e)})};class Pi extends ve{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ne.object)return te(r,{code:J.invalid_type,expected:ne.object,received:r.parsedType}),fe;const s=[],a=this._def.keyType,i=this._def.valueType;for(const o in r.data)s.push({key:a._parse(new hr(r,o,r.path,o)),value:i._parse(new hr(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Mt.mergeObjectAsync(n,s):Mt.mergeObjectSync(n,s)}get element(){return this._def.valueType}static create(e,n,r){return n instanceof ve?new Pi({keyType:e,valueType:n,typeName:$.ZodRecord,...Te(r)}):new Pi({keyType:Bn.create(),valueType:e,typeName:$.ZodRecord,...Te(n)})}}class Hu extends ve{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ne.map)return te(r,{code:J.invalid_type,expected:ne.map,received:r.parsedType}),fe;const s=this._def.keyType,a=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:s._parse(new hr(r,o,r.path,[c,"key"])),value:a._parse(new hr(r,u,r.path,[c,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of i){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return fe;(c.status==="dirty"||l.status==="dirty")&&n.dirty(),o.set(c.value,l.value)}return{status:n.value,value:o}})}else{const o=new Map;for(const u of i){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return fe;(c.status==="dirty"||l.status==="dirty")&&n.dirty(),o.set(c.value,l.value)}return{status:n.value,value:o}}}}Hu.create=(t,e,n)=>new Hu({valueType:e,keyType:t,typeName:$.ZodMap,...Te(n)});class Es extends ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ne.set)return te(r,{code:J.invalid_type,expected:ne.set,received:r.parsedType}),fe;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(te(r,{code:J.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),n.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(te(r,{code:J.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),n.dirty());const a=this._def.valueType;function i(u){const c=new Set;for(const l of u){if(l.status==="aborted")return fe;l.status==="dirty"&&n.dirty(),c.add(l.value)}return{status:n.value,value:c}}const o=[...r.data.values()].map((u,c)=>a._parse(new hr(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,n){return new Es({...this._def,minSize:{value:e,message:ae.toString(n)}})}max(e,n){return new Es({...this._def,maxSize:{value:e,message:ae.toString(n)}})}size(e,n){return this.min(e,n).max(e,n)}nonempty(e){return this.min(1,e)}}Es.create=(t,e)=>new Es({valueType:t,minSize:null,maxSize:null,typeName:$.ZodSet,...Te(e)});class ta extends ve{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==ne.function)return te(n,{code:J.invalid_type,expected:ne.function,received:n.parsedType}),fe;function r(o,u){return Bu({data:o,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,Mu(),ia].filter(c=>!!c),issueData:{code:J.invalid_arguments,argumentsError:u}})}function s(o,u){return Bu({data:o,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,Mu(),ia].filter(c=>!!c),issueData:{code:J.invalid_return_type,returnTypeError:u}})}const a={errorMap:n.common.contextualErrorMap},i=n.data;if(this._def.returns instanceof ua){const o=this;return $t(async function(...u){const c=new hn([]),l=await o._def.args.parseAsync(u,a).catch(p=>{throw c.addIssue(r(u,p)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,a).catch(p=>{throw c.addIssue(s(d,p)),c})})}else{const o=this;return $t(function(...u){const c=o._def.args.safeParse(u,a);if(!c.success)throw new hn([r(u,c.error)]);const l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,a);if(!d.success)throw new hn([s(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new ta({...this._def,args:fr.create(e).rest(ds.create())})}returns(e){return new ta({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,n,r){return new ta({args:e||fr.create([]).rest(ds.create()),returns:n||ds.create(),typeName:$.ZodFunction,...Te(r)})}}class xi extends ve{get schema(){return this._def.getter()}_parse(e){const{ctx:n}=this._processInputParams(e);return this._def.getter()._parse({data:n.data,path:n.path,parent:n})}}xi.create=(t,e)=>new xi({getter:t,typeName:$.ZodLazy,...Te(e)});class Li extends ve{_parse(e){if(e.data!==this._def.value){const n=this._getOrReturnCtx(e);return te(n,{received:n.data,code:J.invalid_literal,expected:this._def.value}),fe}return{status:"valid",value:e.data}}get value(){return this._def.value}}Li.create=(t,e)=>new Li({value:t,typeName:$.ZodLiteral,...Te(e)});function V_(t,e){return new Gr({values:t,typeName:$.ZodEnum,...Te(e)})}class Gr extends ve{constructor(){super(...arguments),Xa.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const n=this._getOrReturnCtx(e),r=this._def.values;return te(n,{expected:Me.joinValues(r),received:n.parsedType,code:J.invalid_type}),fe}if(Fu(this,Xa)||j_(this,Xa,new Set(this._def.values)),!Fu(this,Xa).has(e.data)){const n=this._getOrReturnCtx(e),r=this._def.values;return te(n,{received:n.data,code:J.invalid_enum_value,options:r}),fe}return $t(e.data)}get options(){return this._def.values}get enum(){const e={};for(const n of this._def.values)e[n]=n;return e}get Values(){const e={};for(const n of this._def.values)e[n]=n;return e}get Enum(){const e={};for(const n of this._def.values)e[n]=n;return e}extract(e,n=this._def){return Gr.create(e,{...this._def,...n})}exclude(e,n=this._def){return Gr.create(this.options.filter(r=>!e.includes(r)),{...this._def,...n})}}Xa=new WeakMap;Gr.create=V_;class Di extends ve{constructor(){super(...arguments),Qa.set(this,void 0)}_parse(e){const n=Me.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==ne.string&&r.parsedType!==ne.number){const s=Me.objectValues(n);return te(r,{expected:Me.joinValues(s),received:r.parsedType,code:J.invalid_type}),fe}if(Fu(this,Qa)||j_(this,Qa,new Set(Me.getValidEnumValues(this._def.values))),!Fu(this,Qa).has(e.data)){const s=Me.objectValues(n);return te(r,{received:r.data,code:J.invalid_enum_value,options:s}),fe}return $t(e.data)}get enum(){return this._def.values}}Qa=new WeakMap;Di.create=(t,e)=>new Di({values:t,typeName:$.ZodNativeEnum,...Te(e)});class ua extends ve{unwrap(){return this._def.type}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==ne.promise&&n.common.async===!1)return te(n,{code:J.invalid_type,expected:ne.promise,received:n.parsedType}),fe;const r=n.parsedType===ne.promise?n.data:Promise.resolve(n.data);return $t(r.then(s=>this._def.type.parseAsync(s,{path:n.path,errorMap:n.common.contextualErrorMap})))}}ua.create=(t,e)=>new ua({type:t,typeName:$.ZodPromise,...Te(e)});class qn extends ve{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===$.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:i=>{te(r,i),i.fatal?n.abort():n.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){const i=s.transform(r.data,a);if(r.common.async)return Promise.resolve(i).then(async o=>{if(n.value==="aborted")return fe;const u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?fe:u.status==="dirty"||n.value==="dirty"?Gs(u.value):u});{if(n.value==="aborted")return fe;const o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?fe:o.status==="dirty"||n.value==="dirty"?Gs(o.value):o}}if(s.type==="refinement"){const i=o=>{const u=s.refinement(o,a);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?fe:(o.status==="dirty"&&n.dirty(),i(o.value),{status:n.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?fe:(o.status==="dirty"&&n.dirty(),i(o.value).then(()=>({status:n.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!_s(i))return i;const o=s.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:n.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>_s(i)?Promise.resolve(s.transform(i.value,a)).then(o=>({status:n.value,value:o})):i);Me.assertNever(s)}}qn.create=(t,e,n)=>new qn({schema:t,typeName:$.ZodEffects,effect:e,...Te(n)});qn.createWithPreprocess=(t,e,n)=>new qn({schema:e,effect:{type:"preprocess",transform:t},typeName:$.ZodEffects,...Te(n)});class jn extends ve{_parse(e){return this._getType(e)===ne.undefined?$t(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}jn.create=(t,e)=>new jn({innerType:t,typeName:$.ZodOptional,...Te(e)});class Kr extends ve{_parse(e){return this._getType(e)===ne.null?$t(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Kr.create=(t,e)=>new Kr({innerType:t,typeName:$.ZodNullable,...Te(e)});class Mi extends ve{_parse(e){const{ctx:n}=this._processInputParams(e);let r=n.data;return n.parsedType===ne.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:n.path,parent:n})}removeDefault(){return this._def.innerType}}Mi.create=(t,e)=>new Mi({innerType:t,typeName:$.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...Te(e)});class Bi extends ve{_parse(e){const{ctx:n}=this._processInputParams(e),r={...n,common:{...n.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Oi(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new hn(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new hn(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Bi.create=(t,e)=>new Bi({innerType:t,typeName:$.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...Te(e)});class $u extends ve{_parse(e){if(this._getType(e)!==ne.nan){const r=this._getOrReturnCtx(e);return te(r,{code:J.invalid_type,expected:ne.nan,received:r.parsedType}),fe}return{status:"valid",value:e.data}}}$u.create=t=>new $u({typeName:$.ZodNaN,...Te(t)});const VC=Symbol("zod_brand");class ff extends ve{_parse(e){const{ctx:n}=this._processInputParams(e),r=n.data;return this._def.type._parse({data:r,path:n.path,parent:n})}unwrap(){return this._def.type}}class ao extends ve{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?fe:a.status==="dirty"?(n.dirty(),Gs(a.value)):this._def.out._parseAsync({data:a.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?fe:s.status==="dirty"?(n.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,n){return new ao({in:e,out:n,typeName:$.ZodPipeline})}}class Fi extends ve{_parse(e){const n=this._def.innerType._parse(e),r=s=>(_s(s)&&(s.value=Object.freeze(s.value)),s);return Oi(n)?n.then(s=>r(s)):r(n)}unwrap(){return this._def.innerType}}Fi.create=(t,e)=>new Fi({innerType:t,typeName:$.ZodReadonly,...Te(e)});function z_(t,e={},n){return t?oa.create().superRefine((r,s)=>{var a,i;if(!t(r)){const o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(a=o.fatal)!==null&&a!==void 0?a:n)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;s.addIssue({code:"custom",...c,fatal:u})}}):oa.create()}const zC={object:rt.lazycreate};var $;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})($||($={}));const WC=(t,e={message:`Input not instance of ${t.name}`})=>z_(n=>n instanceof t,e),W_=Bn.create,G_=zr.create,GC=$u.create,KC=Wr.create,K_=vi.create,YC=ys.create,ZC=Uu.create,JC=Ii.create,XC=ki.create,QC=oa.create,eO=ds.create,tO=kr.create,nO=ju.create,rO=Un.create,sO=rt.create,aO=rt.strictCreate,iO=Ni.create,oO=Mc.create,uO=Ri.create,cO=fr.create,lO=Pi.create,dO=Hu.create,hO=Es.create,fO=ta.create,mO=xi.create,pO=Li.create,gO=Gr.create,bO=Di.create,_O=ua.create,Np=qn.create,yO=jn.create,EO=Kr.create,wO=qn.createWithPreprocess,TO=ao.create,SO=()=>W_().optional(),AO=()=>G_().optional(),CO=()=>K_().optional(),OO={string:t=>Bn.create({...t,coerce:!0}),number:t=>zr.create({...t,coerce:!0}),boolean:t=>vi.create({...t,coerce:!0}),bigint:t=>Wr.create({...t,coerce:!0}),date:t=>ys.create({...t,coerce:!0})},vO=fe;var Or=Object.freeze({__proto__:null,defaultErrorMap:ia,setErrorMap:wC,getErrorMap:Mu,makeIssue:Bu,EMPTY_PATH:TC,addIssueToContext:te,ParseStatus:Mt,INVALID:fe,DIRTY:Gs,OK:$t,isAborted:Xd,isDirty:Qd,isValid:_s,isAsync:Oi,get util(){return Me},get objectUtil(){return Jd},ZodParsedType:ne,getParsedType:Tr,ZodType:ve,datetimeRegex:q_,ZodString:Bn,ZodNumber:zr,ZodBigInt:Wr,ZodBoolean:vi,ZodDate:ys,ZodSymbol:Uu,ZodUndefined:Ii,ZodNull:ki,ZodAny:oa,ZodUnknown:ds,ZodNever:kr,ZodVoid:ju,ZodArray:Un,ZodObject:rt,ZodUnion:Ni,ZodDiscriminatedUnion:Mc,ZodIntersection:Ri,ZodTuple:fr,ZodRecord:Pi,ZodMap:Hu,ZodSet:Es,ZodFunction:ta,ZodLazy:xi,ZodLiteral:Li,ZodEnum:Gr,ZodNativeEnum:Di,ZodPromise:ua,ZodEffects:qn,ZodTransformer:qn,ZodOptional:jn,ZodNullable:Kr,ZodDefault:Mi,ZodCatch:Bi,ZodNaN:$u,BRAND:VC,ZodBranded:ff,ZodPipeline:ao,ZodReadonly:Fi,custom:z_,Schema:ve,ZodSchema:ve,late:zC,get ZodFirstPartyTypeKind(){return $},coerce:OO,any:QC,array:rO,bigint:KC,boolean:K_,date:YC,discriminatedUnion:oO,effect:Np,enum:gO,function:fO,instanceof:WC,intersection:uO,lazy:mO,literal:pO,map:dO,nan:GC,nativeEnum:bO,never:tO,null:XC,nullable:EO,number:G_,object:sO,oboolean:CO,onumber:AO,optional:yO,ostring:SO,pipeline:TO,preprocess:wO,promise:_O,record:lO,set:hO,strictObject:aO,string:W_,symbol:ZC,transformer:Np,tuple:cO,undefined:JC,union:iO,unknown:eO,void:nO,NEVER:vO,ZodIssueCode:J,quotelessJson:EC,ZodError:hn}),Bc={exports:{}},Y_={};function vn(t,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var IO=vn;vn.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};vn.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};vn.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=new Date().getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},n),this._options.unref&&this._timer.unref(),!0};vn.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};vn.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)};vn.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)};vn.prototype.start=vn.prototype.try;vn.prototype.errors=function(){return this._errors};vn.prototype.attempts=function(){return this._attempts};vn.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},e=null,n=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,i=(t[a]||0)+1;t[a]=i,i>=n&&(e=s,n=i)}return e};(function(t){var e=IO;t.operation=function(n){var r=t.timeouts(n);return new e(r,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})},t.timeouts=function(n){if(n instanceof Array)return[].concat(n);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in n)r[s]=n[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],i=0;i<r.retries;i++)a.push(this.createTimeout(i,r));return n&&n.forever&&!a.length&&a.push(this.createTimeout(i,r)),a.sort(function(o,u){return o-u}),a},t.createTimeout=function(n,r){var s=r.randomize?Math.random()+1:1,a=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,n));return a=Math.min(a,r.maxTimeout),a},t.wrap=function(n,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var a in n)typeof n[a]=="function"&&s.push(a)}for(var i=0;i<s.length;i++){var o=s[i],u=n[o];n[o]=(function(l){var d=t.operation(r),m=Array.prototype.slice.call(arguments,1),p=m.pop();m.push(function(f){d.retry(f)||(f&&(arguments[0]=d.mainError()),p.apply(this,arguments))}),d.attempt(function(){l.apply(n,m)})}).bind(n,u),n[o].options=r}}})(Y_);var kO=Y_;const NO=kO,RO=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class Z_ extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const PO=(t,e,n)=>{const r=n.retries-(e-1);return t.attemptNumber=e,t.retriesLeft=r,t},xO=t=>RO.includes(t),J_=(t,e)=>new Promise((n,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const s=NO.operation(e);s.attempt(async a=>{try{n(await t(a))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof Z_)s.stop(),r(i.originalError);else if(i instanceof TypeError&&!xO(i.message))s.stop(),r(i);else{PO(i,a,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}s.retry(i)||r(s.mainError())}}})});Bc.exports=J_;Bc.exports.default=J_;Bc.exports.AbortError=Z_;var LO=Bc.exports;const qu=to(LO),DO=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function li(t){return typeof t=="string"&&DO.test(t)}var It=[];for(var Fl=0;Fl<256;++Fl)It.push((Fl+256).toString(16).slice(1));function MO(t,e=0){return(It[t[e+0]]+It[t[e+1]]+It[t[e+2]]+It[t[e+3]]+"-"+It[t[e+4]]+It[t[e+5]]+"-"+It[t[e+6]]+It[t[e+7]]+"-"+It[t[e+8]]+It[t[e+9]]+"-"+It[t[e+10]]+It[t[e+11]]+It[t[e+12]]+It[t[e+13]]+It[t[e+14]]+It[t[e+15]]).toLowerCase()}var $o,BO=new Uint8Array(16);function FO(){if(!$o&&($o=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!$o))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $o(BO)}var UO=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Rp={randomUUID:UO};function Jt(t,e,n){if(Rp.randomUUID&&!t)return Rp.randomUUID();t=t||{};var r=t.random||(t.rng||FO)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,MO(r)}var X_={},Q_={exports:{}};(function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function s(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function a(u,c,l,d,m){if(typeof l!="function")throw new TypeError("The listener must be a function");var p=new s(l,d||u,m),f=n?n+c:c;return u._events[f]?u._events[f].fn?u._events[f]=[u._events[f],p]:u._events[f].push(p):(u._events[f]=p,u._eventsCount++),u}function i(u,c){--u._eventsCount===0?u._events=new r:delete u._events[c]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,d;if(this._eventsCount===0)return c;for(d in l=this._events)e.call(l,d)&&c.push(n?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=n?n+c:c,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var m=0,p=d.length,f=new Array(p);m<p;m++)f[m]=d[m].fn;return f},o.prototype.listenerCount=function(c){var l=n?n+c:c,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,l,d,m,p,f){var g=n?n+c:c;if(!this._events[g])return!1;var b=this._events[g],_=arguments.length,y,S;if(b.fn){switch(b.once&&this.removeListener(c,b.fn,void 0,!0),_){case 1:return b.fn.call(b.context),!0;case 2:return b.fn.call(b.context,l),!0;case 3:return b.fn.call(b.context,l,d),!0;case 4:return b.fn.call(b.context,l,d,m),!0;case 5:return b.fn.call(b.context,l,d,m,p),!0;case 6:return b.fn.call(b.context,l,d,m,p,f),!0}for(S=1,y=new Array(_-1);S<_;S++)y[S-1]=arguments[S];b.fn.apply(b.context,y)}else{var I=b.length,A;for(S=0;S<I;S++)switch(b[S].once&&this.removeListener(c,b[S].fn,void 0,!0),_){case 1:b[S].fn.call(b[S].context);break;case 2:b[S].fn.call(b[S].context,l);break;case 3:b[S].fn.call(b[S].context,l,d);break;case 4:b[S].fn.call(b[S].context,l,d,m);break;default:if(!y)for(A=1,y=new Array(_-1);A<_;A++)y[A-1]=arguments[A];b[S].fn.apply(b[S].context,y)}}return!0},o.prototype.on=function(c,l,d){return a(this,c,l,d,!1)},o.prototype.once=function(c,l,d){return a(this,c,l,d,!0)},o.prototype.removeListener=function(c,l,d,m){var p=n?n+c:c;if(!this._events[p])return this;if(!l)return i(this,p),this;var f=this._events[p];if(f.fn)f.fn===l&&(!m||f.once)&&(!d||f.context===d)&&i(this,p);else{for(var g=0,b=[],_=f.length;g<_;g++)(f[g].fn!==l||m&&!f[g].once||d&&f[g].context!==d)&&b.push(f[g]);b.length?this._events[p]=b.length===1?b[0]:b:i(this,p)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=n?n+c:c,this._events[l]&&i(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,t.exports=o})(Q_);var jO=Q_.exports,Fc={exports:{}},HO=(t,e)=>(e=e||(()=>{}),t.then(n=>new Promise(r=>{r(e())}).then(()=>n),n=>new Promise(r=>{r(e())}).then(()=>{throw n})));const $O=HO;class ey extends Error{constructor(e){super(e),this.name="TimeoutError"}}const ty=(t,e,n)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(t);return}const a=setTimeout(()=>{if(typeof n=="function"){try{r(n())}catch(u){s(u)}return}const i=typeof n=="string"?n:`Promise timed out after ${e} milliseconds`,o=n instanceof Error?n:new ey(i);typeof t.cancel=="function"&&t.cancel(),s(o)},e);$O(t.then(r,s),()=>{clearTimeout(a)})});Fc.exports=ty;Fc.exports.default=ty;Fc.exports.TimeoutError=ey;var qO=Fc.exports,mf={},pf={};Object.defineProperty(pf,"__esModule",{value:!0});function VO(t,e,n){let r=0,s=t.length;for(;s>0;){const a=s/2|0;let i=r+a;n(t[i],e)<=0?(r=++i,s-=a+1):s=a}return r}pf.default=VO;Object.defineProperty(mf,"__esModule",{value:!0});const zO=pf;class WO{constructor(){this._queue=[]}enqueue(e,n){n=Object.assign({priority:0},n);const r={priority:n.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=n.priority){this._queue.push(r);return}const s=zO.default(this._queue,r,(a,i)=>i.priority-a.priority);this._queue.splice(s,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(n=>n.priority===e.priority).map(n=>n.run)}get size(){return this._queue.length}}mf.default=WO;Object.defineProperty(X_,"__esModule",{value:!0});const GO=jO,ny=qO,KO=mf,qo=()=>{},YO=new ny.TimeoutError;class ZO extends GO{constructor(e){var n,r,s,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=qo,this._resolveIdle=qo,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:KO.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(n=e.intervalCap)===null||n===void 0?void 0:n.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=qo,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=qo,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const n=this._intervalEnd-e;if(n<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},n)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const n=this._queue.dequeue();return n?(this.emit("active"),n(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,n={}){return new Promise((r,s)=>{const a=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&n.timeout===void 0?e():ny.default(Promise.resolve(e()),n.timeout===void 0?this._timeout:n.timeout,()=>{(n.throwOnTimeout===void 0?this._throwOnTimeout:n.throwOnTimeout)&&s(YO)});r(await i)}catch(i){s(i)}this._next()};this._queue.enqueue(a,n),this._tryToStartAnother(),this.emit("add")})}async addAll(e,n){return Promise.all(e.map(async r=>this.add(r,n)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const n=this._resolveEmpty;this._resolveEmpty=()=>{n(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const n=this._resolveIdle;this._resolveIdle=()=>{n(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var vr=X_.default=ZO;const JO=(...t)=>fetch(...t),XO=Symbol.for("ls:fetch_implementation"),ie=()=>globalThis[XO]??JO,QO=[400,401,403,404,405,406,407,408],ev=[409];let Pp=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in vr?this.queue=new vr.default({concurrency:this.maxConcurrency}):this.queue=new vr({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...n){const r=this.onFailedResponseHook;return this.queue.add(()=>qu(()=>e(...n).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const a=s==null?void 0:s.response,i=a==null?void 0:a.status;if(i){if(QO.includes(+i))throw s;if(ev.includes(+i))return;r&&await r(a)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,n,...r){return e.signal?Promise.race([this.call(n,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(n,...r)}fetch(...e){return this.call(()=>ie()(...e).then(n=>n.ok?n:Promise.reject(n)))}};function xp(t){return typeof(t==null?void 0:t._getType)=="function"}function Lp(t){const e={type:t._getType(),data:{content:t.content}};return t!=null&&t.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}function Se(t,e){if(!li(t)){const n=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(n)}return t}const Dp={};function ry(t){Dp[t]||(console.warn(t),Dp[t]=!0)}var th={exports:{}};const tv="2.0.0",sy=256,nv=Number.MAX_SAFE_INTEGER||9007199254740991,rv=16,sv=sy-6,av=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var Uc={MAX_LENGTH:sy,MAX_SAFE_COMPONENT_LENGTH:rv,MAX_SAFE_BUILD_LENGTH:sv,MAX_SAFE_INTEGER:nv,RELEASE_TYPES:av,SEMVER_SPEC_VERSION:tv,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2};const iv=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{};var jc=iv;(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=Uc,a=jc;e=t.exports={};const i=e.re=[],o=e.safeRe=[],u=e.src=[],c=e.t={};let l=0;const d="[a-zA-Z0-9-]",m=[["\\s",1],["\\d",s],[d,r]],p=g=>{for(const[b,_]of m)g=g.split(`${b}*`).join(`${b}{0,${_}}`).split(`${b}+`).join(`${b}{1,${_}}`);return g},f=(g,b,_)=>{const y=p(b),S=l++;a(g,S,b),c[g]=S,u[S]=b,i[S]=new RegExp(b,_?"g":void 0),o[S]=new RegExp(y,_?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),f("MAINVERSION",`(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${u[c.NUMERICIDENTIFIER]}|${u[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${u[c.NUMERICIDENTIFIERLOOSE]}|${u[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASE",`(?:-(${u[c.PRERELEASEIDENTIFIER]}(?:\\.${u[c.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${u[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[c.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${d}+`),f("BUILD",`(?:\\+(${u[c.BUILDIDENTIFIER]}(?:\\.${u[c.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${u[c.MAINVERSION]}${u[c.PRERELEASE]}?${u[c.BUILD]}?`),f("FULL",`^${u[c.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${u[c.MAINVERSIONLOOSE]}${u[c.PRERELEASELOOSE]}?${u[c.BUILD]}?`),f("LOOSE",`^${u[c.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${u[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${u[c.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:${u[c.PRERELEASE]})?${u[c.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:${u[c.PRERELEASELOOSE]})?${u[c.BUILD]}?)?)?`),f("XRANGE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),f("COERCE",`${u[c.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",u[c.COERCEPLAIN]+`(?:${u[c.PRERELEASE]})?(?:${u[c.BUILD]})?(?:$|[^\\d])`),f("COERCERTL",u[c.COERCE],!0),f("COERCERTLFULL",u[c.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${u[c.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",f("TILDE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${u[c.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",f("CARET",`^${u[c.LONECARET]}${u[c.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${u[c.LONECARET]}${u[c.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${u[c.GTLT]}\\s*(${u[c.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]}|${u[c.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${u[c.XRANGEPLAIN]})\\s+-\\s+(${u[c.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${u[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[c.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(th,th.exports);var io=th.exports;const ov=Object.freeze({loose:!0}),uv=Object.freeze({}),cv=t=>t?typeof t!="object"?ov:t:uv;var gf=cv;const Mp=/^[0-9]+$/,ay=(t,e)=>{const n=Mp.test(t),r=Mp.test(e);return n&&r&&(t=+t,e=+e),t===e?0:n&&!r?-1:r&&!n?1:t<e?-1:1},lv=(t,e)=>ay(e,t);var iy={compareIdentifiers:ay,rcompareIdentifiers:lv};const Vo=jc,{MAX_LENGTH:Bp,MAX_SAFE_INTEGER:zo}=Uc,{safeRe:Wo,t:Go}=io,dv=gf,{compareIdentifiers:Ls}=iy;let hv=class tr{constructor(e,n){if(n=dv(n),e instanceof tr){if(e.loose===!!n.loose&&e.includePrerelease===!!n.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Bp)throw new TypeError(`version is longer than ${Bp} characters`);Vo("SemVer",e,n),this.options=n,this.loose=!!n.loose,this.includePrerelease=!!n.includePrerelease;const r=e.trim().match(n.loose?Wo[Go.LOOSE]:Wo[Go.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>zo||this.major<0)throw new TypeError("Invalid major version");if(this.minor>zo||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>zo||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(s=>{if(/^[0-9]+$/.test(s)){const a=+s;if(a>=0&&a<zo)return a}return s}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Vo("SemVer.compare",this.version,this.options,e),!(e instanceof tr)){if(typeof e=="string"&&e===this.version)return 0;e=new tr(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof tr||(e=new tr(e,this.options)),Ls(this.major,e.major)||Ls(this.minor,e.minor)||Ls(this.patch,e.patch)}comparePre(e){if(e instanceof tr||(e=new tr(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let n=0;do{const r=this.prerelease[n],s=e.prerelease[n];if(Vo("prerelease compare",n,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return Ls(r,s)}while(++n)}compareBuild(e){e instanceof tr||(e=new tr(e,this.options));let n=0;do{const r=this.build[n],s=e.build[n];if(Vo("build compare",n,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return Ls(r,s)}while(++n)}inc(e,n,r){if(e.startsWith("pre")){if(!n&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(n){const s=`-${n}`.match(this.options.loose?Wo[Go.PRERELEASELOOSE]:Wo[Go.PRERELEASE]);if(!s||s[1]!==n)throw new Error(`invalid identifier: ${n}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",n,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",n,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",n,r),this.inc("pre",n,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",n,r),this.inc("pre",n,r);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const s=Number(r)?1:0;if(this.prerelease.length===0)this.prerelease=[s];else{let a=this.prerelease.length;for(;--a>=0;)typeof this.prerelease[a]=="number"&&(this.prerelease[a]++,a=-2);if(a===-1){if(n===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(s)}}if(n){let a=[n,s];r===!1&&(a=[n]),Ls(this.prerelease[0],n)===0?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var qt=hv;const Fp=qt,fv=(t,e,n=!1)=>{if(t instanceof Fp)return t;try{return new Fp(t,e)}catch(r){if(!n)return null;throw r}};var Ta=fv;const mv=Ta,pv=(t,e)=>{const n=mv(t,e);return n?n.version:null};var gv=pv;const bv=Ta,_v=(t,e)=>{const n=bv(t.trim().replace(/^[=v]+/,""),e);return n?n.version:null};var yv=_v;const Up=qt,Ev=(t,e,n,r,s)=>{typeof n=="string"&&(s=r,r=n,n=void 0);try{return new Up(t instanceof Up?t.version:t,n).inc(e,r,s).version}catch{return null}};var wv=Ev;const jp=Ta,Tv=(t,e)=>{const n=jp(t,null,!0),r=jp(e,null,!0),s=n.compare(r);if(s===0)return null;const a=s>0,i=a?n:r,o=a?r:n,u=!!i.prerelease.length;if(!!o.prerelease.length&&!u){if(!o.patch&&!o.minor)return"major";if(o.compareMain(i)===0)return o.minor&&!o.patch?"minor":"patch"}const l=u?"pre":"";return n.major!==r.major?l+"major":n.minor!==r.minor?l+"minor":n.patch!==r.patch?l+"patch":"prerelease"};var Sv=Tv;const Av=qt,Cv=(t,e)=>new Av(t,e).major;var Ov=Cv;const vv=qt,Iv=(t,e)=>new vv(t,e).minor;var kv=Iv;const Nv=qt,Rv=(t,e)=>new Nv(t,e).patch;var Pv=Rv;const xv=Ta,Lv=(t,e)=>{const n=xv(t,e);return n&&n.prerelease.length?n.prerelease:null};var Dv=Lv;const Hp=qt,Mv=(t,e,n)=>new Hp(t,n).compare(new Hp(e,n));var Wn=Mv;const Bv=Wn,Fv=(t,e,n)=>Bv(e,t,n);var Uv=Fv;const jv=Wn,Hv=(t,e)=>jv(t,e,!0);var $v=Hv;const $p=qt,qv=(t,e,n)=>{const r=new $p(t,n),s=new $p(e,n);return r.compare(s)||r.compareBuild(s)};var bf=qv;const Vv=bf,zv=(t,e)=>t.sort((n,r)=>Vv(n,r,e));var Wv=zv;const Gv=bf,Kv=(t,e)=>t.sort((n,r)=>Gv(r,n,e));var Yv=Kv;const Zv=Wn,Jv=(t,e,n)=>Zv(t,e,n)>0;var Hc=Jv;const Xv=Wn,Qv=(t,e,n)=>Xv(t,e,n)<0;var _f=Qv;const eI=Wn,tI=(t,e,n)=>eI(t,e,n)===0;var oy=tI;const nI=Wn,rI=(t,e,n)=>nI(t,e,n)!==0;var uy=rI;const sI=Wn,aI=(t,e,n)=>sI(t,e,n)>=0;var yf=aI;const iI=Wn,oI=(t,e,n)=>iI(t,e,n)<=0;var Ef=oI;const uI=oy,cI=uy,lI=Hc,dI=yf,hI=_f,fI=Ef,mI=(t,e,n,r)=>{switch(e){case"===":return typeof t=="object"&&(t=t.version),typeof n=="object"&&(n=n.version),t===n;case"!==":return typeof t=="object"&&(t=t.version),typeof n=="object"&&(n=n.version),t!==n;case"":case"=":case"==":return uI(t,n,r);case"!=":return cI(t,n,r);case">":return lI(t,n,r);case">=":return dI(t,n,r);case"<":return hI(t,n,r);case"<=":return fI(t,n,r);default:throw new TypeError(`Invalid operator: ${e}`)}};var cy=mI;const pI=qt,gI=Ta,{safeRe:Ko,t:Yo}=io,bI=(t,e)=>{if(t instanceof pI)return t;if(typeof t=="number"&&(t=String(t)),typeof t!="string")return null;e=e||{};let n=null;if(!e.rtl)n=t.match(e.includePrerelease?Ko[Yo.COERCEFULL]:Ko[Yo.COERCE]);else{const u=e.includePrerelease?Ko[Yo.COERCERTLFULL]:Ko[Yo.COERCERTL];let c;for(;(c=u.exec(t))&&(!n||n.index+n[0].length!==t.length);)(!n||c.index+c[0].length!==n.index+n[0].length)&&(n=c),u.lastIndex=c.index+c[1].length+c[2].length;u.lastIndex=-1}if(n===null)return null;const r=n[2],s=n[3]||"0",a=n[4]||"0",i=e.includePrerelease&&n[5]?`-${n[5]}`:"",o=e.includePrerelease&&n[6]?`+${n[6]}`:"";return gI(`${r}.${s}.${a}${i}${o}`,e)};var _I=bI;class yI{constructor(){this.max=1e3,this.map=new Map}get(e){const n=this.map.get(e);if(n!==void 0)return this.map.delete(e),this.map.set(e,n),n}delete(e){return this.map.delete(e)}set(e,n){if(!this.delete(e)&&n!==void 0){if(this.map.size>=this.max){const s=this.map.keys().next().value;this.delete(s)}this.map.set(e,n)}return this}}var EI=yI,Ul,qp;function Gn(){if(qp)return Ul;qp=1;const t=/\s+/g;class e{constructor(k,F){if(F=s(F),k instanceof e)return k.loose===!!F.loose&&k.includePrerelease===!!F.includePrerelease?k:new e(k.raw,F);if(k instanceof a)return this.raw=k.value,this.set=[[k]],this.formatted=void 0,this;if(this.options=F,this.loose=!!F.loose,this.includePrerelease=!!F.includePrerelease,this.raw=k.trim().replace(t," "),this.set=this.raw.split("||").map(q=>this.parseRange(q.trim())).filter(q=>q.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const q=this.set[0];if(this.set=this.set.filter(M=>!g(M[0])),this.set.length===0)this.set=[q];else if(this.set.length>1){for(const M of this.set)if(M.length===1&&b(M[0])){this.set=[M];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let k=0;k<this.set.length;k++){k>0&&(this.formatted+="||");const F=this.set[k];for(let q=0;q<F.length;q++)q>0&&(this.formatted+=" "),this.formatted+=F[q].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(k){const q=((this.options.includePrerelease&&p)|(this.options.loose&&f))+":"+k,M=r.get(q);if(M)return M;const z=this.options.loose,X=z?u[c.HYPHENRANGELOOSE]:u[c.HYPHENRANGE];k=k.replace(X,K(this.options.includePrerelease)),i("hyphen replace",k),k=k.replace(u[c.COMPARATORTRIM],l),i("comparator trim",k),k=k.replace(u[c.TILDETRIM],d),i("tilde trim",k),k=k.replace(u[c.CARETTRIM],m),i("caret trim",k);let W=k.split(" ").map(Ae=>y(Ae,this.options)).join(" ").split(/\s+/).map(Ae=>ee(Ae,this.options));z&&(W=W.filter(Ae=>(i("loose invalid filter",Ae,this.options),!!Ae.match(u[c.COMPARATORLOOSE])))),i("range list",W);const re=new Map,be=W.map(Ae=>new a(Ae,this.options));for(const Ae of be){if(g(Ae))return[Ae];re.set(Ae.value,Ae)}re.size>1&&re.has("")&&re.delete("");const Pe=[...re.values()];return r.set(q,Pe),Pe}intersects(k,F){if(!(k instanceof e))throw new TypeError("a Range is required");return this.set.some(q=>_(q,F)&&k.set.some(M=>_(M,F)&&q.every(z=>M.every(X=>z.intersects(X,F)))))}test(k){if(!k)return!1;if(typeof k=="string")try{k=new o(k,this.options)}catch{return!1}for(let F=0;F<this.set.length;F++)if(Q(this.set[F],k,this.options))return!0;return!1}}Ul=e;const n=EI,r=new n,s=gf,a=$c(),i=jc,o=qt,{safeRe:u,t:c,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:m}=io,{FLAG_INCLUDE_PRERELEASE:p,FLAG_LOOSE:f}=Uc,g=x=>x.value==="<0.0.0-0",b=x=>x.value==="",_=(x,k)=>{let F=!0;const q=x.slice();let M=q.pop();for(;F&&q.length;)F=q.every(z=>M.intersects(z,k)),M=q.pop();return F},y=(x,k)=>(i("comp",x,k),x=O(x,k),i("caret",x),x=I(x,k),i("tildes",x),x=L(x,k),i("xrange",x),x=B(x,k),i("stars",x),x),S=x=>!x||x.toLowerCase()==="x"||x==="*",I=(x,k)=>x.trim().split(/\s+/).map(F=>A(F,k)).join(" "),A=(x,k)=>{const F=k.loose?u[c.TILDELOOSE]:u[c.TILDE];return x.replace(F,(q,M,z,X,W)=>{i("tilde",x,q,M,z,X,W);let re;return S(M)?re="":S(z)?re=`>=${M}.0.0 <${+M+1}.0.0-0`:S(X)?re=`>=${M}.${z}.0 <${M}.${+z+1}.0-0`:W?(i("replaceTilde pr",W),re=`>=${M}.${z}.${X}-${W} <${M}.${+z+1}.0-0`):re=`>=${M}.${z}.${X} <${M}.${+z+1}.0-0`,i("tilde return",re),re})},O=(x,k)=>x.trim().split(/\s+/).map(F=>w(F,k)).join(" "),w=(x,k)=>{i("caret",x,k);const F=k.loose?u[c.CARETLOOSE]:u[c.CARET],q=k.includePrerelease?"-0":"";return x.replace(F,(M,z,X,W,re)=>{i("caret",x,M,z,X,W,re);let be;return S(z)?be="":S(X)?be=`>=${z}.0.0${q} <${+z+1}.0.0-0`:S(W)?z==="0"?be=`>=${z}.${X}.0${q} <${z}.${+X+1}.0-0`:be=`>=${z}.${X}.0${q} <${+z+1}.0.0-0`:re?(i("replaceCaret pr",re),z==="0"?X==="0"?be=`>=${z}.${X}.${W}-${re} <${z}.${X}.${+W+1}-0`:be=`>=${z}.${X}.${W}-${re} <${z}.${+X+1}.0-0`:be=`>=${z}.${X}.${W}-${re} <${+z+1}.0.0-0`):(i("no pr"),z==="0"?X==="0"?be=`>=${z}.${X}.${W}${q} <${z}.${X}.${+W+1}-0`:be=`>=${z}.${X}.${W}${q} <${z}.${+X+1}.0-0`:be=`>=${z}.${X}.${W} <${+z+1}.0.0-0`),i("caret return",be),be})},L=(x,k)=>(i("replaceXRanges",x,k),x.split(/\s+/).map(F=>D(F,k)).join(" ")),D=(x,k)=>{x=x.trim();const F=k.loose?u[c.XRANGELOOSE]:u[c.XRANGE];return x.replace(F,(q,M,z,X,W,re)=>{i("xRange",x,q,M,z,X,W,re);const be=S(z),Pe=be||S(X),Ae=Pe||S(W),_t=Ae;return M==="="&&_t&&(M=""),re=k.includePrerelease?"-0":"",be?M===">"||M==="<"?q="<0.0.0-0":q="*":M&&_t?(Pe&&(X=0),W=0,M===">"?(M=">=",Pe?(z=+z+1,X=0,W=0):(X=+X+1,W=0)):M==="<="&&(M="<",Pe?z=+z+1:X=+X+1),M==="<"&&(re="-0"),q=`${M+z}.${X}.${W}${re}`):Pe?q=`>=${z}.0.0${re} <${+z+1}.0.0-0`:Ae&&(q=`>=${z}.${X}.0${re} <${z}.${+X+1}.0-0`),i("xRange return",q),q})},B=(x,k)=>(i("replaceStars",x,k),x.trim().replace(u[c.STAR],"")),ee=(x,k)=>(i("replaceGTE0",x,k),x.trim().replace(u[k.includePrerelease?c.GTE0PRE:c.GTE0],"")),K=x=>(k,F,q,M,z,X,W,re,be,Pe,Ae,_t)=>(S(q)?F="":S(M)?F=`>=${q}.0.0${x?"-0":""}`:S(z)?F=`>=${q}.${M}.0${x?"-0":""}`:X?F=`>=${F}`:F=`>=${F}${x?"-0":""}`,S(be)?re="":S(Pe)?re=`<${+be+1}.0.0-0`:S(Ae)?re=`<${be}.${+Pe+1}.0-0`:_t?re=`<=${be}.${Pe}.${Ae}-${_t}`:x?re=`<${be}.${Pe}.${+Ae+1}-0`:re=`<=${re}`,`${F} ${re}`.trim()),Q=(x,k,F)=>{for(let q=0;q<x.length;q++)if(!x[q].test(k))return!1;if(k.prerelease.length&&!F.includePrerelease){for(let q=0;q<x.length;q++)if(i(x[q].semver),x[q].semver!==a.ANY&&x[q].semver.prerelease.length>0){const M=x[q].semver;if(M.major===k.major&&M.minor===k.minor&&M.patch===k.patch)return!0}return!1}return!0};return Ul}var jl,Vp;function $c(){if(Vp)return jl;Vp=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(l,d){if(d=n(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),i("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===t?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(l){const d=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],m=l.match(d);if(!m)throw new TypeError(`Invalid comparator: ${l}`);this.operator=m[1]!==void 0?m[1]:"",this.operator==="="&&(this.operator=""),m[2]?this.semver=new o(m[2],this.options.loose):this.semver=t}toString(){return this.value}test(l){if(i("Comparator.test",l,this.options.loose),this.semver===t||l===t)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return a(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new u(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new u(this.value,d).test(l.semver):(d=n(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||a(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||a(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}jl=e;const n=gf,{safeRe:r,t:s}=io,a=cy,i=jc,o=qt,u=Gn();return jl}const wI=Gn(),TI=(t,e,n)=>{try{e=new wI(e,n)}catch{return!1}return e.test(t)};var qc=TI;const SI=Gn(),AI=(t,e)=>new SI(t,e).set.map(n=>n.map(r=>r.value).join(" ").trim().split(" "));var CI=AI;const OI=qt,vI=Gn(),II=(t,e,n)=>{let r=null,s=null,a=null;try{a=new vI(e,n)}catch{return null}return t.forEach(i=>{a.test(i)&&(!r||s.compare(i)===-1)&&(r=i,s=new OI(r,n))}),r};var kI=II;const NI=qt,RI=Gn(),PI=(t,e,n)=>{let r=null,s=null,a=null;try{a=new RI(e,n)}catch{return null}return t.forEach(i=>{a.test(i)&&(!r||s.compare(i)===1)&&(r=i,s=new NI(r,n))}),r};var xI=PI;const Hl=qt,LI=Gn(),zp=Hc,DI=(t,e)=>{t=new LI(t,e);let n=new Hl("0.0.0");if(t.test(n)||(n=new Hl("0.0.0-0"),t.test(n)))return n;n=null;for(let r=0;r<t.set.length;++r){const s=t.set[r];let a=null;s.forEach(i=>{const o=new Hl(i.semver.version);switch(i.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!a||zp(o,a))&&(a=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${i.operator}`)}}),a&&(!n||zp(n,a))&&(n=a)}return n&&t.test(n)?n:null};var MI=DI;const BI=Gn(),FI=(t,e)=>{try{return new BI(t,e).range||"*"}catch{return null}};var UI=FI;const jI=qt,ly=$c(),{ANY:HI}=ly,$I=Gn(),qI=qc,Wp=Hc,Gp=_f,VI=Ef,zI=yf,WI=(t,e,n,r)=>{t=new jI(t,r),e=new $I(e,r);let s,a,i,o,u;switch(n){case">":s=Wp,a=VI,i=Gp,o=">",u=">=";break;case"<":s=Gp,a=zI,i=Wp,o="<",u="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(qI(t,e,r))return!1;for(let c=0;c<e.set.length;++c){const l=e.set[c];let d=null,m=null;if(l.forEach(p=>{p.semver===HI&&(p=new ly(">=0.0.0")),d=d||p,m=m||p,s(p.semver,d.semver,r)?d=p:i(p.semver,m.semver,r)&&(m=p)}),d.operator===o||d.operator===u||(!m.operator||m.operator===o)&&a(t,m.semver))return!1;if(m.operator===u&&i(t,m.semver))return!1}return!0};var wf=WI;const GI=wf,KI=(t,e,n)=>GI(t,e,">",n);var YI=KI;const ZI=wf,JI=(t,e,n)=>ZI(t,e,"<",n);var XI=JI;const Kp=Gn(),QI=(t,e,n)=>(t=new Kp(t,n),e=new Kp(e,n),t.intersects(e,n));var ek=QI;const tk=qc,nk=Wn;var rk=(t,e,n)=>{const r=[];let s=null,a=null;const i=t.sort((l,d)=>nk(l,d,n));for(const l of i)tk(l,e,n)?(a=l,s||(s=l)):(a&&r.push([s,a]),a=null,s=null);s&&r.push([s,null]);const o=[];for(const[l,d]of r)l===d?o.push(l):!d&&l===i[0]?o.push("*"):d?l===i[0]?o.push(`<=${d}`):o.push(`${l} - ${d}`):o.push(`>=${l}`);const u=o.join(" || "),c=typeof e.raw=="string"?e.raw:String(e);return u.length<c.length?u:e};const Yp=Gn(),Tf=$c(),{ANY:$l}=Tf,qa=qc,Sf=Wn,sk=(t,e,n={})=>{if(t===e)return!0;t=new Yp(t,n),e=new Yp(e,n);let r=!1;e:for(const s of t.set){for(const a of e.set){const i=ik(s,a,n);if(r=r||i!==null,i)continue e}if(r)return!1}return!0},ak=[new Tf(">=0.0.0-0")],Zp=[new Tf(">=0.0.0")],ik=(t,e,n)=>{if(t===e)return!0;if(t.length===1&&t[0].semver===$l){if(e.length===1&&e[0].semver===$l)return!0;n.includePrerelease?t=ak:t=Zp}if(e.length===1&&e[0].semver===$l){if(n.includePrerelease)return!0;e=Zp}const r=new Set;let s,a;for(const p of t)p.operator===">"||p.operator===">="?s=Jp(s,p,n):p.operator==="<"||p.operator==="<="?a=Xp(a,p,n):r.add(p.semver);if(r.size>1)return null;let i;if(s&&a){if(i=Sf(s.semver,a.semver,n),i>0)return null;if(i===0&&(s.operator!==">="||a.operator!=="<="))return null}for(const p of r){if(s&&!qa(p,String(s),n)||a&&!qa(p,String(a),n))return null;for(const f of e)if(!qa(p,String(f),n))return!1;return!0}let o,u,c,l,d=a&&!n.includePrerelease&&a.semver.prerelease.length?a.semver:!1,m=s&&!n.includePrerelease&&s.semver.prerelease.length?s.semver:!1;d&&d.prerelease.length===1&&a.operator==="<"&&d.prerelease[0]===0&&(d=!1);for(const p of e){if(l=l||p.operator===">"||p.operator===">=",c=c||p.operator==="<"||p.operator==="<=",s){if(m&&p.semver.prerelease&&p.semver.prerelease.length&&p.semver.major===m.major&&p.semver.minor===m.minor&&p.semver.patch===m.patch&&(m=!1),p.operator===">"||p.operator===">="){if(o=Jp(s,p,n),o===p&&o!==s)return!1}else if(s.operator===">="&&!qa(s.semver,String(p),n))return!1}if(a){if(d&&p.semver.prerelease&&p.semver.prerelease.length&&p.semver.major===d.major&&p.semver.minor===d.minor&&p.semver.patch===d.patch&&(d=!1),p.operator==="<"||p.operator==="<="){if(u=Xp(a,p,n),u===p&&u!==a)return!1}else if(a.operator==="<="&&!qa(a.semver,String(p),n))return!1}if(!p.operator&&(a||s)&&i!==0)return!1}return!(s&&c&&!a&&i!==0||a&&l&&!s&&i!==0||m||d)},Jp=(t,e,n)=>{if(!t)return e;const r=Sf(t.semver,e.semver,n);return r>0?t:r<0||e.operator===">"&&t.operator===">="?e:t},Xp=(t,e,n)=>{if(!t)return e;const r=Sf(t.semver,e.semver,n);return r<0?t:r>0||e.operator==="<"&&t.operator==="<="?e:t};var ok=sk;const ql=io,Qp=Uc,uk=qt,eg=iy,ck=Ta,lk=gv,dk=yv,hk=wv,fk=Sv,mk=Ov,pk=kv,gk=Pv,bk=Dv,_k=Wn,yk=Uv,Ek=$v,wk=bf,Tk=Wv,Sk=Yv,Ak=Hc,Ck=_f,Ok=oy,vk=uy,Ik=yf,kk=Ef,Nk=cy,Rk=_I,Pk=$c(),xk=Gn(),Lk=qc,Dk=CI,Mk=kI,Bk=xI,Fk=MI,Uk=UI,jk=wf,Hk=YI,$k=XI,qk=ek,Vk=rk,zk=ok;ql.re,ql.src,ql.t,Qp.SEMVER_SPEC_VERSION,Qp.RELEASE_TYPES,eg.compareIdentifiers,eg.rcompareIdentifiers;function Dr(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,n]=t.split(":"),r=n||"latest";if(e.includes("/")){const[s,a]=e.split("/",2);if(!s||!a)throw new Error(`Invalid identifier format: ${t}`);return[s,a,r]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,r]}}class Wk extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function ye(t,e,n){let r;if(t.ok){n&&(r=await t.text());return}r=await t.text();const s=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Server response: ${r}`;throw t.status===409?new Wk(s):new Error(s)}var tg="[...]",Gk={result:"[Circular]"},Vu=[],Ks=[];function Kk(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function sn(t,e,n,r){var i;try{return JSON.stringify(t,e,n)}catch(o){if(!((i=o.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r>"u"&&(r=Kk()),nh(t,"",0,[],void 0,0,r);var s;try{Ks.length===0?s=JSON.stringify(t,e,n):s=JSON.stringify(t,Yk(e),n)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Vu.length!==0;){var a=Vu.pop();a.length===4?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return s}}function Vl(t,e,n,r){var s=Object.getOwnPropertyDescriptor(r,n);s.get!==void 0?s.configurable?(Object.defineProperty(r,n,{value:t}),Vu.push([r,n,e,s])):Ks.push([e,n,t]):(r[n]=t,Vu.push([r,n,e]))}function nh(t,e,n,r,s,a,i){a+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<r.length;o++)if(r[o]===t){Vl(Gk,t,e,s);return}if(typeof i.depthLimit<"u"&&a>i.depthLimit){Vl(tg,t,e,s);return}if(typeof i.edgesLimit<"u"&&n+1>i.edgesLimit){Vl(tg,t,e,s);return}if(r.push(t),Array.isArray(t))for(o=0;o<t.length;o++)nh(t[o],o,o,r,t,a,i);else{var u=Object.keys(t);for(o=0;o<u.length;o++){var c=u[o];nh(t[c],c,o,r,t,a,i)}}r.pop()}}function Yk(t){return t=typeof t<"u"?t:function(e,n){return n},function(e,n){if(Ks.length>0)for(var r=0;r<Ks.length;r++){var s=Ks[r];if(s[1]===e&&s[0]===n){n=s[2],Ks.splice(r,1);break}}return t.call(this,e,n)}}function ng(t){const e=fy(),n=uN(),r=t.extra??{},s=r.metadata;return t.extra={...r,runtime:{...e,...r==null?void 0:r.runtime},metadata:{...n,...n.revision_id||t.revision_id?{revision_id:t.revision_id??n.revision_id}:{},...s}},t}const Zk=()=>{const t=Hr("TRACING_SAMPLING_RATE");if(t===void 0)return;const e=parseFloat(t);if(e<0||e>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},Jk=t=>{const n=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return n==="localhost"||n==="127.0.0.1"||n==="::1"};async function Xk(t){const e=[];for await(const n of t)e.push(n);return e}function zl(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Qk=async t=>{if((t==null?void 0:t.status)===429){const e=parseInt(t.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(n=>setTimeout(n,e)),!0}return!1};class eN{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let n;const r=new Promise(a=>{n=a}),s=sn(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:n,itemPromise:r,size:s}),this.sizeBytes+=s,r}pop(e){var s;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let r=0;for(;r+(((s=this.peek())==null?void 0:s.size)??0)<e&&this.items.length>0;){const a=this.items.shift();a&&(n.push(a),r+=a.size,this.sizeBytes-=a.size)}if(n.length===0&&this.items.length>0){const a=this.items.shift();n.push(a),r+=a.size,this.sizeBytes-=a.size}return[n.map(a=>({action:a.action,item:a.payload})),()=>n.forEach(a=>a.itemPromiseResolve())]}}const tN=20971520,nN=2500;class Ui{constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new eN}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:hs("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});const n=Ui.getDefaultClientConfig();if(this.tracingSampleRate=Zk(),this.apiUrl=zl(e.apiUrl??n.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=zl(e.apiKey??n.apiKey),this.webUrl=zl(e.webUrl??n.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Pp(e.callerOptions??{}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new Pp({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:Qk}),this.hideInputs=e.hideInputs??e.anonymizer??n.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??n.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=Hr("API_KEY"),n=Hr("ENDPOINT")??"https://api.smith.langchain.com",r=Hr("HIDE_INPUTS")==="true",s=Hr("HIDE_OUTPUTS")==="true";return{apiUrl:n,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:Jk(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${dy}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const n={...e};return n.inputs!==void 0&&(n.inputs=this.processInputs(n.inputs)),n.outputs!==void 0&&(n.outputs=this.processOutputs(n.outputs)),n}async _getResponse(e,n){const r=(n==null?void 0:n.toString())??"",s=`${this.apiUrl}${e}?${r}`,a=await this.caller.call(ie(),s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(a,`Failed to fetch ${e}`),a}async _get(e,n){return(await this._getResponse(e,n)).json()}async*_getPaginated(e,n=new URLSearchParams,r){let s=Number(n.get("offset"))||0;const a=Number(n.get("limit"))||100;for(;;){n.set("offset",String(s)),n.set("limit",String(a));const i=`${this.apiUrl}${e}?${n}`,o=await this.caller.call(ie(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(o,`Failed to fetch ${e}`);const u=r?r(await o.json()):await o.json();if(u.length===0||(yield u,u.length<a))break;s+=u.length}}async*_getCursorPaginatedList(e,n=null,r="POST",s="runs"){const a=n?{...n}:{};for(;;){const o=await(await this.caller.call(ie(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)})).json();if(!o||!o[s])break;yield o[s];const u=o.cursors;if(!u||!u.next)break;a.cursor=u.next}}_filterForSampling(e,n=!1){if(this.tracingSampleRate===void 0)return e;if(n){const r=[];for(const s of e)this.filteredPostUuids.has(s.id)?this.filteredPostUuids.delete(s.id):r.push(s);return r}else{const r=[];for(const s of e)s.id!==s.trace_id&&!this.filteredPostUuids.has(s.trace_id)||Math.random()<this.tracingSampleRate?r.push(s):this.filteredPostUuids.add(s.id);return r}}async _getBatchSizeLimitBytes(){var n;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((n=e.batch_ingest_config)==null?void 0:n.size_limit_bytes)??tN}async _getMultiPartSupport(){var n;return((n=(await this._ensureServerInfo()).instance_flags)==null?void 0:n.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue(e){const n=[];for(;this.autoBatchQueue.items.length>0;){const[r,s]=this.autoBatchQueue.pop(e);if(!r.length){s();break}const a=this._processBatch(r,s).catch(console.error);n.push(a)}return Promise.all(n)}async _processBatch(e,n){var r;if(!e.length){n();return}try{const s={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)},a=await this._ensureServerInfo();(r=a==null?void 0:a.batch_ingest_config)!=null&&r.use_multipart_endpoint?await this.multipartIngestRuns(s):await this.batchIngestRuns(s)}finally{n()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=ng(e.item));const n=this.autoBatchQueue.push(e);if(this.manualFlushMode)return n;const r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),n}async _getServerInfo(){const e=await ie()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(nN),...this.fetchOptions});return await ye(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch{console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const s=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){this.processRunOperation({action:"create",item:s}).catch(console.error);return}const a=ng(s),i=await this.caller.call(ie(),`${this.apiUrl}/runs`,{method:"POST",headers:n,body:sn(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:n}){if(e===void 0&&n===void 0)return;let r=(e==null?void 0:e.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[],s=(n==null?void 0:n.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[];if(r.length>0&&s.length>0){const o=r.reduce((c,l)=>(l.id&&(c[l.id]=l),c),{}),u=[];for(const c of s)c.id!==void 0&&o[c.id]?o[c.id]={...o[c.id],...c}:u.push(c);r=Object.values(o),s=u}const a={post:this._filterForSampling(r),patch:this._filterForSampling(s,!0)};if(!a.post.length&&!a.patch.length)return;const i={post:[],patch:[]};for(const o of["post","patch"]){const u=o,c=a[u].reverse();let l=c.pop();for(;l!==void 0;)i[u].push(l),l=c.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(sn(i))}async _postBatchIngestRuns(e){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(ie(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:n,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:n}){if(e===void 0&&n===void 0)return;const r={};let s=[];for(const l of e??[]){const d=this.prepareRunCreateOrUpdateInputs(l);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,s.push(d)}let a=[];for(const l of n??[])a.push(this.prepareRunCreateOrUpdateInputs(l));if(s.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(s.length>0&&a.length>0){const l=s.reduce((m,p)=>(p.id&&(m[p.id]=p),m),{}),d=[];for(const m of a)m.id!==void 0&&l[m.id]?l[m.id]={...l[m.id],...m}:d.push(m);s=Object.values(l),a=d}if(s.length===0&&a.length===0)return;const u=[],c=[];for(const[l,d]of[["post",s],["patch",a]])for(const m of d){const{inputs:p,outputs:f,events:g,attachments:b,..._}=m,y={inputs:p,outputs:f,events:g},S=sn(_);c.push({name:`${l}.${_.id}`,payload:new Blob([S],{type:`application/json; length=${S.length}`})});for(const[I,A]of Object.entries(y)){if(A===void 0)continue;const O=sn(A);c.push({name:`${l}.${_.id}.${I}`,payload:new Blob([O],{type:`application/json; length=${O.length}`})})}if(_.id!==void 0){const I=r[_.id];if(I){delete r[_.id];for(const[A,O]of Object.entries(I)){let w,L;if(Array.isArray(O)?[w,L]=O:(w=O.mimeType,L=O.data),A.includes(".")){console.warn(`Skipping attachment '${A}' for run ${_.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}c.push({name:`attachment.${_.id}.${A}`,payload:new Blob([L],{type:`${w}; length=${L.byteLength}`})})}}}u.push(`trace=${_.trace_id},id=${_.id}`)}await this._sendMultipartRequest(c,u.join("; "))}async _sendMultipartRequest(e,n){try{const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),s=[];for(const u of e)s.push(new Blob([`--${r}\r
`])),s.push(new Blob([`Content-Disposition: form-data; name="${u.name}"\r
`,`Content-Type: ${u.payload.type}\r
\r
`])),s.push(u.payload),s.push(new Blob([`\r
`]));s.push(new Blob([`--${r}--\r
`]));const i=await new Blob(s).arrayBuffer(),o=await this.batchIngestCaller.call(ie(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(o,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${n}`)}}async updateRun(e,n){Se(e),n.inputs&&(n.inputs=this.processInputs(n.inputs)),n.outputs&&(n.outputs=this.processOutputs(n.outputs));const r={...n,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(n.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const s={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(ie(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,body:sn(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(a,"update run",!0)}async readRun(e,{loadChildRuns:n}={loadChildRuns:!1}){Se(e);let r=await this._get(`/runs/${e}`);return n&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:n,projectOpts:r}){if(n!==void 0){let s;n.session_id?s=n.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:Hr("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${s}/r/${n.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const n=await Xk(this.listRuns({id:e.child_run_ids})),r={},s={};n.sort((a,i)=>((a==null?void 0:a.dotted_order)??"").localeCompare((i==null?void 0:i.dotted_order)??""));for(const a of n){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),s[a.id]=a}e.child_runs=r[e.id]||[];for(const a in r)a!==e.id&&(s[a].child_runs=r[a]);return e}async*listRuns(e){const{projectId:n,projectName:r,parentRunId:s,traceId:a,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:c,runType:l,error:d,id:m,query:p,filter:f,traceFilter:g,treeFilter:b,limit:_,select:y}=e;let S=[];if(n&&(S=Array.isArray(n)?n:[n]),r){const w=Array.isArray(r)?r:[r],L=await Promise.all(w.map(D=>this.readProject({projectName:D}).then(B=>B.id)));S.push(...L)}const I=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],A={session:S.length?S:null,run_type:l,reference_example:i,query:p,filter:f,trace_filter:g,tree_filter:b,execution_order:u,parent_run:s,start_time:o?o.toISOString():null,error:d,id:m,limit:_,trace:a,select:y||I,is_root:c};let O=0;for await(const w of this._getCursorPaginatedList("/runs/query",A))if(_){if(O>=_)break;if(w.length+O>_){yield*w.slice(0,_-O);break}O+=w.length,yield*w}else yield*w}async getRunStats({id:e,trace:n,parentRun:r,runType:s,projectNames:a,projectIds:i,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:d,filter:m,traceFilter:p,treeFilter:f,isRoot:g,dataSourceType:b}){let _=i||[];a&&(_=[...i||[],...await Promise.all(a.map(O=>this.readProject({projectName:O}).then(w=>w.id)))]);const S=Object.fromEntries(Object.entries({id:e,trace:n,parent_run:r,run_type:s,session:_,reference_example:o,start_time:u,end_time:c,error:l,query:d,filter:m,trace_filter:p,tree_filter:f,is_root:g,data_source_type:b}).filter(([O,w])=>w!==void 0));return await(await this.caller.call(ie(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(S),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:n}={}){const r={run_id:e,share_token:n||Jt()};Se(e);const a=await(await this.caller.call(ie(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){Se(e);const n=await this.caller.call(ie(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(n,"unshare run",!0)}async readRunSharedLink(e){Se(e);const r=await(await this.caller.call(ie(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:n}={}){const r=new URLSearchParams({share_token:e});if(n!==void 0)for(const i of n)r.append("id",i);return Se(e),await(await this.caller.call(ie(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id),Se(e);const s=await(await this.caller.call(ie(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id);const r={dataset_id:e};Se(e);const a=await(await this.caller.call(ie(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){Se(e);const n=await this.caller.call(ie(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(n,"unshare dataset",!0)}async readSharedDataset(e){return Se(e),await(await this.caller.call(ie(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,n){const r={};n!=null&&n.exampleIds&&(r.id=n.exampleIds);const s=new URLSearchParams;Object.entries(r).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>s.append(o,c)):s.append(o,u)});const a=await this.caller.call(ie(),`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();if(!a.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:n=null,metadata:r=null,upsert:s=!1,projectExtra:a=null,referenceDatasetId:i=null}){const o=s?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=a||{};r&&(c.metadata=r);const l={name:e,extra:c,description:n};i!==null&&(l.reference_dataset_id=i);const d=await this.caller.call(ie(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(d,"create project"),await d.json()}async updateProject(e,{name:n=null,description:r=null,metadata:s=null,projectExtra:a=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=a;s&&(u={...u||{},metadata:s});const c={name:n,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(ie(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:n}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Se(e),r+=`/${e}`;else if(n!==void 0)s.append("name",n);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(ie(),`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const i=await a.json();return a.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:n,includeStats:r}){let s="/sessions";const a=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Se(e),s+=`/${e}`;else if(n!==void 0)a.append("name",n);else throw new Error("Must provide projectName or projectId");r!==void 0&&a.append("include_stats",r.toString());const i=await this._get(s,a);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${n}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const n of this._getPaginated("/sessions",e))return this._tenantId=n[0].tenant_id,n[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:n,nameContains:r,referenceDatasetId:s,referenceDatasetName:a,referenceFree:i,metadata:o}={}){const u=new URLSearchParams;if(e!==void 0)for(const c of e)u.append("id",c);if(n!==void 0&&u.append("name",n),r!==void 0&&u.append("name_contains",r),s!==void 0)u.append("reference_dataset",s);else if(a!==void 0){const c=await this.readDataset({datasetName:a});u.append("reference_dataset",c.id)}i!==void 0&&u.append("reference_free",i.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(const c of this._getPaginated("/sessions",u))yield*c}async deleteProject({projectId:e,projectName:n}){let r;if(e===void 0&&n===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:n})).id:r=e,Se(r);const s=await this.caller.call(ie(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(s,`delete session ${r} (${n})`,!0)}async uploadCsv({csvFile:e,fileName:n,inputKeys:r,outputKeys:s,description:a,dataType:i,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,n),r.forEach(m=>{c.append("input_keys",m)}),s.forEach(m=>{c.append("output_keys",m)}),a&&c.append("description",a),i&&c.append("data_type",i),o&&c.append("name",o);const l=await this.caller.call(ie(),u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(l,"upload CSV"),await l.json()}async createDataset(e,{description:n,dataType:r,inputsSchema:s,outputsSchema:a,metadata:i}={}){const o={name:e,description:n,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),s&&(o.inputs_schema_definition=s),a&&(o.outputs_schema_definition=a);const u=await this.caller.call(ie(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:n}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)Se(e),r+=`/${e}`;else if(n!==void 0)s.append("name",n);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(r,s);let i;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${n}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:n}){try{return await this.readDataset({datasetId:e,datasetName:n}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:n,fromVersion:r,toVersion:s}){let a=e;if(a===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:n})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:n}){const r="/datasets";if(e===void 0)if(n!==void 0)e=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:n=0,datasetIds:r,datasetName:s,datasetNameContains:a,metadata:i}={}){const o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:n.toString()});if(r!==void 0)for(const c of r)u.append("id",c);s!==void 0&&u.append("name",s),a!==void 0&&u.append("name_contains",a),i!==void 0&&u.append("metadata",JSON.stringify(i));for await(const c of this._getPaginated(o,u))yield*c}async updateDataset(e){const{datasetId:n,datasetName:r,...s}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const a=n??(await this.readDataset({datasetName:r})).id;Se(a);const i=await this.caller.call(ie(),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(i,"update dataset"),await i.json()}async updateDatasetTag(e){const{datasetId:n,datasetName:r,asOf:s,tag:a}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const i=n??(await this.readDataset({datasetName:r})).id;Se(i);const o=await this.caller.call(ie(),`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(o,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:n}){let r="/datasets",s=e;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(n!==void 0&&(s=(await this.readDataset({datasetName:n})).id),s!==void 0)Se(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");const a=await this.caller.call(ie(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(a,`delete ${r}`),await a.json()}async indexDataset({datasetId:e,datasetName:n,tag:r}){let s=e;if(!s&&!n)throw new Error("Must provide either datasetName or datasetId");if(s&&n)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:n})).id),Se(s);const a={tag:r},i=await this.caller.call(ie(),`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(i,"index dataset"),await i.json()}async similarExamples(e,n,r,{filter:s}={}){const a={limit:r,inputs:e};s!==void 0&&(a.filter=s),Se(n);const i=await this.caller.call(ie(),`${this.apiUrl}/datasets/${n}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,n,{datasetId:r,datasetName:s,createdAt:a,exampleId:i,metadata:o,split:u,sourceRunId:c}){let l=r;if(l===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:s})).id);const d=a||new Date,m={dataset_id:l,inputs:e,outputs:n,created_at:d==null?void 0:d.toISOString(),id:i,metadata:o,split:u,source_run_id:c},p=await this.caller.call(ie(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(p,"create example"),await p.json()}async createExamples(e){const{inputs:n,outputs:r,metadata:s,sourceRunIds:a,exampleIds:i,datasetId:o,datasetName:u}=e;let c=o;if(c===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(c!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");c===void 0&&(c=(await this.readDataset({datasetName:u})).id);const l=n.map((p,f)=>({dataset_id:c,inputs:p,outputs:r?r[f]:void 0,metadata:s?s[f]:void 0,split:e.splits?e.splits[f]:void 0,id:i?i[f]:void 0,source_run_id:a?a[f]:void 0})),d=await this.caller.call(ie(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(d,"create examples"),await d.json()}async createLLMExample(e,n,r){return this.createExample({input:e},{output:n},r)}async createChatExample(e,n,r){const s=e.map(i=>xp(i)?Lp(i):i),a=xp(n)?Lp(n):n;return this.createExample({input:s},{output:a},r)}async readExample(e){Se(e);const n=`/examples/${e}`,r=await this._get(n),{attachment_urls:s,...a}=r,i=a;return s&&(i.attachments=Object.entries(s).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url,mime_type:c.mime_type},o),{})),i}async*listExamples({datasetId:e,datasetName:n,exampleIds:r,asOf:s,splits:a,inlineS3Urls:i,metadata:o,limit:u,offset:c,filter:l,includeAttachments:d}={}){let m;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)m=e;else if(n!==void 0)m=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide a datasetName or datasetId");const p=new URLSearchParams({dataset:m}),f=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;f&&p.append("as_of",f);const g=i??!0;if(p.append("inline_s3_urls",g.toString()),r!==void 0)for(const _ of r)p.append("id",_);if(a!==void 0)for(const _ of a)p.append("splits",_);if(o!==void 0){const _=JSON.stringify(o);p.append("metadata",_)}u!==void 0&&p.append("limit",u.toString()),c!==void 0&&p.append("offset",c.toString()),l!==void 0&&p.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(_=>p.append("select",_));let b=0;for await(const _ of this._getPaginated("/examples",p)){for(const y of _){const{attachment_urls:S,...I}=y,A=I;S&&(A.attachments=Object.entries(S).reduce((O,[w,L])=>(O[w.slice(11)]={presigned_url:L.presigned_url,mime_type:L.mime_type||void 0},O),{})),yield A,b++}if(u!==void 0&&b>=u)break}}async deleteExample(e){Se(e);const n=`/examples/${e}`,r=await this.caller.call(ie(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(r,`delete ${n}`),await r.json()}async updateExample(e,n){Se(e);const r=await this.caller.call(ie(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(r,"update example"),await r.json()}async updateExamples(e){const n=await this.caller.call(ie(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(n,"update examples"),await n.json()}async readDatasetVersion({datasetId:e,datasetName:n,asOf:r,tag:s}){let a;if(e?a=e:a=(await this.readDataset({datasetName:n})).id,Se(a),r&&s||!r&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;r!==void 0&&i.append("as_of",typeof r=="string"?r:r.toISOString()),s!==void 0&&i.append("tag",s);const o=await this.caller.call(ie(),`${this.apiUrl}/datasets/${a}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(o,"read dataset version"),await o.json()}async listDatasetSplits({datasetId:e,datasetName:n,asOf:r}){let s;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:n})).id:s=e,Se(s);const a=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&a.append("as_of",i),await this._get(`/datasets/${s}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:n,splitName:r,exampleIds:s,remove:a=!1}){let i;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:n})).id:i=e,Se(i);const o={split_name:r,examples:s.map(c=>(Se(c),c)),remove:a},u=await this.caller.call(ie(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(u,"update dataset splits",!0)}async evaluateRun(e,n,{sourceInfo:r,loadChildRuns:s,referenceExample:a}={loadChildRuns:!1}){ry("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));const o=await n.evaluateRun(i,a),[u,c]=await this._logEvaluationFeedback(o,i,r);return c[0]}async createFeedback(e,n,{score:r,value:s,correction:a,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d,projectId:m,comparativeExperimentId:p}){var y;if(!e&&!m)throw new Error("One of runId or projectId must be provided");if(e&&m)throw new Error("Only one of runId or projectId can be provided");const f={type:u??"api",metadata:o??{}};c!==void 0&&(f==null?void 0:f.metadata)!==void 0&&!f.metadata.__run&&(f.metadata.__run={run_id:c}),(f==null?void 0:f.metadata)!==void 0&&((y=f.metadata.__run)==null?void 0:y.run_id)!==void 0&&Se(f.metadata.__run.run_id);const g={id:l??Jt(),run_id:e,key:n,score:r,value:s,correction:a,comment:i,feedback_source:f,comparative_experiment_id:p,feedbackConfig:d,session_id:m},b=`${this.apiUrl}/feedback`,_=await this.caller.call(ie(),b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(g),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(_,"create feedback",!0),g}async updateFeedback(e,{score:n,value:r,correction:s,comment:a}){const i={};n!=null&&(i.score=n),r!=null&&(i.value=r),s!=null&&(i.correction=s),a!=null&&(i.comment=a),Se(e);const o=await this.caller.call(ie(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(o,"update feedback",!0)}async readFeedback(e){Se(e);const n=`/feedback/${e}`;return await this._get(n)}async deleteFeedback(e){Se(e);const n=`/feedback/${e}`,r=await this.caller.call(ie(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(r,`delete ${n}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:n,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e&&s.append("run",e.join(",")),n)for(const a of n)s.append("key",a);if(r)for(const a of r)s.append("source",a);for await(const a of this._getPaginated("/feedback",s))yield*a}async createPresignedFeedbackToken(e,n,{expiration:r,feedbackConfig:s}={}){const a={run_id:e,feedback_key:n,feedback_config:s};return r?typeof r=="string"?a.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(a.expires_in=r):a.expires_in={hours:3},await(await this.caller.call(ie(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:n,referenceDatasetId:r,createdAt:s,description:a,metadata:i,id:o}){var l;if(n.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:n[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const u={id:o,name:e,experiment_ids:n,reference_dataset_id:r,description:a,created_at:(l=s??new Date)==null?void 0:l.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(ie(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){Se(e);const n=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",n))yield*r}_selectEvalResults(e){let n;return"results"in e?n=e.results:n=[e],n}async _logEvaluationFeedback(e,n,r){const s=this._selectEvalResults(e),a=[];for(const i of s){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:n&&(u=n.id),a.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[s,a]}async logEvaluationFeedback(e,n,r){const[s]=await this._logEvaluationFeedback(e,n,r);return s}async*listAnnotationQueues(e={}){const{queueIds:n,name:r,nameContains:s,limit:a}=e,i=new URLSearchParams;n&&n.forEach((u,c)=>{Se(u,`queueIds[${c}]`),i.append("ids",u)}),r&&i.append("name",r),s&&i.append("name_contains",s),i.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(const u of this._getPaginated("/annotation-queues",i))if(yield*u,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(e){const{name:n,description:r,queueId:s}=e,a={name:n,description:r,id:s||Jt()},i=await this.caller.call(ie(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(a).filter(([u,c])=>c!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){const n=await this.listAnnotationQueues({queueIds:[e]}).next();if(n.done)throw new Error(`Annotation queue with ID ${e} not found`);return n.value}async updateAnnotationQueue(e,n){const{name:r,description:s}=n,a=await this.caller.call(ie(),`${this.apiUrl}/annotation-queues/${Se(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:s}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(a,"update annotation queue")}async deleteAnnotationQueue(e){const n=await this.caller.call(ie(),`${this.apiUrl}/annotation-queues/${Se(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(n,"delete annotation queue")}async addRunsToAnnotationQueue(e,n){const r=await this.caller.call(ie(),`${this.apiUrl}/annotation-queues/${Se(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n.map((s,a)=>Se(s,`runIds[${a}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,n){const r=`/annotation-queues/${Se(e,"queueId")}/run`,s=await this.caller.call(ie(),`${this.apiUrl}${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(s,"get run from annotation queue"),await s.json()}async deleteRunFromAnnotationQueue(e,n){const r=await this.caller.call(ie(),`${this.apiUrl}/annotation-queues/${Se(e,"queueId")}/runs/${Se(n,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(r,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const n=await this.caller.call(ie(),`${this.apiUrl}/annotation-queues/${Se(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(n,"get size from annotation queue"),await n.json()}async _currentTenantIsOwner(e){const n=await this._getSettings();return e=="-"||n.tenant_handle===e}async _ownerConflictError(e,n){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${n}`)}async _getLatestCommitHash(e){const n=await this.caller.call(ie(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();if(!n.ok){const s=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),a=new Error(`Error ${n.status}: ${n.statusText}
${s}`);throw a.statusCode=n.status,a}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,n){const[r,s,a]=Dr(e),i=await this.caller.call(ie(),`${this.apiUrl}/likes/${r}/${s}`,{method:"POST",body:JSON.stringify({like:n}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(i,`${n?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){const[n,r,s]=Dr(e);if(await this._currentTenantIsOwner(n)){const a=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${r}/${s.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${a.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${n}/${r}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${n}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const n of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*n}async*listPrompts(e){const n=new URLSearchParams;n.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),n.append("sort_direction","desc"),n.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&n.append("is_public",e.isPublic.toString()),e!=null&&e.query&&n.append("query",e.query);for await(const r of this._getPaginated("/repos",n,s=>s.repos))yield*r}async getPrompt(e){const[n,r,s]=Dr(e),a=await this.caller.call(ie(),`${this.apiUrl}/repos/${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(a.status===404)return null;await ye(a,"get prompt");const i=await a.json();return i.repo?i.repo:null}async createPrompt(e,n){const r=await this._getSettings();if(n!=null&&n.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,a,i]=Dr(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:a,...(n==null?void 0:n.description)&&{description:n.description},...(n==null?void 0:n.readme)&&{readme:n.readme},...(n==null?void 0:n.tags)&&{tags:n.tags},is_public:!!(n!=null&&n.isPublic)},u=await this.caller.call(ie(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(u,"create prompt");const{repo:c}=await u.json();return c}async createCommit(e,n,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,a,i]=Dr(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${s}/${a}`):r==null?void 0:r.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(n)),parent_commit:o},c=await this.caller.call(ie(),`${this.apiUrl}/commits/${s}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(c,"create commit");const l=await c.json();return this._getPromptUrl(`${s}/${a}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,n=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of n){const o=i.id,u={...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=sn(u),l=new Blob([c],{type:"application/json"});if(r.append(o,l),i.inputs){const d=sn(i.inputs),m=new Blob([d],{type:"application/json"});r.append(`${o}.inputs`,m)}if(i.outputs){const d=sn(i.outputs),m=new Blob([d],{type:"application/json"});r.append(`${o}.outputs`,m)}if(i.attachments)for(const[d,m]of Object.entries(i.attachments)){let p,f;Array.isArray(m)?[p,f]=m:(p=m.mimeType,f=m.data);const g=new Blob([f],{type:`${p}; length=${f.byteLength}`});r.append(`${o}.attachment.${d}`,g)}if(i.attachments_operations){const d=sn(i.attachments_operations),m=new Blob([d],{type:"application/json"});r.append(`${o}.attachments_operations`,m)}}return await(await this.caller.call(ie(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,n=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of n){const o=(i.id??Jt()).toString(),u={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=sn(u),l=new Blob([c],{type:"application/json"});r.append(o,l);const d=sn(i.inputs),m=new Blob([d],{type:"application/json"});if(r.append(`${o}.inputs`,m),i.outputs){const p=sn(i.outputs),f=new Blob([p],{type:"application/json"});r.append(`${o}.outputs`,f)}if(i.attachments)for(const[p,f]of Object.entries(i.attachments)){let g,b;Array.isArray(f)?[g,b]=f:(g=f.mimeType,b=f.data);const _=new Blob([b],{type:`${g}; length=${b.byteLength}`});r.append(`${o}.attachment.${p}`,_)}}return await(await this.caller.call(ie(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r})).json()}async updatePrompt(e,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s]=Dr(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if((n==null?void 0:n.description)!==void 0&&(a.description=n.description),(n==null?void 0:n.readme)!==void 0&&(a.readme=n.readme),(n==null?void 0:n.tags)!==void 0&&(a.tags=n.tags),(n==null?void 0:n.isPublic)!==void 0&&(a.is_public=n.isPublic),(n==null?void 0:n.isArchived)!==void 0&&(a.is_archived=n.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const i=await this.caller.call(ie(),`${this.apiUrl}/repos/${r}/${s}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ye(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r,s]=Dr(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("delete a prompt",n);return await(await this.caller.call(ie(),`${this.apiUrl}/repos/${n}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,n){const[r,s,a]=Dr(e),i=await this.caller.call(ie(),`${this.apiUrl}/commits/${r}/${s}/${a}${n!=null&&n.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ye(i,"pull prompt commit");const o=await i.json();return{owner:r,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,n){const r=await this.pullPromptCommit(e,{includeModel:n==null?void 0:n.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,n){return await this.promptExists(e)?n&&Object.keys(n).some(s=>s!=="object")&&await this.updatePrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}):await this.createPrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}),n!=null&&n.object?await this.createCommit(e,n==null?void 0:n.object,{parentCommitHash:n==null?void 0:n.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,n={}){const{sourceApiUrl:r=this.apiUrl,datasetName:s}=n,[a,i]=this.parseTokenOrUrl(e,r),o=new Ui({apiUrl:a,apiKey:"placeholder"}),u=await o.readSharedDataset(i),c=s||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(i),d=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(m=>m.inputs),outputs:l.flatMap(m=>m.outputs?[m.outputs]:[]),datasetId:d.id})}catch(m){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),m}}parseTokenOrUrl(e,n,r=2,s="dataset"){try{return Se(e),[n,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){const o=i[i.length-r];return[n,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}}const dy="0.3.3";let gr;const rN=()=>typeof window<"u"&&typeof window.document<"u",sN=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",aN=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),hy=()=>typeof Deno<"u",iN=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!hy(),oN=()=>gr||(rN()?gr="browser":iN()?gr="node":sN()?gr="webworker":aN()?gr="jsdom":hy()?gr="deno":gr="other",gr);let Wl;function fy(){if(Wl===void 0){const t=oN(),e=lN();Wl={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:dy,...e}}return Wl}function uN(){const t=cN()||{},e={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(t))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof s=="string"&&!n.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function cN(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((t,[e,n])=>(t[e]=String(n),t),{}):void 0}catch{return}}function hs(t){var e;try{return typeof process<"u"?(e=process.env)==null?void 0:e[t]:void 0}catch{return}}function Hr(t){return hs(`LANGSMITH_${t}`)||hs(`LANGCHAIN_${t}`)}let Gl;function lN(){if(Gl!==void 0)return Gl;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const n of t){const r=hs(n);r!==void 0&&(e[n]=r)}return Gl=e,e}const dN=t=>!!["TRACING_V2","TRACING"].find(n=>Hr(n)==="true"),Kl=Symbol.for("lc:context_variables");function hN(t){return t.replace(/[-:.]/g,"")}function fN(t,e,n=1){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return hN(`${new Date(t).toISOString().slice(0,-1)}${r}Z`)+e}class zu{constructor(e,n){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=n}static fromHeader(e){const n=e.split(",");let r={},s=[];for(const a of n){const[i,o]=a.split("="),u=decodeURIComponent(o);i==="langsmith-metadata"?r=JSON.parse(u):i==="langsmith-tags"&&(s=u.split(","))}return new zu(r,s)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class on{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),my(e)){Object.assign(this,{...e});return}const n=on.getDefaultConfig(),{metadata:r,...s}=e,a=s.client??on.getSharedClient(),i={...r,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:i},Object.assign(this,{...n,...s,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const u=fN(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+u:this.dotted_order=u}}static getDefaultConfig(){return{id:Jt(),run_type:"chain",project_name:Hr("PROJECT")??hs("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:hs("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:hs("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return on.sharedClient||(on.sharedClient=new Ui),on.sharedClient}createChild(e){var u,c,l,d,m,p;const n=this.child_execution_order+1,r=new on({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:n,child_execution_order:n});Kl in this&&(r[Kl]=this[Kl]);const s=Symbol.for("lc:child_config"),a=((u=e.extra)==null?void 0:u[s])??this.extra[s];if(pN(a)){const f={...a},g=mN(f.callbacks)?(l=(c=f.callbacks).copy)==null?void 0:l.call(c):void 0;g&&(Object.assign(g,{_parentRunId:r.id}),(p=(m=(d=g.handlers)==null?void 0:d.find(py))==null?void 0:m.updateFromRunTree)==null||p.call(m,r),f.callbacks=g),r.extra[s]=f}const i=new Set;let o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,n),o=o.parent_run;return this.child_runs.push(r),r}async end(e,n,r=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??n,this.end_time=this.end_time??r,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,n,r=!0){var u;const s=e.extra??{};if(s.runtime||(s.runtime={}),n)for(const[c,l]of Object.entries(n))s.runtime[c]||(s.runtime[c]=l);let a,i;return r?(i=(u=e.parent_run)==null?void 0:u.id,a=[]):(a=e.child_runs.map(c=>this._convertToCreate(c,n,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const n=fy(),r=await this._convertToCreate(this,n,!0);if(await this.client.createRun(r),!e){ry("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const s of this.child_runs)await s.postRun(!1)}}catch(n){console.error(`Error in postRun for run ${this.id}:`,n)}}async patchRun(){var e;try{const n={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:(e=this.parent_run)==null?void 0:e.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,n)}catch(n){console.error(`Error in patchRun for run ${this.id}`,n)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,n){var c,l,d,m;const r=e==null?void 0:e.callbacks;let s,a,i,o=dN();if(r){const p=((c=r==null?void 0:r.getParentRunId)==null?void 0:c.call(r))??"",f=(l=r==null?void 0:r.handlers)==null?void 0:l.find(g=>(g==null?void 0:g.name)=="langchain_tracer");s=(d=f==null?void 0:f.getRun)==null?void 0:d.call(f,p),a=f==null?void 0:f.projectName,i=f==null?void 0:f.client,o=o||!!f}return s?new on({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:i,tracingEnabled:o,project_name:a,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(m=s==null?void 0:s.extra)==null?void 0:m.metadata,...e==null?void 0:e.metadata}}}).createChild(n):new on({...n,client:i,tracingEnabled:o,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,n){var c;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=r["langsmith-trace"];if(!s||typeof s!="string")return;const a=s.trim(),i=a.split(".").map(l=>{const[d,m]=l.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:m}}),o=i[0].uuid,u={...n,name:(n==null?void 0:n.name)??"parent",run_type:(n==null?void 0:n.run_type)??"chain",start_time:(n==null?void 0:n.start_time)??Date.now(),id:(c=i.at(-1))==null?void 0:c.uuid,trace_id:o,dotted_order:a};if(r.baggage&&typeof r.baggage=="string"){const l=zu.fromHeader(r.baggage);u.metadata=l.metadata,u.tags=l.tags}return new on(u)}toHeaders(e){var r;const n={"langsmith-trace":this.dotted_order,baggage:new zu((r=this.extra)==null?void 0:r.metadata,this.tags).toHeader()};if(e)for(const[s,a]of Object.entries(n))e.set(s,a);return n}}Object.defineProperty(on,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function my(t){return t!==void 0&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function py(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function rg(t){return Array.isArray(t)&&t.some(e=>py(e))}function mN(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function pN(t){var e;return t!==void 0&&typeof t.callbacks=="object"&&(rg((e=t.callbacks)==null?void 0:e.handlers)||rg(t.callbacks))}let gN=class{getStore(){}run(e,n){return n()}};const Yl=Symbol.for("ls:tracing_async_local_storage"),bN=new gN;let _N=class{getInstance(){return globalThis[Yl]??bN}initializeGlobalInstance(e){globalThis[Yl]===void 0&&(globalThis[Yl]=e)}};const yN=new _N,EN=()=>{const t=yN.getInstance().getStore();if(!my(t))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function and that tracing is enabled."].join(`
`));return t};function Af(t){return typeof t=="function"&&"langsmith:traceable"in t}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const wN=Object.prototype.hasOwnProperty;function rh(t,e){return wN.call(t,e)}function sh(t){if(Array.isArray(t)){const n=new Array(t.length);for(let r=0;r<n.length;r++)n[r]=""+r;return n}if(Object.keys)return Object.keys(t);let e=[];for(let n in t)rh(t,n)&&e.push(n);return e}function ur(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function ah(t){let e=0;const n=t.length;let r;for(;e<n;){if(r=t.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Ds(t){return t.indexOf("/")===-1&&t.indexOf("~")===-1?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}function TN(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function ih(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let n=0,r=t.length;n<r;n++)if(ih(t[n]))return!0}else if(typeof t=="object"){const n=sh(t),r=n.length;for(var e=0;e<r;e++)if(ih(t[n[e]]))return!0}}return!1}function sg(t,e){const n=[t];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&n.push(`${r}: ${s}`)}return n.join(`
`)}class SN extends Error{constructor(e,n,r,s,a){super(sg(e,{name:n,index:r,operation:s,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=sg(e,{name:n,index:r,operation:s,tree:a})}}const ht=SN,Ys={add:function(t,e,n){return t[e]=this.value,{newDocument:n}},remove:function(t,e,n){var r=t[e];return delete t[e],{newDocument:n,removed:r}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:function(t,e,n){let r=oh(n,this.path);r&&(r=ur(r));const s=di(n,{op:"remove",path:this.from}).removed;return di(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(t,e,n){const r=oh(n,this.from);return di(n,{op:"add",path:this.path,value:ur(r)}),{newDocument:n}},test:function(t,e,n){return{newDocument:n,test:Gu(t[e],this.value)}},_get:function(t,e,n){return this.value=t[e],{newDocument:n}}};var AN={add:function(t,e,n){return ah(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:n,index:e}},remove:function(t,e,n){var r=t.splice(e,1);return{newDocument:n,removed:r[0]}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:Ys.move,copy:Ys.copy,test:Ys.test,_get:Ys._get};function oh(t,e){if(e=="")return t;var n={op:"_get",path:e};return di(t,n),n.value}function di(t,e,n=!1,r=!0,s=!0,a=0){if(n&&(typeof n=="function"?n(e,0,t,e.path):uh(e,0)),e.path===""){let i={newDocument:t};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=t,i;if(e.op==="move"||e.op==="copy")return i.newDocument=oh(t,e.from),e.op==="move"&&(i.removed=t),i;if(e.op==="test"){if(i.test=Gu(t,e.value),i.test===!1)throw new ht("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return i.newDocument=t,i}else{if(e.op==="remove")return i.removed=t,i.newDocument=null,i;if(e.op==="_get")return e.value=t,i;if(n)throw new ht("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,t);return i}}else{r||(t=ur(t));const o=(e.path||"").split("/");let u=t,c=1,l=o.length,d,m,p;for(typeof n=="function"?p=n:p=uh;;){if(m=o[c],m&&m.indexOf("~")!=-1&&(m=TN(m)),s&&(m=="__proto__"||m=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&d===void 0&&(u[m]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&p(e,0,t,d)),c++,Array.isArray(u)){if(m==="-")m=u.length;else{if(n&&!ah(m))throw new ht("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,t);ah(m)&&(m=~~m)}if(c>=l){if(n&&e.op==="add"&&m>u.length)throw new ht("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,t);const f=AN[e.op].call(e,u,m,t);if(f.test===!1)throw new ht("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return f}}else if(c>=l){const f=Ys[e.op].call(e,u,m,t);if(f.test===!1)throw new ht("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return f}if(u=u[m],n&&c<l&&(!u||typeof u!="object"))throw new ht("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,t)}}}function Wu(t,e,n,r=!0,s=!0){if(n&&!Array.isArray(e))throw new ht("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(t=ur(t));const a=new Array(e.length);for(let i=0,o=e.length;i<o;i++)a[i]=di(t,e[i],n,!0,s,i),t=a[i].newDocument;return a.newDocument=t,a}function uh(t,e,n,r){if(typeof t!="object"||t===null||Array.isArray(t))throw new ht("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,n);if(Ys[t.op]){if(typeof t.path!="string")throw new ht("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,n);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new ht('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,n);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new ht("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new ht("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&ih(t.value))throw new ht("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,n);if(n){if(t.op=="add"){var s=t.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new ht("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,n)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==r)throw new ht("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,n)}else if(t.op==="move"||t.op==="copy"){var i={op:"_get",path:t.from,value:void 0},o=CN([i],n);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ht("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,n)}}}else throw new ht("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,n)}function CN(t,e,n){try{if(!Array.isArray(t))throw new ht("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Wu(ur(e),ur(t),n||!0);else{n=n||uh;for(var r=0;r<t.length;r++)n(t[r],r,e,void 0)}}catch(s){if(s instanceof ht)return s;throw s}}function Gu(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var n=Array.isArray(t),r=Array.isArray(e),s,a,i;if(n&&r){if(a=t.length,a!=e.length)return!1;for(s=a;s--!==0;)if(!Gu(t[s],e[s]))return!1;return!0}if(n!=r)return!1;var o=Object.keys(t);if(a=o.length,a!==Object.keys(e).length)return!1;for(s=a;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=a;s--!==0;)if(i=o[s],!Gu(t[i],e[i]))return!1;return!0}return t!==t&&e!==e}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function gy(t,e,n,r,s){if(e!==t){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=sh(e),i=sh(t),o=!1,u=i.length-1;u>=0;u--){var c=i[u],l=t[c];if(rh(e,c)&&!(e[c]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?gy(l,d,n,r+"/"+Ds(c),s):l!==d&&(s&&n.push({op:"test",path:r+"/"+Ds(c),value:ur(l)}),n.push({op:"replace",path:r+"/"+Ds(c),value:ur(d)}))}else Array.isArray(t)===Array.isArray(e)?(s&&n.push({op:"test",path:r+"/"+Ds(c),value:ur(l)}),n.push({op:"remove",path:r+"/"+Ds(c)}),o=!0):(s&&n.push({op:"test",path:r,value:t}),n.push({op:"replace",path:r,value:e}))}if(!(!o&&a.length==i.length))for(var u=0;u<a.length;u++){var c=a[u];!rh(t,c)&&e[c]!==void 0&&n.push({op:"add",path:r+"/"+Ds(c),value:ur(e[c])})}}}function ON(t,e,n=!1){var r=[];return gy(t,e,r,"",n),r}const vN=()=>typeof window<"u"&&typeof window.document<"u",IN=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",kN=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Cf=()=>typeof Deno<"u",NN=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Cf(),RN=()=>{let t;return vN()?t="browser":NN()?t="node":IN()?t="webworker":kN()?t="jsdom":Cf()?t="deno":t="other",t};let Zl;async function PN(){return Zl===void 0&&(Zl={library:"langchain-js",runtime:RN()}),Zl}function fn(t){var e;try{return typeof process<"u"?(e=process.env)==null?void 0:e[t]:Cf()?Deno==null?void 0:Deno.env.get(t):void 0}catch{return}}class xN{}function LN(t){return"lc_prefer_streaming"in t&&t.lc_prefer_streaming}class oo extends xN{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,D_(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:fn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Vr.prototype.toJSON.call(this)}toJSONNotImplemented(){return Vr.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class n extends oo{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Jt()}),Object.assign(this,e)}}return new n}}const DN=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function Jl(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function MN(t){return t.replace(/[-:.]/g,"")}function BN(t,e,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return MN(`${new Date(t).toISOString().slice(0,-1)}${r}Z`)+e}function Va(t){return typeof t._addRunToRunMap=="function"}class uo extends oo{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,n){e.child_runs.push(n)}_addRunToRunMap(e){const n=BN(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){const s=this.runMap.get(r.parent_run_id);s&&(this._addChildRun(s,r),s.child_execution_order=Math.max(s.child_execution_order,r.child_execution_order),r.trace_id=s.trace_id,s.dotted_order!==void 0&&(r.dotted_order=[s.dotted_order,n].join(".")))}else r.trace_id=r.id,r.dotted_order=n;return this.runMap.set(r.id,r),r}async _endTrace(e){var r;const n=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);n?n.child_execution_order=Math.max(n.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const n=e!==void 0&&this.runMap.get(e);return n?n.child_execution_order+1:1}_createRunForLLMStart(e,n,r,s,a,i,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,m={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:n},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(m)}async handleLLMStart(e,n,r,s,a,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForLLMStart(e,n,r,s,a,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}_createRunForChatModelStart(e,n,r,s,a,i,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,m={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:n},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(m)}async handleChatModelStart(e,n,r,s,a,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForChatModelStart(e,n,r,s,a,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}async handleLLMEnd(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleLLMError(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForChainStart(e,n,r,s,a,i,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:n,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(d)}async handleChainStart(e,n,r,s,a,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForChainStart(e,n,r,s,a,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onChainStart)==null?void 0:d.call(this,c)),c}async handleChainEnd(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Jl(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Jl(a.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Jl(a.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,n,r,s,a,i,o){const u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:n},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleToolStart(e,n,r,s,a,i,o){var c,l;const u=this.runMap.get(r)??this._createRunForToolStart(e,n,r,s,a,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,u)),await((l=this.onToolStart)==null?void 0:l.call(this,u)),u}async handleToolEnd(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,n){var a;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,r))}async handleAgentEnd(e,n){var s;const r=this.runMap.get(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}_createRunForRetrieverStart(e,n,r,s,a,i,o){const u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:n},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,n,r,s,a,i,o){var c,l;const u=this.runMap.get(r)??this._createRunForRetrieverStart(e,n,r,s,a,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,u)),await((l=this.onRetrieverStart)==null?void 0:l.call(this,u)),u}async handleRetrieverEnd(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,n){var s;const r=this.runMap.get(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,n,r,s,a,i){var u;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:n,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}}var Of={exports:{}};Of.exports;(function(t){const n=(a=0)=>i=>`\x1B[${38+a};5;${i}m`,r=(a=0)=>(i,o,u)=>`\x1B[${38+a};2;${i};${o};${u}m`;function s(){const a=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,u]of Object.entries(i)){for(const[c,l]of Object.entries(u))i[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=i[c],a.set(l[0],l[1]);Object.defineProperty(i,o,{value:u,enumerable:!1})}return Object.defineProperty(i,"codes",{value:a,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=n(),i.color.ansi16m=r(),i.bgColor.ansi256=n(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(t,"exports",{enumerable:!0,get:s})})(Of);var FN=Of.exports;const by=to(FN);function Ft(t,e){return`${t.open}${e}${t.close}`}function yn(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function ag(t){return typeof t=="string"?t.trim():t==null?t:yn(t,t.toString())}function Mr(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:Wt}=by;class ig extends uo{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const n=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)n.push(s),r=s;else break}return n}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,a,i)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return a===i.length-1?Ft(by.bold,o):o}).join(" > ");return Ft(Wt.grey,r)}onChainStart(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.green,"[chain/start]")} [${n}] Entering Chain run with input: ${yn(e.inputs,"[inputs]")}`)}onChainEnd(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.cyan,"[chain/end]")} [${n}] [${Mr(e)}] Exiting Chain run with output: ${yn(e.outputs,"[outputs]")}`)}onChainError(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.red,"[chain/error]")} [${n}] [${Mr(e)}] Chain run errored with error: ${yn(e.error,"[error]")}`)}onLLMStart(e){const n=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${Ft(Wt.green,"[llm/start]")} [${n}] Entering LLM run with input: ${yn(r,"[inputs]")}`)}onLLMEnd(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.cyan,"[llm/end]")} [${n}] [${Mr(e)}] Exiting LLM run with output: ${yn(e.outputs,"[response]")}`)}onLLMError(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.red,"[llm/error]")} [${n}] [${Mr(e)}] LLM run errored with error: ${yn(e.error,"[error]")}`)}onToolStart(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.green,"[tool/start]")} [${n}] Entering Tool run with input: "${ag(e.inputs.input)}"`)}onToolEnd(e){var r;const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.cyan,"[tool/end]")} [${n}] [${Mr(e)}] Exiting Tool run with output: "${ag((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.red,"[tool/error]")} [${n}] [${Mr(e)}] Tool run errored with error: ${yn(e.error,"[error]")}`)}onRetrieverStart(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.green,"[retriever/start]")} [${n}] Entering Retriever run with input: ${yn(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.cyan,"[retriever/end]")} [${n}] [${Mr(e)}] Exiting Retriever run with output: ${yn(e.outputs,"[outputs]")}`)}onRetrieverError(e){const n=this.getBreadcrumbs(e);console.log(`${Ft(Wt.red,"[retriever/error]")} [${n}] [${Mr(e)}] Retriever run errored with error: ${yn(e.error,"[error]")}`)}onAgentAction(e){const n=e,r=this.getBreadcrumbs(e);console.log(`${Ft(Wt.blue,"[agent/action]")} [${r}] Agent selected action: ${yn(n.actions[n.actions.length-1],"[action]")}`)}}let Xl;const UN=()=>{if(Xl===void 0){const t=fn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Xl=new Ui(t)}return Xl};class hi extends uo{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:n,projectName:r,client:s}=e;this.projectName=r??fn("LANGCHAIN_PROJECT")??fn("LANGCHAIN_SESSION"),this.exampleId=n,this.client=s??UN();const a=hi.getTraceableRunTree();a&&this.updateFromRunTree(a)}async _convertToCreate(e,n=void 0){return{...e,extra:{...e.extra,runtime:await PN()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:n}}async persistRun(e){}async onRunCreate(e){const n=await this._convertToCreate(e,this.exampleId);await this.client.createRun(n)}async onRunUpdate(e){const n={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id,extra:e.extra};await this.client.updateRun(e.id,n)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let n=e;const r=new Set;for(;n.parent_run&&!(r.has(n.id)||(r.add(n.id),!n.parent_run));)n=n.parent_run;r.clear();const s=[n];for(;s.length>0;){const a=s.shift();!a||r.has(a.id)||(r.add(a.id),this.runMap.set(a.id,a),a.child_runs&&s.push(...a.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const n={},r=[];for(const[s,a]of this.runMap){const i=new on({...a,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});n[s]=i,r.push([s,a.dotted_order])}r.sort((s,a)=>!s[1]||!a[1]?0:s[1].localeCompare(a[1]));for(const[s]of r){const a=this.runMap.get(s),i=n[s];if(!(!a||!i)&&a.parent_run_id){const o=n[a.parent_run_id];o&&(o.child_runs.push(i),i.parent_run=o)}}return n[e]}static getTraceableRunTree(){try{return EN()}catch{return}}}const _y=Symbol.for("ls:tracing_async_local_storage"),gu=Symbol.for("lc:context_variables"),jN=t=>{globalThis[_y]=t},ji=()=>globalThis[_y];let fi;function HN(){const t="default"in vr?vr.default:vr;return new t({autoStart:!0,concurrency:1})}function $N(){return typeof fi>"u"&&(fi=HN()),fi}async function pt(t,e){if(e===!0){const n=ji();n!==void 0?await n.run(void 0,async()=>t()):await t()}else fi=$N(),fi.add(async()=>{const n=ji();n!==void 0?await n.run(void 0,async()=>t()):await t()})}const qN=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(n=>fn(n)==="true");function yy(t){var r;const e=ji();if(e===void 0)return;const n=e.getStore();return(r=n==null?void 0:n[gu])==null?void 0:r[t]}const VN=Symbol("lc:configure_hooks"),zN=()=>yy(VN)||[];function Ey(t){return t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{}}class WN{setHandler(e){return this.setHandlers([e])}}class Vc{constructor(e,n,r,s,a,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(n=>pt(async()=>{var r;try{await((r=n.handleText)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleText: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleCustomEvent(e,n,r,s,a){await Promise.all(this.handlers.map(i=>pt(async()=>{var o;try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,n,this.runId,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}}class GN extends Vc{getChild(e){const n=new Lt(this.runId);return n.setHandlers(this.inheritableHandlers),n.addTags(this.inheritableTags),n.addMetadata(this.inheritableMetadata),e&&n.addTags([e],!1),n}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(n=>pt(async()=>{var r;if(!n.ignoreRetriever)try{await((r=n.handleRetrieverEnd)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetriever`),n.raiseError)throw s}},n.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(n=>pt(async()=>{var r;if(!n.ignoreRetriever)try{await((r=n.handleRetrieverError)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetrieverError: ${s}`),n.raiseError)throw e}},n.awaitHandlers)))}}class og extends Vc{async handleLLMNewToken(e,n,r,s,a,i){await Promise.all(this.handlers.map(o=>pt(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,n??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`),o.raiseError)throw c}},o.awaitHandlers)))}async handleLLMError(e,n,r,s,a){await Promise.all(this.handlers.map(i=>pt(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleLLMEnd(e,n,r,s,a){await Promise.all(this.handlers.map(i=>pt(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}}class KN extends Vc{getChild(e){const n=new Lt(this.runId);return n.setHandlers(this.inheritableHandlers),n.addTags(this.inheritableTags),n.addMetadata(this.inheritableMetadata),e&&n.addTags([e],!1),n}async handleChainError(e,n,r,s,a){await Promise.all(this.handlers.map(i=>pt(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleChainEnd(e,n,r,s,a){await Promise.all(this.handlers.map(i=>pt(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(n=>pt(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleAgentAction)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleAgentAction: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(n=>pt(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleAgentEnd)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleAgentEnd: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}}class YN extends Vc{getChild(e){const n=new Lt(this.runId);return n.setHandlers(this.inheritableHandlers),n.addTags(this.inheritableTags),n.addMetadata(this.inheritableMetadata),e&&n.addTags([e],!1),n}async handleToolError(e){await Promise.all(this.handlers.map(n=>pt(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleToolError)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolError: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(n=>pt(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleToolEnd)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolEnd: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}}class Lt extends WN{constructor(e,n){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(n==null?void 0:n.handlers)??this.handlers,this.inheritableHandlers=(n==null?void 0:n.inheritableHandlers)??this.inheritableHandlers,this.tags=(n==null?void 0:n.tags)??this.tags,this.inheritableTags=(n==null?void 0:n.inheritableTags)??this.inheritableTags,this.metadata=(n==null?void 0:n.metadata)??this.metadata,this.inheritableMetadata=(n==null?void 0:n.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(n.map(async(c,l)=>{const d=l===0&&r?r:Jt();return await Promise.all(this.handlers.map(m=>{if(!m.ignoreLLM)return Va(m)&&m._createRunForLLMStart(e,[c],d,this._parentRunId,a,this.tags,this.metadata,u),pt(async()=>{var p;try{await((p=m.handleLLMStart)==null?void 0:p.call(m,e,[c],d,this._parentRunId,a,this.tags,this.metadata,u))}catch(f){if((m.raiseError?console.error:console.warn)(`Error in handler ${m.constructor.name}, handleLLMStart: ${f}`),m.raiseError)throw f}},m.awaitHandlers)})),new og(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(n.map(async(c,l)=>{const d=l===0&&r?r:Jt();return await Promise.all(this.handlers.map(m=>{if(!m.ignoreLLM)return Va(m)&&m._createRunForChatModelStart(e,[c],d,this._parentRunId,a,this.tags,this.metadata,u),pt(async()=>{var p,f;try{if(m.handleChatModelStart)await((p=m.handleChatModelStart)==null?void 0:p.call(m,e,[c],d,this._parentRunId,a,this.tags,this.metadata,u));else if(m.handleLLMStart){const g=F_(c);await((f=m.handleLLMStart)==null?void 0:f.call(m,e,[g],d,this._parentRunId,a,this.tags,this.metadata,u))}}catch(g){if((m.raiseError?console.error:console.warn)(`Error in handler ${m.constructor.name}, handleLLMStart: ${g}`),m.raiseError)throw g}},m.awaitHandlers)})),new og(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,n,r=Jt(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return Va(u)&&u._createRunForChainStart(e,n,r,this._parentRunId,this.tags,this.metadata,s,o),pt(async()=>{var c;try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,n,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new KN(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,n,r=Jt(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return Va(u)&&u._createRunForToolStart(e,n,r,this._parentRunId,this.tags,this.metadata,o),pt(async()=>{var c;try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new YN(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,n,r=Jt(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return Va(u)&&u._createRunForRetrieverStart(e,n,r,this._parentRunId,this.tags,this.metadata,o),pt(async()=>{var c;try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new GN(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,n,r,s,a){await Promise.all(this.handlers.map(i=>pt(async()=>{var o;if(!i.ignoreCustomEvent)try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,n,r,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}addHandler(e,n=!0){this.handlers.push(e),n&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(n=>n!==e),this.inheritableHandlers=this.inheritableHandlers.filter(n=>n!==e)}setHandlers(e,n=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,n)}addTags(e,n=!0){this.removeTags(e),this.tags.push(...e),n&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(n=>!e.includes(n)),this.inheritableTags=this.inheritableTags.filter(n=>!e.includes(n))}addMetadata(e,n=!0){this.metadata={...this.metadata,...e},n&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const n of Object.keys(e))delete this.metadata[n],delete this.inheritableMetadata[n]}copy(e=[],n=!0){const r=new Lt(this._parentRunId);for(const s of this.handlers){const a=this.inheritableHandlers.includes(s);r.addHandler(s,a)}for(const s of this.tags){const a=this.inheritableTags.includes(s);r.addTags([s],a)}for(const s of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(s);r.addMetadata({[s]:this.metadata[s]},a)}for(const s of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===s.name)||r.addHandler(s,n);return r}static fromHandlers(e){class n extends oo{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Jt()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new n),r}static configure(e,n,r,s,a,i,o){return this._configureSync(e,n,r,s,a,i,o)}static _configureSync(e,n,r,s,a,i,o){var m,p;let u;(e||n)&&(Array.isArray(e)||!e?(u=new Lt,u.setHandlers((e==null?void 0:e.map(Ku))??[],!0)):u=e,u=u.copy(Array.isArray(n)?n.map(Ku):n==null?void 0:n.handlers,!1));const c=fn("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=((m=hi.getTraceableRunTree())==null?void 0:m.tracingEnabled)||qN(),d=l||(fn("LANGCHAIN_TRACING")??!1);if(c||d){if(u||(u=new Lt),c&&!u.handlers.some(f=>f.name===ig.prototype.name)){const f=new ig;u.addHandler(f,!0)}if(d&&!u.handlers.some(f=>f.name==="langchain_tracer")&&l){const f=new hi;u.addHandler(f,!0),u._parentRunId=((p=hi.getTraceableRunTree())==null?void 0:p.id)??u._parentRunId}}for(const{contextVar:f,inheritable:g=!0,handlerClass:b,envVar:_}of zN()){const y=_&&fn(_)==="true"&&b;let S;const I=f!==void 0?yy(f):void 0;I&&DN(I)?S=I:y&&(S=new b({})),S!==void 0&&(u||(u=new Lt),u.handlers.some(A=>A.name===S.name)||u.addHandler(S,g))}return(r||s)&&u&&(u.addTags(r??[]),u.addTags(s??[],!1)),(a||i)&&u&&(u.addMetadata(a??{}),u.addMetadata(i??{},!1)),u}}function Ku(t){return"name"in t?t:oo.fromMethods(t)}class ZN{getStore(){}run(e,n){return n()}enterWith(e){}}const JN=new ZN,ug=Symbol.for("lc:child_config");class XN{getInstance(){return ji()??JN}getRunnableConfig(){var n,r;return(r=(n=this.getInstance().getStore())==null?void 0:n.extra)==null?void 0:r[ug]}runWithConfig(e,n,r){var l;const s=Lt._configureSync(e==null?void 0:e.callbacks,void 0,e==null?void 0:e.tags,void 0,e==null?void 0:e.metadata),a=this.getInstance(),i=a.getStore(),o=s==null?void 0:s.getParentRunId(),u=(l=s==null?void 0:s.handlers)==null?void 0:l.find(d=>(d==null?void 0:d.name)==="langchain_tracer");let c;return u&&o?c=u.convertToRunTree(o):r||(c=new on({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[ug]:e}),i!==void 0&&i[gu]!==void 0&&(c[gu]=i[gu]),a.run(c,n)}initializeGlobalInstance(e){ji()===void 0&&jN(e)}}const Yr=new XN,Ql=25;async function Hn(t){return Lt._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata)}function cg(...t){const e={};for(const n of t.filter(r=>!!r))for(const r of Object.keys(n))if(r==="metadata")e[r]={...e[r],...n[r]};else if(r==="tags"){const s=e[r]??[];e[r]=[...new Set(s.concat(n[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...n[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=n.timeout:n.timeout!==void 0&&(e.timeout=Math.min(e.timeout,n.timeout));else if(r==="signal")e.signal===void 0?e.signal=n.signal:n.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,n.signal]):e.signal=n.signal);else if(r==="callbacks"){const s=e.callbacks,a=n.callbacks;if(Array.isArray(a))if(!s)e.callbacks=a;else if(Array.isArray(s))e.callbacks=s.concat(a);else{const i=s.copy();for(const o of a)i.addHandler(Ku(o),!0);e.callbacks=i}else if(a)if(!s)e.callbacks=a;else if(Array.isArray(s)){const i=a.copy();for(const o of s)i.addHandler(Ku(o),!0);e.callbacks=i}else e.callbacks=new Lt(a._parentRunId,{handlers:s.handlers.concat(a.handlers),inheritableHandlers:s.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(a.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(a.inheritableTags))),metadata:{...s.metadata,...a.metadata}})}else{const s=r;e[s]=n[s]??e[s]}return e}const QN=new Set(["string","number","boolean"]);function Ue(t){var r;const e=Yr.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:a,...i}=e;n=Object.entries(i).reduce((o,[u,c])=>(c!==void 0&&(o[u]=c),o),n)}if(t&&(n=Object.entries(t).reduce((s,[a,i])=>(i!==void 0&&(s[a]=i),s),n)),n!=null&&n.configurable)for(const s of Object.keys(n.configurable))QN.has(typeof n.configurable[s])&&!((r=n.metadata)!=null&&r[s])&&(n.metadata||(n.metadata={}),n.metadata[s]=n.configurable[s]);if(n.timeout!==void 0){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(n.timeout);n.signal!==void 0?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,s])):n.signal=s,delete n.timeout}return n}function Pt(t={},{callbacks:e,maxConcurrency:n,recursionLimit:r,runName:s,configurable:a,runId:i}={}){const o=Ue(t);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),n!==void 0&&(o.maxConcurrency=n),s!==void 0&&(o.runName=s),a!==void 0&&(o.configurable={...o.configurable,...a}),i!==void 0&&delete o.runId,o}function ca(t){return t?{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal}:void 0}async function Zr(t,e){if(e===void 0)return t;let n;return Promise.race([t.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,s)=>{n=()=>{s(new Error("Aborted"))},e.addEventListener("abort",n),e.aborted&&s(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",n))}class pn extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const n=e.getReader();return new pn({start(r){return s();function s(){return n.read().then(({done:a,value:i})=>{if(a){r.close();return}return r.enqueue(i),s()})}},cancel(){n.releaseLock()}})}static fromAsyncGenerator(e){return new pn({async pull(n){const{value:r,done:s}=await e.next();s&&n.close(),n.enqueue(r)},async cancel(n){await e.return(n)}})}}function wy(t,e=2){const n=Array.from({length:e},()=>[]);return n.map(async function*(s){for(;;)if(s.length===0){const a=await t.next();for(const i of n)i.push(a)}else{if(s[0].done)return;yield s.shift().value}})}function $n(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const n={...t};for(const[r,s]of Object.entries(e))r in n&&!Array.isArray(n[r])?n[r]=$n(n[r],s):n[r]=s;return n}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}class Sa{constructor(e){var n;Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??((n=this.config)==null?void 0:n.signal),this.setup=new Promise((r,s)=>{Yr.runWithConfig(ca(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(r,s):this.firstResult.then(a=>r(void 0),s)},!0)})}async next(...e){var n;return(n=this.signal)==null||n.throwIfAborted(),this.firstResultUsed?Yr.runWithConfig(ca(this.config),this.signal?async()=>Zr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function eR(t,e,n,r,...s){const a=new Sa({generator:e,startSetup:n,signal:r}),i=await a.setup;return{output:t(a,i,...s),setup:i}}class Ur{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const n=this.ops.concat(e.ops),r=Wu({},n);return new Hi({ops:n,state:r[r.length-1].newDocument})}}class Hi extends Ur{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const n=this.ops.concat(e.ops),r=Wu(this.state,e.ops);return new Hi({ops:n,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const n=Wu({},e.ops);return new Hi({ops:e.ops,state:n[n.length-1].newDocument})}}const tR=t=>t.name==="log_stream_tracer";async function lg(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=t;if(["retriever","llm","prompt"].includes(t.run_type))return n;if(!(Object.keys(n).length===1&&(n==null?void 0:n.input)===""))return n.input}async function dg(t,e){const{outputs:n}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?n:n!==void 0&&Object.keys(n).length===1&&(n==null?void 0:n.output)!==void 0?n.output:n}function nR(t){return t!==void 0&&t.message!==void 0}class hg extends uo{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=pn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||n.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,n){for await(const r of n){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new Ur({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Ur({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const n=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=n===1?e.name:`${e.name}:${n}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await lg(e,this._schemaFormat)),await this.writer.write(new Ur({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const n=this.keyMapByRunId[e.id];if(n===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${n}/inputs`,value:await lg(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${n}/final_output`,value:await dg(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${n}/end_time`,value:new Date(e.end_time).toISOString()});const s=new Ur({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const n=new Ur({ops:[{op:"replace",path:"/final_output",value:await dg(e,this._schemaFormat)}]});await this.writer.write(n),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,n,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const a=e.inputs.messages!==void 0;let i;a?nR(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new Zt({id:`run-${e.id}`,content:n}):i=n;const o=new Ur({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:n},{op:"add",path:`/logs/${s}/streamed_output/-`,value:i}]});await this.writer.write(o)}}const fg="__run";class la{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new la({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class ws extends la{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new ws({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function Zo({name:t,serialized:e}){return t!==void 0?t:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const rR=t=>t.name==="event_stream_tracer";class sR extends uo{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=pn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||n.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,n){const r=await n.next();if(r.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield r.value;return}function a(o,u){return o==="llm"&&typeof u=="string"?new la({text:u}):u}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(u=>{o=u}),this.tappedPromises.set(e,i);try{const u={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...u,data:{chunk:a(s.runType,r.value)}},s),yield r.value;for await(const c of n)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...u,data:{chunk:a(s.runType,c)}},s),yield c}finally{o()}}else{yield r.value;for await(const o of n)yield o}}async send(e,n){this._includeRun(n)&&await this.writer.write(e)}async sendEndEvent(e,n){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,n)}):await this.send(e,n)}async onLLMStart(e){var i,o;const n=Zo(e),r=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:n,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,s);const a=`on_${r}_start`;await this.send({event:a,data:{input:e.inputs},name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,n,r){const s=this.runInfoMap.get(e.id);let a,i;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")i="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?a=new Zt({content:n,id:`run-${e.id}`}):a=r.chunk.message;else if(s.runType==="llm")i="on_llm_stream",(r==null?void 0:r.chunk)===void 0?a=new la({text:n}):a=r.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:i,data:{chunk:a},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var i,o,u;const n=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(n===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(i=e.outputs)==null?void 0:i.generations;let a;if(n.runType==="chat_model"){for(const c of s??[]){if(a!==void 0)break;a=(o=c[0])==null?void 0:o.message}r="on_chat_model_end"}else if(n.runType==="llm")a={generations:s==null?void 0:s.map(c=>c.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:((u=e.outputs)==null?void 0:u.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${n.runType}`);await this.sendEndEvent({event:r,data:{output:a,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onChainStart(e){var i,o;const n=Zo(e),r=e.run_type??"chain",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:n,runType:e.run_type};let a={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(a={},s.inputs={}):e.inputs.input!==void 0?(a.input=e.inputs.input,s.inputs=e.inputs.input):(a.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${r}_start`,data:a,name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,s=e.inputs??n.inputs??{},i={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(i.input=s.input,n.inputs=s.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata??{}},n)}async onToolStart(e){var s,a;const n=Zo(e),r={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:n,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:n,run_id:e.id,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{}},r)}async onToolEnd(e){var s;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(n.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onRetrieverStart(e){var a,i;const n=Zo(e),s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:n,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:n,tags:e.tags??[],run_id:e.id,metadata:((i=e.extra)==null?void 0:i.metadata)??{}},s)}async onRetrieverEnd(e){var r;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async handleCustomEvent(e,n,r){const s=this.runInfoMap.get(r);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:s.tags,metadata:s.metadata,data:n},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const aR=[400,401,402,403,404,405,406,407,409],iR=t=>{var n,r;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||(t==null?void 0:t.code)==="ECONNABORTED")throw t;const e=((n=t==null?void 0:t.response)==null?void 0:n.status)??(t==null?void 0:t.status);if(e&&aR.includes(+e))throw t;if(((r=t==null?void 0:t.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(t==null?void 0:t.message);throw s.name="InsufficientQuotaError",s}};class vf{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??iR;const n="default"in vr?vr.default:vr;this.queue=new n({concurrency:this.maxConcurrency})}call(e,...n){return this.queue.add(()=>qu(()=>e(...n).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,n,...r){return e.signal?Promise.race([this.call(n,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(n,...r)}fetch(...e){return this.call(()=>fetch(...e).then(n=>n.ok?n:Promise.reject(n)))}}class Ty extends uo{constructor({config:e,onStart:n,onEnd:r,onError:s}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=n,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function If(t){return t?t.lc_runnable:!1}class oR{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,n){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const s=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(n)),this.includeTags!==void 0&&(r=r||s.some(a=>{var i;return(i=this.includeTags)==null?void 0:i.includes(a)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(n)),this.excludeTags!==void 0&&(r=r&&s.every(a=>{var i;return!((i=this.excludeTags)!=null&&i.includes(a))})),r}}const uR=Symbol("Let zodToJsonSchema decide on which parser to use"),cR={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},lR=t=>({...cR,...t}),dR=t=>{const e=lR(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function Sy(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function Ge(t,e,n,r,s){t[e]=n,Sy(t,e,r,s)}function hR(){return{}}function fR(t,e){var r,s,a;const n={type:"array"};return(r=t.type)!=null&&r._def&&((a=(s=t.type)==null?void 0:s._def)==null?void 0:a.typeName)!==$.ZodAny&&(n.items=$e(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&Ge(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&Ge(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(Ge(n,"minItems",t.exactLength.value,t.exactLength.message,e),Ge(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function mR(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?Ge(n,"minimum",r.value,r.message,e):Ge(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Ge(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Ge(n,"maximum",r.value,r.message,e):Ge(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Ge(n,"maximum",r.value,r.message,e));break;case"multipleOf":Ge(n,"multipleOf",r.value,r.message,e);break}return n}function pR(){return{type:"boolean"}}function Ay(t,e){return $e(t.type._def,e)}const gR=(t,e)=>$e(t.innerType._def,e);function Cy(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,a)=>Cy(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return bR(t,e)}}const bR=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":Ge(n,"minimum",r.value,r.message,e);break;case"max":Ge(n,"maximum",r.value,r.message,e);break}return n};function _R(t,e){return{...$e(t.innerType._def,e),default:t.defaultValue()}}function yR(t,e){return e.effectStrategy==="input"?$e(t.schema._def,e):{}}function ER(t){return{type:"string",enum:Array.from(t.values)}}const wR=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function TR(t,e){const n=[$e(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),$e(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(a=>{if(wR(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...u}=a;i=u}else r=void 0;s.push(i)}}),s.length?{allOf:s,...r}:void 0}function SR(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let ed;const kn={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(ed===void 0&&(ed=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ed),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Oy(t,e){const n={type:"string"};if(t.checks)for(const r of t.checks)switch(r.kind){case"min":Ge(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e);break;case"max":Ge(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Nn(n,"email",r.message,e);break;case"format:idn-email":Nn(n,"idn-email",r.message,e);break;case"pattern:zod":Ut(n,kn.email,r.message,e);break}break;case"url":Nn(n,"uri",r.message,e);break;case"uuid":Nn(n,"uuid",r.message,e);break;case"regex":Ut(n,r.regex,r.message,e);break;case"cuid":Ut(n,kn.cuid,r.message,e);break;case"cuid2":Ut(n,kn.cuid2,r.message,e);break;case"startsWith":Ut(n,RegExp(`^${td(r.value,e)}`),r.message,e);break;case"endsWith":Ut(n,RegExp(`${td(r.value,e)}$`),r.message,e);break;case"datetime":Nn(n,"date-time",r.message,e);break;case"date":Nn(n,"date",r.message,e);break;case"time":Nn(n,"time",r.message,e);break;case"duration":Nn(n,"duration",r.message,e);break;case"length":Ge(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e),Ge(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"includes":{Ut(n,RegExp(td(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&Nn(n,"ipv4",r.message,e),r.version!=="v4"&&Nn(n,"ipv6",r.message,e);break}case"base64url":Ut(n,kn.base64url,r.message,e);break;case"jwt":Ut(n,kn.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&Ut(n,kn.ipv4Cidr,r.message,e),r.version!=="v4"&&Ut(n,kn.ipv6Cidr,r.message,e);break}case"emoji":Ut(n,kn.emoji(),r.message,e);break;case"ulid":{Ut(n,kn.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Nn(n,"binary",r.message,e);break}case"contentEncoding:base64":{Ge(n,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{Ut(n,kn.base64,r.message,e);break}}break}case"nanoid":Ut(n,kn.nanoid,r.message,e)}return n}function td(t,e){return e.patternStrategy==="escape"?CR(t):t}const AR=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function CR(t){let e="";for(let n=0;n<t.length;n++)AR.has(t[n])||(e+="\\"),e+=t[n];return e}function Nn(t,e,n,r){var s;t.format||(s=t.anyOf)!=null&&s.some(a=>a.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Ge(t,"format",e,n,r)}function Ut(t,e,n,r){var s;t.pattern||(s=t.allOf)!=null&&s.some(a=>a.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:mg(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Ge(t,"pattern",mg(e,r),n,r)}function mg(t,e){var u;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},r=n.i?t.source.toLowerCase():t.source;let s="",a=!1,i=!1,o=!1;for(let c=0;c<r.length;c++){if(a){s+=r[c],a=!1;continue}if(n.i){if(i){if(r[c].match(/[a-z]/)){o?(s+=r[c],s+=`${r[c-2]}-${r[c]}`.toUpperCase(),o=!1):r[c+1]==="-"&&((u=r[c+2])!=null&&u.match(/[a-z]/))?(s+=r[c],o=!0):s+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){s+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(n.m){if(r[c]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){s+=`($|(?=[\r
]))`;continue}}if(n.s&&r[c]==="."){s+=i?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}s+=r[c],r[c]==="\\"?a=!0:i&&r[c]==="]"?i=!1:!i&&r[c]==="["&&(i=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s}function vy(t,e){var r,s,a,i,o,u;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===$.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((c,l)=>({...c,[l]:$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===$.ZodString&&((a=t.keyType._def.checks)!=null&&a.length)){const{type:c,...l}=Oy(t.keyType._def,e);return{...n,propertyNames:l}}else{if(((i=t.keyType)==null?void 0:i._def.typeName)===$.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};if(((o=t.keyType)==null?void 0:o._def.typeName)===$.ZodBranded&&t.keyType._def.type._def.typeName===$.ZodString&&((u=t.keyType._def.type._def.checks)!=null&&u.length)){const{type:c,...l}=Ay(t.keyType._def,e);return{...n,propertyNames:l}}}return n}function OR(t,e){if(e.mapStrategy==="record")return vy(t,e);const n=$e(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function vR(t){const e=t.values,r=Object.keys(t.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function IR(){return{not:{}}}function kR(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Yu={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function NR(t,e){if(e.target==="openApi3")return pg(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in Yu&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,a)=>{const i=Yu[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":if(a._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:n.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return pg(t,e)}const pg=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>$e(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function RR(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:Yu[t.innerType._def.typeName],nullable:!0}:{type:[Yu[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=$e(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=$e(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function PR(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",Sy(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?Ge(n,"minimum",r.value,r.message,e):Ge(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Ge(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Ge(n,"maximum",r.value,r.message,e):Ge(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Ge(n,"maximum",r.value,r.message,e));break;case"multipleOf":Ge(n,"multipleOf",r.value,r.message,e);break}return n}function xR(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":$e(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":$e(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function LR(t,e){const n=e.target==="openAi",r={type:"object",...Object.entries(t.shape()).reduce((s,[a,i])=>{if(i===void 0||i._def===void 0)return s;let o=i.isOptional();o&&n&&(i instanceof jn&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);const u=$e(i._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return u===void 0?s:{properties:{...s.properties,[a]:u},required:o?s.required:[...s.required,a]}},{properties:{},required:[]}),additionalProperties:xR(t,e)};return r.required.length||delete r.required,r}const DR=(t,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return $e(t.innerType._def,e);const n=$e(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},MR=(t,e)=>{if(e.pipeStrategy==="input")return $e(t.in._def,e);if(e.pipeStrategy==="output")return $e(t.out._def,e);const n=$e(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=$e(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function BR(t,e){return $e(t.type._def,e)}function FR(t,e){const r={type:"array",uniqueItems:!0,items:$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&Ge(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&Ge(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function UR(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>$e(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:$e(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>$e(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function jR(){return{not:{}}}function HR(){return{}}const $R=(t,e)=>$e(t.innerType._def,e);function $e(t,e,n=!1){var i;const r=e.seen.get(t);if(e.override){const o=(i=e.override)==null?void 0:i.call(e,t,e,r,n);if(o!==uR)return o}if(r&&!n){const o=qR(r,e);if(o!==void 0)return o}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const a=zR(t,t.typeName,e);return a&&WR(t,e,a),s.jsonSchema=a,a}const qR=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:VR(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((n,r)=>e.currentPath[r]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},VR=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")},zR=(t,e,n)=>{switch(e){case $.ZodString:return Oy(t,n);case $.ZodNumber:return PR(t,n);case $.ZodObject:return LR(t,n);case $.ZodBigInt:return mR(t,n);case $.ZodBoolean:return pR();case $.ZodDate:return Cy(t,n);case $.ZodUndefined:return jR();case $.ZodNull:return kR(n);case $.ZodArray:return fR(t,n);case $.ZodUnion:case $.ZodDiscriminatedUnion:return NR(t,n);case $.ZodIntersection:return TR(t,n);case $.ZodTuple:return UR(t,n);case $.ZodRecord:return vy(t,n);case $.ZodLiteral:return SR(t,n);case $.ZodEnum:return ER(t);case $.ZodNativeEnum:return vR(t);case $.ZodNullable:return RR(t,n);case $.ZodOptional:return DR(t,n);case $.ZodMap:return OR(t,n);case $.ZodSet:return FR(t,n);case $.ZodLazy:return $e(t.getter()._def,n);case $.ZodPromise:return BR(t,n);case $.ZodNaN:case $.ZodNever:return IR();case $.ZodEffects:return yR(t,n);case $.ZodAny:return hR();case $.ZodUnknown:return HR();case $.ZodDefault:return _R(t,n);case $.ZodBranded:return Ay(t,n);case $.ZodReadonly:return $R(t,n);case $.ZodCatch:return gR(t,n);case $.ZodPipeline:return MR(t,n);case $.ZodFunction:case $.ZodVoid:case $.ZodSymbol:return;default:return(r=>{})()}},WR=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),Ts=(t,e)=>{const n=dR(e),r=void 0,s=e==null?void 0:e.name,a=$e(t._def,n,!1)??{},i=s===void 0?r?{...a,[n.definitionPath]:r}:a:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...r,[s]:a}};return n.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(n.target==="jsonSchema2019-09"||n.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),n.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function nd(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const GR=["*","_","`"];function KR(t){let e="";for(const[n,r]of Object.entries(t))e+=`	classDef ${n} ${r};
`;return e}function YR(t,e,n){const{firstNode:r,lastNode:s,nodeColors:a,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=n;let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){const p="default",f={[p]:"{0}({1})"};r!==void 0&&(f[r]="{0}([{1}]):::first"),s!==void 0&&(f[s]="{0}([{1}]):::last");for(const[g,b]of Object.entries(t)){const _=b.name.split(":").pop()??"";let S=GR.some(A=>_.startsWith(A)&&_.endsWith(A))?`<p>${_}</p>`:_;Object.keys(b.metadata??{}).length&&(S+=`<hr/><small><em>${Object.entries(b.metadata??{}).map(([A,O])=>`${A} = ${O}`).join(`
`)}</em></small>`);const I=(f[g]??f[p]).replace("{0}",nd(g)).replace("{1}",S);c+=`	${I}
`}}const l={};for(const p of e){const f=p.source.split(":"),g=p.target.split(":"),b=f.filter((_,y)=>_===g[y]).join(":");l[b]||(l[b]=[]),l[b].push(p)}const d=new Set;function m(p,f){const g=p.length===1&&p[0].source===p[0].target;if(f&&!g){const b=f.split(":").pop();if(d.has(b))throw new Error(`Found duplicate subgraph '${b}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(b),c+=`	subgraph ${b}
`}for(const b of p){const{source:_,target:y,data:S,conditional:I}=b;let A="";if(S!==void 0){let O=S;const w=O.split(" ");w.length>u&&(O=Array.from({length:Math.ceil(w.length/u)},(L,D)=>w.slice(D*u,(D+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),A=I?` -. &nbsp;${O}&nbsp; .-> `:` -- &nbsp;${O}&nbsp; --> `}else A=I?" -.-> ":" --> ";c+=`	${nd(_)}${A}${nd(y)};
`}for(const b in l)b.startsWith(`${f}:`)&&b!==f&&m(l[b],b);f&&!g&&(c+=`	end
`)}m(l[""]??[],"");for(const p in l)!p.includes(":")&&p!==""&&m(l[p],p);return i&&(c+=KR(a??{})),c}async function ZR(t,e){let{backgroundColor:n="white"}=e;const r=btoa(t);n!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const s=`https://mermaid.ink/img/${r}?bgColor=${n}`,a=await fetch(s);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}function JR(t,e){if(t!==void 0&&!li(t))return t;if(If(e))try{let n=e.getName();return n=n.startsWith("Runnable")?n.slice(8):n,n}catch{return e.getName()}else return e.name??"UnknownSchema"}function XR(t){return If(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...Ts(t.data.schema),title:t.data.name}}}class zc{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((n,r)=>{e[n.id]=li(n.id)?r:n.id}),{nodes:Object.values(this.nodes).map(n=>({id:e[n.id],...XR(n)})),edges:this.edges.map(n=>{const r={source:e[n.source],target:e[n.target]};return typeof n.data<"u"&&(r.data=n.data),typeof n.conditional<"u"&&(r.conditional=n.conditional),r})}}addNode(e,n,r){if(n!==void 0&&this.nodes[n]!==void 0)throw new Error(`Node with id ${n} already exists`);const s=n??Jt(),a={id:s,data:e,name:JR(n,e),metadata:r};return this.nodes[s]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(n=>n.source!==e.id&&n.target!==e.id)}addEdge(e,n,r,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[n.id]===void 0)throw new Error(`Target node ${n.id} not in graph`);const a={source:e.id,target:n.id,data:r,conditional:s};return this.edges.push(a),a}firstNode(){return gg(this)}lastNode(){return bg(this)}extend(e,n=""){let r=n;Object.values(e.nodes).map(c=>c.id).every(li)&&(r="");const a=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[a(c)]={...l,id:a(c)}});const i=e.edges.map(c=>({...c,source:a(c.source),target:a(c.target)}));this.edges=[...this.edges,...i];const o=e.firstNode(),u=e.lastNode();return[o?{id:a(o.id),data:o.data}:void 0,u?{id:a(u.id),data:u.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&gg(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&bg(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),n=new Map;Object.values(e).forEach(s=>{n.set(s,(n.get(s)||0)+1)});const r=s=>{const a=e[s];return li(s)&&n.get(a)===1?a:s};return new zc({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,a])=>[r(s),{...a,id:r(s)}])),edges:this.edges.map(s=>({...s,source:r(s.source),target:r(s.target)}))})}drawMermaid(e){const{withStyles:n,curveStyle:r,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},i=this.reid(),o=i.firstNode(),u=i.lastNode();return YR(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:u==null?void 0:u.id,withStyles:n,curveStyle:r,nodeColors:s,wrapLabelNWords:a})}async drawMermaidPng(e){const n=this.drawMermaid(e);return ZR(n,{backgroundColor:e==null?void 0:e.backgroundColor})}}function gg(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function bg(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function QR(t){const e=new TextEncoder,n=new ReadableStream({async start(r){for await(const s of t)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return pn.fromReadableStream(n)}function _g(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const eP=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function ch(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*yg(t,e){for(;;){const{value:n,done:r}=Yr.runWithConfig(ca(t),e.next.bind(e),!0);if(r)break;yield n}}async function*lh(t,e){const n=e[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await Yr.runWithConfig(ca(t),n.next.bind(e),!0);if(s)break;yield r}}function At(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}class bt extends Vr{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const n=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${n}${e}`:n}bind(e){return new fs({bound:this,kwargs:e,config:{}})}map(){return new Zu({bound:this})}withRetry(e){return new tP({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new fs({bound:this,config:e,kwargs:{}})}withFallbacks(e){const n=Array.isArray(e)?e:e.fallbacks;return new rP({runnable:this,fallbacks:n})}_getOptionsList(e,n=0){if(Array.isArray(e)&&e.length!==n)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${n} inputs`);if(Array.isArray(e))return e.map(Ue);if(n>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:n},(s,a)=>Ue(a===0?e:r))}return Array.from({length:n},()=>Ue(e))}async batch(e,n,r){var u;const s=this._getOptionsList(n??{},e.length),a=((u=s[0])==null?void 0:u.maxConcurrency)??(r==null?void 0:r.maxConcurrency),i=new vf({maxConcurrency:a,onFailedAttempt:c=>{throw c}}),o=e.map((c,l)=>i.call(async()=>{try{return await this.invoke(c,s[l])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,n){yield this.invoke(e,n)}async stream(e,n){const r=Ue(n),s=new Sa({generator:this._streamIterator(e,r),config:r});return await s.setup,pn.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let n;e===void 0?n=Ue(e):n=Ue({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[n,r]}async _callWithConfig(e,n,r){const s=Ue(r),a=await Hn(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),At(n,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const u=e.call(this,n,s,i);o=await Zr(u,r==null?void 0:r.signal)}catch(u){throw await(i==null?void 0:i.handleChainError(u)),u}return await(i==null?void 0:i.handleChainEnd(At(o,"output"))),o}async _batchWithConfig(e,n,r,s){var c;const a=this._getOptionsList(r??{},n.length),i=await Promise.all(a.map(Hn)),o=await Promise.all(i.map(async(l,d)=>{const m=await(l==null?void 0:l.handleChainStart(this.toJSON(),At(n[d],"input"),a[d].runId,a[d].runType,void 0,void 0,a[d].runName??this.getName()));return delete a[d].runId,m}));let u;try{const l=e.call(this,n,a,o,s);u=await Zr(l,(c=a==null?void 0:a[0])==null?void 0:c.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(At(u,"output")))),u}async*_transformStreamWithConfig(e,n,r){let s,a=!0,i,o=!0;const u=Ue(r),c=await Hn(u);async function*l(){for await(const m of e){if(a)if(s===void 0)s=m;else try{s=$n(s,m)}catch{s=void 0,a=!1}yield m}}let d;try{const m=await eR(n.bind(this),l(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),r==null?void 0:r.signal,u);delete u.runId,d=m.setup;const p=d==null?void 0:d.handlers.find(rR);let f=m.output;p!==void 0&&d!==void 0&&(f=p.tapOutputIterable(d.runId,f));const g=d==null?void 0:d.handlers.find(tR);g!==void 0&&d!==void 0&&(f=g.tapOutputIterable(d.runId,f));for await(const b of f)if(yield b,o)if(i===void 0)i=b;else try{i=$n(i,b)}catch{i=void 0,o=!1}}catch(m){throw await(d==null?void 0:d.handleChainError(m,void 0,void 0,void 0,{inputs:At(s,"input")})),m}await(d==null?void 0:d.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:At(s,"input")}))}getGraph(e){const n=new zc,r=n.addNode({name:`${this.getName()}Input`,schema:Or.any()}),s=n.addNode(this),a=n.addNode({name:`${this.getName()}Output`,schema:Or.any()});return n.addEdge(r,s),n.addEdge(s,a),n}pipe(e){return new cr({first:this,last:os(e)})}pick(e){return this.pipe(new sP(e))}assign(e){return this.pipe(new Iy(new Aa({steps:e})))}async*transform(e,n){let r;for await(const s of e)r===void 0?r=s:r=$n(r,s);yield*this._streamIterator(r,Ue(n))}async*streamLog(e,n,r){const s=new hg({...r,autoClose:!1,_schemaFormat:"original"}),a=Ue(n);yield*this._streamLog(e,s,a)}async*_streamLog(e,n,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[n];else if(Array.isArray(s))r.callbacks=s.concat([n]);else{const u=s.copy();u.addHandler(n,!0),r.callbacks=u}const a=this.stream(e,r);async function i(){try{const u=await a;for await(const c of u){const l=new Ur({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await n.writer.write(l)}}finally{await n.writer.close()}}const o=i();try{for await(const u of n)yield u}finally{await o}}streamEvents(e,n,r){let s;if(n.version==="v1")s=this._streamEventsV1(e,n,r);else if(n.version==="v2")s=this._streamEventsV2(e,n,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return n.encoding==="text/event-stream"?QR(s):pn.fromAsyncGenerator(s)}async*_streamEventsV2(e,n,r){var p;const s=new sR({...r,autoClose:!1}),a=Ue(n),i=a.runId??Jt();a.runId=i;const o=a.callbacks;if(o===void 0)a.callbacks=[s];else if(Array.isArray(o))a.callbacks=o.concat(s);else{const f=o.copy();f.addHandler(s,!0),a.callbacks=f}const u=this;async function c(){try{const f=await u.stream(e,a),g=s.tapOutputIterable(i,f);for await(const b of g);}finally{await s.finish()}}const l=c();let d=!1,m;try{for await(const f of s){if(!d){f.data.input=e,d=!0,m=f.run_id,yield f;continue}f.run_id===m&&f.event.endsWith("_end")&&(p=f.data)!=null&&p.input&&delete f.data.input,yield f}}finally{await l}}async*_streamEventsV1(e,n,r){let s,a=!1;const i=Ue(n),o=i.tags??[],u=i.metadata??{},c=i.runName??this.getName(),l=new hg({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new oR({...r}),m=this._streamLog(e,l,i);for await(const f of m){if(s?s=s.concat(f):s=Hi.fromRunLogPatch(f),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const y={...s.state},S={run_id:y.id,event:`on_${y.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(S,y.type)&&(yield S)}const g=f.ops.filter(y=>y.path.startsWith("/logs/")).map(y=>y.path.split("/")[2]),b=[...new Set(g)];for(const y of b){let S,I={};const A=s.state.logs[y];if(A.end_time===void 0?A.streamed_output.length>0?S="stream":S="start":S="end",S==="start")A.inputs!==void 0&&(I.input=A.inputs);else if(S==="end")A.inputs!==void 0&&(I.input=A.inputs),I.output=A.final_output;else if(S==="stream"){const O=A.streamed_output.length;if(O!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${O} instead. Encountered in: "${A.name}"`);I={chunk:A.streamed_output[0]},A.streamed_output=[]}yield{event:`on_${A.type}_${S}`,name:A.name,run_id:A.id,tags:A.tags,metadata:A.metadata,data:I}}const{state:_}=s;if(_.streamed_output.length>0){const y=_.streamed_output.length;if(y!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${y} instead. Encountered in: "${_.name}"`);const S={chunk:_.streamed_output[0]};_.streamed_output=[];const I={event:`on_${_.type}_stream`,run_id:_.id,tags:o,metadata:u,name:c,data:S};d.includeEvent(I,_.type)&&(yield I)}}const p=s==null?void 0:s.state;if(p!==void 0){const f={event:`on_${p.type}_end`,name:c,run_id:p.id,tags:o,metadata:u,data:{output:p.final_output}};d.includeEvent(f,p.type)&&(yield f)}}static isRunnable(e){return If(e)}withListeners({onStart:e,onEnd:n,onError:r}){return new fs({bound:this,config:{},configFactories:[s=>({callbacks:[new Ty({config:s,onStart:e,onEnd:n,onError:r})]})]})}asTool(e){return aP(this,e)}}class fs extends bt{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const n=cg(this.config,...e);return cg(n,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(n))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,n){return this.bound.invoke(e,await this._mergeConfig(Ue(n),this.kwargs))}async batch(e,n,r){const s=Array.isArray(n)?await Promise.all(n.map(async a=>this._mergeConfig(Ue(a),this.kwargs))):await this._mergeConfig(Ue(n),this.kwargs);return this.bound.batch(e,s,r)}async*_streamIterator(e,n){yield*this.bound._streamIterator(e,await this._mergeConfig(Ue(n),this.kwargs))}async stream(e,n){return this.bound.stream(e,await this._mergeConfig(Ue(n),this.kwargs))}async*transform(e,n){yield*this.bound.transform(e,await this._mergeConfig(Ue(n),this.kwargs))}streamEvents(e,n,r){const s=this,a=async function*(){yield*s.bound.streamEvents(e,{...await s._mergeConfig(Ue(n),s.kwargs),version:n.version},r)};return pn.fromAsyncGenerator(a())}static isRunnableBinding(e){return e.bound&&bt.isRunnable(e.bound)}withListeners({onStart:e,onEnd:n,onError:r}){return new fs({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new Ty({config:s,onStart:e,onEnd:n,onError:r})]})]})}}class Zu extends bt{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Zu({bound:this.bound.bind(e)})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async _invoke(e,n,r){return this.bound.batch(e,Pt(n,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:n,onError:r}){return new Zu({bound:this.bound.withListeners({onStart:e,onEnd:n,onError:r})})}}class tP extends fs{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,n,r){const s=e>1?`retry:attempt:${e}`:void 0;return Pt(n,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,n,r){return qu(s=>super.invoke(e,this._patchConfigForRetry(s,n,r)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async _batch(e,n,r,s){const a={};try{await qu(async i=>{const o=e.map((m,p)=>p).filter(m=>a[m.toString()]===void 0||a[m.toString()]instanceof Error),u=o.map(m=>e[m]),c=o.map(m=>this._patchConfigForRetry(i,n==null?void 0:n[m],r==null?void 0:r[m])),l=await super.batch(u,c,{...s,returnExceptions:!0});let d;for(let m=0;m<l.length;m+=1){const p=l[m],f=o[m];p instanceof Error&&d===void 0&&(d=p,d.input=u[m]),a[f.toString()]=p}if(d)throw d;return l},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((s==null?void 0:s.returnExceptions)!==!0)throw i}return Object.keys(a).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>a[parseInt(i,10)])}async batch(e,n,r){return this._batchWithConfig(this._batch.bind(this),e,n,r)}}class cr extends bt{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,n){var u;const r=Ue(n),s=await Hn(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),At(e,"input"),r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i=e,o;try{const c=[this.first,...this.middle];for(let l=0;l<c.length;l+=1){const m=c[l].invoke(i,Pt(r,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));i=await Zr(m,n==null?void 0:n.signal)}if((u=n==null?void 0:n.signal)!=null&&u.aborted)throw new Error("Aborted");o=await this.last.invoke(i,Pt(r,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(At(o,"output"))),o}async batch(e,n,r){var u;const s=this._getOptionsList(n??{},e.length),a=await Promise.all(s.map(Hn)),i=await Promise.all(a.map(async(c,l)=>{const d=await(c==null?void 0:c.handleChainStart(this.toJSON(),At(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,d}));let o=e;try{for(let c=0;c<this.steps.length;c+=1){const d=this.steps[c].batch(o,i.map((m,p)=>{const f=m==null?void 0:m.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return Pt(s[p],{callbacks:f})}),r);o=await Zr(d,(u=s[0])==null?void 0:u.signal)}}catch(c){throw await Promise.all(i.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(i.map(c=>c==null?void 0:c.handleChainEnd(At(o,"output")))),o}async*_streamIterator(e,n){var d;const r=await Hn(n),{runId:s,...a}=n??{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),At(e,"input"),s,void 0,void 0,void 0,a==null?void 0:a.runName)),o=[this.first,...this.middle,this.last];let u=!0,c;async function*l(){yield e}try{let m=o[0].transform(l(),Pt(a,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let p=1;p<o.length;p+=1)m=await o[p].transform(m,Pt(a,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${p+1}`)}));for await(const p of m)if((d=n==null?void 0:n.signal)==null||d.throwIfAborted(),yield p,u)if(c===void 0)c=p;else try{c=$n(c,p)}catch{c=void 0,u=!1}}catch(m){throw await(i==null?void 0:i.handleChainError(m)),m}await(i==null?void 0:i.handleChainEnd(At(c,"output")))}getGraph(e){const n=new zc;let r=null;return this.steps.forEach((s,a)=>{const i=s.getGraph(e);a!==0&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),n.extend(i);const o=i.firstNode();if(!o)throw new Error(`Runnable ${s} has no first node`);r&&n.addEdge(r,o),r=i.lastNode()}),n}pipe(e){return cr.isRunnableSequence(e)?new cr({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new cr({first:this.first,middle:[...this.middle,this.last],last:os(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&bt.isRunnable(e)}static from([e,...n],r){let s={};return typeof r=="string"?s.name=r:r!==void 0&&(s=r),new cr({...s,first:os(e),middle:n.slice(0,-1).map(os),last:os(n[n.length-1])})}}class Aa extends bt{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[n,r]of Object.entries(e.steps))this.steps[n]=os(r)}static from(e){return new Aa({steps:e})}async invoke(e,n){const r=Ue(n),s=await Hn(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;const i={};try{const o=Object.entries(this.steps).map(async([u,c])=>{i[u]=await c.invoke(e,Pt(r,{callbacks:a==null?void 0:a.getChild(`map:key:${u}`)}))});await Zr(Promise.all(o),n==null?void 0:n.signal)}catch(o){throw await(a==null?void 0:a.handleChainError(o)),o}return await(a==null?void 0:a.handleChainEnd(i)),i}async*_transform(e,n,r){const s={...this.steps},a=wy(e,Object.keys(s).length),i=new Map(Object.entries(s).map(([o,u],c)=>{const l=u.transform(a[c],Pt(r,{callbacks:n==null?void 0:n.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){const o=Promise.race(i.values()),{key:u,result:c,gen:l}=await Zr(o,r==null?void 0:r.signal);i.delete(u),c.done||(yield{[u]:c.value},i.set(u,l.next().then(d=>({key:u,gen:l,result:d}))))}}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Ue(n),a=new Sa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class kf extends bt{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Af(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,n){const[r]=this._getOptionsList(n??{},1),s=await Hn(r),a=this.func(Pt(r,{callbacks:s}),e);return Zr(a,r==null?void 0:r.signal)}async*_streamIterator(e,n){var a,i;const[r]=this._getOptionsList(n??{},1),s=await this.invoke(e,n);if(ch(s)){for await(const o of s)(a=r==null?void 0:r.signal)==null||a.throwIfAborted(),yield o;return}if(eP(s)){for(;;){(i=r==null?void 0:r.signal)==null||i.throwIfAborted();const o=s.next();if(o.done)break;yield o.value}return}yield s}static from(e){return new kf({func:e})}}function nP(t){if(Af(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class co extends bt{static lc_name(){return"RunnableLambda"}constructor(e){if(Af(e.func))return kf.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),nP(e.func),this.func=e.func}static from(e){return new co({func:e})}async _invoke(e,n,r){return new Promise((s,a)=>{const i=Pt(n,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((n==null?void 0:n.recursionLimit)??Ql)-1});Yr.runWithConfig(ca(i),async()=>{var o,u;try{let c=await this.func(e,{...i});if(c&&bt.isRunnable(c)){if((n==null?void 0:n.recursionLimit)===0)throw new Error("Recursion limit reached.");c=await c.invoke(e,{...i,recursionLimit:(i.recursionLimit??Ql)-1})}else if(ch(c)){let l;for await(const d of lh(i,c))if((o=n==null?void 0:n.signal)==null||o.throwIfAborted(),l===void 0)l=d;else try{l=$n(l,d)}catch{l=d}c=l}else if(_g(c)){let l;for(const d of yg(i,c))if((u=n==null?void 0:n.signal)==null||u.throwIfAborted(),l===void 0)l=d;else try{l=$n(l,d)}catch{l=d}c=l}s(c)}catch(c){a(c)}})})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async*_transform(e,n,r){var o,u;let s;for await(const c of e)if(s===void 0)s=c;else try{s=$n(s,c)}catch{s=c}const a=Pt(r,{callbacks:n==null?void 0:n.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??Ql)-1}),i=await new Promise((c,l)=>{Yr.runWithConfig(ca(a),async()=>{try{const d=await this.func(s,{...a,config:a});c(d)}catch(d){l(d)}})});if(i&&bt.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const c=await i.stream(s,a);for await(const l of c)yield l}else if(ch(i))for await(const c of lh(a,i))(o=r==null?void 0:r.signal)==null||o.throwIfAborted(),yield c;else if(_g(i))for(const c of yg(a,i))(u=r==null?void 0:r.signal)==null||u.throwIfAborted(),yield c;else yield i}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Ue(n),a=new Sa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class rP extends bt{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,n){const r=Ue(n),s=await Hn(r),{runId:a,...i}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),At(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName)),u=Pt(i,{callbacks:o==null?void 0:o.getChild()});return await Yr.runWithConfig(u,async()=>{var d;let l;for(const m of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{const p=await m.invoke(e,u);return await(o==null?void 0:o.handleChainEnd(At(p,"output"))),p}catch(p){l===void 0&&(l=p)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,n){var d;const r=Ue(n),s=await Hn(r),{runId:a,...i}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),At(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName));let u,c;for(const m of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();const p=Pt(i,{callbacks:o==null?void 0:o.getChild()});try{const f=await m.stream(e,p);c=lh(p,f);break}catch(f){u===void 0&&(u=f)}}if(c===void 0){const m=u??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(m)),m}let l;try{for await(const m of c){yield m;try{l=l===void 0?l:$n(l,m)}catch{l=void 0}}}catch(m){throw await(o==null?void 0:o.handleChainError(m)),m}await(o==null?void 0:o.handleChainEnd(At(l,"output")))}async batch(e,n,r){var u;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(n??{},e.length),a=await Promise.all(s.map(c=>Hn(c))),i=await Promise.all(a.map(async(c,l)=>{const d=await(c==null?void 0:c.handleChainStart(this.toJSON(),At(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,d}));let o;for(const c of this.runnables()){(u=s[0].signal)==null||u.throwIfAborted();try{const l=await c.batch(e,i.map((d,m)=>Pt(s[m],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(i.map((d,m)=>d==null?void 0:d.handleChainEnd(At(l[m],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function os(t){if(typeof t=="function")return new co({func:t});if(bt.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[n,r]of Object.entries(t))e[n]=os(r);return new Aa({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class Iy extends bt{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Aa&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,n){const r=await this.mapper.invoke(e,n);return{...e,...r}}async*_transform(e,n,r){const s=this.mapper.getStepsKeys(),[a,i]=wy(e),o=this.mapper.transform(i,Pt(r,{callbacks:n==null?void 0:n.getChild()})),u=o.next();for await(const c of a){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([d])=>!s.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Ue(n),a=new Sa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class sP extends bt{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const n=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return n.length===0?void 0:Object.fromEntries(n)}}async invoke(e,n){return this._callWithConfig(this._pick.bind(this),e,n)}async*_transform(e){for await(const n of e){const r=await this._pick(n);r!==void 0&&(yield r)}}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Ue(n),a=new Sa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class Eg extends fs{constructor(e){const n=cr.from([co.from(async r=>{let s;if(hf(r))try{s=await this.schema.parseAsync(r.args)}catch{throw new B_("Received tool input did not match expected schema",JSON.stringify(r.args))}else s=r;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:n,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function aP(t,e){var s;const n=e.name??t.getName(),r=e.description??((s=e.schema)==null?void 0:s.description);return e.schema.constructor===Or.ZodString?new Eg({name:n,description:r,schema:Or.object({input:Or.string()}).transform(a=>a.input),bound:t}):new Eg({name:n,description:r,schema:e.schema,bound:t})}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var iP=typeof window=="object"?window:{},Ce="0123456789abcdef".split(""),oP=[-2147483648,8388608,32768,128],Rn=[24,16,8,0],Et=[];function Vn(t){t?(Et[0]=Et[16]=Et[1]=Et[2]=Et[3]=Et[4]=Et[5]=Et[6]=Et[7]=Et[8]=Et[9]=Et[10]=Et[11]=Et[12]=Et[13]=Et[14]=Et[15]=0,this.blocks=Et):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Vn.prototype.update=function(t){if(!this.finalized){var e=typeof t!="string";e&&t.constructor===iP.ArrayBuffer&&(t=new Uint8Array(t));for(var n,r=0,s,a=t.length||0,i=this.blocks;r<a;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(s=this.start;r<a&&s<64;++r)i[s>>2]|=t[r]<<Rn[s++&3];else for(s=this.start;r<a&&s<64;++r)n=t.charCodeAt(r),n<128?i[s>>2]|=n<<Rn[s++&3]:n<2048?(i[s>>2]|=(192|n>>6)<<Rn[s++&3],i[s>>2]|=(128|n&63)<<Rn[s++&3]):n<55296||n>=57344?(i[s>>2]|=(224|n>>12)<<Rn[s++&3],i[s>>2]|=(128|n>>6&63)<<Rn[s++&3],i[s>>2]|=(128|n&63)<<Rn[s++&3]):(n=65536+((n&1023)<<10|t.charCodeAt(++r)&1023),i[s>>2]|=(240|n>>18)<<Rn[s++&3],i[s>>2]|=(128|n>>12&63)<<Rn[s++&3],i[s>>2]|=(128|n>>6&63)<<Rn[s++&3],i[s>>2]|=(128|n&63)<<Rn[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=i[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Vn.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>2]|=oP[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}};Vn.prototype.hash=function(){var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,a,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)a=e&n|~e&r,o=t<<5|t>>>27,s=o+a+s+1518500249+u[i]<<0,e=e<<30|e>>>2,a=t&e|~t&n,o=s<<5|s>>>27,r=o+a+r+1518500249+u[i+1]<<0,t=t<<30|t>>>2,a=s&t|~s&e,o=r<<5|r>>>27,n=o+a+n+1518500249+u[i+2]<<0,s=s<<30|s>>>2,a=r&s|~r&t,o=n<<5|n>>>27,e=o+a+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,a=n&r|~n&s,o=e<<5|e>>>27,t=o+a+t+1518500249+u[i+4]<<0,n=n<<30|n>>>2;for(;i<40;i+=5)a=e^n^r,o=t<<5|t>>>27,s=o+a+s+1859775393+u[i]<<0,e=e<<30|e>>>2,a=t^e^n,o=s<<5|s>>>27,r=o+a+r+1859775393+u[i+1]<<0,t=t<<30|t>>>2,a=s^t^e,o=r<<5|r>>>27,n=o+a+n+1859775393+u[i+2]<<0,s=s<<30|s>>>2,a=r^s^t,o=n<<5|n>>>27,e=o+a+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,a=n^r^s,o=e<<5|e>>>27,t=o+a+t+1859775393+u[i+4]<<0,n=n<<30|n>>>2;for(;i<60;i+=5)a=e&n|e&r|n&r,o=t<<5|t>>>27,s=o+a+s-1894007588+u[i]<<0,e=e<<30|e>>>2,a=t&e|t&n|e&n,o=s<<5|s>>>27,r=o+a+r-1894007588+u[i+1]<<0,t=t<<30|t>>>2,a=s&t|s&e|t&e,o=r<<5|r>>>27,n=o+a+n-1894007588+u[i+2]<<0,s=s<<30|s>>>2,a=r&s|r&t|s&t,o=n<<5|n>>>27,e=o+a+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,a=n&r|n&s|r&s,o=e<<5|e>>>27,t=o+a+t-1894007588+u[i+4]<<0,n=n<<30|n>>>2;for(;i<80;i+=5)a=e^n^r,o=t<<5|t>>>27,s=o+a+s-899497514+u[i]<<0,e=e<<30|e>>>2,a=t^e^n,o=s<<5|s>>>27,r=o+a+r-899497514+u[i+1]<<0,t=t<<30|t>>>2,a=s^t^e,o=r<<5|r>>>27,n=o+a+n-899497514+u[i+2]<<0,s=s<<30|s>>>2,a=r^s^t,o=n<<5|n>>>27,e=o+a+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,a=n^r^s,o=e<<5|e>>>27,t=o+a+t-899497514+u[i+4]<<0,n=n<<30|n>>>2;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+n<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0};Vn.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4;return Ce[t>>28&15]+Ce[t>>24&15]+Ce[t>>20&15]+Ce[t>>16&15]+Ce[t>>12&15]+Ce[t>>8&15]+Ce[t>>4&15]+Ce[t&15]+Ce[e>>28&15]+Ce[e>>24&15]+Ce[e>>20&15]+Ce[e>>16&15]+Ce[e>>12&15]+Ce[e>>8&15]+Ce[e>>4&15]+Ce[e&15]+Ce[n>>28&15]+Ce[n>>24&15]+Ce[n>>20&15]+Ce[n>>16&15]+Ce[n>>12&15]+Ce[n>>8&15]+Ce[n>>4&15]+Ce[n&15]+Ce[r>>28&15]+Ce[r>>24&15]+Ce[r>>20&15]+Ce[r>>16&15]+Ce[r>>12&15]+Ce[r>>8&15]+Ce[r>>4&15]+Ce[r&15]+Ce[s>>28&15]+Ce[s>>24&15]+Ce[s>>20&15]+Ce[s>>16&15]+Ce[s>>12&15]+Ce[s>>8&15]+Ce[s>>4&15]+Ce[s&15]};Vn.prototype.toString=Vn.prototype.hex;Vn.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4;return[t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,n>>24&255,n>>16&255,n>>8&255,n&255,r>>24&255,r>>16&255,r>>8&255,r&255,s>>24&255,s>>16&255,s>>8&255,s&255]};Vn.prototype.array=Vn.prototype.digest;Vn.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(20),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),t};const uP=t=>new Vn(!0).update(t).hex(),wg=(...t)=>uP(t.join("_"));class cP{}const lP=new Map;class Nf extends cP{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,n){return Promise.resolve(this.cache.get(wg(e,n))??null)}async update(e,n,r){this.cache.set(wg(e,n),r)}static global(){return new Nf(lP)}}class ky extends Vr{}class dP extends ky{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new or(this.value)]}}class hP extends ky{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return F_(this.messages)}toChatMessages(){return this.messages}}var Wc={};Wc.byteLength=pP;Wc.toByteArray=bP;Wc.fromByteArray=EP;var ar=[],En=[],fP=typeof Uint8Array<"u"?Uint8Array:Array,rd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Ms=0,mP=rd.length;Ms<mP;++Ms)ar[Ms]=rd[Ms],En[rd.charCodeAt(Ms)]=Ms;En[45]=62;En[95]=63;function Ny(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function pP(t){var e=Ny(t),n=e[0],r=e[1];return(n+r)*3/4-r}function gP(t,e,n){return(e+n)*3/4-n}function bP(t){var e,n=Ny(t),r=n[0],s=n[1],a=new fP(gP(t,r,s)),i=0,o=s>0?r-4:r,u;for(u=0;u<o;u+=4)e=En[t.charCodeAt(u)]<<18|En[t.charCodeAt(u+1)]<<12|En[t.charCodeAt(u+2)]<<6|En[t.charCodeAt(u+3)],a[i++]=e>>16&255,a[i++]=e>>8&255,a[i++]=e&255;return s===2&&(e=En[t.charCodeAt(u)]<<2|En[t.charCodeAt(u+1)]>>4,a[i++]=e&255),s===1&&(e=En[t.charCodeAt(u)]<<10|En[t.charCodeAt(u+1)]<<4|En[t.charCodeAt(u+2)]>>2,a[i++]=e>>8&255,a[i++]=e&255),a}function _P(t){return ar[t>>18&63]+ar[t>>12&63]+ar[t>>6&63]+ar[t&63]}function yP(t,e,n){for(var r,s=[],a=e;a<n;a+=3)r=(t[a]<<16&16711680)+(t[a+1]<<8&65280)+(t[a+2]&255),s.push(_P(r));return s.join("")}function EP(t){for(var e,n=t.length,r=n%3,s=[],a=16383,i=0,o=n-r;i<o;i+=a)s.push(yP(t,i,i+a>o?o:i+a));return r===1?(e=t[n-1],s.push(ar[e>>2]+ar[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(ar[e>>10]+ar[e>>4&63]+ar[e<<2&63]+"=")),s.join("")}var wP=Object.defineProperty,TP=(t,e,n)=>e in t?wP(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,SP=(t,e,n)=>(TP(t,e+"",n),n);function AP(t,e){let n=Array.from({length:t.length},(r,s)=>({start:s,end:s+1}));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const a=t.slice(n[s].start,n[s+1].end),i=e.get(a.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,s])}if(r!=null){const s=r[1];n[s]={start:n[s].start,end:n[s+1].end},n.splice(s+1,1)}else break}return n}function CP(t,e){return t.length===1?[e.get(t.join(","))]:AP(t,e).map(n=>e.get(t.slice(n.start,n.end).join(","))).filter(n=>n!=null)}function OP(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var dh=class{constructor(t,e){Ie(this,"specialTokens");Ie(this,"inverseSpecialTokens");Ie(this,"patStr");Ie(this,"textEncoder",new TextEncoder);Ie(this,"textDecoder",new TextDecoder("utf-8"));Ie(this,"rankMap",new Map);Ie(this,"textMap",new Map);this.patStr=t.pat_str;const n=t.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[a,i,...o]=s.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(const[r,s]of Object.entries(n)){const a=Wc.toByteArray(r);this.rankMap.set(a.join(","),s),this.textMap.set(s,a)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,a])=>(r[a]=this.textEncoder.encode(s),r),{})}encode(t,e=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=dh.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(n==="all"?Object.keys(this.specialTokens).filter(c=>!i.has(c)):n);if(o.size>0){const c=dh.specialTokenRegex([...o]),l=t.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;s.lastIndex=l,c=s.exec(t),!(c==null||i.has(c[0]));)l=c.index+1;const d=(c==null?void 0:c.index)??t.length;for(const p of t.substring(u,d).matchAll(r)){const f=this.textEncoder.encode(p[0]),g=this.rankMap.get(f.join(","));if(g!=null){a.push(g);continue}a.push(...CP(f,this.rankMap))}if(c==null)break;let m=this.specialTokens[c[0]];a.push(m),u=c.index+c[0].length}return a}decode(t){const e=[];let n=0;for(let a=0;a<t.length;++a){const i=t[a],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),n+=o.length)}const r=new Uint8Array(n);let s=0;for(const a of e)r.set(a,s),s+=a.length;return this.textDecoder.decode(r)}},Ry=dh;SP(Ry,"specialTokenRegex",t=>new RegExp(t.map(e=>OP(e)).join("|"),"g"));function vP(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}const Jo={},IP=new vf({});async function kP(t){return t in Jo||(Jo[t]=IP.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new Ry(e)).catch(e=>{throw delete Jo[t],e})),await Jo[t]}async function NP(t){return kP(vP(t))}const RP=t=>t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t.startsWith("gpt-4o")?"gpt-4o":t;function Py(t){return typeof t!="object"||!t?!1:!!("type"in t&&t.type==="function"&&"function"in t&&typeof t.function=="object"&&t.function&&"name"in t.function&&"parameters"in t.function)}const PP=()=>!1;class xy extends bt{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??PP(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class xP extends xy{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:n,...r}){const{cache:s,...a}=r;super({callbacks:e??n,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof s=="object"?this.cache=s:s?this.cache=Nf.global():this.cache=void 0,this.caller=new vf(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let n=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await NP("modelName"in this?RP(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{n=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new dP(e):Array.isArray(e)?new hP(e.map(Ja)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...n}){const r={...this._identifyingParams(),...n,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class da extends bt{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,n){const r=Ue(n);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,n){const r=Ue(n);let s,a=!0;for await(const i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,a)if(s===void 0)s=i;else try{s=$n(s,i)}catch{s=void 0,a=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new Iy(new Aa({steps:e}))}}function Rf(t){return typeof(t==null?void 0:t.parse)=="function"}class Sr extends xP{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[n,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=n.signal,[n,r]}async invoke(e,n){const r=Sr._convertInputToPromptValue(e);return(await this.generatePrompt([r],n,n==null?void 0:n.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,n,r){throw new Error("Not implemented.")}async*_streamIterator(e,n){var r;if(this._streamResponseChunks===Sr.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,n);else{const a=Sr._convertInputToPromptValue(e).toChatMessages(),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(n),u={...i.metadata,...this.getLsParams(o)},c=await Lt.configure(i.callbacks,this.callbacks,i.tags,this.tags,u,this.metadata,{verbose:this.verbose}),l={options:o,invocation_params:this==null?void 0:this.invocationParams(o),batch_size:1},d=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[a],i.runId,void 0,l,void 0,void 0,i.runName));let m,p;try{for await(const f of this._streamResponseChunks(a,o,d==null?void 0:d[0])){if(f.message.id==null){const g=(r=d==null?void 0:d.at(0))==null?void 0:r.runId;g!=null&&f.message._updateId(`run-${g}`)}f.message.response_metadata={...f.generationInfo,...f.message.response_metadata},yield f.message,m?m=m.concat(f):m=f,Ip(f.message)&&f.message.usage_metadata!==void 0&&(p={tokenUsage:{promptTokens:f.message.usage_metadata.input_tokens,completionTokens:f.message.usage_metadata.output_tokens,totalTokens:f.message.usage_metadata.total_tokens}})}}catch(f){throw await Promise.all((d??[]).map(g=>g==null?void 0:g.handleLLMError(f))),f}await Promise.all((d??[]).map(f=>f==null?void 0:f.handleLLMEnd({generations:[[m]],llmOutput:p})))}}getLsParams(e){const n=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:n}}async _generateUncached(e,n,r,s){var d,m;const a=e.map(p=>p.map(Ja));let i;if(s!==void 0&&s.length===a.length)i=s;else{const p={...r.metadata,...this.getLsParams(n)},f=await Lt.configure(r.callbacks,this.callbacks,r.tags,this.tags,p,this.metadata,{verbose:this.verbose}),g={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:1};i=await(f==null?void 0:f.handleChatModelStart(this.toJSON(),a,r.runId,void 0,g,void 0,void 0,r.runName))}const o=[],u=[];if(!!(i!=null&&i[0].handlers.find(LN))&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==Sr.prototype._streamResponseChunks)try{const p=await this._streamResponseChunks(a[0],n,i==null?void 0:i[0]);let f,g;for await(const b of p){if(b.message.id==null){const _=(d=i==null?void 0:i.at(0))==null?void 0:d.runId;_!=null&&b.message._updateId(`run-${_}`)}f===void 0?f=b:f=$n(f,b),Ip(b.message)&&b.message.usage_metadata!==void 0&&(g={tokenUsage:{promptTokens:b.message.usage_metadata.input_tokens,completionTokens:b.message.usage_metadata.output_tokens,totalTokens:b.message.usage_metadata.total_tokens}})}if(f===void 0)throw new Error("Received empty response from chat model call.");o.push([f]),await(i==null?void 0:i[0].handleLLMEnd({generations:o,llmOutput:g}))}catch(p){throw await(i==null?void 0:i[0].handleLLMError(p)),p}else{const p=await Promise.allSettled(a.map((f,g)=>this._generate(f,{...n,promptIndex:g},i==null?void 0:i[g])));await Promise.all(p.map(async(f,g)=>{var b,_,y;if(f.status==="fulfilled"){const S=f.value;for(const I of S.generations){if(I.message.id==null){const A=(b=i==null?void 0:i.at(0))==null?void 0:b.runId;A!=null&&I.message._updateId(`run-${A}`)}I.message.response_metadata={...I.generationInfo,...I.message.response_metadata}}return S.generations.length===1&&(S.generations[0].message.response_metadata={...S.llmOutput,...S.generations[0].message.response_metadata}),o[g]=S.generations,u[g]=S.llmOutput,(_=i==null?void 0:i[g])==null?void 0:_.handleLLMEnd({generations:[S.generations],llmOutput:S.llmOutput})}else return await((y=i==null?void 0:i[g])==null?void 0:y.handleLLMError(f.reason)),Promise.reject(f.reason)}))}const l={generations:o,llmOutput:u.length?(m=this._combineLLMOutput)==null?void 0:m.call(this,...u):void 0};return Object.defineProperty(l,fg,{value:i?{runIds:i==null?void 0:i.map(p=>p.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:n,llmStringKey:r,parsedOptions:s,handledOptions:a}){const i=e.map(b=>b.map(Ja)),o={...a.metadata,...this.getLsParams(s)},u=await Lt.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1},l=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),i,a.runId,void 0,c,void 0,void 0,a.runName)),d=[],p=(await Promise.allSettled(i.map(async(b,_)=>{const y=Sr._convertInputToPromptValue(b).toString(),S=await n.lookup(y,r);return S==null&&d.push(_),S}))).map((b,_)=>({result:b,runManager:l==null?void 0:l[_]})).filter(({result:b})=>b.status==="fulfilled"&&b.value!=null||b.status==="rejected"),f=[];await Promise.all(p.map(async({result:b,runManager:_},y)=>{if(b.status==="fulfilled"){const S=b.value;return f[y]=S.map(I=>("message"in I&&Pc(I.message)&&ro(I.message)&&(I.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),I.generationInfo={...I.generationInfo,tokenUsage:{}},I)),S.length&&await(_==null?void 0:_.handleLLMNewToken(S[0].text)),_==null?void 0:_.handleLLMEnd({generations:[S]},void 0,void 0,void 0,{cached:!0})}else return await(_==null?void 0:_.handleLLMError(b.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(b.reason)}));const g={generations:f,missingPromptIndices:d,startedRunManagers:l};return Object.defineProperty(g,fg,{value:l?{runIds:l==null?void 0:l.map(b=>b.runId)}:void 0,configurable:!0}),g}async generate(e,n,r){let s;Array.isArray(n)?s={stop:n}:s=n;const a=e.map(f=>f.map(Ja)),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(s);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(a,o,i);const{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d,startedRunManagers:m}=await this._generateCached({messages:a,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i});let p={};if(d.length>0){const f=await this._generateUncached(d.map(g=>a[g]),o,i,m!==void 0?d.map(g=>m==null?void 0:m[g]):void 0);await Promise.all(f.generations.map(async(g,b)=>{const _=d[b];l[_]=g;const y=Sr._convertInputToPromptValue(a[_]).toString();return u.update(y,c,g)})),p=f.llmOutput??{}}return{generations:l,llmOutput:p}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,n,r){const s=e.map(a=>a.toChatMessages());return this.generate(s,n,r)}async call(e,n,r){return(await this.generate([e.map(Ja)],n,r)).generations[0][0].message}async callPrompt(e,n,r){const s=e.toChatMessages();return this.call(s,n,r)}async predictMessages(e,n,r){return this.call(e,n,r)}async predict(e,n,r){const s=new or(e),a=await this.call([s],n,r);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,n){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(n!=null&&n.strict)throw new Error('"strict" mode is not supported for this model by default.');const r=e,s=n==null?void 0:n.name,a=r.description??"A function available to call.",i=n==null?void 0:n.method,o=n==null?void 0:n.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=s??"extract",c;Rf(r)?c=[{type:"function",function:{name:u,description:a,parameters:Ts(r)}}]:("name"in r&&(u=r.name),c=[{type:"function",function:{name:u,description:a,parameters:r}}]);const l=this.bindTools(c),d=co.from(g=>{if(!g.tool_calls||g.tool_calls.length===0)throw new Error("No tool calls found in the response.");const b=g.tool_calls.find(_=>_.name===u);if(!b)throw new Error(`No tool call found with name ${u}.`);return b.args});if(!o)return l.pipe(d).withConfig({runName:"StructuredOutput"});const m=da.assign({parsed:(g,b)=>d.invoke(g.raw,b)}),p=da.assign({parsed:()=>null}),f=m.withFallbacks({fallbacks:[p]});return cr.from([{raw:l},f]).withConfig({runName:"StructuredOutputRunnable"})}}function LP(t,e){const n=typeof e=="number"?void 0:e;return{name:t.name,description:t.description,parameters:Ts(t.schema),...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}}function DP(t){return t!==void 0&&Array.isArray(t.lc_namespace)}function MP(t){return t!==void 0&&bt.isRunnable(t)&&"lc_name"in t.constructor&&typeof t.constructor.lc_name=="function"&&t.constructor.lc_name()==="RunnableToolLike"}function BP(t){return!!t&&typeof t=="object"&&"name"in t&&"schema"in t&&Rf(t.schema)}function Ly(t){return BP(t)||MP(t)||DP(t)}class Dy extends bt{parseResultWithPrompt(e,n,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,n){return typeof e=="string"?this._callWithConfig(async(r,s)=>this.parseResult([{text:r}],s==null?void 0:s.callbacks),e,{...n,runType:"parser"}):this._callWithConfig(async(r,s)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],s==null?void 0:s.callbacks),e,{...n,runType:"parser"})}}class My extends Dy{parseResult(e,n){return this.parse(e[0].text,n)}async parseWithPrompt(e,n,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class $i extends Error{constructor(e,n,r,s=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=n,this.observation=r,this.sendToLLM=s,s&&(r===void 0||n===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");M_(this,"OUTPUT_PARSING_FAILURE")}}function hh(t,e){const n=typeof t;if(n!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const r=t.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!hh(t[s],e[s]))return!1;return!0}if(n==="object"){if(!t||!e)return t===e;const r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(const i of r)if(!hh(t[i],e[i]))return!1;return!0}return t===e}class FP extends My{async*_transform(e){for await(const n of e)typeof n=="string"?yield this.parseResult([{text:n}]):yield this.parseResult([{message:n,text:this._baseMessageToString(n)}])}async*transform(e,n){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...n,runType:"parser"})}}class By extends FP{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let n,r;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let a;if(mC(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new ws({message:s,text:s.content})}else if(Pc(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new ws({message:yC(s),text:s.content})}else a=new la({text:s});r===void 0?r=a:r=r.concat(a);const i=await this.parsePartialResult([r]);i!=null&&!hh(i,n)&&(this.diff?yield this._diff(n,i):yield i,n=i)}}getFormatInstructions(){return""}}class Tg extends My{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const n=Or.object(Object.fromEntries(Object.entries(e).map(([r,s])=>[r,Or.string().describe(s)])));return new this(n)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Ts(this.schema))}
\`\`\`
`}async parse(e){try{const r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(s,a)=>`"${a.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(n){throw new $i(`Failed to parse. Text: "${e}". Error: ${n}`,e)}}}class Sg extends By{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,n){if(n)return e?ON(e,n):[{op:"replace",path:"",value:n}]}async parsePartialResult(e){return Sp(e[0].text)}async parse(e){return Sp(e,JSON.parse)}getFormatInstructions(){return""}}class Ag extends Dy{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){let n=e;if(typeof e=="string")try{n=JSON.parse(e)}catch(s){throw new $i(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(s.message)}`,e)}else n=e;if(this.zodSchema===void 0)return n;const r=await this.zodSchema.safeParseAsync(n);if(r.success)return r.data;throw new $i(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(r.error.errors)}`,JSON.stringify(n,null,2))}async parseResult(e){const n=e.flatMap(a=>{const{message:i}=a;return Array.isArray(i.content)?Fy(i.content)[0]:[]});if(n[0]===void 0)throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");const[r]=n;return await this._validateResult(r.args)}}function Fy(t){const e=[];for(const n of t)n.type==="tool_use"&&e.push({name:n.name,args:n.input,id:n.id,type:"tool_call"});return e}function UP(t){if(t)return t==="any"?{type:"any"}:t==="auto"?{type:"auto"}:typeof t=="string"?{type:"tool",name:t}:t}function Cg(t){const e=/^data:(image\/.+);base64,(.+)$/,n=t.match(e);if(n===null)throw new Error(["Anthropic only supports base64-encoded images currently.","Example: data:image/png;base64,/9j/4AAQSk..."].join(`

`));return{type:"base64",media_type:n[1]??"",data:n[2]??""}}function jP(t){const e=[];for(const n of t)if(n._getType()==="tool")if(typeof n.content=="string"){const r=e[e.length-1];(r==null?void 0:r._getType())==="human"&&Array.isArray(r.content)&&"type"in r.content[0]&&r.content[0].type==="tool_result"?r.content.push({type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}):e.push(new or({content:[{type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}]}))}else e.push(new or({content:[{type:"tool_result",content:fh(n.content),tool_use_id:n.tool_call_id}]}));else e.push(n);return e}function Og(t){if(t.id===void 0)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:t.id,name:t.name,input:t.args}}function fh(t){const e=["tool_use","tool_result","input_json_delta"],n=["text","text_delta"];return typeof t=="string"?t:t.map(s=>{const a="cache_control"in s?s.cache_control:void 0;if(s.type==="image_url"){let i;return typeof s.image_url=="string"?i=Cg(s.image_url):i=Cg(s.image_url.url),{type:"image",source:i,...a?{cache_control:a}:{}}}else{if(s.type==="document")return{type:"document",source:s.source,...a?{cache_control:a}:{}};if(n.find(i=>i===s.type)&&"text"in s)return{type:"text",text:s.text,...a?{cache_control:a}:{}};if(e.find(i=>i===s.type)){const i={...s};if("index"in i&&delete i.index,i.type==="input_json_delta"&&(i.type="tool_use"),"input"in i)try{i.input=JSON.parse(i.input)}catch{}return{...i,...a?{cache_control:a}:{}}}else throw new Error("Unsupported message content format")}})}function vg(t){const e=jP(t);let n;e.length>0&&e[0]._getType()==="system"&&(n=t[0].content);const s=(n!==void 0?e.slice(1):e).map(a=>{var o;let i;if(a._getType()==="human")i="user";else if(a._getType()==="ai")i="assistant";else if(a._getType()==="tool")i="user";else throw a._getType()==="system"?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${a._getType()}" is not supported.`);if(ro(a)&&((o=a.tool_calls)!=null&&o.length)){if(typeof a.content=="string")return a.content===""?{role:i,content:a.tool_calls.map(Og)}:{role:i,content:[{type:"text",text:a.content},...a.tool_calls.map(Og)]};{const{content:u}=a;return!a.tool_calls.every(l=>u.find(d=>(d.type==="tool_use"||d.type==="input_json_delta")&&d.id===l.id))&&console.warn('The "tool_calls" field on a message is only respected if content is a string.'),{role:i,content:fh(a.content)}}}else return{role:i,content:fh(a.content)}});return{messages:HP(s),system:n}}function HP(t){if(!t||t.length<=1)return t;const e=[];let n=t[0];const r=a=>typeof a=="string"?[{type:"text",text:a}]:a,s=a=>a.role!=="user"||typeof a.content=="string"?!1:Array.isArray(a.content)&&a.content.every(i=>i.type==="tool_result");for(let a=1;a<t.length;a+=1){const i=t[a];s(n)&&s(i)?n={...n,content:[...r(n.content),...r(i.content)]}:(e.push(n),n=i)}return e.push(n),e}function $P(t,e){var n,r;if(t.type==="message_start"){const{content:s,usage:a,...i}=t.message,o={};for(const[m,p]of Object.entries(i))p!=null&&(o[m]=p);const{input_tokens:u,output_tokens:c,...l}=a??{},d={input_tokens:u,output_tokens:c,total_tokens:u+c,input_token_details:{cache_creation:l.cache_creation_input_tokens,cache_read:l.cache_read_input_tokens}};return{chunk:new Zt({content:e.coerceContentToString?"":[],additional_kwargs:o,usage_metadata:e.streamUsage?d:void 0,response_metadata:{usage:{...l}},id:t.message.id})}}else if(t.type==="message_delta"){const s={input_tokens:0,output_tokens:t.usage.output_tokens,total_tokens:t.usage.output_tokens,input_token_details:{cache_creation:t.usage.cache_creation_input_tokens,cache_read:t.usage.cache_read_input_tokens}};return{chunk:new Zt({content:e.coerceContentToString?"":[],additional_kwargs:{...t.delta},usage_metadata:e.streamUsage?s:void 0})}}else if(t.type==="content_block_start"&&t.content_block.type==="tool_use"){const s=t.content_block;return{chunk:new Zt({content:e.coerceContentToString?"":[{index:t.index,...t.content_block,input:""}],additional_kwargs:{},tool_call_chunks:[{id:s.id,index:t.index,name:s.name,args:""}]})}}else if(t.type==="content_block_delta"&&t.delta.type==="text_delta"){const s=(n=t.delta)==null?void 0:n.text;if(s!==void 0)return{chunk:new Zt({content:e.coerceContentToString?s:[{index:t.index,...t.delta}],additional_kwargs:{}})}}else{if(t.type==="content_block_delta"&&t.delta.type==="input_json_delta")return{chunk:new Zt({content:e.coerceContentToString?"":[{index:t.index,input:t.delta.partial_json,type:t.delta.type}],additional_kwargs:{},tool_call_chunks:[{index:t.index,args:t.delta.partial_json}]})};if(t.type==="content_block_start"&&t.content_block.type==="text"){const s=(r=t.content_block)==null?void 0:r.text;if(s!==void 0)return{chunk:new Zt({content:e.coerceContentToString?s:[{index:t.index,...t.content_block}],additional_kwargs:{}})}}}return null}function qP(t,e){const n=e.usage,r=n!=null?{input_tokens:n.input_tokens??0,output_tokens:n.output_tokens??0,total_tokens:(n.input_tokens??0)+(n.output_tokens??0),input_token_details:{cache_creation:n.cache_creation_input_tokens,cache_read:n.cache_read_input_tokens}}:void 0;if(t.length===1&&t[0].type==="text")return[{text:t[0].text,message:new bs({content:t[0].text,additional_kwargs:e,usage_metadata:r,response_metadata:e,id:e.id})}];{const s=Fy(t);return[{text:"",message:new bs({content:t,additional_kwargs:e,tool_calls:s,usage_metadata:r,response_metadata:e,id:e.id})}]}}function Xo(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function Ig(t){let e;return t.status===400&&t.message.includes("tool")?e=Xo(t,"INVALID_TOOL_RESULTS"):t.status===401?e=Xo(t,"MODEL_AUTHENTICATION"):t.status===404?e=Xo(t,"MODEL_NOT_FOUND"):t.status===429?e=Xo(t,"MODEL_RATE_LIMIT"):e=t,e}function VP(t){return!!(t.tools&&t.tools.length>0)}function zP(t){return"input_schema"in t}function WP(t){if(typeof t.content=="string")return t.content;if(Array.isArray(t.content)&&t.content.length>=1&&"input"in t.content[0])return typeof t.content[0].input=="string"?t.content[0].input:JSON.stringify(t.content[0].input);if(Array.isArray(t.content)&&t.content.length>=1&&"text"in t.content[0])return t.content[0].text}class GP extends Sr{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"createClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.anthropicApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.anthropicApiKey)??fn("ANTHROPIC_API_KEY"),!this.anthropicApiKey&&!(e!=null&&e.createClient))throw new Error("Anthropic API key not found");this.clientOptions=(e==null?void 0:e.clientOptions)??{},this.apiKey=this.anthropicApiKey,this.apiUrl=e==null?void 0:e.anthropicApiUrl,this.modelName=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.model=this.modelName,this.invocationKwargs=(e==null?void 0:e.invocationKwargs)??{},this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topK=(e==null?void 0:e.topK)??this.topK,this.topP=(e==null?void 0:e.topP)??this.topP,this.maxTokens=(e==null?void 0:e.maxTokensToSample)??(e==null?void 0:e.maxTokens)??this.maxTokens,this.stopSequences=(e==null?void 0:e.stopSequences)??this.stopSequences,this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.createClient=(e==null?void 0:e.createClient)??(n=>new tt(n))}getLsParams(e){const n=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:n.temperature??void 0,ls_max_tokens:n.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(!(!e||!e.length))return e.map(n=>{if(zP(n))return n;if(Py(n))return{name:n.function.name,description:n.function.description,input_schema:n.function.parameters};if(Ly(n))return{name:n.name,description:n.description,input_schema:Ts(n.schema)};throw new Error(`Unknown tool type passed to ChatAnthropic: ${JSON.stringify(n,null,2)}`)})}bindTools(e,n){return this.bind({tools:this.formatStructuredToolToAnthropic(e),...n})}invocationParams(e){const n=UP(e==null?void 0:e.tool_choice);return{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:(e==null?void 0:e.stop)??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e==null?void 0:e.tools),tool_choice:n,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,n,r){var u;const s=this.invocationParams(n),a=vg(e),i=!VP({...s,...a,stream:!1}),o=await this.createStreamWithRetry({...s,...a,stream:!0},{headers:n.headers});for await(const c of o){if((u=n.signal)!=null&&u.aborted)throw o.controller.abort(),new Error("AbortError: User aborted the request.");const l=this.streamUsage??n.streamUsage,d=$P(c,{streamUsage:l,coerceContentToString:i});if(!d)continue;const{chunk:m}=d,p=WP(m),f=new ws({message:new Zt({content:m.content,additional_kwargs:m.additional_kwargs,tool_call_chunks:m.tool_call_chunks,usage_metadata:l?m.usage_metadata:void 0,response_metadata:m.response_metadata,id:m.id}),text:p??""});yield f,await(r==null?void 0:r.handleLLMNewToken(p??"",void 0,void 0,void 0,void 0,{chunk:f}))}}async _generateNonStreaming(e,n,r){const s=await this.completionWithRetry({...n,stream:!1,...vg(e)},r),{content:a,...i}=s,o=qP(a,i),{role:u,type:c,...l}=i;return{generations:o,llmOutput:l}}async _generate(e,n,r){if(this.stopSequences&&n.stop)throw new Error('"stopSequence" parameter found in input and default params');const s=this.invocationParams(n);if(s.stream){let a;const i=this._streamResponseChunks(e,n,r);for await(const o of i)a===void 0?a=o:a=a.concat(o);if(a===void 0)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:a.text,message:a.message}]}}else return this._generateNonStreaming(e,s,{signal:n.signal,headers:n.headers})}async createStreamWithRetry(e,n){if(!this.streamingClient){const s=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...s,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},n)}catch(s){throw Ig(s)}};return this.caller.call(r)}async completionWithRetry(e,n){if(!this.batchClient){const s=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.batchClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...s,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.batchClient.messages.create({...e,...this.invocationKwargs},n)}catch(s){throw Ig(s)}};return this.caller.callWithOptions({signal:n.signal??void 0},r)}_llmType(){return"anthropic"}withStructuredOutput(e,n){const r=e,s=n==null?void 0:n.name,a=n==null?void 0:n.method,i=n==null?void 0:n.includeRaw;if(a==="jsonMode")throw new Error('Anthropic only supports "functionCalling" as a method.');let o=s??"extract",u,c;if(Rf(r)){const f=Ts(r);c=[{name:o,description:f.description??"A function available to call.",input_schema:f}],u=new Ag({returnSingle:!0,keyName:o,zodSchema:r})}else{let f;typeof r.name=="string"&&typeof r.description=="string"&&typeof r.input_schema=="object"&&r.input_schema!=null?(f=r,o=r.name):f={name:o,description:r.description??"",input_schema:r},c=[f],u=new Ag({returnSingle:!0,keyName:o})}const l=this.bind({tools:c,tool_choice:{type:"tool",name:o}});if(!i)return l.pipe(u).withConfig({runName:"ChatAnthropicStructuredOutput"});const d=da.assign({parsed:(f,g)=>u.invoke(f.raw,g)}),m=da.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[m]});return cr.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}}class KP extends GP{}const mh="RFC3986",ph={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:t=>String(t)},YP="RFC1738",ZP=Array.isArray,Qn=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),sd=1024,JP=(t,e,n,r,s)=>{if(t.length===0)return t;let a=t;if(typeof t=="symbol"?a=Symbol.prototype.toString.call(t):typeof t!="string"&&(a=String(t)),n==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<a.length;o+=sd){const u=a.length>=sd?a.slice(o,o+sd):a,c=[];for(let l=0;l<u.length;++l){let d=u.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||s===YP&&(d===40||d===41)){c[c.length]=u.charAt(l);continue}if(d<128){c[c.length]=Qn[d];continue}if(d<2048){c[c.length]=Qn[192|d>>6]+Qn[128|d&63];continue}if(d<55296||d>=57344){c[c.length]=Qn[224|d>>12]+Qn[128|d>>6&63]+Qn[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=Qn[240|d>>18]+Qn[128|d>>12&63]+Qn[128|d>>6&63]+Qn[128|d&63]}i+=c.join("")}return i};function XP(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function kg(t,e){if(ZP(t)){const n=[];for(let r=0;r<t.length;r+=1)n.push(e(t[r]));return n}return e(t)}const QP=Object.prototype.hasOwnProperty,Uy={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},nr=Array.isArray,e3=Array.prototype.push,jy=function(t,e){e3.apply(t,nr(e)?e:[e])},t3=Date.prototype.toISOString,mt={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:JP,encodeValuesOnly:!1,format:mh,formatter:ph[mh],indices:!1,serializeDate(t){return t3.call(t)},skipNulls:!1,strictNullHandling:!1};function n3(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const ad={};function Hy(t,e,n,r,s,a,i,o,u,c,l,d,m,p,f,g,b,_){let y=t,S=_,I=0,A=!1;for(;(S=S.get(ad))!==void 0&&!A;){const B=S.get(t);if(I+=1,typeof B<"u"){if(B===I)throw new RangeError("Cyclic object value");A=!0}typeof S.get(ad)>"u"&&(I=0)}if(typeof c=="function"?y=c(e,y):y instanceof Date?y=m==null?void 0:m(y):n==="comma"&&nr(y)&&(y=kg(y,function(B){return B instanceof Date?m==null?void 0:m(B):B})),y===null){if(a)return u&&!g?u(e,mt.encoder,b,"key",p):e;y=""}if(n3(y)||XP(y)){if(u){const B=g?e:u(e,mt.encoder,b,"key",p);return[(f==null?void 0:f(B))+"="+(f==null?void 0:f(u(y,mt.encoder,b,"value",p)))]}return[(f==null?void 0:f(e))+"="+(f==null?void 0:f(String(y)))]}const O=[];if(typeof y>"u")return O;let w;if(n==="comma"&&nr(y))g&&u&&(y=kg(y,u)),w=[{value:y.length>0?y.join(",")||null:void 0}];else if(nr(c))w=c;else{const B=Object.keys(y);w=l?B.sort(l):B}const L=o?String(e).replace(/\./g,"%2E"):String(e),D=r&&nr(y)&&y.length===1?L+"[]":L;if(s&&nr(y)&&y.length===0)return D+"[]";for(let B=0;B<w.length;++B){const ee=w[B],K=typeof ee=="object"&&typeof ee.value<"u"?ee.value:y[ee];if(i&&K===null)continue;const Q=d&&o?ee.replace(/\./g,"%2E"):ee,x=nr(y)?typeof n=="function"?n(D,Q):D:D+(d?"."+Q:"["+Q+"]");_.set(t,I);const k=new WeakMap;k.set(ad,_),jy(O,Hy(K,x,n,r,s,a,i,o,n==="comma"&&g&&nr(y)?null:u,c,l,d,m,p,f,g,b,k))}return O}function r3(t=mt){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||mt.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=mh;if(typeof t.format<"u"){if(!QP.call(ph,t.format))throw new TypeError("Unknown format option provided.");n=t.format}const r=ph[n];let s=mt.filter;(typeof t.filter=="function"||nr(t.filter))&&(s=t.filter);let a;if(t.arrayFormat&&t.arrayFormat in Uy?a=t.arrayFormat:"indices"in t?a=t.indices?"indices":"repeat":a=mt.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:mt.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:mt.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:mt.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:mt.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?mt.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:mt.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:mt.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:mt.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:mt.encodeValuesOnly,filter:s,format:n,formatter:r,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:mt.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:mt.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:mt.strictNullHandling}}function s3(t,e={}){let n=t;const r=r3(e);let s,a;typeof r.filter=="function"?(a=r.filter,n=a("",n)):nr(r.filter)&&(a=r.filter,s=a);const i=[];if(typeof n!="object"||n===null)return"";const o=Uy[r.arrayFormat],u=o==="comma"&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const c=new WeakMap;for(let m=0;m<s.length;++m){const p=s[m];r.skipNulls&&n[p]===null||jy(i,Hy(n[p],p,o,u,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const l=i.join(r.delimiter);let d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}const zs="4.83.0";let Ng=!1,mi,$y,qy,gh,Vy,zy,Wy,Gy,Ky;function a3(t,e={auto:!1}){if(Ng)throw new Error(`you must \`import 'openai/shims/${t.kind}'\` before importing anything else from openai`);if(mi)throw new Error(`can't \`import 'openai/shims/${t.kind}'\` after \`import 'openai/shims/${mi}'\``);Ng=e.auto,mi=t.kind,$y=t.fetch,qy=t.FormData,gh=t.File,Vy=t.ReadableStream,zy=t.getMultipartRequestOptions,Wy=t.getDefaultAgent,Gy=t.fileFromPath,Ky=t.isFsReadStream}class i3{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function o3({manuallyImported:t}={}){const e=t?"You may need to use polyfills":"Add one of these imports before your first `import  from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new i3(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}mi||a3(o3(),{auto:!0});class De extends Error{}class Nt extends De{constructor(e,n,r,s){super(`${Nt.makeMessage(e,n,r)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["x-request-id"],this.error=n;const a=n;this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,n,r){const s=n!=null&&n.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,n,r,s){if(!e||!s)return new Gc({message:r,cause:_h(n)});const a=n==null?void 0:n.error;return e===400?new Yy(e,a,r,s):e===401?new Zy(e,a,r,s):e===403?new Jy(e,a,r,s):e===404?new Xy(e,a,r,s):e===409?new Qy(e,a,r,s):e===422?new e1(e,a,r,s):e===429?new t1(e,a,r,s):e>=500?new n1(e,a,r,s):new Nt(e,a,r,s)}}class Cn extends Nt{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Gc extends Nt{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),n&&(this.cause=n)}}class Kc extends Gc{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Yy extends Nt{}class Zy extends Nt{}class Jy extends Nt{}class Xy extends Nt{}class Qy extends Nt{}class e1 extends Nt{}class t1 extends Nt{}class n1 extends Nt{}class r1 extends De{constructor(){super("Could not parse response content as the length limit was reached")}}class s1 extends De{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Ss{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let n=this.decodeText(e);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];const r=Ss.NEWLINE_CHARS.has(n[n.length-1]||"");let s=n.split(Ss.NEWLINE_REGEXP);return r&&s.pop(),s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new De(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new De(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new De("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}Ss.NEWLINE_CHARS=new Set([`
`,"\r"]);Ss.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function a1(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n!=null&&n.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class lr{constructor(e,n){this.iterator=e,this.controller=n}static fromSSEResponse(e,n){let r=!1;async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const i of u3(e,n))if(!a){if(i.data.startsWith("[DONE]")){a=!0;continue}if(i.event===null){let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(o&&o.error)throw new Nt(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(i.event=="error")throw new Nt(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}a=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{a||n.abort()}}return new lr(s,n)}static fromReadableStream(e,n){let r=!1;async function*s(){const i=new Ss,o=a1(e);for await(const u of o)for(const c of i.decode(u))yield c;for(const u of i.flush())yield u}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of s())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||n.abort()}}return new lr(a,n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],n=[],r=this.iterator(),s=a=>({next:()=>{if(a.length===0){const i=r.next();e.push(i),n.push(i)}return a.shift()}});return[new lr(()=>s(e),this.controller),new lr(()=>s(n),this.controller)]}toReadableStream(){const e=this;let n;const r=new TextEncoder;return new Vy({async start(){n=e[Symbol.asyncIterator]()},async pull(s){try{const{value:a,done:i}=await n.next();if(i)return s.close();const o=r.encode(JSON.stringify(a)+`
`);s.enqueue(o)}catch(a){s.error(a)}},async cancel(){var s;await((s=n.return)==null?void 0:s.call(n))}})}}async function*u3(t,e){if(!t.body)throw e.abort(),new De("Attempted to iterate over a response with no body");const n=new d3,r=new Ss,s=a1(t.body);for await(const a of c3(s))for(const i of r.decode(a)){const o=n.decode(i);o&&(yield o)}for(const a of r.flush()){const i=n.decode(a);i&&(yield i)}}async function*c3(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let a;for(;(a=l3(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}function l3(t){for(let r=0;r<t.length-2;r++){if(t[r]===10&&t[r+1]===10||t[r]===13&&t[r+1]===13)return r+2;if(t[r]===13&&t[r+1]===10&&r+3<t.length&&t[r+2]===13&&t[r+3]===10)return r+4}return-1}class d3{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,r,s]=h3(e,":");return s.startsWith(" ")&&(s=s.substring(1)),n==="event"?this.event=s:n==="data"&&this.data.push(s),null}}function h3(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}const i1=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function",o1=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&Yc(t),Yc=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",f3=t=>o1(t)||i1(t)||Ky(t);async function u1(t,e,n){var s;if(t=await t,o1(t))return t;if(i1(t)){const a=await t.blob();e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=Yc(a)?[await a.arrayBuffer()]:[a];return new gh(i,e,n)}const r=await m3(t);if(e||(e=g3(t)??"unknown_file"),!(n!=null&&n.type)){const a=(s=r[0])==null?void 0:s.type;typeof a=="string"&&(n={...n,type:a})}return new gh(r,e,n)}async function m3(t){var n;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(Yc(t))e.push(await t.arrayBuffer());else if(b3(t))for await(const r of t)e.push(r);else throw new Error(`Unexpected data type: ${typeof t}; constructor: ${(n=t==null?void 0:t.constructor)==null?void 0:n.name}; props: ${p3(t)}`);return e}function p3(t){return`[${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}function g3(t){var e;return id(t.name)||id(t.filename)||((e=id(t.path))==null?void 0:e.split(/[\\/]/).pop())}const id=t=>{if(typeof t=="string")return t;if(typeof Buffer<"u"&&t instanceof Buffer)return String(t)},b3=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",Rg=t=>t&&typeof t=="object"&&t.body&&t[Symbol.toStringTag]==="MultipartBody",ha=async t=>{const e=await _3(t.body);return zy(e,t)},_3=async t=>{const e=new qy;return await Promise.all(Object.entries(t||{}).map(([n,r])=>bh(e,n,r))),e},bh=async(t,e,n)=>{if(n!==void 0){if(n==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")t.append(e,String(n));else if(f3(n)){const r=await u1(n);t.append(e,r)}else if(Array.isArray(n))await Promise.all(n.map(r=>bh(t,e+"[]",r)));else if(typeof n=="object")await Promise.all(Object.entries(n).map(([r,s])=>bh(t,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}};var y3=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},E3=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},Qo;async function c1(t){const{response:e}=t;if(t.options.stream)return na("response",e.status,e.url,e.headers,e.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(e,t.controller):lr.fromSSEResponse(e,t.controller);if(e.status===204)return null;if(t.options.__binaryResponse)return e;const n=e.headers.get("content-type");if((n==null?void 0:n.includes("application/json"))||(n==null?void 0:n.includes("application/vnd.api+json"))){const a=await e.json();return na("response",e.status,e.url,e.headers,a),l1(a,e)}const s=await e.text();return na("response",e.status,e.url,e.headers,s),s}function l1(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class Zc extends Promise{constructor(e,n=c1){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=n}_thenUnwrap(e){return new Zc(this.responsePromise,async n=>l1(e(await this.parseResponse(n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n,request_id:n.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class w3{constructor({baseURL:e,maxRetries:n=2,timeout:r=6e5,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=od("maxRetries",n),this.timeout=od("timeout",r),this.httpAgent=s,this.fetch=a??$y}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...v3(),...this.authHeaders(e)}}validateHeaders(e,n){}defaultIdempotencyKey(){return`stainless-node-retry-${R3()}`}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,r){return this.request(Promise.resolve(r).then(async s=>{const a=s&&Yc(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:n,...s,body:a}}))}getAPIList(e,n,r){return this.requestAPIList(n,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:n=0}={}){var f;e={...e};const{method:r,path:s,query:a,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Rg(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(s,a);"timeout"in e&&od("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const l=e.httpAgent??this.httpAgent??Wy(c),d=e.timeout+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const m=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:n});return{req:{method:r,...o&&{body:o},headers:m,...l&&{agent:l},signal:e.signal??null},url:c,timeout:e.timeout}}buildHeaders({options:e,headers:n,contentLength:r,retryCount:s}){const a={};r&&(a["content-length"]=r);const i=this.defaultHeaders(e);return Dg(a,i),Dg(a,n),Rg(e.body)&&mi!=="node"&&delete a["content-type"],tu(i,"x-stainless-retry-count")===void 0&&tu(n,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),tu(i,"x-stainless-timeout")===void 0&&tu(n,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(a,n),a}async prepareOptions(e){}async prepareRequest(e,{url:n,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(n=>[...n])):{...e}:{}}makeStatusError(e,n,r,s){return Nt.generate(e,n,r,s)}request(e,n=null){return new Zc(this.makeRequest(e,n))}async makeRequest(e,n){var d,m;const r=await e,s=r.maxRetries??this.maxRetries;n==null&&(n=s),await this.prepareOptions(r);const{req:a,url:i,timeout:o}=this.buildRequest(r,{retryCount:s-n});if(await this.prepareRequest(a,{url:i,options:r}),na("request",i,r,a.headers),(d=r.signal)!=null&&d.aborted)throw new Cn;const u=new AbortController,c=await this.fetchWithTimeout(i,a,o,u).catch(_h);if(c instanceof Error){if((m=r.signal)!=null&&m.aborted)throw new Cn;if(n)return this.retryRequest(r,n);throw c.name==="AbortError"?new Kc:new Gc({cause:c})}const l=S3(c.headers);if(!c.ok){if(n&&this.shouldRetry(c)){const y=`retrying, ${n} attempts remaining`;return na(`response (error; ${y})`,c.status,i,l),this.retryRequest(r,n,l)}const p=await c.text().catch(y=>_h(y).message),f=I3(p),g=f?void 0:p;throw na(`response (error; ${n?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,g),this.makeStatusError(c.status,f,g,l)}return{response:c,options:r,controller:u}}requestAPIList(e,n){const r=this.makeRequest(n,null);return new T3(this,r,e)}buildURL(e,n){const r=N3(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return h1(s)||(n={...s,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(r.search=this.stringifyQuery(n)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([n,r])=>typeof r<"u").map(([n,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(n)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(n)}=`;throw new De(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,n,r,s){const{signal:a,...i}=n||{};a&&a.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r),u={signal:s.signal,...i};return u.method&&(u.method=u.method.toUpperCase()),this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o)})}shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,r){let s;const a=r==null?void 0:r["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(s=o)}const i=r==null?void 0:r["retry-after"];if(i&&!s){const o=parseFloat(i);Number.isNaN(o)?s=Date.parse(i)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(n,o)}return await lo(s),this.makeRequest(e,n-1)}calculateDefaultRetryTimeoutMillis(e,n){const a=n-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${zs}`}}class d1{constructor(e,n,r,s){Qo.set(this,void 0),y3(this,Qo,e,"f"),this.options=s,this.response=n,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new De("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const n={...this.options};if("params"in e&&typeof n.query=="object")n.query={...n.query,...e.params};else if("url"in e){const r=[...Object.entries(n.query||{}),...e.url.searchParams.entries()];for(const[s,a]of r)e.url.searchParams.set(s,a);n.query=void 0,n.path=e.url.toString()}return await E3(this,Qo,"f").requestAPIList(this.constructor,n)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Qo=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}}class T3 extends Zc{constructor(e,n,r){super(n,async s=>new r(e,s.response,await c1(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}}const S3=t=>new Proxy(Object.fromEntries(t.entries()),{get(e,n){const r=n.toString();return e[r.toLowerCase()]||e[r]}}),A3={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},nn=t=>typeof t=="object"&&t!==null&&!h1(t)&&Object.keys(t).every(e=>f1(A3,e)),C3=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":xg(Deno.build.os),"X-Stainless-Arch":Pg(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":xg(process.platform),"X-Stainless-Arch":Pg(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const t=O3();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function O3(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const r=n.exec(navigator.userAgent);if(r){const s=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${s}.${a}.${i}`}}}return null}const Pg=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",xg=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let Lg;const v3=()=>Lg??(Lg=C3()),I3=t=>{try{return JSON.parse(t)}catch{return}},k3=/^[a-z][a-z0-9+.-]*:/i,N3=t=>k3.test(t),lo=t=>new Promise(e=>setTimeout(e,t)),od=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new De(`${t} must be an integer`);if(e<0)throw new De(`${t} must be a positive integer`);return e},_h=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null)try{return new Error(JSON.stringify(t))}catch{}return new Error(t)},eu=t=>{var e,n,r,s,a;if(typeof process<"u")return((n=(e=process.env)==null?void 0:e[t])==null?void 0:n.trim())??void 0;if(typeof Deno<"u")return(a=(s=(r=Deno.env)==null?void 0:r.get)==null?void 0:s.call(r,t))==null?void 0:a.trim()};function h1(t){if(!t)return!0;for(const e in t)return!1;return!0}function f1(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Dg(t,e){for(const n in e){if(!f1(e,n))continue;const r=n.toLowerCase();if(!r)continue;const s=e[n];s===null?delete t[r]:s!==void 0&&(t[r]=s)}}const Mg=new Set(["authorization","api-key"]);function na(t,...e){var n;if(typeof process<"u"&&((n=process==null?void 0:process.env)==null?void 0:n.DEBUG)==="true"){const r=e.map(s=>{if(!s)return s;if(s.headers){const i={...s,headers:{...s.headers}};for(const o in s.headers)Mg.has(o.toLowerCase())&&(i.headers[o]="REDACTED");return i}let a=null;for(const i in s)Mg.has(i.toLowerCase())&&(a??(a={...s}),a[i]="REDACTED");return a??s});console.log(`OpenAI:DEBUG:${t}`,...r)}}const R3=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),P3=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",x3=t=>typeof(t==null?void 0:t.get)=="function",tu=(t,e)=>{var r;const n=e.toLowerCase();if(x3(t)){const s=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,i,o)=>i+o.toUpperCase());for(const a of[e,n,e.toUpperCase(),s]){const i=t.get(a);if(i)return i}}for(const[s,a]of Object.entries(t))if(s.toLowerCase()===n)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a};function ud(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}class L3 extends d1{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Kn extends d1{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const n=Object.fromEntries(e.url.searchParams);return Object.keys(n).length?n:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const n=(r=e[e.length-1])==null?void 0:r.id;return n?{params:{after:n}}:null}}class Ve{constructor(e){this._client=e}}let m1=class extends Ve{create(e,n){return this._client.post("/chat/completions",{body:e,...n,stream:e.stream??!1})}},Pf=class extends Ve{constructor(){super(...arguments),this.completions=new m1(this._client)}};Pf.Completions=m1;class p1 extends Ve{create(e,n){return this._client.post("/audio/speech",{body:e,...n,headers:{Accept:"application/octet-stream",...n==null?void 0:n.headers},__binaryResponse:!0})}}class g1 extends Ve{create(e,n){return this._client.post("/audio/transcriptions",ha({body:e,...n,__metadata:{model:e.model}}))}}class b1 extends Ve{create(e,n){return this._client.post("/audio/translations",ha({body:e,...n,__metadata:{model:e.model}}))}}class ho extends Ve{constructor(){super(...arguments),this.transcriptions=new g1(this._client),this.translations=new b1(this._client),this.speech=new p1(this._client)}}ho.Transcriptions=g1;ho.Translations=b1;ho.Speech=p1;class xf extends Ve{create(e,n){return this._client.post("/batches",{body:e,...n})}retrieve(e,n){return this._client.get(`/batches/${e}`,n)}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/batches",Lf,{query:e,...n})}cancel(e,n){return this._client.post(`/batches/${e}/cancel`,n)}}class Lf extends Kn{}xf.BatchesPage=Lf;class Df extends Ve{create(e,n){return this._client.post("/assistants",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/assistants/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/assistants/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/assistants",Mf,{query:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,n){return this._client.delete(`/assistants/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class Mf extends Kn{}Df.AssistantsPage=Mf;function Bg(t){return typeof t.parse=="function"}const ra=t=>(t==null?void 0:t.role)==="assistant",_1=t=>(t==null?void 0:t.role)==="function",y1=t=>(t==null?void 0:t.role)==="tool";var Ln=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},nt=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},yh,bu,_u,ei,ti,yu,ni,yr,ri,Ju,Xu,Ws,E1;class w1{constructor(){yh.add(this),this.controller=new AbortController,bu.set(this,void 0),_u.set(this,()=>{}),ei.set(this,()=>{}),ti.set(this,void 0),yu.set(this,()=>{}),ni.set(this,()=>{}),yr.set(this,{}),ri.set(this,!1),Ju.set(this,!1),Xu.set(this,!1),Ws.set(this,!1),Ln(this,bu,new Promise((e,n)=>{Ln(this,_u,e,"f"),Ln(this,ei,n,"f")}),"f"),Ln(this,ti,new Promise((e,n)=>{Ln(this,yu,e,"f"),Ln(this,ni,n,"f")}),"f"),nt(this,bu,"f").catch(()=>{}),nt(this,ti,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},nt(this,yh,"m",E1).bind(this))},0)}_connected(){this.ended||(nt(this,_u,"f").call(this),this._emit("connect"))}get ended(){return nt(this,ri,"f")}get errored(){return nt(this,Ju,"f")}get aborted(){return nt(this,Xu,"f")}abort(){this.controller.abort()}on(e,n){return(nt(this,yr,"f")[e]||(nt(this,yr,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=nt(this,yr,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(nt(this,yr,"f")[e]||(nt(this,yr,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{Ln(this,Ws,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){Ln(this,Ws,!0,"f"),await nt(this,ti,"f")}_emit(e,...n){if(nt(this,ri,"f"))return;e==="end"&&(Ln(this,ri,!0,"f"),nt(this,yu,"f").call(this));const r=nt(this,yr,"f")[e];if(r&&(nt(this,yr,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!nt(this,Ws,"f")&&!(r!=null&&r.length)&&Promise.reject(s),nt(this,ei,"f").call(this,s),nt(this,ni,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!nt(this,Ws,"f")&&!(r!=null&&r.length)&&Promise.reject(s),nt(this,ei,"f").call(this,s),nt(this,ni,"f").call(this,s),this._emit("end")}}_emitFinal(){}}bu=new WeakMap,_u=new WeakMap,ei=new WeakMap,ti=new WeakMap,yu=new WeakMap,ni=new WeakMap,yr=new WeakMap,ri=new WeakMap,Ju=new WeakMap,Xu=new WeakMap,Ws=new WeakMap,yh=new WeakSet,E1=function(e){if(Ln(this,Ju,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Cn),e instanceof Cn)return Ln(this,Xu,!0,"f"),this._emit("abort",e);if(e instanceof De)return this._emit("error",e);if(e instanceof Error){const n=new De(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new De(String(e)))};function D3(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function T1(t){return(t==null?void 0:t.$brand)==="auto-parseable-response-format"}function M3(t,{parser:e,callback:n}){const r={...t};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:n,enumerable:!1}}),r}function fo(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function B3(t,e){return!e||!S1(e)?{...t,choices:t.choices.map(n=>({...n,message:{...n.message,parsed:null,tool_calls:n.message.tool_calls??[]}}))}:Bf(t,e)}function Bf(t,e){const n=t.choices.map(r=>{var s;if(r.finish_reason==="length")throw new r1;if(r.finish_reason==="content_filter")throw new s1;return{...r,message:{...r.message,tool_calls:((s=r.message.tool_calls)==null?void 0:s.map(a=>U3(e,a)))??[],parsed:r.message.content&&!r.message.refusal?F3(e,r.message.content):null}}});return{...t,choices:n}}function F3(t,e){var n,r;return((n=t.response_format)==null?void 0:n.type)!=="json_schema"?null:((r=t.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function U3(t,e){var r;const n=(r=t.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:fo(n)?n.$parseRaw(e.function.arguments):n!=null&&n.function.strict?JSON.parse(e.function.arguments):null}}}function j3(t,e){var r;if(!t)return!1;const n=(r=t.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return fo(n)||(n==null?void 0:n.function.strict)||!1}function S1(t){var e;return T1(t.response_format)?!0:((e=t.tools)==null?void 0:e.some(n=>fo(n)||n.type==="function"&&n.function.strict===!0))??!1}function H3(t){for(const e of t??[]){if(e.type!=="function")throw new De(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new De(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Kt=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},Rt,Eh,Qu,wh,Th,Sh,A1,Ah;const Fg=10;class C1 extends w1{constructor(){super(...arguments),Rt.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const n=(r=e.choices[0])==null?void 0:r.message;return n&&this._addMessage(n),e}_addMessage(e,n=!0){if("content"in e||(e.content=null),this.messages.push(e),n){if(this._emit("message",e),(_1(e)||y1(e))&&e.content)this._emit("functionCallResult",e.content);else if(ra(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(ra(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new De("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Kt(this,Rt,"m",Eh).call(this)}async finalMessage(){return await this.done(),Kt(this,Rt,"m",Qu).call(this)}async finalFunctionCall(){return await this.done(),Kt(this,Rt,"m",wh).call(this)}async finalFunctionCallResult(){return await this.done(),Kt(this,Rt,"m",Th).call(this)}async totalUsage(){return await this.done(),Kt(this,Rt,"m",Sh).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const n=Kt(this,Rt,"m",Qu).call(this);n&&this._emit("finalMessage",n);const r=Kt(this,Rt,"m",Eh).call(this);r&&this._emit("finalContent",r);const s=Kt(this,Rt,"m",wh).call(this);s&&this._emit("finalFunctionCall",s);const a=Kt(this,Rt,"m",Th).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",Kt(this,Rt,"m",Sh).call(this))}async _createChatCompletion(e,n,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Kt(this,Rt,"m",A1).call(this,n);const a=await e.chat.completions.create({...n,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Bf(a,n))}async _runChatCompletion(e,n,r){for(const s of n.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,n,r)}async _runFunctions(e,n,r){var m;const s="function",{function_call:a="auto",stream:i,...o}=n,u=typeof a!="string"&&(a==null?void 0:a.name),{maxChatCompletions:c=Fg}=r||{},l={};for(const p of n.functions)l[p.name||p.function.name]=p;const d=n.functions.map(p=>({name:p.name||p.function.name,parameters:p.parameters,description:p.description}));for(const p of n.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){const g=(m=(await this._createChatCompletion(e,{...o,function_call:a,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:m.message;if(!g)throw new De("missing message in ChatCompletion response");if(!g.function_call)return;const{name:b,arguments:_}=g.function_call,y=l[b];if(y){if(u&&u!==b){const O=`Invalid function_call: ${JSON.stringify(b)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,name:b,content:O});continue}}else{const O=`Invalid function_call: ${JSON.stringify(b)}. Available options are: ${d.map(w=>JSON.stringify(w.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:b,content:O});continue}let S;try{S=Bg(y)?await y.parse(_):_}catch(O){this._addMessage({role:s,name:b,content:O instanceof Error?O.message:String(O)});continue}const I=await y.function(S,this),A=Kt(this,Rt,"m",Ah).call(this,I);if(this._addMessage({role:s,name:b,content:A}),u)return}}async _runTools(e,n,r){var p,f,g;const s="tool",{tool_choice:a="auto",stream:i,...o}=n,u=typeof a!="string"&&((p=a==null?void 0:a.function)==null?void 0:p.name),{maxChatCompletions:c=Fg}=r||{},l=n.tools.map(b=>{if(fo(b)){if(!b.$callback)throw new De("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:b.$callback,name:b.function.name,description:b.function.description||"",parameters:b.function.parameters,parse:b.$parseRaw,strict:!0}}}return b}),d={};for(const b of l)b.type==="function"&&(d[b.function.name||b.function.function.name]=b.function);const m="tools"in n?l.map(b=>b.type==="function"?{type:"function",function:{name:b.function.name||b.function.function.name,parameters:b.function.parameters,description:b.function.description,strict:b.function.strict}}:b):void 0;for(const b of n.messages)this._addMessage(b,!1);for(let b=0;b<c;++b){const y=(f=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:m,messages:[...this.messages]},r)).choices[0])==null?void 0:f.message;if(!y)throw new De("missing message in ChatCompletion response");if(!((g=y.tool_calls)!=null&&g.length))return;for(const S of y.tool_calls){if(S.type!=="function")continue;const I=S.id,{name:A,arguments:O}=S.function,w=d[A];if(w){if(u&&u!==A){const ee=`Invalid tool_call: ${JSON.stringify(A)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,tool_call_id:I,content:ee});continue}}else{const ee=`Invalid tool_call: ${JSON.stringify(A)}. Available options are: ${Object.keys(d).map(K=>JSON.stringify(K)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:I,content:ee});continue}let L;try{L=Bg(w)?await w.parse(O):O}catch(ee){const K=ee instanceof Error?ee.message:String(ee);this._addMessage({role:s,tool_call_id:I,content:K});continue}const D=await w.function(L,this),B=Kt(this,Rt,"m",Ah).call(this,D);if(this._addMessage({role:s,tool_call_id:I,content:B}),u)return}}}}Rt=new WeakSet,Eh=function(){return Kt(this,Rt,"m",Qu).call(this).content??null},Qu=function(){let e=this.messages.length;for(;e-- >0;){const n=this.messages[e];if(ra(n)){const{function_call:r,...s}=n,a={...s,content:n.content??null,refusal:n.refusal??null};return r&&(a.function_call=r),a}}throw new De("stream ended without producing a ChatCompletionMessage with role=assistant")},wh=function(){var e,n;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(ra(s)&&(s!=null&&s.function_call))return s.function_call;if(ra(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(n=s.tool_calls.at(-1))==null?void 0:n.function}},Th=function(){for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];if(_1(n)&&n.content!=null||y1(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(a=>a.type==="function"&&a.id===n.tool_call_id))}))return n.content}},Sh=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:n}of this._chatCompletions)n&&(e.completion_tokens+=n.completion_tokens,e.prompt_tokens+=n.prompt_tokens,e.total_tokens+=n.total_tokens);return e},A1=function(e){if(e.n!=null&&e.n>1)throw new De("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Ah=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class qi extends C1{static runFunctions(e,n,r){const s=new qi,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,n,a)),s}static runTools(e,n,r){const s=new qi,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,a)),s}_addMessage(e,n=!0){super._addMessage(e,n),ra(e)&&e.content&&this._emit("content",e.content)}}const O1=1,v1=2,I1=4,k1=8,N1=16,R1=32,P1=64,x1=128,L1=256,D1=x1|L1,M1=N1|R1|D1|P1,B1=O1|v1|M1,F1=I1|k1,$3=B1|F1,Tt={STR:O1,NUM:v1,ARR:I1,OBJ:k1,NULL:N1,BOOL:R1,NAN:P1,INFINITY:x1,MINUS_INFINITY:L1,INF:D1,SPECIAL:M1,ATOM:B1,COLLECTION:F1,ALL:$3};class q3 extends Error{}class V3 extends Error{}function z3(t,e=Tt.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return W3(t.trim(),e)}const W3=(t,e)=>{const n=t.length;let r=0;const s=m=>{throw new q3(`${m} at position ${r}`)},a=m=>{throw new V3(`${m} at position ${r}`)},i=()=>(d(),r>=n&&s("Unexpected end of input"),t[r]==='"'?o():t[r]==="{"?u():t[r]==="["?c():t.substring(r,r+4)==="null"||Tt.NULL&e&&n-r<4&&"null".startsWith(t.substring(r))?(r+=4,null):t.substring(r,r+4)==="true"||Tt.BOOL&e&&n-r<4&&"true".startsWith(t.substring(r))?(r+=4,!0):t.substring(r,r+5)==="false"||Tt.BOOL&e&&n-r<5&&"false".startsWith(t.substring(r))?(r+=5,!1):t.substring(r,r+8)==="Infinity"||Tt.INFINITY&e&&n-r<8&&"Infinity".startsWith(t.substring(r))?(r+=8,1/0):t.substring(r,r+9)==="-Infinity"||Tt.MINUS_INFINITY&e&&1<n-r&&n-r<9&&"-Infinity".startsWith(t.substring(r))?(r+=9,-1/0):t.substring(r,r+3)==="NaN"||Tt.NAN&e&&n-r<3&&"NaN".startsWith(t.substring(r))?(r+=3,NaN):l()),o=()=>{const m=r;let p=!1;for(r++;r<n&&(t[r]!=='"'||p&&t[r-1]==="\\");)p=t[r]==="\\"?!p:!1,r++;if(t.charAt(r)=='"')try{return JSON.parse(t.substring(m,++r-Number(p)))}catch(f){a(String(f))}else if(Tt.STR&e)try{return JSON.parse(t.substring(m,r-Number(p))+'"')}catch{return JSON.parse(t.substring(m,t.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},u=()=>{r++,d();const m={};try{for(;t[r]!=="}";){if(d(),r>=n&&Tt.OBJ&e)return m;const p=o();d(),r++;try{const f=i();Object.defineProperty(m,p,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(Tt.OBJ&e)return m;throw f}d(),t[r]===","&&r++}}catch{if(Tt.OBJ&e)return m;s("Expected '}' at end of object")}return r++,m},c=()=>{r++;const m=[];try{for(;t[r]!=="]";)m.push(i()),d(),t[r]===","&&r++}catch{if(Tt.ARR&e)return m;s("Expected ']' at end of array")}return r++,m},l=()=>{if(r===0){t==="-"&&Tt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t)}catch(p){if(Tt.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}a(String(p))}}const m=r;for(t[r]==="-"&&r++;t[r]&&!",]}".includes(t[r]);)r++;r==n&&!(Tt.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(t.substring(m,r))}catch{t.substring(m,r)==="-"&&Tt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t.substring(m,t.lastIndexOf("e")))}catch(f){a(String(f))}}},d=()=>{for(;r<n&&` 
\r	`.includes(t[r]);)r++};return i()},Ug=t=>z3(t,Tt.ALL^Tt.NUM);var Bs=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Ze=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},ft,br,Fs,Br,cd,nu,ld,dd,hd,ru,fd,jg;class Vi extends C1{constructor(e){super(),ft.add(this),br.set(this,void 0),Fs.set(this,void 0),Br.set(this,void 0),Bs(this,br,e,"f"),Bs(this,Fs,[],"f")}get currentChatCompletionSnapshot(){return Ze(this,Br,"f")}static fromReadableStream(e){const n=new Vi(null);return n._run(()=>n._fromReadableStream(e)),n}static createChatCompletion(e,n,r){const s=new Vi(n);return s._run(()=>s._runChatCompletion(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,n,r){var i;super._createChatCompletion;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Ze(this,ft,"m",cd).call(this);const a=await e.chat.completions.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)Ze(this,ft,"m",ld).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new Cn;return this._addChatCompletion(Ze(this,ft,"m",ru).call(this))}async _fromReadableStream(e,n){var i;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Ze(this,ft,"m",cd).call(this),this._connected();const s=lr.fromReadableStream(e,this.controller);let a;for await(const o of s)a&&a!==o.id&&this._addChatCompletion(Ze(this,ft,"m",ru).call(this)),Ze(this,ft,"m",ld).call(this,o),a=o.id;if((i=s.controller.signal)!=null&&i.aborted)throw new Cn;return this._addChatCompletion(Ze(this,ft,"m",ru).call(this))}[(br=new WeakMap,Fs=new WeakMap,Br=new WeakMap,ft=new WeakSet,cd=function(){this.ended||Bs(this,Br,void 0,"f")},nu=function(n){let r=Ze(this,Fs,"f")[n.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Ze(this,Fs,"f")[n.index]=r,r)},ld=function(n){var s,a,i,o,u,c,l,d,m,p,f,g,b,_,y;if(this.ended)return;const r=Ze(this,ft,"m",jg).call(this,n);this._emit("chunk",n,r);for(const S of n.choices){const I=r.choices[S.index];S.delta.content!=null&&((s=I.message)==null?void 0:s.role)==="assistant"&&((a=I.message)!=null&&a.content)&&(this._emit("content",S.delta.content,I.message.content),this._emit("content.delta",{delta:S.delta.content,snapshot:I.message.content,parsed:I.message.parsed})),S.delta.refusal!=null&&((i=I.message)==null?void 0:i.role)==="assistant"&&((o=I.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:S.delta.refusal,snapshot:I.message.refusal}),((u=S.logprobs)==null?void 0:u.content)!=null&&((c=I.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=S.logprobs)==null?void 0:l.content,snapshot:((d=I.logprobs)==null?void 0:d.content)??[]}),((m=S.logprobs)==null?void 0:m.refusal)!=null&&((p=I.message)==null?void 0:p.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(f=S.logprobs)==null?void 0:f.refusal,snapshot:((g=I.logprobs)==null?void 0:g.refusal)??[]});const A=Ze(this,ft,"m",nu).call(this,I);I.finish_reason&&(Ze(this,ft,"m",hd).call(this,I),A.current_tool_call_index!=null&&Ze(this,ft,"m",dd).call(this,I,A.current_tool_call_index));for(const O of S.delta.tool_calls??[])A.current_tool_call_index!==O.index&&(Ze(this,ft,"m",hd).call(this,I),A.current_tool_call_index!=null&&Ze(this,ft,"m",dd).call(this,I,A.current_tool_call_index)),A.current_tool_call_index=O.index;for(const O of S.delta.tool_calls??[]){const w=(b=I.message.tool_calls)==null?void 0:b[O.index];w!=null&&w.type&&((w==null?void 0:w.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(_=w.function)==null?void 0:_.name,index:O.index,arguments:w.function.arguments,parsed_arguments:w.function.parsed_arguments,arguments_delta:((y=O.function)==null?void 0:y.arguments)??""}):(w==null||w.type,void 0))}}},dd=function(n,r){var i,o,u;if(Ze(this,ft,"m",nu).call(this,n).done_tool_calls.has(r))return;const a=(i=n.message.tool_calls)==null?void 0:i[r];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const c=(u=(o=Ze(this,br,"f"))==null?void 0:o.tools)==null?void 0:u.find(l=>l.type==="function"&&l.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:r,arguments:a.function.arguments,parsed_arguments:fo(c)?c.$parseRaw(a.function.arguments):c!=null&&c.function.strict?JSON.parse(a.function.arguments):null})}else a.type},hd=function(n){var s,a;const r=Ze(this,ft,"m",nu).call(this,n);if(n.message.content&&!r.content_done){r.content_done=!0;const i=Ze(this,ft,"m",fd).call(this);this._emit("content.done",{content:n.message.content,parsed:i?i.$parseRaw(n.message.content):null})}n.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:n.message.refusal})),(s=n.logprobs)!=null&&s.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:n.logprobs.content})),(a=n.logprobs)!=null&&a.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:n.logprobs.refusal}))},ru=function(){if(this.ended)throw new De("stream has ended, this shouldn't happen");const n=Ze(this,Br,"f");if(!n)throw new De("request ended without sending any chunks");return Bs(this,Br,void 0,"f"),Bs(this,Fs,[],"f"),G3(n,Ze(this,br,"f"))},fd=function(){var r;const n=(r=Ze(this,br,"f"))==null?void 0:r.response_format;return T1(n)?n:null},jg=function(n){var r,s,a,i;let o=Ze(this,Br,"f");const{choices:u,...c}=n;o?Object.assign(o,c):o=Bs(this,Br,{...c,choices:[]},"f");for(const{delta:l,finish_reason:d,index:m,logprobs:p=null,...f}of n.choices){let g=o.choices[m];if(g||(g=o.choices[m]={finish_reason:d,index:m,message:{},logprobs:p,...f}),p)if(!g.logprobs)g.logprobs=Object.assign({},p);else{const{content:O,refusal:w,...L}=p;Object.assign(g.logprobs,L),O&&((r=g.logprobs).content??(r.content=[]),g.logprobs.content.push(...O)),w&&((s=g.logprobs).refusal??(s.refusal=[]),g.logprobs.refusal.push(...w))}if(d&&(g.finish_reason=d,Ze(this,br,"f")&&S1(Ze(this,br,"f")))){if(d==="length")throw new r1;if(d==="content_filter")throw new s1}if(Object.assign(g,f),!l)continue;const{content:b,refusal:_,function_call:y,role:S,tool_calls:I,...A}=l;if(Object.assign(g.message,A),_&&(g.message.refusal=(g.message.refusal||"")+_),S&&(g.message.role=S),y&&(g.message.function_call?(y.name&&(g.message.function_call.name=y.name),y.arguments&&((a=g.message.function_call).arguments??(a.arguments=""),g.message.function_call.arguments+=y.arguments)):g.message.function_call=y),b&&(g.message.content=(g.message.content||"")+b,!g.message.refusal&&Ze(this,ft,"m",fd).call(this)&&(g.message.parsed=Ug(g.message.content))),I){g.message.tool_calls||(g.message.tool_calls=[]);for(const{index:O,id:w,type:L,function:D,...B}of I){const ee=(i=g.message.tool_calls)[O]??(i[O]={});Object.assign(ee,B),w&&(ee.id=w),L&&(ee.type=L),D&&(ee.function??(ee.function={name:D.name??"",arguments:""})),D!=null&&D.name&&(ee.function.name=D.name),D!=null&&D.arguments&&(ee.function.arguments+=D.arguments,j3(Ze(this,br,"f"),ee)&&(ee.function.parsed_arguments=Ug(ee.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("chunk",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new lr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function G3(t,e){const{id:n,choices:r,created:s,model:a,system_fingerprint:i,...o}=t,u={...o,id:n,choices:r.map(({message:c,finish_reason:l,index:d,logprobs:m,...p})=>{if(!l)throw new De(`missing finish_reason for choice ${d}`);const{content:f=null,function_call:g,tool_calls:b,..._}=c,y=c.role;if(!y)throw new De(`missing role for choice ${d}`);if(g){const{arguments:S,name:I}=g;if(S==null)throw new De(`missing function_call.arguments for choice ${d}`);if(!I)throw new De(`missing function_call.name for choice ${d}`);return{...p,message:{content:f,function_call:{arguments:S,name:I},role:y,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:m}}return b?{...p,index:d,finish_reason:l,logprobs:m,message:{..._,role:y,content:f,refusal:c.refusal??null,tool_calls:b.map((S,I)=>{const{function:A,type:O,id:w,...L}=S,{arguments:D,name:B,...ee}=A||{};if(w==null)throw new De(`missing choices[${d}].tool_calls[${I}].id
${su(t)}`);if(O==null)throw new De(`missing choices[${d}].tool_calls[${I}].type
${su(t)}`);if(B==null)throw new De(`missing choices[${d}].tool_calls[${I}].function.name
${su(t)}`);if(D==null)throw new De(`missing choices[${d}].tool_calls[${I}].function.arguments
${su(t)}`);return{...L,id:w,type:O,function:{...ee,name:B,arguments:D}}})}}:{...p,message:{..._,content:f,role:y,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:m}}),created:s,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return B3(u,e)}function su(t){return JSON.stringify(t)}class sa extends Vi{static fromReadableStream(e){const n=new sa(null);return n._run(()=>n._fromReadableStream(e)),n}static runFunctions(e,n,r){const s=new sa(null),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,n,a)),s}static runTools(e,n,r){const s=new sa(n),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,a)),s}}let U1=class extends Ve{parse(e,n){return H3(e.tools),this._client.chat.completions.create(e,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>Bf(r,e))}runFunctions(e,n){return e.stream?sa.runFunctions(this._client,e,n):qi.runFunctions(this._client,e,n)}runTools(e,n){return e.stream?sa.runTools(this._client,e,n):qi.runTools(this._client,e,n)}stream(e,n){return Vi.createChatCompletion(this._client,e,n)}},j1=class extends Ve{constructor(){super(...arguments),this.completions=new U1(this._client)}};(function(t){t.Completions=U1})(j1);class H1 extends Ve{create(e,n){return this._client.post("/realtime/sessions",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class Ff extends Ve{constructor(){super(...arguments),this.sessions=new H1(this._client)}}Ff.Sessions=H1;var ue=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},rn=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},kt,Ch,rr,Eu,Dn,us,Zs,ns,ec,an,wu,Tu,pi,si,ai,Hg,$g,qg,Vg,zg,Wg,Gg;class Fn extends w1{constructor(){super(...arguments),kt.add(this),Ch.set(this,[]),rr.set(this,{}),Eu.set(this,{}),Dn.set(this,void 0),us.set(this,void 0),Zs.set(this,void 0),ns.set(this,void 0),ec.set(this,void 0),an.set(this,void 0),wu.set(this,void 0),Tu.set(this,void 0),pi.set(this,void 0)}[(Ch=new WeakMap,rr=new WeakMap,Eu=new WeakMap,Dn=new WeakMap,us=new WeakMap,Zs=new WeakMap,ns=new WeakMap,ec=new WeakMap,an=new WeakMap,wu=new WeakMap,Tu=new WeakMap,pi=new WeakMap,kt=new WeakSet,Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const n=new Fn;return n._run(()=>n._fromReadableStream(e)),n}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=lr.fromReadableStream(e,this.controller);for await(const i of s)ue(this,kt,"m",si).call(this,i);if((a=s.controller.signal)!=null&&a.aborted)throw new Cn;return this._addRun(ue(this,kt,"m",ai).call(this))}toReadableStream(){return new lr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,n,r,s,a){const i=new Fn;return i._run(()=>i._runToolAssistantStream(e,n,r,s,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,n,r,s,a){var c;const i=a==null?void 0:a.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const o={...s,stream:!0},u=await e.submitToolOutputs(n,r,o,{...a,signal:this.controller.signal});this._connected();for await(const l of u)ue(this,kt,"m",si).call(this,l);if((c=u.controller.signal)!=null&&c.aborted)throw new Cn;return this._addRun(ue(this,kt,"m",ai).call(this))}static createThreadAssistantStream(e,n,r){const s=new Fn;return s._run(()=>s._threadAssistantStream(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,n,r,s){const a=new Fn;return a._run(()=>a._runAssistantStream(e,n,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return ue(this,wu,"f")}currentRun(){return ue(this,Tu,"f")}currentMessageSnapshot(){return ue(this,Dn,"f")}currentRunStepSnapshot(){return ue(this,pi,"f")}async finalRunSteps(){return await this.done(),Object.values(ue(this,rr,"f"))}async finalMessages(){return await this.done(),Object.values(ue(this,Eu,"f"))}async finalRun(){if(await this.done(),!ue(this,us,"f"))throw Error("Final run was not received.");return ue(this,us,"f")}async _createThreadAssistantStream(e,n,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await e.createAndRun(a,{...r,signal:this.controller.signal});this._connected();for await(const u of i)ue(this,kt,"m",si).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new Cn;return this._addRun(ue(this,kt,"m",ai).call(this))}async _createAssistantStream(e,n,r,s){var u;const a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...r,stream:!0},o=await e.create(n,i,{...s,signal:this.controller.signal});this._connected();for await(const c of o)ue(this,kt,"m",si).call(this,c);if((u=o.controller.signal)!=null&&u.aborted)throw new Cn;return this._addRun(ue(this,kt,"m",ai).call(this))}static accumulateDelta(e,n){for(const[r,s]of Object.entries(n)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let a=e[r];if(a==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof a=="string"&&typeof s=="string")a+=s;else if(typeof a=="number"&&typeof s=="number")a+=s;else if(ud(a)&&ud(s))a=this.accumulateDelta(a,s);else if(Array.isArray(a)&&Array.isArray(s)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...s);continue}for(const i of s){if(!ud(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const u=a[o];u==null?a.push(i):a[o]=this.accumulateDelta(u,i)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${a}`);e[r]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,n,r){return await this._createThreadAssistantStream(n,e,r)}async _runAssistantStream(e,n,r,s){return await this._createAssistantStream(n,e,r,s)}async _runToolAssistantStream(e,n,r,s,a){return await this._createToolAssistantStream(r,e,n,s,a)}}si=function(e){if(!this.ended)switch(rn(this,wu,e,"f"),ue(this,kt,"m",qg).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":ue(this,kt,"m",Gg).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ue(this,kt,"m",$g).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":ue(this,kt,"m",Hg).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},ai=function(){if(this.ended)throw new De("stream has ended, this shouldn't happen");if(!ue(this,us,"f"))throw Error("Final run has not been received");return ue(this,us,"f")},Hg=function(e){const[n,r]=ue(this,kt,"m",zg).call(this,e,ue(this,Dn,"f"));rn(this,Dn,n,"f"),ue(this,Eu,"f")[n.id]=n;for(const s of r){const a=n.content[s.index];(a==null?void 0:a.type)=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,n),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let a=s.text,i=n.content[s.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=ue(this,Zs,"f")){if(ue(this,ns,"f"))switch(ue(this,ns,"f").type){case"text":this._emit("textDone",ue(this,ns,"f").text,ue(this,Dn,"f"));break;case"image_file":this._emit("imageFileDone",ue(this,ns,"f").image_file,ue(this,Dn,"f"));break}rn(this,Zs,s.index,"f")}rn(this,ns,n.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(ue(this,Zs,"f")!==void 0){const s=e.data.content[ue(this,Zs,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,ue(this,Dn,"f"));break;case"text":this._emit("textDone",s.text,ue(this,Dn,"f"));break}}ue(this,Dn,"f")&&this._emit("messageDone",e.data),rn(this,Dn,void 0,"f")}},$g=function(e){const n=ue(this,kt,"m",Vg).call(this,e);switch(rn(this,pi,n,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&n.step_details.type=="tool_calls")for(const a of r.step_details.tool_calls)a.index==ue(this,ec,"f")?this._emit("toolCallDelta",a,n.step_details.tool_calls[a.index]):(ue(this,an,"f")&&this._emit("toolCallDone",ue(this,an,"f")),rn(this,ec,a.index,"f"),rn(this,an,n.step_details.tool_calls[a.index],"f"),ue(this,an,"f")&&this._emit("toolCallCreated",ue(this,an,"f")));this._emit("runStepDelta",e.data.delta,n);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":rn(this,pi,void 0,"f"),e.data.step_details.type=="tool_calls"&&ue(this,an,"f")&&(this._emit("toolCallDone",ue(this,an,"f")),rn(this,an,void 0,"f")),this._emit("runStepDone",e.data,n);break}},qg=function(e){ue(this,Ch,"f").push(e),this._emit("event",e)},Vg=function(e){switch(e.event){case"thread.run.step.created":return ue(this,rr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let n=ue(this,rr,"f")[e.data.id];if(!n)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const s=Fn.accumulateDelta(n,r.delta);ue(this,rr,"f")[e.data.id]=s}return ue(this,rr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":ue(this,rr,"f")[e.data.id]=e.data;break}if(ue(this,rr,"f")[e.data.id])return ue(this,rr,"f")[e.data.id];throw new Error("No snapshot available")},zg=function(e,n){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!n)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const a of s.delta.content)if(a.index in n.content){let i=n.content[a.index];n.content[a.index]=ue(this,kt,"m",Wg).call(this,a,i)}else n.content[a.index]=a,r.push(a);return[n,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(n)return[n,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Wg=function(e,n){return Fn.accumulateDelta(n,e)},Gg=function(e){switch(rn(this,Tu,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":rn(this,us,e.data,"f"),ue(this,an,"f")&&(this._emit("toolCallDone",ue(this,an,"f")),rn(this,an,void 0,"f"));break}};class Uf extends Ve{create(e,n,r){return this._client.post(`/threads/${e}/messages`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/threads/${e}/messages/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,n,r,s){return this._client.post(`/threads/${e}/messages/${n}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/threads/${e}/messages`,jf,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n,r){return this._client.delete(`/threads/${e}/messages/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class jf extends Kn{}Uf.MessagesPage=jf;class Hf extends Ve{retrieve(e,n,r,s={},a){return nn(s)?this.retrieve(e,n,r,{},s):this._client.get(`/threads/${e}/runs/${n}/steps/${r}`,{query:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,n,r={},s){return nn(r)?this.list(e,n,{},r):this._client.getAPIList(`/threads/${e}/runs/${n}/steps`,$f,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}}class $f extends Kn{}Hf.RunStepsPage=$f;class mo extends Ve{constructor(){super(...arguments),this.steps=new Hf(this._client)}create(e,n,r){const{include:s,...a}=n;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:n.stream??!1})}retrieve(e,n,r){return this._client.get(`/threads/${e}/runs/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,n,r,s){return this._client.post(`/threads/${e}/runs/${n}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/threads/${e}/runs`,qf,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,n,r){return this._client.post(`/threads/${e}/runs/${n}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}createAndStream(e,n,r){return Fn.createAssistantStream(e,this._client.beta.threads.runs,n,r)}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,n,{...r,headers:{...r==null?void 0:r.headers,...s}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await lo(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,n,r){return Fn.createAssistantStream(e,this._client.beta.threads.runs,n,r)}submitToolOutputs(e,n,r,s){return this._client.post(`/threads/${e}/runs/${n}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,n,r,s){const a=await this.submitToolOutputs(e,n,r,s);return await this.poll(e,a.id,s)}submitToolOutputsStream(e,n,r,s){return Fn.createToolAssistantStream(e,n,this._client.beta.threads.runs,r,s)}}class qf extends Kn{}mo.RunsPage=qf;mo.Steps=Hf;mo.RunStepsPage=$f;class Ca extends Ve{constructor(){super(...arguments),this.runs=new mo(this._client),this.messages=new Uf(this._client)}create(e={},n){return nn(e)?this.create({},e):this._client.post("/threads",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/threads/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/threads/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n){return this._client.delete(`/threads/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}createAndRun(e,n){return this._client.post("/threads/runs",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers},stream:e.stream??!1})}async createAndRunPoll(e,n){const r=await this.createAndRun(e,n);return await this.runs.poll(r.thread_id,r.id,n)}createAndRunStream(e,n){return Fn.createThreadAssistantStream(e,this._client.beta.threads,n)}}Ca.Runs=mo;Ca.RunsPage=qf;Ca.Messages=Uf;Ca.MessagesPage=jf;const K3=async t=>{const e=await Promise.allSettled(t),n=e.filter(s=>s.status==="rejected");if(n.length){for(const s of n)console.error(s.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const s of e)s.status==="fulfilled"&&r.push(s.value);return r};let Vf=class extends Ve{create(e,n,r){return this._client.post(`/vector_stores/${e}/files`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/vector_stores/${e}/files/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/vector_stores/${e}/files`,Jc,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n,r){return this._client.delete(`/vector_stores/${e}/files/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const a=await this.retrieve(e,n,{...r,headers:s}).withResponse(),i=a.data;switch(i.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=a.response.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await lo(o);break;case"failed":case"completed":return i}}}async upload(e,n,r){const s=await this._client.files.create({file:n,purpose:"assistants"},r);return this.create(e,{file_id:s.id},r)}async uploadAndPoll(e,n,r){const s=await this.upload(e,n,r);return await this.poll(e,s.id,r)}};class Jc extends Kn{}Vf.VectorStoreFilesPage=Jc;class $1 extends Ve{create(e,n,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/vector_stores/${e}/file_batches/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,n,r){return this._client.post(`/vector_stores/${e}/file_batches/${n}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n);return await this.poll(e,s.id,r)}listFiles(e,n,r={},s){return nn(r)?this.listFiles(e,n,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${n}/files`,Jc,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,n,{...r,headers:s}).withResponse();switch(a.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await lo(o);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:n,fileIds:r=[]},s){if(n==null||n.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(s==null?void 0:s.maxConcurrency)??5,i=Math.min(a,n.length),o=this._client,u=n.values(),c=[...r];async function l(m){for(let p of m){const f=await o.files.create({file:p,purpose:"assistants"},s);c.push(f.id)}}const d=Array(i).fill(u).map(l);return await K3(d),await this.createAndPoll(e,{file_ids:c})}}class Oa extends Ve{constructor(){super(...arguments),this.files=new Vf(this._client),this.fileBatches=new $1(this._client)}create(e,n){return this._client.post("/vector_stores",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/vector_stores/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/vector_stores/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/vector_stores",zf,{query:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,n){return this._client.delete(`/vector_stores/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class zf extends Kn{}Oa.VectorStoresPage=zf;Oa.Files=Vf;Oa.VectorStoreFilesPage=Jc;Oa.FileBatches=$1;class Jr extends Ve{constructor(){super(...arguments),this.realtime=new Ff(this._client),this.vectorStores=new Oa(this._client),this.chat=new j1(this._client),this.assistants=new Df(this._client),this.threads=new Ca(this._client)}}Jr.Realtime=Ff;Jr.VectorStores=Oa;Jr.VectorStoresPage=zf;Jr.Assistants=Df;Jr.AssistantsPage=Mf;Jr.Threads=Ca;class q1 extends Ve{create(e,n){return this._client.post("/completions",{body:e,...n,stream:e.stream??!1})}}class V1 extends Ve{create(e,n){return this._client.post("/embeddings",{body:e,...n})}}class Wf extends Ve{create(e,n){return this._client.post("/files",ha({body:e,...n}))}retrieve(e,n){return this._client.get(`/files/${e}`,n)}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/files",Gf,{query:e,...n})}del(e,n){return this._client.delete(`/files/${e}`,n)}content(e,n){return this._client.get(`/files/${e}/content`,{...n,headers:{Accept:"application/binary",...n==null?void 0:n.headers},__binaryResponse:!0})}retrieveContent(e,n){return this._client.get(`/files/${e}/content`,n)}async waitForProcessing(e,{pollInterval:n=5e3,maxWait:r=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!s.has(i.status);)if(await lo(n),i=await this.retrieve(e),Date.now()-a>r)throw new Kc({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}}class Gf extends Kn{}Wf.FileObjectsPage=Gf;class Kf extends Ve{list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Yf,{query:n,...r})}}class Yf extends Kn{}Kf.FineTuningJobCheckpointsPage=Yf;class va extends Ve{constructor(){super(...arguments),this.checkpoints=new Kf(this._client)}create(e,n){return this._client.post("/fine_tuning/jobs",{body:e,...n})}retrieve(e,n){return this._client.get(`/fine_tuning/jobs/${e}`,n)}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Zf,{query:e,...n})}cancel(e,n){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,n)}listEvents(e,n={},r){return nn(n)?this.listEvents(e,{},n):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Jf,{query:n,...r})}}class Zf extends Kn{}class Jf extends Kn{}va.FineTuningJobsPage=Zf;va.FineTuningJobEventsPage=Jf;va.Checkpoints=Kf;va.FineTuningJobCheckpointsPage=Yf;class po extends Ve{constructor(){super(...arguments),this.jobs=new va(this._client)}}po.Jobs=va;po.FineTuningJobsPage=Zf;po.FineTuningJobEventsPage=Jf;class z1 extends Ve{createVariation(e,n){return this._client.post("/images/variations",ha({body:e,...n}))}edit(e,n){return this._client.post("/images/edits",ha({body:e,...n}))}generate(e,n){return this._client.post("/images/generations",{body:e,...n})}}class Xf extends Ve{retrieve(e,n){return this._client.get(`/models/${e}`,n)}list(e){return this._client.getAPIList("/models",Qf,e)}del(e,n){return this._client.delete(`/models/${e}`,n)}}class Qf extends L3{}Xf.ModelsPage=Qf;class W1 extends Ve{create(e,n){return this._client.post("/moderations",{body:e,...n})}}class G1 extends Ve{create(e,n,r){return this._client.post(`/uploads/${e}/parts`,ha({body:n,...r}))}}class em extends Ve{constructor(){super(...arguments),this.parts=new G1(this._client)}create(e,n){return this._client.post("/uploads",{body:e,...n})}cancel(e,n){return this._client.post(`/uploads/${e}/cancel`,n)}complete(e,n,r){return this._client.post(`/uploads/${e}/complete`,{body:n,...r})}}em.Parts=G1;var K1;let Be=class extends w3{constructor({baseURL:e=eu("OPENAI_BASE_URL"),apiKey:n=eu("OPENAI_API_KEY"),organization:r=eu("OPENAI_ORG_ID")??null,project:s=eu("OPENAI_PROJECT_ID")??null,...a}={}){if(n===void 0)throw new De("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:n,organization:r,project:s,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&P3())throw new De(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new q1(this),this.chat=new Pf(this),this.embeddings=new V1(this),this.files=new Wf(this),this.images=new z1(this),this.audio=new ho(this),this.moderations=new W1(this),this.models=new Xf(this),this.fineTuning=new po(this),this.beta=new Jr(this),this.batches=new xf(this),this.uploads=new em(this),this._options=i,this.apiKey=n,this.organization=r,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return s3(e,{arrayFormat:"brackets"})}};K1=Be;Be.OpenAI=K1;Be.DEFAULT_TIMEOUT=6e5;Be.OpenAIError=De;Be.APIError=Nt;Be.APIConnectionError=Gc;Be.APIConnectionTimeoutError=Kc;Be.APIUserAbortError=Cn;Be.NotFoundError=Xy;Be.ConflictError=Qy;Be.RateLimitError=t1;Be.BadRequestError=Yy;Be.AuthenticationError=Zy;Be.InternalServerError=n1;Be.PermissionDeniedError=Jy;Be.UnprocessableEntityError=e1;Be.toFile=u1;Be.fileFromPath=Gy;Be.Completions=q1;Be.Chat=Pf;Be.Embeddings=V1;Be.Files=Wf;Be.FileObjectsPage=Gf;Be.Images=z1;Be.Audio=ho;Be.Moderations=W1;Be.Models=Xf;Be.ModelsPage=Qf;Be.FineTuning=po;Be.Beta=Jr;Be.Batches=xf;Be.BatchesPage=Lf;Be.Uploads=em;function Y1(t,e){if(t.function===void 0)return;let n;if(e!=null&&e.partial)try{n=lf(t.function.arguments??"{}")}catch{return}else try{n=JSON.parse(t.function.arguments)}catch(s){throw new $i([`Function "${t.function.name}" arguments:`,"",t.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const r={name:t.function.name,args:n,type:"tool_call"};return e!=null&&e.returnId&&(r.id=t.id),r}function Y3(t){if(t.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.args)}}}function Z3(t,e){var n,r;return{name:(n=t.function)==null?void 0:n.name,args:(r=t.function)==null?void 0:r.arguments,id:t.id,error:e,type:"invalid_tool_call"}}class J3 extends By{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,n=!0){var i;const r=e[0].message;let s;if(ro(r)&&((i=r.tool_calls)!=null&&i.length)?s=r.tool_calls.map(o=>{const{id:u,...c}=o;return this.returnId?{id:u,...c}:c}):r.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(u=>Y1(u,{returnId:this.returnId,partial:n}))),!s)return[];const a=[];for(const o of s)if(o!==void 0){const u={type:o.name,args:o.args,id:o.id};a.push(u)}return a}}class Kg extends J3{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const n=await this.zodSchema.safeParseAsync(e);if(n.success)return n.data;throw new $i(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(n.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const r=(await super.parsePartialResult(e)).filter(a=>a.type===this.keyName);let s=r;if(r.length)return this.returnId||(s=r.map(a=>a.args)),this.returnSingle?s[0]:s}async parseResult(e){const r=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName);let s=r;return r.length?(this.returnId||(s=r.map(i=>i.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(i=>this._validateResult(i)))):void 0}}const X3=Symbol("Let zodToJsonSchema decide on which parser to use"),Yg={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Q3=t=>typeof t=="string"?{...Yg,basePath:["#"],definitions:{},name:t}:{...Yg,basePath:["#"],definitions:{},...t},Oh=t=>"_def"in t?t._def:t;function ex(t){if(!t)return!0;for(const e in t)return!1;return!0}const tx=t=>{const e=Q3(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[Oh(s),{def:Oh(s),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function Z1(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function Ke(t,e,n,r,s){t[e]=n,Z1(t,e,r,s)}function nx(){return{}}function rx(t,e){var r,s;const n={type:"array"};return((s=(r=t.type)==null?void 0:r._def)==null?void 0:s.typeName)!==$.ZodAny&&(n.items=He(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&Ke(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&Ke(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(Ke(n,"minItems",t.exactLength.value,t.exactLength.message,e),Ke(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function sx(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?Ke(n,"minimum",r.value,r.message,e):Ke(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Ke(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Ke(n,"maximum",r.value,r.message,e):Ke(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Ke(n,"maximum",r.value,r.message,e));break;case"multipleOf":Ke(n,"multipleOf",r.value,r.message,e);break}return n}function ax(){return{type:"boolean"}}function ix(t,e){return He(t.type._def,e)}const ox=(t,e)=>He(t.innerType._def,e);function J1(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,a)=>J1(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return ux(t,e)}}const ux=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":Ke(n,"minimum",r.value,r.message,e);break;case"max":Ke(n,"maximum",r.value,r.message,e);break}return n};function cx(t,e){return{...He(t.innerType._def,e),default:t.defaultValue()}}function lx(t,e,n){return e.effectStrategy==="input"?He(t.schema._def,e,n):{}}function dx(t){return{type:"string",enum:[...t.values]}}const hx=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function fx(t,e){const n=[He(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),He(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(a=>{if(hx(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...u}=a;i=u}else r=void 0;s.push(i)}}),s.length?{allOf:s,...r}:void 0}function mx(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let md;const es={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(md===void 0&&(md=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),md),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function X1(t,e){const n={type:"string"};function r(s){return e.patternStrategy==="escape"?px(s):s}if(t.checks)for(const s of t.checks)switch(s.kind){case"min":Ke(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e);break;case"max":Ke(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Pn(n,"email",s.message,e);break;case"format:idn-email":Pn(n,"idn-email",s.message,e);break;case"pattern:zod":xn(n,es.email,s.message,e);break}break;case"url":Pn(n,"uri",s.message,e);break;case"uuid":Pn(n,"uuid",s.message,e);break;case"regex":xn(n,s.regex,s.message,e);break;case"cuid":xn(n,es.cuid,s.message,e);break;case"cuid2":xn(n,es.cuid2,s.message,e);break;case"startsWith":xn(n,RegExp(`^${r(s.value)}`),s.message,e);break;case"endsWith":xn(n,RegExp(`${r(s.value)}$`),s.message,e);break;case"datetime":Pn(n,"date-time",s.message,e);break;case"date":Pn(n,"date",s.message,e);break;case"time":Pn(n,"time",s.message,e);break;case"duration":Pn(n,"duration",s.message,e);break;case"length":Ke(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e),Ke(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"includes":{xn(n,RegExp(r(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&Pn(n,"ipv4",s.message,e),s.version!=="v4"&&Pn(n,"ipv6",s.message,e);break}case"emoji":xn(n,es.emoji,s.message,e);break;case"ulid":{xn(n,es.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Pn(n,"binary",s.message,e);break}case"contentEncoding:base64":{Ke(n,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{xn(n,es.base64,s.message,e);break}}break}case"nanoid":xn(n,es.nanoid,s.message,e)}return n}const px=t=>Array.from(t).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Pn=(t,e,n,r)=>{var s;t.format||(s=t.anyOf)!=null&&s.some(a=>a.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Ke(t,"format",e,n,r)},xn=(t,e,n,r)=>{var s;t.pattern||(s=t.allOf)!=null&&s.some(a=>a.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:Zg(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Ke(t,"pattern",Zg(e,r),n,r)},Zg=(t,e)=>{var c;const n=typeof t=="function"?t():t;if(!e.applyRegexFlags||!n.flags)return n.source;const r={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},s=r.i?n.source.toLowerCase():n.source;let a="",i=!1,o=!1,u=!1;for(let l=0;l<s.length;l++){if(i){a+=s[l],i=!1;continue}if(r.i){if(o){if(s[l].match(/[a-z]/)){u?(a+=s[l],a+=`${s[l-2]}-${s[l]}`.toUpperCase(),u=!1):s[l+1]==="-"&&((c=s[l+2])!=null&&c.match(/[a-z]/))?(a+=s[l],u=!0):a+=`${s[l]}${s[l].toUpperCase()}`;continue}}else if(s[l].match(/[a-z]/)){a+=`[${s[l]}${s[l].toUpperCase()}]`;continue}}if(r.m){if(s[l]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(s[l]==="$"){a+=`($|(?=[\r
]))`;continue}}if(r.s&&s[l]==="."){a+=o?`${s[l]}\r
`:`[${s[l]}\r
]`;continue}a+=s[l],s[l]==="\\"?i=!0:o&&s[l]==="]"?o=!1:!o&&s[l]==="["&&(o=!0)}try{const l=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a};function Q1(t,e){var r,s,a,i;if(e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===$.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((o,u)=>({...o,[u]:He(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:He(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===$.ZodString&&((a=t.keyType._def.checks)!=null&&a.length)){const o=Object.entries(X1(t.keyType._def,e)).reduce((u,[c,l])=>c==="type"?u:{...u,[c]:l},{});return{...n,propertyNames:o}}else if(((i=t.keyType)==null?void 0:i._def.typeName)===$.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};return n}function gx(t,e){if(e.mapStrategy==="record")return Q1(t,e);const n=He(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=He(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function bx(t){const e=t.values,r=Object.keys(t.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function _x(){return{not:{}}}function yx(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const tc={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Ex(t,e){if(e.target==="openApi3")return Jg(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in tc&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,a)=>{const i=tc[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":if(a._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:n.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return Jg(t,e)}const Jg=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>He(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function wx(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:tc[t.innerType._def.typeName],nullable:!0}:{type:[tc[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=He(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=He(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function Tx(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",Z1(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?Ke(n,"minimum",r.value,r.message,e):Ke(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),Ke(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?Ke(n,"maximum",r.value,r.message,e):Ke(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),Ke(n,"maximum",r.value,r.message,e));break;case"multipleOf":Ke(n,"multipleOf",r.value,r.message,e);break}return n}function Sx(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":He(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":He(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Ax(t,e){const n={type:"object",...Object.entries(t.shape()).reduce((r,[s,a])=>{if(a===void 0||a._def===void 0)return r;const i=He(a._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return i===void 0?r:{properties:{...r.properties,[s]:i},required:a.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,s]}},{properties:{},required:[]}),additionalProperties:Sx(t,e)};return n.required.length||delete n.required,n}const Cx=(t,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return He(t.innerType._def,e);const n=He(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},Ox=(t,e)=>{if(e.pipeStrategy==="input")return He(t.in._def,e);if(e.pipeStrategy==="output")return He(t.out._def,e);const n=He(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=He(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function vx(t,e){return He(t.type._def,e)}function Ix(t,e){const r={type:"array",uniqueItems:!0,items:He(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&Ke(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&Ke(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function kx(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>He(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:He(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>He(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function Nx(){return{not:{}}}function Rx(){return{}}const Px=(t,e)=>He(t.innerType._def,e);function He(t,e,n=!1){var i;const r=e.seen.get(t);if(e.override){const o=(i=e.override)==null?void 0:i.call(e,t,e,r,n);if(o!==X3)return o}if(r&&!n){const o=xx(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const a=Dx(t,t.typeName,e,n);return a&&Mx(t,e,a),s.jsonSchema=a,a}const xx=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"extract-to-root":const n=t.path.slice(e.basePath.length+1).join("_");return n!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[n]=t.def),{$ref:[...e.basePath,e.definitionPath,n].join("/")};case"relative":return{$ref:Lx(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((r,s)=>e.currentPath[s]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Lx=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")},Dx=(t,e,n,r)=>{switch(e){case $.ZodString:return X1(t,n);case $.ZodNumber:return Tx(t,n);case $.ZodObject:return Ax(t,n);case $.ZodBigInt:return sx(t,n);case $.ZodBoolean:return ax();case $.ZodDate:return J1(t,n);case $.ZodUndefined:return Nx();case $.ZodNull:return yx(n);case $.ZodArray:return rx(t,n);case $.ZodUnion:case $.ZodDiscriminatedUnion:return Ex(t,n);case $.ZodIntersection:return fx(t,n);case $.ZodTuple:return kx(t,n);case $.ZodRecord:return Q1(t,n);case $.ZodLiteral:return mx(t,n);case $.ZodEnum:return dx(t);case $.ZodNativeEnum:return bx(t);case $.ZodNullable:return wx(t,n);case $.ZodOptional:return Cx(t,n);case $.ZodMap:return gx(t,n);case $.ZodSet:return Ix(t,n);case $.ZodLazy:return He(t.getter()._def,n);case $.ZodPromise:return vx(t,n);case $.ZodNaN:case $.ZodNever:return _x();case $.ZodEffects:return lx(t,n,r);case $.ZodAny:return nx();case $.ZodUnknown:return Rx();case $.ZodDefault:return cx(t,n);case $.ZodBranded:return ix(t,n);case $.ZodReadonly:return Px(t,n);case $.ZodCatch:return ox(t,n);case $.ZodPipeline:return Ox(t,n);case $.ZodFunction:case $.ZodVoid:case $.ZodSymbol:return;default:return(s=>{})()}},Mx=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),Bx=(t,e)=>{const n=tx(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=He(t._def,r===void 0?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(s.title=a);const i=(()=>{if(ex(n.definitions))return;const u={},c=new Set;for(let l=0;l<500;l++){const d=Object.entries(n.definitions).filter(([m])=>!c.has(m));if(d.length===0)break;for(const[m,p]of d)u[m]=He(Oh(p),{...n,currentPath:[...n.basePath,n.definitionPath,m]},!0)??{},c.add(m)}return u})(),o=r===void 0?i?{...s,[n.definitionPath]:i}:s:n.nameStrategy==="duplicate-ref"?{...s,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[r]:s}:void 0}}:void 0}:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...i,[r]:s}};return n.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":n.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function eE(t,e){return Bx(t,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Fx(t,e,n){return D3({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:eE(t,{name:e})}},r=>t.parse(JSON.parse(r)))}function Ux(t){return M3({type:"function",function:{name:t.name,parameters:eE(t.parameters,{name:t.name}),strict:!0,...t.description?{description:t.description}:void 0}},{callback:t.function,parser:e=>t.parameters.parse(JSON.parse(e))})}function jx(t){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:a,azureADTokenProvider:i,azureOpenAIEndpoint:o}=t;if((r||i)&&s&&e)return`${s}/${e}`;if((r||i)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${e}`}return a}function au(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function Xg(t){let e;return t.constructor.name===Kc.name?(e=new Error(t.message),e.name="TimeoutError"):t.constructor.name===Cn.name?(e=new Error(t.message),e.name="AbortError"):t.status===400&&t.message.includes("tool_calls")?e=au(t,"INVALID_TOOL_RESULTS"):t.status===401?e=au(t,"MODEL_AUTHENTICATION"):t.status===429?e=au(t,"MODEL_RATE_LIMIT"):t.status===404?e=au(t,"MODEL_NOT_FOUND"):e=t,e}function Hx(t){if(t)return t==="any"||t==="required"?"required":t==="auto"?"auto":t==="none"?"none":typeof t=="string"?{type:"function",function:{name:t}}:t}function $x(t){return t.anyOf!==void 0&&Array.isArray(t.anyOf)}function qx(t){const e=["namespace functions {",""];for(const n of t)n.description&&e.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(e.push(`type ${n.name} = (_: {`),e.push(tE(n.parameters,0)),e.push("}) => any;")):e.push(`type ${n.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function tE(t,e){var r;const n=[];for(const[s,a]of Object.entries(t.properties??{}))a.description&&e<2&&n.push(`// ${a.description}`),(r=t.required)!=null&&r.includes(s)?n.push(`${s}: ${nc(a,e)},`):n.push(`${s}?: ${nc(a,e)},`);return n.map(s=>" ".repeat(e)+s).join(`
`)}function nc(t,e){if($x(t))return t.anyOf.map(n=>nc(n,e)).join(" | ");switch(t.type){case"string":return t.enum?t.enum.map(n=>`"${n}"`).join(" | "):"string";case"number":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"integer":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",tE(t,e+2),"}"].join(`
`);case"array":return t.items?`${nc(t.items,e)}[]`:"any[]";default:return""}}function Vx(t,e){let n;if(Ly(t)){const r=Ux({name:t.name,parameters:t.schema,description:t.description});r.function.parameters?n={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...(e==null?void 0:e.strict)!==void 0?{strict:e.strict}:{}}}:n={type:"function",function:LP(t,e)}}else n=t;return(e==null?void 0:e.strict)!==void 0&&(n.function.strict=e.strict),n}function zx(t){return t.role!=="system"&&t.role!=="developer"&&t.role!=="assistant"&&t.role!=="user"&&t.role!=="function"&&t.role!=="tool"&&console.warn(`Unknown message role: ${t.role}`),t.role}function nE(t){const e=t._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!so.isInstance(t))throw new Error("Invalid generic chat message");return zx(t)}default:throw new Error(`Unknown message type: ${e}`)}}function Qg(t,e){return t.flatMap(n=>{var a;let r=nE(n);r==="system"&&(e!=null&&e.startsWith("o1"))&&(r="developer");const s={role:r,content:n.content};if(n.name!=null&&(s.name=n.name),n.additional_kwargs.function_call!=null&&(s.function_call=n.additional_kwargs.function_call,s.content=null),ro(n)&&((a=n.tool_calls)!=null&&a.length)?(s.tool_calls=n.tool_calls.map(Y3),s.content=null):(n.additional_kwargs.tool_calls!=null&&(s.tool_calls=n.additional_kwargs.tool_calls),n.tool_call_id!=null&&(s.tool_call_id=n.tool_call_id)),n.additional_kwargs.audio&&typeof n.additional_kwargs.audio=="object"&&"id"in n.additional_kwargs.audio){const i={role:"assistant",audio:{id:n.additional_kwargs.audio.id}};return[s,i]}return s})}function e0(t,e){return Py(t)?(e==null?void 0:e.strict)!==void 0?{...t,function:{...t.function,strict:e.strict}}:t:Vx(t,e)}class vh extends Sr{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}constructor(e){var n,r;super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((n=e==null?void 0:e.configuration)==null?void 0:n.apiKey)??fn("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??fn("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelName=this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this==null?void 0:this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=e==null?void 0:e.reasoningEffort,this.model==="o1"&&(this.disableStreaming=!0),this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const n=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:n.temperature??void 0,ls_max_tokens:n.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,n){let r;return(n==null?void 0:n.strict)!==void 0?r=n.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(s=>e0(s,{strict:r})),...n})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&iu(e.json_schema.schema)?Fx(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,n){var o;let r;(e==null?void 0:e.strict)!==void 0?r=e.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling);let s={};(e==null?void 0:e.stream_options)!==void 0?s={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||n!=null&&n.streaming)&&(s={stream_options:{include_usage:!0}});const a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(o=e==null?void 0:e.tools)!=null&&o.length?e.tools.map(u=>e0(u,{strict:r})):void 0,tool_choice:Hx(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...s,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(a.prediction=e.prediction);const i=(e==null?void 0:e.reasoning_effort)??this.reasoningEffort;return i!==void 0&&(a.reasoning_effort=i),a}_convertOpenAIChatCompletionMessageToBaseMessage(e,n){const r=e.tool_calls;switch(e.role){case"assistant":{const s=[],a=[];for(const u of r??[])try{s.push(Y1(u,{returnId:!0}))}catch(c){a.push(Z3(u,c.message))}const i={function_call:e.function_call,tool_calls:r};this.__includeRawResponse!==void 0&&(i.__raw_response=n);const o={model_name:n.model,...n.system_fingerprint?{usage:{...n.usage},system_fingerprint:n.system_fingerprint}:{}};return e.audio&&(i.audio=e.audio),new bs({content:e.content||"",tool_calls:s,invalid_tool_calls:a,additional_kwargs:i,response_metadata:o,id:n.id})}default:return new so(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,n,r){var u,c;const s=e.role??r,a=e.content??"";let i;e.function_call?i={function_call:e.function_call}:e.tool_calls?i={tool_calls:e.tool_calls}:i={},this.__includeRawResponse&&(i.__raw_response=n),e.audio&&(i.audio={...e.audio,index:n.choices[0].index});const o={usage:{...n.usage}};if(s==="user")return new Dc({content:a,response_metadata:o});if(s==="assistant"){const l=[];if(Array.isArray(e.tool_calls))for(const d of e.tool_calls)l.push({name:(u=d.function)==null?void 0:u.name,args:(c=d.function)==null?void 0:c.arguments,id:d.id,index:d.index,type:"tool_call_chunk"});return new Zt({content:a,tool_call_chunks:l,additional_kwargs:i,id:n.id,response_metadata:o})}else return s==="system"?new Ci({content:a,response_metadata:o}):s==="developer"?new Ci({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new Lc({content:a,additional_kwargs:i,name:e.name,response_metadata:o}):s==="tool"?new df({content:a,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new xc({content:a,role:s,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,n,r){var c,l,d,m,p,f,g,b,_,y;const s=Qg(e,this.model),a={...this.invocationParams(n,{streaming:!0}),messages:s,stream:!0};let i;const o=await this.completionWithRetry(a,n);let u;for await(const S of o){const I=(c=S==null?void 0:S.choices)==null?void 0:c[0];if(S.usage&&(u=S.usage),!I)continue;const{delta:A}=I;if(!A)continue;const O=this._convertOpenAIDeltaToBaseMessageChunk(A,S,i);i=A.role??i;const w={prompt:n.promptIndex??0,completion:I.index??0};if(typeof O.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const L={...w};I.finish_reason!=null&&(L.finish_reason=I.finish_reason,L.system_fingerprint=S.system_fingerprint,L.model_name=S.model),this.logprobs&&(L.logprobs=I.logprobs);const D=new ws({message:O,text:O.content,generationInfo:L});yield D,await(r==null?void 0:r.handleLLMNewToken(D.text??"",w,void 0,void 0,void 0,{chunk:D}))}if(u){const S={...((l=u.prompt_tokens_details)==null?void 0:l.audio_tokens)!==null&&{audio:(d=u.prompt_tokens_details)==null?void 0:d.audio_tokens},...((m=u.prompt_tokens_details)==null?void 0:m.cached_tokens)!==null&&{cache_read:(p=u.prompt_tokens_details)==null?void 0:p.cached_tokens}},I={...((f=u.completion_tokens_details)==null?void 0:f.audio_tokens)!==null&&{audio:(g=u.completion_tokens_details)==null?void 0:g.audio_tokens},...((b=u.completion_tokens_details)==null?void 0:b.reasoning_tokens)!==null&&{reasoning:(_=u.completion_tokens_details)==null?void 0:_.reasoning_tokens}};yield new ws({message:new Zt({content:"",response_metadata:{usage:{...u}},usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens,...Object.keys(S).length>0&&{input_token_details:S},...Object.keys(I).length>0&&{output_token_details:I}}}),text:""})}if((y=n.signal)!=null&&y.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,n,r){var o,u;const s={},a=this.invocationParams(n),i=Qg(e,this.model);if(a.stream){const c=this._streamResponseChunks(e,n,r),l={};for await(const b of c){b.message.response_metadata={...b.generationInfo,...b.message.response_metadata};const _=((o=b.generationInfo)==null?void 0:o.completion)??0;l[_]===void 0?l[_]=b:l[_]=l[_].concat(b)}const d=Object.entries(l).sort(([b],[_])=>parseInt(b,10)-parseInt(_,10)).map(([b,_])=>_),{functions:m,function_call:p}=this.invocationParams(n),f=await this.getEstimatedTokenCountFromPrompt(e,m,p),g=await this.getNumTokensFromGenerations(d);return s.input_tokens=f,s.output_tokens=g,s.total_tokens=f+g,{generations:d,llmOutput:{estimatedTokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}else{let c;n.response_format&&n.response_format.type==="json_schema"?c=await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:i},{signal:n==null?void 0:n.signal,...n==null?void 0:n.options}):c=await this.completionWithRetry({...a,stream:!1,messages:i},{signal:n==null?void 0:n.signal,...n==null?void 0:n.options});const{completion_tokens:l,prompt_tokens:d,total_tokens:m,prompt_tokens_details:p,completion_tokens_details:f}=(c==null?void 0:c.usage)??{};l&&(s.output_tokens=(s.output_tokens??0)+l),d&&(s.input_tokens=(s.input_tokens??0)+d),m&&(s.total_tokens=(s.total_tokens??0)+m),((p==null?void 0:p.audio_tokens)!==null||(p==null?void 0:p.cached_tokens)!==null)&&(s.input_token_details={...(p==null?void 0:p.audio_tokens)!==null&&{audio:p==null?void 0:p.audio_tokens},...(p==null?void 0:p.cached_tokens)!==null&&{cache_read:p==null?void 0:p.cached_tokens}}),((f==null?void 0:f.audio_tokens)!==null||(f==null?void 0:f.reasoning_tokens)!==null)&&(s.output_token_details={...(f==null?void 0:f.audio_tokens)!==null&&{audio:f==null?void 0:f.audio_tokens},...(f==null?void 0:f.reasoning_tokens)!==null&&{reasoning:f==null?void 0:f.reasoning_tokens}});const g=[];for(const b of(c==null?void 0:c.choices)??[]){const y={text:((u=b.message)==null?void 0:u.content)??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(b.message??{role:"assistant"},c)};y.generationInfo={...b.finish_reason?{finish_reason:b.finish_reason}:{},...b.logprobs?{logprobs:b.logprobs}:{}},ro(y.message)&&(y.message.usage_metadata=s),y.message=new bs(Object.fromEntries(Object.entries(y.message).filter(([S])=>!S.startsWith("lc_")))),g.push(y)}return{generations:g,llmOutput:{tokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,n,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(n&&r!=="auto"){const a=qx(n);s+=await this.getNumTokens(a),s+=9}return n&&e.find(a=>a._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async getNumTokensFromMessages(e){let n=0,r=0,s=0;this.model==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const a=await Promise.all(e.map(async i=>{var m,p,f,g,b,_;const o=await this.getNumTokens(i.content),u=await this.getNumTokens(nE(i)),c=i.name!==void 0?s+await this.getNumTokens(i.name):0;let l=o+r+u+c;const d=i;if(d._getType()==="function"&&(l-=2),(m=d.additional_kwargs)!=null&&m.function_call&&(l+=3),(p=d==null?void 0:d.additional_kwargs.function_call)!=null&&p.name&&(l+=await this.getNumTokens((f=d.additional_kwargs.function_call)==null?void 0:f.name)),(g=d.additional_kwargs.function_call)!=null&&g.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((b=d.additional_kwargs.function_call)==null?void 0:b.arguments)))}catch(y){console.error("Error parsing function arguments",y,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((_=d.additional_kwargs.function_call)==null?void 0:_.arguments)}return n+=l,l}));return n+=3,{totalCount:n,countPerMessage:a}}async completionWithRetry(e,n){const r=this._getClientOptions(n);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(s){throw Xg(s)}})}async betaParsedCompletionWithRetry(e,n){const r=this._getClientOptions(n);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(s){throw Xg(s)}})}_getClientOptions(e){if(!this.client){const r={baseURL:this.clientConfig.baseURL},s=jx(r),a={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};a.baseURL||delete a.baseURL,this.client=new Be(a)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((n,r)=>(r&&r.tokenUsage&&(n.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,n.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,n.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),n),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,n){let r,s,a,i;Wx(e)?(r=e.schema,s=e.name,a=e.method,i=e.includeRaw):(r=e,s=n==null?void 0:n.name,a=n==null?void 0:n.method,i=n==null?void 0:n.includeRaw);let o,u;if((n==null?void 0:n.strict)!==void 0&&a==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?a===void 0&&(a="jsonSchema"):a==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),a==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),iu(r)?u=Tg.fromZodSchema(r):u=new Sg;else if(a==="jsonSchema")o=this.bind({response_format:{type:"json_schema",json_schema:{name:s??"extract",description:r.description,schema:r,strict:n==null?void 0:n.strict}}}),iu(r)?u=Tg.fromZodSchema(r):u=new Sg;else{let m=s??"extract";if(iu(r)){const p=Ts(r);o=this.bind({tools:[{type:"function",function:{name:m,description:p.description,parameters:p}}],tool_choice:{type:"function",function:{name:m}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),u=new Kg({returnSingle:!0,keyName:m,zodSchema:r})}else{let p;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(p=r,m=r.name):(m=r.title??m,p={name:m,description:r.description??"",parameters:r}),o=this.bind({tools:[{type:"function",function:p}],tool_choice:{type:"function",function:{name:m}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),u=new Kg({returnSingle:!0,keyName:m})}}if(!i)return o.pipe(u);const c=da.assign({parsed:(m,p)=>u.invoke(m.raw,p)}),l=da.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return cr.from([{raw:o},d])}}function iu(t){return typeof(t==null?void 0:t.parse)=="function"}function Wx(t){return t!==void 0&&typeof t.schema=="object"}class Gx extends xy{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=(e==null?void 0:e.verboseParsingErrors)??this.verboseParsingErrors,this.responseFormat=(e==null?void 0:e.responseFormat)??this.responseFormat}async invoke(e,n){let r,s,a=Ue(n);return hf(e)?(r=e.id,s=e.args,a={...a,toolCall:e,configurable:{...a.configurable,tool_call_id:r}}):s=e,this.call(s,a)}async call(e,n,r){let s;try{s=await this.schema.parseAsync(e)}catch(p){let f="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(f=`${f}
Details: ${p.message}`),new B_(f,JSON.stringify(e))}const a=Ey(n),i=Lt.configure(a.callbacks,this.callbacks,a.tags||r,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o=await(i==null?void 0:i.handleToolStart(this.toJSON(),typeof s=="string"?s:JSON.stringify(s),a.runId,void 0,void 0,void 0,a.runName));delete a.runId;let u;try{u=await this._call(s,o,a)}catch(p){throw await(o==null?void 0:o.handleToolError(p)),p}let c,l;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[c,l]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else c=u;let d;a&&"configurable"in a&&(d=a.configurable.tool_call_id);const m=Yx({content:c,artifact:l,toolCallId:d,name:this.name});return await(o==null?void 0:o.handleToolEnd(m)),m}}class Kx extends Gx{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Or.object({input:Or.string().optional()}).transform(n=>n.input)})}call(e,n){return super.call(typeof e=="string"||!e?{input:e}:e,n)}}function Yx(t){const{content:e,artifact:n,toolCallId:r}=t;return r&&!pC(e)?typeof e=="string"||Array.isArray(e)&&e.every(s=>typeof s=="object")?new Yd({content:e,artifact:n,tool_call_id:r,name:t.name}):new Yd({content:Zx(e),artifact:n,tool_call_id:r,name:t.name}):e}function Zx(t){try{return JSON.stringify(t,null,2)}catch{return`${t}`}}class Jx extends Kx{static lc_name(){return"SearxngSearch"}get lc_secrets(){return{apiBase:"SEARXNG_API_BASE"}}constructor({apiBase:e,params:n,headers:r}){if(super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"searxng-search"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A meta search engine. Useful for when you need to answer questions about current events. Input should be a search query. Output is a JSON array of the query results"}),Object.defineProperty(this,"apiBase",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:{numResults:10,pageNumber:1,format:"json",imageProxy:!0,safesearch:0}}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.apiBase=fn("SEARXNG_API_BASE")||e,this.headers={"content-type":"application/json",...r},!this.apiBase)throw new Error('SEARXNG_API_BASE not set. You can set it as "SEARXNG_API_BASE" in your environment variables.');n&&(this.params={...this.params,...n})}buildUrl(e,n,r){const s=Object.entries(n).filter(([i,o])=>o!==void 0).map(([i,o])=>[i,o.toString()]),a=new URLSearchParams(s);return`${r}/${e}?${a}`}async _call(e){var i,o;const n={q:e,...this.params},r=this.buildUrl("search",n,this.apiBase),s=await fetch(r,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(5*1e3)});if(!s.ok)throw new Error(s.statusText);const a=await s.json();if(!a.results.length&&!a.answers.length&&!a.infoboxes.length&&!a.suggestions.length)return"No good results found.";if(a.results.length){const u=[];return a.results.forEach(c=>{u.push(JSON.stringify({title:c.title||"",link:c.url||"",snippet:c.content||""}))}),u.slice(0,(i=this.params)==null?void 0:i.numResults).toString()}else{if(a.answers.length)return a.answers[0];if(a.infoboxes.length)return(o=a.infoboxes[0])==null?void 0:o.content.replaceAll(/<[^>]+>/gi,"");if(a.suggestions.length){let u="Suggestions: ";return a.suggestions.forEach(c=>{u+=`${c}, `}),u}else return"No good results found."}}}function rE(t,e){return function(){return t.apply(e,arguments)}}const{toString:Xx}=Object.prototype,{getPrototypeOf:tm}=Object,Xc=(t=>e=>{const n=Xx.call(e);return t[n]||(t[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),Yn=t=>(t=t.toLowerCase(),e=>Xc(e)===t),Qc=t=>e=>typeof e===t,{isArray:Ia}=Array,zi=Qc("undefined");function Qx(t){return t!==null&&!zi(t)&&t.constructor!==null&&!zi(t.constructor)&&mn(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const sE=Yn("ArrayBuffer");function e6(t){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(t):e=t&&t.buffer&&sE(t.buffer),e}const t6=Qc("string"),mn=Qc("function"),aE=Qc("number"),el=t=>t!==null&&typeof t=="object",n6=t=>t===!0||t===!1,Su=t=>{if(Xc(t)!=="object")return!1;const e=tm(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},r6=Yn("Date"),s6=Yn("File"),a6=Yn("Blob"),i6=Yn("FileList"),o6=t=>el(t)&&mn(t.pipe),u6=t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||mn(t.append)&&((e=Xc(t))==="formdata"||e==="object"&&mn(t.toString)&&t.toString()==="[object FormData]"))},c6=Yn("URLSearchParams"),[l6,d6,h6,f6]=["ReadableStream","Request","Response","Headers"].map(Yn),m6=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function go(t,e,{allOwnKeys:n=!1}={}){if(t===null||typeof t>"u")return;let r,s;if(typeof t!="object"&&(t=[t]),Ia(t))for(r=0,s=t.length;r<s;r++)e.call(null,t[r],r,t);else{const a=n?Object.getOwnPropertyNames(t):Object.keys(t),i=a.length;let o;for(r=0;r<i;r++)o=a[r],e.call(null,t[o],o,t)}}function iE(t,e){e=e.toLowerCase();const n=Object.keys(t);let r=n.length,s;for(;r-- >0;)if(s=n[r],e===s.toLowerCase())return s;return null}const cs=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,oE=t=>!zi(t)&&t!==cs;function Ih(){const{caseless:t}=oE(this)&&this||{},e={},n=(r,s)=>{const a=t&&iE(e,s)||s;Su(e[a])&&Su(r)?e[a]=Ih(e[a],r):Su(r)?e[a]=Ih({},r):Ia(r)?e[a]=r.slice():e[a]=r};for(let r=0,s=arguments.length;r<s;r++)arguments[r]&&go(arguments[r],n);return e}const p6=(t,e,n,{allOwnKeys:r}={})=>(go(e,(s,a)=>{n&&mn(s)?t[a]=rE(s,n):t[a]=s},{allOwnKeys:r}),t),g6=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),b6=(t,e,n,r)=>{t.prototype=Object.create(e.prototype,r),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},_6=(t,e,n,r)=>{let s,a,i;const o={};if(e=e||{},t==null)return e;do{for(s=Object.getOwnPropertyNames(t),a=s.length;a-- >0;)i=s[a],(!r||r(i,t,e))&&!o[i]&&(e[i]=t[i],o[i]=!0);t=n!==!1&&tm(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},y6=(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;const r=t.indexOf(e,n);return r!==-1&&r===n},E6=t=>{if(!t)return null;if(Ia(t))return t;let e=t.length;if(!aE(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},w6=(t=>e=>t&&e instanceof t)(typeof Uint8Array<"u"&&tm(Uint8Array)),T6=(t,e)=>{const r=(t&&t[Symbol.iterator]).call(t);let s;for(;(s=r.next())&&!s.done;){const a=s.value;e.call(t,a[0],a[1])}},S6=(t,e)=>{let n;const r=[];for(;(n=t.exec(e))!==null;)r.push(n);return r},A6=Yn("HTMLFormElement"),C6=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(n,r,s){return r.toUpperCase()+s}),t0=(({hasOwnProperty:t})=>(e,n)=>t.call(e,n))(Object.prototype),O6=Yn("RegExp"),uE=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),r={};go(n,(s,a)=>{let i;(i=e(s,a,t))!==!1&&(r[a]=i||s)}),Object.defineProperties(t,r)},v6=t=>{uE(t,(e,n)=>{if(mn(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const r=t[n];if(mn(r)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")})}})},I6=(t,e)=>{const n={},r=s=>{s.forEach(a=>{n[a]=!0})};return Ia(t)?r(t):r(String(t).split(e)),n},k6=()=>{},N6=(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,pd="abcdefghijklmnopqrstuvwxyz",n0="0123456789",cE={DIGIT:n0,ALPHA:pd,ALPHA_DIGIT:pd+pd.toUpperCase()+n0},R6=(t=16,e=cE.ALPHA_DIGIT)=>{let n="";const{length:r}=e;for(;t--;)n+=e[Math.random()*r|0];return n};function P6(t){return!!(t&&mn(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])}const x6=t=>{const e=new Array(10),n=(r,s)=>{if(el(r)){if(e.indexOf(r)>=0)return;if(!("toJSON"in r)){e[s]=r;const a=Ia(r)?[]:{};return go(r,(i,o)=>{const u=n(i,s+1);!zi(u)&&(a[o]=u)}),e[s]=void 0,a}}return r};return n(t,0)},L6=Yn("AsyncFunction"),D6=t=>t&&(el(t)||mn(t))&&mn(t.then)&&mn(t.catch),lE=((t,e)=>t?setImmediate:e?((n,r)=>(cs.addEventListener("message",({source:s,data:a})=>{s===cs&&a===n&&r.length&&r.shift()()},!1),s=>{r.push(s),cs.postMessage(n,"*")}))(`axios@${Math.random()}`,[]):n=>setTimeout(n))(typeof setImmediate=="function",mn(cs.postMessage)),M6=typeof queueMicrotask<"u"?queueMicrotask.bind(cs):typeof process<"u"&&process.nextTick||lE,H={isArray:Ia,isArrayBuffer:sE,isBuffer:Qx,isFormData:u6,isArrayBufferView:e6,isString:t6,isNumber:aE,isBoolean:n6,isObject:el,isPlainObject:Su,isReadableStream:l6,isRequest:d6,isResponse:h6,isHeaders:f6,isUndefined:zi,isDate:r6,isFile:s6,isBlob:a6,isRegExp:O6,isFunction:mn,isStream:o6,isURLSearchParams:c6,isTypedArray:w6,isFileList:i6,forEach:go,merge:Ih,extend:p6,trim:m6,stripBOM:g6,inherits:b6,toFlatObject:_6,kindOf:Xc,kindOfTest:Yn,endsWith:y6,toArray:E6,forEachEntry:T6,matchAll:S6,isHTMLForm:A6,hasOwnProperty:t0,hasOwnProp:t0,reduceDescriptors:uE,freezeMethods:v6,toObjectSet:I6,toCamelCase:C6,noop:k6,toFiniteNumber:N6,findKey:iE,global:cs,isContextDefined:oE,ALPHABET:cE,generateString:R6,isSpecCompliantForm:P6,toJSONObject:x6,isAsyncFn:L6,isThenable:D6,setImmediate:lE,asap:M6};function we(t,e,n,r,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),r&&(this.request=r),s&&(this.response=s,this.status=s.status?s.status:null)}H.inherits(we,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:H.toJSONObject(this.config),code:this.code,status:this.status}}});const dE=we.prototype,hE={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{hE[t]={value:t}});Object.defineProperties(we,hE);Object.defineProperty(dE,"isAxiosError",{value:!0});we.from=(t,e,n,r,s,a)=>{const i=Object.create(dE);return H.toFlatObject(t,i,function(u){return u!==Error.prototype},o=>o!=="isAxiosError"),we.call(i,t.message,e,n,r,s),i.cause=t,i.name=t.name,a&&Object.assign(i,a),i};const B6=null;function kh(t){return H.isPlainObject(t)||H.isArray(t)}function fE(t){return H.endsWith(t,"[]")?t.slice(0,-2):t}function r0(t,e,n){return t?t.concat(e).map(function(s,a){return s=fE(s),!n&&a?"["+s+"]":s}).join(n?".":""):e}function F6(t){return H.isArray(t)&&!t.some(kh)}const U6=H.toFlatObject(H,{},null,function(e){return/^is[A-Z]/.test(e)});function tl(t,e,n){if(!H.isObject(t))throw new TypeError("target must be an object");e=e||new FormData,n=H.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(g,b){return!H.isUndefined(b[g])});const r=n.metaTokens,s=n.visitor||l,a=n.dots,i=n.indexes,u=(n.Blob||typeof Blob<"u"&&Blob)&&H.isSpecCompliantForm(e);if(!H.isFunction(s))throw new TypeError("visitor must be a function");function c(f){if(f===null)return"";if(H.isDate(f))return f.toISOString();if(!u&&H.isBlob(f))throw new we("Blob is not supported. Use a Buffer instead.");return H.isArrayBuffer(f)||H.isTypedArray(f)?u&&typeof Blob=="function"?new Blob([f]):Buffer.from(f):f}function l(f,g,b){let _=f;if(f&&!b&&typeof f=="object"){if(H.endsWith(g,"{}"))g=r?g:g.slice(0,-2),f=JSON.stringify(f);else if(H.isArray(f)&&F6(f)||(H.isFileList(f)||H.endsWith(g,"[]"))&&(_=H.toArray(f)))return g=fE(g),_.forEach(function(S,I){!(H.isUndefined(S)||S===null)&&e.append(i===!0?r0([g],I,a):i===null?g:g+"[]",c(S))}),!1}return kh(f)?!0:(e.append(r0(b,g,a),c(f)),!1)}const d=[],m=Object.assign(U6,{defaultVisitor:l,convertValue:c,isVisitable:kh});function p(f,g){if(!H.isUndefined(f)){if(d.indexOf(f)!==-1)throw Error("Circular reference detected in "+g.join("."));d.push(f),H.forEach(f,function(_,y){(!(H.isUndefined(_)||_===null)&&s.call(e,_,H.isString(y)?y.trim():y,g,m))===!0&&p(_,g?g.concat(y):[y])}),d.pop()}}if(!H.isObject(t))throw new TypeError("data must be an object");return p(t),e}function s0(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(r){return e[r]})}function nm(t,e){this._pairs=[],t&&tl(t,this,e)}const mE=nm.prototype;mE.append=function(e,n){this._pairs.push([e,n])};mE.toString=function(e){const n=e?function(r){return e.call(this,r,s0)}:s0;return this._pairs.map(function(s){return n(s[0])+"="+n(s[1])},"").join("&")};function j6(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function pE(t,e,n){if(!e)return t;const r=n&&n.encode||j6;H.isFunction(n)&&(n={serialize:n});const s=n&&n.serialize;let a;if(s?a=s(e,n):a=H.isURLSearchParams(e)?e.toString():new nm(e,n).toString(r),a){const i=t.indexOf("#");i!==-1&&(t=t.slice(0,i)),t+=(t.indexOf("?")===-1?"?":"&")+a}return t}class a0{constructor(){this.handlers=[]}use(e,n,r){return this.handlers.push({fulfilled:e,rejected:n,synchronous:r?r.synchronous:!1,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){H.forEach(this.handlers,function(r){r!==null&&e(r)})}}const gE={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},H6=typeof URLSearchParams<"u"?URLSearchParams:nm,$6=typeof FormData<"u"?FormData:null,q6=typeof Blob<"u"?Blob:null,V6={isBrowser:!0,classes:{URLSearchParams:H6,FormData:$6,Blob:q6},protocols:["http","https","file","blob","url","data"]},rm=typeof window<"u"&&typeof document<"u",Nh=typeof navigator=="object"&&navigator||void 0,z6=rm&&(!Nh||["ReactNative","NativeScript","NS"].indexOf(Nh.product)<0),W6=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",G6=rm&&window.location.href||"http://localhost",K6=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:rm,hasStandardBrowserEnv:z6,hasStandardBrowserWebWorkerEnv:W6,navigator:Nh,origin:G6},Symbol.toStringTag,{value:"Module"})),xt={...K6,...V6};function Y6(t,e){return tl(t,new xt.classes.URLSearchParams,Object.assign({visitor:function(n,r,s,a){return xt.isNode&&H.isBuffer(n)?(this.append(r,n.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},e))}function Z6(t){return H.matchAll(/\w+|\[(\w*)]/g,t).map(e=>e[0]==="[]"?"":e[1]||e[0])}function J6(t){const e={},n=Object.keys(t);let r;const s=n.length;let a;for(r=0;r<s;r++)a=n[r],e[a]=t[a];return e}function bE(t){function e(n,r,s,a){let i=n[a++];if(i==="__proto__")return!0;const o=Number.isFinite(+i),u=a>=n.length;return i=!i&&H.isArray(s)?s.length:i,u?(H.hasOwnProp(s,i)?s[i]=[s[i],r]:s[i]=r,!o):((!s[i]||!H.isObject(s[i]))&&(s[i]=[]),e(n,r,s[i],a)&&H.isArray(s[i])&&(s[i]=J6(s[i])),!o)}if(H.isFormData(t)&&H.isFunction(t.entries)){const n={};return H.forEachEntry(t,(r,s)=>{e(Z6(r),s,n,0)}),n}return null}function X6(t,e,n){if(H.isString(t))try{return(e||JSON.parse)(t),H.trim(t)}catch(r){if(r.name!=="SyntaxError")throw r}return(0,JSON.stringify)(t)}const bo={transitional:gE,adapter:["xhr","http","fetch"],transformRequest:[function(e,n){const r=n.getContentType()||"",s=r.indexOf("application/json")>-1,a=H.isObject(e);if(a&&H.isHTMLForm(e)&&(e=new FormData(e)),H.isFormData(e))return s?JSON.stringify(bE(e)):e;if(H.isArrayBuffer(e)||H.isBuffer(e)||H.isStream(e)||H.isFile(e)||H.isBlob(e)||H.isReadableStream(e))return e;if(H.isArrayBufferView(e))return e.buffer;if(H.isURLSearchParams(e))return n.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(a){if(r.indexOf("application/x-www-form-urlencoded")>-1)return Y6(e,this.formSerializer).toString();if((o=H.isFileList(e))||r.indexOf("multipart/form-data")>-1){const u=this.env&&this.env.FormData;return tl(o?{"files[]":e}:e,u&&new u,this.formSerializer)}}return a||s?(n.setContentType("application/json",!1),X6(e)):e}],transformResponse:[function(e){const n=this.transitional||bo.transitional,r=n&&n.forcedJSONParsing,s=this.responseType==="json";if(H.isResponse(e)||H.isReadableStream(e))return e;if(e&&H.isString(e)&&(r&&!this.responseType||s)){const i=!(n&&n.silentJSONParsing)&&s;try{return JSON.parse(e)}catch(o){if(i)throw o.name==="SyntaxError"?we.from(o,we.ERR_BAD_RESPONSE,this,null,this.response):o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:xt.classes.FormData,Blob:xt.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};H.forEach(["delete","get","head","post","put","patch"],t=>{bo.headers[t]={}});const Q6=H.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),eL=t=>{const e={};let n,r,s;return t&&t.split(`
`).forEach(function(i){s=i.indexOf(":"),n=i.substring(0,s).trim().toLowerCase(),r=i.substring(s+1).trim(),!(!n||e[n]&&Q6[n])&&(n==="set-cookie"?e[n]?e[n].push(r):e[n]=[r]:e[n]=e[n]?e[n]+", "+r:r)}),e},i0=Symbol("internals");function za(t){return t&&String(t).trim().toLowerCase()}function Au(t){return t===!1||t==null?t:H.isArray(t)?t.map(Au):String(t)}function tL(t){const e=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=n.exec(t);)e[r[1]]=r[2];return e}const nL=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function gd(t,e,n,r,s){if(H.isFunction(r))return r.call(this,e,n);if(s&&(e=n),!!H.isString(e)){if(H.isString(r))return e.indexOf(r)!==-1;if(H.isRegExp(r))return r.test(e)}}function rL(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,n,r)=>n.toUpperCase()+r)}function sL(t,e){const n=H.toCamelCase(" "+e);["get","set","has"].forEach(r=>{Object.defineProperty(t,r+n,{value:function(s,a,i){return this[r].call(this,e,s,a,i)},configurable:!0})})}class tn{constructor(e){e&&this.set(e)}set(e,n,r){const s=this;function a(o,u,c){const l=za(u);if(!l)throw new Error("header name must be a non-empty string");const d=H.findKey(s,l);(!d||s[d]===void 0||c===!0||c===void 0&&s[d]!==!1)&&(s[d||u]=Au(o))}const i=(o,u)=>H.forEach(o,(c,l)=>a(c,l,u));if(H.isPlainObject(e)||e instanceof this.constructor)i(e,n);else if(H.isString(e)&&(e=e.trim())&&!nL(e))i(eL(e),n);else if(H.isHeaders(e))for(const[o,u]of e.entries())a(u,o,r);else e!=null&&a(n,e,r);return this}get(e,n){if(e=za(e),e){const r=H.findKey(this,e);if(r){const s=this[r];if(!n)return s;if(n===!0)return tL(s);if(H.isFunction(n))return n.call(this,s,r);if(H.isRegExp(n))return n.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=za(e),e){const r=H.findKey(this,e);return!!(r&&this[r]!==void 0&&(!n||gd(this,this[r],r,n)))}return!1}delete(e,n){const r=this;let s=!1;function a(i){if(i=za(i),i){const o=H.findKey(r,i);o&&(!n||gd(r,r[o],o,n))&&(delete r[o],s=!0)}}return H.isArray(e)?e.forEach(a):a(e),s}clear(e){const n=Object.keys(this);let r=n.length,s=!1;for(;r--;){const a=n[r];(!e||gd(this,this[a],a,e,!0))&&(delete this[a],s=!0)}return s}normalize(e){const n=this,r={};return H.forEach(this,(s,a)=>{const i=H.findKey(r,a);if(i){n[i]=Au(s),delete n[a];return}const o=e?rL(a):String(a).trim();o!==a&&delete n[a],n[o]=Au(s),r[o]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const n=Object.create(null);return H.forEach(this,(r,s)=>{r!=null&&r!==!1&&(n[s]=e&&H.isArray(r)?r.join(", "):r)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,n])=>e+": "+n).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...n){const r=new this(e);return n.forEach(s=>r.set(s)),r}static accessor(e){const r=(this[i0]=this[i0]={accessors:{}}).accessors,s=this.prototype;function a(i){const o=za(i);r[o]||(sL(s,i),r[o]=!0)}return H.isArray(e)?e.forEach(a):a(e),this}}tn.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);H.reduceDescriptors(tn.prototype,({value:t},e)=>{let n=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(r){this[n]=r}}});H.freezeMethods(tn);function bd(t,e){const n=this||bo,r=e||n,s=tn.from(r.headers);let a=r.data;return H.forEach(t,function(o){a=o.call(n,a,s.normalize(),e?e.status:void 0)}),s.normalize(),a}function _E(t){return!!(t&&t.__CANCEL__)}function ka(t,e,n){we.call(this,t??"canceled",we.ERR_CANCELED,e,n),this.name="CanceledError"}H.inherits(ka,we,{__CANCEL__:!0});function yE(t,e,n){const r=n.config.validateStatus;!n.status||!r||r(n.status)?t(n):e(new we("Request failed with status code "+n.status,[we.ERR_BAD_REQUEST,we.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n))}function aL(t){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}function iL(t,e){t=t||10;const n=new Array(t),r=new Array(t);let s=0,a=0,i;return e=e!==void 0?e:1e3,function(u){const c=Date.now(),l=r[a];i||(i=c),n[s]=u,r[s]=c;let d=a,m=0;for(;d!==s;)m+=n[d++],d=d%t;if(s=(s+1)%t,s===a&&(a=(a+1)%t),c-i<e)return;const p=l&&c-l;return p?Math.round(m*1e3/p):void 0}}function oL(t,e){let n=0,r=1e3/e,s,a;const i=(c,l=Date.now())=>{n=l,s=null,a&&(clearTimeout(a),a=null),t.apply(null,c)};return[(...c)=>{const l=Date.now(),d=l-n;d>=r?i(c,l):(s=c,a||(a=setTimeout(()=>{a=null,i(s)},r-d)))},()=>s&&i(s)]}const rc=(t,e,n=3)=>{let r=0;const s=iL(50,250);return oL(a=>{const i=a.loaded,o=a.lengthComputable?a.total:void 0,u=i-r,c=s(u),l=i<=o;r=i;const d={loaded:i,total:o,progress:o?i/o:void 0,bytes:u,rate:c||void 0,estimated:c&&o&&l?(o-i)/c:void 0,event:a,lengthComputable:o!=null,[e?"download":"upload"]:!0};t(d)},n)},o0=(t,e)=>{const n=t!=null;return[r=>e[0]({lengthComputable:n,total:t,loaded:r}),e[1]]},u0=t=>(...e)=>H.asap(()=>t(...e)),uL=xt.hasStandardBrowserEnv?((t,e)=>n=>(n=new URL(n,xt.origin),t.protocol===n.protocol&&t.host===n.host&&(e||t.port===n.port)))(new URL(xt.origin),xt.navigator&&/(msie|trident)/i.test(xt.navigator.userAgent)):()=>!0,cL=xt.hasStandardBrowserEnv?{write(t,e,n,r,s,a){const i=[t+"="+encodeURIComponent(e)];H.isNumber(n)&&i.push("expires="+new Date(n).toGMTString()),H.isString(r)&&i.push("path="+r),H.isString(s)&&i.push("domain="+s),a===!0&&i.push("secure"),document.cookie=i.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function lL(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function dL(t,e){return e?t.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):t}function EE(t,e){return t&&!lL(e)?dL(t,e):e}const c0=t=>t instanceof tn?{...t}:t;function As(t,e){e=e||{};const n={};function r(c,l,d,m){return H.isPlainObject(c)&&H.isPlainObject(l)?H.merge.call({caseless:m},c,l):H.isPlainObject(l)?H.merge({},l):H.isArray(l)?l.slice():l}function s(c,l,d,m){if(H.isUndefined(l)){if(!H.isUndefined(c))return r(void 0,c,d,m)}else return r(c,l,d,m)}function a(c,l){if(!H.isUndefined(l))return r(void 0,l)}function i(c,l){if(H.isUndefined(l)){if(!H.isUndefined(c))return r(void 0,c)}else return r(void 0,l)}function o(c,l,d){if(d in e)return r(c,l);if(d in t)return r(void 0,c)}const u={url:a,method:a,data:a,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:o,headers:(c,l,d)=>s(c0(c),c0(l),d,!0)};return H.forEach(Object.keys(Object.assign({},t,e)),function(l){const d=u[l]||s,m=d(t[l],e[l],l);H.isUndefined(m)&&d!==o||(n[l]=m)}),n}const wE=t=>{const e=As({},t);let{data:n,withXSRFToken:r,xsrfHeaderName:s,xsrfCookieName:a,headers:i,auth:o}=e;e.headers=i=tn.from(i),e.url=pE(EE(e.baseURL,e.url),t.params,t.paramsSerializer),o&&i.set("Authorization","Basic "+btoa((o.username||"")+":"+(o.password?unescape(encodeURIComponent(o.password)):"")));let u;if(H.isFormData(n)){if(xt.hasStandardBrowserEnv||xt.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((u=i.getContentType())!==!1){const[c,...l]=u?u.split(";").map(d=>d.trim()).filter(Boolean):[];i.setContentType([c||"multipart/form-data",...l].join("; "))}}if(xt.hasStandardBrowserEnv&&(r&&H.isFunction(r)&&(r=r(e)),r||r!==!1&&uL(e.url))){const c=s&&a&&cL.read(a);c&&i.set(s,c)}return e},hL=typeof XMLHttpRequest<"u",fL=hL&&function(t){return new Promise(function(n,r){const s=wE(t);let a=s.data;const i=tn.from(s.headers).normalize();let{responseType:o,onUploadProgress:u,onDownloadProgress:c}=s,l,d,m,p,f;function g(){p&&p(),f&&f(),s.cancelToken&&s.cancelToken.unsubscribe(l),s.signal&&s.signal.removeEventListener("abort",l)}let b=new XMLHttpRequest;b.open(s.method.toUpperCase(),s.url,!0),b.timeout=s.timeout;function _(){if(!b)return;const S=tn.from("getAllResponseHeaders"in b&&b.getAllResponseHeaders()),A={data:!o||o==="text"||o==="json"?b.responseText:b.response,status:b.status,statusText:b.statusText,headers:S,config:t,request:b};yE(function(w){n(w),g()},function(w){r(w),g()},A),b=null}"onloadend"in b?b.onloadend=_:b.onreadystatechange=function(){!b||b.readyState!==4||b.status===0&&!(b.responseURL&&b.responseURL.indexOf("file:")===0)||setTimeout(_)},b.onabort=function(){b&&(r(new we("Request aborted",we.ECONNABORTED,t,b)),b=null)},b.onerror=function(){r(new we("Network Error",we.ERR_NETWORK,t,b)),b=null},b.ontimeout=function(){let I=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const A=s.transitional||gE;s.timeoutErrorMessage&&(I=s.timeoutErrorMessage),r(new we(I,A.clarifyTimeoutError?we.ETIMEDOUT:we.ECONNABORTED,t,b)),b=null},a===void 0&&i.setContentType(null),"setRequestHeader"in b&&H.forEach(i.toJSON(),function(I,A){b.setRequestHeader(A,I)}),H.isUndefined(s.withCredentials)||(b.withCredentials=!!s.withCredentials),o&&o!=="json"&&(b.responseType=s.responseType),c&&([m,f]=rc(c,!0),b.addEventListener("progress",m)),u&&b.upload&&([d,p]=rc(u),b.upload.addEventListener("progress",d),b.upload.addEventListener("loadend",p)),(s.cancelToken||s.signal)&&(l=S=>{b&&(r(!S||S.type?new ka(null,t,b):S),b.abort(),b=null)},s.cancelToken&&s.cancelToken.subscribe(l),s.signal&&(s.signal.aborted?l():s.signal.addEventListener("abort",l)));const y=aL(s.url);if(y&&xt.protocols.indexOf(y)===-1){r(new we("Unsupported protocol "+y+":",we.ERR_BAD_REQUEST,t));return}b.send(a||null)})},mL=(t,e)=>{const{length:n}=t=t?t.filter(Boolean):[];if(e||n){let r=new AbortController,s;const a=function(c){if(!s){s=!0,o();const l=c instanceof Error?c:this.reason;r.abort(l instanceof we?l:new ka(l instanceof Error?l.message:l))}};let i=e&&setTimeout(()=>{i=null,a(new we(`timeout ${e} of ms exceeded`,we.ETIMEDOUT))},e);const o=()=>{t&&(i&&clearTimeout(i),i=null,t.forEach(c=>{c.unsubscribe?c.unsubscribe(a):c.removeEventListener("abort",a)}),t=null)};t.forEach(c=>c.addEventListener("abort",a));const{signal:u}=r;return u.unsubscribe=()=>H.asap(o),u}},pL=function*(t,e){let n=t.byteLength;if(n<e){yield t;return}let r=0,s;for(;r<n;)s=r+e,yield t.slice(r,s),r=s},gL=async function*(t,e){for await(const n of bL(t))yield*pL(n,e)},bL=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const e=t.getReader();try{for(;;){const{done:n,value:r}=await e.read();if(n)break;yield r}}finally{await e.cancel()}},l0=(t,e,n,r)=>{const s=gL(t,e);let a=0,i,o=u=>{i||(i=!0,r&&r(u))};return new ReadableStream({async pull(u){try{const{done:c,value:l}=await s.next();if(c){o(),u.close();return}let d=l.byteLength;if(n){let m=a+=d;n(m)}u.enqueue(new Uint8Array(l))}catch(c){throw o(c),c}},cancel(u){return o(u),s.return()}},{highWaterMark:2})},nl=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",TE=nl&&typeof ReadableStream=="function",_L=nl&&(typeof TextEncoder=="function"?(t=>e=>t.encode(e))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),SE=(t,...e)=>{try{return!!t(...e)}catch{return!1}},yL=TE&&SE(()=>{let t=!1;const e=new Request(xt.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),d0=64*1024,Rh=TE&&SE(()=>H.isReadableStream(new Response("").body)),sc={stream:Rh&&(t=>t.body)};nl&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!sc[e]&&(sc[e]=H.isFunction(t[e])?n=>n[e]():(n,r)=>{throw new we(`Response type '${e}' is not supported`,we.ERR_NOT_SUPPORT,r)})})})(new Response);const EL=async t=>{if(t==null)return 0;if(H.isBlob(t))return t.size;if(H.isSpecCompliantForm(t))return(await new Request(xt.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(H.isArrayBufferView(t)||H.isArrayBuffer(t))return t.byteLength;if(H.isURLSearchParams(t)&&(t=t+""),H.isString(t))return(await _L(t)).byteLength},wL=async(t,e)=>{const n=H.toFiniteNumber(t.getContentLength());return n??EL(e)},TL=nl&&(async t=>{let{url:e,method:n,data:r,signal:s,cancelToken:a,timeout:i,onDownloadProgress:o,onUploadProgress:u,responseType:c,headers:l,withCredentials:d="same-origin",fetchOptions:m}=wE(t);c=c?(c+"").toLowerCase():"text";let p=mL([s,a&&a.toAbortSignal()],i),f;const g=p&&p.unsubscribe&&(()=>{p.unsubscribe()});let b;try{if(u&&yL&&n!=="get"&&n!=="head"&&(b=await wL(l,r))!==0){let A=new Request(e,{method:"POST",body:r,duplex:"half"}),O;if(H.isFormData(r)&&(O=A.headers.get("content-type"))&&l.setContentType(O),A.body){const[w,L]=o0(b,rc(u0(u)));r=l0(A.body,d0,w,L)}}H.isString(d)||(d=d?"include":"omit");const _="credentials"in Request.prototype;f=new Request(e,{...m,signal:p,method:n.toUpperCase(),headers:l.normalize().toJSON(),body:r,duplex:"half",credentials:_?d:void 0});let y=await fetch(f);const S=Rh&&(c==="stream"||c==="response");if(Rh&&(o||S&&g)){const A={};["status","statusText","headers"].forEach(D=>{A[D]=y[D]});const O=H.toFiniteNumber(y.headers.get("content-length")),[w,L]=o&&o0(O,rc(u0(o),!0))||[];y=new Response(l0(y.body,d0,w,()=>{L&&L(),g&&g()}),A)}c=c||"text";let I=await sc[H.findKey(sc,c)||"text"](y,t);return!S&&g&&g(),await new Promise((A,O)=>{yE(A,O,{data:I,headers:tn.from(y.headers),status:y.status,statusText:y.statusText,config:t,request:f})})}catch(_){throw g&&g(),_&&_.name==="TypeError"&&/fetch/i.test(_.message)?Object.assign(new we("Network Error",we.ERR_NETWORK,t,f),{cause:_.cause||_}):we.from(_,_&&_.code,t,f)}}),Ph={http:B6,xhr:fL,fetch:TL};H.forEach(Ph,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const h0=t=>`- ${t}`,SL=t=>H.isFunction(t)||t===null||t===!1,AE={getAdapter:t=>{t=H.isArray(t)?t:[t];const{length:e}=t;let n,r;const s={};for(let a=0;a<e;a++){n=t[a];let i;if(r=n,!SL(n)&&(r=Ph[(i=String(n)).toLowerCase()],r===void 0))throw new we(`Unknown adapter '${i}'`);if(r)break;s[i||"#"+a]=r}if(!r){const a=Object.entries(s).map(([o,u])=>`adapter ${o} `+(u===!1?"is not supported by the environment":"is not available in the build"));let i=e?a.length>1?`since :
`+a.map(h0).join(`
`):" "+h0(a[0]):"as no adapter specified";throw new we("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return r},adapters:Ph};function _d(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new ka(null,t)}function f0(t){return _d(t),t.headers=tn.from(t.headers),t.data=bd.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),AE.getAdapter(t.adapter||bo.adapter)(t).then(function(r){return _d(t),r.data=bd.call(t,t.transformResponse,r),r.headers=tn.from(r.headers),r},function(r){return _E(r)||(_d(t),r&&r.response&&(r.response.data=bd.call(t,t.transformResponse,r.response),r.response.headers=tn.from(r.response.headers))),Promise.reject(r)})}const CE="1.7.9",rl={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{rl[t]=function(r){return typeof r===t||"a"+(e<1?"n ":" ")+t}});const m0={};rl.transitional=function(e,n,r){function s(a,i){return"[Axios v"+CE+"] Transitional option '"+a+"'"+i+(r?". "+r:"")}return(a,i,o)=>{if(e===!1)throw new we(s(i," has been removed"+(n?" in "+n:"")),we.ERR_DEPRECATED);return n&&!m0[i]&&(m0[i]=!0,console.warn(s(i," has been deprecated since v"+n+" and will be removed in the near future"))),e?e(a,i,o):!0}};rl.spelling=function(e){return(n,r)=>(console.warn(`${r} is likely a misspelling of ${e}`),!0)};function AL(t,e,n){if(typeof t!="object")throw new we("options must be an object",we.ERR_BAD_OPTION_VALUE);const r=Object.keys(t);let s=r.length;for(;s-- >0;){const a=r[s],i=e[a];if(i){const o=t[a],u=o===void 0||i(o,a,t);if(u!==!0)throw new we("option "+a+" must be "+u,we.ERR_BAD_OPTION_VALUE);continue}if(n!==!0)throw new we("Unknown option "+a,we.ERR_BAD_OPTION)}}const Cu={assertOptions:AL,validators:rl},er=Cu.validators;class ms{constructor(e){this.defaults=e,this.interceptors={request:new a0,response:new a0}}async request(e,n){try{return await this._request(e,n)}catch(r){if(r instanceof Error){let s={};Error.captureStackTrace?Error.captureStackTrace(s):s=new Error;const a=s.stack?s.stack.replace(/^.+\n/,""):"";try{r.stack?a&&!String(r.stack).endsWith(a.replace(/^.+\n.+\n/,""))&&(r.stack+=`
`+a):r.stack=a}catch{}}throw r}}_request(e,n){typeof e=="string"?(n=n||{},n.url=e):n=e||{},n=As(this.defaults,n);const{transitional:r,paramsSerializer:s,headers:a}=n;r!==void 0&&Cu.assertOptions(r,{silentJSONParsing:er.transitional(er.boolean),forcedJSONParsing:er.transitional(er.boolean),clarifyTimeoutError:er.transitional(er.boolean)},!1),s!=null&&(H.isFunction(s)?n.paramsSerializer={serialize:s}:Cu.assertOptions(s,{encode:er.function,serialize:er.function},!0)),Cu.assertOptions(n,{baseUrl:er.spelling("baseURL"),withXsrfToken:er.spelling("withXSRFToken")},!0),n.method=(n.method||this.defaults.method||"get").toLowerCase();let i=a&&H.merge(a.common,a[n.method]);a&&H.forEach(["delete","get","head","post","put","patch","common"],f=>{delete a[f]}),n.headers=tn.concat(i,a);const o=[];let u=!0;this.interceptors.request.forEach(function(g){typeof g.runWhen=="function"&&g.runWhen(n)===!1||(u=u&&g.synchronous,o.unshift(g.fulfilled,g.rejected))});const c=[];this.interceptors.response.forEach(function(g){c.push(g.fulfilled,g.rejected)});let l,d=0,m;if(!u){const f=[f0.bind(this),void 0];for(f.unshift.apply(f,o),f.push.apply(f,c),m=f.length,l=Promise.resolve(n);d<m;)l=l.then(f[d++],f[d++]);return l}m=o.length;let p=n;for(d=0;d<m;){const f=o[d++],g=o[d++];try{p=f(p)}catch(b){g.call(this,b);break}}try{l=f0.call(this,p)}catch(f){return Promise.reject(f)}for(d=0,m=c.length;d<m;)l=l.then(c[d++],c[d++]);return l}getUri(e){e=As(this.defaults,e);const n=EE(e.baseURL,e.url);return pE(n,e.params,e.paramsSerializer)}}H.forEach(["delete","get","head","options"],function(e){ms.prototype[e]=function(n,r){return this.request(As(r||{},{method:e,url:n,data:(r||{}).data}))}});H.forEach(["post","put","patch"],function(e){function n(r){return function(a,i,o){return this.request(As(o||{},{method:e,headers:r?{"Content-Type":"multipart/form-data"}:{},url:a,data:i}))}}ms.prototype[e]=n(),ms.prototype[e+"Form"]=n(!0)});class sm{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(a){n=a});const r=this;this.promise.then(s=>{if(!r._listeners)return;let a=r._listeners.length;for(;a-- >0;)r._listeners[a](s);r._listeners=null}),this.promise.then=s=>{let a;const i=new Promise(o=>{r.subscribe(o),a=o}).then(s);return i.cancel=function(){r.unsubscribe(a)},i},e(function(a,i,o){r.reason||(r.reason=new ka(a,i,o),n(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const e=new AbortController,n=r=>{e.abort(r)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new sm(function(s){e=s}),cancel:e}}}function CL(t){return function(n){return t.apply(null,n)}}function OL(t){return H.isObject(t)&&t.isAxiosError===!0}const xh={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(xh).forEach(([t,e])=>{xh[e]=t});function OE(t){const e=new ms(t),n=rE(ms.prototype.request,e);return H.extend(n,ms.prototype,e,{allOwnKeys:!0}),H.extend(n,e,null,{allOwnKeys:!0}),n.create=function(s){return OE(As(t,s))},n}const Xe=OE(bo);Xe.Axios=ms;Xe.CanceledError=ka;Xe.CancelToken=sm;Xe.isCancel=_E;Xe.VERSION=CE;Xe.toFormData=tl;Xe.AxiosError=we;Xe.Cancel=Xe.CanceledError;Xe.all=function(e){return Promise.all(e)};Xe.spread=CL;Xe.isAxiosError=OL;Xe.mergeConfig=As;Xe.AxiosHeaders=tn;Xe.formToJSON=t=>bE(H.isHTMLForm(t)?new FormData(t):t);Xe.getAdapter=AE.getAdapter;Xe.HttpStatusCode=xh;Xe.default=Xe;var qe;(function(t){t.Root="root",t.Text="text",t.Directive="directive",t.Comment="comment",t.Script="script",t.Style="style",t.Tag="tag",t.CDATA="cdata",t.Doctype="doctype"})(qe||(qe={}));function vL(t){return t.type===qe.Tag||t.type===qe.Script||t.type===qe.Style}const IL=qe.Root,kL=qe.Text,NL=qe.Directive,RL=qe.Comment,PL=qe.Script,xL=qe.Style,LL=qe.Tag,DL=qe.CDATA,ML=qe.Doctype;class vE{constructor(){this.parent=null,this.prev=null,this.next=null,this.startIndex=null,this.endIndex=null}get parentNode(){return this.parent}set parentNode(e){this.parent=e}get previousSibling(){return this.prev}set previousSibling(e){this.prev=e}get nextSibling(){return this.next}set nextSibling(e){this.next=e}cloneNode(e=!1){return Gi(this,e)}}class am extends vE{constructor(e){super(),this.data=e}get nodeValue(){return this.data}set nodeValue(e){this.data=e}}class Wi extends am{constructor(){super(...arguments),this.type=qe.Text}get nodeType(){return 3}}class im extends am{constructor(){super(...arguments),this.type=qe.Comment}get nodeType(){return 8}}class om extends am{constructor(e,n){super(n),this.name=e,this.type=qe.Directive}get nodeType(){return 1}}class um extends vE{constructor(e){super(),this.children=e}get firstChild(){var e;return(e=this.children[0])!==null&&e!==void 0?e:null}get lastChild(){return this.children.length>0?this.children[this.children.length-1]:null}get childNodes(){return this.children}set childNodes(e){this.children=e}}class IE extends um{constructor(){super(...arguments),this.type=qe.CDATA}get nodeType(){return 4}}let Cs=class extends um{constructor(){super(...arguments),this.type=qe.Root}get nodeType(){return 9}};class cm extends um{constructor(e,n,r=[],s=e==="script"?qe.Script:e==="style"?qe.Style:qe.Tag){super(r),this.name=e,this.attribs=n,this.type=s}get nodeType(){return 1}get tagName(){return this.name}set tagName(e){this.name=e}get attributes(){return Object.keys(this.attribs).map(e=>{var n,r;return{name:e,value:this.attribs[e],namespace:(n=this["x-attribsNamespace"])===null||n===void 0?void 0:n[e],prefix:(r=this["x-attribsPrefix"])===null||r===void 0?void 0:r[e]}})}}function ge(t){return vL(t)}function sl(t){return t.type===qe.CDATA}function dr(t){return t.type===qe.Text}function al(t){return t.type===qe.Comment}function Lh(t){return t.type===qe.Directive}function Xr(t){return t.type===qe.Root}function ot(t){return Object.prototype.hasOwnProperty.call(t,"children")}function Gi(t,e=!1){let n;if(dr(t))n=new Wi(t.data);else if(al(t))n=new im(t.data);else if(ge(t)){const r=e?yd(t.children):[],s=new cm(t.name,{...t.attribs},r);r.forEach(a=>a.parent=s),t.namespace!=null&&(s.namespace=t.namespace),t["x-attribsNamespace"]&&(s["x-attribsNamespace"]={...t["x-attribsNamespace"]}),t["x-attribsPrefix"]&&(s["x-attribsPrefix"]={...t["x-attribsPrefix"]}),n=s}else if(sl(t)){const r=e?yd(t.children):[],s=new IE(r);r.forEach(a=>a.parent=s),n=s}else if(Xr(t)){const r=e?yd(t.children):[],s=new Cs(r);r.forEach(a=>a.parent=s),t["x-mode"]&&(s["x-mode"]=t["x-mode"]),n=s}else if(Lh(t)){const r=new om(t.name,t.data);t["x-name"]!=null&&(r["x-name"]=t["x-name"],r["x-publicId"]=t["x-publicId"],r["x-systemId"]=t["x-systemId"]),n=r}else throw new Error(`Not implemented yet: ${t.type}`);return n.startIndex=t.startIndex,n.endIndex=t.endIndex,t.sourceCodeLocation!=null&&(n.sourceCodeLocation=t.sourceCodeLocation),n}function yd(t){const e=t.map(n=>Gi(n,!0));for(let n=1;n<e.length;n++)e[n].prev=e[n-1],e[n-1].next=e[n];return e}const p0={withStartIndices:!1,withEndIndices:!1,xmlMode:!1};class BL{constructor(e,n,r){this.dom=[],this.root=new Cs(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null,typeof n=="function"&&(r=n,n=p0),typeof e=="object"&&(n=e,e=void 0),this.callback=e??null,this.options=n??p0,this.elementCB=r??null}onparserinit(e){this.parser=e}onreset(){this.dom=[],this.root=new Cs(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null}onend(){this.done||(this.done=!0,this.parser=null,this.handleCallback(null))}onerror(e){this.handleCallback(e)}onclosetag(){this.lastNode=null;const e=this.tagStack.pop();this.options.withEndIndices&&(e.endIndex=this.parser.endIndex),this.elementCB&&this.elementCB(e)}onopentag(e,n){const r=this.options.xmlMode?qe.Tag:void 0,s=new cm(e,n,void 0,r);this.addNode(s),this.tagStack.push(s)}ontext(e){const{lastNode:n}=this;if(n&&n.type===qe.Text)n.data+=e,this.options.withEndIndices&&(n.endIndex=this.parser.endIndex);else{const r=new Wi(e);this.addNode(r),this.lastNode=r}}oncomment(e){if(this.lastNode&&this.lastNode.type===qe.Comment){this.lastNode.data+=e;return}const n=new im(e);this.addNode(n),this.lastNode=n}oncommentend(){this.lastNode=null}oncdatastart(){const e=new Wi(""),n=new IE([e]);this.addNode(n),e.parent=n,this.lastNode=e}oncdataend(){this.lastNode=null}onprocessinginstruction(e,n){const r=new om(e,n);this.addNode(r)}handleCallback(e){if(typeof this.callback=="function")this.callback(e,this.dom);else if(e)throw e}addNode(e){const n=this.tagStack[this.tagStack.length-1],r=n.children[n.children.length-1];this.options.withStartIndices&&(e.startIndex=this.parser.startIndex),this.options.withEndIndices&&(e.endIndex=this.parser.endIndex),n.children.push(e),r&&(e.prev=r,r.next=e),e.parent=n,this.lastNode=null}}const lm=new Uint16Array('<\0\0\0\0\0\0EMabcfglmnoprstu\\bfmsligP&cutereve;iyx}rc;r;ravepha;acr;d;gpon;f;plyFunction;ingcsr;ign;ildemlaceforsucrkslash;;ed;y;crtause;noullis;a;r;pf;eve;cmpeq;HOacdefhilorsucy;PYcpyute;;italDifferentialD;leys;aeioron;dilrc;nint;ot;dnilla;terDot;i;rcleDMPTot;inus;lus;imes;ocskwiseContourIntegral;eCurlyDQoubleQuote;uote;lnpuon;e;gitruent;nt;ourIntegral;fr;oduct;nterClockwiseContourIntegral;oss;cr;p;Cap;DJSZacefios;otrahd;cy;cy;cy;grsger;r;hv;ayron;;l;ta;r;afcmriticalADGTcute;o;bleAcute;rave;ilde;ond;ferentialD;\0\0\0\0f;;DEot;qual;bleCDLRUVontourIntegrao\0\0nArrow;eoftARTrrow;ightArrow;engLReftARrrow;ightArrow;ightArrow;ightATrrow;ee;p\0\0rrow;ownArrow;erticalBar;nABLRTarrow;BUar;pArrow;reve;eft\0\0ightVector;eeVector;ector;Bar;ight\0eeVector;ector;Bar;ee;Arrow;ctr;rok;NTacdfglmopqstuxG;Hcuteaiyron;rc;ot;r;raveement;apcr;ty\0\0mallSquare;erySmallSquare;gpon;f;silon;uail;Tilde;librium;cir;m;a;mlipsts;onentialE;cfiosy;r;lled\0\0mallSquare;erySmallSquare;\0\0\0f;All;riertrf;cJTabcdfgorstcy;>mma;d;reve;eiydil;rc;;ot;r;;pf;eaterEFGLSTqual;Less;ullEqual;reater;ess;lantEqual;ilde;cr;;AacfiosuRDcy;ctek;;irc;r;lbertSpace;\0f;izontalLine;ctrok;mpownHumqual;EJOacdfgmnostucy;lig;cy;cuteiyrc;ot;r;rave;apcgr;inaryI;lie\0;egrral;section;isibleCTomma;imes;gpton;f;a;cr;ilde;\0cy;lcfosuiyrc;;r;pf;\0r;rcy;kcy;HJacfoscy;cy;ppa;eydil;;r;pf;cr;JTaceflmostcy;<cmnprute;bda;g;lacetrf;r;aeyron;dil;;fstACDFRTUVarnrgleBracket;row;BRar;ightArrow;eiling;o\0bleBracket;n\0eeVector;ector;Bar;loor;ightAVrrow;ector;ere;AVrrow;ector;iangle;BEar;qual;pDTVownVector;eeVector;ector;Bar;ector;Bar;ightsEFGLSTqualGreater;ullEqual;reater;ess;lantEqual;ilde;r;;eftarrow;idot;npwgLRlreftARrrow;ightArrow;ightArrow;eftarightightf;erLReftArrow;ightArrow;cht;rok;;acefiosup;y;dliumSpace;lintrf;r;nusPlus;pf;c;Jacefostucy;cute;aeyron;dil;;gswativeMTVediumSpace;hicneryThitedGLreaterGreateessLesLine;r;Bnptreak;BreakingSpace;f;;CDEGHLNPRSTVoungruent;pCap;oubleVerticalBar;lqxement;ual;Tilde;ists;reater;EFGLSTqual;ullEqual;reater;ess;lantEqual;ilde;umpownHump;qual;efstTriangle;BEar;qual;s;EGLSTqual;reater;ess;lantEqual;ilde;estedGLreaterGreater;essLess;recedes;ESqual;lantEqual;eiverseElement;ghtTriangle;BEar;qual;quuareSubpset;Equal;erset;Equal;bcpset;Equal;ceeds;ESTqual;lantEqual;ilde;erset;Equal;ilde;EFTqual;ullEqual;ilde;erticalBar;cr;ilde;Eacdfgmoprstuvlig;cuteiyrc;blac;r;raveaeicr;ga;cron;pf;enCurlyDQoubleQuote;uote;;clr;ashidees;mlerBParr;acek;et;arenthesis;acfhilorsrtialD;y;r;i;;usMinus;ipncareplanf;;eiocedes;ESTqual;lantEqual;ilde;me;dpuct;ortion;al;cir;;UfosOT"r;pf;cr;BEacefhiorsuarr;Gcnrute;g;r;tl;aeyron;dil;;;verseEUlqement;uilibrium;pEquilibrium;ro;ghtACDFTUVanrgleBracket;row;BLar;eftArrow;eiling;o\0bleBracket;n\0eeVector;ector;Bar;loor;ere;AVrrow;ector;iangle;BEar;qual;pDTVownVector;eeVector;ector;Bar;ector;Bar;puf;ndImplies;ightarrow;chr;;leDelayed;HOacfhimoqstuCcHcy;y;FTcy;cute;;aeiyron;dil;rc;;r;ortDLRUownArroweftArrowightArrowpArrow;gma;allCircle;pf;\0\0t;are;ISUntersection;ubpset;Equal;erset;Equal;nion;cr;ar;bcmp;set;Equal;cheeds;ESTqual;lantEqual;ilde;Th;;esrset;Equal;etHRSacfhiorsORNADE;Hccy;y;bu;;aeyron;dil;;r;ei\0efore;a;cnkSpace;Space;lde;EFTqual;ullEqual;ilde;pf;ipleDot;ctr;rok;\0\0\0\0\0\0\0cruter;ocir;r\0y;ve;iyrc;blac;r;raveacr;dierBParr;acek;et;arenthesis;on;Plus;gpon;f;ADETadpsrrow;BDar;ownArrow;ownArrow;quilibrium;ee;Arrow;ownerLReftArrow;ightArrow;i;lon;ing;cr;ilde;mlDbcdefosvash;ar;y;ash;l;er;btyar;;icalBLSTar;ine;eparator;ilde;ThinSpace;r;pf;cr;dash;cefosirc;dge;r;pf;cr;fiosr;;pf;cr;AIUacfosucy;cy;cy;cuteiyrc;;r;pf;cr;ml;Hacdefoscy;cute;ayron;;ot;\0oWidta;r;pf;cr;\0\0\0\0\0\0\0cutereve;;Ediuy;;rcte;lig;r;raveepfpsym;ha;apcclr;g;\0\0;adsvnd;;lope;;;elmrsz;esd;a;;;;;;;;t;vb;d;pth;arr;gpon;f;;Eaeiop;cir;;d;s;rox;eingctyr;;mp;eildemlcioninnt;Nabcdefiklnoprsuot;crkcepsong;psilon;rime;im;eq;ee;ed;gerk;tbrk;oy;quo;cmprtaus;eptyv;snoahw;;een;r;gcostuvwaiurc;pdptot;lus;imes;\0\0cup;ar;riangleduown;p;plus;earow;akocnklstozenge;riangle;dlrown;eft;ight;k;\0\0;;4;ck;eo;q=uiv;t;ptwxf;;tomtie;DHUVbdhmptuvLRlr;;;;;DUdu;;;;LRlr;;;;;HLRhlr;;;;;;ox;LRlr;;;;;DUdu;;;;inus;lus;imes;LRlr;;;;;HLRhlr;;;;;;evbarceior;mi;m;el;bh;sub;l;etp;Ee;;q\0\0\0\0\0\0\0\0\0\0cprute;;abcdsnd;rcup;aup;p;ot;;eot;aeiu\0s;on;dilrc;ps;sm;ot;dmnilptyv;t;err;ceiy;ck;mark;r;Ecefms;;elq;e\0\0rrowlreft;ight;RSacd;st;irc;ash;nint;id;cir;ubs;uit\0on;e;q\0\0a;t;;flemxente\0;dot;nfry;o;sr;aorr;ss;cur;bp;e;;e;dot;delprvwarrlr;;\0\0r;c;arr;p;;bcdosrcap;aup;p;ot;r;;alrvrr;m;yevwq\0\0reuee;edge;enearrowlreftightecioninnt;lcty;AHabcdefhijlorstuwzrar;glrsger;eth;h;varow;aayron;;;aogrr;tseq;glmta;ptyv;irsht;;arlraegsvm;osnd;suit;amma;in;;iode;ontimes;ncy;c\0\0rn;op;lptuwlar;f;;empsq;dot;inus;lus;quare;blebarwedgnadhownarrowarpoonlrefighkaro\0\0rn;op;cotry;;l;rok;drot;i;fahraangle;ciy;grarr;DacdefglmnopqrstuxDoocsuteter;aioyron;r;clon;;ot;Drot;;;rsave;dot;;ilsnters;;;dot;apscr;ty;svetp1;;;gs;p;gpon;f;alsr;sl;us;i;lvon;csuviorc\0\0antgltressaeils;st;v;DD;parsl;Daot;rr;cdir;oah;mrlo;cipl;seoctationential\0\0\0\0\0\0\0llingdotsey;male;ilrlig;\0\0g;ig;;lig;lig;fjaltt;ig;ns;of;\0f;ak;v;artint;aocs\0\0;;;;\0;;\0\0;;5;\0;;8;l;wn;cr;Eabcdefgijlnorstv;l;cmpute;ma;d;reve;iyrc;;ot;;lqs;qslan;cdlc;ot;o;l;;es;r;;gmel;cy;;Eaj;;;Eaes;p;prox;q;qim;pf;cir;m;el;;>;cdlqrci;r;ot;Par;uest;adels\0pror;qlqlesienrtneqq;Aabcefkosyrilmrrsfildrcy;;cwir;;ar;irc;alrrts;uitlip;con;r;sewarow;arow;amoprrr;tht;klreftarrow;ightarrow;f;bar;cltr;asrok;bpull;hen\0\0\0\0\0\0cute;iyrc;cxy;clfr;rave;inoinnt;t;fin;ta;lig;aopcgtr;elpinarh;f;ed;;cfotare;in;tie;do;celpal;grerarhk;rod;cgpty;on;f;a;uestcir;n;Edsv;ot;;v;;ilde;\0cy;lcfmosuiyrc;;r;ath;pf;\0r;rcy;kcy;acfghjosppa;v;eydil;;r;reen;cy;cy;pf;cr;ABEHabcdefghjlmnoprstuvartrail;arr;;g;ar;\0\0\0\0\0\0\0\0\0ute;mptyv;rabda;g;dl;;uor;bfhlpst;fs;s;p;l;im;l;;aeil;;s;abrrr;rk;akcek;;es;ldu;;aeuyron;diil;;cqrsa;uo;rduhar;shar;h;;fgqstahlrtrrow;taarpoonduownpeftarrows;ightahsrrow;sarpoonquigarrohreetimes;;qslan;cdgsc;ot;o;r;;es;adegspproot;qgqgtiilrsht;;;E;rdu;l;lk;cy;;achtrorneard;ri;iodot;ust;acheEaes;p;prox;q;qim;abnoptwznrg;r;rglmreftarightapsto;ightparrowlrefight;aflr;;us;imes;st;;efngear;lt;achmtrornear;d;;ri;achiqtquo;r;m;eg;;buo;r;rok;<;cdhilqrci;r;remes;arr;uest;Piar;;efrdushar;har;enrtneqq;DacdefhilnopsuDot;clprret;;ese;sto;dluowefker;oymma;;ash;asuredangler;o;cdnro;acdsir;otus;bd;u;p;dpels;f;ctr;pos;lmtimap;GLRVabcdefghijlmoprstuvwgt;;veltftarrrow;ightarrow;;;vightarrow;Ddash;ash;bcnptlaute;g;;Eiop;d;s;rour;al;s\0pmp;eaeouy\0;on;dil;ng;dot;p;;ash;;Aadqsxrr;rhrk;;oot;uieiar;ist;sr;Eest;qs;qslani;rAaprrr;ar;;sv;d;cy;AEadestr;rr;r;;fqstarrroightarro;qslan;si;ri;eiptf;;inn;Edv;ot;;;i;v;;aorr;astllel;;lint;;ceu;c;eAaitrrr;cw;;ghtarrowri;echimpqu;ceru;ort\0\0arm;e;qsubpbcp;Ees;et;eq;qc;e;Ees;et;eq;qgilrldeianglelreft;eight;e;m;esro;p;DHadgilrsash;arr;p;ash;et;;>nfin;Aetrr;;;r<ie;Atrr;rie;im;Aanrr;rhrk;;oear;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0csuteiyr;c;abioslac;v;old;lig;crir;;\0\0\0n;ave;bmar;acitrirr;oss;n;aeicr;ga;cdnron;;pf;aelr;rp;;adiosvr;efmr;ofgof;r;lope;;cloashl;idees;as;mlbar;\0\0\0\0\0\0\0\0\0r;ast;lle\0\0m;;y;rcimptnt;od;il;enk;r;imo;v;mane;;tvchfork;aunckk;h;s;abcdemstcir;ir;ou;;nim;wo;ipuntint;f;nd;Eaceinosu;p;u;c;acenspprourlyeaespprox;qq;im;ime;sEasdfpalslar;ine;urf;;trel;cir;;ncsp;fiopsur;pf;rime;cr;aeoteirnionnt;st;eABHabcdefhilmnoprstuxartrail;arar;cdenqrteu;te;imptyv;g;del;;uor;abcfhlpstwp;;fs;;s;l;im;l;;aiil;o;nalabrrrk;akcek;;es;ldu;;aeuyron;diil;;clqsa;dhar;uo;rh;acgl;ipsnart;ilrsht;;aordu;l;;v;gnshtahlrstrrow;taarpoonduowpeftahrrowarpoonightarrows;quigarrohreetimes;g;ingdotseahmra;oust;achemid;abptnrg;r;raflr;;us;imes;apr;gt;olint;arachqquo;r;buo;rhirremes;i;efltri;luhar;;\0\0\0\0\0\0\0cute;qu;Eaceinpsy;\0;on;u;dil;rc;Eas;p;im;olint;i;ot;be;Aacmstxrr;rhr;oti;war;minnut;r;oacoyrp;hycy;;rt\0\0iaragmma;fv;;deglnprot;;q;E;;E;e;lus;arr;araeitlslsetmhp;parsl;dle;;e;s;flptcy;;b;ar;f;adres;uitcsuaup;s;p;s;ubp;eset;e;eset;e;afrarcemtr;tmiararr;fanighteppsilohsbcmnp;Edemnprs;ot;;dot;ult;Ee;;lus;arr;eiut;enq;qeq;qm;bp;;c;acenspprourlyeaespproqg;123;Edehlmnps;ost;ub;;dot;soul;b;arr;ult;Ee;;lus;eiut;enq;qeq;qm;bp;;Aanrr;rhr;owar;lig\0\0\0\0\0\0\0\0\0\0\0\0get;;raeyron;dil;;lrec;r;eiko\0e4fa;svym;cnkaspproimsasrnes;bd;ar;;eps;bcfot;ir;;ork;rime;aipdadempstngle;dlqrowneft;e;ight;eot;inus;lus;b;ime;ezium;chtry;;cy;rok;ioxheadlreftarroightarrowAHabcdfghlmoprstuwrar;cruter\0y;ve;iyrc;abhrlac;airsht;;raverlrlk;ct\0\0rn;erop;ri;alcr;gpon;f;adhlsuownarpoonlrefighi;hlonparrows;cit\0\0rn;erop;ng;ri;cr;dirot;lde;i;famrlangle;ABDacdeflnoprszrar;v;asnrgrt;eknprstappothinhirop;hiugmbpsetneq;q;setneq;q;hretianglelreftighty;ashelr;bear;q;lip;btar;trsubppf;rotrcur;bpnEenEeigzag;cefoprsirc;dibgar;e;q;erp;r;pf;;eatcr;\0\0\0\0\0\0\0trr;Aarr;Aarrais;dptfl;imAarrcqr;ptracefiosucuyte;iyrc;;nr;cy;pf;cr;cmy;lacdefhioswcute;ayron;;ot;ettra;r;cy;grarr;pf;cr;jn;j;'.split("").map(t=>t.charCodeAt(0))),kE=new Uint16Array("aglq	\x1B\0\0p;os;t;t;uot;".split("").map(t=>t.charCodeAt(0)));var Ed;const FL=new Map([[0,65533],[128,8364],[130,8218],[131,402],[132,8222],[133,8230],[134,8224],[135,8225],[136,710],[137,8240],[138,352],[139,8249],[140,338],[142,381],[145,8216],[146,8217],[147,8220],[148,8221],[149,8226],[150,8211],[151,8212],[152,732],[153,8482],[154,353],[155,8250],[156,339],[158,382],[159,376]]),Dh=(Ed=String.fromCodePoint)!==null&&Ed!==void 0?Ed:function(t){let e="";return t>65535&&(t-=65536,e+=String.fromCharCode(t>>>10&1023|55296),t=56320|t&1023),e+=String.fromCharCode(t),e};function UL(t){var e;return t>=55296&&t<=57343||t>1114111?65533:(e=FL.get(t))!==null&&e!==void 0?e:t}var Ct;(function(t){t[t.NUM=35]="NUM",t[t.SEMI=59]="SEMI",t[t.EQUALS=61]="EQUALS",t[t.ZERO=48]="ZERO",t[t.NINE=57]="NINE",t[t.LOWER_A=97]="LOWER_A",t[t.LOWER_F=102]="LOWER_F",t[t.LOWER_X=120]="LOWER_X",t[t.LOWER_Z=122]="LOWER_Z",t[t.UPPER_A=65]="UPPER_A",t[t.UPPER_F=70]="UPPER_F",t[t.UPPER_Z=90]="UPPER_Z"})(Ct||(Ct={}));const jL=32;var $r;(function(t){t[t.VALUE_LENGTH=49152]="VALUE_LENGTH",t[t.BRANCH_LENGTH=16256]="BRANCH_LENGTH",t[t.JUMP_TABLE=127]="JUMP_TABLE"})($r||($r={}));function Mh(t){return t>=Ct.ZERO&&t<=Ct.NINE}function HL(t){return t>=Ct.UPPER_A&&t<=Ct.UPPER_F||t>=Ct.LOWER_A&&t<=Ct.LOWER_F}function $L(t){return t>=Ct.UPPER_A&&t<=Ct.UPPER_Z||t>=Ct.LOWER_A&&t<=Ct.LOWER_Z||Mh(t)}function qL(t){return t===Ct.EQUALS||$L(t)}var wt;(function(t){t[t.EntityStart=0]="EntityStart",t[t.NumericStart=1]="NumericStart",t[t.NumericDecimal=2]="NumericDecimal",t[t.NumericHex=3]="NumericHex",t[t.NamedEntity=4]="NamedEntity"})(wt||(wt={}));var Sn;(function(t){t[t.Legacy=0]="Legacy",t[t.Strict=1]="Strict",t[t.Attribute=2]="Attribute"})(Sn||(Sn={}));class dm{constructor(e,n,r){this.decodeTree=e,this.emitCodePoint=n,this.errors=r,this.state=wt.EntityStart,this.consumed=1,this.result=0,this.treeIndex=0,this.excess=1,this.decodeMode=Sn.Strict}startEntity(e){this.decodeMode=e,this.state=wt.EntityStart,this.result=0,this.treeIndex=0,this.excess=1,this.consumed=1}write(e,n){switch(this.state){case wt.EntityStart:return e.charCodeAt(n)===Ct.NUM?(this.state=wt.NumericStart,this.consumed+=1,this.stateNumericStart(e,n+1)):(this.state=wt.NamedEntity,this.stateNamedEntity(e,n));case wt.NumericStart:return this.stateNumericStart(e,n);case wt.NumericDecimal:return this.stateNumericDecimal(e,n);case wt.NumericHex:return this.stateNumericHex(e,n);case wt.NamedEntity:return this.stateNamedEntity(e,n)}}stateNumericStart(e,n){return n>=e.length?-1:(e.charCodeAt(n)|jL)===Ct.LOWER_X?(this.state=wt.NumericHex,this.consumed+=1,this.stateNumericHex(e,n+1)):(this.state=wt.NumericDecimal,this.stateNumericDecimal(e,n))}addToNumericResult(e,n,r,s){if(n!==r){const a=r-n;this.result=this.result*Math.pow(s,a)+parseInt(e.substr(n,a),s),this.consumed+=a}}stateNumericHex(e,n){const r=n;for(;n<e.length;){const s=e.charCodeAt(n);if(Mh(s)||HL(s))n+=1;else return this.addToNumericResult(e,r,n,16),this.emitNumericEntity(s,3)}return this.addToNumericResult(e,r,n,16),-1}stateNumericDecimal(e,n){const r=n;for(;n<e.length;){const s=e.charCodeAt(n);if(Mh(s))n+=1;else return this.addToNumericResult(e,r,n,10),this.emitNumericEntity(s,2)}return this.addToNumericResult(e,r,n,10),-1}emitNumericEntity(e,n){var r;if(this.consumed<=n)return(r=this.errors)===null||r===void 0||r.absenceOfDigitsInNumericCharacterReference(this.consumed),0;if(e===Ct.SEMI)this.consumed+=1;else if(this.decodeMode===Sn.Strict)return 0;return this.emitCodePoint(UL(this.result),this.consumed),this.errors&&(e!==Ct.SEMI&&this.errors.missingSemicolonAfterCharacterReference(),this.errors.validateNumericCharacterReference(this.result)),this.consumed}stateNamedEntity(e,n){const{decodeTree:r}=this;let s=r[this.treeIndex],a=(s&$r.VALUE_LENGTH)>>14;for(;n<e.length;n++,this.excess++){const i=e.charCodeAt(n);if(this.treeIndex=VL(r,s,this.treeIndex+Math.max(1,a),i),this.treeIndex<0)return this.result===0||this.decodeMode===Sn.Attribute&&(a===0||qL(i))?0:this.emitNotTerminatedNamedEntity();if(s=r[this.treeIndex],a=(s&$r.VALUE_LENGTH)>>14,a!==0){if(i===Ct.SEMI)return this.emitNamedEntityData(this.treeIndex,a,this.consumed+this.excess);this.decodeMode!==Sn.Strict&&(this.result=this.treeIndex,this.consumed+=this.excess,this.excess=0)}}return-1}emitNotTerminatedNamedEntity(){var e;const{result:n,decodeTree:r}=this,s=(r[n]&$r.VALUE_LENGTH)>>14;return this.emitNamedEntityData(n,s,this.consumed),(e=this.errors)===null||e===void 0||e.missingSemicolonAfterCharacterReference(),this.consumed}emitNamedEntityData(e,n,r){const{decodeTree:s}=this;return this.emitCodePoint(n===1?s[e]&~$r.VALUE_LENGTH:s[e+1],r),n===3&&this.emitCodePoint(s[e+2],r),r}end(){var e;switch(this.state){case wt.NamedEntity:return this.result!==0&&(this.decodeMode!==Sn.Attribute||this.result===this.treeIndex)?this.emitNotTerminatedNamedEntity():0;case wt.NumericDecimal:return this.emitNumericEntity(0,2);case wt.NumericHex:return this.emitNumericEntity(0,3);case wt.NumericStart:return(e=this.errors)===null||e===void 0||e.absenceOfDigitsInNumericCharacterReference(this.consumed),0;case wt.EntityStart:return 0}}}function NE(t){let e="";const n=new dm(t,r=>e+=Dh(r));return function(s,a){let i=0,o=0;for(;(o=s.indexOf("&",o))>=0;){e+=s.slice(i,o),n.startEntity(a);const c=n.write(s,o+1);if(c<0){i=o+n.end();break}i=o+c,o=c===0?i+1:i}const u=e+s.slice(i);return e="",u}}function VL(t,e,n,r){const s=(e&$r.BRANCH_LENGTH)>>7,a=e&$r.JUMP_TABLE;if(s===0)return a!==0&&r===a?n:-1;if(a){const u=r-a;return u<0||u>=s?-1:t[n+u]-1}let i=n,o=i+s-1;for(;i<=o;){const u=i+o>>>1,c=t[u];if(c<r)i=u+1;else if(c>r)o=u-1;else return t[u+s]}return-1}NE(lm);NE(kE);const g0=/["&'<>$\x80-\uFFFF]/g,zL=new Map([[34,"&quot;"],[38,"&amp;"],[39,"&apos;"],[60,"&lt;"],[62,"&gt;"]]),WL=String.prototype.codePointAt!=null?(t,e)=>t.codePointAt(e):(t,e)=>(t.charCodeAt(e)&64512)===55296?(t.charCodeAt(e)-55296)*1024+t.charCodeAt(e+1)-56320+65536:t.charCodeAt(e);function RE(t){let e="",n=0,r;for(;(r=g0.exec(t))!==null;){const s=r.index,a=t.charCodeAt(s),i=zL.get(a);i!==void 0?(e+=t.substring(n,s)+i,n=s+1):(e+=`${t.substring(n,s)}&#x${WL(t,s).toString(16)};`,n=g0.lastIndex+=+((a&64512)===55296))}return e+t.substr(n)}function PE(t,e){return function(r){let s,a=0,i="";for(;s=t.exec(r);)a!==s.index&&(i+=r.substring(a,s.index)),i+=e.get(s[0].charCodeAt(0)),a=s.index+1;return i+r.substring(a)}}const xE=PE(/["&\u00A0]/g,new Map([[34,"&quot;"],[38,"&amp;"],[160,"&nbsp;"]])),LE=PE(/[&<>\u00A0]/g,new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[160,"&nbsp;"]])),GL=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(t=>[t.toLowerCase(),t])),KL=new Map(["definitionURL","attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(t=>[t.toLowerCase(),t])),YL=new Set(["style","script","xmp","iframe","noembed","noframes","plaintext","noscript"]);function ZL(t){return t.replace(/"/g,"&quot;")}function JL(t,e){var n;if(!t)return;const r=((n=e.encodeEntities)!==null&&n!==void 0?n:e.decodeEntities)===!1?ZL:e.xmlMode||e.encodeEntities!=="utf8"?RE:xE;return Object.keys(t).map(s=>{var a,i;const o=(a=t[s])!==null&&a!==void 0?a:"";return e.xmlMode==="foreign"&&(s=(i=KL.get(s))!==null&&i!==void 0?i:s),!e.emptyAttrs&&!e.xmlMode&&o===""?s:`${s}="${r(o)}"`}).join(" ")}const b0=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]);function il(t,e={}){const n="length"in t?t:[t];let r="";for(let s=0;s<n.length;s++)r+=XL(n[s],e);return r}function XL(t,e){switch(t.type){case IL:return il(t.children,e);case ML:case NL:return n4(t);case RL:return a4(t);case DL:return s4(t);case PL:case xL:case LL:return t4(t,e);case kL:return r4(t,e)}}const QL=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignObject","desc","title"]),e4=new Set(["svg","math"]);function t4(t,e){var n;e.xmlMode==="foreign"&&(t.name=(n=GL.get(t.name))!==null&&n!==void 0?n:t.name,t.parent&&QL.has(t.parent.name)&&(e={...e,xmlMode:!1})),!e.xmlMode&&e4.has(t.name)&&(e={...e,xmlMode:"foreign"});let r=`<${t.name}`;const s=JL(t.attribs,e);return s&&(r+=` ${s}`),t.children.length===0&&(e.xmlMode?e.selfClosingTags!==!1:e.selfClosingTags&&b0.has(t.name))?(e.xmlMode||(r+=" "),r+="/>"):(r+=">",t.children.length>0&&(r+=il(t.children,e)),(e.xmlMode||!b0.has(t.name))&&(r+=`</${t.name}>`)),r}function n4(t){return`<${t.data}>`}function r4(t,e){var n;let r=t.data||"";return((n=e.encodeEntities)!==null&&n!==void 0?n:e.decodeEntities)!==!1&&!(!e.xmlMode&&t.parent&&YL.has(t.parent.name))&&(r=e.xmlMode||e.encodeEntities!=="utf8"?RE(r):LE(r)),r}function s4(t){return`<![CDATA[${t.children[0].data}]]>`}function a4(t){return`<!--${t.data}-->`}function DE(t,e){return il(t,e)}function i4(t,e){return ot(t)?t.children.map(n=>DE(n,e)).join(""):""}function Ou(t){return Array.isArray(t)?t.map(Ou).join(""):ge(t)?t.name==="br"?`
`:Ou(t.children):sl(t)?Ou(t.children):dr(t)?t.data:""}function fa(t){return Array.isArray(t)?t.map(fa).join(""):ot(t)&&!al(t)?fa(t.children):dr(t)?t.data:""}function ac(t){return Array.isArray(t)?t.map(ac).join(""):ot(t)&&(t.type===qe.Tag||sl(t))?ac(t.children):dr(t)?t.data:""}function ol(t){return ot(t)?t.children:[]}function ME(t){return t.parent||null}function BE(t){const e=ME(t);if(e!=null)return ol(e);const n=[t];let{prev:r,next:s}=t;for(;r!=null;)n.unshift(r),{prev:r}=r;for(;s!=null;)n.push(s),{next:s}=s;return n}function o4(t,e){var n;return(n=t.attribs)===null||n===void 0?void 0:n[e]}function u4(t,e){return t.attribs!=null&&Object.prototype.hasOwnProperty.call(t.attribs,e)&&t.attribs[e]!=null}function c4(t){return t.name}function hm(t){let{next:e}=t;for(;e!==null&&!ge(e);)({next:e}=e);return e}function fm(t){let{prev:e}=t;for(;e!==null&&!ge(e);)({prev:e}=e);return e}function ks(t){if(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.parent){const e=t.parent.children,n=e.lastIndexOf(t);n>=0&&e.splice(n,1)}t.next=null,t.prev=null,t.parent=null}function l4(t,e){const n=e.prev=t.prev;n&&(n.next=e);const r=e.next=t.next;r&&(r.prev=e);const s=e.parent=t.parent;if(s){const a=s.children;a[a.lastIndexOf(t)]=e,t.parent=null}}function d4(t,e){if(ks(e),e.next=null,e.parent=t,t.children.push(e)>1){const n=t.children[t.children.length-2];n.next=e,e.prev=n}else e.prev=null}function h4(t,e){ks(e);const{parent:n}=t,r=t.next;if(e.next=r,e.prev=t,t.next=e,e.parent=n,r){if(r.prev=e,n){const s=n.children;s.splice(s.lastIndexOf(r),0,e)}}else n&&n.children.push(e)}function f4(t,e){if(ks(e),e.parent=t,e.prev=null,t.children.unshift(e)!==1){const n=t.children[1];n.prev=e,e.next=n}else e.next=null}function m4(t,e){ks(e);const{parent:n}=t;if(n){const r=n.children;r.splice(r.indexOf(t),0,e)}t.prev&&(t.prev.next=e),e.parent=n,e.prev=t.prev,e.next=t,t.prev=e}function _o(t,e,n=!0,r=1/0){return mm(t,Array.isArray(e)?e:[e],n,r)}function mm(t,e,n,r){const s=[],a=[Array.isArray(e)?e:[e]],i=[0];for(;;){if(i[0]>=a[0].length){if(i.length===1)return s;a.shift(),i.shift();continue}const o=a[0][i[0]++];if(t(o)&&(s.push(o),--r<=0))return s;n&&ot(o)&&o.children.length>0&&(i.unshift(0),a.unshift(o.children))}}function p4(t,e){return e.find(t)}function pm(t,e,n=!0){const r=Array.isArray(e)?e:[e];for(let s=0;s<r.length;s++){const a=r[s];if(ge(a)&&t(a))return a;if(n&&ot(a)&&a.children.length>0){const i=pm(t,a.children,!0);if(i)return i}}return null}function FE(t,e){return(Array.isArray(e)?e:[e]).some(n=>ge(n)&&t(n)||ot(n)&&FE(t,n.children))}function g4(t,e){const n=[],r=[Array.isArray(e)?e:[e]],s=[0];for(;;){if(s[0]>=r[0].length){if(r.length===1)return n;r.shift(),s.shift();continue}const a=r[0][s[0]++];ge(a)&&t(a)&&n.push(a),ot(a)&&a.children.length>0&&(s.unshift(0),r.unshift(a.children))}}const ic={tag_name(t){return typeof t=="function"?e=>ge(e)&&t(e.name):t==="*"?ge:e=>ge(e)&&e.name===t},tag_type(t){return typeof t=="function"?e=>t(e.type):e=>e.type===t},tag_contains(t){return typeof t=="function"?e=>dr(e)&&t(e.data):e=>dr(e)&&e.data===t}};function gm(t,e){return typeof e=="function"?n=>ge(n)&&e(n.attribs[t]):n=>ge(n)&&n.attribs[t]===e}function b4(t,e){return n=>t(n)||e(n)}function UE(t){const e=Object.keys(t).map(n=>{const r=t[n];return Object.prototype.hasOwnProperty.call(ic,n)?ic[n](r):gm(n,r)});return e.length===0?null:e.reduce(b4)}function _4(t,e){const n=UE(t);return n?n(e):!0}function y4(t,e,n,r=1/0){const s=UE(t);return s?_o(s,e,n,r):[]}function E4(t,e,n=!0){return Array.isArray(e)||(e=[e]),pm(gm("id",t),e,n)}function Na(t,e,n=!0,r=1/0){return _o(ic.tag_name(t),e,n,r)}function w4(t,e,n=!0,r=1/0){return _o(gm("class",t),e,n,r)}function T4(t,e,n=!0,r=1/0){return _o(ic.tag_type(t),e,n,r)}function S4(t){let e=t.length;for(;--e>=0;){const n=t[e];if(e>0&&t.lastIndexOf(n,e-1)>=0){t.splice(e,1);continue}for(let r=n.parent;r;r=r.parent)if(t.includes(r)){t.splice(e,1);break}}return t}var wn;(function(t){t[t.DISCONNECTED=1]="DISCONNECTED",t[t.PRECEDING=2]="PRECEDING",t[t.FOLLOWING=4]="FOLLOWING",t[t.CONTAINS=8]="CONTAINS",t[t.CONTAINED_BY=16]="CONTAINED_BY"})(wn||(wn={}));function jE(t,e){const n=[],r=[];if(t===e)return 0;let s=ot(t)?t:t.parent;for(;s;)n.unshift(s),s=s.parent;for(s=ot(e)?e:e.parent;s;)r.unshift(s),s=s.parent;const a=Math.min(n.length,r.length);let i=0;for(;i<a&&n[i]===r[i];)i++;if(i===0)return wn.DISCONNECTED;const o=n[i-1],u=o.children,c=n[i],l=r[i];return u.indexOf(c)>u.indexOf(l)?o===e?wn.FOLLOWING|wn.CONTAINED_BY:wn.FOLLOWING:o===t?wn.PRECEDING|wn.CONTAINS:wn.PRECEDING}function Ra(t){return t=t.filter((e,n,r)=>!r.includes(e,n+1)),t.sort((e,n)=>{const r=jE(e,n);return r&wn.PRECEDING?-1:r&wn.FOLLOWING?1:0}),t}function A4(t){const e=oc(k4,t);return e?e.name==="feed"?C4(e):O4(e):null}function C4(t){var e;const n=t.children,r={type:"atom",items:Na("entry",n).map(i=>{var o;const{children:u}=i,c={media:HE(u)};Yt(c,"id","id",u),Yt(c,"title","title",u);const l=(o=oc("link",u))===null||o===void 0?void 0:o.attribs.href;l&&(c.link=l);const d=qr("summary",u)||qr("content",u);d&&(c.description=d);const m=qr("updated",u);return m&&(c.pubDate=new Date(m)),c})};Yt(r,"id","id",n),Yt(r,"title","title",n);const s=(e=oc("link",n))===null||e===void 0?void 0:e.attribs.href;s&&(r.link=s),Yt(r,"description","subtitle",n);const a=qr("updated",n);return a&&(r.updated=new Date(a)),Yt(r,"author","email",n,!0),r}function O4(t){var e,n;const r=(n=(e=oc("channel",t.children))===null||e===void 0?void 0:e.children)!==null&&n!==void 0?n:[],s={type:t.name.substr(0,3),id:"",items:Na("item",t.children).map(i=>{const{children:o}=i,u={media:HE(o)};Yt(u,"id","guid",o),Yt(u,"title","title",o),Yt(u,"link","link",o),Yt(u,"description","description",o);const c=qr("pubDate",o)||qr("dc:date",o);return c&&(u.pubDate=new Date(c)),u})};Yt(s,"title","title",r),Yt(s,"link","link",r),Yt(s,"description","description",r);const a=qr("lastBuildDate",r);return a&&(s.updated=new Date(a)),Yt(s,"author","managingEditor",r,!0),s}const v4=["url","type","lang"],I4=["fileSize","bitrate","framerate","samplingrate","channels","duration","height","width"];function HE(t){return Na("media:content",t).map(e=>{const{attribs:n}=e,r={medium:n.medium,isDefault:!!n.isDefault};for(const s of v4)n[s]&&(r[s]=n[s]);for(const s of I4)n[s]&&(r[s]=parseInt(n[s],10));return n.expression&&(r.expression=n.expression),r})}function oc(t,e){return Na(t,e,!0,1)[0]}function qr(t,e,n=!1){return fa(Na(t,e,n,1)).trim()}function Yt(t,e,n,r,s=!1){const a=qr(n,r,s);a&&(t[e]=a)}function k4(t){return t==="rss"||t==="feed"||t==="rdf:RDF"}const ul=Object.freeze(Object.defineProperty({__proto__:null,get DocumentPosition(){return wn},append:h4,appendChild:d4,compareDocumentPosition:jE,existsOne:FE,filter:_o,find:mm,findAll:g4,findOne:pm,findOneChild:p4,getAttributeValue:o4,getChildren:ol,getElementById:E4,getElements:y4,getElementsByClassName:w4,getElementsByTagName:Na,getElementsByTagType:T4,getFeed:A4,getInnerHTML:i4,getName:c4,getOuterHTML:DE,getParent:ME,getSiblings:BE,getText:Ou,hasAttrib:u4,hasChildren:ot,innerText:ac,isCDATA:sl,isComment:al,isDocument:Xr,isTag:ge,isText:dr,nextElementSibling:hm,prepend:m4,prependChild:f4,prevElementSibling:fm,removeElement:ks,removeSubsets:S4,replaceElement:l4,testElement:_4,textContent:fa,uniqueSort:Ra},Symbol.toStringTag,{value:"Module"})),N4={_useHtmlParser2:!1};function Bh(t,e){if(!t)return e??N4;const n={_useHtmlParser2:!!t.xmlMode,...e,...t};return t.xml?(n._useHtmlParser2=!0,n.xmlMode=!0,t.xml!==!0&&Object.assign(n,t.xml)):t.xmlMode&&(n._useHtmlParser2=!0),n}function $E(t,e,n){return t?t(e??t._root.children,null,void 0,n).toString():""}function R4(t,e){return typeof t=="object"&&t!=null&&!("length"in t)&&!("type"in t)}function P4(t,e){const n=R4(t)?(e=t,void 0):t,r={...this===null||this===void 0?void 0:this._options,...Bh(e)};return $E(this,n,r)}function x4(t){const e={...this._options,xmlMode:!0};return $E(this,t,e)}function Ki(t){const e=t??(this?this.root():[]);let n="";for(let r=0;r<e.length;r++)n+=fa(e[r]);return n}function L4(t,e,n=typeof e=="boolean"?e:!1){if(!t||typeof t!="string")return null;typeof e=="boolean"&&(n=e);const r=this.load(t,this._options,!1);return n||r("script").remove(),[...r.root()[0].children]}function D4(){return this(this._root)}function qE(t,e){if(e===t)return!1;let n=e;for(;n&&n!==n.parent;)if(n=n.parent,n===t)return!0;return!1}function M4(t){return this.root().extract(t)}function B4(t,e){if(!_0(t)||!_0(e))return;let n=t.length;const r=+e.length;for(let s=0;s<r;s++)t[n++]=e[s];return t.length=n,t}function _0(t){if(Array.isArray(t))return!0;if(typeof t!="object"||t===null||!("length"in t)||typeof t.length!="number"||t.length<0)return!1;for(let e=0;e<t.length;e++)if(!(e in t))return!1;return!0}const F4=Object.freeze(Object.defineProperty({__proto__:null,contains:qE,extract:M4,html:P4,merge:B4,parseHTML:L4,root:D4,text:Ki,xml:x4},Symbol.toStringTag,{value:"Module"}));function Ir(t){return t.cheerio!=null}function U4(t){return t.replace(/[._-](\w|$)/g,(e,n)=>n.toUpperCase())}function j4(t){return t.replace(/[A-Z]/g,"-$&").toLowerCase()}function st(t,e){const n=t.length;for(let r=0;r<n;r++)e(t[r],r);return t}var rs;(function(t){t[t.LowerA=97]="LowerA",t[t.LowerZ=122]="LowerZ",t[t.UpperA=65]="UpperA",t[t.UpperZ=90]="UpperZ",t[t.Exclamation=33]="Exclamation"})(rs||(rs={}));function Fh(t){const e=t.indexOf("<");if(e<0||e>t.length-3)return!1;const n=t.charCodeAt(e+1);return(n>=rs.LowerA&&n<=rs.LowerZ||n>=rs.UpperA&&n<=rs.UpperZ||n===rs.Exclamation)&&t.includes(">",e+2)}const Yi=Object.prototype.hasOwnProperty,Zi=/\s+/,Uh="data-",bm=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,H4=/^{[^]*}$|^\[[^]*]$/;function uc(t,e,n){var r;if(!(!t||!ge(t))){if((r=t.attribs)!==null&&r!==void 0||(t.attribs={}),!e)return t.attribs;if(Yi.call(t.attribs,e))return!n&&bm.test(e)?e:t.attribs[e];if(t.name==="option"&&e==="value")return Ki(t.children);if(t.name==="input"&&(t.attribs.type==="radio"||t.attribs.type==="checkbox")&&e==="value")return"on"}}function aa(t,e,n){n===null?zE(t,e):t.attribs[e]=`${n}`}function $4(t,e){if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t!="string")throw new Error("Bad combination of arguments.");return st(this,(n,r)=>{ge(n)&&aa(n,t,e.call(n,r,n.attribs[t]))})}return st(this,n=>{if(ge(n))if(typeof t=="object")for(const r of Object.keys(t)){const s=t[r];aa(n,r,s)}else aa(n,t,e)})}return arguments.length>1?this:uc(this[0],t,this.options.xmlMode)}function y0(t,e,n){return e in t?t[e]:!n&&bm.test(e)?uc(t,e,!1)!==void 0:uc(t,e,n)}function wd(t,e,n,r){e in t?t[e]=n:aa(t,e,!r&&bm.test(e)?n?"":null:`${n}`)}function q4(t,e){var n;if(typeof t=="string"&&e===void 0){const r=this[0];if(!r||!ge(r))return;switch(t){case"style":{const s=this.css(),a=Object.keys(s);for(let i=0;i<a.length;i++)s[i]=a[i];return s.length=a.length,s}case"tagName":case"nodeName":return r.name.toUpperCase();case"href":case"src":{const s=(n=r.attribs)===null||n===void 0?void 0:n[t];return typeof URL<"u"&&(t==="href"&&(r.tagName==="a"||r.tagName==="link")||t==="src"&&(r.tagName==="img"||r.tagName==="iframe"||r.tagName==="audio"||r.tagName==="video"||r.tagName==="source"))&&s!==void 0&&this.options.baseURI?new URL(s,this.options.baseURI).href:s}case"innerText":return ac(r);case"textContent":return fa(r);case"outerHTML":return this.clone().wrap("<container />").parent().html();case"innerHTML":return this.html();default:return y0(r,t,this.options.xmlMode)}}if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t=="object")throw new TypeError("Bad combination of arguments.");return st(this,(r,s)=>{ge(r)&&wd(r,t,e.call(r,s,y0(r,t,this.options.xmlMode)),this.options.xmlMode)})}return st(this,r=>{if(ge(r))if(typeof t=="object")for(const s of Object.keys(t)){const a=t[s];wd(r,s,a,this.options.xmlMode)}else wd(r,t,e,this.options.xmlMode)})}}function E0(t,e,n){var r;(r=t.data)!==null&&r!==void 0||(t.data={}),typeof e=="object"?Object.assign(t.data,e):typeof e=="string"&&n!==void 0&&(t.data[e]=n)}function V4(t){for(const e of Object.keys(t.attribs)){if(!e.startsWith(Uh))continue;const n=U4(e.slice(Uh.length));Yi.call(t.data,n)||(t.data[n]=VE(t.attribs[e]))}return t.data}function z4(t,e){const n=Uh+j4(e),r=t.data;if(Yi.call(r,e))return r[e];if(Yi.call(t.attribs,n))return r[e]=VE(t.attribs[n])}function VE(t){if(t==="null")return null;if(t==="true")return!0;if(t==="false")return!1;const e=Number(t);if(t===String(e))return e;if(H4.test(t))try{return JSON.parse(t)}catch{}return t}function W4(t,e){var n;const r=this[0];if(!r||!ge(r))return;const s=r;return(n=s.data)!==null&&n!==void 0||(s.data={}),t==null?V4(s):typeof t=="object"||e!==void 0?(st(this,a=>{ge(a)&&(typeof t=="object"?E0(a,t):E0(a,t,e))}),this):z4(s,t)}function G4(t){const e=arguments.length===0,n=this[0];if(!n||!ge(n))return e?void 0:this;switch(n.name){case"textarea":return this.text(t);case"select":{const r=this.find("option:selected");if(!e){if(this.attr("multiple")==null&&typeof t=="object")return this;this.find("option").removeAttr("selected");const s=typeof t=="object"?t:[t];for(const a of s)this.find(`option[value="${a}"]`).attr("selected","");return this}return this.attr("multiple")?r.toArray().map(s=>Ki(s.children)):r.attr("value")}case"input":case"option":return e?this.attr("value"):this.attr("value",t)}}function zE(t,e){!t.attribs||!Yi.call(t.attribs,e)||delete t.attribs[e]}function cc(t){return t?t.trim().split(Zi):[]}function K4(t){const e=cc(t);for(const n of e)st(this,r=>{ge(r)&&zE(r,n)});return this}function Y4(t){return this.toArray().some(e=>{const n=ge(e)&&e.attribs.class;let r=-1;if(n&&t.length>0)for(;(r=n.indexOf(t,r+1))>-1;){const s=r+t.length;if((r===0||Zi.test(n[r-1]))&&(s===n.length||Zi.test(n[s])))return!0}return!1})}function WE(t){if(typeof t=="function")return st(this,(r,s)=>{if(ge(r)){const a=r.attribs.class||"";WE.call([r],t.call(r,s,a))}});if(!t||typeof t!="string")return this;const e=t.split(Zi),n=this.length;for(let r=0;r<n;r++){const s=this[r];if(!ge(s))continue;const a=uc(s,"class",!1);if(a){let i=` ${a} `;for(const o of e){const u=`${o} `;i.includes(` ${u}`)||(i+=u)}aa(s,"class",i.trim())}else aa(s,"class",e.join(" ").trim())}return this}function GE(t){if(typeof t=="function")return st(this,(s,a)=>{ge(s)&&GE.call([s],t.call(s,a,s.attribs.class||""))});const e=cc(t),n=e.length,r=arguments.length===0;return st(this,s=>{if(ge(s))if(r)s.attribs.class="";else{const a=cc(s.attribs.class);let i=!1;for(let o=0;o<n;o++){const u=a.indexOf(e[o]);u>=0&&(a.splice(u,1),i=!0,o--)}i&&(s.attribs.class=a.join(" "))}})}function KE(t,e){if(typeof t=="function")return st(this,(i,o)=>{ge(i)&&KE.call([i],t.call(i,o,i.attribs.class||"",e),e)});if(!t||typeof t!="string")return this;const n=t.split(Zi),r=n.length,s=typeof e=="boolean"?e?1:-1:0,a=this.length;for(let i=0;i<a;i++){const o=this[i];if(!ge(o))continue;const u=cc(o.attribs.class);for(let c=0;c<r;c++){const l=u.indexOf(n[c]);s>=0&&l<0?u.push(n[c]):s<=0&&l>=0&&u.splice(l,1)}o.attribs.class=u.join(" ")}return this}const Z4=Object.freeze(Object.defineProperty({__proto__:null,addClass:WE,attr:$4,data:W4,hasClass:Y4,prop:q4,removeAttr:K4,removeClass:GE,toggleClass:KE,val:G4},Symbol.toStringTag,{value:"Module"}));var le;(function(t){t.Attribute="attribute",t.Pseudo="pseudo",t.PseudoElement="pseudo-element",t.Tag="tag",t.Universal="universal",t.Adjacent="adjacent",t.Child="child",t.Descendant="descendant",t.Parent="parent",t.Sibling="sibling",t.ColumnCombinator="column-combinator"})(le||(le={}));var gt;(function(t){t.Any="any",t.Element="element",t.End="end",t.Equals="equals",t.Exists="exists",t.Hyphen="hyphen",t.Not="not",t.Start="start"})(gt||(gt={}));const w0=/^[^\\#]?(?:\\(?:[\da-f]{1,6}\s?|.)|[\w\-\u00b0-\uFFFF])+/,J4=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,X4=new Map([[126,gt.Element],[94,gt.Start],[36,gt.End],[42,gt.Any],[33,gt.Not],[124,gt.Hyphen]]),Q4=new Set(["has","not","matches","is","where","host","host-context"]);function gi(t){switch(t.type){case le.Adjacent:case le.Child:case le.Descendant:case le.Parent:case le.Sibling:case le.ColumnCombinator:return!0;default:return!1}}const eD=new Set(["contains","icontains"]);function tD(t,e,n){const r=parseInt(e,16)-65536;return r!==r||n?e:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,r&1023|56320)}function Wa(t){return t.replace(J4,tD)}function Td(t){return t===39||t===34}function T0(t){return t===32||t===9||t===10||t===12||t===13}function cl(t){const e=[],n=YE(e,`${t}`,0);if(n<t.length)throw new Error(`Unmatched selector: ${t.slice(n)}`);return e}function YE(t,e,n){let r=[];function s(m){const p=e.slice(n+m).match(w0);if(!p)throw new Error(`Expected name, found ${e.slice(n)}`);const[f]=p;return n+=m+f.length,Wa(f)}function a(m){for(n+=m;n<e.length&&T0(e.charCodeAt(n));)n++}function i(){n+=1;const m=n;let p=1;for(;p>0&&n<e.length;n++)e.charCodeAt(n)===40&&!o(n)?p++:e.charCodeAt(n)===41&&!o(n)&&p--;if(p)throw new Error("Parenthesis not matched");return Wa(e.slice(m,n-1))}function o(m){let p=0;for(;e.charCodeAt(--m)===92;)p++;return(p&1)===1}function u(){if(r.length>0&&gi(r[r.length-1]))throw new Error("Did not expect successive traversals.")}function c(m){if(r.length>0&&r[r.length-1].type===le.Descendant){r[r.length-1].type=m;return}u(),r.push({type:m})}function l(m,p){r.push({type:le.Attribute,name:m,action:p,value:s(1),namespace:null,ignoreCase:"quirks"})}function d(){if(r.length&&r[r.length-1].type===le.Descendant&&r.pop(),r.length===0)throw new Error("Empty sub-selector");t.push(r)}if(a(0),e.length===n)return n;e:for(;n<e.length;){const m=e.charCodeAt(n);switch(m){case 32:case 9:case 10:case 12:case 13:{(r.length===0||r[0].type!==le.Descendant)&&(u(),r.push({type:le.Descendant})),a(1);break}case 62:{c(le.Child),a(1);break}case 60:{c(le.Parent),a(1);break}case 126:{c(le.Sibling),a(1);break}case 43:{c(le.Adjacent),a(1);break}case 46:{l("class",gt.Element);break}case 35:{l("id",gt.Equals);break}case 91:{a(1);let p,f=null;e.charCodeAt(n)===124?p=s(1):e.startsWith("*|",n)?(f="*",p=s(2)):(p=s(0),e.charCodeAt(n)===124&&e.charCodeAt(n+1)!==61&&(f=p,p=s(1))),a(0);let g=gt.Exists;const b=X4.get(e.charCodeAt(n));if(b){if(g=b,e.charCodeAt(n+1)!==61)throw new Error("Expected `=`");a(2)}else e.charCodeAt(n)===61&&(g=gt.Equals,a(1));let _="",y=null;if(g!=="exists"){if(Td(e.charCodeAt(n))){const A=e.charCodeAt(n);let O=n+1;for(;O<e.length&&(e.charCodeAt(O)!==A||o(O));)O+=1;if(e.charCodeAt(O)!==A)throw new Error("Attribute value didn't end");_=Wa(e.slice(n+1,O)),n=O+1}else{const A=n;for(;n<e.length&&(!T0(e.charCodeAt(n))&&e.charCodeAt(n)!==93||o(n));)n+=1;_=Wa(e.slice(A,n))}a(0);const I=e.charCodeAt(n)|32;I===115?(y=!1,a(1)):I===105&&(y=!0,a(1))}if(e.charCodeAt(n)!==93)throw new Error("Attribute selector didn't terminate");n+=1;const S={type:le.Attribute,name:p,action:g,value:_,namespace:f,ignoreCase:y};r.push(S);break}case 58:{if(e.charCodeAt(n+1)===58){r.push({type:le.PseudoElement,name:s(2).toLowerCase(),data:e.charCodeAt(n)===40?i():null});continue}const p=s(1).toLowerCase();let f=null;if(e.charCodeAt(n)===40)if(Q4.has(p)){if(Td(e.charCodeAt(n+1)))throw new Error(`Pseudo-selector ${p} cannot be quoted`);if(f=[],n=YE(f,e,n+1),e.charCodeAt(n)!==41)throw new Error(`Missing closing parenthesis in :${p} (${e})`);n+=1}else{if(f=i(),eD.has(p)){const g=f.charCodeAt(0);g===f.charCodeAt(f.length-1)&&Td(g)&&(f=f.slice(1,-1))}f=Wa(f)}r.push({type:le.Pseudo,name:p,data:f});break}case 44:{d(),r=[],a(1);break}default:{if(e.startsWith("/*",n)){const g=e.indexOf("*/",n+2);if(g<0)throw new Error("Comment was not terminated");n=g+2,r.length===0&&a(0);break}let p=null,f;if(m===42)n+=1,f="*";else if(m===124){if(f="",e.charCodeAt(n+1)===124){c(le.ColumnCombinator),a(2);break}}else if(w0.test(e.slice(n)))f=s(0);else break e;e.charCodeAt(n)===124&&e.charCodeAt(n+1)!==124&&(p=f,e.charCodeAt(n+1)===42?(f="*",n+=2):f=s(1)),r.push(f==="*"?{type:le.Universal,namespace:p}:{type:le.Tag,name:f,namespace:p})}}}return d(),n}var lc={trueFunc:function(){return!0},falseFunc:function(){return!1}};const Re=to(lc),ZE=new Map([[le.Universal,50],[le.Tag,30],[le.Attribute,1],[le.Pseudo,0]]);function _m(t){return!ZE.has(t.type)}const nD=new Map([[gt.Exists,10],[gt.Equals,8],[gt.Not,7],[gt.Start,6],[gt.End,6],[gt.Any,5]]);function rD(t){const e=t.map(JE);for(let n=1;n<t.length;n++){const r=e[n];if(!(r<0))for(let s=n-1;s>=0&&r<e[s];s--){const a=t[s+1];t[s+1]=t[s],t[s]=a,e[s+1]=e[s],e[s]=r}}}function JE(t){var e,n;let r=(e=ZE.get(t.type))!==null&&e!==void 0?e:-1;return t.type===le.Attribute?(r=(n=nD.get(t.action))!==null&&n!==void 0?n:4,t.action===gt.Equals&&t.name==="id"&&(r=9),t.ignoreCase&&(r>>=1)):t.type===le.Pseudo&&(t.data?t.name==="has"||t.name==="contains"?r=0:Array.isArray(t.data)?(r=Math.min(...t.data.map(s=>Math.min(...s.map(JE)))),r<0&&(r=0)):r=2:r=3),r}const sD=/[-[\]{}()*+?.,\\^$|#\s]/g;function S0(t){return t.replace(sD,"\\$&")}const aD=new Set(["accept","accept-charset","align","alink","axis","bgcolor","charset","checked","clear","codetype","color","compact","declare","defer","dir","direction","disabled","enctype","face","frame","hreflang","http-equiv","lang","language","link","media","method","multiple","nohref","noresize","noshade","nowrap","readonly","rel","rev","rules","scope","scrolling","selected","shape","target","text","type","valign","valuetype","vlink"]);function ts(t,e){return typeof t.ignoreCase=="boolean"?t.ignoreCase:t.ignoreCase==="quirks"?!!e.quirksMode:!e.xmlMode&&aD.has(t.name)}const iD={equals(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;return ts(e,n)?(a=a.toLowerCase(),i=>{const o=r.getAttributeValue(i,s);return o!=null&&o.length===a.length&&o.toLowerCase()===a&&t(i)}):i=>r.getAttributeValue(i,s)===a&&t(i)},hyphen(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;const i=a.length;return ts(e,n)?(a=a.toLowerCase(),function(u){const c=r.getAttributeValue(u,s);return c!=null&&(c.length===i||c.charAt(i)==="-")&&c.substr(0,i).toLowerCase()===a&&t(u)}):function(u){const c=r.getAttributeValue(u,s);return c!=null&&(c.length===i||c.charAt(i)==="-")&&c.substr(0,i)===a&&t(u)}},element(t,e,n){const{adapter:r}=n,{name:s,value:a}=e;if(/\s/.test(a))return Re.falseFunc;const i=new RegExp(`(?:^|\\s)${S0(a)}(?:$|\\s)`,ts(e,n)?"i":"");return function(u){const c=r.getAttributeValue(u,s);return c!=null&&c.length>=a.length&&i.test(c)&&t(u)}},exists(t,{name:e},{adapter:n}){return r=>n.hasAttrib(r,e)&&t(r)},start(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;const i=a.length;return i===0?Re.falseFunc:ts(e,n)?(a=a.toLowerCase(),o=>{const u=r.getAttributeValue(o,s);return u!=null&&u.length>=i&&u.substr(0,i).toLowerCase()===a&&t(o)}):o=>{var u;return!!(!((u=r.getAttributeValue(o,s))===null||u===void 0)&&u.startsWith(a))&&t(o)}},end(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;const i=-a.length;return i===0?Re.falseFunc:ts(e,n)?(a=a.toLowerCase(),o=>{var u;return((u=r.getAttributeValue(o,s))===null||u===void 0?void 0:u.substr(i).toLowerCase())===a&&t(o)}):o=>{var u;return!!(!((u=r.getAttributeValue(o,s))===null||u===void 0)&&u.endsWith(a))&&t(o)}},any(t,e,n){const{adapter:r}=n,{name:s,value:a}=e;if(a==="")return Re.falseFunc;if(ts(e,n)){const i=new RegExp(S0(a),"i");return function(u){const c=r.getAttributeValue(u,s);return c!=null&&c.length>=a.length&&i.test(c)&&t(u)}}return i=>{var o;return!!(!((o=r.getAttributeValue(i,s))===null||o===void 0)&&o.includes(a))&&t(i)}},not(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;return a===""?i=>!!r.getAttributeValue(i,s)&&t(i):ts(e,n)?(a=a.toLowerCase(),i=>{const o=r.getAttributeValue(i,s);return(o==null||o.length!==a.length||o.toLowerCase()!==a)&&t(i)}):i=>r.getAttributeValue(i,s)!==a&&t(i)}},oD=new Set([9,10,12,13,32]),A0=48,uD=57;function cD(t){if(t=t.trim().toLowerCase(),t==="even")return[2,0];if(t==="odd")return[2,1];let e=0,n=0,r=a(),s=i();if(e<t.length&&t.charAt(e)==="n"&&(e++,n=r*(s??1),o(),e<t.length?(r=a(),o(),s=i()):r=s=0),s===null||e<t.length)throw new Error(`n-th rule couldn't be parsed ('${t}')`);return[n,r*s];function a(){return t.charAt(e)==="-"?(e++,-1):(t.charAt(e)==="+"&&e++,1)}function i(){const u=e;let c=0;for(;e<t.length&&t.charCodeAt(e)>=A0&&t.charCodeAt(e)<=uD;)c=c*10+(t.charCodeAt(e)-A0),e++;return e===u?null:c}function o(){for(;e<t.length&&oD.has(t.charCodeAt(e));)e++}}function lD(t){const e=t[0],n=t[1]-1;if(n<0&&e<=0)return Re.falseFunc;if(e===-1)return a=>a<=n;if(e===0)return a=>a===n;if(e===1)return n<0?Re.trueFunc:a=>a>=n;const r=Math.abs(e),s=(n%r+r)%r;return e>1?a=>a>=n&&a%r===s:a=>a<=n&&a%r===s}function ou(t){return lD(cD(t))}function uu(t,e){return n=>{const r=e.getParent(n);return r!=null&&e.isTag(r)&&t(n)}}const jh={contains(t,e,{adapter:n}){return function(s){return t(s)&&n.getText(s).includes(e)}},icontains(t,e,{adapter:n}){const r=e.toLowerCase();return function(a){return t(a)&&n.getText(a).toLowerCase().includes(r)}},"nth-child"(t,e,{adapter:n,equals:r}){const s=ou(e);return s===Re.falseFunc?Re.falseFunc:s===Re.trueFunc?uu(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=0;c<o.length&&!r(i,o[c]);c++)n.isTag(o[c])&&u++;return s(u)&&t(i)}},"nth-last-child"(t,e,{adapter:n,equals:r}){const s=ou(e);return s===Re.falseFunc?Re.falseFunc:s===Re.trueFunc?uu(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=o.length-1;c>=0&&!r(i,o[c]);c--)n.isTag(o[c])&&u++;return s(u)&&t(i)}},"nth-of-type"(t,e,{adapter:n,equals:r}){const s=ou(e);return s===Re.falseFunc?Re.falseFunc:s===Re.trueFunc?uu(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=0;c<o.length;c++){const l=o[c];if(r(i,l))break;n.isTag(l)&&n.getName(l)===n.getName(i)&&u++}return s(u)&&t(i)}},"nth-last-of-type"(t,e,{adapter:n,equals:r}){const s=ou(e);return s===Re.falseFunc?Re.falseFunc:s===Re.trueFunc?uu(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=o.length-1;c>=0;c--){const l=o[c];if(r(i,l))break;n.isTag(l)&&n.getName(l)===n.getName(i)&&u++}return s(u)&&t(i)}},root(t,e,{adapter:n}){return r=>{const s=n.getParent(r);return(s==null||!n.isTag(s))&&t(r)}},scope(t,e,n,r){const{equals:s}=n;return!r||r.length===0?jh.root(t,e,n):r.length===1?a=>s(r[0],a)&&t(a):a=>r.includes(a)&&t(a)},hover:Sd("isHovered"),visited:Sd("isVisited"),active:Sd("isActive")};function Sd(t){return function(n,r,{adapter:s}){const a=s[t];return typeof a!="function"?Re.falseFunc:function(o){return a(o)&&n(o)}}}const C0={empty(t,{adapter:e}){return!e.getChildren(t).some(n=>e.isTag(n)||e.getText(n)!=="")},"first-child"(t,{adapter:e,equals:n}){if(e.prevElementSibling)return e.prevElementSibling(t)==null;const r=e.getSiblings(t).find(s=>e.isTag(s));return r!=null&&n(t,r)},"last-child"(t,{adapter:e,equals:n}){const r=e.getSiblings(t);for(let s=r.length-1;s>=0;s--){if(n(t,r[s]))return!0;if(e.isTag(r[s]))break}return!1},"first-of-type"(t,{adapter:e,equals:n}){const r=e.getSiblings(t),s=e.getName(t);for(let a=0;a<r.length;a++){const i=r[a];if(n(t,i))return!0;if(e.isTag(i)&&e.getName(i)===s)break}return!1},"last-of-type"(t,{adapter:e,equals:n}){const r=e.getSiblings(t),s=e.getName(t);for(let a=r.length-1;a>=0;a--){const i=r[a];if(n(t,i))return!0;if(e.isTag(i)&&e.getName(i)===s)break}return!1},"only-of-type"(t,{adapter:e,equals:n}){const r=e.getName(t);return e.getSiblings(t).every(s=>n(t,s)||!e.isTag(s)||e.getName(s)!==r)},"only-child"(t,{adapter:e,equals:n}){return e.getSiblings(t).every(r=>n(t,r)||!e.isTag(r))}};function O0(t,e,n,r){if(n===null){if(t.length>r)throw new Error(`Pseudo-class :${e} requires an argument`)}else if(t.length===r)throw new Error(`Pseudo-class :${e} doesn't have any arguments`)}const dD={"any-link":":is(a, area, link)[href]",link:":any-link:not(:visited)",disabled:`:is(
        :is(button, input, select, textarea, optgroup, option)[disabled],
        optgroup[disabled] > option,
        fieldset[disabled]:not(fieldset[disabled] legend:first-of-type *)
    )`,enabled:":not(:disabled)",checked:":is(:is(input[type=radio], input[type=checkbox])[checked], option:selected)",required:":is(input, select, textarea)[required]",optional:":is(input, select, textarea):not([required])",selected:"option:is([selected], select:not([multiple]):not(:has(> option[selected])) > :first-of-type)",checkbox:"[type=checkbox]",file:"[type=file]",password:"[type=password]",radio:"[type=radio]",reset:"[type=reset]",image:"[type=image]",submit:"[type=submit]",parent:":not(:empty)",header:":is(h1, h2, h3, h4, h5, h6)",button:":is(button, input[type=button])",input:":is(input, textarea, select, button)",text:"input:is(:not([type!='']), [type=text])"},XE={};function hD(t,e){return t===Re.falseFunc?Re.falseFunc:n=>e.isTag(n)&&t(n)}function QE(t,e){const n=e.getSiblings(t);if(n.length<=1)return[];const r=n.indexOf(t);return r<0||r===n.length-1?[]:n.slice(r+1).filter(e.isTag)}function Hh(t){return{xmlMode:!!t.xmlMode,lowerCaseAttributeNames:!!t.lowerCaseAttributeNames,lowerCaseTags:!!t.lowerCaseTags,quirksMode:!!t.quirksMode,cacheResults:!!t.cacheResults,pseudos:t.pseudos,adapter:t.adapter,equals:t.equals}}const Ad=(t,e,n,r,s)=>{const a=s(e,Hh(n),r);return a===Re.trueFunc?t:a===Re.falseFunc?Re.falseFunc:i=>a(i)&&t(i)},Cd={is:Ad,matches:Ad,where:Ad,not(t,e,n,r,s){const a=s(e,Hh(n),r);return a===Re.falseFunc?t:a===Re.trueFunc?Re.falseFunc:i=>!a(i)&&t(i)},has(t,e,n,r,s){const{adapter:a}=n,i=Hh(n);i.relativeSelector=!0;const o=e.some(l=>l.some(_m))?[XE]:void 0,u=s(e,i,o);if(u===Re.falseFunc)return Re.falseFunc;const c=hD(u,a);if(o&&u!==Re.trueFunc){const{shouldTestNextSiblings:l=!1}=u;return d=>{if(!t(d))return!1;o[0]=d;const m=a.getChildren(d),p=l?[...m,...QE(d,a)]:m;return a.existsOne(c,p)}}return l=>t(l)&&a.existsOne(c,a.getChildren(l))}};function fD(t,e,n,r,s){var a;const{name:i,data:o}=e;if(Array.isArray(o)){if(!(i in Cd))throw new Error(`Unknown pseudo-class :${i}(${o})`);return Cd[i](t,o,n,r,s)}const u=(a=n.pseudos)===null||a===void 0?void 0:a[i],c=typeof u=="string"?u:dD[i];if(typeof c=="string"){if(o!=null)throw new Error(`Pseudo ${i} doesn't have any arguments`);const l=cl(c);return Cd.is(t,l,n,r,s)}if(typeof u=="function")return O0(u,i,o,1),l=>u(l,o)&&t(l);if(i in jh)return jh[i](t,o,n,r);if(i in C0){const l=C0[i];return O0(l,i,o,2),d=>l(d,n,o)&&t(d)}throw new Error(`Unknown pseudo-class :${i}`)}function Od(t,e){const n=e.getParent(t);return n&&e.isTag(n)?n:null}function mD(t,e,n,r,s){const{adapter:a,equals:i}=n;switch(e.type){case le.PseudoElement:throw new Error("Pseudo-elements are not supported by css-select");case le.ColumnCombinator:throw new Error("Column combinators are not yet supported by css-select");case le.Attribute:{if(e.namespace!=null)throw new Error("Namespaced attributes are not yet supported by css-select");return(!n.xmlMode||n.lowerCaseAttributeNames)&&(e.name=e.name.toLowerCase()),iD[e.action](t,e,n)}case le.Pseudo:return fD(t,e,n,r,s);case le.Tag:{if(e.namespace!=null)throw new Error("Namespaced tag names are not yet supported by css-select");let{name:o}=e;return(!n.xmlMode||n.lowerCaseTags)&&(o=o.toLowerCase()),function(c){return a.getName(c)===o&&t(c)}}case le.Descendant:{if(n.cacheResults===!1||typeof WeakSet>"u")return function(c){let l=c;for(;l=Od(l,a);)if(t(l))return!0;return!1};const o=new WeakSet;return function(c){let l=c;for(;l=Od(l,a);)if(!o.has(l)){if(a.isTag(l)&&t(l))return!0;o.add(l)}return!1}}case"_flexibleDescendant":return function(u){let c=u;do if(t(c))return!0;while(c=Od(c,a));return!1};case le.Parent:return function(u){return a.getChildren(u).some(c=>a.isTag(c)&&t(c))};case le.Child:return function(u){const c=a.getParent(u);return c!=null&&a.isTag(c)&&t(c)};case le.Sibling:return function(u){const c=a.getSiblings(u);for(let l=0;l<c.length;l++){const d=c[l];if(i(u,d))break;if(a.isTag(d)&&t(d))return!0}return!1};case le.Adjacent:return a.prevElementSibling?function(u){const c=a.prevElementSibling(u);return c!=null&&t(c)}:function(u){const c=a.getSiblings(u);let l;for(let d=0;d<c.length;d++){const m=c[d];if(i(u,m))break;a.isTag(m)&&(l=m)}return!!l&&t(l)};case le.Universal:{if(e.namespace!=null&&e.namespace!=="*")throw new Error("Namespaced universal selectors are not yet supported by css-select");return t}}}function ew(t){return t.type===le.Pseudo&&(t.name==="scope"||Array.isArray(t.data)&&t.data.some(e=>e.some(ew)))}const pD={type:le.Descendant},gD={type:"_flexibleDescendant"},bD={type:le.Pseudo,name:"scope",data:null};function _D(t,{adapter:e},n){const r=!!(n!=null&&n.every(s=>{const a=e.isTag(s)&&e.getParent(s);return s===XE||a&&e.isTag(a)}));for(const s of t){if(!(s.length>0&&_m(s[0])&&s[0].type!==le.Descendant))if(r&&!s.some(ew))s.unshift(pD);else continue;s.unshift(bD)}}function tw(t,e,n){var r;t.forEach(rD),n=(r=e.context)!==null&&r!==void 0?r:n;const s=Array.isArray(n),a=n&&(Array.isArray(n)?n:[n]);if(e.relativeSelector!==!1)_D(t,e,a);else if(t.some(u=>u.length>0&&_m(u[0])))throw new Error("Relative selectors are not allowed when the `relativeSelector` option is disabled");let i=!1;const o=t.map(u=>{if(u.length>=2){const[c,l]=u;c.type!==le.Pseudo||c.name!=="scope"||(s&&l.type===le.Descendant?u[1]=gD:(l.type===le.Adjacent||l.type===le.Sibling)&&(i=!0))}return yD(u,e,a)}).reduce(ED,Re.falseFunc);return o.shouldTestNextSiblings=i,o}function yD(t,e,n){var r;return t.reduce((s,a)=>s===Re.falseFunc?Re.falseFunc:mD(s,a,e,n,tw),(r=e.rootFunc)!==null&&r!==void 0?r:Re.trueFunc)}function ED(t,e){return e===Re.falseFunc||t===Re.trueFunc?t:t===Re.falseFunc||e===Re.trueFunc?e:function(r){return t(r)||e(r)}}const nw=(t,e)=>t===e,wD={adapter:ul,equals:nw};function TD(t){var e,n,r,s;const a=t??wD;return(e=a.adapter)!==null&&e!==void 0||(a.adapter=ul),(n=a.equals)!==null&&n!==void 0||(a.equals=(s=(r=a.adapter)===null||r===void 0?void 0:r.equals)!==null&&s!==void 0?s:nw),a}function SD(t){return function(n,r,s){const a=TD(r);return t(n,a,s)}}const ym=SD(tw);function rw(t,e,n=!1){return n&&(t=AD(t,e)),Array.isArray(t)?e.removeSubsets(t):e.getChildren(t)}function AD(t,e){const n=Array.isArray(t)?t.slice(0):[t],r=n.length;for(let s=0;s<r;s++){const a=QE(n[s],e);n.push(...a)}return n}const CD=new Set(["first","last","eq","gt","nth","lt","even","odd"]);function dc(t){return t.type!=="pseudo"?!1:CD.has(t.name)?!0:t.name==="not"&&Array.isArray(t.data)?t.data.some(e=>e.some(dc)):!1}function OD(t,e,n){const r=e!=null?parseInt(e,10):NaN;switch(t){case"first":return 1;case"nth":case"eq":return isFinite(r)?r>=0?r+1:1/0:0;case"lt":return isFinite(r)?r>=0?Math.min(r,n):1/0:0;case"gt":return isFinite(r)?1/0:0;case"odd":return 2*n;case"even":return 2*n-1;case"last":case"not":return 1/0}}function vD(t){for(;t.parent;)t=t.parent;return t}function Em(t){const e=[],n=[];for(const r of t)r.some(dc)?e.push(r):n.push(r);return[n,e]}const ID={type:le.Universal,namespace:null},kD={type:le.Pseudo,name:"scope",data:null};function sw(t,e,n={}){return aw([t],e,n)}function aw(t,e,n={}){if(typeof e=="function")return t.some(e);const[r,s]=Em(cl(e));return r.length>0&&t.some(ym(r,n))||s.some(a=>uw(a,t,n).length>0)}function ND(t,e,n,r){const s=typeof n=="string"?parseInt(n,10):NaN;switch(t){case"first":case"lt":return e;case"last":return e.length>0?[e[e.length-1]]:e;case"nth":case"eq":return isFinite(s)&&Math.abs(s)<e.length?[s<0?e[e.length+s]:e[s]]:[];case"gt":return isFinite(s)?e.slice(s+1):[];case"even":return e.filter((a,i)=>i%2===0);case"odd":return e.filter((a,i)=>i%2===1);case"not":{const a=new Set(ow(n,e,r));return e.filter(i=>!a.has(i))}}}function iw(t,e,n={}){return ow(cl(t),e,n)}function ow(t,e,n){if(e.length===0)return[];const[r,s]=Em(t);let a;if(r.length){const i=qh(e,r,n);if(s.length===0)return i;i.length&&(a=new Set(i))}for(let i=0;i<s.length&&(a==null?void 0:a.size)!==e.length;i++){const o=s[i];if((a?e.filter(l=>ge(l)&&!a.has(l)):e).length===0)break;const c=uw(o,e,n);if(c.length)if(a)c.forEach(l=>a.add(l));else{if(i===s.length-1)return c;a=new Set(c)}}return typeof a<"u"?a.size===e.length?e:e.filter(i=>a.has(i)):[]}function uw(t,e,n){var r;if(t.some(gi)){const s=(r=n.root)!==null&&r!==void 0?r:vD(e[0]),a={...n,context:e,relativeSelector:!1};return t.push(kD),hc(s,t,a,!0,e.length)}return hc(e,t,n,!1,e.length)}function RD(t,e,n={},r=1/0){if(typeof t=="function")return cw(e,t);const[s,a]=Em(cl(t)),i=a.map(o=>hc(e,o,n,!0,r));return s.length&&i.push($h(e,s,n,r)),i.length===0?[]:i.length===1?i[0]:Ra(i.reduce((o,u)=>[...o,...u]))}function hc(t,e,n,r,s){const a=e.findIndex(dc),i=e.slice(0,a),o=e[a],u=e.length-1===a?s:1/0,c=OD(o.name,o.data,u);if(c===0)return[];const d=(i.length===0&&!Array.isArray(t)?ol(t).filter(ge):i.length===0?(Array.isArray(t)?t:[t]).filter(ge):r||i.some(gi)?$h(t,[i],n,c):qh(t,[i],n)).slice(0,c);let m=ND(o.name,d,o.data,n);if(m.length===0||e.length===a+1)return m;const p=e.slice(a+1),f=p.some(gi);if(f){if(gi(p[0])){const{type:g}=p[0];(g===le.Sibling||g===le.Adjacent)&&(m=rw(m,ul,!0)),p.unshift(ID)}n={...n,relativeSelector:!1,rootFunc:g=>m.includes(g)}}else n.rootFunc&&n.rootFunc!==lc.trueFunc&&(n={...n,rootFunc:lc.trueFunc});return p.some(dc)?hc(m,p,n,!1,s):f?$h(m,[p],n,s):qh(m,[p],n)}function $h(t,e,n,r){const s=ym(e,n,t);return cw(t,s,r)}function cw(t,e,n=1/0){const r=rw(t,ul,e.shouldTestNextSiblings);return mm(s=>ge(s)&&e(s),r,!0,n)}function qh(t,e,n){const r=(Array.isArray(t)?t:[t]).filter(ge);if(r.length===0)return r;const s=ym(e,n);return s===lc.trueFunc?r:r.filter(s)}const PD=/^\s*[+~]/;function xD(t){if(!t)return this._make([]);if(typeof t!="string"){const e=Ir(t)?t.toArray():[t],n=this.toArray();return this._make(e.filter(r=>n.some(s=>qE(s,r))))}return this._findBySelector(t,Number.POSITIVE_INFINITY)}function LD(t,e){var n;const r=this.toArray(),s=PD.test(t)?r:this.children().toArray(),a={context:r,root:(n=this._root)===null||n===void 0?void 0:n[0],xmlMode:this.options.xmlMode,lowerCaseTags:this.options.lowerCaseTags,lowerCaseAttributeNames:this.options.lowerCaseAttributeNames,pseudos:this.options.pseudos,quirksMode:this.options.quirksMode};return this._make(RD(t,s,a,e))}function wm(t){return function(e,...n){return function(r){var s;let a=t(e,this);return r&&(a=Am(a,r,this.options.xmlMode,(s=this._root)===null||s===void 0?void 0:s[0])),this._make(this.length>1&&a.length>1?n.reduce((i,o)=>o(i),a):a)}}}const yo=wm((t,e)=>{let n=[];for(let r=0;r<e.length;r++){const s=t(e[r]);s.length>0&&(n=n.concat(s))}return n}),Tm=wm((t,e)=>{const n=[];for(let r=0;r<e.length;r++){const s=t(e[r]);s!==null&&n.push(s)}return n});function Sm(t,...e){let n=null;const r=wm((s,a)=>{const i=[];return st(a,o=>{for(let u;(u=s(o))&&!(n!=null&&n(u,i.length));o=u)i.push(u)}),i})(t,...e);return function(s,a){n=typeof s=="string"?o=>sw(o,s,this.options):s?Eo(s):null;const i=r.call(this,a);return n=null,i}}function Pa(t){return t.length>1?Array.from(new Set(t)):t}const DD=Tm(({parent:t})=>t&&!Xr(t)?t:null,Pa),MD=yo(t=>{const e=[];for(;t.parent&&!Xr(t.parent);)e.push(t.parent),t=t.parent;return e},Ra,t=>t.reverse()),BD=Sm(({parent:t})=>t&&!Xr(t)?t:null,Ra,t=>t.reverse());function FD(t){var e;const n=[];if(!t)return this._make(n);const r={xmlMode:this.options.xmlMode,root:(e=this._root)===null||e===void 0?void 0:e[0]},s=typeof t=="string"?a=>sw(a,t,r):Eo(t);return st(this,a=>{for(a&&!Xr(a)&&!ge(a)&&(a=a.parent);a&&ge(a);){if(s(a,0)){n.includes(a)||n.push(a);break}a=a.parent}}),this._make(n)}const UD=Tm(t=>hm(t)),jD=yo(t=>{const e=[];for(;t.next;)t=t.next,ge(t)&&e.push(t);return e},Pa),HD=Sm(t=>hm(t),Pa),$D=Tm(t=>fm(t)),qD=yo(t=>{const e=[];for(;t.prev;)t=t.prev,ge(t)&&e.push(t);return e},Pa),VD=Sm(t=>fm(t),Pa),zD=yo(t=>BE(t).filter(e=>ge(e)&&e!==t),Ra),WD=yo(t=>ol(t).filter(ge),Pa);function GD(){const t=this.toArray().reduce((e,n)=>ot(n)?e.concat(n.children):e,[]);return this._make(t)}function KD(t){let e=0;const n=this.length;for(;e<n&&t.call(this[e],e,this[e])!==!1;)++e;return this}function YD(t){let e=[];for(let n=0;n<this.length;n++){const r=this[n],s=t.call(r,n,r);s!=null&&(e=e.concat(s))}return this._make(e)}function Eo(t){return typeof t=="function"?(e,n)=>t.call(e,n,e):Ir(t)?e=>Array.prototype.includes.call(t,e):function(e){return t===e}}function ZD(t){var e;return this._make(Am(this.toArray(),t,this.options.xmlMode,(e=this._root)===null||e===void 0?void 0:e[0]))}function Am(t,e,n,r){return typeof e=="string"?iw(e,t,{xmlMode:n,root:r}):t.filter(Eo(e))}function JD(t){const e=this.toArray();return typeof t=="string"?aw(e.filter(ge),t,this.options):t?e.some(Eo(t)):!1}function XD(t){let e=this.toArray();if(typeof t=="string"){const n=new Set(iw(t,e,this.options));e=e.filter(r=>!n.has(r))}else{const n=Eo(t);e=e.filter((r,s)=>!n(r,s))}return this._make(e)}function QD(t){return this.filter(typeof t=="string"?`:has(${t})`:(e,n)=>this._make(n).find(t).length>0)}function eM(){return this.length>1?this._make(this[0]):this}function tM(){return this.length>0?this._make(this[this.length-1]):this}function nM(t){var e;return t=+t,t===0&&this.length<=1?this:(t<0&&(t=this.length+t),this._make((e=this[t])!==null&&e!==void 0?e:[]))}function rM(t){return t==null?this.toArray():this[t<0?this.length+t:t]}function sM(){return Array.prototype.slice.call(this)}function aM(t){let e,n;return t==null?(e=this.parent().children(),n=this[0]):typeof t=="string"?(e=this._make(t),n=this[0]):(e=this,n=Ir(t)?t[0]:t),Array.prototype.indexOf.call(e,n)}function iM(t,e){return this._make(Array.prototype.slice.call(this,t,e))}function oM(){var t;return(t=this.prevObject)!==null&&t!==void 0?t:this._make([])}function uM(t,e){const n=this._make(t,e),r=Ra([...this.get(),...n.get()]);return this._make(r)}function cM(t){return this.prevObject?this.add(t?this.prevObject.filter(t):this.prevObject):this}const lM=Object.freeze(Object.defineProperty({__proto__:null,_findBySelector:LD,add:uM,addBack:cM,children:WD,closest:FD,contents:GD,each:KD,end:oM,eq:nM,filter:ZD,filterArray:Am,find:xD,first:eM,get:rM,has:QD,index:aM,is:JD,last:tM,map:YD,next:UD,nextAll:jD,nextUntil:HD,not:XD,parent:DD,parents:MD,parentsUntil:BD,prev:$D,prevAll:qD,prevUntil:VD,siblings:zD,slice:iM,toArray:sM},Symbol.toStringTag,{value:"Module"}));function dM(t){return function(n,r,s,a){if(typeof Buffer<"u"&&Buffer.isBuffer(n)&&(n=n.toString()),typeof n=="string")return t(n,r,s,a);const i=n;if(!Array.isArray(i)&&Xr(i))return i;const o=new Cs([]);return Os(i,o),o}}function Os(t,e){const n=Array.isArray(t)?t:[t];e?e.children=n:e=null;for(let r=0;r<n.length;r++){const s=n[r];s.parent&&s.parent.children!==n&&ks(s),e?(s.prev=n[r-1]||null,s.next=n[r+1]||null):s.prev=s.next=null,s.parent=e}return e}function hM(t,e){if(t==null)return[];if(typeof t=="string")return this._parse(t,this.options,!1,null).children.slice(0);if("length"in t){if(t.length===1)return this._makeDomArray(t[0],e);const n=[];for(let r=0;r<t.length;r++){const s=t[r];if(typeof s=="object"){if(s==null)continue;if(!("length"in s)){n.push(e?Gi(s,!0):s);continue}}n.push(...this._makeDomArray(s,e))}return n}return[e?Gi(t,!0):t]}function lw(t){return function(...e){const n=this.length-1;return st(this,(r,s)=>{if(!ot(r))return;const a=typeof e[0]=="function"?e[0].call(r,s,this._render(r.children)):e,i=this._makeDomArray(a,s<n);t(i,r.children,r)})}}function Qr(t,e,n,r,s){var a,i;const o=[e,n,...r],u=e===0?null:t[e-1],c=e+n>=t.length?null:t[e+n];for(let l=0;l<r.length;++l){const d=r[l],m=d.parent;if(m){const f=m.children.indexOf(d);f>-1&&(m.children.splice(f,1),s===m&&e>f&&o[0]--)}d.parent=s,d.prev&&(d.prev.next=(a=d.next)!==null&&a!==void 0?a:null),d.next&&(d.next.prev=(i=d.prev)!==null&&i!==void 0?i:null),d.prev=l===0?u:r[l-1],d.next=l===r.length-1?c:r[l+1]}return u&&(u.next=r[0]),c&&(c.prev=r[r.length-1]),t.splice(...o)}function fM(t){return(Ir(t)?t:this._make(t)).append(this),this}function mM(t){return(Ir(t)?t:this._make(t)).prepend(this),this}const pM=lw((t,e,n)=>{Qr(e,e.length,0,t,n)}),gM=lw((t,e,n)=>{Qr(e,0,0,t,n)});function dw(t){return function(e){const n=this.length-1,r=this.parents().last();for(let s=0;s<this.length;s++){const a=this[s],i=typeof e=="function"?e.call(a,s,a):typeof e=="string"&&!Fh(e)?r.find(e).clone():e,[o]=this._makeDomArray(i,s<n);if(!o||!ot(o))continue;let u=o,c=0;for(;c<u.children.length;){const l=u.children[c];ge(l)?(u=l,c=0):c++}t(a,u,[o])}return this}}const bM=dw((t,e,n)=>{const{parent:r}=t;if(!r)return;const s=r.children,a=s.indexOf(t);Os([t],e),Qr(s,a,0,n,r)}),_M=dw((t,e,n)=>{ot(t)&&(Os(t.children,e),Os(n,t))});function yM(t){return this.parent(t).not("body").each((e,n)=>{this._make(n).replaceWith(n.children)}),this}function EM(t){const e=this[0];if(e){const n=this._make(typeof t=="function"?t.call(e,0,e):t).insertBefore(e);let r;for(let a=0;a<n.length;a++)n[a].type==="tag"&&(r=n[a]);let s=0;for(;r&&s<r.children.length;){const a=r.children[s];a.type==="tag"?(r=a,s=0):s++}r&&this._make(r).append(this)}return this}function wM(...t){const e=this.length-1;return st(this,(n,r)=>{if(!ot(n)||!n.parent)return;const s=n.parent.children,a=s.indexOf(n);if(a<0)return;const i=typeof t[0]=="function"?t[0].call(n,r,this._render(n.children)):t,o=this._makeDomArray(i,r<e);Qr(s,a+1,0,o,n.parent)})}function TM(t){typeof t=="string"&&(t=this._make(t)),this.remove();const e=[];for(const n of this._makeDomArray(t)){const r=this.clone().toArray(),{parent:s}=n;if(!s)continue;const a=s.children,i=a.indexOf(n);i<0||(Qr(a,i+1,0,r,s),e.push(...r))}return this._make(e)}function SM(...t){const e=this.length-1;return st(this,(n,r)=>{if(!ot(n)||!n.parent)return;const s=n.parent.children,a=s.indexOf(n);if(a<0)return;const i=typeof t[0]=="function"?t[0].call(n,r,this._render(n.children)):t,o=this._makeDomArray(i,r<e);Qr(s,a,0,o,n.parent)})}function AM(t){const e=this._make(t);this.remove();const n=[];return st(e,r=>{const s=this.clone().toArray(),{parent:a}=r;if(!a)return;const i=a.children,o=i.indexOf(r);o<0||(Qr(i,o,0,s,a),n.push(...s))}),this._make(n)}function CM(t){const e=t?this.filter(t):this;return st(e,n=>{ks(n),n.prev=n.next=n.parent=null}),this}function OM(t){return st(this,(e,n)=>{const{parent:r}=e;if(!r)return;const s=r.children,a=typeof t=="function"?t.call(e,n,e):t,i=this._makeDomArray(a);Os(i,null);const o=s.indexOf(e);Qr(s,o,1,i,r),i.includes(e)||(e.parent=e.prev=e.next=null)})}function vM(){return st(this,t=>{if(ot(t)){for(const e of t.children)e.next=e.prev=e.parent=null;t.children.length=0}})}function IM(t){if(t===void 0){const e=this[0];return!e||!ot(e)?null:this._render(e.children)}return st(this,e=>{if(!ot(e))return;for(const r of e.children)r.next=r.prev=r.parent=null;const n=Ir(t)?t.toArray():this._parse(`${t}`,this.options,!1,e).children;Os(n,e)})}function kM(){return this._render(this)}function NM(t){return t===void 0?Ki(this):typeof t=="function"?st(this,(e,n)=>this._make(e).text(t.call(e,n,Ki([e])))):st(this,e=>{if(!ot(e))return;for(const r of e.children)r.next=r.prev=r.parent=null;const n=new Wi(`${t}`);Os(n,e)})}function RM(){const t=Array.prototype.map.call(this.get(),n=>Gi(n,!0)),e=new Cs(t);for(const n of t)n.parent=e;return this._make(t)}const PM=Object.freeze(Object.defineProperty({__proto__:null,_makeDomArray:hM,after:wM,append:pM,appendTo:fM,before:SM,clone:RM,empty:vM,html:IM,insertAfter:TM,insertBefore:AM,prepend:gM,prependTo:mM,remove:CM,replaceWith:OM,text:NM,toString:kM,unwrap:yM,wrap:bM,wrapAll:EM,wrapInner:_M},Symbol.toStringTag,{value:"Module"}));function xM(t,e){if(t!=null&&e!=null||typeof t=="object"&&!Array.isArray(t))return st(this,(n,r)=>{ge(n)&&hw(n,t,e,r)});if(this.length!==0)return fw(this[0],t)}function hw(t,e,n,r){if(typeof e=="string"){const s=fw(t),a=typeof n=="function"?n.call(t,r,s[e]):n;a===""?delete s[e]:a!=null&&(s[e]=a),t.attribs.style=LM(s)}else if(typeof e=="object"){const s=Object.keys(e);for(let a=0;a<s.length;a++){const i=s[a];hw(t,i,e[i],a)}}}function fw(t,e){if(!t||!ge(t))return;const n=DM(t.attribs.style);if(typeof e=="string")return n[e];if(Array.isArray(e)){const r={};for(const s of e)n[s]!=null&&(r[s]=n[s]);return r}return n}function LM(t){return Object.keys(t).reduce((e,n)=>`${e}${e?" ":""}${n}: ${t[n]};`,"")}function DM(t){if(t=(t||"").trim(),!t)return{};const e={};let n;for(const r of t.split(";")){const s=r.indexOf(":");if(s<1||s===r.length-1){const a=r.trimEnd();a.length>0&&n!==void 0&&(e[n]+=`;${a}`)}else n=r.slice(0,s).trim(),e[n]=r.slice(s+1).trim()}return e}const MM=Object.freeze(Object.defineProperty({__proto__:null,css:xM},Symbol.toStringTag,{value:"Module"})),v0="input,select,textarea,keygen",BM=/%20/g,I0=/\r?\n/g;function FM(){return this.serializeArray().map(n=>`${encodeURIComponent(n.name)}=${encodeURIComponent(n.value)}`).join("&").replace(BM,"+")}function UM(){return this.map((t,e)=>{const n=this._make(e);return ge(e)&&e.name==="form"?n.find(v0).toArray():n.filter(v0).toArray()}).filter('[name!=""]:enabled:not(:submit, :button, :image, :reset, :file):matches([checked], :not(:checkbox, :radio))').map((t,e)=>{var n;const r=this._make(e),s=r.attr("name"),a=(n=r.val())!==null&&n!==void 0?n:"";return Array.isArray(a)?a.map(i=>({name:s,value:i.replace(I0,`\r
`)})):{name:s,value:a.replace(I0,`\r
`)}}).toArray()}const jM=Object.freeze(Object.defineProperty({__proto__:null,serialize:FM,serializeArray:UM},Symbol.toStringTag,{value:"Module"}));function HM(t){var e;return typeof t=="string"?{selector:t,value:"textContent"}:{selector:t.selector,value:(e=t.value)!==null&&e!==void 0?e:"textContent"}}function $M(t){const e={};for(const n in t){const r=t[n],s=Array.isArray(r),{selector:a,value:i}=HM(s?r[0]:r),o=typeof i=="function"?i:typeof i=="string"?u=>this._make(u).prop(i):u=>this._make(u).extract(i);if(s)e[n]=this._findBySelector(a,Number.POSITIVE_INFINITY).map((u,c)=>o(c,n,e)).get();else{const u=this._findBySelector(a,1);e[n]=u.length>0?o(u[0],n,e):void 0}}return e}const qM=Object.freeze(Object.defineProperty({__proto__:null,extract:$M},Symbol.toStringTag,{value:"Module"}));class wo{constructor(e,n,r){if(this.length=0,this.options=r,this._root=n,e){for(let s=0;s<e.length;s++)this[s]=e[s];this.length=e.length}}}wo.prototype.cheerio="[cheerio object]";wo.prototype.splice=Array.prototype.splice;wo.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator];Object.assign(wo.prototype,Z4,lM,PM,MM,jM,qM);function VM(t,e){return function n(r,s,a=!0){if(r==null)throw new Error("cheerio.load() expects a string");const i=Bh(s),o=t(r,i,a,null);class u extends wo{_make(d,m){const p=c(d,m);return p.prevObject=this,p}_parse(d,m,p,f){return t(d,m,p,f)}_render(d){return e(d,this.options)}}function c(l,d,m=o,p){if(l&&Ir(l))return l;const f=Bh(p,i),g=typeof m=="string"?[t(m,f,!1,null)]:"length"in m?m:[m],b=Ir(g)?g:new u(g,null,f);if(b._root=b,!l)return new u(void 0,b,f);const _=typeof l=="string"&&Fh(l)?t(l,f,!1,null).children:zM(l)?[l]:Array.isArray(l)?l:void 0,y=new u(_,b,f);if(_)return y;if(typeof l!="string")throw new TypeError("Unexpected type of selector");let S=l;const I=d?typeof d=="string"?Fh(d)?new u([t(d,f,!1,null)],b,f):(S=`${d} ${S}`,b):Ir(d)?d:new u(Array.isArray(d)?d:[d],b,f):b;return I?I.find(S):y}return Object.assign(c,F4,{load:n,_root:o,_options:i,fn:u.prototype,prototype:u.prototype}),c}}function zM(t){return!!t.name||t.type==="root"||t.type==="text"||t.type==="comment"}const WM=new Set([65534,65535,131070,131071,196606,196607,262142,262143,327678,327679,393214,393215,458750,458751,524286,524287,589822,589823,655358,655359,720894,720895,786430,786431,851966,851967,917502,917503,983038,983039,1048574,1048575,1114110,1114111]),et="";var E;(function(t){t[t.EOF=-1]="EOF",t[t.NULL=0]="NULL",t[t.TABULATION=9]="TABULATION",t[t.CARRIAGE_RETURN=13]="CARRIAGE_RETURN",t[t.LINE_FEED=10]="LINE_FEED",t[t.FORM_FEED=12]="FORM_FEED",t[t.SPACE=32]="SPACE",t[t.EXCLAMATION_MARK=33]="EXCLAMATION_MARK",t[t.QUOTATION_MARK=34]="QUOTATION_MARK",t[t.AMPERSAND=38]="AMPERSAND",t[t.APOSTROPHE=39]="APOSTROPHE",t[t.HYPHEN_MINUS=45]="HYPHEN_MINUS",t[t.SOLIDUS=47]="SOLIDUS",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_9=57]="DIGIT_9",t[t.SEMICOLON=59]="SEMICOLON",t[t.LESS_THAN_SIGN=60]="LESS_THAN_SIGN",t[t.EQUALS_SIGN=61]="EQUALS_SIGN",t[t.GREATER_THAN_SIGN=62]="GREATER_THAN_SIGN",t[t.QUESTION_MARK=63]="QUESTION_MARK",t[t.LATIN_CAPITAL_A=65]="LATIN_CAPITAL_A",t[t.LATIN_CAPITAL_Z=90]="LATIN_CAPITAL_Z",t[t.RIGHT_SQUARE_BRACKET=93]="RIGHT_SQUARE_BRACKET",t[t.GRAVE_ACCENT=96]="GRAVE_ACCENT",t[t.LATIN_SMALL_A=97]="LATIN_SMALL_A",t[t.LATIN_SMALL_Z=122]="LATIN_SMALL_Z"})(E||(E={}));const Gt={DASH_DASH:"--",CDATA_START:"[CDATA[",DOCTYPE:"doctype",SCRIPT:"script",PUBLIC:"public",SYSTEM:"system"};function mw(t){return t>=55296&&t<=57343}function GM(t){return t>=56320&&t<=57343}function KM(t,e){return(t-55296)*1024+9216+e}function pw(t){return t!==32&&t!==10&&t!==13&&t!==9&&t!==12&&t>=1&&t<=31||t>=127&&t<=159}function gw(t){return t>=64976&&t<=65007||WM.has(t)}var U;(function(t){t.controlCharacterInInputStream="control-character-in-input-stream",t.noncharacterInInputStream="noncharacter-in-input-stream",t.surrogateInInputStream="surrogate-in-input-stream",t.nonVoidHtmlElementStartTagWithTrailingSolidus="non-void-html-element-start-tag-with-trailing-solidus",t.endTagWithAttributes="end-tag-with-attributes",t.endTagWithTrailingSolidus="end-tag-with-trailing-solidus",t.unexpectedSolidusInTag="unexpected-solidus-in-tag",t.unexpectedNullCharacter="unexpected-null-character",t.unexpectedQuestionMarkInsteadOfTagName="unexpected-question-mark-instead-of-tag-name",t.invalidFirstCharacterOfTagName="invalid-first-character-of-tag-name",t.unexpectedEqualsSignBeforeAttributeName="unexpected-equals-sign-before-attribute-name",t.missingEndTagName="missing-end-tag-name",t.unexpectedCharacterInAttributeName="unexpected-character-in-attribute-name",t.unknownNamedCharacterReference="unknown-named-character-reference",t.missingSemicolonAfterCharacterReference="missing-semicolon-after-character-reference",t.unexpectedCharacterAfterDoctypeSystemIdentifier="unexpected-character-after-doctype-system-identifier",t.unexpectedCharacterInUnquotedAttributeValue="unexpected-character-in-unquoted-attribute-value",t.eofBeforeTagName="eof-before-tag-name",t.eofInTag="eof-in-tag",t.missingAttributeValue="missing-attribute-value",t.missingWhitespaceBetweenAttributes="missing-whitespace-between-attributes",t.missingWhitespaceAfterDoctypePublicKeyword="missing-whitespace-after-doctype-public-keyword",t.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers="missing-whitespace-between-doctype-public-and-system-identifiers",t.missingWhitespaceAfterDoctypeSystemKeyword="missing-whitespace-after-doctype-system-keyword",t.missingQuoteBeforeDoctypePublicIdentifier="missing-quote-before-doctype-public-identifier",t.missingQuoteBeforeDoctypeSystemIdentifier="missing-quote-before-doctype-system-identifier",t.missingDoctypePublicIdentifier="missing-doctype-public-identifier",t.missingDoctypeSystemIdentifier="missing-doctype-system-identifier",t.abruptDoctypePublicIdentifier="abrupt-doctype-public-identifier",t.abruptDoctypeSystemIdentifier="abrupt-doctype-system-identifier",t.cdataInHtmlContent="cdata-in-html-content",t.incorrectlyOpenedComment="incorrectly-opened-comment",t.eofInScriptHtmlCommentLikeText="eof-in-script-html-comment-like-text",t.eofInDoctype="eof-in-doctype",t.nestedComment="nested-comment",t.abruptClosingOfEmptyComment="abrupt-closing-of-empty-comment",t.eofInComment="eof-in-comment",t.incorrectlyClosedComment="incorrectly-closed-comment",t.eofInCdata="eof-in-cdata",t.absenceOfDigitsInNumericCharacterReference="absence-of-digits-in-numeric-character-reference",t.nullCharacterReference="null-character-reference",t.surrogateCharacterReference="surrogate-character-reference",t.characterReferenceOutsideUnicodeRange="character-reference-outside-unicode-range",t.controlCharacterReference="control-character-reference",t.noncharacterCharacterReference="noncharacter-character-reference",t.missingWhitespaceBeforeDoctypeName="missing-whitespace-before-doctype-name",t.missingDoctypeName="missing-doctype-name",t.invalidCharacterSequenceAfterDoctypeName="invalid-character-sequence-after-doctype-name",t.duplicateAttribute="duplicate-attribute",t.nonConformingDoctype="non-conforming-doctype",t.missingDoctype="missing-doctype",t.misplacedDoctype="misplaced-doctype",t.endTagWithoutMatchingOpenElement="end-tag-without-matching-open-element",t.closingOfElementWithOpenChildElements="closing-of-element-with-open-child-elements",t.disallowedContentInNoscriptInHead="disallowed-content-in-noscript-in-head",t.openElementsLeftAfterEof="open-elements-left-after-eof",t.abandonedHeadElementChild="abandoned-head-element-child",t.misplacedStartTagForHeadElement="misplaced-start-tag-for-head-element",t.nestedNoscriptInHead="nested-noscript-in-head",t.eofInElementThatCanContainOnlyText="eof-in-element-that-can-contain-only-text"})(U||(U={}));const YM=65536;class ZM{constructor(e){this.handler=e,this.html="",this.pos=-1,this.lastGapPos=-2,this.gapStack=[],this.skipNextNewLine=!1,this.lastChunkWritten=!1,this.endOfChunkHit=!1,this.bufferWaterline=YM,this.isEol=!1,this.lineStartPos=0,this.droppedBufferSize=0,this.line=1,this.lastErrOffset=-1}get col(){return this.pos-this.lineStartPos+ +(this.lastGapPos!==this.pos)}get offset(){return this.droppedBufferSize+this.pos}getError(e,n){const{line:r,col:s,offset:a}=this,i=s+n,o=a+n;return{code:e,startLine:r,endLine:r,startCol:i,endCol:i,startOffset:o,endOffset:o}}_err(e){this.handler.onParseError&&this.lastErrOffset!==this.offset&&(this.lastErrOffset=this.offset,this.handler.onParseError(this.getError(e,0)))}_addGap(){this.gapStack.push(this.lastGapPos),this.lastGapPos=this.pos}_processSurrogate(e){if(this.pos!==this.html.length-1){const n=this.html.charCodeAt(this.pos+1);if(GM(n))return this.pos++,this._addGap(),KM(e,n)}else if(!this.lastChunkWritten)return this.endOfChunkHit=!0,E.EOF;return this._err(U.surrogateInInputStream),e}willDropParsedChunk(){return this.pos>this.bufferWaterline}dropParsedChunk(){this.willDropParsedChunk()&&(this.html=this.html.substring(this.pos),this.lineStartPos-=this.pos,this.droppedBufferSize+=this.pos,this.pos=0,this.lastGapPos=-2,this.gapStack.length=0)}write(e,n){this.html.length>0?this.html+=e:this.html=e,this.endOfChunkHit=!1,this.lastChunkWritten=n}insertHtmlAtCurrentPos(e){this.html=this.html.substring(0,this.pos+1)+e+this.html.substring(this.pos+1),this.endOfChunkHit=!1}startsWith(e,n){if(this.pos+e.length>this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,!1;if(n)return this.html.startsWith(e,this.pos);for(let r=0;r<e.length;r++)if((this.html.charCodeAt(this.pos+r)|32)!==e.charCodeAt(r))return!1;return!0}peek(e){const n=this.pos+e;if(n>=this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,E.EOF;const r=this.html.charCodeAt(n);return r===E.CARRIAGE_RETURN?E.LINE_FEED:r}advance(){if(this.pos++,this.isEol&&(this.isEol=!1,this.line++,this.lineStartPos=this.pos),this.pos>=this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,E.EOF;let e=this.html.charCodeAt(this.pos);return e===E.CARRIAGE_RETURN?(this.isEol=!0,this.skipNextNewLine=!0,E.LINE_FEED):e===E.LINE_FEED&&(this.isEol=!0,this.skipNextNewLine)?(this.line--,this.skipNextNewLine=!1,this._addGap(),this.advance()):(this.skipNextNewLine=!1,mw(e)&&(e=this._processSurrogate(e)),this.handler.onParseError===null||e>31&&e<127||e===E.LINE_FEED||e===E.CARRIAGE_RETURN||e>159&&e<64976||this._checkForProblematicCharacters(e),e)}_checkForProblematicCharacters(e){pw(e)?this._err(U.controlCharacterInInputStream):gw(e)&&this._err(U.noncharacterInInputStream)}retreat(e){for(this.pos-=e;this.pos<this.lastGapPos;)this.lastGapPos=this.gapStack.pop(),this.pos--;this.isEol=!1}}var Fe;(function(t){t[t.CHARACTER=0]="CHARACTER",t[t.NULL_CHARACTER=1]="NULL_CHARACTER",t[t.WHITESPACE_CHARACTER=2]="WHITESPACE_CHARACTER",t[t.START_TAG=3]="START_TAG",t[t.END_TAG=4]="END_TAG",t[t.COMMENT=5]="COMMENT",t[t.DOCTYPE=6]="DOCTYPE",t[t.EOF=7]="EOF",t[t.HIBERNATION=8]="HIBERNATION"})(Fe||(Fe={}));function bw(t,e){for(let n=t.attrs.length-1;n>=0;n--)if(t.attrs[n].name===e)return t.attrs[n].value;return null}var G;(function(t){t.HTML="http://www.w3.org/1999/xhtml",t.MATHML="http://www.w3.org/1998/Math/MathML",t.SVG="http://www.w3.org/2000/svg",t.XLINK="http://www.w3.org/1999/xlink",t.XML="http://www.w3.org/XML/1998/namespace",t.XMLNS="http://www.w3.org/2000/xmlns/"})(G||(G={}));var ps;(function(t){t.TYPE="type",t.ACTION="action",t.ENCODING="encoding",t.PROMPT="prompt",t.NAME="name",t.COLOR="color",t.FACE="face",t.SIZE="size"})(ps||(ps={}));var ln;(function(t){t.NO_QUIRKS="no-quirks",t.QUIRKS="quirks",t.LIMITED_QUIRKS="limited-quirks"})(ln||(ln={}));var R;(function(t){t.A="a",t.ADDRESS="address",t.ANNOTATION_XML="annotation-xml",t.APPLET="applet",t.AREA="area",t.ARTICLE="article",t.ASIDE="aside",t.B="b",t.BASE="base",t.BASEFONT="basefont",t.BGSOUND="bgsound",t.BIG="big",t.BLOCKQUOTE="blockquote",t.BODY="body",t.BR="br",t.BUTTON="button",t.CAPTION="caption",t.CENTER="center",t.CODE="code",t.COL="col",t.COLGROUP="colgroup",t.DD="dd",t.DESC="desc",t.DETAILS="details",t.DIALOG="dialog",t.DIR="dir",t.DIV="div",t.DL="dl",t.DT="dt",t.EM="em",t.EMBED="embed",t.FIELDSET="fieldset",t.FIGCAPTION="figcaption",t.FIGURE="figure",t.FONT="font",t.FOOTER="footer",t.FOREIGN_OBJECT="foreignObject",t.FORM="form",t.FRAME="frame",t.FRAMESET="frameset",t.H1="h1",t.H2="h2",t.H3="h3",t.H4="h4",t.H5="h5",t.H6="h6",t.HEAD="head",t.HEADER="header",t.HGROUP="hgroup",t.HR="hr",t.HTML="html",t.I="i",t.IMG="img",t.IMAGE="image",t.INPUT="input",t.IFRAME="iframe",t.KEYGEN="keygen",t.LABEL="label",t.LI="li",t.LINK="link",t.LISTING="listing",t.MAIN="main",t.MALIGNMARK="malignmark",t.MARQUEE="marquee",t.MATH="math",t.MENU="menu",t.META="meta",t.MGLYPH="mglyph",t.MI="mi",t.MO="mo",t.MN="mn",t.MS="ms",t.MTEXT="mtext",t.NAV="nav",t.NOBR="nobr",t.NOFRAMES="noframes",t.NOEMBED="noembed",t.NOSCRIPT="noscript",t.OBJECT="object",t.OL="ol",t.OPTGROUP="optgroup",t.OPTION="option",t.P="p",t.PARAM="param",t.PLAINTEXT="plaintext",t.PRE="pre",t.RB="rb",t.RP="rp",t.RT="rt",t.RTC="rtc",t.RUBY="ruby",t.S="s",t.SCRIPT="script",t.SEARCH="search",t.SECTION="section",t.SELECT="select",t.SOURCE="source",t.SMALL="small",t.SPAN="span",t.STRIKE="strike",t.STRONG="strong",t.STYLE="style",t.SUB="sub",t.SUMMARY="summary",t.SUP="sup",t.TABLE="table",t.TBODY="tbody",t.TEMPLATE="template",t.TEXTAREA="textarea",t.TFOOT="tfoot",t.TD="td",t.TH="th",t.THEAD="thead",t.TITLE="title",t.TR="tr",t.TRACK="track",t.TT="tt",t.U="u",t.UL="ul",t.SVG="svg",t.VAR="var",t.WBR="wbr",t.XMP="xmp"})(R||(R={}));var h;(function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A=1]="A",t[t.ADDRESS=2]="ADDRESS",t[t.ANNOTATION_XML=3]="ANNOTATION_XML",t[t.APPLET=4]="APPLET",t[t.AREA=5]="AREA",t[t.ARTICLE=6]="ARTICLE",t[t.ASIDE=7]="ASIDE",t[t.B=8]="B",t[t.BASE=9]="BASE",t[t.BASEFONT=10]="BASEFONT",t[t.BGSOUND=11]="BGSOUND",t[t.BIG=12]="BIG",t[t.BLOCKQUOTE=13]="BLOCKQUOTE",t[t.BODY=14]="BODY",t[t.BR=15]="BR",t[t.BUTTON=16]="BUTTON",t[t.CAPTION=17]="CAPTION",t[t.CENTER=18]="CENTER",t[t.CODE=19]="CODE",t[t.COL=20]="COL",t[t.COLGROUP=21]="COLGROUP",t[t.DD=22]="DD",t[t.DESC=23]="DESC",t[t.DETAILS=24]="DETAILS",t[t.DIALOG=25]="DIALOG",t[t.DIR=26]="DIR",t[t.DIV=27]="DIV",t[t.DL=28]="DL",t[t.DT=29]="DT",t[t.EM=30]="EM",t[t.EMBED=31]="EMBED",t[t.FIELDSET=32]="FIELDSET",t[t.FIGCAPTION=33]="FIGCAPTION",t[t.FIGURE=34]="FIGURE",t[t.FONT=35]="FONT",t[t.FOOTER=36]="FOOTER",t[t.FOREIGN_OBJECT=37]="FOREIGN_OBJECT",t[t.FORM=38]="FORM",t[t.FRAME=39]="FRAME",t[t.FRAMESET=40]="FRAMESET",t[t.H1=41]="H1",t[t.H2=42]="H2",t[t.H3=43]="H3",t[t.H4=44]="H4",t[t.H5=45]="H5",t[t.H6=46]="H6",t[t.HEAD=47]="HEAD",t[t.HEADER=48]="HEADER",t[t.HGROUP=49]="HGROUP",t[t.HR=50]="HR",t[t.HTML=51]="HTML",t[t.I=52]="I",t[t.IMG=53]="IMG",t[t.IMAGE=54]="IMAGE",t[t.INPUT=55]="INPUT",t[t.IFRAME=56]="IFRAME",t[t.KEYGEN=57]="KEYGEN",t[t.LABEL=58]="LABEL",t[t.LI=59]="LI",t[t.LINK=60]="LINK",t[t.LISTING=61]="LISTING",t[t.MAIN=62]="MAIN",t[t.MALIGNMARK=63]="MALIGNMARK",t[t.MARQUEE=64]="MARQUEE",t[t.MATH=65]="MATH",t[t.MENU=66]="MENU",t[t.META=67]="META",t[t.MGLYPH=68]="MGLYPH",t[t.MI=69]="MI",t[t.MO=70]="MO",t[t.MN=71]="MN",t[t.MS=72]="MS",t[t.MTEXT=73]="MTEXT",t[t.NAV=74]="NAV",t[t.NOBR=75]="NOBR",t[t.NOFRAMES=76]="NOFRAMES",t[t.NOEMBED=77]="NOEMBED",t[t.NOSCRIPT=78]="NOSCRIPT",t[t.OBJECT=79]="OBJECT",t[t.OL=80]="OL",t[t.OPTGROUP=81]="OPTGROUP",t[t.OPTION=82]="OPTION",t[t.P=83]="P",t[t.PARAM=84]="PARAM",t[t.PLAINTEXT=85]="PLAINTEXT",t[t.PRE=86]="PRE",t[t.RB=87]="RB",t[t.RP=88]="RP",t[t.RT=89]="RT",t[t.RTC=90]="RTC",t[t.RUBY=91]="RUBY",t[t.S=92]="S",t[t.SCRIPT=93]="SCRIPT",t[t.SEARCH=94]="SEARCH",t[t.SECTION=95]="SECTION",t[t.SELECT=96]="SELECT",t[t.SOURCE=97]="SOURCE",t[t.SMALL=98]="SMALL",t[t.SPAN=99]="SPAN",t[t.STRIKE=100]="STRIKE",t[t.STRONG=101]="STRONG",t[t.STYLE=102]="STYLE",t[t.SUB=103]="SUB",t[t.SUMMARY=104]="SUMMARY",t[t.SUP=105]="SUP",t[t.TABLE=106]="TABLE",t[t.TBODY=107]="TBODY",t[t.TEMPLATE=108]="TEMPLATE",t[t.TEXTAREA=109]="TEXTAREA",t[t.TFOOT=110]="TFOOT",t[t.TD=111]="TD",t[t.TH=112]="TH",t[t.THEAD=113]="THEAD",t[t.TITLE=114]="TITLE",t[t.TR=115]="TR",t[t.TRACK=116]="TRACK",t[t.TT=117]="TT",t[t.U=118]="U",t[t.UL=119]="UL",t[t.SVG=120]="SVG",t[t.VAR=121]="VAR",t[t.WBR=122]="WBR",t[t.XMP=123]="XMP"})(h||(h={}));const JM=new Map([[R.A,h.A],[R.ADDRESS,h.ADDRESS],[R.ANNOTATION_XML,h.ANNOTATION_XML],[R.APPLET,h.APPLET],[R.AREA,h.AREA],[R.ARTICLE,h.ARTICLE],[R.ASIDE,h.ASIDE],[R.B,h.B],[R.BASE,h.BASE],[R.BASEFONT,h.BASEFONT],[R.BGSOUND,h.BGSOUND],[R.BIG,h.BIG],[R.BLOCKQUOTE,h.BLOCKQUOTE],[R.BODY,h.BODY],[R.BR,h.BR],[R.BUTTON,h.BUTTON],[R.CAPTION,h.CAPTION],[R.CENTER,h.CENTER],[R.CODE,h.CODE],[R.COL,h.COL],[R.COLGROUP,h.COLGROUP],[R.DD,h.DD],[R.DESC,h.DESC],[R.DETAILS,h.DETAILS],[R.DIALOG,h.DIALOG],[R.DIR,h.DIR],[R.DIV,h.DIV],[R.DL,h.DL],[R.DT,h.DT],[R.EM,h.EM],[R.EMBED,h.EMBED],[R.FIELDSET,h.FIELDSET],[R.FIGCAPTION,h.FIGCAPTION],[R.FIGURE,h.FIGURE],[R.FONT,h.FONT],[R.FOOTER,h.FOOTER],[R.FOREIGN_OBJECT,h.FOREIGN_OBJECT],[R.FORM,h.FORM],[R.FRAME,h.FRAME],[R.FRAMESET,h.FRAMESET],[R.H1,h.H1],[R.H2,h.H2],[R.H3,h.H3],[R.H4,h.H4],[R.H5,h.H5],[R.H6,h.H6],[R.HEAD,h.HEAD],[R.HEADER,h.HEADER],[R.HGROUP,h.HGROUP],[R.HR,h.HR],[R.HTML,h.HTML],[R.I,h.I],[R.IMG,h.IMG],[R.IMAGE,h.IMAGE],[R.INPUT,h.INPUT],[R.IFRAME,h.IFRAME],[R.KEYGEN,h.KEYGEN],[R.LABEL,h.LABEL],[R.LI,h.LI],[R.LINK,h.LINK],[R.LISTING,h.LISTING],[R.MAIN,h.MAIN],[R.MALIGNMARK,h.MALIGNMARK],[R.MARQUEE,h.MARQUEE],[R.MATH,h.MATH],[R.MENU,h.MENU],[R.META,h.META],[R.MGLYPH,h.MGLYPH],[R.MI,h.MI],[R.MO,h.MO],[R.MN,h.MN],[R.MS,h.MS],[R.MTEXT,h.MTEXT],[R.NAV,h.NAV],[R.NOBR,h.NOBR],[R.NOFRAMES,h.NOFRAMES],[R.NOEMBED,h.NOEMBED],[R.NOSCRIPT,h.NOSCRIPT],[R.OBJECT,h.OBJECT],[R.OL,h.OL],[R.OPTGROUP,h.OPTGROUP],[R.OPTION,h.OPTION],[R.P,h.P],[R.PARAM,h.PARAM],[R.PLAINTEXT,h.PLAINTEXT],[R.PRE,h.PRE],[R.RB,h.RB],[R.RP,h.RP],[R.RT,h.RT],[R.RTC,h.RTC],[R.RUBY,h.RUBY],[R.S,h.S],[R.SCRIPT,h.SCRIPT],[R.SEARCH,h.SEARCH],[R.SECTION,h.SECTION],[R.SELECT,h.SELECT],[R.SOURCE,h.SOURCE],[R.SMALL,h.SMALL],[R.SPAN,h.SPAN],[R.STRIKE,h.STRIKE],[R.STRONG,h.STRONG],[R.STYLE,h.STYLE],[R.SUB,h.SUB],[R.SUMMARY,h.SUMMARY],[R.SUP,h.SUP],[R.TABLE,h.TABLE],[R.TBODY,h.TBODY],[R.TEMPLATE,h.TEMPLATE],[R.TEXTAREA,h.TEXTAREA],[R.TFOOT,h.TFOOT],[R.TD,h.TD],[R.TH,h.TH],[R.THEAD,h.THEAD],[R.TITLE,h.TITLE],[R.TR,h.TR],[R.TRACK,h.TRACK],[R.TT,h.TT],[R.U,h.U],[R.UL,h.UL],[R.SVG,h.SVG],[R.VAR,h.VAR],[R.WBR,h.WBR],[R.XMP,h.XMP]]);function ll(t){var e;return(e=JM.get(t))!==null&&e!==void 0?e:h.UNKNOWN}const Z=h,XM={[G.HTML]:new Set([Z.ADDRESS,Z.APPLET,Z.AREA,Z.ARTICLE,Z.ASIDE,Z.BASE,Z.BASEFONT,Z.BGSOUND,Z.BLOCKQUOTE,Z.BODY,Z.BR,Z.BUTTON,Z.CAPTION,Z.CENTER,Z.COL,Z.COLGROUP,Z.DD,Z.DETAILS,Z.DIR,Z.DIV,Z.DL,Z.DT,Z.EMBED,Z.FIELDSET,Z.FIGCAPTION,Z.FIGURE,Z.FOOTER,Z.FORM,Z.FRAME,Z.FRAMESET,Z.H1,Z.H2,Z.H3,Z.H4,Z.H5,Z.H6,Z.HEAD,Z.HEADER,Z.HGROUP,Z.HR,Z.HTML,Z.IFRAME,Z.IMG,Z.INPUT,Z.LI,Z.LINK,Z.LISTING,Z.MAIN,Z.MARQUEE,Z.MENU,Z.META,Z.NAV,Z.NOEMBED,Z.NOFRAMES,Z.NOSCRIPT,Z.OBJECT,Z.OL,Z.P,Z.PARAM,Z.PLAINTEXT,Z.PRE,Z.SCRIPT,Z.SECTION,Z.SELECT,Z.SOURCE,Z.STYLE,Z.SUMMARY,Z.TABLE,Z.TBODY,Z.TD,Z.TEMPLATE,Z.TEXTAREA,Z.TFOOT,Z.TH,Z.THEAD,Z.TITLE,Z.TR,Z.TRACK,Z.UL,Z.WBR,Z.XMP]),[G.MATHML]:new Set([Z.MI,Z.MO,Z.MN,Z.MS,Z.MTEXT,Z.ANNOTATION_XML]),[G.SVG]:new Set([Z.TITLE,Z.FOREIGN_OBJECT,Z.DESC]),[G.XLINK]:new Set,[G.XML]:new Set,[G.XMLNS]:new Set},Vh=new Set([Z.H1,Z.H2,Z.H3,Z.H4,Z.H5,Z.H6]),QM=new Set([R.STYLE,R.SCRIPT,R.XMP,R.IFRAME,R.NOEMBED,R.NOFRAMES,R.PLAINTEXT]);function e8(t,e){return QM.has(t)||e&&t===R.NOSCRIPT}var T;(function(t){t[t.DATA=0]="DATA",t[t.RCDATA=1]="RCDATA",t[t.RAWTEXT=2]="RAWTEXT",t[t.SCRIPT_DATA=3]="SCRIPT_DATA",t[t.PLAINTEXT=4]="PLAINTEXT",t[t.TAG_OPEN=5]="TAG_OPEN",t[t.END_TAG_OPEN=6]="END_TAG_OPEN",t[t.TAG_NAME=7]="TAG_NAME",t[t.RCDATA_LESS_THAN_SIGN=8]="RCDATA_LESS_THAN_SIGN",t[t.RCDATA_END_TAG_OPEN=9]="RCDATA_END_TAG_OPEN",t[t.RCDATA_END_TAG_NAME=10]="RCDATA_END_TAG_NAME",t[t.RAWTEXT_LESS_THAN_SIGN=11]="RAWTEXT_LESS_THAN_SIGN",t[t.RAWTEXT_END_TAG_OPEN=12]="RAWTEXT_END_TAG_OPEN",t[t.RAWTEXT_END_TAG_NAME=13]="RAWTEXT_END_TAG_NAME",t[t.SCRIPT_DATA_LESS_THAN_SIGN=14]="SCRIPT_DATA_LESS_THAN_SIGN",t[t.SCRIPT_DATA_END_TAG_OPEN=15]="SCRIPT_DATA_END_TAG_OPEN",t[t.SCRIPT_DATA_END_TAG_NAME=16]="SCRIPT_DATA_END_TAG_NAME",t[t.SCRIPT_DATA_ESCAPE_START=17]="SCRIPT_DATA_ESCAPE_START",t[t.SCRIPT_DATA_ESCAPE_START_DASH=18]="SCRIPT_DATA_ESCAPE_START_DASH",t[t.SCRIPT_DATA_ESCAPED=19]="SCRIPT_DATA_ESCAPED",t[t.SCRIPT_DATA_ESCAPED_DASH=20]="SCRIPT_DATA_ESCAPED_DASH",t[t.SCRIPT_DATA_ESCAPED_DASH_DASH=21]="SCRIPT_DATA_ESCAPED_DASH_DASH",t[t.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN=22]="SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN",t[t.SCRIPT_DATA_ESCAPED_END_TAG_OPEN=23]="SCRIPT_DATA_ESCAPED_END_TAG_OPEN",t[t.SCRIPT_DATA_ESCAPED_END_TAG_NAME=24]="SCRIPT_DATA_ESCAPED_END_TAG_NAME",t[t.SCRIPT_DATA_DOUBLE_ESCAPE_START=25]="SCRIPT_DATA_DOUBLE_ESCAPE_START",t[t.SCRIPT_DATA_DOUBLE_ESCAPED=26]="SCRIPT_DATA_DOUBLE_ESCAPED",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_DASH=27]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH=28]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN=29]="SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN",t[t.SCRIPT_DATA_DOUBLE_ESCAPE_END=30]="SCRIPT_DATA_DOUBLE_ESCAPE_END",t[t.BEFORE_ATTRIBUTE_NAME=31]="BEFORE_ATTRIBUTE_NAME",t[t.ATTRIBUTE_NAME=32]="ATTRIBUTE_NAME",t[t.AFTER_ATTRIBUTE_NAME=33]="AFTER_ATTRIBUTE_NAME",t[t.BEFORE_ATTRIBUTE_VALUE=34]="BEFORE_ATTRIBUTE_VALUE",t[t.ATTRIBUTE_VALUE_DOUBLE_QUOTED=35]="ATTRIBUTE_VALUE_DOUBLE_QUOTED",t[t.ATTRIBUTE_VALUE_SINGLE_QUOTED=36]="ATTRIBUTE_VALUE_SINGLE_QUOTED",t[t.ATTRIBUTE_VALUE_UNQUOTED=37]="ATTRIBUTE_VALUE_UNQUOTED",t[t.AFTER_ATTRIBUTE_VALUE_QUOTED=38]="AFTER_ATTRIBUTE_VALUE_QUOTED",t[t.SELF_CLOSING_START_TAG=39]="SELF_CLOSING_START_TAG",t[t.BOGUS_COMMENT=40]="BOGUS_COMMENT",t[t.MARKUP_DECLARATION_OPEN=41]="MARKUP_DECLARATION_OPEN",t[t.COMMENT_START=42]="COMMENT_START",t[t.COMMENT_START_DASH=43]="COMMENT_START_DASH",t[t.COMMENT=44]="COMMENT",t[t.COMMENT_LESS_THAN_SIGN=45]="COMMENT_LESS_THAN_SIGN",t[t.COMMENT_LESS_THAN_SIGN_BANG=46]="COMMENT_LESS_THAN_SIGN_BANG",t[t.COMMENT_LESS_THAN_SIGN_BANG_DASH=47]="COMMENT_LESS_THAN_SIGN_BANG_DASH",t[t.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH=48]="COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH",t[t.COMMENT_END_DASH=49]="COMMENT_END_DASH",t[t.COMMENT_END=50]="COMMENT_END",t[t.COMMENT_END_BANG=51]="COMMENT_END_BANG",t[t.DOCTYPE=52]="DOCTYPE",t[t.BEFORE_DOCTYPE_NAME=53]="BEFORE_DOCTYPE_NAME",t[t.DOCTYPE_NAME=54]="DOCTYPE_NAME",t[t.AFTER_DOCTYPE_NAME=55]="AFTER_DOCTYPE_NAME",t[t.AFTER_DOCTYPE_PUBLIC_KEYWORD=56]="AFTER_DOCTYPE_PUBLIC_KEYWORD",t[t.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER=57]="BEFORE_DOCTYPE_PUBLIC_IDENTIFIER",t[t.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED=58]="DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED",t[t.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED=59]="DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED",t[t.AFTER_DOCTYPE_PUBLIC_IDENTIFIER=60]="AFTER_DOCTYPE_PUBLIC_IDENTIFIER",t[t.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS=61]="BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS",t[t.AFTER_DOCTYPE_SYSTEM_KEYWORD=62]="AFTER_DOCTYPE_SYSTEM_KEYWORD",t[t.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER=63]="BEFORE_DOCTYPE_SYSTEM_IDENTIFIER",t[t.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED=64]="DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED",t[t.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED=65]="DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED",t[t.AFTER_DOCTYPE_SYSTEM_IDENTIFIER=66]="AFTER_DOCTYPE_SYSTEM_IDENTIFIER",t[t.BOGUS_DOCTYPE=67]="BOGUS_DOCTYPE",t[t.CDATA_SECTION=68]="CDATA_SECTION",t[t.CDATA_SECTION_BRACKET=69]="CDATA_SECTION_BRACKET",t[t.CDATA_SECTION_END=70]="CDATA_SECTION_END",t[t.CHARACTER_REFERENCE=71]="CHARACTER_REFERENCE",t[t.AMBIGUOUS_AMPERSAND=72]="AMBIGUOUS_AMPERSAND"})(T||(T={}));const Xt={DATA:T.DATA,RCDATA:T.RCDATA,RAWTEXT:T.RAWTEXT,SCRIPT_DATA:T.SCRIPT_DATA,PLAINTEXT:T.PLAINTEXT,CDATA_SECTION:T.CDATA_SECTION};function t8(t){return t>=E.DIGIT_0&&t<=E.DIGIT_9}function ii(t){return t>=E.LATIN_CAPITAL_A&&t<=E.LATIN_CAPITAL_Z}function n8(t){return t>=E.LATIN_SMALL_A&&t<=E.LATIN_SMALL_Z}function Fr(t){return n8(t)||ii(t)}function k0(t){return Fr(t)||t8(t)}function cu(t){return t+32}function _w(t){return t===E.SPACE||t===E.LINE_FEED||t===E.TABULATION||t===E.FORM_FEED}function N0(t){return _w(t)||t===E.SOLIDUS||t===E.GREATER_THAN_SIGN}function r8(t){return t===E.NULL?U.nullCharacterReference:t>1114111?U.characterReferenceOutsideUnicodeRange:mw(t)?U.surrogateCharacterReference:gw(t)?U.noncharacterCharacterReference:pw(t)||t===E.CARRIAGE_RETURN?U.controlCharacterReference:null}let s8=class{constructor(e,n){this.options=e,this.handler=n,this.paused=!1,this.inLoop=!1,this.inForeignNode=!1,this.lastStartTagName="",this.active=!1,this.state=T.DATA,this.returnState=T.DATA,this.entityStartPos=0,this.consumedAfterSnapshot=-1,this.currentCharacterToken=null,this.currentToken=null,this.currentAttr={name:"",value:""},this.preprocessor=new ZM(n),this.currentLocation=this.getCurrentLocation(-1),this.entityDecoder=new dm(lm,(r,s)=>{this.preprocessor.pos=this.entityStartPos+s-1,this._flushCodePointConsumedAsCharacterReference(r)},n.onParseError?{missingSemicolonAfterCharacterReference:()=>{this._err(U.missingSemicolonAfterCharacterReference,1)},absenceOfDigitsInNumericCharacterReference:r=>{this._err(U.absenceOfDigitsInNumericCharacterReference,this.entityStartPos-this.preprocessor.pos+r)},validateNumericCharacterReference:r=>{const s=r8(r);s&&this._err(s,1)}}:void 0)}_err(e,n=0){var r,s;(s=(r=this.handler).onParseError)===null||s===void 0||s.call(r,this.preprocessor.getError(e,n))}getCurrentLocation(e){return this.options.sourceCodeLocationInfo?{startLine:this.preprocessor.line,startCol:this.preprocessor.col-e,startOffset:this.preprocessor.offset-e,endLine:-1,endCol:-1,endOffset:-1}:null}_runParsingLoop(){if(!this.inLoop){for(this.inLoop=!0;this.active&&!this.paused;){this.consumedAfterSnapshot=0;const e=this._consume();this._ensureHibernation()||this._callState(e)}this.inLoop=!1}}pause(){this.paused=!0}resume(e){if(!this.paused)throw new Error("Parser was already resumed");this.paused=!1,!this.inLoop&&(this._runParsingLoop(),this.paused||e==null||e())}write(e,n,r){this.active=!0,this.preprocessor.write(e,n),this._runParsingLoop(),this.paused||r==null||r()}insertHtmlAtCurrentPos(e){this.active=!0,this.preprocessor.insertHtmlAtCurrentPos(e),this._runParsingLoop()}_ensureHibernation(){return this.preprocessor.endOfChunkHit?(this.preprocessor.retreat(this.consumedAfterSnapshot),this.consumedAfterSnapshot=0,this.active=!1,!0):!1}_consume(){return this.consumedAfterSnapshot++,this.preprocessor.advance()}_advanceBy(e){this.consumedAfterSnapshot+=e;for(let n=0;n<e;n++)this.preprocessor.advance()}_consumeSequenceIfMatch(e,n){return this.preprocessor.startsWith(e,n)?(this._advanceBy(e.length-1),!0):!1}_createStartTagToken(){this.currentToken={type:Fe.START_TAG,tagName:"",tagID:h.UNKNOWN,selfClosing:!1,ackSelfClosing:!1,attrs:[],location:this.getCurrentLocation(1)}}_createEndTagToken(){this.currentToken={type:Fe.END_TAG,tagName:"",tagID:h.UNKNOWN,selfClosing:!1,ackSelfClosing:!1,attrs:[],location:this.getCurrentLocation(2)}}_createCommentToken(e){this.currentToken={type:Fe.COMMENT,data:"",location:this.getCurrentLocation(e)}}_createDoctypeToken(e){this.currentToken={type:Fe.DOCTYPE,name:e,forceQuirks:!1,publicId:null,systemId:null,location:this.currentLocation}}_createCharacterToken(e,n){this.currentCharacterToken={type:e,chars:n,location:this.currentLocation}}_createAttr(e){this.currentAttr={name:e,value:""},this.currentLocation=this.getCurrentLocation(0)}_leaveAttrName(){var e,n;const r=this.currentToken;if(bw(r,this.currentAttr.name)===null){if(r.attrs.push(this.currentAttr),r.location&&this.currentLocation){const s=(e=(n=r.location).attrs)!==null&&e!==void 0?e:n.attrs=Object.create(null);s[this.currentAttr.name]=this.currentLocation,this._leaveAttrValue()}}else this._err(U.duplicateAttribute)}_leaveAttrValue(){this.currentLocation&&(this.currentLocation.endLine=this.preprocessor.line,this.currentLocation.endCol=this.preprocessor.col,this.currentLocation.endOffset=this.preprocessor.offset)}prepareToken(e){this._emitCurrentCharacterToken(e.location),this.currentToken=null,e.location&&(e.location.endLine=this.preprocessor.line,e.location.endCol=this.preprocessor.col+1,e.location.endOffset=this.preprocessor.offset+1),this.currentLocation=this.getCurrentLocation(-1)}emitCurrentTagToken(){const e=this.currentToken;this.prepareToken(e),e.tagID=ll(e.tagName),e.type===Fe.START_TAG?(this.lastStartTagName=e.tagName,this.handler.onStartTag(e)):(e.attrs.length>0&&this._err(U.endTagWithAttributes),e.selfClosing&&this._err(U.endTagWithTrailingSolidus),this.handler.onEndTag(e)),this.preprocessor.dropParsedChunk()}emitCurrentComment(e){this.prepareToken(e),this.handler.onComment(e),this.preprocessor.dropParsedChunk()}emitCurrentDoctype(e){this.prepareToken(e),this.handler.onDoctype(e),this.preprocessor.dropParsedChunk()}_emitCurrentCharacterToken(e){if(this.currentCharacterToken){switch(e&&this.currentCharacterToken.location&&(this.currentCharacterToken.location.endLine=e.startLine,this.currentCharacterToken.location.endCol=e.startCol,this.currentCharacterToken.location.endOffset=e.startOffset),this.currentCharacterToken.type){case Fe.CHARACTER:{this.handler.onCharacter(this.currentCharacterToken);break}case Fe.NULL_CHARACTER:{this.handler.onNullCharacter(this.currentCharacterToken);break}case Fe.WHITESPACE_CHARACTER:{this.handler.onWhitespaceCharacter(this.currentCharacterToken);break}}this.currentCharacterToken=null}}_emitEOFToken(){const e=this.getCurrentLocation(0);e&&(e.endLine=e.startLine,e.endCol=e.startCol,e.endOffset=e.startOffset),this._emitCurrentCharacterToken(e),this.handler.onEof({type:Fe.EOF,location:e}),this.active=!1}_appendCharToCurrentCharacterToken(e,n){if(this.currentCharacterToken)if(this.currentCharacterToken.type===e){this.currentCharacterToken.chars+=n;return}else this.currentLocation=this.getCurrentLocation(0),this._emitCurrentCharacterToken(this.currentLocation),this.preprocessor.dropParsedChunk();this._createCharacterToken(e,n)}_emitCodePoint(e){const n=_w(e)?Fe.WHITESPACE_CHARACTER:e===E.NULL?Fe.NULL_CHARACTER:Fe.CHARACTER;this._appendCharToCurrentCharacterToken(n,String.fromCodePoint(e))}_emitChars(e){this._appendCharToCurrentCharacterToken(Fe.CHARACTER,e)}_startCharacterReference(){this.returnState=this.state,this.state=T.CHARACTER_REFERENCE,this.entityStartPos=this.preprocessor.pos,this.entityDecoder.startEntity(this._isCharacterReferenceInAttribute()?Sn.Attribute:Sn.Legacy)}_isCharacterReferenceInAttribute(){return this.returnState===T.ATTRIBUTE_VALUE_DOUBLE_QUOTED||this.returnState===T.ATTRIBUTE_VALUE_SINGLE_QUOTED||this.returnState===T.ATTRIBUTE_VALUE_UNQUOTED}_flushCodePointConsumedAsCharacterReference(e){this._isCharacterReferenceInAttribute()?this.currentAttr.value+=String.fromCodePoint(e):this._emitCodePoint(e)}_callState(e){switch(this.state){case T.DATA:{this._stateData(e);break}case T.RCDATA:{this._stateRcdata(e);break}case T.RAWTEXT:{this._stateRawtext(e);break}case T.SCRIPT_DATA:{this._stateScriptData(e);break}case T.PLAINTEXT:{this._statePlaintext(e);break}case T.TAG_OPEN:{this._stateTagOpen(e);break}case T.END_TAG_OPEN:{this._stateEndTagOpen(e);break}case T.TAG_NAME:{this._stateTagName(e);break}case T.RCDATA_LESS_THAN_SIGN:{this._stateRcdataLessThanSign(e);break}case T.RCDATA_END_TAG_OPEN:{this._stateRcdataEndTagOpen(e);break}case T.RCDATA_END_TAG_NAME:{this._stateRcdataEndTagName(e);break}case T.RAWTEXT_LESS_THAN_SIGN:{this._stateRawtextLessThanSign(e);break}case T.RAWTEXT_END_TAG_OPEN:{this._stateRawtextEndTagOpen(e);break}case T.RAWTEXT_END_TAG_NAME:{this._stateRawtextEndTagName(e);break}case T.SCRIPT_DATA_LESS_THAN_SIGN:{this._stateScriptDataLessThanSign(e);break}case T.SCRIPT_DATA_END_TAG_OPEN:{this._stateScriptDataEndTagOpen(e);break}case T.SCRIPT_DATA_END_TAG_NAME:{this._stateScriptDataEndTagName(e);break}case T.SCRIPT_DATA_ESCAPE_START:{this._stateScriptDataEscapeStart(e);break}case T.SCRIPT_DATA_ESCAPE_START_DASH:{this._stateScriptDataEscapeStartDash(e);break}case T.SCRIPT_DATA_ESCAPED:{this._stateScriptDataEscaped(e);break}case T.SCRIPT_DATA_ESCAPED_DASH:{this._stateScriptDataEscapedDash(e);break}case T.SCRIPT_DATA_ESCAPED_DASH_DASH:{this._stateScriptDataEscapedDashDash(e);break}case T.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN:{this._stateScriptDataEscapedLessThanSign(e);break}case T.SCRIPT_DATA_ESCAPED_END_TAG_OPEN:{this._stateScriptDataEscapedEndTagOpen(e);break}case T.SCRIPT_DATA_ESCAPED_END_TAG_NAME:{this._stateScriptDataEscapedEndTagName(e);break}case T.SCRIPT_DATA_DOUBLE_ESCAPE_START:{this._stateScriptDataDoubleEscapeStart(e);break}case T.SCRIPT_DATA_DOUBLE_ESCAPED:{this._stateScriptDataDoubleEscaped(e);break}case T.SCRIPT_DATA_DOUBLE_ESCAPED_DASH:{this._stateScriptDataDoubleEscapedDash(e);break}case T.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH:{this._stateScriptDataDoubleEscapedDashDash(e);break}case T.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN:{this._stateScriptDataDoubleEscapedLessThanSign(e);break}case T.SCRIPT_DATA_DOUBLE_ESCAPE_END:{this._stateScriptDataDoubleEscapeEnd(e);break}case T.BEFORE_ATTRIBUTE_NAME:{this._stateBeforeAttributeName(e);break}case T.ATTRIBUTE_NAME:{this._stateAttributeName(e);break}case T.AFTER_ATTRIBUTE_NAME:{this._stateAfterAttributeName(e);break}case T.BEFORE_ATTRIBUTE_VALUE:{this._stateBeforeAttributeValue(e);break}case T.ATTRIBUTE_VALUE_DOUBLE_QUOTED:{this._stateAttributeValueDoubleQuoted(e);break}case T.ATTRIBUTE_VALUE_SINGLE_QUOTED:{this._stateAttributeValueSingleQuoted(e);break}case T.ATTRIBUTE_VALUE_UNQUOTED:{this._stateAttributeValueUnquoted(e);break}case T.AFTER_ATTRIBUTE_VALUE_QUOTED:{this._stateAfterAttributeValueQuoted(e);break}case T.SELF_CLOSING_START_TAG:{this._stateSelfClosingStartTag(e);break}case T.BOGUS_COMMENT:{this._stateBogusComment(e);break}case T.MARKUP_DECLARATION_OPEN:{this._stateMarkupDeclarationOpen(e);break}case T.COMMENT_START:{this._stateCommentStart(e);break}case T.COMMENT_START_DASH:{this._stateCommentStartDash(e);break}case T.COMMENT:{this._stateComment(e);break}case T.COMMENT_LESS_THAN_SIGN:{this._stateCommentLessThanSign(e);break}case T.COMMENT_LESS_THAN_SIGN_BANG:{this._stateCommentLessThanSignBang(e);break}case T.COMMENT_LESS_THAN_SIGN_BANG_DASH:{this._stateCommentLessThanSignBangDash(e);break}case T.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH:{this._stateCommentLessThanSignBangDashDash(e);break}case T.COMMENT_END_DASH:{this._stateCommentEndDash(e);break}case T.COMMENT_END:{this._stateCommentEnd(e);break}case T.COMMENT_END_BANG:{this._stateCommentEndBang(e);break}case T.DOCTYPE:{this._stateDoctype(e);break}case T.BEFORE_DOCTYPE_NAME:{this._stateBeforeDoctypeName(e);break}case T.DOCTYPE_NAME:{this._stateDoctypeName(e);break}case T.AFTER_DOCTYPE_NAME:{this._stateAfterDoctypeName(e);break}case T.AFTER_DOCTYPE_PUBLIC_KEYWORD:{this._stateAfterDoctypePublicKeyword(e);break}case T.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER:{this._stateBeforeDoctypePublicIdentifier(e);break}case T.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED:{this._stateDoctypePublicIdentifierDoubleQuoted(e);break}case T.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED:{this._stateDoctypePublicIdentifierSingleQuoted(e);break}case T.AFTER_DOCTYPE_PUBLIC_IDENTIFIER:{this._stateAfterDoctypePublicIdentifier(e);break}case T.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS:{this._stateBetweenDoctypePublicAndSystemIdentifiers(e);break}case T.AFTER_DOCTYPE_SYSTEM_KEYWORD:{this._stateAfterDoctypeSystemKeyword(e);break}case T.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER:{this._stateBeforeDoctypeSystemIdentifier(e);break}case T.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED:{this._stateDoctypeSystemIdentifierDoubleQuoted(e);break}case T.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED:{this._stateDoctypeSystemIdentifierSingleQuoted(e);break}case T.AFTER_DOCTYPE_SYSTEM_IDENTIFIER:{this._stateAfterDoctypeSystemIdentifier(e);break}case T.BOGUS_DOCTYPE:{this._stateBogusDoctype(e);break}case T.CDATA_SECTION:{this._stateCdataSection(e);break}case T.CDATA_SECTION_BRACKET:{this._stateCdataSectionBracket(e);break}case T.CDATA_SECTION_END:{this._stateCdataSectionEnd(e);break}case T.CHARACTER_REFERENCE:{this._stateCharacterReference();break}case T.AMBIGUOUS_AMPERSAND:{this._stateAmbiguousAmpersand(e);break}default:throw new Error("Unknown state")}}_stateData(e){switch(e){case E.LESS_THAN_SIGN:{this.state=T.TAG_OPEN;break}case E.AMPERSAND:{this._startCharacterReference();break}case E.NULL:{this._err(U.unexpectedNullCharacter),this._emitCodePoint(e);break}case E.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateRcdata(e){switch(e){case E.AMPERSAND:{this._startCharacterReference();break}case E.LESS_THAN_SIGN:{this.state=T.RCDATA_LESS_THAN_SIGN;break}case E.NULL:{this._err(U.unexpectedNullCharacter),this._emitChars(et);break}case E.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateRawtext(e){switch(e){case E.LESS_THAN_SIGN:{this.state=T.RAWTEXT_LESS_THAN_SIGN;break}case E.NULL:{this._err(U.unexpectedNullCharacter),this._emitChars(et);break}case E.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptData(e){switch(e){case E.LESS_THAN_SIGN:{this.state=T.SCRIPT_DATA_LESS_THAN_SIGN;break}case E.NULL:{this._err(U.unexpectedNullCharacter),this._emitChars(et);break}case E.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_statePlaintext(e){switch(e){case E.NULL:{this._err(U.unexpectedNullCharacter),this._emitChars(et);break}case E.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateTagOpen(e){if(Fr(e))this._createStartTagToken(),this.state=T.TAG_NAME,this._stateTagName(e);else switch(e){case E.EXCLAMATION_MARK:{this.state=T.MARKUP_DECLARATION_OPEN;break}case E.SOLIDUS:{this.state=T.END_TAG_OPEN;break}case E.QUESTION_MARK:{this._err(U.unexpectedQuestionMarkInsteadOfTagName),this._createCommentToken(1),this.state=T.BOGUS_COMMENT,this._stateBogusComment(e);break}case E.EOF:{this._err(U.eofBeforeTagName),this._emitChars("<"),this._emitEOFToken();break}default:this._err(U.invalidFirstCharacterOfTagName),this._emitChars("<"),this.state=T.DATA,this._stateData(e)}}_stateEndTagOpen(e){if(Fr(e))this._createEndTagToken(),this.state=T.TAG_NAME,this._stateTagName(e);else switch(e){case E.GREATER_THAN_SIGN:{this._err(U.missingEndTagName),this.state=T.DATA;break}case E.EOF:{this._err(U.eofBeforeTagName),this._emitChars("</"),this._emitEOFToken();break}default:this._err(U.invalidFirstCharacterOfTagName),this._createCommentToken(2),this.state=T.BOGUS_COMMENT,this._stateBogusComment(e)}}_stateTagName(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this.state=T.BEFORE_ATTRIBUTE_NAME;break}case E.SOLIDUS:{this.state=T.SELF_CLOSING_START_TAG;break}case E.GREATER_THAN_SIGN:{this.state=T.DATA,this.emitCurrentTagToken();break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.tagName+=et;break}case E.EOF:{this._err(U.eofInTag),this._emitEOFToken();break}default:n.tagName+=String.fromCodePoint(ii(e)?cu(e):e)}}_stateRcdataLessThanSign(e){e===E.SOLIDUS?this.state=T.RCDATA_END_TAG_OPEN:(this._emitChars("<"),this.state=T.RCDATA,this._stateRcdata(e))}_stateRcdataEndTagOpen(e){Fr(e)?(this.state=T.RCDATA_END_TAG_NAME,this._stateRcdataEndTagName(e)):(this._emitChars("</"),this.state=T.RCDATA,this._stateRcdata(e))}handleSpecialEndTag(e){if(!this.preprocessor.startsWith(this.lastStartTagName,!1))return!this._ensureHibernation();this._createEndTagToken();const n=this.currentToken;switch(n.tagName=this.lastStartTagName,this.preprocessor.peek(this.lastStartTagName.length)){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:return this._advanceBy(this.lastStartTagName.length),this.state=T.BEFORE_ATTRIBUTE_NAME,!1;case E.SOLIDUS:return this._advanceBy(this.lastStartTagName.length),this.state=T.SELF_CLOSING_START_TAG,!1;case E.GREATER_THAN_SIGN:return this._advanceBy(this.lastStartTagName.length),this.emitCurrentTagToken(),this.state=T.DATA,!1;default:return!this._ensureHibernation()}}_stateRcdataEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=T.RCDATA,this._stateRcdata(e))}_stateRawtextLessThanSign(e){e===E.SOLIDUS?this.state=T.RAWTEXT_END_TAG_OPEN:(this._emitChars("<"),this.state=T.RAWTEXT,this._stateRawtext(e))}_stateRawtextEndTagOpen(e){Fr(e)?(this.state=T.RAWTEXT_END_TAG_NAME,this._stateRawtextEndTagName(e)):(this._emitChars("</"),this.state=T.RAWTEXT,this._stateRawtext(e))}_stateRawtextEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=T.RAWTEXT,this._stateRawtext(e))}_stateScriptDataLessThanSign(e){switch(e){case E.SOLIDUS:{this.state=T.SCRIPT_DATA_END_TAG_OPEN;break}case E.EXCLAMATION_MARK:{this.state=T.SCRIPT_DATA_ESCAPE_START,this._emitChars("<!");break}default:this._emitChars("<"),this.state=T.SCRIPT_DATA,this._stateScriptData(e)}}_stateScriptDataEndTagOpen(e){Fr(e)?(this.state=T.SCRIPT_DATA_END_TAG_NAME,this._stateScriptDataEndTagName(e)):(this._emitChars("</"),this.state=T.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=T.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscapeStart(e){e===E.HYPHEN_MINUS?(this.state=T.SCRIPT_DATA_ESCAPE_START_DASH,this._emitChars("-")):(this.state=T.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscapeStartDash(e){e===E.HYPHEN_MINUS?(this.state=T.SCRIPT_DATA_ESCAPED_DASH_DASH,this._emitChars("-")):(this.state=T.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscaped(e){switch(e){case E.HYPHEN_MINUS:{this.state=T.SCRIPT_DATA_ESCAPED_DASH,this._emitChars("-");break}case E.LESS_THAN_SIGN:{this.state=T.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case E.NULL:{this._err(U.unexpectedNullCharacter),this._emitChars(et);break}case E.EOF:{this._err(U.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptDataEscapedDash(e){switch(e){case E.HYPHEN_MINUS:{this.state=T.SCRIPT_DATA_ESCAPED_DASH_DASH,this._emitChars("-");break}case E.LESS_THAN_SIGN:{this.state=T.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.state=T.SCRIPT_DATA_ESCAPED,this._emitChars(et);break}case E.EOF:{this._err(U.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=T.SCRIPT_DATA_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataEscapedDashDash(e){switch(e){case E.HYPHEN_MINUS:{this._emitChars("-");break}case E.LESS_THAN_SIGN:{this.state=T.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case E.GREATER_THAN_SIGN:{this.state=T.SCRIPT_DATA,this._emitChars(">");break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.state=T.SCRIPT_DATA_ESCAPED,this._emitChars(et);break}case E.EOF:{this._err(U.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=T.SCRIPT_DATA_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataEscapedLessThanSign(e){e===E.SOLIDUS?this.state=T.SCRIPT_DATA_ESCAPED_END_TAG_OPEN:Fr(e)?(this._emitChars("<"),this.state=T.SCRIPT_DATA_DOUBLE_ESCAPE_START,this._stateScriptDataDoubleEscapeStart(e)):(this._emitChars("<"),this.state=T.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataEscapedEndTagOpen(e){Fr(e)?(this.state=T.SCRIPT_DATA_ESCAPED_END_TAG_NAME,this._stateScriptDataEscapedEndTagName(e)):(this._emitChars("</"),this.state=T.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataEscapedEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=T.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataDoubleEscapeStart(e){if(this.preprocessor.startsWith(Gt.SCRIPT,!1)&&N0(this.preprocessor.peek(Gt.SCRIPT.length))){this._emitCodePoint(e);for(let n=0;n<Gt.SCRIPT.length;n++)this._emitCodePoint(this._consume());this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED}else this._ensureHibernation()||(this.state=T.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataDoubleEscaped(e){switch(e){case E.HYPHEN_MINUS:{this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED_DASH,this._emitChars("-");break}case E.LESS_THAN_SIGN:{this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case E.NULL:{this._err(U.unexpectedNullCharacter),this._emitChars(et);break}case E.EOF:{this._err(U.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedDash(e){switch(e){case E.HYPHEN_MINUS:{this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH,this._emitChars("-");break}case E.LESS_THAN_SIGN:{this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitChars(et);break}case E.EOF:{this._err(U.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedDashDash(e){switch(e){case E.HYPHEN_MINUS:{this._emitChars("-");break}case E.LESS_THAN_SIGN:{this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case E.GREATER_THAN_SIGN:{this.state=T.SCRIPT_DATA,this._emitChars(">");break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitChars(et);break}case E.EOF:{this._err(U.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedLessThanSign(e){e===E.SOLIDUS?(this.state=T.SCRIPT_DATA_DOUBLE_ESCAPE_END,this._emitChars("/")):(this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED,this._stateScriptDataDoubleEscaped(e))}_stateScriptDataDoubleEscapeEnd(e){if(this.preprocessor.startsWith(Gt.SCRIPT,!1)&&N0(this.preprocessor.peek(Gt.SCRIPT.length))){this._emitCodePoint(e);for(let n=0;n<Gt.SCRIPT.length;n++)this._emitCodePoint(this._consume());this.state=T.SCRIPT_DATA_ESCAPED}else this._ensureHibernation()||(this.state=T.SCRIPT_DATA_DOUBLE_ESCAPED,this._stateScriptDataDoubleEscaped(e))}_stateBeforeAttributeName(e){switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.SOLIDUS:case E.GREATER_THAN_SIGN:case E.EOF:{this.state=T.AFTER_ATTRIBUTE_NAME,this._stateAfterAttributeName(e);break}case E.EQUALS_SIGN:{this._err(U.unexpectedEqualsSignBeforeAttributeName),this._createAttr("="),this.state=T.ATTRIBUTE_NAME;break}default:this._createAttr(""),this.state=T.ATTRIBUTE_NAME,this._stateAttributeName(e)}}_stateAttributeName(e){switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:case E.SOLIDUS:case E.GREATER_THAN_SIGN:case E.EOF:{this._leaveAttrName(),this.state=T.AFTER_ATTRIBUTE_NAME,this._stateAfterAttributeName(e);break}case E.EQUALS_SIGN:{this._leaveAttrName(),this.state=T.BEFORE_ATTRIBUTE_VALUE;break}case E.QUOTATION_MARK:case E.APOSTROPHE:case E.LESS_THAN_SIGN:{this._err(U.unexpectedCharacterInAttributeName),this.currentAttr.name+=String.fromCodePoint(e);break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.currentAttr.name+=et;break}default:this.currentAttr.name+=String.fromCodePoint(ii(e)?cu(e):e)}}_stateAfterAttributeName(e){switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.SOLIDUS:{this.state=T.SELF_CLOSING_START_TAG;break}case E.EQUALS_SIGN:{this.state=T.BEFORE_ATTRIBUTE_VALUE;break}case E.GREATER_THAN_SIGN:{this.state=T.DATA,this.emitCurrentTagToken();break}case E.EOF:{this._err(U.eofInTag),this._emitEOFToken();break}default:this._createAttr(""),this.state=T.ATTRIBUTE_NAME,this._stateAttributeName(e)}}_stateBeforeAttributeValue(e){switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.QUOTATION_MARK:{this.state=T.ATTRIBUTE_VALUE_DOUBLE_QUOTED;break}case E.APOSTROPHE:{this.state=T.ATTRIBUTE_VALUE_SINGLE_QUOTED;break}case E.GREATER_THAN_SIGN:{this._err(U.missingAttributeValue),this.state=T.DATA,this.emitCurrentTagToken();break}default:this.state=T.ATTRIBUTE_VALUE_UNQUOTED,this._stateAttributeValueUnquoted(e)}}_stateAttributeValueDoubleQuoted(e){switch(e){case E.QUOTATION_MARK:{this.state=T.AFTER_ATTRIBUTE_VALUE_QUOTED;break}case E.AMPERSAND:{this._startCharacterReference();break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.currentAttr.value+=et;break}case E.EOF:{this._err(U.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAttributeValueSingleQuoted(e){switch(e){case E.APOSTROPHE:{this.state=T.AFTER_ATTRIBUTE_VALUE_QUOTED;break}case E.AMPERSAND:{this._startCharacterReference();break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.currentAttr.value+=et;break}case E.EOF:{this._err(U.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAttributeValueUnquoted(e){switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this._leaveAttrValue(),this.state=T.BEFORE_ATTRIBUTE_NAME;break}case E.AMPERSAND:{this._startCharacterReference();break}case E.GREATER_THAN_SIGN:{this._leaveAttrValue(),this.state=T.DATA,this.emitCurrentTagToken();break}case E.NULL:{this._err(U.unexpectedNullCharacter),this.currentAttr.value+=et;break}case E.QUOTATION_MARK:case E.APOSTROPHE:case E.LESS_THAN_SIGN:case E.EQUALS_SIGN:case E.GRAVE_ACCENT:{this._err(U.unexpectedCharacterInUnquotedAttributeValue),this.currentAttr.value+=String.fromCodePoint(e);break}case E.EOF:{this._err(U.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAfterAttributeValueQuoted(e){switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this._leaveAttrValue(),this.state=T.BEFORE_ATTRIBUTE_NAME;break}case E.SOLIDUS:{this._leaveAttrValue(),this.state=T.SELF_CLOSING_START_TAG;break}case E.GREATER_THAN_SIGN:{this._leaveAttrValue(),this.state=T.DATA,this.emitCurrentTagToken();break}case E.EOF:{this._err(U.eofInTag),this._emitEOFToken();break}default:this._err(U.missingWhitespaceBetweenAttributes),this.state=T.BEFORE_ATTRIBUTE_NAME,this._stateBeforeAttributeName(e)}}_stateSelfClosingStartTag(e){switch(e){case E.GREATER_THAN_SIGN:{const n=this.currentToken;n.selfClosing=!0,this.state=T.DATA,this.emitCurrentTagToken();break}case E.EOF:{this._err(U.eofInTag),this._emitEOFToken();break}default:this._err(U.unexpectedSolidusInTag),this.state=T.BEFORE_ATTRIBUTE_NAME,this._stateBeforeAttributeName(e)}}_stateBogusComment(e){const n=this.currentToken;switch(e){case E.GREATER_THAN_SIGN:{this.state=T.DATA,this.emitCurrentComment(n);break}case E.EOF:{this.emitCurrentComment(n),this._emitEOFToken();break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.data+=et;break}default:n.data+=String.fromCodePoint(e)}}_stateMarkupDeclarationOpen(e){this._consumeSequenceIfMatch(Gt.DASH_DASH,!0)?(this._createCommentToken(Gt.DASH_DASH.length+1),this.state=T.COMMENT_START):this._consumeSequenceIfMatch(Gt.DOCTYPE,!1)?(this.currentLocation=this.getCurrentLocation(Gt.DOCTYPE.length+1),this.state=T.DOCTYPE):this._consumeSequenceIfMatch(Gt.CDATA_START,!0)?this.inForeignNode?this.state=T.CDATA_SECTION:(this._err(U.cdataInHtmlContent),this._createCommentToken(Gt.CDATA_START.length+1),this.currentToken.data="[CDATA[",this.state=T.BOGUS_COMMENT):this._ensureHibernation()||(this._err(U.incorrectlyOpenedComment),this._createCommentToken(2),this.state=T.BOGUS_COMMENT,this._stateBogusComment(e))}_stateCommentStart(e){switch(e){case E.HYPHEN_MINUS:{this.state=T.COMMENT_START_DASH;break}case E.GREATER_THAN_SIGN:{this._err(U.abruptClosingOfEmptyComment),this.state=T.DATA;const n=this.currentToken;this.emitCurrentComment(n);break}default:this.state=T.COMMENT,this._stateComment(e)}}_stateCommentStartDash(e){const n=this.currentToken;switch(e){case E.HYPHEN_MINUS:{this.state=T.COMMENT_END;break}case E.GREATER_THAN_SIGN:{this._err(U.abruptClosingOfEmptyComment),this.state=T.DATA,this.emitCurrentComment(n);break}case E.EOF:{this._err(U.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="-",this.state=T.COMMENT,this._stateComment(e)}}_stateComment(e){const n=this.currentToken;switch(e){case E.HYPHEN_MINUS:{this.state=T.COMMENT_END_DASH;break}case E.LESS_THAN_SIGN:{n.data+="<",this.state=T.COMMENT_LESS_THAN_SIGN;break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.data+=et;break}case E.EOF:{this._err(U.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+=String.fromCodePoint(e)}}_stateCommentLessThanSign(e){const n=this.currentToken;switch(e){case E.EXCLAMATION_MARK:{n.data+="!",this.state=T.COMMENT_LESS_THAN_SIGN_BANG;break}case E.LESS_THAN_SIGN:{n.data+="<";break}default:this.state=T.COMMENT,this._stateComment(e)}}_stateCommentLessThanSignBang(e){e===E.HYPHEN_MINUS?this.state=T.COMMENT_LESS_THAN_SIGN_BANG_DASH:(this.state=T.COMMENT,this._stateComment(e))}_stateCommentLessThanSignBangDash(e){e===E.HYPHEN_MINUS?this.state=T.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH:(this.state=T.COMMENT_END_DASH,this._stateCommentEndDash(e))}_stateCommentLessThanSignBangDashDash(e){e!==E.GREATER_THAN_SIGN&&e!==E.EOF&&this._err(U.nestedComment),this.state=T.COMMENT_END,this._stateCommentEnd(e)}_stateCommentEndDash(e){const n=this.currentToken;switch(e){case E.HYPHEN_MINUS:{this.state=T.COMMENT_END;break}case E.EOF:{this._err(U.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="-",this.state=T.COMMENT,this._stateComment(e)}}_stateCommentEnd(e){const n=this.currentToken;switch(e){case E.GREATER_THAN_SIGN:{this.state=T.DATA,this.emitCurrentComment(n);break}case E.EXCLAMATION_MARK:{this.state=T.COMMENT_END_BANG;break}case E.HYPHEN_MINUS:{n.data+="-";break}case E.EOF:{this._err(U.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="--",this.state=T.COMMENT,this._stateComment(e)}}_stateCommentEndBang(e){const n=this.currentToken;switch(e){case E.HYPHEN_MINUS:{n.data+="--!",this.state=T.COMMENT_END_DASH;break}case E.GREATER_THAN_SIGN:{this._err(U.incorrectlyClosedComment),this.state=T.DATA,this.emitCurrentComment(n);break}case E.EOF:{this._err(U.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="--!",this.state=T.COMMENT,this._stateComment(e)}}_stateDoctype(e){switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this.state=T.BEFORE_DOCTYPE_NAME;break}case E.GREATER_THAN_SIGN:{this.state=T.BEFORE_DOCTYPE_NAME,this._stateBeforeDoctypeName(e);break}case E.EOF:{this._err(U.eofInDoctype),this._createDoctypeToken(null);const n=this.currentToken;n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.missingWhitespaceBeforeDoctypeName),this.state=T.BEFORE_DOCTYPE_NAME,this._stateBeforeDoctypeName(e)}}_stateBeforeDoctypeName(e){if(ii(e))this._createDoctypeToken(String.fromCharCode(cu(e))),this.state=T.DOCTYPE_NAME;else switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.NULL:{this._err(U.unexpectedNullCharacter),this._createDoctypeToken(et),this.state=T.DOCTYPE_NAME;break}case E.GREATER_THAN_SIGN:{this._err(U.missingDoctypeName),this._createDoctypeToken(null);const n=this.currentToken;n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.EOF:{this._err(U.eofInDoctype),this._createDoctypeToken(null);const n=this.currentToken;n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._createDoctypeToken(String.fromCodePoint(e)),this.state=T.DOCTYPE_NAME}}_stateDoctypeName(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this.state=T.AFTER_DOCTYPE_NAME;break}case E.GREATER_THAN_SIGN:{this.state=T.DATA,this.emitCurrentDoctype(n);break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.name+=et;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.name+=String.fromCodePoint(ii(e)?cu(e):e)}}_stateAfterDoctypeName(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.GREATER_THAN_SIGN:{this.state=T.DATA,this.emitCurrentDoctype(n);break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._consumeSequenceIfMatch(Gt.PUBLIC,!1)?this.state=T.AFTER_DOCTYPE_PUBLIC_KEYWORD:this._consumeSequenceIfMatch(Gt.SYSTEM,!1)?this.state=T.AFTER_DOCTYPE_SYSTEM_KEYWORD:this._ensureHibernation()||(this._err(U.invalidCharacterSequenceAfterDoctypeName),n.forceQuirks=!0,this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e))}}_stateAfterDoctypePublicKeyword(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this.state=T.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER;break}case E.QUOTATION_MARK:{this._err(U.missingWhitespaceAfterDoctypePublicKeyword),n.publicId="",this.state=T.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED;break}case E.APOSTROPHE:{this._err(U.missingWhitespaceAfterDoctypePublicKeyword),n.publicId="",this.state=T.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED;break}case E.GREATER_THAN_SIGN:{this._err(U.missingDoctypePublicIdentifier),n.forceQuirks=!0,this.state=T.DATA,this.emitCurrentDoctype(n);break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.missingQuoteBeforeDoctypePublicIdentifier),n.forceQuirks=!0,this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBeforeDoctypePublicIdentifier(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.QUOTATION_MARK:{n.publicId="",this.state=T.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED;break}case E.APOSTROPHE:{n.publicId="",this.state=T.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED;break}case E.GREATER_THAN_SIGN:{this._err(U.missingDoctypePublicIdentifier),n.forceQuirks=!0,this.state=T.DATA,this.emitCurrentDoctype(n);break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.missingQuoteBeforeDoctypePublicIdentifier),n.forceQuirks=!0,this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateDoctypePublicIdentifierDoubleQuoted(e){const n=this.currentToken;switch(e){case E.QUOTATION_MARK:{this.state=T.AFTER_DOCTYPE_PUBLIC_IDENTIFIER;break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.publicId+=et;break}case E.GREATER_THAN_SIGN:{this._err(U.abruptDoctypePublicIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.publicId+=String.fromCodePoint(e)}}_stateDoctypePublicIdentifierSingleQuoted(e){const n=this.currentToken;switch(e){case E.APOSTROPHE:{this.state=T.AFTER_DOCTYPE_PUBLIC_IDENTIFIER;break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.publicId+=et;break}case E.GREATER_THAN_SIGN:{this._err(U.abruptDoctypePublicIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.publicId+=String.fromCodePoint(e)}}_stateAfterDoctypePublicIdentifier(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this.state=T.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS;break}case E.GREATER_THAN_SIGN:{this.state=T.DATA,this.emitCurrentDoctype(n);break}case E.QUOTATION_MARK:{this._err(U.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case E.APOSTROPHE:{this._err(U.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBetweenDoctypePublicAndSystemIdentifiers(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.GREATER_THAN_SIGN:{this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.QUOTATION_MARK:{n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case E.APOSTROPHE:{n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateAfterDoctypeSystemKeyword(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:{this.state=T.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER;break}case E.QUOTATION_MARK:{this._err(U.missingWhitespaceAfterDoctypeSystemKeyword),n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case E.APOSTROPHE:{this._err(U.missingWhitespaceAfterDoctypeSystemKeyword),n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case E.GREATER_THAN_SIGN:{this._err(U.missingDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=T.DATA,this.emitCurrentDoctype(n);break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBeforeDoctypeSystemIdentifier(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.QUOTATION_MARK:{n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case E.APOSTROPHE:{n.systemId="",this.state=T.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case E.GREATER_THAN_SIGN:{this._err(U.missingDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=T.DATA,this.emitCurrentDoctype(n);break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateDoctypeSystemIdentifierDoubleQuoted(e){const n=this.currentToken;switch(e){case E.QUOTATION_MARK:{this.state=T.AFTER_DOCTYPE_SYSTEM_IDENTIFIER;break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.systemId+=et;break}case E.GREATER_THAN_SIGN:{this._err(U.abruptDoctypeSystemIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.systemId+=String.fromCodePoint(e)}}_stateDoctypeSystemIdentifierSingleQuoted(e){const n=this.currentToken;switch(e){case E.APOSTROPHE:{this.state=T.AFTER_DOCTYPE_SYSTEM_IDENTIFIER;break}case E.NULL:{this._err(U.unexpectedNullCharacter),n.systemId+=et;break}case E.GREATER_THAN_SIGN:{this._err(U.abruptDoctypeSystemIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.systemId+=String.fromCodePoint(e)}}_stateAfterDoctypeSystemIdentifier(e){const n=this.currentToken;switch(e){case E.SPACE:case E.LINE_FEED:case E.TABULATION:case E.FORM_FEED:break;case E.GREATER_THAN_SIGN:{this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.EOF:{this._err(U.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(U.unexpectedCharacterAfterDoctypeSystemIdentifier),this.state=T.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBogusDoctype(e){const n=this.currentToken;switch(e){case E.GREATER_THAN_SIGN:{this.emitCurrentDoctype(n),this.state=T.DATA;break}case E.NULL:{this._err(U.unexpectedNullCharacter);break}case E.EOF:{this.emitCurrentDoctype(n),this._emitEOFToken();break}}}_stateCdataSection(e){switch(e){case E.RIGHT_SQUARE_BRACKET:{this.state=T.CDATA_SECTION_BRACKET;break}case E.EOF:{this._err(U.eofInCdata),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateCdataSectionBracket(e){e===E.RIGHT_SQUARE_BRACKET?this.state=T.CDATA_SECTION_END:(this._emitChars("]"),this.state=T.CDATA_SECTION,this._stateCdataSection(e))}_stateCdataSectionEnd(e){switch(e){case E.GREATER_THAN_SIGN:{this.state=T.DATA;break}case E.RIGHT_SQUARE_BRACKET:{this._emitChars("]");break}default:this._emitChars("]]"),this.state=T.CDATA_SECTION,this._stateCdataSection(e)}}_stateCharacterReference(){let e=this.entityDecoder.write(this.preprocessor.html,this.preprocessor.pos);if(e<0)if(this.preprocessor.lastChunkWritten)e=this.entityDecoder.end();else{this.active=!1,this.preprocessor.pos=this.preprocessor.html.length-1,this.consumedAfterSnapshot=0,this.preprocessor.endOfChunkHit=!0;return}e===0?(this.preprocessor.pos=this.entityStartPos,this._flushCodePointConsumedAsCharacterReference(E.AMPERSAND),this.state=!this._isCharacterReferenceInAttribute()&&k0(this.preprocessor.peek(1))?T.AMBIGUOUS_AMPERSAND:this.returnState):this.state=this.returnState}_stateAmbiguousAmpersand(e){k0(e)?this._flushCodePointConsumedAsCharacterReference(e):(e===E.SEMICOLON&&this._err(U.unknownNamedCharacterReference),this.state=this.returnState,this._callState(e))}};const yw=new Set([h.DD,h.DT,h.LI,h.OPTGROUP,h.OPTION,h.P,h.RB,h.RP,h.RT,h.RTC]),R0=new Set([...yw,h.CAPTION,h.COLGROUP,h.TBODY,h.TD,h.TFOOT,h.TH,h.THEAD,h.TR]),fc=new Set([h.APPLET,h.CAPTION,h.HTML,h.MARQUEE,h.OBJECT,h.TABLE,h.TD,h.TEMPLATE,h.TH]),a8=new Set([...fc,h.OL,h.UL]),i8=new Set([...fc,h.BUTTON]),P0=new Set([h.ANNOTATION_XML,h.MI,h.MN,h.MO,h.MS,h.MTEXT]),x0=new Set([h.DESC,h.FOREIGN_OBJECT,h.TITLE]),o8=new Set([h.TR,h.TEMPLATE,h.HTML]),u8=new Set([h.TBODY,h.TFOOT,h.THEAD,h.TEMPLATE,h.HTML]),c8=new Set([h.TABLE,h.TEMPLATE,h.HTML]),l8=new Set([h.TD,h.TH]);class d8{get currentTmplContentOrNode(){return this._isInTemplate()?this.treeAdapter.getTemplateContent(this.current):this.current}constructor(e,n,r){this.treeAdapter=n,this.handler=r,this.items=[],this.tagIDs=[],this.stackTop=-1,this.tmplCount=0,this.currentTagId=h.UNKNOWN,this.current=e}_indexOf(e){return this.items.lastIndexOf(e,this.stackTop)}_isInTemplate(){return this.currentTagId===h.TEMPLATE&&this.treeAdapter.getNamespaceURI(this.current)===G.HTML}_updateCurrentElement(){this.current=this.items[this.stackTop],this.currentTagId=this.tagIDs[this.stackTop]}push(e,n){this.stackTop++,this.items[this.stackTop]=e,this.current=e,this.tagIDs[this.stackTop]=n,this.currentTagId=n,this._isInTemplate()&&this.tmplCount++,this.handler.onItemPush(e,n,!0)}pop(){const e=this.current;this.tmplCount>0&&this._isInTemplate()&&this.tmplCount--,this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(e,!0)}replace(e,n){const r=this._indexOf(e);this.items[r]=n,r===this.stackTop&&(this.current=n)}insertAfter(e,n,r){const s=this._indexOf(e)+1;this.items.splice(s,0,n),this.tagIDs.splice(s,0,r),this.stackTop++,s===this.stackTop&&this._updateCurrentElement(),this.handler.onItemPush(this.current,this.currentTagId,s===this.stackTop)}popUntilTagNamePopped(e){let n=this.stackTop+1;do n=this.tagIDs.lastIndexOf(e,n-1);while(n>0&&this.treeAdapter.getNamespaceURI(this.items[n])!==G.HTML);this.shortenToLength(n<0?0:n)}shortenToLength(e){for(;this.stackTop>=e;){const n=this.current;this.tmplCount>0&&this._isInTemplate()&&(this.tmplCount-=1),this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(n,this.stackTop<e)}}popUntilElementPopped(e){const n=this._indexOf(e);this.shortenToLength(n<0?0:n)}popUntilPopped(e,n){const r=this._indexOfTagNames(e,n);this.shortenToLength(r<0?0:r)}popUntilNumberedHeaderPopped(){this.popUntilPopped(Vh,G.HTML)}popUntilTableCellPopped(){this.popUntilPopped(l8,G.HTML)}popAllUpToHtmlElement(){this.tmplCount=0,this.shortenToLength(1)}_indexOfTagNames(e,n){for(let r=this.stackTop;r>=0;r--)if(e.has(this.tagIDs[r])&&this.treeAdapter.getNamespaceURI(this.items[r])===n)return r;return-1}clearBackTo(e,n){const r=this._indexOfTagNames(e,n);this.shortenToLength(r+1)}clearBackToTableContext(){this.clearBackTo(c8,G.HTML)}clearBackToTableBodyContext(){this.clearBackTo(u8,G.HTML)}clearBackToTableRowContext(){this.clearBackTo(o8,G.HTML)}remove(e){const n=this._indexOf(e);n>=0&&(n===this.stackTop?this.pop():(this.items.splice(n,1),this.tagIDs.splice(n,1),this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(e,!1)))}tryPeekProperlyNestedBodyElement(){return this.stackTop>=1&&this.tagIDs[1]===h.BODY?this.items[1]:null}contains(e){return this._indexOf(e)>-1}getCommonAncestor(e){const n=this._indexOf(e)-1;return n>=0?this.items[n]:null}isRootHtmlElementCurrent(){return this.stackTop===0&&this.tagIDs[0]===h.HTML}hasInDynamicScope(e,n){for(let r=this.stackTop;r>=0;r--){const s=this.tagIDs[r];switch(this.treeAdapter.getNamespaceURI(this.items[r])){case G.HTML:{if(s===e)return!0;if(n.has(s))return!1;break}case G.SVG:{if(x0.has(s))return!1;break}case G.MATHML:{if(P0.has(s))return!1;break}}}return!0}hasInScope(e){return this.hasInDynamicScope(e,fc)}hasInListItemScope(e){return this.hasInDynamicScope(e,a8)}hasInButtonScope(e){return this.hasInDynamicScope(e,i8)}hasNumberedHeaderInScope(){for(let e=this.stackTop;e>=0;e--){const n=this.tagIDs[e];switch(this.treeAdapter.getNamespaceURI(this.items[e])){case G.HTML:{if(Vh.has(n))return!0;if(fc.has(n))return!1;break}case G.SVG:{if(x0.has(n))return!1;break}case G.MATHML:{if(P0.has(n))return!1;break}}}return!0}hasInTableScope(e){for(let n=this.stackTop;n>=0;n--)if(this.treeAdapter.getNamespaceURI(this.items[n])===G.HTML)switch(this.tagIDs[n]){case e:return!0;case h.TABLE:case h.HTML:return!1}return!0}hasTableBodyContextInTableScope(){for(let e=this.stackTop;e>=0;e--)if(this.treeAdapter.getNamespaceURI(this.items[e])===G.HTML)switch(this.tagIDs[e]){case h.TBODY:case h.THEAD:case h.TFOOT:return!0;case h.TABLE:case h.HTML:return!1}return!0}hasInSelectScope(e){for(let n=this.stackTop;n>=0;n--)if(this.treeAdapter.getNamespaceURI(this.items[n])===G.HTML)switch(this.tagIDs[n]){case e:return!0;case h.OPTION:case h.OPTGROUP:break;default:return!1}return!0}generateImpliedEndTags(){for(;yw.has(this.currentTagId);)this.pop()}generateImpliedEndTagsThoroughly(){for(;R0.has(this.currentTagId);)this.pop()}generateImpliedEndTagsWithExclusion(e){for(;this.currentTagId!==e&&R0.has(this.currentTagId);)this.pop()}}const vd=3;var sr;(function(t){t[t.Marker=0]="Marker",t[t.Element=1]="Element"})(sr||(sr={}));const L0={type:sr.Marker};class h8{constructor(e){this.treeAdapter=e,this.entries=[],this.bookmark=null}_getNoahArkConditionCandidates(e,n){const r=[],s=n.length,a=this.treeAdapter.getTagName(e),i=this.treeAdapter.getNamespaceURI(e);for(let o=0;o<this.entries.length;o++){const u=this.entries[o];if(u.type===sr.Marker)break;const{element:c}=u;if(this.treeAdapter.getTagName(c)===a&&this.treeAdapter.getNamespaceURI(c)===i){const l=this.treeAdapter.getAttrList(c);l.length===s&&r.push({idx:o,attrs:l})}}return r}_ensureNoahArkCondition(e){if(this.entries.length<vd)return;const n=this.treeAdapter.getAttrList(e),r=this._getNoahArkConditionCandidates(e,n);if(r.length<vd)return;const s=new Map(n.map(i=>[i.name,i.value]));let a=0;for(let i=0;i<r.length;i++){const o=r[i];o.attrs.every(u=>s.get(u.name)===u.value)&&(a+=1,a>=vd&&this.entries.splice(o.idx,1))}}insertMarker(){this.entries.unshift(L0)}pushElement(e,n){this._ensureNoahArkCondition(e),this.entries.unshift({type:sr.Element,element:e,token:n})}insertElementAfterBookmark(e,n){const r=this.entries.indexOf(this.bookmark);this.entries.splice(r,0,{type:sr.Element,element:e,token:n})}removeEntry(e){const n=this.entries.indexOf(e);n>=0&&this.entries.splice(n,1)}clearToLastMarker(){const e=this.entries.indexOf(L0);e>=0?this.entries.splice(0,e+1):this.entries.length=0}getElementEntryInScopeWithTagName(e){const n=this.entries.find(r=>r.type===sr.Marker||this.treeAdapter.getTagName(r.element)===e);return n&&n.type===sr.Element?n:null}getElementEntry(e){return this.entries.find(n=>n.type===sr.Element&&n.element===e)}}const wr={createDocument(){return{nodeName:"#document",mode:ln.NO_QUIRKS,childNodes:[]}},createDocumentFragment(){return{nodeName:"#document-fragment",childNodes:[]}},createElement(t,e,n){return{nodeName:t,tagName:t,attrs:n,namespaceURI:e,childNodes:[],parentNode:null}},createCommentNode(t){return{nodeName:"#comment",data:t,parentNode:null}},createTextNode(t){return{nodeName:"#text",value:t,parentNode:null}},appendChild(t,e){t.childNodes.push(e),e.parentNode=t},insertBefore(t,e,n){const r=t.childNodes.indexOf(n);t.childNodes.splice(r,0,e),e.parentNode=t},setTemplateContent(t,e){t.content=e},getTemplateContent(t){return t.content},setDocumentType(t,e,n,r){const s=t.childNodes.find(a=>a.nodeName==="#documentType");if(s)s.name=e,s.publicId=n,s.systemId=r;else{const a={nodeName:"#documentType",name:e,publicId:n,systemId:r,parentNode:null};wr.appendChild(t,a)}},setDocumentMode(t,e){t.mode=e},getDocumentMode(t){return t.mode},detachNode(t){if(t.parentNode){const e=t.parentNode.childNodes.indexOf(t);t.parentNode.childNodes.splice(e,1),t.parentNode=null}},insertText(t,e){if(t.childNodes.length>0){const n=t.childNodes[t.childNodes.length-1];if(wr.isTextNode(n)){n.value+=e;return}}wr.appendChild(t,wr.createTextNode(e))},insertTextBefore(t,e,n){const r=t.childNodes[t.childNodes.indexOf(n)-1];r&&wr.isTextNode(r)?r.value+=e:wr.insertBefore(t,wr.createTextNode(e),n)},adoptAttributes(t,e){const n=new Set(t.attrs.map(r=>r.name));for(let r=0;r<e.length;r++)n.has(e[r].name)||t.attrs.push(e[r])},getFirstChild(t){return t.childNodes[0]},getChildNodes(t){return t.childNodes},getParentNode(t){return t.parentNode},getAttrList(t){return t.attrs},getTagName(t){return t.tagName},getNamespaceURI(t){return t.namespaceURI},getTextNodeContent(t){return t.value},getCommentNodeContent(t){return t.data},getDocumentTypeNodeName(t){return t.name},getDocumentTypeNodePublicId(t){return t.publicId},getDocumentTypeNodeSystemId(t){return t.systemId},isTextNode(t){return t.nodeName==="#text"},isCommentNode(t){return t.nodeName==="#comment"},isDocumentTypeNode(t){return t.nodeName==="#documentType"},isElementNode(t){return Object.prototype.hasOwnProperty.call(t,"tagName")},setNodeSourceCodeLocation(t,e){t.sourceCodeLocation=e},getNodeSourceCodeLocation(t){return t.sourceCodeLocation},updateNodeSourceCodeLocation(t,e){t.sourceCodeLocation={...t.sourceCodeLocation,...e}}},Ew="html",f8="about:legacy-compat",m8="http://www.ibm.com/data/dtd/v11/ibmxhtml1-transitional.dtd",ww=["+//silmaril//dtd html pro v0r11 19970101//","-//as//dtd html 3.0 aswedit + extensions//","-//advasoft ltd//dtd html 3.0 aswedit + extensions//","-//ietf//dtd html 2.0 level 1//","-//ietf//dtd html 2.0 level 2//","-//ietf//dtd html 2.0 strict level 1//","-//ietf//dtd html 2.0 strict level 2//","-//ietf//dtd html 2.0 strict//","-//ietf//dtd html 2.0//","-//ietf//dtd html 2.1e//","-//ietf//dtd html 3.0//","-//ietf//dtd html 3.2 final//","-//ietf//dtd html 3.2//","-//ietf//dtd html 3//","-//ietf//dtd html level 0//","-//ietf//dtd html level 1//","-//ietf//dtd html level 2//","-//ietf//dtd html level 3//","-//ietf//dtd html strict level 0//","-//ietf//dtd html strict level 1//","-//ietf//dtd html strict level 2//","-//ietf//dtd html strict level 3//","-//ietf//dtd html strict//","-//ietf//dtd html//","-//metrius//dtd metrius presentational//","-//microsoft//dtd internet explorer 2.0 html strict//","-//microsoft//dtd internet explorer 2.0 html//","-//microsoft//dtd internet explorer 2.0 tables//","-//microsoft//dtd internet explorer 3.0 html strict//","-//microsoft//dtd internet explorer 3.0 html//","-//microsoft//dtd internet explorer 3.0 tables//","-//netscape comm. corp.//dtd html//","-//netscape comm. corp.//dtd strict html//","-//o'reilly and associates//dtd html 2.0//","-//o'reilly and associates//dtd html extended 1.0//","-//o'reilly and associates//dtd html extended relaxed 1.0//","-//sq//dtd html 2.0 hotmetal + extensions//","-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//","-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//","-//spyglass//dtd html 2.0 extended//","-//sun microsystems corp.//dtd hotjava html//","-//sun microsystems corp.//dtd hotjava strict html//","-//w3c//dtd html 3 1995-03-24//","-//w3c//dtd html 3.2 draft//","-//w3c//dtd html 3.2 final//","-//w3c//dtd html 3.2//","-//w3c//dtd html 3.2s draft//","-//w3c//dtd html 4.0 frameset//","-//w3c//dtd html 4.0 transitional//","-//w3c//dtd html experimental 19960712//","-//w3c//dtd html experimental 970421//","-//w3c//dtd w3 html//","-//w3o//dtd w3 html 3.0//","-//webtechs//dtd mozilla html 2.0//","-//webtechs//dtd mozilla html//"],p8=[...ww,"-//w3c//dtd html 4.01 frameset//","-//w3c//dtd html 4.01 transitional//"],g8=new Set(["-//w3o//dtd w3 html strict 3.0//en//","-/w3c/dtd html 4.0 transitional/en","html"]),Tw=["-//w3c//dtd xhtml 1.0 frameset//","-//w3c//dtd xhtml 1.0 transitional//"],b8=[...Tw,"-//w3c//dtd html 4.01 frameset//","-//w3c//dtd html 4.01 transitional//"];function D0(t,e){return e.some(n=>t.startsWith(n))}function _8(t){return t.name===Ew&&t.publicId===null&&(t.systemId===null||t.systemId===f8)}function y8(t){if(t.name!==Ew)return ln.QUIRKS;const{systemId:e}=t;if(e&&e.toLowerCase()===m8)return ln.QUIRKS;let{publicId:n}=t;if(n!==null){if(n=n.toLowerCase(),g8.has(n))return ln.QUIRKS;let r=e===null?p8:ww;if(D0(n,r))return ln.QUIRKS;if(r=e===null?Tw:b8,D0(n,r))return ln.LIMITED_QUIRKS}return ln.NO_QUIRKS}const M0={TEXT_HTML:"text/html",APPLICATION_XML:"application/xhtml+xml"},E8="definitionurl",w8="definitionURL",T8=new Map(["attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(t=>[t.toLowerCase(),t])),S8=new Map([["xlink:actuate",{prefix:"xlink",name:"actuate",namespace:G.XLINK}],["xlink:arcrole",{prefix:"xlink",name:"arcrole",namespace:G.XLINK}],["xlink:href",{prefix:"xlink",name:"href",namespace:G.XLINK}],["xlink:role",{prefix:"xlink",name:"role",namespace:G.XLINK}],["xlink:show",{prefix:"xlink",name:"show",namespace:G.XLINK}],["xlink:title",{prefix:"xlink",name:"title",namespace:G.XLINK}],["xlink:type",{prefix:"xlink",name:"type",namespace:G.XLINK}],["xml:lang",{prefix:"xml",name:"lang",namespace:G.XML}],["xml:space",{prefix:"xml",name:"space",namespace:G.XML}],["xmlns",{prefix:"",name:"xmlns",namespace:G.XMLNS}],["xmlns:xlink",{prefix:"xmlns",name:"xlink",namespace:G.XMLNS}]]),A8=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(t=>[t.toLowerCase(),t])),C8=new Set([h.B,h.BIG,h.BLOCKQUOTE,h.BODY,h.BR,h.CENTER,h.CODE,h.DD,h.DIV,h.DL,h.DT,h.EM,h.EMBED,h.H1,h.H2,h.H3,h.H4,h.H5,h.H6,h.HEAD,h.HR,h.I,h.IMG,h.LI,h.LISTING,h.MENU,h.META,h.NOBR,h.OL,h.P,h.PRE,h.RUBY,h.S,h.SMALL,h.SPAN,h.STRONG,h.STRIKE,h.SUB,h.SUP,h.TABLE,h.TT,h.U,h.UL,h.VAR]);function O8(t){const e=t.tagID;return e===h.FONT&&t.attrs.some(({name:r})=>r===ps.COLOR||r===ps.SIZE||r===ps.FACE)||C8.has(e)}function Sw(t){for(let e=0;e<t.attrs.length;e++)if(t.attrs[e].name===E8){t.attrs[e].name=w8;break}}function Aw(t){for(let e=0;e<t.attrs.length;e++){const n=T8.get(t.attrs[e].name);n!=null&&(t.attrs[e].name=n)}}function Cm(t){for(let e=0;e<t.attrs.length;e++){const n=S8.get(t.attrs[e].name);n&&(t.attrs[e].prefix=n.prefix,t.attrs[e].name=n.name,t.attrs[e].namespace=n.namespace)}}function v8(t){const e=A8.get(t.tagName);e!=null&&(t.tagName=e,t.tagID=ll(t.tagName))}function I8(t,e){return e===G.MATHML&&(t===h.MI||t===h.MO||t===h.MN||t===h.MS||t===h.MTEXT)}function k8(t,e,n){if(e===G.MATHML&&t===h.ANNOTATION_XML){for(let r=0;r<n.length;r++)if(n[r].name===ps.ENCODING){const s=n[r].value.toLowerCase();return s===M0.TEXT_HTML||s===M0.APPLICATION_XML}}return e===G.SVG&&(t===h.FOREIGN_OBJECT||t===h.DESC||t===h.TITLE)}function N8(t,e,n,r){return(!r||r===G.HTML)&&k8(t,e,n)||(!r||r===G.MATHML)&&I8(t,e)}const R8="hidden",P8=8,x8=3;var C;(function(t){t[t.INITIAL=0]="INITIAL",t[t.BEFORE_HTML=1]="BEFORE_HTML",t[t.BEFORE_HEAD=2]="BEFORE_HEAD",t[t.IN_HEAD=3]="IN_HEAD",t[t.IN_HEAD_NO_SCRIPT=4]="IN_HEAD_NO_SCRIPT",t[t.AFTER_HEAD=5]="AFTER_HEAD",t[t.IN_BODY=6]="IN_BODY",t[t.TEXT=7]="TEXT",t[t.IN_TABLE=8]="IN_TABLE",t[t.IN_TABLE_TEXT=9]="IN_TABLE_TEXT",t[t.IN_CAPTION=10]="IN_CAPTION",t[t.IN_COLUMN_GROUP=11]="IN_COLUMN_GROUP",t[t.IN_TABLE_BODY=12]="IN_TABLE_BODY",t[t.IN_ROW=13]="IN_ROW",t[t.IN_CELL=14]="IN_CELL",t[t.IN_SELECT=15]="IN_SELECT",t[t.IN_SELECT_IN_TABLE=16]="IN_SELECT_IN_TABLE",t[t.IN_TEMPLATE=17]="IN_TEMPLATE",t[t.AFTER_BODY=18]="AFTER_BODY",t[t.IN_FRAMESET=19]="IN_FRAMESET",t[t.AFTER_FRAMESET=20]="AFTER_FRAMESET",t[t.AFTER_AFTER_BODY=21]="AFTER_AFTER_BODY",t[t.AFTER_AFTER_FRAMESET=22]="AFTER_AFTER_FRAMESET"})(C||(C={}));const L8={startLine:-1,startCol:-1,startOffset:-1,endLine:-1,endCol:-1,endOffset:-1},Cw=new Set([h.TABLE,h.TBODY,h.TFOOT,h.THEAD,h.TR]),B0={scriptingEnabled:!0,sourceCodeLocationInfo:!1,treeAdapter:wr,onParseError:null};let Ow=class{constructor(e,n,r=null,s=null){this.fragmentContext=r,this.scriptHandler=s,this.currentToken=null,this.stopped=!1,this.insertionMode=C.INITIAL,this.originalInsertionMode=C.INITIAL,this.headElement=null,this.formElement=null,this.currentNotInHTML=!1,this.tmplInsertionModeStack=[],this.pendingCharacterTokens=[],this.hasNonWhitespacePendingCharacterToken=!1,this.framesetOk=!0,this.skipNextNewLine=!1,this.fosterParentingEnabled=!1,this.options={...B0,...e},this.treeAdapter=this.options.treeAdapter,this.onParseError=this.options.onParseError,this.onParseError&&(this.options.sourceCodeLocationInfo=!0),this.document=n??this.treeAdapter.createDocument(),this.tokenizer=new s8(this.options,this),this.activeFormattingElements=new h8(this.treeAdapter),this.fragmentContextID=r?ll(this.treeAdapter.getTagName(r)):h.UNKNOWN,this._setContextModes(r??this.document,this.fragmentContextID),this.openElements=new d8(this.document,this.treeAdapter,this)}static parse(e,n){const r=new this(n);return r.tokenizer.write(e,!0),r.document}static getFragmentParser(e,n){const r={...B0,...n};e??(e=r.treeAdapter.createElement(R.TEMPLATE,G.HTML,[]));const s=r.treeAdapter.createElement("documentmock",G.HTML,[]),a=new this(r,s,e);return a.fragmentContextID===h.TEMPLATE&&a.tmplInsertionModeStack.unshift(C.IN_TEMPLATE),a._initTokenizerForFragmentParsing(),a._insertFakeRootElement(),a._resetInsertionMode(),a._findFormInFragmentContext(),a}getFragment(){const e=this.treeAdapter.getFirstChild(this.document),n=this.treeAdapter.createDocumentFragment();return this._adoptNodes(e,n),n}_err(e,n,r){var s;if(!this.onParseError)return;const a=(s=e.location)!==null&&s!==void 0?s:L8,i={code:n,startLine:a.startLine,startCol:a.startCol,startOffset:a.startOffset,endLine:r?a.startLine:a.endLine,endCol:r?a.startCol:a.endCol,endOffset:r?a.startOffset:a.endOffset};this.onParseError(i)}onItemPush(e,n,r){var s,a;(a=(s=this.treeAdapter).onItemPush)===null||a===void 0||a.call(s,e),r&&this.openElements.stackTop>0&&this._setContextModes(e,n)}onItemPop(e,n){var r,s;if(this.options.sourceCodeLocationInfo&&this._setEndLocation(e,this.currentToken),(s=(r=this.treeAdapter).onItemPop)===null||s===void 0||s.call(r,e,this.openElements.current),n){let a,i;this.openElements.stackTop===0&&this.fragmentContext?(a=this.fragmentContext,i=this.fragmentContextID):{current:a,currentTagId:i}=this.openElements,this._setContextModes(a,i)}}_setContextModes(e,n){const r=e===this.document||this.treeAdapter.getNamespaceURI(e)===G.HTML;this.currentNotInHTML=!r,this.tokenizer.inForeignNode=!r&&!this._isIntegrationPoint(n,e)}_switchToTextParsing(e,n){this._insertElement(e,G.HTML),this.tokenizer.state=n,this.originalInsertionMode=this.insertionMode,this.insertionMode=C.TEXT}switchToPlaintextParsing(){this.insertionMode=C.TEXT,this.originalInsertionMode=C.IN_BODY,this.tokenizer.state=Xt.PLAINTEXT}_getAdjustedCurrentElement(){return this.openElements.stackTop===0&&this.fragmentContext?this.fragmentContext:this.openElements.current}_findFormInFragmentContext(){let e=this.fragmentContext;for(;e;){if(this.treeAdapter.getTagName(e)===R.FORM){this.formElement=e;break}e=this.treeAdapter.getParentNode(e)}}_initTokenizerForFragmentParsing(){if(!(!this.fragmentContext||this.treeAdapter.getNamespaceURI(this.fragmentContext)!==G.HTML))switch(this.fragmentContextID){case h.TITLE:case h.TEXTAREA:{this.tokenizer.state=Xt.RCDATA;break}case h.STYLE:case h.XMP:case h.IFRAME:case h.NOEMBED:case h.NOFRAMES:case h.NOSCRIPT:{this.tokenizer.state=Xt.RAWTEXT;break}case h.SCRIPT:{this.tokenizer.state=Xt.SCRIPT_DATA;break}case h.PLAINTEXT:{this.tokenizer.state=Xt.PLAINTEXT;break}}}_setDocumentType(e){const n=e.name||"",r=e.publicId||"",s=e.systemId||"";if(this.treeAdapter.setDocumentType(this.document,n,r,s),e.location){const i=this.treeAdapter.getChildNodes(this.document).find(o=>this.treeAdapter.isDocumentTypeNode(o));i&&this.treeAdapter.setNodeSourceCodeLocation(i,e.location)}}_attachElementToTree(e,n){if(this.options.sourceCodeLocationInfo){const r=n&&{...n,startTag:n};this.treeAdapter.setNodeSourceCodeLocation(e,r)}if(this._shouldFosterParentOnInsertion())this._fosterParentElement(e);else{const r=this.openElements.currentTmplContentOrNode;this.treeAdapter.appendChild(r,e)}}_appendElement(e,n){const r=this.treeAdapter.createElement(e.tagName,n,e.attrs);this._attachElementToTree(r,e.location)}_insertElement(e,n){const r=this.treeAdapter.createElement(e.tagName,n,e.attrs);this._attachElementToTree(r,e.location),this.openElements.push(r,e.tagID)}_insertFakeElement(e,n){const r=this.treeAdapter.createElement(e,G.HTML,[]);this._attachElementToTree(r,null),this.openElements.push(r,n)}_insertTemplate(e){const n=this.treeAdapter.createElement(e.tagName,G.HTML,e.attrs),r=this.treeAdapter.createDocumentFragment();this.treeAdapter.setTemplateContent(n,r),this._attachElementToTree(n,e.location),this.openElements.push(n,e.tagID),this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(r,null)}_insertFakeRootElement(){const e=this.treeAdapter.createElement(R.HTML,G.HTML,[]);this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(e,null),this.treeAdapter.appendChild(this.openElements.current,e),this.openElements.push(e,h.HTML)}_appendCommentNode(e,n){const r=this.treeAdapter.createCommentNode(e.data);this.treeAdapter.appendChild(n,r),this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(r,e.location)}_insertCharacters(e){let n,r;if(this._shouldFosterParentOnInsertion()?({parent:n,beforeElement:r}=this._findFosterParentingLocation(),r?this.treeAdapter.insertTextBefore(n,e.chars,r):this.treeAdapter.insertText(n,e.chars)):(n=this.openElements.currentTmplContentOrNode,this.treeAdapter.insertText(n,e.chars)),!e.location)return;const s=this.treeAdapter.getChildNodes(n),a=r?s.lastIndexOf(r):s.length,i=s[a-1];if(this.treeAdapter.getNodeSourceCodeLocation(i)){const{endLine:u,endCol:c,endOffset:l}=e.location;this.treeAdapter.updateNodeSourceCodeLocation(i,{endLine:u,endCol:c,endOffset:l})}else this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(i,e.location)}_adoptNodes(e,n){for(let r=this.treeAdapter.getFirstChild(e);r;r=this.treeAdapter.getFirstChild(e))this.treeAdapter.detachNode(r),this.treeAdapter.appendChild(n,r)}_setEndLocation(e,n){if(this.treeAdapter.getNodeSourceCodeLocation(e)&&n.location){const r=n.location,s=this.treeAdapter.getTagName(e),a=n.type===Fe.END_TAG&&s===n.tagName?{endTag:{...r},endLine:r.endLine,endCol:r.endCol,endOffset:r.endOffset}:{endLine:r.startLine,endCol:r.startCol,endOffset:r.startOffset};this.treeAdapter.updateNodeSourceCodeLocation(e,a)}}shouldProcessStartTagTokenInForeignContent(e){if(!this.currentNotInHTML)return!1;let n,r;return this.openElements.stackTop===0&&this.fragmentContext?(n=this.fragmentContext,r=this.fragmentContextID):{current:n,currentTagId:r}=this.openElements,e.tagID===h.SVG&&this.treeAdapter.getTagName(n)===R.ANNOTATION_XML&&this.treeAdapter.getNamespaceURI(n)===G.MATHML?!1:this.tokenizer.inForeignNode||(e.tagID===h.MGLYPH||e.tagID===h.MALIGNMARK)&&!this._isIntegrationPoint(r,n,G.HTML)}_processToken(e){switch(e.type){case Fe.CHARACTER:{this.onCharacter(e);break}case Fe.NULL_CHARACTER:{this.onNullCharacter(e);break}case Fe.COMMENT:{this.onComment(e);break}case Fe.DOCTYPE:{this.onDoctype(e);break}case Fe.START_TAG:{this._processStartTag(e);break}case Fe.END_TAG:{this.onEndTag(e);break}case Fe.EOF:{this.onEof(e);break}case Fe.WHITESPACE_CHARACTER:{this.onWhitespaceCharacter(e);break}}}_isIntegrationPoint(e,n,r){const s=this.treeAdapter.getNamespaceURI(n),a=this.treeAdapter.getAttrList(n);return N8(e,s,a,r)}_reconstructActiveFormattingElements(){const e=this.activeFormattingElements.entries.length;if(e){const n=this.activeFormattingElements.entries.findIndex(s=>s.type===sr.Marker||this.openElements.contains(s.element)),r=n<0?e-1:n-1;for(let s=r;s>=0;s--){const a=this.activeFormattingElements.entries[s];this._insertElement(a.token,this.treeAdapter.getNamespaceURI(a.element)),a.element=this.openElements.current}}}_closeTableCell(){this.openElements.generateImpliedEndTags(),this.openElements.popUntilTableCellPopped(),this.activeFormattingElements.clearToLastMarker(),this.insertionMode=C.IN_ROW}_closePElement(){this.openElements.generateImpliedEndTagsWithExclusion(h.P),this.openElements.popUntilTagNamePopped(h.P)}_resetInsertionMode(){for(let e=this.openElements.stackTop;e>=0;e--)switch(e===0&&this.fragmentContext?this.fragmentContextID:this.openElements.tagIDs[e]){case h.TR:{this.insertionMode=C.IN_ROW;return}case h.TBODY:case h.THEAD:case h.TFOOT:{this.insertionMode=C.IN_TABLE_BODY;return}case h.CAPTION:{this.insertionMode=C.IN_CAPTION;return}case h.COLGROUP:{this.insertionMode=C.IN_COLUMN_GROUP;return}case h.TABLE:{this.insertionMode=C.IN_TABLE;return}case h.BODY:{this.insertionMode=C.IN_BODY;return}case h.FRAMESET:{this.insertionMode=C.IN_FRAMESET;return}case h.SELECT:{this._resetInsertionModeForSelect(e);return}case h.TEMPLATE:{this.insertionMode=this.tmplInsertionModeStack[0];return}case h.HTML:{this.insertionMode=this.headElement?C.AFTER_HEAD:C.BEFORE_HEAD;return}case h.TD:case h.TH:{if(e>0){this.insertionMode=C.IN_CELL;return}break}case h.HEAD:{if(e>0){this.insertionMode=C.IN_HEAD;return}break}}this.insertionMode=C.IN_BODY}_resetInsertionModeForSelect(e){if(e>0)for(let n=e-1;n>0;n--){const r=this.openElements.tagIDs[n];if(r===h.TEMPLATE)break;if(r===h.TABLE){this.insertionMode=C.IN_SELECT_IN_TABLE;return}}this.insertionMode=C.IN_SELECT}_isElementCausesFosterParenting(e){return Cw.has(e)}_shouldFosterParentOnInsertion(){return this.fosterParentingEnabled&&this._isElementCausesFosterParenting(this.openElements.currentTagId)}_findFosterParentingLocation(){for(let e=this.openElements.stackTop;e>=0;e--){const n=this.openElements.items[e];switch(this.openElements.tagIDs[e]){case h.TEMPLATE:{if(this.treeAdapter.getNamespaceURI(n)===G.HTML)return{parent:this.treeAdapter.getTemplateContent(n),beforeElement:null};break}case h.TABLE:{const r=this.treeAdapter.getParentNode(n);return r?{parent:r,beforeElement:n}:{parent:this.openElements.items[e-1],beforeElement:null}}}}return{parent:this.openElements.items[0],beforeElement:null}}_fosterParentElement(e){const n=this._findFosterParentingLocation();n.beforeElement?this.treeAdapter.insertBefore(n.parent,e,n.beforeElement):this.treeAdapter.appendChild(n.parent,e)}_isSpecialElement(e,n){const r=this.treeAdapter.getNamespaceURI(e);return XM[r].has(n)}onCharacter(e){if(this.skipNextNewLine=!1,this.tokenizer.inForeignNode){lB(this,e);return}switch(this.insertionMode){case C.INITIAL:{Ga(this,e);break}case C.BEFORE_HTML:{bi(this,e);break}case C.BEFORE_HEAD:{_i(this,e);break}case C.IN_HEAD:{yi(this,e);break}case C.IN_HEAD_NO_SCRIPT:{Ei(this,e);break}case C.AFTER_HEAD:{wi(this,e);break}case C.IN_BODY:case C.IN_CAPTION:case C.IN_CELL:case C.IN_TEMPLATE:{Iw(this,e);break}case C.TEXT:case C.IN_SELECT:case C.IN_SELECT_IN_TABLE:{this._insertCharacters(e);break}case C.IN_TABLE:case C.IN_TABLE_BODY:case C.IN_ROW:{Id(this,e);break}case C.IN_TABLE_TEXT:{Lw(this,e);break}case C.IN_COLUMN_GROUP:{mc(this,e);break}case C.AFTER_BODY:{pc(this,e);break}case C.AFTER_AFTER_BODY:{vu(this,e);break}}}onNullCharacter(e){if(this.skipNextNewLine=!1,this.tokenizer.inForeignNode){cB(this,e);return}switch(this.insertionMode){case C.INITIAL:{Ga(this,e);break}case C.BEFORE_HTML:{bi(this,e);break}case C.BEFORE_HEAD:{_i(this,e);break}case C.IN_HEAD:{yi(this,e);break}case C.IN_HEAD_NO_SCRIPT:{Ei(this,e);break}case C.AFTER_HEAD:{wi(this,e);break}case C.TEXT:{this._insertCharacters(e);break}case C.IN_TABLE:case C.IN_TABLE_BODY:case C.IN_ROW:{Id(this,e);break}case C.IN_COLUMN_GROUP:{mc(this,e);break}case C.AFTER_BODY:{pc(this,e);break}case C.AFTER_AFTER_BODY:{vu(this,e);break}}}onComment(e){if(this.skipNextNewLine=!1,this.currentNotInHTML){zh(this,e);return}switch(this.insertionMode){case C.INITIAL:case C.BEFORE_HTML:case C.BEFORE_HEAD:case C.IN_HEAD:case C.IN_HEAD_NO_SCRIPT:case C.AFTER_HEAD:case C.IN_BODY:case C.IN_TABLE:case C.IN_CAPTION:case C.IN_COLUMN_GROUP:case C.IN_TABLE_BODY:case C.IN_ROW:case C.IN_CELL:case C.IN_SELECT:case C.IN_SELECT_IN_TABLE:case C.IN_TEMPLATE:case C.IN_FRAMESET:case C.AFTER_FRAMESET:{zh(this,e);break}case C.IN_TABLE_TEXT:{Ka(this,e);break}case C.AFTER_BODY:{H8(this,e);break}case C.AFTER_AFTER_BODY:case C.AFTER_AFTER_FRAMESET:{$8(this,e);break}}}onDoctype(e){switch(this.skipNextNewLine=!1,this.insertionMode){case C.INITIAL:{q8(this,e);break}case C.BEFORE_HEAD:case C.IN_HEAD:case C.IN_HEAD_NO_SCRIPT:case C.AFTER_HEAD:{this._err(e,U.misplacedDoctype);break}case C.IN_TABLE_TEXT:{Ka(this,e);break}}}onStartTag(e){this.skipNextNewLine=!1,this.currentToken=e,this._processStartTag(e),e.selfClosing&&!e.ackSelfClosing&&this._err(e,U.nonVoidHtmlElementStartTagWithTrailingSolidus)}_processStartTag(e){this.shouldProcessStartTagTokenInForeignContent(e)?dB(this,e):this._startTagOutsideForeignContent(e)}_startTagOutsideForeignContent(e){switch(this.insertionMode){case C.INITIAL:{Ga(this,e);break}case C.BEFORE_HTML:{V8(this,e);break}case C.BEFORE_HEAD:{W8(this,e);break}case C.IN_HEAD:{Zn(this,e);break}case C.IN_HEAD_NO_SCRIPT:{Y8(this,e);break}case C.AFTER_HEAD:{J8(this,e);break}case C.IN_BODY:{Bt(this,e);break}case C.IN_TABLE:{ma(this,e);break}case C.IN_TABLE_TEXT:{Ka(this,e);break}case C.IN_CAPTION:{G5(this,e);break}case C.IN_COLUMN_GROUP:{Im(this,e);break}case C.IN_TABLE_BODY:{fl(this,e);break}case C.IN_ROW:{ml(this,e);break}case C.IN_CELL:{Z5(this,e);break}case C.IN_SELECT:{Bw(this,e);break}case C.IN_SELECT_IN_TABLE:{X5(this,e);break}case C.IN_TEMPLATE:{eB(this,e);break}case C.AFTER_BODY:{nB(this,e);break}case C.IN_FRAMESET:{rB(this,e);break}case C.AFTER_FRAMESET:{aB(this,e);break}case C.AFTER_AFTER_BODY:{oB(this,e);break}case C.AFTER_AFTER_FRAMESET:{uB(this,e);break}}}onEndTag(e){this.skipNextNewLine=!1,this.currentToken=e,this.currentNotInHTML?hB(this,e):this._endTagOutsideForeignContent(e)}_endTagOutsideForeignContent(e){switch(this.insertionMode){case C.INITIAL:{Ga(this,e);break}case C.BEFORE_HTML:{z8(this,e);break}case C.BEFORE_HEAD:{G8(this,e);break}case C.IN_HEAD:{K8(this,e);break}case C.IN_HEAD_NO_SCRIPT:{Z8(this,e);break}case C.AFTER_HEAD:{X8(this,e);break}case C.IN_BODY:{hl(this,e);break}case C.TEXT:{B5(this,e);break}case C.IN_TABLE:{Ji(this,e);break}case C.IN_TABLE_TEXT:{Ka(this,e);break}case C.IN_CAPTION:{K5(this,e);break}case C.IN_COLUMN_GROUP:{Y5(this,e);break}case C.IN_TABLE_BODY:{Wh(this,e);break}case C.IN_ROW:{Mw(this,e);break}case C.IN_CELL:{J5(this,e);break}case C.IN_SELECT:{Fw(this,e);break}case C.IN_SELECT_IN_TABLE:{Q5(this,e);break}case C.IN_TEMPLATE:{tB(this,e);break}case C.AFTER_BODY:{jw(this,e);break}case C.IN_FRAMESET:{sB(this,e);break}case C.AFTER_FRAMESET:{iB(this,e);break}case C.AFTER_AFTER_BODY:{vu(this,e);break}}}onEof(e){switch(this.insertionMode){case C.INITIAL:{Ga(this,e);break}case C.BEFORE_HTML:{bi(this,e);break}case C.BEFORE_HEAD:{_i(this,e);break}case C.IN_HEAD:{yi(this,e);break}case C.IN_HEAD_NO_SCRIPT:{Ei(this,e);break}case C.AFTER_HEAD:{wi(this,e);break}case C.IN_BODY:case C.IN_TABLE:case C.IN_CAPTION:case C.IN_COLUMN_GROUP:case C.IN_TABLE_BODY:case C.IN_ROW:case C.IN_CELL:case C.IN_SELECT:case C.IN_SELECT_IN_TABLE:{Pw(this,e);break}case C.TEXT:{F5(this,e);break}case C.IN_TABLE_TEXT:{Ka(this,e);break}case C.IN_TEMPLATE:{Uw(this,e);break}case C.AFTER_BODY:case C.IN_FRAMESET:case C.AFTER_FRAMESET:case C.AFTER_AFTER_BODY:case C.AFTER_AFTER_FRAMESET:{vm(this,e);break}}}onWhitespaceCharacter(e){if(this.skipNextNewLine&&(this.skipNextNewLine=!1,e.chars.charCodeAt(0)===E.LINE_FEED)){if(e.chars.length===1)return;e.chars=e.chars.substr(1)}if(this.tokenizer.inForeignNode){this._insertCharacters(e);return}switch(this.insertionMode){case C.IN_HEAD:case C.IN_HEAD_NO_SCRIPT:case C.AFTER_HEAD:case C.TEXT:case C.IN_COLUMN_GROUP:case C.IN_SELECT:case C.IN_SELECT_IN_TABLE:case C.IN_FRAMESET:case C.AFTER_FRAMESET:{this._insertCharacters(e);break}case C.IN_BODY:case C.IN_CAPTION:case C.IN_CELL:case C.IN_TEMPLATE:case C.AFTER_BODY:case C.AFTER_AFTER_BODY:case C.AFTER_AFTER_FRAMESET:{vw(this,e);break}case C.IN_TABLE:case C.IN_TABLE_BODY:case C.IN_ROW:{Id(this,e);break}case C.IN_TABLE_TEXT:{xw(this,e);break}}}};function D8(t,e){let n=t.activeFormattingElements.getElementEntryInScopeWithTagName(e.tagName);return n?t.openElements.contains(n.element)?t.openElements.hasInScope(e.tagID)||(n=null):(t.activeFormattingElements.removeEntry(n),n=null):Rw(t,e),n}function M8(t,e){let n=null,r=t.openElements.stackTop;for(;r>=0;r--){const s=t.openElements.items[r];if(s===e.element)break;t._isSpecialElement(s,t.openElements.tagIDs[r])&&(n=s)}return n||(t.openElements.shortenToLength(r<0?0:r),t.activeFormattingElements.removeEntry(e)),n}function B8(t,e,n){let r=e,s=t.openElements.getCommonAncestor(e);for(let a=0,i=s;i!==n;a++,i=s){s=t.openElements.getCommonAncestor(i);const o=t.activeFormattingElements.getElementEntry(i),u=o&&a>=x8;!o||u?(u&&t.activeFormattingElements.removeEntry(o),t.openElements.remove(i)):(i=F8(t,o),r===e&&(t.activeFormattingElements.bookmark=o),t.treeAdapter.detachNode(r),t.treeAdapter.appendChild(i,r),r=i)}return r}function F8(t,e){const n=t.treeAdapter.getNamespaceURI(e.element),r=t.treeAdapter.createElement(e.token.tagName,n,e.token.attrs);return t.openElements.replace(e.element,r),e.element=r,r}function U8(t,e,n){const r=t.treeAdapter.getTagName(e),s=ll(r);if(t._isElementCausesFosterParenting(s))t._fosterParentElement(n);else{const a=t.treeAdapter.getNamespaceURI(e);s===h.TEMPLATE&&a===G.HTML&&(e=t.treeAdapter.getTemplateContent(e)),t.treeAdapter.appendChild(e,n)}}function j8(t,e,n){const r=t.treeAdapter.getNamespaceURI(n.element),{token:s}=n,a=t.treeAdapter.createElement(s.tagName,r,s.attrs);t._adoptNodes(e,a),t.treeAdapter.appendChild(e,a),t.activeFormattingElements.insertElementAfterBookmark(a,s),t.activeFormattingElements.removeEntry(n),t.openElements.remove(n.element),t.openElements.insertAfter(e,a,s.tagID)}function Om(t,e){for(let n=0;n<P8;n++){const r=D8(t,e);if(!r)break;const s=M8(t,r);if(!s)break;t.activeFormattingElements.bookmark=r;const a=B8(t,s,r.element),i=t.openElements.getCommonAncestor(r.element);t.treeAdapter.detachNode(a),i&&U8(t,i,a),j8(t,s,r)}}function zh(t,e){t._appendCommentNode(e,t.openElements.currentTmplContentOrNode)}function H8(t,e){t._appendCommentNode(e,t.openElements.items[0])}function $8(t,e){t._appendCommentNode(e,t.document)}function vm(t,e){if(t.stopped=!0,e.location){const n=t.fragmentContext?0:2;for(let r=t.openElements.stackTop;r>=n;r--)t._setEndLocation(t.openElements.items[r],e);if(!t.fragmentContext&&t.openElements.stackTop>=0){const r=t.openElements.items[0],s=t.treeAdapter.getNodeSourceCodeLocation(r);if(s&&!s.endTag&&(t._setEndLocation(r,e),t.openElements.stackTop>=1)){const a=t.openElements.items[1],i=t.treeAdapter.getNodeSourceCodeLocation(a);i&&!i.endTag&&t._setEndLocation(a,e)}}}}function q8(t,e){t._setDocumentType(e);const n=e.forceQuirks?ln.QUIRKS:y8(e);_8(e)||t._err(e,U.nonConformingDoctype),t.treeAdapter.setDocumentMode(t.document,n),t.insertionMode=C.BEFORE_HTML}function Ga(t,e){t._err(e,U.missingDoctype,!0),t.treeAdapter.setDocumentMode(t.document,ln.QUIRKS),t.insertionMode=C.BEFORE_HTML,t._processToken(e)}function V8(t,e){e.tagID===h.HTML?(t._insertElement(e,G.HTML),t.insertionMode=C.BEFORE_HEAD):bi(t,e)}function z8(t,e){const n=e.tagID;(n===h.HTML||n===h.HEAD||n===h.BODY||n===h.BR)&&bi(t,e)}function bi(t,e){t._insertFakeRootElement(),t.insertionMode=C.BEFORE_HEAD,t._processToken(e)}function W8(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.HEAD:{t._insertElement(e,G.HTML),t.headElement=t.openElements.current,t.insertionMode=C.IN_HEAD;break}default:_i(t,e)}}function G8(t,e){const n=e.tagID;n===h.HEAD||n===h.BODY||n===h.HTML||n===h.BR?_i(t,e):t._err(e,U.endTagWithoutMatchingOpenElement)}function _i(t,e){t._insertFakeElement(R.HEAD,h.HEAD),t.headElement=t.openElements.current,t.insertionMode=C.IN_HEAD,t._processToken(e)}function Zn(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.BASE:case h.BASEFONT:case h.BGSOUND:case h.LINK:case h.META:{t._appendElement(e,G.HTML),e.ackSelfClosing=!0;break}case h.TITLE:{t._switchToTextParsing(e,Xt.RCDATA);break}case h.NOSCRIPT:{t.options.scriptingEnabled?t._switchToTextParsing(e,Xt.RAWTEXT):(t._insertElement(e,G.HTML),t.insertionMode=C.IN_HEAD_NO_SCRIPT);break}case h.NOFRAMES:case h.STYLE:{t._switchToTextParsing(e,Xt.RAWTEXT);break}case h.SCRIPT:{t._switchToTextParsing(e,Xt.SCRIPT_DATA);break}case h.TEMPLATE:{t._insertTemplate(e),t.activeFormattingElements.insertMarker(),t.framesetOk=!1,t.insertionMode=C.IN_TEMPLATE,t.tmplInsertionModeStack.unshift(C.IN_TEMPLATE);break}case h.HEAD:{t._err(e,U.misplacedStartTagForHeadElement);break}default:yi(t,e)}}function K8(t,e){switch(e.tagID){case h.HEAD:{t.openElements.pop(),t.insertionMode=C.AFTER_HEAD;break}case h.BODY:case h.BR:case h.HTML:{yi(t,e);break}case h.TEMPLATE:{Ns(t,e);break}default:t._err(e,U.endTagWithoutMatchingOpenElement)}}function Ns(t,e){t.openElements.tmplCount>0?(t.openElements.generateImpliedEndTagsThoroughly(),t.openElements.currentTagId!==h.TEMPLATE&&t._err(e,U.closingOfElementWithOpenChildElements),t.openElements.popUntilTagNamePopped(h.TEMPLATE),t.activeFormattingElements.clearToLastMarker(),t.tmplInsertionModeStack.shift(),t._resetInsertionMode()):t._err(e,U.endTagWithoutMatchingOpenElement)}function yi(t,e){t.openElements.pop(),t.insertionMode=C.AFTER_HEAD,t._processToken(e)}function Y8(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.BASEFONT:case h.BGSOUND:case h.HEAD:case h.LINK:case h.META:case h.NOFRAMES:case h.STYLE:{Zn(t,e);break}case h.NOSCRIPT:{t._err(e,U.nestedNoscriptInHead);break}default:Ei(t,e)}}function Z8(t,e){switch(e.tagID){case h.NOSCRIPT:{t.openElements.pop(),t.insertionMode=C.IN_HEAD;break}case h.BR:{Ei(t,e);break}default:t._err(e,U.endTagWithoutMatchingOpenElement)}}function Ei(t,e){const n=e.type===Fe.EOF?U.openElementsLeftAfterEof:U.disallowedContentInNoscriptInHead;t._err(e,n),t.openElements.pop(),t.insertionMode=C.IN_HEAD,t._processToken(e)}function J8(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.BODY:{t._insertElement(e,G.HTML),t.framesetOk=!1,t.insertionMode=C.IN_BODY;break}case h.FRAMESET:{t._insertElement(e,G.HTML),t.insertionMode=C.IN_FRAMESET;break}case h.BASE:case h.BASEFONT:case h.BGSOUND:case h.LINK:case h.META:case h.NOFRAMES:case h.SCRIPT:case h.STYLE:case h.TEMPLATE:case h.TITLE:{t._err(e,U.abandonedHeadElementChild),t.openElements.push(t.headElement,h.HEAD),Zn(t,e),t.openElements.remove(t.headElement);break}case h.HEAD:{t._err(e,U.misplacedStartTagForHeadElement);break}default:wi(t,e)}}function X8(t,e){switch(e.tagID){case h.BODY:case h.HTML:case h.BR:{wi(t,e);break}case h.TEMPLATE:{Ns(t,e);break}default:t._err(e,U.endTagWithoutMatchingOpenElement)}}function wi(t,e){t._insertFakeElement(R.BODY,h.BODY),t.insertionMode=C.IN_BODY,dl(t,e)}function dl(t,e){switch(e.type){case Fe.CHARACTER:{Iw(t,e);break}case Fe.WHITESPACE_CHARACTER:{vw(t,e);break}case Fe.COMMENT:{zh(t,e);break}case Fe.START_TAG:{Bt(t,e);break}case Fe.END_TAG:{hl(t,e);break}case Fe.EOF:{Pw(t,e);break}}}function vw(t,e){t._reconstructActiveFormattingElements(),t._insertCharacters(e)}function Iw(t,e){t._reconstructActiveFormattingElements(),t._insertCharacters(e),t.framesetOk=!1}function Q8(t,e){t.openElements.tmplCount===0&&t.treeAdapter.adoptAttributes(t.openElements.items[0],e.attrs)}function e5(t,e){const n=t.openElements.tryPeekProperlyNestedBodyElement();n&&t.openElements.tmplCount===0&&(t.framesetOk=!1,t.treeAdapter.adoptAttributes(n,e.attrs))}function t5(t,e){const n=t.openElements.tryPeekProperlyNestedBodyElement();t.framesetOk&&n&&(t.treeAdapter.detachNode(n),t.openElements.popAllUpToHtmlElement(),t._insertElement(e,G.HTML),t.insertionMode=C.IN_FRAMESET)}function n5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,G.HTML)}function r5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),Vh.has(t.openElements.currentTagId)&&t.openElements.pop(),t._insertElement(e,G.HTML)}function s5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,G.HTML),t.skipNextNewLine=!0,t.framesetOk=!1}function a5(t,e){const n=t.openElements.tmplCount>0;(!t.formElement||n)&&(t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,G.HTML),n||(t.formElement=t.openElements.current))}function i5(t,e){t.framesetOk=!1;const n=e.tagID;for(let r=t.openElements.stackTop;r>=0;r--){const s=t.openElements.tagIDs[r];if(n===h.LI&&s===h.LI||(n===h.DD||n===h.DT)&&(s===h.DD||s===h.DT)){t.openElements.generateImpliedEndTagsWithExclusion(s),t.openElements.popUntilTagNamePopped(s);break}if(s!==h.ADDRESS&&s!==h.DIV&&s!==h.P&&t._isSpecialElement(t.openElements.items[r],s))break}t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,G.HTML)}function o5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,G.HTML),t.tokenizer.state=Xt.PLAINTEXT}function u5(t,e){t.openElements.hasInScope(h.BUTTON)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(h.BUTTON)),t._reconstructActiveFormattingElements(),t._insertElement(e,G.HTML),t.framesetOk=!1}function c5(t,e){const n=t.activeFormattingElements.getElementEntryInScopeWithTagName(R.A);n&&(Om(t,e),t.openElements.remove(n.element),t.activeFormattingElements.removeEntry(n)),t._reconstructActiveFormattingElements(),t._insertElement(e,G.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function l5(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,G.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function d5(t,e){t._reconstructActiveFormattingElements(),t.openElements.hasInScope(h.NOBR)&&(Om(t,e),t._reconstructActiveFormattingElements()),t._insertElement(e,G.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function h5(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,G.HTML),t.activeFormattingElements.insertMarker(),t.framesetOk=!1}function f5(t,e){t.treeAdapter.getDocumentMode(t.document)!==ln.QUIRKS&&t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,G.HTML),t.framesetOk=!1,t.insertionMode=C.IN_TABLE}function kw(t,e){t._reconstructActiveFormattingElements(),t._appendElement(e,G.HTML),t.framesetOk=!1,e.ackSelfClosing=!0}function Nw(t){const e=bw(t,ps.TYPE);return e!=null&&e.toLowerCase()===R8}function m5(t,e){t._reconstructActiveFormattingElements(),t._appendElement(e,G.HTML),Nw(e)||(t.framesetOk=!1),e.ackSelfClosing=!0}function p5(t,e){t._appendElement(e,G.HTML),e.ackSelfClosing=!0}function g5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._appendElement(e,G.HTML),t.framesetOk=!1,e.ackSelfClosing=!0}function b5(t,e){e.tagName=R.IMG,e.tagID=h.IMG,kw(t,e)}function _5(t,e){t._insertElement(e,G.HTML),t.skipNextNewLine=!0,t.tokenizer.state=Xt.RCDATA,t.originalInsertionMode=t.insertionMode,t.framesetOk=!1,t.insertionMode=C.TEXT}function y5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._reconstructActiveFormattingElements(),t.framesetOk=!1,t._switchToTextParsing(e,Xt.RAWTEXT)}function E5(t,e){t.framesetOk=!1,t._switchToTextParsing(e,Xt.RAWTEXT)}function F0(t,e){t._switchToTextParsing(e,Xt.RAWTEXT)}function w5(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,G.HTML),t.framesetOk=!1,t.insertionMode=t.insertionMode===C.IN_TABLE||t.insertionMode===C.IN_CAPTION||t.insertionMode===C.IN_TABLE_BODY||t.insertionMode===C.IN_ROW||t.insertionMode===C.IN_CELL?C.IN_SELECT_IN_TABLE:C.IN_SELECT}function T5(t,e){t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t._reconstructActiveFormattingElements(),t._insertElement(e,G.HTML)}function S5(t,e){t.openElements.hasInScope(h.RUBY)&&t.openElements.generateImpliedEndTags(),t._insertElement(e,G.HTML)}function A5(t,e){t.openElements.hasInScope(h.RUBY)&&t.openElements.generateImpliedEndTagsWithExclusion(h.RTC),t._insertElement(e,G.HTML)}function C5(t,e){t._reconstructActiveFormattingElements(),Sw(e),Cm(e),e.selfClosing?t._appendElement(e,G.MATHML):t._insertElement(e,G.MATHML),e.ackSelfClosing=!0}function O5(t,e){t._reconstructActiveFormattingElements(),Aw(e),Cm(e),e.selfClosing?t._appendElement(e,G.SVG):t._insertElement(e,G.SVG),e.ackSelfClosing=!0}function U0(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,G.HTML)}function Bt(t,e){switch(e.tagID){case h.I:case h.S:case h.B:case h.U:case h.EM:case h.TT:case h.BIG:case h.CODE:case h.FONT:case h.SMALL:case h.STRIKE:case h.STRONG:{l5(t,e);break}case h.A:{c5(t,e);break}case h.H1:case h.H2:case h.H3:case h.H4:case h.H5:case h.H6:{r5(t,e);break}case h.P:case h.DL:case h.OL:case h.UL:case h.DIV:case h.DIR:case h.NAV:case h.MAIN:case h.MENU:case h.ASIDE:case h.CENTER:case h.FIGURE:case h.FOOTER:case h.HEADER:case h.HGROUP:case h.DIALOG:case h.DETAILS:case h.ADDRESS:case h.ARTICLE:case h.SEARCH:case h.SECTION:case h.SUMMARY:case h.FIELDSET:case h.BLOCKQUOTE:case h.FIGCAPTION:{n5(t,e);break}case h.LI:case h.DD:case h.DT:{i5(t,e);break}case h.BR:case h.IMG:case h.WBR:case h.AREA:case h.EMBED:case h.KEYGEN:{kw(t,e);break}case h.HR:{g5(t,e);break}case h.RB:case h.RTC:{S5(t,e);break}case h.RT:case h.RP:{A5(t,e);break}case h.PRE:case h.LISTING:{s5(t,e);break}case h.XMP:{y5(t,e);break}case h.SVG:{O5(t,e);break}case h.HTML:{Q8(t,e);break}case h.BASE:case h.LINK:case h.META:case h.STYLE:case h.TITLE:case h.SCRIPT:case h.BGSOUND:case h.BASEFONT:case h.TEMPLATE:{Zn(t,e);break}case h.BODY:{e5(t,e);break}case h.FORM:{a5(t,e);break}case h.NOBR:{d5(t,e);break}case h.MATH:{C5(t,e);break}case h.TABLE:{f5(t,e);break}case h.INPUT:{m5(t,e);break}case h.PARAM:case h.TRACK:case h.SOURCE:{p5(t,e);break}case h.IMAGE:{b5(t,e);break}case h.BUTTON:{u5(t,e);break}case h.APPLET:case h.OBJECT:case h.MARQUEE:{h5(t,e);break}case h.IFRAME:{E5(t,e);break}case h.SELECT:{w5(t,e);break}case h.OPTION:case h.OPTGROUP:{T5(t,e);break}case h.NOEMBED:case h.NOFRAMES:{F0(t,e);break}case h.FRAMESET:{t5(t,e);break}case h.TEXTAREA:{_5(t,e);break}case h.NOSCRIPT:{t.options.scriptingEnabled?F0(t,e):U0(t,e);break}case h.PLAINTEXT:{o5(t,e);break}case h.COL:case h.TH:case h.TD:case h.TR:case h.HEAD:case h.FRAME:case h.TBODY:case h.TFOOT:case h.THEAD:case h.CAPTION:case h.COLGROUP:break;default:U0(t,e)}}function v5(t,e){if(t.openElements.hasInScope(h.BODY)&&(t.insertionMode=C.AFTER_BODY,t.options.sourceCodeLocationInfo)){const n=t.openElements.tryPeekProperlyNestedBodyElement();n&&t._setEndLocation(n,e)}}function I5(t,e){t.openElements.hasInScope(h.BODY)&&(t.insertionMode=C.AFTER_BODY,jw(t,e))}function k5(t,e){const n=e.tagID;t.openElements.hasInScope(n)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(n))}function N5(t){const e=t.openElements.tmplCount>0,{formElement:n}=t;e||(t.formElement=null),(n||e)&&t.openElements.hasInScope(h.FORM)&&(t.openElements.generateImpliedEndTags(),e?t.openElements.popUntilTagNamePopped(h.FORM):n&&t.openElements.remove(n))}function R5(t){t.openElements.hasInButtonScope(h.P)||t._insertFakeElement(R.P,h.P),t._closePElement()}function P5(t){t.openElements.hasInListItemScope(h.LI)&&(t.openElements.generateImpliedEndTagsWithExclusion(h.LI),t.openElements.popUntilTagNamePopped(h.LI))}function x5(t,e){const n=e.tagID;t.openElements.hasInScope(n)&&(t.openElements.generateImpliedEndTagsWithExclusion(n),t.openElements.popUntilTagNamePopped(n))}function L5(t){t.openElements.hasNumberedHeaderInScope()&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilNumberedHeaderPopped())}function D5(t,e){const n=e.tagID;t.openElements.hasInScope(n)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(n),t.activeFormattingElements.clearToLastMarker())}function M5(t){t._reconstructActiveFormattingElements(),t._insertFakeElement(R.BR,h.BR),t.openElements.pop(),t.framesetOk=!1}function Rw(t,e){const n=e.tagName,r=e.tagID;for(let s=t.openElements.stackTop;s>0;s--){const a=t.openElements.items[s],i=t.openElements.tagIDs[s];if(r===i&&(r!==h.UNKNOWN||t.treeAdapter.getTagName(a)===n)){t.openElements.generateImpliedEndTagsWithExclusion(r),t.openElements.stackTop>=s&&t.openElements.shortenToLength(s);break}if(t._isSpecialElement(a,i))break}}function hl(t,e){switch(e.tagID){case h.A:case h.B:case h.I:case h.S:case h.U:case h.EM:case h.TT:case h.BIG:case h.CODE:case h.FONT:case h.NOBR:case h.SMALL:case h.STRIKE:case h.STRONG:{Om(t,e);break}case h.P:{R5(t);break}case h.DL:case h.UL:case h.OL:case h.DIR:case h.DIV:case h.NAV:case h.PRE:case h.MAIN:case h.MENU:case h.ASIDE:case h.BUTTON:case h.CENTER:case h.FIGURE:case h.FOOTER:case h.HEADER:case h.HGROUP:case h.DIALOG:case h.ADDRESS:case h.ARTICLE:case h.DETAILS:case h.SEARCH:case h.SECTION:case h.SUMMARY:case h.LISTING:case h.FIELDSET:case h.BLOCKQUOTE:case h.FIGCAPTION:{k5(t,e);break}case h.LI:{P5(t);break}case h.DD:case h.DT:{x5(t,e);break}case h.H1:case h.H2:case h.H3:case h.H4:case h.H5:case h.H6:{L5(t);break}case h.BR:{M5(t);break}case h.BODY:{v5(t,e);break}case h.HTML:{I5(t,e);break}case h.FORM:{N5(t);break}case h.APPLET:case h.OBJECT:case h.MARQUEE:{D5(t,e);break}case h.TEMPLATE:{Ns(t,e);break}default:Rw(t,e)}}function Pw(t,e){t.tmplInsertionModeStack.length>0?Uw(t,e):vm(t,e)}function B5(t,e){var n;e.tagID===h.SCRIPT&&((n=t.scriptHandler)===null||n===void 0||n.call(t,t.openElements.current)),t.openElements.pop(),t.insertionMode=t.originalInsertionMode}function F5(t,e){t._err(e,U.eofInElementThatCanContainOnlyText),t.openElements.pop(),t.insertionMode=t.originalInsertionMode,t.onEof(e)}function Id(t,e){if(Cw.has(t.openElements.currentTagId))switch(t.pendingCharacterTokens.length=0,t.hasNonWhitespacePendingCharacterToken=!1,t.originalInsertionMode=t.insertionMode,t.insertionMode=C.IN_TABLE_TEXT,e.type){case Fe.CHARACTER:{Lw(t,e);break}case Fe.WHITESPACE_CHARACTER:{xw(t,e);break}}else To(t,e)}function U5(t,e){t.openElements.clearBackToTableContext(),t.activeFormattingElements.insertMarker(),t._insertElement(e,G.HTML),t.insertionMode=C.IN_CAPTION}function j5(t,e){t.openElements.clearBackToTableContext(),t._insertElement(e,G.HTML),t.insertionMode=C.IN_COLUMN_GROUP}function H5(t,e){t.openElements.clearBackToTableContext(),t._insertFakeElement(R.COLGROUP,h.COLGROUP),t.insertionMode=C.IN_COLUMN_GROUP,Im(t,e)}function $5(t,e){t.openElements.clearBackToTableContext(),t._insertElement(e,G.HTML),t.insertionMode=C.IN_TABLE_BODY}function q5(t,e){t.openElements.clearBackToTableContext(),t._insertFakeElement(R.TBODY,h.TBODY),t.insertionMode=C.IN_TABLE_BODY,fl(t,e)}function V5(t,e){t.openElements.hasInTableScope(h.TABLE)&&(t.openElements.popUntilTagNamePopped(h.TABLE),t._resetInsertionMode(),t._processStartTag(e))}function z5(t,e){Nw(e)?t._appendElement(e,G.HTML):To(t,e),e.ackSelfClosing=!0}function W5(t,e){!t.formElement&&t.openElements.tmplCount===0&&(t._insertElement(e,G.HTML),t.formElement=t.openElements.current,t.openElements.pop())}function ma(t,e){switch(e.tagID){case h.TD:case h.TH:case h.TR:{q5(t,e);break}case h.STYLE:case h.SCRIPT:case h.TEMPLATE:{Zn(t,e);break}case h.COL:{H5(t,e);break}case h.FORM:{W5(t,e);break}case h.TABLE:{V5(t,e);break}case h.TBODY:case h.TFOOT:case h.THEAD:{$5(t,e);break}case h.INPUT:{z5(t,e);break}case h.CAPTION:{U5(t,e);break}case h.COLGROUP:{j5(t,e);break}default:To(t,e)}}function Ji(t,e){switch(e.tagID){case h.TABLE:{t.openElements.hasInTableScope(h.TABLE)&&(t.openElements.popUntilTagNamePopped(h.TABLE),t._resetInsertionMode());break}case h.TEMPLATE:{Ns(t,e);break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:case h.TBODY:case h.TD:case h.TFOOT:case h.TH:case h.THEAD:case h.TR:break;default:To(t,e)}}function To(t,e){const n=t.fosterParentingEnabled;t.fosterParentingEnabled=!0,dl(t,e),t.fosterParentingEnabled=n}function xw(t,e){t.pendingCharacterTokens.push(e)}function Lw(t,e){t.pendingCharacterTokens.push(e),t.hasNonWhitespacePendingCharacterToken=!0}function Ka(t,e){let n=0;if(t.hasNonWhitespacePendingCharacterToken)for(;n<t.pendingCharacterTokens.length;n++)To(t,t.pendingCharacterTokens[n]);else for(;n<t.pendingCharacterTokens.length;n++)t._insertCharacters(t.pendingCharacterTokens[n]);t.insertionMode=t.originalInsertionMode,t._processToken(e)}const Dw=new Set([h.CAPTION,h.COL,h.COLGROUP,h.TBODY,h.TD,h.TFOOT,h.TH,h.THEAD,h.TR]);function G5(t,e){const n=e.tagID;Dw.has(n)?t.openElements.hasInTableScope(h.CAPTION)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(h.CAPTION),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=C.IN_TABLE,ma(t,e)):Bt(t,e)}function K5(t,e){const n=e.tagID;switch(n){case h.CAPTION:case h.TABLE:{t.openElements.hasInTableScope(h.CAPTION)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(h.CAPTION),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=C.IN_TABLE,n===h.TABLE&&Ji(t,e));break}case h.BODY:case h.COL:case h.COLGROUP:case h.HTML:case h.TBODY:case h.TD:case h.TFOOT:case h.TH:case h.THEAD:case h.TR:break;default:hl(t,e)}}function Im(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.COL:{t._appendElement(e,G.HTML),e.ackSelfClosing=!0;break}case h.TEMPLATE:{Zn(t,e);break}default:mc(t,e)}}function Y5(t,e){switch(e.tagID){case h.COLGROUP:{t.openElements.currentTagId===h.COLGROUP&&(t.openElements.pop(),t.insertionMode=C.IN_TABLE);break}case h.TEMPLATE:{Ns(t,e);break}case h.COL:break;default:mc(t,e)}}function mc(t,e){t.openElements.currentTagId===h.COLGROUP&&(t.openElements.pop(),t.insertionMode=C.IN_TABLE,t._processToken(e))}function fl(t,e){switch(e.tagID){case h.TR:{t.openElements.clearBackToTableBodyContext(),t._insertElement(e,G.HTML),t.insertionMode=C.IN_ROW;break}case h.TH:case h.TD:{t.openElements.clearBackToTableBodyContext(),t._insertFakeElement(R.TR,h.TR),t.insertionMode=C.IN_ROW,ml(t,e);break}case h.CAPTION:case h.COL:case h.COLGROUP:case h.TBODY:case h.TFOOT:case h.THEAD:{t.openElements.hasTableBodyContextInTableScope()&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=C.IN_TABLE,ma(t,e));break}default:ma(t,e)}}function Wh(t,e){const n=e.tagID;switch(e.tagID){case h.TBODY:case h.TFOOT:case h.THEAD:{t.openElements.hasInTableScope(n)&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=C.IN_TABLE);break}case h.TABLE:{t.openElements.hasTableBodyContextInTableScope()&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=C.IN_TABLE,Ji(t,e));break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:case h.TD:case h.TH:case h.TR:break;default:Ji(t,e)}}function ml(t,e){switch(e.tagID){case h.TH:case h.TD:{t.openElements.clearBackToTableRowContext(),t._insertElement(e,G.HTML),t.insertionMode=C.IN_CELL,t.activeFormattingElements.insertMarker();break}case h.CAPTION:case h.COL:case h.COLGROUP:case h.TBODY:case h.TFOOT:case h.THEAD:case h.TR:{t.openElements.hasInTableScope(h.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=C.IN_TABLE_BODY,fl(t,e));break}default:ma(t,e)}}function Mw(t,e){switch(e.tagID){case h.TR:{t.openElements.hasInTableScope(h.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=C.IN_TABLE_BODY);break}case h.TABLE:{t.openElements.hasInTableScope(h.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=C.IN_TABLE_BODY,Wh(t,e));break}case h.TBODY:case h.TFOOT:case h.THEAD:{(t.openElements.hasInTableScope(e.tagID)||t.openElements.hasInTableScope(h.TR))&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=C.IN_TABLE_BODY,Wh(t,e));break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:case h.TD:case h.TH:break;default:Ji(t,e)}}function Z5(t,e){const n=e.tagID;Dw.has(n)?(t.openElements.hasInTableScope(h.TD)||t.openElements.hasInTableScope(h.TH))&&(t._closeTableCell(),ml(t,e)):Bt(t,e)}function J5(t,e){const n=e.tagID;switch(n){case h.TD:case h.TH:{t.openElements.hasInTableScope(n)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(n),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=C.IN_ROW);break}case h.TABLE:case h.TBODY:case h.TFOOT:case h.THEAD:case h.TR:{t.openElements.hasInTableScope(n)&&(t._closeTableCell(),Mw(t,e));break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:break;default:hl(t,e)}}function Bw(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.OPTION:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t._insertElement(e,G.HTML);break}case h.OPTGROUP:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t.openElements.currentTagId===h.OPTGROUP&&t.openElements.pop(),t._insertElement(e,G.HTML);break}case h.HR:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t.openElements.currentTagId===h.OPTGROUP&&t.openElements.pop(),t._appendElement(e,G.HTML),e.ackSelfClosing=!0;break}case h.INPUT:case h.KEYGEN:case h.TEXTAREA:case h.SELECT:{t.openElements.hasInSelectScope(h.SELECT)&&(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode(),e.tagID!==h.SELECT&&t._processStartTag(e));break}case h.SCRIPT:case h.TEMPLATE:{Zn(t,e);break}}}function Fw(t,e){switch(e.tagID){case h.OPTGROUP:{t.openElements.stackTop>0&&t.openElements.currentTagId===h.OPTION&&t.openElements.tagIDs[t.openElements.stackTop-1]===h.OPTGROUP&&t.openElements.pop(),t.openElements.currentTagId===h.OPTGROUP&&t.openElements.pop();break}case h.OPTION:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop();break}case h.SELECT:{t.openElements.hasInSelectScope(h.SELECT)&&(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode());break}case h.TEMPLATE:{Ns(t,e);break}}}function X5(t,e){const n=e.tagID;n===h.CAPTION||n===h.TABLE||n===h.TBODY||n===h.TFOOT||n===h.THEAD||n===h.TR||n===h.TD||n===h.TH?(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode(),t._processStartTag(e)):Bw(t,e)}function Q5(t,e){const n=e.tagID;n===h.CAPTION||n===h.TABLE||n===h.TBODY||n===h.TFOOT||n===h.THEAD||n===h.TR||n===h.TD||n===h.TH?t.openElements.hasInTableScope(n)&&(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode(),t.onEndTag(e)):Fw(t,e)}function eB(t,e){switch(e.tagID){case h.BASE:case h.BASEFONT:case h.BGSOUND:case h.LINK:case h.META:case h.NOFRAMES:case h.SCRIPT:case h.STYLE:case h.TEMPLATE:case h.TITLE:{Zn(t,e);break}case h.CAPTION:case h.COLGROUP:case h.TBODY:case h.TFOOT:case h.THEAD:{t.tmplInsertionModeStack[0]=C.IN_TABLE,t.insertionMode=C.IN_TABLE,ma(t,e);break}case h.COL:{t.tmplInsertionModeStack[0]=C.IN_COLUMN_GROUP,t.insertionMode=C.IN_COLUMN_GROUP,Im(t,e);break}case h.TR:{t.tmplInsertionModeStack[0]=C.IN_TABLE_BODY,t.insertionMode=C.IN_TABLE_BODY,fl(t,e);break}case h.TD:case h.TH:{t.tmplInsertionModeStack[0]=C.IN_ROW,t.insertionMode=C.IN_ROW,ml(t,e);break}default:t.tmplInsertionModeStack[0]=C.IN_BODY,t.insertionMode=C.IN_BODY,Bt(t,e)}}function tB(t,e){e.tagID===h.TEMPLATE&&Ns(t,e)}function Uw(t,e){t.openElements.tmplCount>0?(t.openElements.popUntilTagNamePopped(h.TEMPLATE),t.activeFormattingElements.clearToLastMarker(),t.tmplInsertionModeStack.shift(),t._resetInsertionMode(),t.onEof(e)):vm(t,e)}function nB(t,e){e.tagID===h.HTML?Bt(t,e):pc(t,e)}function jw(t,e){var n;if(e.tagID===h.HTML){if(t.fragmentContext||(t.insertionMode=C.AFTER_AFTER_BODY),t.options.sourceCodeLocationInfo&&t.openElements.tagIDs[0]===h.HTML){t._setEndLocation(t.openElements.items[0],e);const r=t.openElements.items[1];r&&!(!((n=t.treeAdapter.getNodeSourceCodeLocation(r))===null||n===void 0)&&n.endTag)&&t._setEndLocation(r,e)}}else pc(t,e)}function pc(t,e){t.insertionMode=C.IN_BODY,dl(t,e)}function rB(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.FRAMESET:{t._insertElement(e,G.HTML);break}case h.FRAME:{t._appendElement(e,G.HTML),e.ackSelfClosing=!0;break}case h.NOFRAMES:{Zn(t,e);break}}}function sB(t,e){e.tagID===h.FRAMESET&&!t.openElements.isRootHtmlElementCurrent()&&(t.openElements.pop(),!t.fragmentContext&&t.openElements.currentTagId!==h.FRAMESET&&(t.insertionMode=C.AFTER_FRAMESET))}function aB(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.NOFRAMES:{Zn(t,e);break}}}function iB(t,e){e.tagID===h.HTML&&(t.insertionMode=C.AFTER_AFTER_FRAMESET)}function oB(t,e){e.tagID===h.HTML?Bt(t,e):vu(t,e)}function vu(t,e){t.insertionMode=C.IN_BODY,dl(t,e)}function uB(t,e){switch(e.tagID){case h.HTML:{Bt(t,e);break}case h.NOFRAMES:{Zn(t,e);break}}}function cB(t,e){e.chars=et,t._insertCharacters(e)}function lB(t,e){t._insertCharacters(e),t.framesetOk=!1}function Hw(t){for(;t.treeAdapter.getNamespaceURI(t.openElements.current)!==G.HTML&&!t._isIntegrationPoint(t.openElements.currentTagId,t.openElements.current);)t.openElements.pop()}function dB(t,e){if(O8(e))Hw(t),t._startTagOutsideForeignContent(e);else{const n=t._getAdjustedCurrentElement(),r=t.treeAdapter.getNamespaceURI(n);r===G.MATHML?Sw(e):r===G.SVG&&(v8(e),Aw(e)),Cm(e),e.selfClosing?t._appendElement(e,r):t._insertElement(e,r),e.ackSelfClosing=!0}}function hB(t,e){if(e.tagID===h.P||e.tagID===h.BR){Hw(t),t._endTagOutsideForeignContent(e);return}for(let n=t.openElements.stackTop;n>0;n--){const r=t.openElements.items[n];if(t.treeAdapter.getNamespaceURI(r)===G.HTML){t._endTagOutsideForeignContent(e);break}const s=t.treeAdapter.getTagName(r);if(s.toLowerCase()===e.tagName){e.tagName=s,t.openElements.shortenToLength(n);break}}}const fB=new Set([R.AREA,R.BASE,R.BASEFONT,R.BGSOUND,R.BR,R.COL,R.EMBED,R.FRAME,R.HR,R.IMG,R.INPUT,R.KEYGEN,R.LINK,R.META,R.PARAM,R.SOURCE,R.TRACK,R.WBR]);function mB(t,e){return e.treeAdapter.isElementNode(t)&&e.treeAdapter.getNamespaceURI(t)===G.HTML&&fB.has(e.treeAdapter.getTagName(t))}const pB={treeAdapter:wr,scriptingEnabled:!0};function gB(t,e){const n={...pB,...e};return $w(t,n)}function bB(t,e){let n="";const r=e.treeAdapter.isElementNode(t)&&e.treeAdapter.getTagName(t)===R.TEMPLATE&&e.treeAdapter.getNamespaceURI(t)===G.HTML?e.treeAdapter.getTemplateContent(t):t,s=e.treeAdapter.getChildNodes(r);if(s)for(const a of s)n+=$w(a,e);return n}function $w(t,e){return e.treeAdapter.isElementNode(t)?_B(t,e):e.treeAdapter.isTextNode(t)?EB(t,e):e.treeAdapter.isCommentNode(t)?wB(t,e):e.treeAdapter.isDocumentTypeNode(t)?TB(t,e):""}function _B(t,e){const n=e.treeAdapter.getTagName(t);return`<${n}${yB(t,e)}>${mB(t,e)?"":`${bB(t,e)}</${n}>`}`}function yB(t,{treeAdapter:e}){let n="";for(const r of e.getAttrList(t)){if(n+=" ",r.namespace)switch(r.namespace){case G.XML:{n+=`xml:${r.name}`;break}case G.XMLNS:{r.name!=="xmlns"&&(n+="xmlns:"),n+=r.name;break}case G.XLINK:{n+=`xlink:${r.name}`;break}default:n+=`${r.prefix}:${r.name}`}else n+=r.name;n+=`="${xE(r.value)}"`}return n}function EB(t,e){const{treeAdapter:n}=e,r=n.getTextNodeContent(t),s=n.getParentNode(t),a=s&&n.isElementNode(s)&&n.getTagName(s);return a&&n.getNamespaceURI(s)===G.HTML&&e8(a,e.scriptingEnabled)?r:LE(r)}function wB(t,{treeAdapter:e}){return`<!--${e.getCommentNodeContent(t)}-->`}function TB(t,{treeAdapter:e}){return`<!DOCTYPE ${e.getDocumentTypeNodeName(t)}>`}function SB(t,e){return Ow.parse(t,e)}function AB(t,e,n){typeof t=="string"&&(n=e,e=t,t=null);const r=Ow.getFragmentParser(t,n);return r.tokenizer.write(e,!0),r.getFragment()}function j0(t){const e=t.includes('"')?"'":'"';return e+t+e}function CB(t,e,n){let r="!DOCTYPE ";return t&&(r+=t),e?r+=` PUBLIC ${j0(e)}`:n&&(r+=" SYSTEM"),n&&(r+=` ${j0(n)}`),r}const jr={isCommentNode:al,isElementNode:ge,isTextNode:dr,createDocument(){const t=new Cs([]);return t["x-mode"]=ln.NO_QUIRKS,t},createDocumentFragment(){return new Cs([])},createElement(t,e,n){const r=Object.create(null),s=Object.create(null),a=Object.create(null);for(let o=0;o<n.length;o++){const u=n[o].name;r[u]=n[o].value,s[u]=n[o].namespace,a[u]=n[o].prefix}const i=new cm(t,r,[]);return i.namespace=e,i["x-attribsNamespace"]=s,i["x-attribsPrefix"]=a,i},createCommentNode(t){return new im(t)},createTextNode(t){return new Wi(t)},appendChild(t,e){const n=t.children[t.children.length-1];n&&(n.next=e,e.prev=n),t.children.push(e),e.parent=t},insertBefore(t,e,n){const r=t.children.indexOf(n),{prev:s}=n;s&&(s.next=e,e.prev=s),n.prev=e,e.next=n,t.children.splice(r,0,e),e.parent=t},setTemplateContent(t,e){jr.appendChild(t,e)},getTemplateContent(t){return t.children[0]},setDocumentType(t,e,n,r){const s=CB(e,n,r);let a=t.children.find(i=>Lh(i)&&i.name==="!doctype");a?a.data=s??null:(a=new om("!doctype",s),jr.appendChild(t,a)),a["x-name"]=e,a["x-publicId"]=n,a["x-systemId"]=r},setDocumentMode(t,e){t["x-mode"]=e},getDocumentMode(t){return t["x-mode"]},detachNode(t){if(t.parent){const e=t.parent.children.indexOf(t),{prev:n,next:r}=t;t.prev=null,t.next=null,n&&(n.next=r),r&&(r.prev=n),t.parent.children.splice(e,1),t.parent=null}},insertText(t,e){const n=t.children[t.children.length-1];n&&dr(n)?n.data+=e:jr.appendChild(t,jr.createTextNode(e))},insertTextBefore(t,e,n){const r=t.children[t.children.indexOf(n)-1];r&&dr(r)?r.data+=e:jr.insertBefore(t,jr.createTextNode(e),n)},adoptAttributes(t,e){for(let n=0;n<e.length;n++){const r=e[n].name;t.attribs[r]===void 0&&(t.attribs[r]=e[n].value,t["x-attribsNamespace"][r]=e[n].namespace,t["x-attribsPrefix"][r]=e[n].prefix)}},getFirstChild(t){return t.children[0]},getChildNodes(t){return t.children},getParentNode(t){return t.parent},getAttrList(t){return t.attributes},getTagName(t){return t.name},getNamespaceURI(t){return t.namespace},getTextNodeContent(t){return t.data},getCommentNodeContent(t){return t.data},getDocumentTypeNodeName(t){var e;return(e=t["x-name"])!==null&&e!==void 0?e:""},getDocumentTypeNodePublicId(t){var e;return(e=t["x-publicId"])!==null&&e!==void 0?e:""},getDocumentTypeNodeSystemId(t){var e;return(e=t["x-systemId"])!==null&&e!==void 0?e:""},isDocumentTypeNode(t){return Lh(t)&&t.name==="!doctype"},setNodeSourceCodeLocation(t,e){e&&(t.startIndex=e.startOffset,t.endIndex=e.endOffset),t.sourceCodeLocation=e},getNodeSourceCodeLocation(t){return t.sourceCodeLocation},updateNodeSourceCodeLocation(t,e){e.endOffset!=null&&(t.endIndex=e.endOffset),t.sourceCodeLocation={...t.sourceCodeLocation,...e}}};function OB(t,e,n,r){var s;return(s=e.treeAdapter)!==null&&s!==void 0||(e.treeAdapter=jr),e.scriptingEnabled!==!1&&(e.scriptingEnabled=!0),n?SB(t,e):AB(r,t,e)}const vB={treeAdapter:jr};function IB(t){const e="length"in t?t:[t];for(let r=0;r<e.length;r+=1){const s=e[r];Xr(s)&&Array.prototype.splice.call(e,r,1,...s.children)}let n="";for(let r=0;r<e.length;r+=1){const s=e[r];n+=gB(s,vB)}return n}var de;(function(t){t[t.Tab=9]="Tab",t[t.NewLine=10]="NewLine",t[t.FormFeed=12]="FormFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.Number=35]="Number",t[t.Amp=38]="Amp",t[t.SingleQuote=39]="SingleQuote",t[t.DoubleQuote=34]="DoubleQuote",t[t.Dash=45]="Dash",t[t.Slash=47]="Slash",t[t.Zero=48]="Zero",t[t.Nine=57]="Nine",t[t.Semi=59]="Semi",t[t.Lt=60]="Lt",t[t.Eq=61]="Eq",t[t.Gt=62]="Gt",t[t.Questionmark=63]="Questionmark",t[t.UpperA=65]="UpperA",t[t.LowerA=97]="LowerA",t[t.UpperF=70]="UpperF",t[t.LowerF=102]="LowerF",t[t.UpperZ=90]="UpperZ",t[t.LowerZ=122]="LowerZ",t[t.LowerX=120]="LowerX",t[t.OpeningSquareBracket=91]="OpeningSquareBracket"})(de||(de={}));var Y;(function(t){t[t.Text=1]="Text",t[t.BeforeTagName=2]="BeforeTagName",t[t.InTagName=3]="InTagName",t[t.InSelfClosingTag=4]="InSelfClosingTag",t[t.BeforeClosingTagName=5]="BeforeClosingTagName",t[t.InClosingTagName=6]="InClosingTagName",t[t.AfterClosingTagName=7]="AfterClosingTagName",t[t.BeforeAttributeName=8]="BeforeAttributeName",t[t.InAttributeName=9]="InAttributeName",t[t.AfterAttributeName=10]="AfterAttributeName",t[t.BeforeAttributeValue=11]="BeforeAttributeValue",t[t.InAttributeValueDq=12]="InAttributeValueDq",t[t.InAttributeValueSq=13]="InAttributeValueSq",t[t.InAttributeValueNq=14]="InAttributeValueNq",t[t.BeforeDeclaration=15]="BeforeDeclaration",t[t.InDeclaration=16]="InDeclaration",t[t.InProcessingInstruction=17]="InProcessingInstruction",t[t.BeforeComment=18]="BeforeComment",t[t.CDATASequence=19]="CDATASequence",t[t.InSpecialComment=20]="InSpecialComment",t[t.InCommentLike=21]="InCommentLike",t[t.BeforeSpecialS=22]="BeforeSpecialS",t[t.BeforeSpecialT=23]="BeforeSpecialT",t[t.SpecialStartSequence=24]="SpecialStartSequence",t[t.InSpecialTag=25]="InSpecialTag",t[t.InEntity=26]="InEntity"})(Y||(Y={}));function Er(t){return t===de.Space||t===de.NewLine||t===de.Tab||t===de.FormFeed||t===de.CarriageReturn}function lu(t){return t===de.Slash||t===de.Gt||Er(t)}function kB(t){return t>=de.LowerA&&t<=de.LowerZ||t>=de.UpperA&&t<=de.UpperZ}var ir;(function(t){t[t.NoValue=0]="NoValue",t[t.Unquoted=1]="Unquoted",t[t.Single=2]="Single",t[t.Double=3]="Double"})(ir||(ir={}));const vt={Cdata:new Uint8Array([67,68,65,84,65,91]),CdataEnd:new Uint8Array([93,93,62]),CommentEnd:new Uint8Array([45,45,62]),ScriptEnd:new Uint8Array([60,47,115,99,114,105,112,116]),StyleEnd:new Uint8Array([60,47,115,116,121,108,101]),TitleEnd:new Uint8Array([60,47,116,105,116,108,101]),TextareaEnd:new Uint8Array([60,47,116,101,120,116,97,114,101,97])};class NB{constructor({xmlMode:e=!1,decodeEntities:n=!0},r){this.cbs=r,this.state=Y.Text,this.buffer="",this.sectionStart=0,this.index=0,this.entityStart=0,this.baseState=Y.Text,this.isSpecial=!1,this.running=!0,this.offset=0,this.currentSequence=void 0,this.sequenceIndex=0,this.xmlMode=e,this.decodeEntities=n,this.entityDecoder=new dm(e?kE:lm,(s,a)=>this.emitCodePoint(s,a))}reset(){this.state=Y.Text,this.buffer="",this.sectionStart=0,this.index=0,this.baseState=Y.Text,this.currentSequence=void 0,this.running=!0,this.offset=0}write(e){this.offset+=this.buffer.length,this.buffer=e,this.parse()}end(){this.running&&this.finish()}pause(){this.running=!1}resume(){this.running=!0,this.index<this.buffer.length+this.offset&&this.parse()}stateText(e){e===de.Lt||!this.decodeEntities&&this.fastForwardTo(de.Lt)?(this.index>this.sectionStart&&this.cbs.ontext(this.sectionStart,this.index),this.state=Y.BeforeTagName,this.sectionStart=this.index):this.decodeEntities&&e===de.Amp&&this.startEntity()}stateSpecialStartSequence(e){const n=this.sequenceIndex===this.currentSequence.length;if(!(n?lu(e):(e|32)===this.currentSequence[this.sequenceIndex]))this.isSpecial=!1;else if(!n){this.sequenceIndex++;return}this.sequenceIndex=0,this.state=Y.InTagName,this.stateInTagName(e)}stateInSpecialTag(e){if(this.sequenceIndex===this.currentSequence.length){if(e===de.Gt||Er(e)){const n=this.index-this.currentSequence.length;if(this.sectionStart<n){const r=this.index;this.index=n,this.cbs.ontext(this.sectionStart,n),this.index=r}this.isSpecial=!1,this.sectionStart=n+2,this.stateInClosingTagName(e);return}this.sequenceIndex=0}(e|32)===this.currentSequence[this.sequenceIndex]?this.sequenceIndex+=1:this.sequenceIndex===0?this.currentSequence===vt.TitleEnd?this.decodeEntities&&e===de.Amp&&this.startEntity():this.fastForwardTo(de.Lt)&&(this.sequenceIndex=1):this.sequenceIndex=+(e===de.Lt)}stateCDATASequence(e){e===vt.Cdata[this.sequenceIndex]?++this.sequenceIndex===vt.Cdata.length&&(this.state=Y.InCommentLike,this.currentSequence=vt.CdataEnd,this.sequenceIndex=0,this.sectionStart=this.index+1):(this.sequenceIndex=0,this.state=Y.InDeclaration,this.stateInDeclaration(e))}fastForwardTo(e){for(;++this.index<this.buffer.length+this.offset;)if(this.buffer.charCodeAt(this.index-this.offset)===e)return!0;return this.index=this.buffer.length+this.offset-1,!1}stateInCommentLike(e){e===this.currentSequence[this.sequenceIndex]?++this.sequenceIndex===this.currentSequence.length&&(this.currentSequence===vt.CdataEnd?this.cbs.oncdata(this.sectionStart,this.index,2):this.cbs.oncomment(this.sectionStart,this.index,2),this.sequenceIndex=0,this.sectionStart=this.index+1,this.state=Y.Text):this.sequenceIndex===0?this.fastForwardTo(this.currentSequence[0])&&(this.sequenceIndex=1):e!==this.currentSequence[this.sequenceIndex-1]&&(this.sequenceIndex=0)}isTagStartChar(e){return this.xmlMode?!lu(e):kB(e)}startSpecial(e,n){this.isSpecial=!0,this.currentSequence=e,this.sequenceIndex=n,this.state=Y.SpecialStartSequence}stateBeforeTagName(e){if(e===de.ExclamationMark)this.state=Y.BeforeDeclaration,this.sectionStart=this.index+1;else if(e===de.Questionmark)this.state=Y.InProcessingInstruction,this.sectionStart=this.index+1;else if(this.isTagStartChar(e)){const n=e|32;this.sectionStart=this.index,this.xmlMode?this.state=Y.InTagName:n===vt.ScriptEnd[2]?this.state=Y.BeforeSpecialS:n===vt.TitleEnd[2]?this.state=Y.BeforeSpecialT:this.state=Y.InTagName}else e===de.Slash?this.state=Y.BeforeClosingTagName:(this.state=Y.Text,this.stateText(e))}stateInTagName(e){lu(e)&&(this.cbs.onopentagname(this.sectionStart,this.index),this.sectionStart=-1,this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e))}stateBeforeClosingTagName(e){Er(e)||(e===de.Gt?this.state=Y.Text:(this.state=this.isTagStartChar(e)?Y.InClosingTagName:Y.InSpecialComment,this.sectionStart=this.index))}stateInClosingTagName(e){(e===de.Gt||Er(e))&&(this.cbs.onclosetag(this.sectionStart,this.index),this.sectionStart=-1,this.state=Y.AfterClosingTagName,this.stateAfterClosingTagName(e))}stateAfterClosingTagName(e){(e===de.Gt||this.fastForwardTo(de.Gt))&&(this.state=Y.Text,this.sectionStart=this.index+1)}stateBeforeAttributeName(e){e===de.Gt?(this.cbs.onopentagend(this.index),this.isSpecial?(this.state=Y.InSpecialTag,this.sequenceIndex=0):this.state=Y.Text,this.sectionStart=this.index+1):e===de.Slash?this.state=Y.InSelfClosingTag:Er(e)||(this.state=Y.InAttributeName,this.sectionStart=this.index)}stateInSelfClosingTag(e){e===de.Gt?(this.cbs.onselfclosingtag(this.index),this.state=Y.Text,this.sectionStart=this.index+1,this.isSpecial=!1):Er(e)||(this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e))}stateInAttributeName(e){(e===de.Eq||lu(e))&&(this.cbs.onattribname(this.sectionStart,this.index),this.sectionStart=this.index,this.state=Y.AfterAttributeName,this.stateAfterAttributeName(e))}stateAfterAttributeName(e){e===de.Eq?this.state=Y.BeforeAttributeValue:e===de.Slash||e===de.Gt?(this.cbs.onattribend(ir.NoValue,this.sectionStart),this.sectionStart=-1,this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e)):Er(e)||(this.cbs.onattribend(ir.NoValue,this.sectionStart),this.state=Y.InAttributeName,this.sectionStart=this.index)}stateBeforeAttributeValue(e){e===de.DoubleQuote?(this.state=Y.InAttributeValueDq,this.sectionStart=this.index+1):e===de.SingleQuote?(this.state=Y.InAttributeValueSq,this.sectionStart=this.index+1):Er(e)||(this.sectionStart=this.index,this.state=Y.InAttributeValueNq,this.stateInAttributeValueNoQuotes(e))}handleInAttributeValue(e,n){e===n||!this.decodeEntities&&this.fastForwardTo(n)?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(n===de.DoubleQuote?ir.Double:ir.Single,this.index+1),this.state=Y.BeforeAttributeName):this.decodeEntities&&e===de.Amp&&this.startEntity()}stateInAttributeValueDoubleQuotes(e){this.handleInAttributeValue(e,de.DoubleQuote)}stateInAttributeValueSingleQuotes(e){this.handleInAttributeValue(e,de.SingleQuote)}stateInAttributeValueNoQuotes(e){Er(e)||e===de.Gt?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(ir.Unquoted,this.index),this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e)):this.decodeEntities&&e===de.Amp&&this.startEntity()}stateBeforeDeclaration(e){e===de.OpeningSquareBracket?(this.state=Y.CDATASequence,this.sequenceIndex=0):this.state=e===de.Dash?Y.BeforeComment:Y.InDeclaration}stateInDeclaration(e){(e===de.Gt||this.fastForwardTo(de.Gt))&&(this.cbs.ondeclaration(this.sectionStart,this.index),this.state=Y.Text,this.sectionStart=this.index+1)}stateInProcessingInstruction(e){(e===de.Gt||this.fastForwardTo(de.Gt))&&(this.cbs.onprocessinginstruction(this.sectionStart,this.index),this.state=Y.Text,this.sectionStart=this.index+1)}stateBeforeComment(e){e===de.Dash?(this.state=Y.InCommentLike,this.currentSequence=vt.CommentEnd,this.sequenceIndex=2,this.sectionStart=this.index+1):this.state=Y.InDeclaration}stateInSpecialComment(e){(e===de.Gt||this.fastForwardTo(de.Gt))&&(this.cbs.oncomment(this.sectionStart,this.index,0),this.state=Y.Text,this.sectionStart=this.index+1)}stateBeforeSpecialS(e){const n=e|32;n===vt.ScriptEnd[3]?this.startSpecial(vt.ScriptEnd,4):n===vt.StyleEnd[3]?this.startSpecial(vt.StyleEnd,4):(this.state=Y.InTagName,this.stateInTagName(e))}stateBeforeSpecialT(e){const n=e|32;n===vt.TitleEnd[3]?this.startSpecial(vt.TitleEnd,4):n===vt.TextareaEnd[3]?this.startSpecial(vt.TextareaEnd,4):(this.state=Y.InTagName,this.stateInTagName(e))}startEntity(){this.baseState=this.state,this.state=Y.InEntity,this.entityStart=this.index,this.entityDecoder.startEntity(this.xmlMode?Sn.Strict:this.baseState===Y.Text||this.baseState===Y.InSpecialTag?Sn.Legacy:Sn.Attribute)}stateInEntity(){const e=this.entityDecoder.write(this.buffer,this.index-this.offset);e>=0?(this.state=this.baseState,e===0&&(this.index=this.entityStart)):this.index=this.offset+this.buffer.length-1}cleanup(){this.running&&this.sectionStart!==this.index&&(this.state===Y.Text||this.state===Y.InSpecialTag&&this.sequenceIndex===0?(this.cbs.ontext(this.sectionStart,this.index),this.sectionStart=this.index):(this.state===Y.InAttributeValueDq||this.state===Y.InAttributeValueSq||this.state===Y.InAttributeValueNq)&&(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=this.index))}shouldContinue(){return this.index<this.buffer.length+this.offset&&this.running}parse(){for(;this.shouldContinue();){const e=this.buffer.charCodeAt(this.index-this.offset);switch(this.state){case Y.Text:{this.stateText(e);break}case Y.SpecialStartSequence:{this.stateSpecialStartSequence(e);break}case Y.InSpecialTag:{this.stateInSpecialTag(e);break}case Y.CDATASequence:{this.stateCDATASequence(e);break}case Y.InAttributeValueDq:{this.stateInAttributeValueDoubleQuotes(e);break}case Y.InAttributeName:{this.stateInAttributeName(e);break}case Y.InCommentLike:{this.stateInCommentLike(e);break}case Y.InSpecialComment:{this.stateInSpecialComment(e);break}case Y.BeforeAttributeName:{this.stateBeforeAttributeName(e);break}case Y.InTagName:{this.stateInTagName(e);break}case Y.InClosingTagName:{this.stateInClosingTagName(e);break}case Y.BeforeTagName:{this.stateBeforeTagName(e);break}case Y.AfterAttributeName:{this.stateAfterAttributeName(e);break}case Y.InAttributeValueSq:{this.stateInAttributeValueSingleQuotes(e);break}case Y.BeforeAttributeValue:{this.stateBeforeAttributeValue(e);break}case Y.BeforeClosingTagName:{this.stateBeforeClosingTagName(e);break}case Y.AfterClosingTagName:{this.stateAfterClosingTagName(e);break}case Y.BeforeSpecialS:{this.stateBeforeSpecialS(e);break}case Y.BeforeSpecialT:{this.stateBeforeSpecialT(e);break}case Y.InAttributeValueNq:{this.stateInAttributeValueNoQuotes(e);break}case Y.InSelfClosingTag:{this.stateInSelfClosingTag(e);break}case Y.InDeclaration:{this.stateInDeclaration(e);break}case Y.BeforeDeclaration:{this.stateBeforeDeclaration(e);break}case Y.BeforeComment:{this.stateBeforeComment(e);break}case Y.InProcessingInstruction:{this.stateInProcessingInstruction(e);break}case Y.InEntity:{this.stateInEntity();break}}this.index++}this.cleanup()}finish(){this.state===Y.InEntity&&(this.entityDecoder.end(),this.state=this.baseState),this.handleTrailingData(),this.cbs.onend()}handleTrailingData(){const e=this.buffer.length+this.offset;this.sectionStart>=e||(this.state===Y.InCommentLike?this.currentSequence===vt.CdataEnd?this.cbs.oncdata(this.sectionStart,e,0):this.cbs.oncomment(this.sectionStart,e,0):this.state===Y.InTagName||this.state===Y.BeforeAttributeName||this.state===Y.BeforeAttributeValue||this.state===Y.AfterAttributeName||this.state===Y.InAttributeName||this.state===Y.InAttributeValueSq||this.state===Y.InAttributeValueDq||this.state===Y.InAttributeValueNq||this.state===Y.InClosingTagName||this.cbs.ontext(this.sectionStart,e))}emitCodePoint(e,n){this.baseState!==Y.Text&&this.baseState!==Y.InSpecialTag?(this.sectionStart<this.entityStart&&this.cbs.onattribdata(this.sectionStart,this.entityStart),this.sectionStart=this.entityStart+n,this.index=this.sectionStart-1,this.cbs.onattribentity(e)):(this.sectionStart<this.entityStart&&this.cbs.ontext(this.sectionStart,this.entityStart),this.sectionStart=this.entityStart+n,this.index=this.sectionStart-1,this.cbs.ontextentity(e,this.sectionStart))}}const Us=new Set(["input","option","optgroup","select","button","datalist","textarea"]),Je=new Set(["p"]),H0=new Set(["thead","tbody"]),$0=new Set(["dd","dt"]),q0=new Set(["rt","rp"]),RB=new Map([["tr",new Set(["tr","th","td"])],["th",new Set(["th"])],["td",new Set(["thead","th","td"])],["body",new Set(["head","link","script"])],["li",new Set(["li"])],["p",Je],["h1",Je],["h2",Je],["h3",Je],["h4",Je],["h5",Je],["h6",Je],["select",Us],["input",Us],["output",Us],["button",Us],["datalist",Us],["textarea",Us],["option",new Set(["option"])],["optgroup",new Set(["optgroup","option"])],["dd",$0],["dt",$0],["address",Je],["article",Je],["aside",Je],["blockquote",Je],["details",Je],["div",Je],["dl",Je],["fieldset",Je],["figcaption",Je],["figure",Je],["footer",Je],["form",Je],["header",Je],["hr",Je],["main",Je],["nav",Je],["ol",Je],["pre",Je],["section",Je],["table",Je],["ul",Je],["rt",q0],["rp",q0],["tbody",H0],["tfoot",H0]]),PB=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]),V0=new Set(["math","svg"]),z0=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignobject","desc","title"]),xB=/\s|\//;class LB{constructor(e,n={}){var r,s,a,i,o,u;this.options=n,this.startIndex=0,this.endIndex=0,this.openTagStart=0,this.tagname="",this.attribname="",this.attribvalue="",this.attribs=null,this.stack=[],this.buffers=[],this.bufferOffset=0,this.writeIndex=0,this.ended=!1,this.cbs=e??{},this.htmlMode=!this.options.xmlMode,this.lowerCaseTagNames=(r=n.lowerCaseTags)!==null&&r!==void 0?r:this.htmlMode,this.lowerCaseAttributeNames=(s=n.lowerCaseAttributeNames)!==null&&s!==void 0?s:this.htmlMode,this.recognizeSelfClosing=(a=n.recognizeSelfClosing)!==null&&a!==void 0?a:!this.htmlMode,this.tokenizer=new((i=n.Tokenizer)!==null&&i!==void 0?i:NB)(this.options,this),this.foreignContext=[!this.htmlMode],(u=(o=this.cbs).onparserinit)===null||u===void 0||u.call(o,this)}ontext(e,n){var r,s;const a=this.getSlice(e,n);this.endIndex=n-1,(s=(r=this.cbs).ontext)===null||s===void 0||s.call(r,a),this.startIndex=n}ontextentity(e,n){var r,s;this.endIndex=n-1,(s=(r=this.cbs).ontext)===null||s===void 0||s.call(r,Dh(e)),this.startIndex=n}isVoidElement(e){return this.htmlMode&&PB.has(e)}onopentagname(e,n){this.endIndex=n;let r=this.getSlice(e,n);this.lowerCaseTagNames&&(r=r.toLowerCase()),this.emitOpenTag(r)}emitOpenTag(e){var n,r,s,a;this.openTagStart=this.startIndex,this.tagname=e;const i=this.htmlMode&&RB.get(e);if(i)for(;this.stack.length>0&&i.has(this.stack[0]);){const o=this.stack.shift();(r=(n=this.cbs).onclosetag)===null||r===void 0||r.call(n,o,!0)}this.isVoidElement(e)||(this.stack.unshift(e),this.htmlMode&&(V0.has(e)?this.foreignContext.unshift(!0):z0.has(e)&&this.foreignContext.unshift(!1))),(a=(s=this.cbs).onopentagname)===null||a===void 0||a.call(s,e),this.cbs.onopentag&&(this.attribs={})}endOpenTag(e){var n,r;this.startIndex=this.openTagStart,this.attribs&&((r=(n=this.cbs).onopentag)===null||r===void 0||r.call(n,this.tagname,this.attribs,e),this.attribs=null),this.cbs.onclosetag&&this.isVoidElement(this.tagname)&&this.cbs.onclosetag(this.tagname,!0),this.tagname=""}onopentagend(e){this.endIndex=e,this.endOpenTag(!1),this.startIndex=e+1}onclosetag(e,n){var r,s,a,i,o,u,c,l;this.endIndex=n;let d=this.getSlice(e,n);if(this.lowerCaseTagNames&&(d=d.toLowerCase()),this.htmlMode&&(V0.has(d)||z0.has(d))&&this.foreignContext.shift(),this.isVoidElement(d))this.htmlMode&&d==="br"&&((i=(a=this.cbs).onopentagname)===null||i===void 0||i.call(a,"br"),(u=(o=this.cbs).onopentag)===null||u===void 0||u.call(o,"br",{},!0),(l=(c=this.cbs).onclosetag)===null||l===void 0||l.call(c,"br",!1));else{const m=this.stack.indexOf(d);if(m!==-1)for(let p=0;p<=m;p++){const f=this.stack.shift();(s=(r=this.cbs).onclosetag)===null||s===void 0||s.call(r,f,p!==m)}else this.htmlMode&&d==="p"&&(this.emitOpenTag("p"),this.closeCurrentTag(!0))}this.startIndex=n+1}onselfclosingtag(e){this.endIndex=e,this.recognizeSelfClosing||this.foreignContext[0]?(this.closeCurrentTag(!1),this.startIndex=e+1):this.onopentagend(e)}closeCurrentTag(e){var n,r;const s=this.tagname;this.endOpenTag(e),this.stack[0]===s&&((r=(n=this.cbs).onclosetag)===null||r===void 0||r.call(n,s,!e),this.stack.shift())}onattribname(e,n){this.startIndex=e;const r=this.getSlice(e,n);this.attribname=this.lowerCaseAttributeNames?r.toLowerCase():r}onattribdata(e,n){this.attribvalue+=this.getSlice(e,n)}onattribentity(e){this.attribvalue+=Dh(e)}onattribend(e,n){var r,s;this.endIndex=n,(s=(r=this.cbs).onattribute)===null||s===void 0||s.call(r,this.attribname,this.attribvalue,e===ir.Double?'"':e===ir.Single?"'":e===ir.NoValue?void 0:null),this.attribs&&!Object.prototype.hasOwnProperty.call(this.attribs,this.attribname)&&(this.attribs[this.attribname]=this.attribvalue),this.attribvalue=""}getInstructionName(e){const n=e.search(xB);let r=n<0?e:e.substr(0,n);return this.lowerCaseTagNames&&(r=r.toLowerCase()),r}ondeclaration(e,n){this.endIndex=n;const r=this.getSlice(e,n);if(this.cbs.onprocessinginstruction){const s=this.getInstructionName(r);this.cbs.onprocessinginstruction(`!${s}`,`!${r}`)}this.startIndex=n+1}onprocessinginstruction(e,n){this.endIndex=n;const r=this.getSlice(e,n);if(this.cbs.onprocessinginstruction){const s=this.getInstructionName(r);this.cbs.onprocessinginstruction(`?${s}`,`?${r}`)}this.startIndex=n+1}oncomment(e,n,r){var s,a,i,o;this.endIndex=n,(a=(s=this.cbs).oncomment)===null||a===void 0||a.call(s,this.getSlice(e,n-r)),(o=(i=this.cbs).oncommentend)===null||o===void 0||o.call(i),this.startIndex=n+1}oncdata(e,n,r){var s,a,i,o,u,c,l,d,m,p;this.endIndex=n;const f=this.getSlice(e,n-r);!this.htmlMode||this.options.recognizeCDATA?((a=(s=this.cbs).oncdatastart)===null||a===void 0||a.call(s),(o=(i=this.cbs).ontext)===null||o===void 0||o.call(i,f),(c=(u=this.cbs).oncdataend)===null||c===void 0||c.call(u)):((d=(l=this.cbs).oncomment)===null||d===void 0||d.call(l,`[CDATA[${f}]]`),(p=(m=this.cbs).oncommentend)===null||p===void 0||p.call(m)),this.startIndex=n+1}onend(){var e,n;if(this.cbs.onclosetag){this.endIndex=this.startIndex;for(let r=0;r<this.stack.length;r++)this.cbs.onclosetag(this.stack[r],!0)}(n=(e=this.cbs).onend)===null||n===void 0||n.call(e)}reset(){var e,n,r,s;(n=(e=this.cbs).onreset)===null||n===void 0||n.call(e),this.tokenizer.reset(),this.tagname="",this.attribname="",this.attribs=null,this.stack.length=0,this.startIndex=0,this.endIndex=0,(s=(r=this.cbs).onparserinit)===null||s===void 0||s.call(r,this),this.buffers.length=0,this.foreignContext.length=0,this.foreignContext.unshift(!this.htmlMode),this.bufferOffset=0,this.writeIndex=0,this.ended=!1}parseComplete(e){this.reset(),this.end(e)}getSlice(e,n){for(;e-this.bufferOffset>=this.buffers[0].length;)this.shiftBuffer();let r=this.buffers[0].slice(e-this.bufferOffset,n-this.bufferOffset);for(;n-this.bufferOffset>this.buffers[0].length;)this.shiftBuffer(),r+=this.buffers[0].slice(0,n-this.bufferOffset);return r}shiftBuffer(){this.bufferOffset+=this.buffers[0].length,this.writeIndex--,this.buffers.shift()}write(e){var n,r;if(this.ended){(r=(n=this.cbs).onerror)===null||r===void 0||r.call(n,new Error(".write() after done!"));return}this.buffers.push(e),this.tokenizer.running&&(this.tokenizer.write(e),this.writeIndex++)}end(e){var n,r;if(this.ended){(r=(n=this.cbs).onerror)===null||r===void 0||r.call(n,new Error(".end() after done!"));return}e&&this.write(e),this.ended=!0,this.tokenizer.end()}pause(){this.tokenizer.pause()}resume(){for(this.tokenizer.resume();this.tokenizer.running&&this.writeIndex<this.buffers.length;)this.tokenizer.write(this.buffers[this.writeIndex++]);this.ended&&this.tokenizer.end()}parseChunk(e){this.write(e)}done(e){this.end(e)}}function DB(t,e){const n=new BL(void 0,e);return new LB(n,e).end(t),n.root}const MB=dM((t,e,n,r)=>e._useHtmlParser2?DB(t,e):OB(t,e,n,r)),BB=VM(MB,(t,e)=>e._useHtmlParser2?il(t,e):IB(t));async function FB(t,e){try{const n=await t.invoke(e),r=typeof n=="string"?JSON.parse(`[${n}]`):n;return r.length===0?(_a(""),[]):r}catch(n){console.error(":",n)}return[]}async function UB(t){let e="";try{const n=await Xe.get(t),r=BB(n.data);r("script").remove(),r("style").remove(),r("noscript").remove(),r("iframe").remove(),r("nav").remove(),r("footer").remove(),e=r("body").text().replace(/&nbsp;/g," ").trim()}catch(n){console.error(`Error crawling ${t}:`,n)}return e}class jB extends vh{static lc_name(){return"ChatDeepSeek"}_llmType(){return"deepseek"}get lc_secrets(){return{apiKey:"DEEPSEEK_API_KEY"}}constructor(e){const n=(e==null?void 0:e.apiKey)||fn("DEEPSEEK_API_KEY");if(!n)throw new Error('Deepseek API key not found. Please set the DEEPSEEK_API_KEY environment variable or pass the key into "apiKey" field.');super({...e,apiKey:n,configuration:{baseURL:"https://api.deepseek.com",...e==null?void 0:e.configuration}}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","deepseek"]})}_convertOpenAIDeltaToBaseMessageChunk(e,n,r){const s=super._convertOpenAIDeltaToBaseMessageChunk(e,n,r);return s.additional_kwargs.reasoning_content=e.reasoning_content,s}_convertOpenAIChatCompletionMessageToBaseMessage(e,n){const r=super._convertOpenAIChatCompletionMessageToBaseMessage(e,n);return r.additional_kwargs.reasoning_content=e.reasoning_content,r}withStructuredOutput(e,n){const r={...n};return(r==null?void 0:r.method)===void 0&&(r.method="functionCalling"),super.withStructuredOutput(e,r)}}async function HB(t,e,n){const r=await $A(e),s=r-n,a=r+n,i=await Jb(t);let o=[];for(let[u,c]of i.entries())u<s||u>a||o.push({link:`siyuan://blocks/${c.id}`,content:c.markdown});return o}let Tn;function km(t){Tn=t}async function $B(t){try{await navigator.clipboard.writeText(t)}catch{const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}}function qB(t,e){let n=[],r="";for(let[s,a]of t.entries())switch(s===t.length-1&&e.length>0?r=`${Tn.searchResults}${JSON.stringify(e)}

${Tn.answerBasedOnSearch}${a.content};`:r=a.content,!0){case a.role==="system":n.push(new Zd(r));break;case a.role==="assistant":n.push(new bs(r));break;case a.role==="user":a.image?n.push(new or({content:[{type:"text",text:r},{type:"image_url",image_url:{url:a.image}}]})):a.fileContent?n.push(new or(`${a.fileContent}

${r}`)):n.push(new or(r));break;case a.role==="image":break;default:n.push(new or(r));break}return n}async function du(t,e){let n=[],r=[],s=[],a="",i=e.isReason?`${Tn.thinking}

`:"",o=!1;if(e.isSearch){let l=e.messages[e.messages.length-1].content;l||(l=e.messages[e.messages.length-2].content);const d=new Jx({apiBase:f2,params:{format:"json",engines:"google,bing",numResults:3},headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}}),m=await FB(d,l);for(let[p,f]of m.entries()){if(f.link.includes("zhihu"))continue;p===0&&(a+=`${Tn.relatedWebPages}:

`);const g=await UB(f.link),b=await qw(g.replace(`
`,""),e.apiKey);console.debug(b),n.push(b),a+=`${Tn.webLink}: ${f.link}
`,e.callback(a),a+=`${Tn.title}:${f.title}
`,e.callback(a),a+=`${Tn.summary}: ${f.snippet}

`,e.callback(a)}a+=`

---------------------------------------
`}if(e.isKnowledge){const l=e.messages[e.messages.length-1].content,d=await e.knowledgeCallback(l);for(let m of d){const p=await HB(m.metadata.docId,m.metadata.blockId,3);r.push(JSON.stringify(p))}s=[...e.messages.splice(0,-1),{role:"user",content:Tn.knowledgeBasePrompt},{role:"assistant",content:`${Tn.retrievedContent}:
${r}`},{role:"user",content:e.messages[e.messages.length-1].content}],e.messages=s}let u=qB(e.messages,n);if(e.isStream){const l=await t.stream(u,{timeout:e.timeout*1e3});try{for await(const d of l)d.additional_kwargs&&d.additional_kwargs.reasoning_content&&(i+=d.additional_kwargs.reasoning_content.toString()),d.content&&(e.isReason&&!o&&(i+=`

--------- 
`),o=!0,a+=d.content.toString()),e.callback(i+a,!0)}catch{throw new Error("User interrupted")}finally{e.callback(i+a,!1)}return a}const c=await t.invoke(u,{timeout:e.timeout*1e3});return c.additional_kwargs.reasoning_content?(i+=c.additional_kwargs.reasoning_content.toString(),i+=`

--------- 
`,a+=c.content.toString(),e.callback(`${i}${a}`),a):(a+=c.content.toString(),e.callback(a),a)}async function So(t){let e="",n;try{switch(!0){case t.model.includes("claude"):n=new KP({model:t.model,apiKey:t.apiKey,anthropicApiUrl:`${ko}/claude`,maxTokens:t.maxTokens,temperature:t.temperature}),e=await du(n,t);break;case t.model.includes("deepseek-reasoner"):n=new jB({model:t.model,apiKey:t.apiKey,maxTokens:t.maxTokens,temperature:t.temperature,configuration:{baseURL:`${ko}/v1`}}),t.isReason=!0,e=await du(n,t);break;case t.model.includes("o3-mini"):n=new vh({openAIApiKey:t.apiKey,modelName:t.model,configuration:{baseURL:`${ko}/v1`}}),e=await du(n,t);break;default:n=new vh({openAIApiKey:t.apiKey,modelName:t.model,maxTokens:t.maxTokens,temperature:t.temperature,configuration:{baseURL:`${ko}/v1`,timeout:t.timeout*1e3}}),e=await du(n,t);break}t.isClipboard&&(document.body.focus(),await $B(e),Xs(Tn.contentCopied))}catch(r){return console.error(Tn.generateAnswerError,r),e}finally{return e}}async function VB(t,e){return await So({apiKey:e,model:"glm-4-flash",maxTokens:100,temperature:.5,timeout:90,isSearch:!1,isStream:!1,isClipboard:!1,callback:()=>{},messages:t})}async function qw(t,e){return await So({apiKey:e,model:"glm-4-flash",maxTokens:4e3,temperature:.5,timeout:90,isSearch:!1,isStream:!1,isClipboard:!1,callback:()=>{},messages:[{role:"system",content:""},{role:"user",content:t}]})}class Ao{constructor(e,n){Ie(this,"data");Ie(this,"plugin");Ie(this,"name");Ie(this,"file");Ie(this,"i18n");this.name=n,this.plugin=e,this.i18n=e.i18n}async customSaveData(e,n){n=n||this.file;const r=`/ai/${n}`;let s;return typeof e=="object"?s=new File([new Blob([JSON.stringify(e)],{type:"application/json"})],r.split("/").pop()):s=new File([new Blob([e])],r.split("/").pop()),g2(r,!1,s)}async customLoadData(e){e=e||this.file;const n=`/ai/${e}`;return new Promise(r=>{An.fetchPost("/api/file/getFile",{path:n},s=>{s.code!==404&&(this.data=s),r(this.data)})})}async load(){let e=await this.plugin.loadData(this.file);return e?this.data=e:this.save(),this.data}async save(e){return e=e??this.data,this.plugin.saveData(this.file,e),e}}class zB extends Ao{constructor(n,r,s,a,i,o){super(n,r);Ie(this,"apiKey");Ie(this,"documentVectorStorage");Ie(this,"data",new Map);Ie(this,"BATCH_SIZE",20);Ie(this,"MAX_CONTENT_LENGTH",510);Ie(this,"includeNotebooks");Ie(this,"excludeNotebooks");this.name=r??o_,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this.apiKey=s,this.documentVectorStorage=a,this.includeNotebooks=i,this.excludeNotebooks=o}async load(){return console.debug("BlockStorage load"),this.data.size===0&&(this.data=await this.documentVectorStorage.embeddingBlocks()),await this.knowledgeProcess(),await this.documentVectorStorage.release(),this.data}get(n){return this.data[n]}has(n){return this.data.has(n)}add(n,r){this.data.set(n,r)}async getDocuments(){const n=[],r=a=>{if(!Array.isArray(a)){console.warn(this.i18n.invalidNodesArray);return}a.forEach(i=>{var o;n.push(i.id),((o=i.children)==null?void 0:o.length)>0&&r(i.children)})},s=await qA();if(!s)return n;for(const a of s.notebooks)if(!(this.excludeNotebooks&&this.excludeNotebooks.includes(a.name))&&(this.includeNotebooks===""||this.includeNotebooks.includes(a.name))){const i=await b2(a.id,"/");r(i.tree)}return n}async getBlocks(){const n=[],r=new Set(["widget","iframe","audio"]);try{const s=await this.getDocuments();return await Promise.allSettled(s.map(async a=>{try{const o=(await Jb(a)).filter(u=>{var c;return!r.has(u.type)&&((c=u.content)==null?void 0:c.length)>2}).map(u=>({docId:a,blockId:u.id,content:u.content}));n.push(...o)}catch(i){console.error(` ${a} :`,i)}})),n}catch(s){return console.error(":",s),[]}}async blocksToInsert(){return console.debug("BlockStorage::blocksToInsert"),(await this.getBlocks()).filter(r=>!this.has(r.blockId))}async blocksToDelete(){console.debug("BlockStorage::blocksToDelete");const n=[];try{const r=await this.getBlocks(),s=new Set(r.map(a=>a.blockId));for(const[a,i]of this.data.entries())s.has(a)||(this.data.delete(a),n.push({blockId:a,docId:i}));return n}catch(r){return console.error("ID:",r),n}}async processSingleBlock(n){let r=n.content;const a=n.content.length>this.MAX_CONTENT_LENGTH;a&&(r=await qw(r,this.apiKey));const i=r.substring(0,this.MAX_CONTENT_LENGTH);return{blockId:n.blockId,docId:n.docId,content:i,isSummary:a}}async genBatchBlocks(n){const r=[];let s=[];for(const a of n){const i=await this.processSingleBlock(a);s.push({pageContent:i.content,metadata:{blockId:i.blockId,docId:i.docId,isSummary:i.isSummary},id:i.blockId}),s.length===this.BATCH_SIZE&&(r.push(s),s=[])}return s.length>0&&r.push(s),r}async knowledgeProcess(){const n=await this.blocksToInsert(),r=await this.genBatchBlocks(n),s=r.length;let a=0,i=0;for(const u of r){a++;const c=Math.round(a/s*100);c>=i+5&&(Xs(`${this.documentVectorStorage.i18n.knowledgeBaseProgress}: ${c}%`,2e3),i=c,await this.documentVectorStorage.save()),console.log(`${a}${s}`),await this.documentVectorStorage.addDocuments(u)}await this.documentVectorStorage.save(),Xs(this.documentVectorStorage.i18n.knowledgeReady,1e4);const o=await this.blocksToDelete();(o==null?void 0:o.length)>0&&this.documentVectorStorage.deleteDocuments(o)}}class WB extends Ao{constructor(n,r){super(n,r);Ie(this,"data",[{id:1,title:this.i18n.translation,time:"2025/1/22 17:06:59",messages:[{id:1,role:"system",content:this.i18n.defaultSystemPrompt},{id:2,role:"user",content:this.i18n.defaultTranslationExample},{id:3,role:"assistant",content:this.i18n.defaultTranslationResponse}]},{id:2,title:this.i18n.greeting,time:"2025/1/22 17:05:59",messages:[{id:1,role:"system",content:this.i18n.defaultSystemPrompt},{id:2,role:"user",content:this.i18n.helloMessage},{id:3,role:"assistant",content:this.i18n.helloResponse}]}]);this.name=r??i_,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`}add(n){return this.data.unshift(n),this.save()}update(n){const r=this.data.findIndex(s=>s.id===n.id);if(r!==-1)return this.data[r]=n,this.save()}updateMessage(n){return this.data=this.data.map(r=>({...r,messages:r.messages.map(s=>s.id===n.id?n:s)})),this.save()}delete(n){return this.data=this.data.filter(r=>r.id!==n),this.save()}deleteMessage(n){return this.data=this.data.map(r=>({...r,messages:r.messages.filter(s=>s.id!==n)})),this.save()}get(n){return this.data.find(r=>r.id===n)}set(n){return this.data.push(n),this.save()}dump(){return this.data}}class GB extends Ao{constructor(n,r){super(n,r);Ie(this,"data",[{id:0,title:this.i18n.translationPromptTitle,content:this.i18n.translationPromptContent},{id:1,title:this.i18n.extractTitlePromptTitle,content:this.i18n.extractTitlePromptContent}]);this.name=r??qd,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`}addPrompt(n){this.data=[...this.data,n],this.save()}updatePrompt(n){this.data=this.data.map(r=>r.id===n.id?n:r),this.save()}deletePrompt(n){this.data=this.data.filter(r=>r.id!==n),this.save()}get(n){return this.data.find(r=>r.id===n)}set(n){this.data.push(n),this.save()}}class KB extends Ao{constructor(n,r){super(n,r);Ie(this,"data",new Map);this.name=r??$d,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this._defaultSettings()}async load(){let n=await this.plugin.loadData(this.file);if(n){for(let[r,s]of this.data)if(r!=="modelSelections"){if(r==="isKnowledgeBaseInstruction"||r==="isKnowledgeBaseChat"){s.value=!1;continue}s.value=(n==null?void 0:n[r])??s.value}}else this.save();return n}async save(n){return n=n??this.dump(),await this.plugin.saveData(this.file,n),n}get(n){return this.data.get(n)}getValue(n){var s;let r=(s=this.data.get(n))==null?void 0:s.value;return n==="apiKey"&&(r==null?void 0:r.length)===0&&_a(this.i18n.pleaseConfigureApiKey,2e3),r}getSettingItems(n){let r=[];for(let[s,a]of this.data)n&&a.group!==n||r.push(a);return r}set(n,r){this.data.set(n,r)}setValue(n,r){let s=this.data.get(n);s.value=r}dump(){let n={};for(let[r,s]of this.data)n[r]=s.value;return n}_defaultSettings(){const n={group:" ",title:this.i18n.apiKeyTitle,description:this.i18n.apiKeyDescription,type:"textinput",key:"apiKey",value:"",placeholder:this.i18n.apiKeyPlaceholder};this.data.set(n.key,n);const r={group:" ",title:"",description:"[]",type:"checkbox",key:"isVectorOnline",value:!1};this.data.set(r.key,r);const s={group:" ",title:"",description:"[,]",type:"textinput",key:"phoneNumber",value:"",placeholder:""};this.data.set(s.key,s);const a={group:" ",title:this.i18n.excludeknowledgeBookTitle,description:this.i18n.excludeknowledgeBookDescription,type:"textinput",key:"excludeKnowledgeBook",value:"",placeholder:this.i18n.knowledgeBookPlaceholder};this.data.set(a.key,a);const i={group:" ",title:this.i18n.includeknowledgeBookTitle,description:this.i18n.includeknowledgeBookDescription,type:"textinput",key:"includeKnowledgeBook",value:"",placeholder:this.i18n.knowledgeBookPlaceholder};this.data.set(i.key,i);const o={group:"instruction",title:"",description:"token5",key:"knowledgeBaseRecallNumInstruction",type:"number",value:5};this.data.set(o.key,o);const u={group:"chat",title:"",description:"token5",key:"knowledgeBaseRecallNumChat",type:"number",value:5},c={group:"instructionIcon",title:this.i18n.searchInstructionTitle,description:this.i18n.searchInstructionDesc,type:"checkbox",key:"isSearchInstruction",value:!1};this.data.set(c.key,c);const l={group:"instruction",title:this.i18n.pageContentTitle,description:this.i18n.pageContentDesc,type:"checkbox",key:"isPageContent",value:!1};this.data.set(l.key,l);const d={group:"instruction",title:this.i18n.temperatureTitle,description:this.i18n.temperatureDesc,type:"slider",key:"temperatureInstruction",slider:{min:0,max:1,step:.1},value:.5};this.data.set(d.key,d);const m={group:"instruction",title:this.i18n.maxTokensTitle,description:this.i18n.maxTokensDesc,type:"number",key:"maxOutputLengthInstruction",value:4e3};this.data.set(m.key,m);const p={group:"custom",title:this.i18n.searchChatTitle,description:this.i18n.searchChatDesc,key:"isSearchChat",type:"checkbox",value:!1};this.data.set(p.key,p),this.data.set(u.key,u);const f={group:"chat",title:this.i18n.maxTokensTitle,description:this.i18n.maxTokensDesc,type:"number",key:"maxOutputLengthChat",value:4e3};this.data.set(f.key,f);const g={group:"instruction",title:this.i18n.responseTimeoutTitle,description:this.i18n.responseTimeoutDesc,type:"number",key:"responseTimeoutInstruction",value:90};this.data.set(g.key,g);const b={group:"chat",title:this.i18n.responseTimeoutTitle,description:this.i18n.responseTimeoutDesc,type:"number",key:"responseTimeoutChat",value:90};this.data.set(b.key,b);const _={group:"chat",title:this.i18n.temperatureTitle,description:this.i18n.temperatureDesc,type:"slider",key:"temperatureChat",slider:{min:0,max:1,step:.1},value:.5};this.data.set(_.key,_);const y={group:"custom",title:this.i18n.knowledgeBaseTitle,description:this.i18n.knowledgeBaseDesc,type:"checkbox",key:"isKnowledgeBaseInstruction",value:!1};this.data.set(y.key,y);const S={group:"custom",title:this.i18n.knowledgeBaseTitle,description:this.i18n.knowledgeBaseDesc,type:"checkbox",key:"isKnowledgeBaseChat",value:!1};this.data.set(S.key,S);const I={group:"model",title:this.i18n.modelTitle,description:this.i18n.modelDesc,type:"select",key:"modelSelections",value:"deepseek-chat",options:{"deepseek-chat":"DeepSeek V3","deepseek-reasoner":"DeepSeek R1","moonshot-v1-auto":"Moonshot Chat","glm-4-flash":"GLM 4 Flash","qwen-turbo-latest":"Qwen Turbo","qwen-plus-latest":"Qwen Plus","qwen-max-latest":"Qwen Max","doubao-1.5-lite-32k":"Doubao 1.5 Lite","doubao-1.5-pro-32k":"Doubao 1.5 Pro","gemini-2.0-flash-thinking-exp-01-21":"Gemini 2.0 Flash","gpt-4o-mini":"GPT 4o mini"}};this.data.set(I.key,I),this.load()}}function W0(t,e,n){const r=t.slice();return r[7]=e[n],r}function G0(t){let e,n,r,s=t[7].title+"",a,i,o,u=t[7].time+"",c,l,d,m,p,f;function g(){return t[5](t[7])}function b(){return t[6](t[7])}return{c(){e=V("div"),n=V("button"),r=V("span"),a=Qe(s),i=se(),o=V("div"),c=Qe(u),l=se(),d=V("button"),d.innerHTML='<svg viewBox="0 0 24 24" width="1rem" height="1rem" stroke="currentColor" stroke-width="2" fill="none" class="svelte-1beqtaw"><path d="M18 6L6 18M6 6l12 12"></path></svg>',m=se(),v(r,"class","svelte-1beqtaw"),v(o,"class","time svelte-1beqtaw"),v(n,"class","item-content svelte-1beqtaw"),v(d,"class","delete-btn svelte-1beqtaw"),v(d,"title",""),v(e,"class","list-item svelte-1beqtaw")},m(_,y){pe(_,e,y),N(e,n),N(n,r),N(r,a),N(n,i),N(n,o),N(o,c),N(e,l),N(e,d),N(e,m),p||(f=[ce(n,"click",g),ce(d,"click",WA(b))],p=!0)},p(_,y){t=_,y&2&&s!==(s=t[7].title+"")&&St(a,s),y&2&&u!==(u=t[7].time+"")&&St(c,u)},d(_){_&&me(e),p=!1,ut(f)}}}function YB(t){let e,n,r,s,a,i,o,u=t[0].i18n.newChat+"",c,l,d,m,p=On(t[1]),f=[];for(let g=0;g<p.length;g+=1)f[g]=G0(W0(t,p,g));return{c(){e=V("div"),n=V("div"),n.innerHTML='<h3 class="svelte-1beqtaw">SiYuan AI</h3>',r=se(),s=V("div"),a=V("button"),i=V("span"),o=Qe("+ "),c=Qe(u),l=se();for(let g=0;g<f.length;g+=1)f[g].c();v(n,"class","history-header svelte-1beqtaw"),v(i,"class","svelte-1beqtaw"),v(a,"class","new-chat-btn svelte-1beqtaw"),v(s,"class","list svelte-1beqtaw"),v(e,"class","history svelte-1beqtaw")},m(g,b){pe(g,e,b),N(e,n),N(e,r),N(e,s),N(s,a),N(a,i),N(i,o),N(i,c),N(s,l);for(let _=0;_<f.length;_+=1)f[_]&&f[_].m(s,null);d||(m=ce(a,"click",t[3]),d=!0)},p(g,[b]){if(b&1&&u!==(u=g[0].i18n.newChat+"")&&St(c,u),b&22){p=On(g[1]);let _;for(_=0;_<p.length;_+=1){const y=W0(g,p,_);f[_]?f[_].p(y,b):(f[_]=G0(y),f[_].c(),f[_].m(s,null))}for(;_<f.length;_+=1)f[_].d(1);f.length=p.length}},i:it,o:it,d(g){g&&me(e),Ac(f,g),d=!1,m()}}}function ZB(t,e,n){let{chatHistoryStorage:r}=e,s=r.dump();const a=Nr();function i(){const l={id:Date.now(),title:r.i18n.newChat,time:h2().format("YYYY/M/D HH:mm:ss"),messages:[{id:Date.now(),role:"system",content:"You are a helpful assistant. You can help me by answering my questions. You can also ask me questions."}]};r.add(l),n(1,s=r.dump()),a("selectChat",l)}function o(l){r.delete(l),r.data.length===0&&i(),n(1,s=r.dump()),a("selectChat",s[0])}const u=l=>a("selectChat",l),c=l=>o(l.id);return t.$$set=l=>{"chatHistoryStorage"in l&&n(0,r=l.chatHistoryStorage)},[r,s,a,i,o,u,c]}class JB extends dt{constructor(e){super(),lt(this,e,ZB,YB,ct,{chatHistoryStorage:0})}}function K0(t,e,n){const r=t.slice();return r[12]=e[n],r}function XB(t){var b;let e,n,r,s=t[1].Md2HTML(t[12].content)+"",a,i,o,u,c,l,d,m,p=((b=t[12])==null?void 0:b.fileContent)&&Y0(),f=t[12].role==="user"&&Z0(t);function g(){return t[8](t[12])}return{c(){e=V("div"),p&&p.c(),n=se(),r=V("div"),a=se(),i=V("div"),f&&f.c(),o=se(),u=V("button"),u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',c=se(),v(r,"class","message-content svelte-2nz1n6"),v(u,"class","action-btn svelte-2nz1n6"),v(i,"class","message-actions svelte-2nz1n6"),v(e,"class",l="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")},m(_,y){pe(_,e,y),p&&p.m(e,null),N(e,n),N(e,r),r.innerHTML=s,N(e,a),N(e,i),f&&f.m(i,null),N(i,o),N(i,u),N(e,c),d||(m=ce(u,"click",g),d=!0)},p(_,y){var S;t=_,(S=t[12])!=null&&S.fileContent?p||(p=Y0(),p.c(),p.m(e,n)):p&&(p.d(1),p=null),y&3&&s!==(s=t[1].Md2HTML(t[12].content)+"")&&(r.innerHTML=s),t[12].role==="user"?f?f.p(t,y):(f=Z0(t),f.c(),f.m(i,o)):f&&(f.d(1),f=null),y&1&&l!==(l="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")&&v(e,"class",l)},d(_){_&&me(e),p&&p.d(),f&&f.d(),d=!1,m()}}}function QB(t){let e,n,r=t[1].Md2HTML(`![User uploaded image](${t[12].image})

${t[12].content}`)+"",s,a,i,o,u,c,l,d,m=t[12].role==="user"&&J0(t);function p(){return t[6](t[12])}return{c(){e=V("div"),n=V("div"),s=se(),a=V("div"),m&&m.c(),i=se(),o=V("button"),o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',u=se(),v(n,"class","message-content svelte-2nz1n6"),v(o,"class","action-btn svelte-2nz1n6"),v(a,"class","message-actions svelte-2nz1n6"),v(e,"class",c="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")},m(f,g){pe(f,e,g),N(e,n),n.innerHTML=r,N(e,s),N(e,a),m&&m.m(a,null),N(a,i),N(a,o),N(e,u),l||(d=ce(o,"click",p),l=!0)},p(f,g){t=f,g&3&&r!==(r=t[1].Md2HTML(`![User uploaded image](${t[12].image})

${t[12].content}`)+"")&&(n.innerHTML=r),t[12].role==="user"?m?m.p(t,g):(m=J0(t),m.c(),m.m(a,i)):m&&(m.d(1),m=null),g&1&&c!==(c="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")&&v(e,"class",c)},d(f){f&&me(e),m&&m.d(),l=!1,d()}}}function Y0(t){let e;return{c(){e=V("span"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>',v(e,"class","file-icon svelte-2nz1n6")},m(n,r){pe(n,e,r)},d(n){n&&me(e)}}}function Z0(t){let e,n,r;function s(){return t[7](t[12])}return{c(){e=V("button"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><path d="M23 4v6h-6M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',v(e,"class","action-btn svelte-2nz1n6")},m(a,i){pe(a,e,i),n||(r=ce(e,"click",s),n=!0)},p(a,i){t=a},d(a){a&&me(e),n=!1,r()}}}function J0(t){let e,n,r;function s(){return t[5](t[12])}return{c(){e=V("button"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><path d="M23 4v6h-6M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',v(e,"class","action-btn svelte-2nz1n6")},m(a,i){pe(a,e,i),n||(r=ce(e,"click",s),n=!0)},p(a,i){t=a},d(a){a&&me(e),n=!1,r()}}}function X0(t){let e;function n(a,i){var o,u;return((u=(o=a[12])==null?void 0:o.image)==null?void 0:u.length)>0?QB:XB}let r=n(t),s=r(t);return{c(){s.c(),e=Cc()},m(a,i){s.m(a,i),pe(a,e,i)},p(a,i){r===(r=n(a))&&s?s.p(a,i):(s.d(1),s=r(a),s&&(s.c(),s.m(e.parentNode,e)))},d(a){a&&me(e),s.d(a)}}}function e9(t){let e,n,r=On(t[0].messages),s=[];for(let a=0;a<r.length;a+=1)s[a]=X0(K0(t,r,a));return{c(){e=V("div"),n=V("div");for(let a=0;a<s.length;a+=1)s[a].c();v(n,"class","messages-wrapper svelte-2nz1n6"),v(e,"class","message-container svelte-2nz1n6")},m(a,i){pe(a,e,i),N(e,n);for(let o=0;o<s.length;o+=1)s[o]&&s[o].m(n,null);t[9](e)},p(a,[i]){if(i&27){r=On(a[0].messages);let o;for(o=0;o<r.length;o+=1){const u=K0(a,r,o);s[o]?s[o].p(u,i):(s[o]=X0(u),s[o].c(),s[o].m(n,null))}for(;o<s.length;o+=1)s[o].d(1);s.length=r.length}},i:it,o:it,d(a){a&&me(e),Ac(s,a),t[9](null)}}}function t9(t,e,n){let{currentChat:r}=e,{lute:s}=e,a;const i=Nr();function o(){if(a){const g=a.scrollHeight,b=a.clientHeight,_=g-b;a.scrollTo({top:_,behavior:"smooth"})}}function u(g){i("edit",{message:g})}function c(g){i("delete",{message:g})}QA(()=>{var g;if(((g=r==null?void 0:r.messages)==null?void 0:g.length)>0){const b=r.messages[r.messages.length-1];(b==null?void 0:b.role)==="ai"&&setTimeout(o,50)}}),Oc(o);const l=g=>u(g),d=g=>c(g),m=g=>u(g),p=g=>c(g);function f(g){_e[g?"unshift":"push"](()=>{a=g,n(2,a)})}return t.$$set=g=>{"currentChat"in g&&n(0,r=g.currentChat),"lute"in g&&n(1,s=g.lute)},t.$$.update=()=>{if(t.$$.dirty&1&&r!=null&&r.messages){const g=r.messages[r.messages.length-1];(g==null?void 0:g.role)!=="user"&&g.content&&o()}},[r,s,a,u,c,l,d,m,p,f]}class n9 extends dt{constructor(e){super(),lt(this,e,t9,e9,ct,{currentChat:0,lute:1})}}function Q0(t,e,n){const r=t.slice();return r[0]=e[n][0],r[18]=e[n][1],r}function r9(t){let e,n,r,s,a,i,o;return{c(){e=V("div"),n=V("input"),v(n,"id","fontSize"),v(n,"min",r=t[5].min),v(n,"max",s=t[5].max),v(n,"step",a=t[5].step),v(n,"type","range"),v(n,"style",t[8]),Oe(n,"b3-slider",!0),Oe(n,"fn__size200",t[7]),v(e,"class","b3-tooltips b3-tooltips__n"),v(e,"aria-label",t[0])},m(u,c){pe(u,e,c),N(e,n),Dt(n,t[0]),i||(o=[ce(n,"change",t[16]),ce(n,"input",t[16]),ce(n,"change",t[10])],i=!0)},p(u,c){c&32&&r!==(r=u[5].min)&&v(n,"min",r),c&32&&s!==(s=u[5].max)&&v(n,"max",s),c&32&&a!==(a=u[5].step)&&v(n,"step",a),c&256&&v(n,"style",u[8]),c&17&&Dt(n,u[0]),c&128&&Oe(n,"fn__size200",u[7]),c&17&&v(e,"aria-label",u[0])},d(u){u&&me(e),i=!1,ut(o)}}}function s9(t){let e,n,r,s=On(Object.entries(t[4])),a=[];for(let i=0;i<s.length;i+=1)a[i]=eb(Q0(t,s,i));return{c(){e=V("select");for(let i=0;i<a.length;i+=1)a[i].c();v(e,"id","iconPosition"),v(e,"style",t[8]),t[0]===void 0&&Pu(()=>t[15].call(e)),Oe(e,"b3-select",!0),Oe(e,"fn__flex-center",!0),Oe(e,"fn__size200",t[7])},m(i,o){pe(i,e,o);for(let u=0;u<a.length;u+=1)a[u]&&a[u].m(e,null);ip(e,t[0],!0),n||(r=[ce(e,"change",t[15]),ce(e,"change",t[10])],n=!0)},p(i,o){if(o&16){s=On(Object.entries(i[4]));let u;for(u=0;u<s.length;u+=1){const c=Q0(i,s,u);a[u]?a[u].p(c,o):(a[u]=eb(c),a[u].c(),a[u].m(e,null))}for(;u<a.length;u+=1)a[u].d(1);a.length=s.length}o&256&&v(e,"style",i[8]),o&17&&ip(e,i[0]),o&128&&Oe(e,"fn__size200",i[7])},d(i){i&&me(e),Ac(a,i),n=!1,ut(r)}}}function a9(t){let e,n=t[6].label+"",r,s,a;return{c(){e=V("button"),r=Qe(n),v(e,"id",t[2]),v(e,"style",t[8]),Oe(e,"b3-button",!0),Oe(e,"b3-button--outline",!0),Oe(e,"fn__flex-center",!0),Oe(e,"fn__size200",t[7])},m(i,o){pe(i,e,o),N(e,r),s||(a=ce(e,"click",t[9]),s=!0)},p(i,o){o&64&&n!==(n=i[6].label+"")&&St(r,n),o&4&&v(e,"id",i[2]),o&256&&v(e,"style",i[8]),o&128&&Oe(e,"fn__size200",i[7])},d(i){i&&me(e),s=!1,a()}}}function i9(t){let e,n,r;return{c(){e=V("input"),v(e,"id",t[2]),v(e,"type","number"),v(e,"style",t[8]),Oe(e,"b3-text-field",!0),Oe(e,"fn__flex-center",!0),Oe(e,"fn__size200",t[7])},m(s,a){pe(s,e,a),Dt(e,t[0]),n||(r=[ce(e,"input",t[14]),ce(e,"change",t[10])],n=!0)},p(s,a){a&4&&v(e,"id",s[2]),a&256&&v(e,"style",s[8]),a&17&&Ud(e.value)!==s[0]&&Dt(e,s[0]),a&128&&Oe(e,"fn__size200",s[7])},d(s){s&&me(e),n=!1,ut(r)}}}function o9(t){let e,n,r,s;return{c(){e=V("textarea"),v(e,"class","b3-text-field fn__block"),v(e,"style",n=`resize: vertical; height: 10em; white-space: nowrap; ${t[8]}`)},m(a,i){pe(a,e,i),Dt(e,t[0]),r||(s=[ce(e,"input",t[13]),ce(e,"change",t[10])],r=!0)},p(a,i){i&256&&n!==(n=`resize: vertical; height: 10em; white-space: nowrap; ${a[8]}`)&&v(e,"style",n),i&17&&Dt(e,a[0])},d(a){a&&me(e),r=!1,ut(s)}}}function u9(t){let e,n,r;return{c(){e=V("input"),v(e,"id",t[2]),v(e,"placeholder",t[3]),v(e,"style",t[8]),Oe(e,"b3-text-field",!0),Oe(e,"fn__flex-center",!0),Oe(e,"fn__size200",t[7])},m(s,a){pe(s,e,a),Dt(e,t[0]),n||(r=[ce(e,"input",t[12]),ce(e,"change",t[10])],n=!0)},p(s,a){a&4&&v(e,"id",s[2]),a&8&&v(e,"placeholder",s[3]),a&256&&v(e,"style",s[8]),a&17&&e.value!==s[0]&&Dt(e,s[0]),a&128&&Oe(e,"fn__size200",s[7])},d(s){s&&me(e),n=!1,ut(r)}}}function c9(t){let e,n,r;return{c(){e=V("input"),v(e,"class","b3-switch fn__flex-center"),v(e,"id",t[2]),v(e,"type","checkbox"),v(e,"style",t[8])},m(s,a){pe(s,e,a),e.checked=t[0],n||(r=[ce(e,"change",t[11]),ce(e,"change",t[10])],n=!0)},p(s,a){a&4&&v(e,"id",s[2]),a&256&&v(e,"style",s[8]),a&17&&(e.checked=s[0])},d(s){s&&me(e),n=!1,ut(r)}}}function eb(t){let e,n=t[18]+"",r,s;return{c(){e=V("option"),r=Qe(n),e.__value=s=t[0],Dt(e,e.__value)},m(a,i){pe(a,e,i),N(e,r)},p(a,i){i&16&&n!==(n=a[18]+"")&&St(r,n),i&16&&s!==(s=a[0])&&(e.__value=s,Dt(e,e.__value))},d(a){a&&me(e)}}}function l9(t){let e;function n(a,i){if(a[1]==="checkbox")return c9;if(a[1]==="textinput")return u9;if(a[1]==="textarea")return o9;if(a[1]==="number")return i9;if(a[1]==="button")return a9;if(a[1]==="select")return s9;if(a[1]=="slider")return r9}let r=n(t),s=r&&r(t);return{c(){s&&s.c(),e=Cc()},m(a,i){s&&s.m(a,i),pe(a,e,i)},p(a,[i]){r===(r=n(a))&&s?s.p(a,i):(s&&s.d(1),s=r&&r(a),s&&(s.c(),s.m(e.parentNode,e)))},i:it,o:it,d(a){a&&me(e),s&&s.d(a)}}}function d9(t,e,n){let{type:r}=e,{key:s}=e,{value:a}=e,{placeholder:i=""}=e,{options:o={}}=e,{slider:u={min:0,max:100,step:1}}=e,{button:c={label:a,callback:()=>{}}}=e,{fnSize:l=!0}=e,{style:d=""}=e;const m=Nr();function p(){c==null||c.callback(),m("click",{key:s})}function f(){m("changed",{key:s,value:a})}function g(){a=this.checked,n(0,a),n(4,o)}function b(){a=this.value,n(0,a),n(4,o)}function _(){a=this.value,n(0,a),n(4,o)}function y(){a=Ud(this.value),n(0,a),n(4,o)}function S(){a=JA(this),n(0,a),n(4,o)}function I(){a=Ud(this.value),n(0,a),n(4,o)}return t.$$set=A=>{"type"in A&&n(1,r=A.type),"key"in A&&n(2,s=A.key),"value"in A&&n(0,a=A.value),"placeholder"in A&&n(3,i=A.placeholder),"options"in A&&n(4,o=A.options),"slider"in A&&n(5,u=A.slider),"button"in A&&n(6,c=A.button),"fnSize"in A&&n(7,l=A.fnSize),"style"in A&&n(8,d=A.style)},[a,r,s,i,o,u,c,l,d,p,f,g,b,_,y,S,I]}let pa=class extends dt{constructor(e){super(),lt(this,e,d9,l9,ct,{type:1,key:2,value:0,placeholder:3,options:4,slider:5,button:6,fnSize:7,style:8})}};function h9(t){let e,n,r,s,a,i,o=gc(t[1],t[3])+"",u,c,l,d;const m=t[5].default,p=Qh(m,t,t[4],null);return{c(){e=V("div"),n=V("div"),r=V("span"),s=Qe(t[0]),a=se(),i=V("div"),u=se(),c=V("span"),l=se(),p&&p.c(),v(r,"class","title svelte-ikiu6h"),v(i,"class","b3-label__text"),v(n,"class","fn__flex-1"),v(c,"class","fn__space"),v(e,"class","item-wrap fn__flex b3-label config__item svelte-ikiu6h")},m(f,g){pe(f,e,g),N(e,n),N(n,r),N(r,s),N(n,a),N(n,i),i.innerHTML=o,N(e,u),N(e,c),N(e,l),p&&p.m(e,null),d=!0},p(f,g){(!d||g&1)&&St(s,f[0]),(!d||g&10)&&o!==(o=gc(f[1],f[3])+"")&&(i.innerHTML=o),p&&p.p&&(!d||g&16)&&tf(p,m,f,f[4],d?ef(m,f[4],g,null):nf(f[4]),null)},i(f){d||(oe(p,f),d=!0)},o(f){he(p,f),d=!1},d(f){f&&me(e),p&&p.d(f)}}}function f9(t){let e,n,r,s,a,i,o=gc(t[1],t[3])+"",u,c,l,d,m;const p=t[5].default,f=Qh(p,t,t[4],null);return{c(){e=V("div"),n=V("div"),r=V("span"),s=Qe(t[0]),a=se(),i=V("div"),u=se(),c=V("div"),l=se(),d=V("div"),f&&f.c(),v(r,"class","title svelte-ikiu6h"),v(i,"class","b3-label__text"),v(c,"class","fn__hr"),jt(d,"display","flex"),jt(d,"flex-direction","column"),jt(d,"gap","5px"),jt(d,"position","relative"),v(n,"class","fn__block"),v(e,"class","item-wrap b3-label svelte-ikiu6h"),v(e,"data-key","CustomCSS")},m(g,b){pe(g,e,b),N(e,n),N(n,r),N(r,s),N(n,a),N(n,i),i.innerHTML=o,N(n,u),N(n,c),N(n,l),N(n,d),f&&f.m(d,null),m=!0},p(g,b){(!m||b&1)&&St(s,g[0]),(!m||b&10)&&o!==(o=gc(g[1],g[3])+"")&&(i.innerHTML=o),f&&f.p&&(!m||b&16)&&tf(f,p,g,g[4],m?ef(p,g[4],b,null):nf(g[4]),null)},i(g){m||(oe(f,g),m=!0)},o(g){he(f,g),m=!1},d(g){g&&me(e),f&&f.d(g)}}}function m9(t){let e,n,r,s;const a=[f9,h9],i=[];function o(u,c){return u[2]==="row"?0:1}return e=o(t),n=i[e]=a[e](t),{c(){n.c(),r=Cc()},m(u,c){i[e].m(u,c),pe(u,r,c),s=!0},p(u,[c]){let l=e;e=o(u),e===l?i[e].p(u,c):(Ar(),he(i[l],1,1,()=>{i[l]=null}),Cr(),n=i[e],n?n.p(u,c):(n=i[e]=a[e](u),n.c()),oe(n,1),n.m(r.parentNode,r))},i(u){s||(oe(n),s=!0)},o(u){he(n),s=!1},d(u){u&&me(r),i[e].d(u)}}}function gc(t,e=!1){return e&&t.length>20?t.slice(0,20)+"...":t}function p9(t,e,n){let{$$slots:r={},$$scope:s}=e,{title:a}=e,{description:i}=e,{direction:o="column"}=e,{isSimple:u=!1}=e;return t.$$set=c=>{"title"in c&&n(0,a=c.title),"description"in c&&n(1,i=c.description),"direction"in c&&n(2,o=c.direction),"isSimple"in c&&n(3,u=c.isSimple),"$$scope"in c&&n(4,s=c.$$scope)},[a,i,o,u,s,r]}class g9 extends dt{constructor(e){super(),lt(this,e,p9,m9,ct,{title:0,description:1,direction:2,isSimple:3})}}const Vw={Wrap:g9,Input:pa};async function Xi(t){if(!t||t.length==0)return[0,0];const e={method:"POST",url:atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTQ5MjgvYWRtaW4tYXBpL2FpZ2MvYmFsYW5jZS90b2tlbg"),headers:{"content-type":"application/json"},data:{apikey:t.replace("sk-","")}};let n=await Xe.request(e);return!n||n.status!=200?[0,0]:n.data.data}function b9(t){let e,n,r,s=t[0].balanceQuery+"",a,i,o,u=t[0].accountBalance+"",c,l,d,m,p,f,g=t[0].validUntil+"",b,_,y=new Date(t[3]).toLocaleString()+"",S,I,A,O,w,L=t[0].refresh+"",D,B,ee;return{c(){e=V("label"),n=V("div"),r=V("span"),a=Qe(s),i=se(),o=V("div"),c=Qe(u),l=Qe(" : "),d=Qe(t[2]),m=Qe(` 
      `),p=V("br"),f=se(),b=Qe(g),_=Qe(" : "),S=Qe(y),I=se(),A=V("span"),O=se(),w=V("button"),D=Qe(L),v(r,"class","title"),v(o,"class","b3-label__text"),v(n,"class","fn__flex-1"),v(A,"class","fn__space"),v(w,"class","b3-button b3-button--outline fn__flex-center fn__size200"),v(e,"class","item-wrap fn__flex b3-label config__item")},m(K,Q){pe(K,e,Q),N(e,n),N(n,r),N(r,a),N(n,i),N(n,o),N(o,c),N(o,l),N(o,d),N(o,m),N(o,p),N(o,f),N(o,b),N(o,_),N(o,S),N(e,I),N(e,A),N(e,O),N(e,w),N(w,D),B||(ee=ce(w,"click",t[4]),B=!0)},p(K,[Q]){Q&1&&s!==(s=K[0].balanceQuery+"")&&St(a,s),Q&1&&u!==(u=K[0].accountBalance+"")&&St(c,u),Q&4&&St(d,K[2]),Q&1&&g!==(g=K[0].validUntil+"")&&St(b,g),Q&8&&y!==(y=new Date(K[3]).toLocaleString()+"")&&St(S,y),Q&1&&L!==(L=K[0].refresh+"")&&St(D,L)},i:it,o:it,d(K){K&&me(e),B=!1,ee()}}}function _9(t,e,n){let{i18n:r}=e,{apiKey:s}=e,a=0,i=0;Oc(async()=>{await Xi(s).then(u=>{n(2,a=Math.round(u.money*10)/10),n(3,i=u.expiredTime*1e3)})});const o=async()=>{Xi(s).then(u=>{n(3,i=u.expiredTime*1e3),n(2,a=Math.round(u.money*10)/10)})};return t.$$set=u=>{"i18n"in u&&n(0,r=u.i18n),"apiKey"in u&&n(1,s=u.apiKey)},[r,s,a,i,o]}let y9=class extends dt{constructor(e){super(),lt(this,e,_9,b9,ct,{i18n:0,apiKey:1})}};function tb(t,e,n){const r=t.slice();return r[13]=e[n],r[14]=e,r[15]=n,r}function E9(t){var i,o,u,c;let e,n,r;function s(l){t[10](l,t[13])}let a={type:t[13].type,key:t[13].key,placeholder:(i=t[13])==null?void 0:i.placeholder,options:(o=t[13])==null?void 0:o.options,slider:(u=t[13])==null?void 0:u.slider,button:(c=t[13])==null?void 0:c.button};return t[13].value!==void 0&&(a.value=t[13].value),e=new Vw.Input({props:a}),_e.push(()=>Ne(e,"value",s)),e.$on("click",t[6]),e.$on("changed",t[7]),{c(){Ye(e.$$.fragment)},m(l,d){ze(e,l,d),r=!0},p(l,d){var p,f,g,b;t=l;const m={};d&4&&(m.type=t[13].type),d&4&&(m.key=t[13].key),d&4&&(m.placeholder=(p=t[13])==null?void 0:p.placeholder),d&4&&(m.options=(f=t[13])==null?void 0:f.options),d&4&&(m.slider=(g=t[13])==null?void 0:g.slider),d&4&&(m.button=(b=t[13])==null?void 0:b.button),!n&&d&4&&(n=!0,m.value=t[13].value,ke(()=>n=!1)),e.$set(m)},i(l){r||(oe(e.$$.fragment,l),r=!0)},o(l){he(e.$$.fragment,l),r=!1},d(l){We(e,l)}}}function nb(t,e){var a;let n,r,s;return r=new Vw.Wrap({props:{title:e[13].title,description:e[13].description,direction:(a=e[13])==null?void 0:a.direction,$$slots:{default:[E9]},$$scope:{ctx:e}}}),{key:t,first:null,c(){n=Cc(),Ye(r.$$.fragment),this.first=n},m(i,o){pe(i,n,o),ze(r,i,o),s=!0},p(i,o){var c;e=i;const u={};o&4&&(u.title=e[13].title),o&4&&(u.description=e[13].description),o&4&&(u.direction=(c=e[13])==null?void 0:c.direction),o&2052&&(u.$$scope={dirty:o,ctx:e}),r.$set(u)},i(i){s||(oe(r.$$.fragment,i),s=!0)},o(i){he(r.$$.fragment,i),s=!1},d(i){i&&me(n),We(r,i)}}}function rb(t){let e,n;return e=new y9({props:{apiKey:t[1].getValue("apiKey"),i18n:t[5]}}),{c(){Ye(e.$$.fragment)},m(r,s){ze(e,r,s),n=!0},p(r,s){const a={};s&2&&(a.apiKey=r[1].getValue("apiKey")),e.$set(a)},i(r){n||(oe(e.$$.fragment,r),n=!0)},o(r){he(e.$$.fragment,r),n=!1},d(r){We(e,r)}}}function sb(t){let e=t[5].buyKeyOnTaobao+"",n,r,s;return{c(){n=Qe(e),r=se(),s=V("div"),s.innerHTML='<img src="https://pub-a4fc15e05e5b45ae93e81825f01bfb69.r2.dev/file-repository/files/taobao.png" alt="" style="max-width: 200px; height: auto;"/>',v(s,"class","config__img-container")},m(a,i){pe(a,n,i),pe(a,r,i),pe(a,s,i)},p:it,d(a){a&&(me(n),me(r),me(s))}}}function w9(t){let e,n,r=[],s=new Map,a,i,o,u;const c=t[9].default,l=Qh(c,t,t[11],null);let d=On(t[2]);const m=g=>g[13].key;for(let g=0;g<d.length;g+=1){let b=tb(t,d,g),_=m(b);s.set(_,r[g]=nb(_,b))}let p=t[3]&&rb(t),f=t[3]&&sb(t);return{c(){e=V("div"),l&&l.c(),n=se();for(let g=0;g<r.length;g+=1)r[g].c();a=se(),p&&p.c(),i=se(),f&&f.c(),v(e,"class",o="config__tab-container "+t[4]),v(e,"data-name",t[0])},m(g,b){pe(g,e,b),l&&l.m(e,null),N(e,n);for(let _=0;_<r.length;_+=1)r[_]&&r[_].m(e,null);N(e,a),p&&p.m(e,null),N(e,i),f&&f.m(e,null),u=!0},p(g,[b]){l&&l.p&&(!u||b&2048)&&tf(l,c,g,g[11],u?ef(c,g[11],b,null):nf(g[11]),null),b&196&&(d=On(g[2]),Ar(),r=s_(r,b,m,1,g,d,s,e,i2,nb,a,tb),Cr()),g[3]?p?(p.p(g,b),b&8&&oe(p,1)):(p=rb(g),p.c(),oe(p,1),p.m(e,i)):p&&(Ar(),he(p,1,1,()=>{p=null}),Cr()),g[3]?f?f.p(g,b):(f=sb(g),f.c(),f.m(e,null)):f&&(f.d(1),f=null),(!u||b&16&&o!==(o="config__tab-container "+g[4]))&&v(e,"class",o),(!u||b&1)&&v(e,"data-name",g[0])},i(g){if(!u){oe(l,g);for(let b=0;b<d.length;b+=1)oe(r[b]);oe(p),u=!0}},o(g){he(l,g);for(let b=0;b<r.length;b+=1)he(r[b]);he(p),u=!1},d(g){g&&me(e),l&&l.d(g);for(let b=0;b<r.length;b+=1)r[b].d();p&&p.d(),f&&f.d()}}}function T9(t,e,n){let r,s,{$$slots:a={},$$scope:i}=e,{group:o}=e,{settingStorage:u}=e,{display:c=!0}=e,l=u.getSettingItems(o);const d=u.plugin.i18n,m=Nr();function p({detail:b}){m("click",{key:b.key})}function f({detail:b}){m("changed",{group:o,...b})}function g(b,_){t.$$.not_equal(_.value,b)&&(_.value=b,n(2,l))}return t.$$set=b=>{"group"in b&&n(0,o=b.group),"settingStorage"in b&&n(1,u=b.settingStorage),"display"in b&&n(8,c=b.display),"$$scope"in b&&n(11,i=b.$$scope)},t.$$.update=()=>{t.$$.dirty&256&&n(4,r=c?"":"fn__none"),t.$$.dirty&1&&n(3,s=o===" ")},[o,u,l,s,r,d,p,f,c,a,g,i]}class zw extends dt{constructor(e){super(),lt(this,e,T9,w9,ct,{group:0,settingStorage:1,display:8})}}function S9(t){let e,n,r;return n=new zw({props:{group:t[1],settingStorage:t[0],display:!0}}),n.$on("changed",t[2]),{c(){e=V("div"),Ye(n.$$.fragment),jt(e,"margin-top","10px"),jt(e,"padding","10px"),jt(e,"background","none"),jt(e,"border-radius","4px"),jt(e,"border","1px solid var(--b3-border-color)")},m(s,a){pe(s,e,a),ze(n,e,null),r=!0},p(s,[a]){const i={};a&2&&(i.group=s[1]),a&1&&(i.settingStorage=s[0]),n.$set(i)},i(s){r||(oe(n.$$.fragment,s),r=!0)},o(s){he(n.$$.fragment,s),r=!1},d(s){s&&me(e),We(n)}}}function A9(t,e,n){let{settingStorage:r}=e,{group:s}=e;const a=({detail:i})=>{r.setValue(i.key,i.value),r.save()};return t.$$set=i=>{"settingStorage"in i&&n(0,r=i.settingStorage),"group"in i&&n(1,s=i.group)},[r,s,a]}class Ww extends dt{constructor(e){super(),lt(this,e,A9,S9,ct,{settingStorage:0,group:1})}}class Js{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent!==void 0?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}const ss=class ss{async embedDocuments(e){const n=await this.requestEmbedding({inputs:e});if(!n||!n.data)throw console.debug("Failed to get embedding"),new Error("Failed to get embedding");return n.data.data.map(r=>r.embedding)}async embedQuery(e){const n=await this.requestEmbedding({inputs:e});if(!n||!n.data)throw console.debug("Failed to get embedding"),new Error("Failed to get embedding");return n.data.data[0].embedding}async requestEmbedding(e){return await this.retryRequest(0,e)}async retryRequest(e,n){try{const r=typeof n.inputs=="string"?Math.random()<.97?up:op:Math.random()<.97?op:up;return await Xe.post(r,n)}catch{if(e<ss.MAX_RETRIES)return console.debug(`${ss.RETRY_DELAY/1e3}${e+1}`),await new Promise(s=>setTimeout(s,ss.RETRY_DELAY)),this.retryRequest(e+1,n)}}};Ie(ss,"MAX_RETRIES",3),Ie(ss,"RETRY_DELAY",1e3);let Gh=ss;class C9 extends bt{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,n){throw new Error("Not implemented!")}async invoke(e,n){return this.getRelevantDocuments(e,Ue(n))}async getRelevantDocuments(e,n){const r=Ue(Ey(n)),s=await Lt.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName));try{const i=await this._getRelevantDocuments(e,a);return await(a==null?void 0:a.handleRetrieverEnd(i)),i}catch(i){throw await(a==null?void 0:a.handleRetrieverError(i)),i}}}class kd extends C9{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,n){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},n==null?void 0:n.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,n==null?void 0:n.getChild("vectorstore"))}async addDocuments(e,n){return this.vectorStore.addDocuments(e,n)}}class O9 extends Vr{constructor(e,n){super(n),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,n=4,r=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)).map(i=>i[0])}async similaritySearchWithScore(e,n=4,r=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)}static fromTexts(e,n,r,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,n,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,n,r,s,a,i){if(typeof e=="number")return new kd({vectorStore:this,k:e,filter:n,tags:[...s??[],this._vectorstoreType()],metadata:a,verbose:i,callbacks:r});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new kd({...o,searchKwargs:e.searchKwargs}):new kd({...o})}}}function v9(t,e){let n=0,r=0,s=0;for(let a=0;a<t.length;a++)n+=t[a]*e[a],r+=t[a]*t[a],s+=e[a]*e[a];return n/(Math.sqrt(r)*Math.sqrt(s))}function I9(t,e){let n=0,r=0,s=0;for(let a=0;a<t.length;a++)n+=t[a]*e[a],r+=t[a]*t[a],s+=e[a]*e[a];return n/(Math.sqrt(r)*Math.sqrt(s))}function k9(t,e,n){if(t.length===0||t[0].length===0||e.length===0||e[0].length===0)return[[]];if(t[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[t.length,t[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return t.map(r=>e.map(s=>n(r,s)).map(s=>Number.isNaN(s)?0:s))}function ab(t,e){return k9(t,e,I9)}function N9(t,e,n=.5,r=4){if(Math.min(r,e.length)<=0)return[];const s=Array.isArray(t[0])?t:[t],a=ab(s,e)[0],i=R9(a).maxIndex,o=[e[i]],u=[i];for(;u.length<Math.min(r,e.length);){let c=-1/0,l=-1;const d=ab(e,o);a.forEach((m,p)=>{if(u.includes(p))return;const f=Math.max(...d[p]),g=n*m-(1-n)*f;g>c&&(c=g,l=p)}),o.push(e[l]),u.push(l)}return u}function R9(t){if(t.length===0)return{maxIndex:-1,maxValue:NaN};let e=t[0],n=0;for(let r=1;r<t.length;r+=1)t[r]>e&&(n=r,e=t[r]);return{maxIndex:n,maxValue:e}}class Nm extends O9{_vectorstoreType(){return"memory"}constructor(e,{similarity:n,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=n??v9}async addDocuments(e){const n=e.map(({pageContent:r})=>r);return this.addVectors(await this.embeddings.embedDocuments(n),e)}async addVectors(e,n){const r=e.map((s,a)=>({content:n[a].pageContent,embedding:s,metadata:n[a].metadata,id:n[a].id}));this.memoryVectors=this.memoryVectors.concat(r)}async _queryVectors(e,n,r){const s=i=>{if(!r)return!0;const o=new Js({metadata:i.metadata,pageContent:i.content,id:i.id});return r(o)};return this.memoryVectors.filter(s).map((i,o)=>({similarity:this.similarity(e,i.embedding),index:o,metadata:i.metadata,content:i.content,embedding:i.embedding,id:i.id})).sort((i,o)=>i.similarity>o.similarity?-1:0).slice(0,n)}async similaritySearchVectorWithScore(e,n,r){return(await this._queryVectors(e,n,r)).map(i=>[new Js({metadata:i.metadata,pageContent:i.content,id:i.id}),i.similarity])}async maxMarginalRelevanceSearch(e,n){const r=await this.embeddings.embedQuery(e),s=await this._queryVectors(r,n.fetchK??20,n.filter),a=s.map(o=>o.embedding);return N9(r,a,n.lambda,n.k).map(o=>new Js({metadata:s[o].metadata,pageContent:s[o].content,id:s[o].id}))}static async fromTexts(e,n,r,s){const a=[];for(let i=0;i<e.length;i+=1){const o=Array.isArray(n)?n[i]:n,u=new Js({pageContent:e[i],metadata:o});a.push(u)}return Nm.fromDocuments(a,r,s)}static async fromDocuments(e,n,r){const s=new this(n,r);return await s.addDocuments(e),s}static async fromExistingIndex(e,n){return new this(e,n)}}class Gw extends Ao{constructor(n,r,s,a){super(n,r);Ie(this,"apiKey");Ie(this,"phone");this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this.apiKey=s,this.phone=a}}class P9 extends Gw{constructor(n,r,s,a){super(n,r,s,a);Ie(this,"memoryVectorStore");Ie(this,"embeddingService");this.name=r??Vd,this.plugin.removeData(this.file),this.embeddingService=new Gh,this.memoryVectorStore=new Nm(this.embeddingService)}async customLoadData(n){console.debug("MemoryVectorStorage::customLoadData"),n=n||this.file;const r=`/ai/${n}`,s=await p2(r);return(s==null?void 0:s.code)==404?[]:s}async load(){console.debug("MemoryVectorStorage::load");const n=await Xi(this.apiKey);if((n==null?void 0:n.money)>0&&(n==null?void 0:n.expiredTime)>Math.floor(Date.now()/1e3)){const r=await this.customLoadData(this.file);r&&(this.memoryVectorStore.memoryVectors=r)}}async save(){console.debug("MemoryVectorStorage::save"),await this.customSaveData(this.memoryVectorStore.memoryVectors)}async release(){console.debug("MemoryVectorStorage::release"),this.memoryVectorStore.memoryVectors=[]}async embeddingBlocks(){console.debug("MemoryVectorStorage::embeddingBlocks"),await this.load();let n=new Map;return this.memoryVectorStore.memoryVectors.map(r=>{n.set(r.metadata.blockId,r.metadata.docId)}),n}async getDocuments(){return console.debug("MemoryVectorStorage::getDocuments"),this.memoryVectorStore.memoryVectors.map(n=>new Js({pageContent:n.content,metadata:n.metadata}))}async addDocuments(n){console.debug("MemoryVectorStorage::addDocuments");const r=n.map(a=>a.pageContent),s=await this.embeddingService.embedDocuments(r);return await this.memoryVectorStore.addVectors(s,n),!0}async deleteDocument(n){console.debug("MemoryVectorStorage::deleteDocument");const r=this.memoryVectorStore.memoryVectors.findIndex(s=>s.metadata.blockId===n.blockId);return r!==-1?(this.memoryVectorStore.memoryVectors.splice(r,1),await this.save(),!0):!1}async deleteDocuments(n){console.debug("MemoryVectorStorage::deleteDocuments");const r=new Set(n.map(s=>s.blockId));return this.memoryVectorStore.memoryVectors=this.memoryVectorStore.memoryVectors.filter(s=>!r.has(s.metadata.blockId)),await this.save(),!0}async addVectors(n,r){return console.debug("MemoryVectorStorage::addVectors"),this.memoryVectorStore.addVectors(n,r)}async similaritySearch(n,r=3){return console.debug("MemoryVectorStorage::similaritySearch"),this.memoryVectorStore.similaritySearch(n,r)}async similaritySearchWithScore(n,r=3){return console.debug("MemoryVectorStorage::similaritySearchWithScore"),this.memoryVectorStore.similaritySearchWithScore(n,r)}}class x9 extends Gw{constructor(n,r,s,a){super(n,r,s,a);Ie(this,"baseUrl",m2)}async embeddingBlocks(){console.debug("MilvusVectorStorage::embeddingBlocks");const n={phone:this.phone},r=await Xe.post(`${this.baseUrl}/list`,n);let s=new Map;return r.data.map(a=>{s.set(a.block_id,a.document_id)}),s}async release(){}async save(n){}async load(){}transformDocumentToRequestData(n){return{phone:this.phone,block_id:n.metadata.blockId,document_id:n.metadata.docId,content:n.pageContent,is_summary:n.metadata.isSummary}}async makeRequest(n,r){try{return(await Xe.post(`${this.baseUrl}${n}`,r)).status===200}catch(s){return console.error(`API: ${n}`,s),!1}}async getDocuments(){try{const n=await Xe.post(`${this.baseUrl}/list`,{phone:this.phone});return n.status===200?n.data.map(r=>this.transformHitToDocument(r)):[]}catch(n){return console.error(":",n),[]}}async addDocuments(n){const r=n.map(this.transformDocumentToRequestData.bind(this));return this.makeRequest("/add",r)}async deleteDocument(n){console.debug("MilvusVectorStorage::deleteDocument");const r=[{phone:this.phone,block_id:n.blockId,document_id:n.docId}];return this.makeRequest("/delete",r)}async deleteDocuments(n){console.debug("MilvusVectorStorage::deleteDocuments",n);const r=n.map(s=>({phone:this.phone,block_id:s.blockId,document_id:s.docId}));return this.makeRequest("/delete",r)}async addVectors(n,r){}transformHitToDocument(n){return new Js({pageContent:n.content,metadata:{blockId:n.block_id,docId:n.document_id,isSummary:n.is_summary}})}async similaritySearch(n,r){try{const s=await Xe.post(`${this.baseUrl}/search`,{phone:this.phone,query:n,top_k:r});return s.status===200?s.data.map(a=>this.transformHitToDocument(a)):[]}catch(s){return console.error(":",s),[]}}async similaritySearchWithScore(n,r){try{const s=await Xe.post(`${this.baseUrl}/search`,{phone:this.phone,query:n,top_k:r});return s.status===200?s.data.map(a=>[this.transformHitToDocument(a),a.distance]):[]}catch(s){return console.error(":",s),[]}}}function ib(t){let e,n=t[7]?"":"...",r,s,a,i;return{c(){e=V("button"),r=Qe(n),v(e,"type","button"),v(e,"class","generation-text svelte-k9nhz1"),v(e,"aria-label",s=t[7]?"":"...")},m(o,u){pe(o,e,u),N(e,r),a||(i=[ce(e,"mouseenter",t[17]),ce(e,"mouseleave",t[18]),ce(e,"click",t[9]),ce(e,"keydown",t[19])],a=!0)},p(o,u){u&128&&n!==(n=o[7]?"":"...")&&St(r,n),u&128&&s!==(s=o[7]?"":"...")&&v(e,"aria-label",s)},d(o){o&&me(e),a=!1,ut(i)}}}function L9(t){let e,n,r,s,a,i,o,u,c,l,d,m,p,f,g,b,_,y,S,I,A,O,w,L,D,B,ee,K,Q,x,k=t[6]&&ib(t);function F(M){t[20](M)}let q={type:"select",key:"modelSelections",fnSize:!1,options:t[5].get("modelSelections").options,style:"margin-right: 6px; font-size: 12px; padding: 2px 4px; border-radius: 4px; border: none ;outline: none; height: 2em; background: transparent; align-self: center;margin-left: auto;"};return t[0]!==void 0&&(q.value=t[0]),B=new pa({props:q}),_e.push(()=>Ne(B,"value",F)),B.$on("changed",t[21]),{c(){e=V("div"),n=V("button"),r=cn("svg"),s=cn("path"),a=cn("path"),i=se(),o=V("button"),u=cn("svg"),c=cn("path"),l=se(),d=V("button"),m=cn("svg"),p=cn("path"),f=se(),g=V("button"),b=V("input"),_=se(),y=V("label"),y.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" class="svelte-k9nhz1"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><path d="M13 2v7h7"></path></svg>',S=se(),I=V("button"),A=V("input"),O=se(),w=V("label"),w.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" class="svelte-k9nhz1"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></svg>',L=se(),k&&k.c(),D=se(),Ye(B.$$.fragment),v(s,"d","M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"),v(a,"d","M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"),v(r,"viewBox","0 0 24 24"),v(r,"width","16"),v(r,"height","16"),v(r,"stroke","currentColor"),v(r,"stroke-width","2"),v(r,"fill","none"),v(r,"class","svelte-k9nhz1"),v(n,"title",t[8].settings),v(n,"class","svelte-k9nhz1"),v(c,"d","M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"),v(u,"viewBox","0 0 24 24"),v(u,"width","16"),v(u,"height","16"),v(u,"stroke","currentColor"),v(u,"stroke-width","2"),v(u,"fill","none"),v(u,"class","svelte-k9nhz1"),v(o,"title",t[8].onlineSearch),v(o,"class","svelte-k9nhz1"),Oe(o,"active",t[1]),v(p,"d","M21 5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5zm-2 14H5V5h14v14zM7 15h10v2H7v-2zm0-4h10v2H7v-2zm0-4h10v2H7V7z"),v(m,"viewBox","0 0 24 24"),v(m,"width","16"),v(m,"height","16"),v(m,"stroke","currentColor"),v(m,"stroke-width","2"),v(m,"fill","none"),v(m,"class","svelte-k9nhz1"),v(d,"title",t[8].knowledgeBase),v(d,"class","svelte-k9nhz1"),Oe(d,"active",t[2]),v(b,"type","file"),v(b,"accept",".pdf,.docx,.md,.txt"),jt(b,"display","none"),v(b,"id","file-upload"),v(y,"for","file-upload"),jt(y,"cursor","pointer"),v(g,"title",t[8].file),v(g,"class","svelte-k9nhz1"),Oe(g,"active",t[4].length>0),v(A,"type","file"),v(A,"accept","image/*"),jt(A,"display","none"),v(A,"id","image-upload"),v(w,"for","image-upload"),jt(w,"cursor","pointer"),v(I,"title",t[8].image),v(I,"class","svelte-k9nhz1"),Oe(I,"active",t[3].length>0),v(e,"class","tools-container svelte-k9nhz1")},m(M,z){pe(M,e,z),N(e,n),N(n,r),N(r,s),N(r,a),N(e,i),N(e,o),N(o,u),N(u,c),N(e,l),N(e,d),N(d,m),N(m,p),N(e,f),N(e,g),N(g,b),N(g,_),N(g,y),N(e,S),N(e,I),N(I,A),N(I,O),N(I,w),N(e,L),k&&k.m(e,null),N(e,D),ze(B,e,null),K=!0,Q||(x=[ce(n,"click",t[13]),ce(o,"click",t[11]),ce(d,"click",t[12]),ce(b,"change",t[10]),ce(A,"change",t[14])],Q=!0)},p(M,[z]){(!K||z&2)&&Oe(o,"active",M[1]),(!K||z&4)&&Oe(d,"active",M[2]),(!K||z&16)&&Oe(g,"active",M[4].length>0),(!K||z&8)&&Oe(I,"active",M[3].length>0),M[6]?k?k.p(M,z):(k=ib(M),k.c(),k.m(e,D)):k&&(k.d(1),k=null);const X={};z&32&&(X.options=M[5].get("modelSelections").options),!ee&&z&1&&(ee=!0,X.value=M[0],ke(()=>ee=!1)),B.$set(X)},i(M){K||(oe(B.$$.fragment,M),K=!0)},o(M){he(B.$$.fragment,M),K=!1},d(M){M&&me(e),k&&k.d(),We(B),Q=!1,ut(x)}}}function D9(t,e,n){let{settingStorage:r}=e,{documentVectorStorage:s}=e,{selectedModel:a}=e,{isSearchEnabled:i}=e,{isKnowledgeEnabled:o}=e,{imageUrl:u=""}=e,{fileContent:c=""}=e,{isInterrupted:l=!1}=e,{isGenerating:d=!1}=e,m=r.i18n,p=!1;function f(){n(15,l=!0)}async function g(D){var B,ee;try{const K=D.target,Q=(B=K.files)==null?void 0:B[0];if(!Q)return;switch((ee=Q.name.split(".").pop())==null?void 0:ee.toLowerCase()){case"txt":case"csv":case"md":const k=new FileReader;k.onload=F=>{var q;(q=F.target)!=null&&q.result&&(n(4,c=F.target.result),console.debug(c))},k.readAsText(Q);break;case"pdf":_a(m.pdfParsingInDev);break;default:throw new Error(m.supportedFileTypes)}K.value=""}catch(K){console.error(m.fileProcessingFailed,K),n(4,c="")}}function b(){n(1,i=!i),r.setValue("isSearchChat",i),r.save()}async function _(){n(2,o=!o),r.setValue("isKnowledgeBaseChat",o),r.save(),o?await s.load():(await s.save(),await s.release())}function y(){const D=new An.Dialog({title:"",content:'<div id="chat-params-panel" style="height: 100%; margin:0px; padding:0px;"></div>',width:"40%",height:"40%",hideCloseIcon:!0});new Ww({target:D.element.querySelector("#chat-params-panel"),props:{settingStorage:r,group:"chat"}})}async function S(D){var K;const ee=(K=D.target.files)==null?void 0:K[0];if(ee)try{const Q=new FileReader;Q.onload=x=>{var k;(k=x.target)!=null&&k.result&&n(3,u=x.target.result)},console.debug(u),Q.readAsDataURL(ee)}catch(Q){console.error(m.imageProcessingFailed,Q)}}const I=()=>n(7,p=!0),A=()=>n(7,p=!1),O=D=>D.key==="Enter"&&f();function w(D){a=D,n(0,a)}const L=({detail:D})=>{r.setValue(D.key,D.value),r.save()};return t.$$set=D=>{"settingStorage"in D&&n(5,r=D.settingStorage),"documentVectorStorage"in D&&n(16,s=D.documentVectorStorage),"selectedModel"in D&&n(0,a=D.selectedModel),"isSearchEnabled"in D&&n(1,i=D.isSearchEnabled),"isKnowledgeEnabled"in D&&n(2,o=D.isKnowledgeEnabled),"imageUrl"in D&&n(3,u=D.imageUrl),"fileContent"in D&&n(4,c=D.fileContent),"isInterrupted"in D&&n(15,l=D.isInterrupted),"isGenerating"in D&&n(6,d=D.isGenerating)},[a,i,o,u,c,r,d,p,m,f,g,b,_,y,S,l,s,I,A,O,w,L]}class M9 extends dt{constructor(e){super(),lt(this,e,D9,L9,ct,{settingStorage:5,documentVectorStorage:16,selectedModel:0,isSearchEnabled:1,isKnowledgeEnabled:2,imageUrl:3,fileContent:4,isInterrupted:15,isGenerating:6})}}function B9(t){let e,n,r,s,a,i=[{type:"button"},t[4],{class:r=["b3-button",t[3],t[2]].join(" ")},{style:t[1]}],o={};for(let u=0;u<i.length;u+=1)o=Ru(o,i[u]);return{c(){e=V("button"),n=Qe(t[0]),ap(e,o)},m(u,c){pe(u,e,c),N(e,n),e.autofocus&&e.focus(),s||(a=ce(e,"click",t[8]),s=!0)},p(u,[c]){c&1&&ZA(n,u[0],o.contenteditable),ap(e,o=o2(i,[{type:"button"},c&16&&u[4],c&12&&r!==(r=["b3-button",u[3],u[2]].join(" "))&&{class:r},c&2&&{style:u[1]}]))},i:it,o:it,d(u){u&&me(e),s=!1,a()}}}function F9(t,e,n){let r,s,a,{text:i=!1}=e,{outline:o=!1}=e,{backgroundColor:u=void 0}=e,{label:c=""}=e;function l(d){e2.call(this,t,d)}return t.$$set=d=>{n(4,e=Ru(Ru({},e),sp(d))),"text"in d&&n(5,i=d.text),"outline"in d&&n(6,o=d.outline),"backgroundColor"in d&&n(7,u=d.backgroundColor),"label"in d&&n(0,c=d.label)},t.$$.update=()=>{t.$$.dirty&64&&n(3,r=o?"b3-button--outline":""),t.$$.dirty&32&&n(2,s=i?"b3-button--text":""),t.$$.dirty&128&&n(1,a=u?`background-color: ${u}`:"")},e=sp(e),[c,a,s,r,e,i,o,u,l]}class bc extends dt{constructor(e){super(),lt(this,e,F9,B9,ct,{text:5,outline:6,backgroundColor:7,label:0})}}function U9(t){let e,n,r,s,a,i,o,u,c,l,d,m,p,f,g,b;function _(A){t[3](A)}let y={type:"textinput",placeholder:"",key:"title",style:"width: 100%; margin-bottom: 16px;"};t[1].title!==void 0&&(y.value=t[1].title),s=new pa({props:y}),_e.push(()=>Ne(s,"value",_));function S(A){t[4](A)}let I={type:"textarea",placeholder:"",key:"content",style:"width: 100%; white-space: pre-wrap; word-wrap: break-word;"};return t[1].content!==void 0&&(I.value=t[1].content),o=new pa({props:I}),_e.push(()=>Ne(o,"value",S)),d=new bc({props:{label:"",text:!0,outline:!0}}),d.$on("click",t[5]),g=new bc({props:{label:"",text:!1,outline:!1}}),g.$on("click",t[6]),{c(){e=V("div"),n=V("div"),r=V("div"),Ye(s.$$.fragment),i=se(),Ye(o.$$.fragment),c=se(),l=V("div"),Ye(d.$$.fragment),m=se(),p=V("div"),f=se(),Ye(g.$$.fragment),v(r,"class","edit-content__body svelte-c66fm5"),v(p,"class","fn__space"),v(l,"class","b3-dialog__action svelte-c66fm5"),v(n,"class","edit-content svelte-c66fm5"),v(e,"class","edit-panel svelte-c66fm5")},m(A,O){pe(A,e,O),N(e,n),N(n,r),ze(s,r,null),N(r,i),ze(o,r,null),N(n,c),N(n,l),ze(d,l,null),N(l,m),N(l,p),N(l,f),ze(g,l,null),b=!0},p(A,[O]){const w={};!a&&O&2&&(a=!0,w.value=A[1].title,ke(()=>a=!1)),s.$set(w);const L={};!u&&O&2&&(u=!0,L.value=A[1].content,ke(()=>u=!1)),o.$set(L)},i(A){b||(oe(s.$$.fragment,A),oe(o.$$.fragment,A),oe(d.$$.fragment,A),oe(g.$$.fragment,A),b=!0)},o(A){he(s.$$.fragment,A),he(o.$$.fragment,A),he(d.$$.fragment,A),he(g.$$.fragment,A),b=!1},d(A){A&&me(e),We(s),We(o),We(d),We(g)}}}function j9(t,e,n){let{showEditPanel:r=!1}=e,{currentPrompt:s}=e;const a=Nr();function i(l){t.$$.not_equal(s.title,l)&&(s.title=l,n(1,s))}function o(l){t.$$.not_equal(s.content,l)&&(s.content=l,n(1,s))}const u=()=>n(0,r=!1),c=()=>a("save");return t.$$set=l=>{"showEditPanel"in l&&n(0,r=l.showEditPanel),"currentPrompt"in l&&n(1,s=l.currentPrompt)},[r,s,a,i,o,u,c]}class Kw extends dt{constructor(e){super(),lt(this,e,j9,U9,ct,{showEditPanel:0,currentPrompt:1})}}function ob(t,e,n){const r=t.slice();return r[6]=e[n],r}function ub(t,e){let n,r,s,a=e[6].title+"",i,o,u,c,l,d,m,p,f,g,b;function _(){return e[3](e[6])}function y(){return e[4](e[6])}function S(){return e[5](e[6])}return{key:t,first:null,c(){n=V("div"),r=V("div"),s=V("span"),i=Qe(a),o=se(),u=V("div"),c=V("button"),c.innerHTML='<svg class="b3-list-item__hinticon" style="width: 1.5em;"><use xlink:href="#iconTrashcan"></use></svg>',l=se(),d=V("button"),d.innerHTML='<svg class="b3-list-item__hinticon" style="width: 1.5em;"><use xlink:href="#iconEdit"></use></svg>',m=se(),p=V("button"),p.innerHTML='<svg class="b3-list-item__hinticon" style="width: 1.5em;"><use xlink:href="#iconPlay"></use></svg>',f=se(),v(s,"class","title"),v(r,"class","fn__flex-1"),v(c,"class","b3-list-item"),v(c,"title",""),v(d,"class","b3-list-item"),v(d,"title",""),v(p,"class","b3-list-item"),v(p,"title",""),v(u,"class","fn__flex"),v(n,"class","item-wrap fn__flex b3-label config__item prompt-item svelte-1706rdx"),jt(n,"height","1.5em"),this.first=n},m(I,A){pe(I,n,A),N(n,r),N(r,s),N(s,i),N(n,o),N(n,u),N(u,c),N(u,l),N(u,d),N(u,m),N(u,p),N(n,f),g||(b=[ce(c,"click",_),ce(d,"click",y),ce(p,"click",S)],g=!0)},p(I,A){e=I,A&1&&a!==(a=e[6].title+"")&&St(i,a)},d(I){I&&me(n),g=!1,ut(b)}}}function H9(t){let e,n=[],r=new Map,s=On(t[0]);const a=i=>i[6].id;for(let i=0;i<s.length;i+=1){let o=ob(t,s,i),u=a(o);r.set(u,n[i]=ub(u,o))}return{c(){e=V("div");for(let i=0;i<n.length;i+=1)n[i].c();v(e,"class","b3-tab-bar b3-list b3-list--background")},m(i,o){pe(i,e,o);for(let u=0;u<n.length;u+=1)n[u]&&n[u].m(e,null)},p(i,[o]){o&7&&(s=On(i[0]),n=s_(n,o,a,1,i,s,r,e,a2,ub,null,ob))},i:it,o:it,d(i){i&&me(e);for(let o=0;o<n.length;o+=1)n[o].d()}}}function $9(t,e,n){let{prompts:r}=e,{inputAreaComponent:s}=e;const a=Nr(),i=c=>a("delete",c.id),o=c=>a("edit",c),u=c=>{a("use",c),s.focus()};return t.$$set=c=>{"prompts"in c&&n(0,r=c.prompts),"inputAreaComponent"in c&&n(1,s=c.inputAreaComponent)},[r,s,a,i,o,u]}class Yw extends dt{constructor(e){super(),lt(this,e,$9,H9,ct,{prompts:0,inputAreaComponent:1})}}function cb(t){let e,n,r,s;function a(u){t[16](u)}function i(u){t[17](u)}let o={};return t[1]!==void 0&&(o.showEditPanel=t[1]),t[2]!==void 0&&(o.currentPrompt=t[2]),e=new Kw({props:o}),_e.push(()=>Ne(e,"showEditPanel",a)),_e.push(()=>Ne(e,"currentPrompt",i)),e.$on("save",t[7]),{c(){Ye(e.$$.fragment)},m(u,c){ze(e,u,c),s=!0},p(u,c){const l={};!n&&c&2&&(n=!0,l.showEditPanel=u[1],ke(()=>n=!1)),!r&&c&4&&(r=!0,l.currentPrompt=u[2],ke(()=>r=!1)),e.$set(l)},i(u){s||(oe(e.$$.fragment,u),s=!0)},o(u){he(e.$$.fragment,u),s=!1},d(u){We(e,u)}}}function q9(t){let e,n,r,s,a,i,o,u;s=new Yw({props:{inputAreaComponent:t[0],prompts:t[3]}}),s.$on("edit",t[13]),s.$on("delete",t[14]),s.$on("use",t[15]);let c=t[1]&&cb(t);return{c(){e=V("div"),n=V("button"),n.innerHTML='<span class="add-icon svelte-19yd9nj">+</span> <span class="btn-text svelte-19yd9nj"> Prompt</span>',r=se(),Ye(s.$$.fragment),a=se(),c&&c.c(),v(n,"class","add-prompt-btn svelte-19yd9nj"),v(e,"class","prompts-panel svelte-19yd9nj")},m(l,d){pe(l,e,d),N(e,n),N(e,r),ze(s,e,null),N(e,a),c&&c.m(e,null),i=!0,o||(u=ce(n,"click",t[12]),o=!0)},p(l,[d]){const m={};d&1&&(m.inputAreaComponent=l[0]),d&8&&(m.prompts=l[3]),s.$set(m),l[1]?c?(c.p(l,d),d&2&&oe(c,1)):(c=cb(l),c.c(),oe(c,1),c.m(e,null)):c&&(Ar(),he(c,1,1,()=>{c=null}),Cr())},i(l){i||(oe(s.$$.fragment,l),oe(c),i=!0)},o(l){he(s.$$.fragment,l),he(c),i=!1},d(l){l&&me(e),We(s),c&&c.d(),o=!1,u()}}}function V9(t,e,n){let r,s,{promptStorage:a}=e,{searchText:i}=e,{inputAreaComponent:o}=e,{isCommand:u}=e,c=!1,l;const d=()=>({id:Date.now(),title:"",content:""}),m=Nr();function p(w){a.deletePrompt(w),n(11,r=a.data)}function f(w){n(2,l=w?{...w}:d()),n(1,c=!0)}function g(w){n(8,i=w.content)}function b(){r.some(L=>L.id===l.id)?a.updatePrompt(l):a.addPrompt(l),n(1,c=!1),n(11,r=a.data)}const _=()=>f(),y=w=>f(w.detail),S=w=>p(w.detail),I=w=>g(w.detail);function A(w){c=w,n(1,c)}function O(w){l=w,n(2,l)}return t.$$set=w=>{"promptStorage"in w&&n(9,a=w.promptStorage),"searchText"in w&&n(8,i=w.searchText),"inputAreaComponent"in w&&n(0,o=w.inputAreaComponent),"isCommand"in w&&n(10,u=w.isCommand)},t.$$.update=()=>{t.$$.dirty&512&&n(11,r=a.data),t.$$.dirty&2304&&n(3,s=i.length>1?r.filter(w=>{const L=i.slice(1).toLowerCase();return w.title.toLowerCase().includes(L)||w.content.toLowerCase().includes(L)}):r),t.$$.dirty&256&&m("searchTextChange",i)},[o,c,l,s,p,f,g,b,i,a,u,r,_,y,S,I,A,O]}class Zw extends dt{constructor(e){super(),lt(this,e,V9,q9,ct,{promptStorage:9,searchText:8,inputAreaComponent:0,isCommand:10})}}function z9(t){let e,n,r,s;return{c(){e=V("div"),n=V("textarea"),v(n,"placeholder","/Enter Shift + Enter "),n.disabled=t[0],v(n,"class","svelte-7ohy60"),v(e,"class","input-container svelte-7ohy60")},m(a,i){pe(a,e,i),N(e,n),t[6](n),Dt(n,t[1]),r||(s=[ce(n,"input",t[7]),ce(n,"input",t[3]),ce(n,"keydown",t[4])],r=!0)},p(a,[i]){i&1&&(n.disabled=a[0]),i&2&&Dt(n,a[1])},i:it,o:it,d(a){a&&me(e),t[6](null),r=!1,ut(s)}}}function W9(t,e,n){let{promptStorage:r}=e,{isGenerating:s}=e,a="",i;const o=Nr();function u(p){const f=p.target;f.value==="/"&&f.selectionStart===1&&l()}function c(p){p.key==="Enter"&&!p.shiftKey&&!p.isComposing&&(p.preventDefault(),o("sendMessage",a),n(1,a=""))}function l(){const p=new An.Dialog({title:"",content:'<div id="chat-prompts-panel" style="height: 100%; margin:0px; padding:0px;"></div>',width:"40%",hideCloseIcon:!0});new Zw({target:p.element.querySelector("#chat-prompts-panel"),props:{inputAreaComponent:i,promptStorage:r,searchText:a,isCommand:!1}}).$on("searchTextChange",g=>{n(1,a=g.detail),n(2,i.style.height="auto",i),n(2,i.style.height=`${i.scrollHeight}px`,i)})}Oc(()=>{i.focus()});function d(p){_e[p?"unshift":"push"](()=>{i=p,n(2,i)})}function m(){a=this.value,n(1,a)}return t.$$set=p=>{"promptStorage"in p&&n(5,r=p.promptStorage),"isGenerating"in p&&n(0,s=p.isGenerating)},[s,a,i,u,c,r,d,m]}class G9 extends dt{constructor(e){super(),lt(this,e,W9,z9,ct,{promptStorage:5,isGenerating:0})}}function K9(t){let e,n,r,s,a,i,o,u,c,l,d,m,p,f;n=new n9({props:{currentChat:t[0],lute:t[9]}}),n.$on("edit",t[12]),n.$on("delete",t[13]);function g(w){t[16](w)}function b(w){t[17](w)}function _(w){t[18](w)}function y(w){t[19](w)}function S(w){t[20](w)}function I(w){t[21](w)}function A(w){t[22](w)}let O={settingStorage:t[8],isGenerating:t[10]};return t[11]!==void 0&&(O.isInterrupted=t[11]),t[2]!==void 0&&(O.selectedModel=t[2]),t[3]!==void 0&&(O.isSearchEnabled=t[3]),t[4]!==void 0&&(O.isKnowledgeEnabled=t[4]),t[5]!==void 0&&(O.imageUrl=t[5]),t[6]!==void 0&&(O.fileContent=t[6]),t[1]!==void 0&&(O.documentVectorStorage=t[1]),s=new M9({props:O}),_e.push(()=>Ne(s,"isInterrupted",g)),_e.push(()=>Ne(s,"selectedModel",b)),_e.push(()=>Ne(s,"isSearchEnabled",_)),_e.push(()=>Ne(s,"isKnowledgeEnabled",y)),_e.push(()=>Ne(s,"imageUrl",S)),_e.push(()=>Ne(s,"fileContent",I)),_e.push(()=>Ne(s,"documentVectorStorage",A)),p=new G9({props:{promptStorage:t[7],isGenerating:t[10]}}),p.$on("sendMessage",t[23]),{c(){e=V("div"),Ye(n.$$.fragment),r=se(),Ye(s.$$.fragment),m=se(),Ye(p.$$.fragment),v(e,"class","chat svelte-qot5nw")},m(w,L){pe(w,e,L),ze(n,e,null),N(e,r),ze(s,e,null),N(e,m),ze(p,e,null),f=!0},p(w,[L]){const D={};L&1&&(D.currentChat=w[0]),L&512&&(D.lute=w[9]),n.$set(D);const B={};L&256&&(B.settingStorage=w[8]),L&1024&&(B.isGenerating=w[10]),!a&&L&2048&&(a=!0,B.isInterrupted=w[11],ke(()=>a=!1)),!i&&L&4&&(i=!0,B.selectedModel=w[2],ke(()=>i=!1)),!o&&L&8&&(o=!0,B.isSearchEnabled=w[3],ke(()=>o=!1)),!u&&L&16&&(u=!0,B.isKnowledgeEnabled=w[4],ke(()=>u=!1)),!c&&L&32&&(c=!0,B.imageUrl=w[5],ke(()=>c=!1)),!l&&L&64&&(l=!0,B.fileContent=w[6],ke(()=>l=!1)),!d&&L&2&&(d=!0,B.documentVectorStorage=w[1],ke(()=>d=!1)),s.$set(B);const ee={};L&128&&(ee.promptStorage=w[7]),L&1024&&(ee.isGenerating=w[10]),p.$set(ee)},i(w){f||(oe(n.$$.fragment,w),oe(s.$$.fragment,w),oe(p.$$.fragment,w),f=!0)},o(w){he(n.$$.fragment,w),he(s.$$.fragment,w),he(p.$$.fragment,w),f=!1},d(w){w&&me(e),We(n),We(s),We(p)}}}function Y9(t,e,n){let{currentChat:r}=e,{chatHistoryStorage:s}=e,{promptStorage:a}=e,{settingStorage:i}=e,{documentVectorStorage:o}=e,{selectedModel:u}=e,{isSearchEnabled:c}=e,{isKnowledgeEnabled:l}=e,{imageUrl:d}=e,{fileContent:m}=e,{lute:p}=e,f=!1,g=!1;km(i.i18n);function b(K){const{message:Q}=K.detail,x=r.messages.findIndex(k=>k.id===Q.id);x!==-1&&(n(0,r.messages=r.messages.slice(0,x),r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"user",content:Q.content,image:Q.image||"",model:u,fileContent:Q.fileContent||""}],r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"assistant",content:"",model:u}],r),s.update(r),y())}function _(K){const{message:Q}=K.detail,x=r.messages.findIndex(k=>k.id===Q.id);x!==-1&&(n(0,r.messages=r.messages.slice(0,x),r),s.update(r))}async function y(){So({apiKey:i.getValue("apiKey"),phone:i.getValue("phone"),model:r.model?r.model:u,maxTokens:i.getValue("maxOutputLengthChat"),temperature:i.getValue("temperatureChat"),timeout:i.getValue("responseTimeoutChat"),isSearch:c,isStream:!0,isClipboard:!0,isKnowledge:l,callback:(K,Q)=>{if(g)throw n(10,f=!1),new Error("User interrupted");n(0,r.messages[r.messages.length-1].content=K,r),n(0,r.messages[r.messages.length-1].model=u,r),s.update(r),n(10,f=Q)},knowledgeCallback:async K=>{const Q=await o.similaritySearchWithScore(K,i.getValue("knowledgeBaseRecallNumChat"));let x=[];for(const k of Q)k[1]<.7||x.push(k[0]);return x},messages:r.messages.slice(0,-1)})}async function S(K){if(!(f||!K.trim()))try{d&&n(0,r.model=Math.random()<.7?Tl[0]:Tl[Math.floor(Math.random()*(Tl.length-1))+1],r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"user",content:K,image:d,model:u,fileContent:m}],r),s.update(r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"assistant",content:"",model:u}],r);try{if(d.length>0&&(n(0,r.title="",r),s.update(r)),await y(),r.messages.length>3&&r.messages.length<=5&&d.length==0){const Q=await VB([...r.messages,{role:"user",content:s.i18n.summaryPrompt}],i.getValue("apiKey"));n(0,r.title=Q,r)}}catch(Q){console.error("AI :",Q),n(0,r.messages=r.messages.slice(0,-1),r)}}finally{s.update(r),n(10,f=!1),n(11,g=!1),n(5,d="")}}function I(K){g=K,n(11,g)}function A(K){u=K,n(2,u)}function O(K){c=K,n(3,c)}function w(K){l=K,n(4,l)}function L(K){d=K,n(5,d)}function D(K){m=K,n(6,m)}function B(K){o=K,n(1,o)}const ee=async({detail:K})=>await S(K);return t.$$set=K=>{"currentChat"in K&&n(0,r=K.currentChat),"chatHistoryStorage"in K&&n(15,s=K.chatHistoryStorage),"promptStorage"in K&&n(7,a=K.promptStorage),"settingStorage"in K&&n(8,i=K.settingStorage),"documentVectorStorage"in K&&n(1,o=K.documentVectorStorage),"selectedModel"in K&&n(2,u=K.selectedModel),"isSearchEnabled"in K&&n(3,c=K.isSearchEnabled),"isKnowledgeEnabled"in K&&n(4,l=K.isKnowledgeEnabled),"imageUrl"in K&&n(5,d=K.imageUrl),"fileContent"in K&&n(6,m=K.fileContent),"lute"in K&&n(9,p=K.lute)},[r,o,u,c,l,d,m,a,i,p,f,g,b,_,S,s,I,A,O,w,L,D,B,ee]}class Z9 extends dt{constructor(e){super(),lt(this,e,Y9,K9,ct,{currentChat:0,chatHistoryStorage:15,promptStorage:7,settingStorage:8,documentVectorStorage:1,selectedModel:2,isSearchEnabled:3,isKnowledgeEnabled:4,imageUrl:5,fileContent:6,lute:9})}}function J9(t){let e,n,r,s,a,i,o,u,c,l;function d(y){t[12](y)}let m={};t[0]!==void 0&&(m.chatHistoryStorage=t[0]),n=new JB({props:m}),_e.push(()=>Ne(n,"chatHistoryStorage",d)),n.$on("selectChat",t[13]);function p(y){t[14](y)}function f(y){t[15](y)}function g(y){t[16](y)}function b(y){t[17](y)}let _={currentChat:t[5],promptStorage:t[3],settingStorage:t[2],selectedModel:t[8],isSearchEnabled:t[9],isKnowledgeEnabled:t[10],lute:t[4]};return t[0]!==void 0&&(_.chatHistoryStorage=t[0]),t[1]!==void 0&&(_.documentVectorStorage=t[1]),t[6]!==void 0&&(_.imageUrl=t[6]),t[7]!==void 0&&(_.fileContent=t[7]),a=new Z9({props:_}),_e.push(()=>Ne(a,"chatHistoryStorage",p)),_e.push(()=>Ne(a,"documentVectorStorage",f)),_e.push(()=>Ne(a,"imageUrl",g)),_e.push(()=>Ne(a,"fileContent",b)),a.$on("messageUpdate",t[11]),a.$on("titleUpdate",t[11]),{c(){e=V("div"),Ye(n.$$.fragment),s=se(),Ye(a.$$.fragment),v(e,"class","chat-container svelte-wqoale")},m(y,S){pe(y,e,S),ze(n,e,null),N(e,s),ze(a,e,null),l=!0},p(y,[S]){const I={};!r&&S&1&&(r=!0,I.chatHistoryStorage=y[0],ke(()=>r=!1)),n.$set(I);const A={};S&32&&(A.currentChat=y[5]),S&8&&(A.promptStorage=y[3]),S&4&&(A.settingStorage=y[2]),S&16&&(A.lute=y[4]),!i&&S&1&&(i=!0,A.chatHistoryStorage=y[0],ke(()=>i=!1)),!o&&S&2&&(o=!0,A.documentVectorStorage=y[1],ke(()=>o=!1)),!u&&S&64&&(u=!0,A.imageUrl=y[6],ke(()=>u=!1)),!c&&S&128&&(c=!0,A.fileContent=y[7],ke(()=>c=!1)),a.$set(A)},i(y){l||(oe(n.$$.fragment,y),oe(a.$$.fragment,y),l=!0)},o(y){he(n.$$.fragment,y),he(a.$$.fragment,y),l=!1},d(y){y&&me(e),We(n),We(a)}}}function X9(t,e,n){let{settingStorage:r}=e,{chatHistoryStorage:s}=e,{promptStorage:a}=e,{documentVectorStorage:i}=e,{lute:o}=e,u=r.getValue("modelSelections"),c=s.dump(),l=c[0],d=r.getValue("isSearchChat"),m=r.getValue("isisKnowledgeBaseChat"),p="",f="";function g(){c=s.dump(),n(5,l=c.find(O=>O.id===l.id)||c[0])}function b(O){s=O,n(0,s)}const _=O=>n(5,l=O.detail);function y(O){s=O,n(0,s)}function S(O){i=O,n(1,i)}function I(O){p=O,n(6,p)}function A(O){f=O,n(7,f)}return t.$$set=O=>{"settingStorage"in O&&n(2,r=O.settingStorage),"chatHistoryStorage"in O&&n(0,s=O.chatHistoryStorage),"promptStorage"in O&&n(3,a=O.promptStorage),"documentVectorStorage"in O&&n(1,i=O.documentVectorStorage),"lute"in O&&n(4,o=O.lute)},[s,i,r,a,o,l,p,f,u,d,m,g,b,_,y,S,I,A]}class Q9 extends dt{constructor(e){super(),lt(this,e,X9,J9,ct,{settingStorage:2,chatHistoryStorage:0,promptStorage:3,documentVectorStorage:1,lute:4})}}function eF(t){let e,n,r,s,a,i,o,u,c,l,d,m,p,f,g,b,_,y,S,I,A,O,w,L,D,B,ee;function K(x){t[21](x)}let Q={type:"select",key:"modelSelections",style:"font-size: 12px; border-radius: 4px; border: none ;outline: none;background: transparent; align-self: center;",fnSize:!1,options:t[5].get("modelSelections").options};return t[2]!==void 0&&(Q.value=t[2]),w=new pa({props:Q}),_e.push(()=>Ne(w,"value",K)),w.$on("changed",t[22]),{c(){e=V("div"),n=V("div"),r=V("textarea"),a=se(),i=V("div"),o=V("div"),u=V("button"),c=cn("svg"),l=cn("path"),d=se(),m=V("button"),p=cn("svg"),f=cn("path"),b=se(),_=V("button"),y=cn("svg"),S=cn("path"),A=se(),O=V("div"),Ye(w.$$.fragment),v(r,"placeholder",s=t[7].instructionInputPlaceholder),v(r,"class","svelte-1uickue"),v(n,"class","input svelte-1uickue"),v(l,"d","M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"),v(c,"viewBox","0 0 24 24"),v(c,"class","tools-icon svelte-1uickue"),Oe(c,"active",t[3]),v(u,"type","button"),v(u,"class","tools-button svelte-1uickue"),v(f,"d","M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"),v(p,"viewBox","0 0 24 24"),v(p,"class","tools-icon svelte-1uickue"),Oe(p,"active",t[8]),v(m,"title",g=t[7].onlineSearch),v(m,"type","button"),v(m,"class","tools-button svelte-1uickue"),Oe(m,"active",t[8]),v(S,"d","M21 5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5zm-2 14H5V5h14v14zM7 15h10v2H7v-2zm0-4h10v2H7v-2zm0-4h10v2H7V7z"),v(y,"viewBox","0 0 24 24"),v(y,"class","tools-icon svelte-1uickue"),Oe(y,"active",t[9]),v(_,"title",I=t[7].knowledgeBase),v(_,"type","button"),v(_,"class","tools-button svelte-1uickue"),Oe(_,"active",t[9]),v(o,"class","tools svelte-1uickue"),v(O,"class","models svelte-1uickue"),v(i,"class","tools-group svelte-1uickue"),v(e,"class","input-container svelte-1uickue")},m(x,k){pe(x,e,k),N(e,n),N(n,r),t[13](r),Dt(r,t[0]),N(e,a),N(e,i),N(i,o),N(o,u),N(u,c),N(c,l),N(o,d),N(o,m),N(m,p),N(p,f),N(o,b),N(o,_),N(_,y),N(y,S),N(i,A),N(i,O),ze(w,O,null),D=!0,B||(ee=[ce(r,"input",t[14]),ce(r,"keydown",t[15]),ce(r,"focus",t[16]),ce(r,"blur",t[17]),ce(u,"click",t[18]),ce(m,"click",t[19]),ce(_,"click",t[20])],B=!0)},p(x,[k]){(!D||k&128&&s!==(s=x[7].instructionInputPlaceholder))&&v(r,"placeholder",s),k&1&&Dt(r,x[0]),(!D||k&8)&&Oe(c,"active",x[3]),(!D||k&256)&&Oe(p,"active",x[8]),(!D||k&128&&g!==(g=x[7].onlineSearch))&&v(m,"title",g),(!D||k&256)&&Oe(m,"active",x[8]),(!D||k&512)&&Oe(y,"active",x[9]),(!D||k&128&&I!==(I=x[7].knowledgeBase))&&v(_,"title",I),(!D||k&512)&&Oe(_,"active",x[9]);const F={};k&32&&(F.options=x[5].get("modelSelections").options),!L&&k&4&&(L=!0,F.value=x[2],ke(()=>L=!1)),w.$set(F)},i(x){D||(oe(w.$$.fragment,x),D=!0)},o(x){he(w.$$.fragment,x),D=!1},d(x){x&&me(e),t[13](null),We(w),B=!1,ut(ee)}}}function tF(t,e,n){let{inputValue:r}=e,{inputElement:s}=e,{selectedModel:a}=e,{settingStorage:i}=e,{documentVectorStorage:o}=e,{showParams:u}=e,{handleSubmit:c}=e,{i18n:l}=e,{isFocused:d=!0}=e,m=i.getValue("isSearchInstruction"),p=i.getValue("isKnowledgeBaseInstruction");function f(){n(8,m=!m),i.setValue("isSearchInstruction",m),i.save()}async function g(){n(9,p=!p),i.setValue("isKnowledgeBaseInstruction",p),i.save(),p?await o.load():(await o.save(),await o.release())}function b(B){_e[B?"unshift":"push"](()=>{s=B,n(1,s)})}function _(){r=this.value,n(0,r)}const y=B=>{B.key==="Enter"&&!B.shiftKey&&!B.isComposing&&(B.preventDefault(),c())},S=()=>{n(4,d=!0)},I=()=>{n(4,d=!1)},A=()=>{n(3,u=!u),u||i.save()},O=()=>{f()},w=()=>{g()};function L(B){a=B,n(2,a)}const D=({detail:B})=>{i.setValue(B.key,B.value),i.save()};return t.$$set=B=>{"inputValue"in B&&n(0,r=B.inputValue),"inputElement"in B&&n(1,s=B.inputElement),"selectedModel"in B&&n(2,a=B.selectedModel),"settingStorage"in B&&n(5,i=B.settingStorage),"documentVectorStorage"in B&&n(12,o=B.documentVectorStorage),"showParams"in B&&n(3,u=B.showParams),"handleSubmit"in B&&n(6,c=B.handleSubmit),"i18n"in B&&n(7,l=B.i18n),"isFocused"in B&&n(4,d=B.isFocused)},[r,s,a,u,d,i,c,l,m,p,f,g,o,b,_,y,S,I,A,O,w,L,D]}class nF extends dt{constructor(e){super(),lt(this,e,tF,eF,ct,{inputValue:0,inputElement:1,selectedModel:2,settingStorage:5,documentVectorStorage:12,showParams:3,handleSubmit:6,i18n:7,isFocused:4})}}function lb(t){let e,n,r=t[4]?"":"...",s,a,i,o;return{c(){e=V("div"),n=V("button"),s=Qe(r),v(n,"type","button"),v(n,"class","generation-text svelte-1t9569r"),v(n,"aria-label",a=t[4]?"":"..."),v(e,"class","generating svelte-1t9569r")},m(u,c){pe(u,e,c),N(e,n),N(n,s),i||(o=[ce(n,"mouseenter",t[8]),ce(n,"mouseleave",t[9]),ce(n,"click",t[5]),ce(n,"keydown",t[10])],i=!0)},p(u,c){c&16&&r!==(r=u[4]?"":"...")&&St(s,r),c&16&&a!==(a=u[4]?"":"...")&&v(n,"aria-label",a)},d(u){u&&me(e),i=!1,ut(o)}}}function rF(t){let e,n,r=t[3].Md2HTML(t[1])+"",s,a=t[2]&&lb(t);return{c(){e=V("div"),n=V("div"),s=se(),a&&a.c(),v(n,"class","output svelte-1t9569r"),v(e,"class","output-container svelte-1t9569r")},m(i,o){pe(i,e,o),N(e,n),n.innerHTML=r,t[7](n),N(e,s),a&&a.m(e,null)},p(i,[o]){o&10&&r!==(r=i[3].Md2HTML(i[1])+"")&&(n.innerHTML=r),i[2]?a?a.p(i,o):(a=lb(i),a.c(),a.m(e,null)):a&&(a.d(1),a=null)},i:it,o:it,d(i){i&&me(e),t[7](null),a&&a.d()}}}function sF(t,e,n){let{outputContent:r}=e,{isGenerating:s}=e,{outputContainer:a}=e,{lute:i}=e,{isInterrupted:o}=e,u=!1;function c(){n(6,o=!0)}function l(f){_e[f?"unshift":"push"](()=>{a=f,n(0,a)})}const d=()=>n(4,u=!0),m=()=>n(4,u=!1),p=f=>f.key==="Enter"&&c();return t.$$set=f=>{"outputContent"in f&&n(1,r=f.outputContent),"isGenerating"in f&&n(2,s=f.isGenerating),"outputContainer"in f&&n(0,a=f.outputContainer),"lute"in f&&n(3,i=f.lute),"isInterrupted"in f&&n(6,o=f.isInterrupted)},[a,r,s,i,u,c,o,l,d,m,p]}class Jw extends dt{constructor(e){super(),lt(this,e,sF,rF,ct,{outputContent:1,isGenerating:2,outputContainer:0,lute:3,isInterrupted:6})}}function db(t){let e,n,r,s,a;function i(l){t[18](l)}function o(l){t[19](l)}function u(l){t[20](l)}let c={outputContent:t[10],lute:t[3]};return t[12]!==void 0&&(c.isInterrupted=t[12]),t[11]!==void 0&&(c.isGenerating=t[11]),t[6]!==void 0&&(c.outputContainer=t[6]),e=new Jw({props:c}),_e.push(()=>Ne(e,"isInterrupted",i)),_e.push(()=>Ne(e,"isGenerating",o)),_e.push(()=>Ne(e,"outputContainer",u)),{c(){Ye(e.$$.fragment)},m(l,d){ze(e,l,d),a=!0},p(l,d){const m={};d[0]&1024&&(m.outputContent=l[10]),d[0]&8&&(m.lute=l[3]),!n&&d[0]&4096&&(n=!0,m.isInterrupted=l[12],ke(()=>n=!1)),!r&&d[0]&2048&&(r=!0,m.isGenerating=l[11],ke(()=>r=!1)),!s&&d[0]&64&&(s=!0,m.outputContainer=l[6],ke(()=>s=!1)),e.$set(m)},i(l){a||(oe(e.$$.fragment,l),a=!0)},o(l){he(e.$$.fragment,l),a=!1},d(l){We(e,l)}}}function hb(t){let e,n,r;function s(i){t[27](i)}let a={group:"instruction"};return t[0]!==void 0&&(a.settingStorage=t[0]),e=new Ww({props:a}),_e.push(()=>Ne(e,"settingStorage",s)),{c(){Ye(e.$$.fragment)},m(i,o){ze(e,i,o),r=!0},p(i,o){const u={};!n&&o[0]&1&&(n=!0,u.settingStorage=i[0],ke(()=>n=!1)),e.$set(u)},i(i){r||(oe(e.$$.fragment,i),r=!0)},o(i){he(e.$$.fragment,i),r=!1},d(i){We(e,i)}}}function fb(t){let e,n,r,s,a;function i(l){t[28](l)}function o(l){t[29](l)}function u(l){t[30](l)}let c={isCommand:!1};return t[7]!==void 0&&(c.inputAreaComponent=t[7]),t[4]!==void 0&&(c.searchText=t[4]),t[1]!==void 0&&(c.promptStorage=t[1]),e=new Zw({props:c}),_e.push(()=>Ne(e,"inputAreaComponent",i)),_e.push(()=>Ne(e,"searchText",o)),_e.push(()=>Ne(e,"promptStorage",u)),{c(){Ye(e.$$.fragment)},m(l,d){ze(e,l,d),a=!0},p(l,d){const m={};!n&&d[0]&128&&(n=!0,m.inputAreaComponent=l[7],ke(()=>n=!1)),!r&&d[0]&16&&(r=!0,m.searchText=l[4],ke(()=>r=!1)),!s&&d[0]&2&&(s=!0,m.promptStorage=l[1],ke(()=>s=!1)),e.$set(m)},i(l){a||(oe(e.$$.fragment,l),a=!0)},o(l){he(e.$$.fragment,l),a=!1},d(l){We(e,l)}}}function aF(t){let e,n,r,s,a,i,o,u,c,l,d,m,p,f=t[9]&&db(t);function g(L){t[21](L)}function b(L){t[22](L)}function _(L){t[23](L)}function y(L){t[24](L)}function S(L){t[25](L)}function I(L){t[26](L)}let A={handleSubmit:t[15],i18n:t[14]};t[4]!==void 0&&(A.inputValue=t[4]),t[7]!==void 0&&(A.inputElement=t[7]),t[8]!==void 0&&(A.selectedModel=t[8]),t[0]!==void 0&&(A.settingStorage=t[0]),t[2]!==void 0&&(A.documentVectorStorage=t[2]),t[5]!==void 0&&(A.showParams=t[5]),r=new nF({props:A}),_e.push(()=>Ne(r,"inputValue",g)),_e.push(()=>Ne(r,"inputElement",b)),_e.push(()=>Ne(r,"selectedModel",_)),_e.push(()=>Ne(r,"settingStorage",y)),_e.push(()=>Ne(r,"documentVectorStorage",S)),_e.push(()=>Ne(r,"showParams",I));let O=t[5]&&hb(t),w=t[13]&&fb(t);return{c(){e=V("div"),f&&f.c(),n=se(),Ye(r.$$.fragment),l=se(),d=V("div"),O&&O.c(),m=se(),w&&w.c(),jt(d,"width","100%"),v(e,"class","instruction-container svelte-1dkyoze")},m(L,D){pe(L,e,D),f&&f.m(e,null),N(e,n),ze(r,e,null),N(e,l),N(e,d),O&&O.m(d,null),N(d,m),w&&w.m(d,null),p=!0},p(L,D){L[9]?f?(f.p(L,D),D[0]&512&&oe(f,1)):(f=db(L),f.c(),oe(f,1),f.m(e,n)):f&&(Ar(),he(f,1,1,()=>{f=null}),Cr());const B={};!s&&D[0]&16&&(s=!0,B.inputValue=L[4],ke(()=>s=!1)),!a&&D[0]&128&&(a=!0,B.inputElement=L[7],ke(()=>a=!1)),!i&&D[0]&256&&(i=!0,B.selectedModel=L[8],ke(()=>i=!1)),!o&&D[0]&1&&(o=!0,B.settingStorage=L[0],ke(()=>o=!1)),!u&&D[0]&4&&(u=!0,B.documentVectorStorage=L[2],ke(()=>u=!1)),!c&&D[0]&32&&(c=!0,B.showParams=L[5],ke(()=>c=!1)),r.$set(B),L[5]?O?(O.p(L,D),D[0]&32&&oe(O,1)):(O=hb(L),O.c(),oe(O,1),O.m(d,m)):O&&(Ar(),he(O,1,1,()=>{O=null}),Cr()),L[13]?w?(w.p(L,D),D[0]&8192&&oe(w,1)):(w=fb(L),w.c(),oe(w,1),w.m(d,null)):w&&(Ar(),he(w,1,1,()=>{w=null}),Cr())},i(L){p||(oe(f),oe(r.$$.fragment,L),oe(O),oe(w),p=!0)},o(L){he(f),he(r.$$.fragment,L),he(O),he(w),p=!1},d(L){L&&me(e),f&&f.d(),We(r),O&&O.d(),w&&w.d()}}}function iF(t,e,n){let r,{settingStorage:s}=e,{promptStorage:a}=e,{documentVectorStorage:i}=e,{lute:o}=e,{selectedText:u}=e,{pageContent:c}=e;km(s.i18n);let l=s.i18n,d,m="",p=!1,f=s.getValue("modelSelections"),g=!1,b="",_=!1,y=!1,S;async function I(){n(9,g=!0),n(11,_=!0),n(10,b="");let W=m.startsWith("/")?m.slice(1):m,re=[];u.trim().length>0?re.push({role:"user",content:`${u}

${W}`}):s.getValue("isPageContent")?re.push({role:"user",content:`${c.title}

${c.content}

${W}`}):re.push({role:"user",content:`${W}`});try{await So({apiKey:s.getValue("apiKey"),phone:s.getValue("phone"),model:f,maxTokens:s.getValue("maxOutputLengthInstruction"),temperature:s.getValue("temperatureInstruction"),timeout:s.getValue("responseTimeoutInstruction"),isSearch:s.getValue("isSearchInstruction"),isStream:!0,isClipboard:!0,isKnowledge:s.getValue("isKnowledgeBaseInstruction"),callback:(Pe,Ae)=>{if(y)throw new Error("User interrupted");n(10,b=Pe),S&&!A&&n(6,S.scrollTop=S.scrollHeight,S)},knowledgeCallback:async Pe=>{const Ae=await i.similaritySearchWithScore(Pe,s.getValue("knowledgeBaseRecallNumInstruction"));let _t=[];for(const Ot of Ae)Ot[1]<.7||_t.push(Ot[0]);return _t},messages:re})}finally{n(11,_=!1)}}let A=!1,O=0;function w(W){W&&W.addEventListener("scroll",()=>{W.scrollTop<O&&(A=!0),O=W.scrollTop,W.scrollHeight-W.scrollTop-W.clientHeight<50&&(A=!1)})}Oc(()=>{d.focus()});function L(W){y=W,n(12,y)}function D(W){_=W,n(11,_)}function B(W){S=W,n(6,S)}function ee(W){m=W,n(4,m)}function K(W){d=W,n(7,d)}function Q(W){f=W,n(8,f)}function x(W){s=W,n(0,s)}function k(W){i=W,n(2,i)}function F(W){p=W,n(5,p)}function q(W){s=W,n(0,s)}function M(W){d=W,n(7,d)}function z(W){m=W,n(4,m)}function X(W){a=W,n(1,a)}return t.$$set=W=>{"settingStorage"in W&&n(0,s=W.settingStorage),"promptStorage"in W&&n(1,a=W.promptStorage),"documentVectorStorage"in W&&n(2,i=W.documentVectorStorage),"lute"in W&&n(3,o=W.lute),"selectedText"in W&&n(16,u=W.selectedText),"pageContent"in W&&n(17,c=W.pageContent)},t.$$.update=()=>{t.$$.dirty[0]&48&&n(13,r=m.trim().startsWith("/")&&!p),t.$$.dirty[0]&64&&S&&w(S)},[s,a,i,o,m,p,S,d,f,g,b,_,y,r,l,I,u,c,L,D,B,ee,K,Q,x,k,F,q,M,z,X]}class oF extends dt{constructor(e){super(),lt(this,e,iF,aF,ct,{settingStorage:0,promptStorage:1,documentVectorStorage:2,lute:3,selectedText:16,pageContent:17},null,[-1,-1])}}function mb(t){let e,n,r;return{c(){e=V("button"),e.innerHTML="<span></span>",v(e,"class","clear-btn svelte-5yxkd9")},m(s,a){pe(s,e,a),n||(r=ce(e,"click",t[15]),n=!0)},p:it,d(s){s&&me(e),n=!1,r()}}}function pb(t){let e,n,r,s;function a(u){t[22](u)}function i(u){t[23](u)}let o={};return t[4]!==void 0&&(o.showEditPanel=t[4]),t[5]!==void 0&&(o.currentPrompt=t[5]),e=new Kw({props:o}),_e.push(()=>Ne(e,"showEditPanel",a)),_e.push(()=>Ne(e,"currentPrompt",i)),e.$on("save",t[10]),{c(){Ye(e.$$.fragment)},m(u,c){ze(e,u,c),s=!0},p(u,c){const l={};!n&&c&16&&(n=!0,l.showEditPanel=u[4],ke(()=>n=!1)),!r&&c&32&&(r=!0,l.currentPrompt=u[5],ke(()=>r=!1)),e.$set(l)},i(u){s||(oe(e.$$.fragment,u),s=!0)},o(u){he(e.$$.fragment,u),s=!1},d(u){We(e,u)}}}function uF(t){let e,n,r,s,a,i,o,u,c,l,d,m,p,f,g,b,_,y=t[1]&&mb(t);function S(O){t[17](O)}let I={type:"select",key:"modelSelections",style:"font-size: 12px; transition: all 0.2s ease; margin: 5px 0;  border-radius: 8px; border: 1px solid var(--b3-theme-surface-lighter); background: var(--b3-theme-surface);",fnSize:!1,options:t[0].get("modelSelections").options};t[3]!==void 0&&(I.value=t[3]),l=new pa({props:I}),_e.push(()=>Ne(l,"value",S)),l.$on("changed",t[18]),p=new Yw({props:{inputAreaComponent:t[2],prompts:t[6]}}),p.$on("edit",t[19]),p.$on("delete",t[20]),p.$on("use",t[21]);let A=t[4]&&pb(t);return{c(){e=V("div"),n=V("div"),r=V("textarea"),s=se(),y&&y.c(),a=se(),i=V("div"),o=V("button"),o.innerHTML='<span class="add-icon svelte-5yxkd9">+</span> <span class="btn-text svelte-5yxkd9"> Prompt</span>',u=se(),c=V("div"),Ye(l.$$.fragment),m=se(),Ye(p.$$.fragment),f=se(),A&&A.c(),v(r,"class","search-input svelte-5yxkd9"),v(r,"placeholder"," Prompt..."),v(n,"class","search-container svelte-5yxkd9"),v(o,"class","add-prompt-btn svelte-5yxkd9"),v(c,"class","models"),v(i,"class","tools svelte-5yxkd9"),v(e,"class","prompts-panel svelte-5yxkd9")},m(O,w){pe(O,e,w),N(e,n),N(n,r),t[13](r),Dt(r,t[1]),N(n,s),y&&y.m(n,null),N(e,a),N(e,i),N(i,o),N(i,u),N(i,c),ze(l,c,null),N(e,m),ze(p,e,null),N(e,f),A&&A.m(e,null),g=!0,b||(_=[ce(r,"input",t[14]),ce(o,"click",t[16])],b=!0)},p(O,[w]){w&2&&Dt(r,O[1]),O[1]?y?y.p(O,w):(y=mb(O),y.c(),y.m(n,null)):y&&(y.d(1),y=null);const L={};w&1&&(L.options=O[0].get("modelSelections").options),!d&&w&8&&(d=!0,L.value=O[3],ke(()=>d=!1)),l.$set(L);const D={};w&4&&(D.inputAreaComponent=O[2]),w&64&&(D.prompts=O[6]),p.$set(D),O[4]?A?(A.p(O,w),w&16&&oe(A,1)):(A=pb(O),A.c(),oe(A,1),A.m(e,null)):A&&(Ar(),he(A,1,1,()=>{A=null}),Cr())},i(O){g||(oe(l.$$.fragment,O),oe(p.$$.fragment,O),oe(A),g=!0)},o(O){he(l.$$.fragment,O),he(p.$$.fragment,O),he(A),g=!1},d(O){O&&me(e),t[13](null),y&&y.d(),We(l),We(p),A&&A.d(),b=!1,ut(_)}}}function cF(t,e,n){let r,s,{promptStorage:a}=e,{settingStorage:i}=e,o,u,c=i.getValue("modelSelections"),l=!1,d;const m=()=>({id:Date.now(),title:"",content:""}),p=Nr();function f(Q){a.deletePrompt(Q),n(12,r=a.data)}function g(Q){n(5,d=Q?{...Q}:m()),n(4,l=!0)}function b(Q){n(1,o=Q.content),p("use",Q)}function _(){r.some(x=>x.id===d.id)?a.updatePrompt(d):a.addPrompt(d),n(4,l=!1),n(12,r=a.data)}function y(Q){_e[Q?"unshift":"push"](()=>{u=Q,n(2,u)})}function S(){o=this.value,n(1,o)}const I=()=>n(1,o=""),A=()=>g();function O(Q){c=Q,n(3,c)}const w=({detail:Q})=>{i.setValue(Q.key,Q.value),i.save()},L=Q=>g(Q.detail),D=Q=>f(Q.detail),B=Q=>b(Q.detail);function ee(Q){l=Q,n(4,l)}function K(Q){d=Q,n(5,d)}return t.$$set=Q=>{"promptStorage"in Q&&n(11,a=Q.promptStorage),"settingStorage"in Q&&n(0,i=Q.settingStorage)},t.$$.update=()=>{t.$$.dirty&2048&&n(12,r=a.data),t.$$.dirty&4098&&n(6,s=(o==null?void 0:o.length)>1?r.filter(Q=>{const x=o.slice(1).toLowerCase();return Q.title.toLowerCase().includes(x)||Q.content.toLowerCase().includes(x)}):r)},[i,o,u,c,l,d,s,f,g,b,_,a,r,y,S,I,A,O,w,L,D,B,ee,K]}class lF extends dt{constructor(e){super(),lt(this,e,cF,uF,ct,{promptStorage:11,settingStorage:0})}}function gb(t){let e,n,r,s,a;function i(l){t[12](l)}function o(l){t[13](l)}function u(l){t[14](l)}let c={outputContent:t[5],lute:t[2]};return t[7]!==void 0&&(c.isInterrupted=t[7]),t[6]!==void 0&&(c.isGenerating=t[6]),t[3]!==void 0&&(c.outputContainer=t[3]),e=new Jw({props:c}),_e.push(()=>Ne(e,"isInterrupted",i)),_e.push(()=>Ne(e,"isGenerating",o)),_e.push(()=>Ne(e,"outputContainer",u)),{c(){Ye(e.$$.fragment)},m(l,d){ze(e,l,d),a=!0},p(l,d){const m={};d&32&&(m.outputContent=l[5]),d&4&&(m.lute=l[2]),!n&&d&128&&(n=!0,m.isInterrupted=l[7],ke(()=>n=!1)),!r&&d&64&&(r=!0,m.isGenerating=l[6],ke(()=>r=!1)),!s&&d&8&&(s=!0,m.outputContainer=l[3],ke(()=>s=!1)),e.$set(m)},i(l){a||(oe(e.$$.fragment,l),a=!0)},o(l){he(e.$$.fragment,l),a=!1},d(l){We(e,l)}}}function dF(t){let e,n,r,s,a,i=t[4]&&gb(t);function o(c){t[15](c)}let u={settingStorage:t[1]};return t[0]!==void 0&&(u.promptStorage=t[0]),r=new lF({props:u}),_e.push(()=>Ne(r,"promptStorage",o)),r.$on("use",t[16]),{c(){e=V("div"),i&&i.c(),n=se(),Ye(r.$$.fragment),v(e,"class","prompt-container svelte-1utspvn")},m(c,l){pe(c,e,l),i&&i.m(e,null),N(e,n),ze(r,e,null),a=!0},p(c,[l]){c[4]?i?(i.p(c,l),l&16&&oe(i,1)):(i=gb(c),i.c(),oe(i,1),i.m(e,n)):i&&(Ar(),he(i,1,1,()=>{i=null}),Cr());const d={};l&2&&(d.settingStorage=c[1]),!s&&l&1&&(s=!0,d.promptStorage=c[0],ke(()=>s=!1)),r.$set(d)},i(c){a||(oe(i),oe(r.$$.fragment,c),a=!0)},o(c){he(i),he(r.$$.fragment,c),a=!1},d(c){c&&me(e),i&&i.d(),We(r)}}}function hF(t,e,n){let{settingStorage:r}=e,{promptStorage:s}=e,{selectedText:a}=e,{pageContent:i}=e,{lute:o}=e,u=!1,c="",l=!1,d=!1,m,p="",f=!1,g=0;km(r.i18n);async function b(){n(4,u=!0),n(6,l=!0),n(5,c="");let w=[];a.trim().length>0?w.push({role:"user",content:`${a}

${p}`}):r.getValue("isPageContent")?w.push({role:"user",content:`${i.title}

${i.content}

${p}`}):w.push({role:"user",content:`${p}`});try{await So({apiKey:r.getValue("apiKey"),phone:r.getValue("phone"),model:r.getValue("modelSelections"),maxTokens:r.getValue("maxOutputLengthInstruction"),temperature:r.getValue("temperatureInstruction"),timeout:r.getValue("responseTimeoutInstruction"),isSearch:r.getValue("isSearchInstruction"),isStream:!0,isClipboard:!0,isKnowledge:!1,callback:(D,B)=>{if(d)throw new Error("User interrupted");n(5,c=D),m&&!f&&n(3,m.scrollTop=m.scrollHeight,m)},knowledgeCallback:()=>{},messages:w})}finally{n(6,l=!1)}}function _(w){w&&w.addEventListener("scroll",()=>{w.scrollTop<g&&(f=!0),g=w.scrollTop,w.scrollHeight-w.scrollTop-w.clientHeight<50&&(f=!1)})}function y(w){d=w,n(7,d)}function S(w){l=w,n(6,l)}function I(w){m=w,n(3,m)}function A(w){s=w,n(0,s)}const O=async({detail:w})=>{n(8,p=w.content),await b()};return t.$$set=w=>{"settingStorage"in w&&n(1,r=w.settingStorage),"promptStorage"in w&&n(0,s=w.promptStorage),"selectedText"in w&&n(10,a=w.selectedText),"pageContent"in w&&n(11,i=w.pageContent),"lute"in w&&n(2,o=w.lute)},t.$$.update=()=>{t.$$.dirty&8&&m&&_(m)},[s,r,o,m,u,c,l,d,p,b,a,i,y,S,I,A,O]}class fF extends dt{constructor(e){super(),lt(this,e,hF,dF,ct,{settingStorage:1,promptStorage:0,selectedText:10,pageContent:11,lute:2})}}function bb(t,e,n){const r=new An.Dialog({title:"",content:'<div id="ai-instruction"></div>',width:"40%",hideCloseIcon:!0}),s=Xb(),a=Qb();t.getValue("apiKey").trim().length<=0&&_a("API Key"),new oF({target:r.element.querySelector("#ai-instruction"),props:{settingStorage:t,promptStorage:e,documentVectorStorage:n,selectedText:s,pageContent:a,lute:window.Lute.New()}})}function _b(t,e,n,r){const s=new An.Dialog({title:"",content:'<div id="ai-chat" style="height: 100%; margin: 0; padding: 0; overflow: hidden; display:flex;min-height: 0;"></div>',width:"50%",height:"60%",hideCloseIcon:!0});new Q9({target:s.element.querySelector("#ai-chat"),props:{settingStorage:t,chatHistoryStorage:e,promptStorage:n,documentVectorStorage:r,lute:window.Lute.New()}})}function mF(t,e){const n=new An.Dialog({title:"",content:'<div id="ai-prompt"></div>',width:"30%",hideCloseIcon:!0}),r=Xb(),s=Qb();t.getValue("apiKey").trim().length<=0&&_a("API Key"),new fF({target:n.element.querySelector("#ai-prompt"),props:{settingStorage:t,promptStorage:e,selectedText:r,pageContent:s,lute:window.Lute.New()}})}function yb(t,e,n){const r=t.slice();return r[8]=e[n],r}function Eb(t){let e,n,r=t[0].i18n.settingGroup+"",s,a,i,o;function u(){return t[4](t[8])}return{c(){e=V("li"),n=V("span"),s=Qe(r),a=se(),v(n,"class","b3-list-item__text"),v(e,"data-name","editor"),v(e,"class","b3-list-item"),Oe(e,"b3-list-item--focus",t[8]===t[2])},m(c,l){pe(c,e,l),N(e,n),N(n,s),N(e,a),i||(o=[ce(e,"click",u),ce(e,"keydown",gF)],i=!0)},p(c,l){t=c,l&1&&r!==(r=t[0].i18n.settingGroup+"")&&St(s,r),l&12&&Oe(e,"b3-list-item--focus",t[8]===t[2])},d(c){c&&me(e),i=!1,ut(o)}}}function pF(t){let e,n,r,s,a,i,o,u,c,l,d,m,p,f,g=On(t[3]),b=[];for(let _=0;_<g.length;_+=1)b[_]=Eb(yb(t,g,_));return a=new zw({props:{group:t[3][0],settingStorage:t[0],display:t[2]===t[3][0]}}),a.$on("changed",t[5]),u=new bc({props:{label:t[0].i18n.cancel,text:!0,outline:!0}}),u.$on("click",t[6]),m=new bc({props:{label:t[0].i18n.confirm,text:!1,outline:!1}}),m.$on("click",t[7]),{c(){e=V("div"),n=V("ul");for(let _=0;_<b.length;_+=1)b[_].c();r=se(),s=V("div"),Ye(a.$$.fragment),i=se(),o=V("div"),Ye(u.$$.fragment),c=se(),l=V("div"),d=se(),Ye(m.$$.fragment),v(n,"class","b3-tab-bar b3-list b3-list--background"),v(l,"class","fn__space"),v(o,"class",p="b3-dialog__action "+(t[2]==t[3][0]?"":"fn__none")),v(s,"class","config__tab-wrap"),v(e,"class","fn__flex-1 fn__flex config__panel")},m(_,y){pe(_,e,y),N(e,n);for(let S=0;S<b.length;S+=1)b[S]&&b[S].m(n,null);N(e,r),N(e,s),ze(a,s,null),N(s,i),N(s,o),ze(u,o,null),N(o,c),N(o,l),N(o,d),ze(m,o,null),f=!0},p(_,[y]){if(y&13){g=On(_[3]);let O;for(O=0;O<g.length;O+=1){const w=yb(_,g,O);b[O]?b[O].p(w,y):(b[O]=Eb(w),b[O].c(),b[O].m(n,null))}for(;O<b.length;O+=1)b[O].d(1);b.length=g.length}const S={};y&1&&(S.settingStorage=_[0]),y&4&&(S.display=_[2]===_[3][0]),a.$set(S);const I={};y&1&&(I.label=_[0].i18n.cancel),u.$set(I);const A={};y&1&&(A.label=_[0].i18n.confirm),m.$set(A),(!f||y&4&&p!==(p="b3-dialog__action "+(_[2]==_[3][0]?"":"fn__none")))&&v(o,"class",p)},i(_){f||(oe(a.$$.fragment,_),oe(u.$$.fragment,_),oe(m.$$.fragment,_),f=!0)},o(_){he(a.$$.fragment,_),he(u.$$.fragment,_),he(m.$$.fragment,_),f=!1},d(_){_&&me(e),Ac(b,_),We(a),We(u),We(m)}}}const gF=()=>{};function bF(t,e,n){let r=[" "],s=r[0],{settingStorage:a}=e,{dialog:i}=e;const o=d=>{n(2,s=d)},u=({detail:d})=>{a.setValue(d.key,d.value)},c=()=>{a.load(),i.destroy()},l=()=>{a.save(),i.destroy()};return t.$$set=d=>{"settingStorage"in d&&n(0,a=d.settingStorage),"dialog"in d&&n(1,i=d.dialog)},[a,i,s,r,o,u,c,l]}class _F extends dt{constructor(e){super(),lt(this,e,bF,pF,ct,{settingStorage:0,dialog:1})}}const yF=`<symbol id="iconFace" viewBox="0 0 32 32">
<path d="M13.667 17.333c0 0.92-0.747 1.667-1.667 1.667s-1.667-0.747-1.667-1.667 0.747-1.667 1.667-1.667 1.667 0.747 1.667 1.667zM20 15.667c-0.92 0-1.667 0.747-1.667 1.667s0.747 1.667 1.667 1.667 1.667-0.747 1.667-1.667-0.747-1.667-1.667-1.667zM29.333 16c0 7.36-5.973 13.333-13.333 13.333s-13.333-5.973-13.333-13.333 5.973-13.333 13.333-13.333 13.333 5.973 13.333 13.333zM14.213 5.493c1.867 3.093 5.253 5.173 9.12 5.173 0.613 0 1.213-0.067 1.787-0.16-1.867-3.093-5.253-5.173-9.12-5.173-0.613 0-1.213 0.067-1.787 0.16zM5.893 12.627c2.28-1.293 4.040-3.4 4.88-5.92-2.28 1.293-4.040 3.4-4.88 5.92zM26.667 16c0-1.040-0.16-2.040-0.44-2.987-0.933 0.2-1.893 0.32-2.893 0.32-4.173 0-7.893-1.92-10.347-4.92-1.4 3.413-4.187 6.093-7.653 7.4 0.013 0.053 0 0.12 0 0.187 0 5.88 4.787 10.667 10.667 10.667s10.667-4.787 10.667-10.667z"></path>
</symbol>`,EF=`<symbol id="iconSaving" viewBox="0 0 32 32">
<path d="M20 13.333c0-0.733 0.6-1.333 1.333-1.333s1.333 0.6 1.333 1.333c0 0.733-0.6 1.333-1.333 1.333s-1.333-0.6-1.333-1.333zM10.667 12h6.667v-2.667h-6.667v2.667zM29.333 10v9.293l-3.76 1.253-2.24 7.453h-7.333v-2.667h-2.667v2.667h-7.333c0 0-3.333-11.28-3.333-15.333s3.28-7.333 7.333-7.333h6.667c1.213-1.613 3.147-2.667 5.333-2.667 1.107 0 2 0.893 2 2 0 0.28-0.053 0.533-0.16 0.773-0.187 0.453-0.347 0.973-0.427 1.533l3.027 3.027h2.893zM26.667 12.667h-1.333l-4.667-4.667c0-0.867 0.12-1.72 0.347-2.547-1.293 0.333-2.347 1.293-2.787 2.547h-8.227c-2.573 0-4.667 2.093-4.667 4.667 0 2.507 1.627 8.867 2.68 12.667h2.653v-2.667h8v2.667h2.68l2.067-6.867 3.253-1.093v-4.707z"></path>
</symbol>`,wF=`<symbol id="iconChat" viewBox="0 0 32 32">
  <path d="M16 2C8.268 2 2 8.268 2 16c0 2.25.54 4.373 1.5 6.25L1 29l6.75-2.5c1.876.96 4 1.5 6.25 1.5 7.732 0 14-6.268 14-14S23.732 2 16 2zm0 2c6.627 0 12 5.373 12 12s-5.373 12-12 12c-2.027 0-3.93-.506-5.602-1.397l-.467-.25-4.18 1.547 1.547-4.18-.25-.467C5.506 21.93 5 20.027 5 18c0-6.627 5.373-12 12-12zm-5 10v4h3v-4h-3zm7 0v4h3v-4h-3z"></path>
</symbol>
`,TF=`<symbol id="iconInstruction" viewBox="0 0 32 32">
  <path d="M28 16c0 6.627-5.373 12-12 12S4 22.627 4 16 9.373 4 16 4s12 5.373 12 12zM16 2C8.268 2 2 8.268 2 16s6.268 14 14 14 14-6.268 14-14S23.732 2 16 2zm-2 9.5v3h-2v3h2v3h4v-3h2v-3h-2v-3h-4zm1 1h2v2h2v1h-2v2h-2v-2h-2v-1h2v-2z"/>
</symbol>`;class SF extends An.Plugin{constructor(n){super(n);Ie(this,"_isMobile");Ie(this,"_settingStorage");Ie(this,"_promptStorage");Ie(this,"_chatHistoryStorage");Ie(this,"_documentVectorStorage");Ie(this,"_blockStorage");Ie(this,"_apiClient");this._apiClient=new jA,this._settingStorage=new KB(this,$d),this._promptStorage=new GB(this,qd),this._chatHistoryStorage=new WB(this,i_),this._isMobile=An.getFrontend()==="mobile"||An.getFrontend()==="browser-mobile"}async onload(){console.debug("onload...."),await this._settingStorage.load(),this.addIcons(yF),this.addIcons(EF),this.addIcons(wF),this.addIcons(TF),this.addTopBar({icon:"iconInstruction",title:this.i18n.instructionMode,position:"right",callback:()=>bb(this._settingStorage,this._promptStorage,this._documentVectorStorage)}),this.addTopBar({icon:"iconChat",title:"",position:"right",callback:()=>_b(this._settingStorage,this._chatHistoryStorage,this._promptStorage,this._documentVectorStorage)});const n=this._settingStorage.getValue("isVectorOnline"),r=this._settingStorage.getValue("phoneNumber"),s=this._settingStorage.getValue("apiKey"),a=this._settingStorage.getValue("includeKnowledgeBook"),i=this._settingStorage.getValue("excludeKnowledgeBook"),o=await Xi(s);o.money<=0&&Xs(this.i18n.balanceInsufficientMsg.replace("${balance}",String(Math.round(o.money*10)/10))),o.expiredTime<Math.floor(Date.now()/1e3)&&Xs(this.i18n.apiKeyExpiredMsg),n&&r?this._documentVectorStorage=new x9(this,Vd,s,r):this._documentVectorStorage=new P9(this,Vd,s,r),this._blockStorage=new zB(this,o_,s,this._documentVectorStorage,a,i),Xi(s).then(u=>{u.money>0&&u.expiredTime>Math.floor(Date.now()/1e3)&&(console.debug("apiKey "),this._blockStorage.load(),this._promptStorage.load(),this._chatHistoryStorage.load())}),this.addCommand({langKey:"",hotkey:"K",callback:()=>bb(this._settingStorage,this._promptStorage,this._documentVectorStorage)}),this.addCommand({langKey:"",hotkey:"L",callback:()=>_b(this._settingStorage,this._chatHistoryStorage,this._promptStorage,this._documentVectorStorage)}),this.addCommand({langKey:"prompts",hotkey:"S",callback:()=>mF(this._settingStorage,this._promptStorage)}),console.debug("onload....end")}onLayoutReady(){}uninstall(){this.removeData($d),this.removeData(qd),_a("AI")}openSetting(){if(!this._settingStorage)return;if(this._isMobile){Xs("");return}let n=new An.Dialog({title:"AI",width:"70%",height:"60%",content:'<div class="b3-dialog__content" id="AISettingPanel" ></div>'});new _F({target:n.element.querySelector("#AISettingPanel"),props:{settingStorage:this._settingStorage,dialog:n}})}}module.exports=SF;
