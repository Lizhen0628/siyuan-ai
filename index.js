"use strict";var Vw=Object.defineProperty;var zw=(t,e,n)=>e in t?Vw(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var ve=(t,e,n)=>zw(t,typeof e!="symbol"?e+"":e,n);const Dn=require("siyuan");var Ww=Object.defineProperty,Gw=(t,e,n)=>e in t?Ww(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,un=(t,e,n)=>Gw(t,typeof e!="symbol"?e+"":e,n);function bb(t,e){return function(){return t.apply(e,arguments)}}const{toString:Kw}=Object.prototype,{getPrototypeOf:Kh}=Object,bc=(t=>e=>{const n=Kw.call(e);return t[n]||(t[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),zn=t=>(t=t.toLowerCase(),e=>bc(e)===t),_c=t=>e=>typeof e===t,{isArray:pa}=Array,Ei=_c("undefined");function Yw(t){return t!==null&&!Ei(t)&&t.constructor!==null&&!Ei(t.constructor)&&dn(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const _b=zn("ArrayBuffer");function Zw(t){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(t):e=t&&t.buffer&&_b(t.buffer),e}const Jw=_c("string"),dn=_c("function"),yb=_c("number"),yc=t=>t!==null&&typeof t=="object",Xw=t=>t===!0||t===!1,du=t=>{if(bc(t)!=="object")return!1;const e=Kh(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},Qw=zn("Date"),eT=zn("File"),tT=zn("Blob"),nT=zn("FileList"),rT=t=>yc(t)&&dn(t.pipe),sT=t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||dn(t.append)&&((e=bc(t))==="formdata"||e==="object"&&dn(t.toString)&&t.toString()==="[object FormData]"))},aT=zn("URLSearchParams"),[iT,oT,uT,cT]=["ReadableStream","Request","Response","Headers"].map(zn),lT=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Xi(t,e,{allOwnKeys:n=!1}={}){if(t===null||typeof t>"u")return;let r,s;if(typeof t!="object"&&(t=[t]),pa(t))for(r=0,s=t.length;r<s;r++)e.call(null,t[r],r,t);else{const a=n?Object.getOwnPropertyNames(t):Object.keys(t),i=a.length;let o;for(r=0;r<i;r++)o=a[r],e.call(null,t[o],o,t)}}function Eb(t,e){e=e.toLowerCase();const n=Object.keys(t);let r=n.length,s;for(;r-- >0;)if(s=n[r],e===s.toLowerCase())return s;return null}const rs=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,wb=t=>!Ei(t)&&t!==rs;function kd(){const{caseless:t}=wb(this)&&this||{},e={},n=(r,s)=>{const a=t&&Eb(e,s)||s;du(e[a])&&du(r)?e[a]=kd(e[a],r):du(r)?e[a]=kd({},r):pa(r)?e[a]=r.slice():e[a]=r};for(let r=0,s=arguments.length;r<s;r++)arguments[r]&&Xi(arguments[r],n);return e}const dT=(t,e,n,{allOwnKeys:r}={})=>(Xi(e,(s,a)=>{n&&dn(s)?t[a]=bb(s,n):t[a]=s},{allOwnKeys:r}),t),hT=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),fT=(t,e,n,r)=>{t.prototype=Object.create(e.prototype,r),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},mT=(t,e,n,r)=>{let s,a,i;const o={};if(e=e||{},t==null)return e;do{for(s=Object.getOwnPropertyNames(t),a=s.length;a-- >0;)i=s[a],(!r||r(i,t,e))&&!o[i]&&(e[i]=t[i],o[i]=!0);t=n!==!1&&Kh(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},pT=(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;const r=t.indexOf(e,n);return r!==-1&&r===n},gT=t=>{if(!t)return null;if(pa(t))return t;let e=t.length;if(!yb(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},bT=(t=>e=>t&&e instanceof t)(typeof Uint8Array<"u"&&Kh(Uint8Array)),_T=(t,e)=>{const n=(t&&t[Symbol.iterator]).call(t);let r;for(;(r=n.next())&&!r.done;){const s=r.value;e.call(t,s[0],s[1])}},yT=(t,e)=>{let n;const r=[];for(;(n=t.exec(e))!==null;)r.push(n);return r},ET=zn("HTMLFormElement"),wT=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,r){return n.toUpperCase()+r}),km=(({hasOwnProperty:t})=>(e,n)=>t.call(e,n))(Object.prototype),TT=zn("RegExp"),Tb=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),r={};Xi(n,(s,a)=>{let i;(i=e(s,a,t))!==!1&&(r[a]=i||s)}),Object.defineProperties(t,r)},ST=t=>{Tb(t,(e,n)=>{if(dn(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const r=t[n];if(dn(r)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")})}})},AT=(t,e)=>{const n={},r=s=>{s.forEach(a=>{n[a]=!0})};return pa(t)?r(t):r(String(t).split(e)),n},CT=()=>{},OT=(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,pl="abcdefghijklmnopqrstuvwxyz",Rm="0123456789",Sb={DIGIT:Rm,ALPHA:pl,ALPHA_DIGIT:pl+pl.toUpperCase()+Rm},vT=(t=16,e=Sb.ALPHA_DIGIT)=>{let n="";const{length:r}=e;for(;t--;)n+=e[Math.random()*r|0];return n};function IT(t){return!!(t&&dn(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])}const NT=t=>{const e=new Array(10),n=(r,s)=>{if(yc(r)){if(e.indexOf(r)>=0)return;if(!("toJSON"in r)){e[s]=r;const a=pa(r)?[]:{};return Xi(r,(i,o)=>{const u=n(i,s+1);!Ei(u)&&(a[o]=u)}),e[s]=void 0,a}}return r};return n(t,0)},kT=zn("AsyncFunction"),RT=t=>t&&(yc(t)||dn(t))&&dn(t.then)&&dn(t.catch),Ab=((t,e)=>t?setImmediate:e?((n,r)=>(rs.addEventListener("message",({source:s,data:a})=>{s===rs&&a===n&&r.length&&r.shift()()},!1),s=>{r.push(s),rs.postMessage(n,"*")}))(`axios@${Math.random()}`,[]):n=>setTimeout(n))(typeof setImmediate=="function",dn(rs.postMessage)),PT=typeof queueMicrotask<"u"?queueMicrotask.bind(rs):typeof process<"u"&&process.nextTick||Ab,j={isArray:pa,isArrayBuffer:_b,isBuffer:Yw,isFormData:sT,isArrayBufferView:Zw,isString:Jw,isNumber:yb,isBoolean:Xw,isObject:yc,isPlainObject:du,isReadableStream:iT,isRequest:oT,isResponse:uT,isHeaders:cT,isUndefined:Ei,isDate:Qw,isFile:eT,isBlob:tT,isRegExp:TT,isFunction:dn,isStream:rT,isURLSearchParams:aT,isTypedArray:bT,isFileList:nT,forEach:Xi,merge:kd,extend:dT,trim:lT,stripBOM:hT,inherits:fT,toFlatObject:mT,kindOf:bc,kindOfTest:zn,endsWith:pT,toArray:gT,forEachEntry:_T,matchAll:yT,isHTMLForm:ET,hasOwnProperty:km,hasOwnProp:km,reduceDescriptors:Tb,freezeMethods:ST,toObjectSet:AT,toCamelCase:wT,noop:CT,toFiniteNumber:OT,findKey:Eb,global:rs,isContextDefined:wb,ALPHABET:Sb,generateString:vT,isSpecCompliantForm:IT,toJSONObject:NT,isAsyncFn:kT,isThenable:RT,setImmediate:Ab,asap:PT};function _e(t,e,n,r,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),r&&(this.request=r),s&&(this.response=s,this.status=s.status?s.status:null)}j.inherits(_e,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:j.toJSONObject(this.config),code:this.code,status:this.status}}});const Cb=_e.prototype,Ob={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Ob[t]={value:t}});Object.defineProperties(_e,Ob);Object.defineProperty(Cb,"isAxiosError",{value:!0});_e.from=(t,e,n,r,s,a)=>{const i=Object.create(Cb);return j.toFlatObject(t,i,function(o){return o!==Error.prototype},o=>o!=="isAxiosError"),_e.call(i,t.message,e,n,r,s),i.cause=t,i.name=t.name,a&&Object.assign(i,a),i};const xT=null;function Rd(t){return j.isPlainObject(t)||j.isArray(t)}function vb(t){return j.endsWith(t,"[]")?t.slice(0,-2):t}function Pm(t,e,n){return t?t.concat(e).map(function(r,s){return r=vb(r),!n&&s?"["+r+"]":r}).join(n?".":""):e}function LT(t){return j.isArray(t)&&!t.some(Rd)}const DT=j.toFlatObject(j,{},null,function(t){return/^is[A-Z]/.test(t)});function Ec(t,e,n){if(!j.isObject(t))throw new TypeError("target must be an object");e=e||new FormData,n=j.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(m,f){return!j.isUndefined(f[m])});const r=n.metaTokens,s=n.visitor||c,a=n.dots,i=n.indexes,o=(n.Blob||typeof Blob<"u"&&Blob)&&j.isSpecCompliantForm(e);if(!j.isFunction(s))throw new TypeError("visitor must be a function");function u(m){if(m===null)return"";if(j.isDate(m))return m.toISOString();if(!o&&j.isBlob(m))throw new _e("Blob is not supported. Use a Buffer instead.");return j.isArrayBuffer(m)||j.isTypedArray(m)?o&&typeof Blob=="function"?new Blob([m]):Buffer.from(m):m}function c(m,f,g){let b=m;if(m&&!g&&typeof m=="object"){if(j.endsWith(f,"{}"))f=r?f:f.slice(0,-2),m=JSON.stringify(m);else if(j.isArray(m)&&LT(m)||(j.isFileList(m)||j.endsWith(f,"[]"))&&(b=j.toArray(m)))return f=vb(f),b.forEach(function(_,E){!(j.isUndefined(_)||_===null)&&e.append(i===!0?Pm([f],E,a):i===null?f:f+"[]",u(_))}),!1}return Rd(m)?!0:(e.append(Pm(g,f,a),u(m)),!1)}const l=[],d=Object.assign(DT,{defaultVisitor:c,convertValue:u,isVisitable:Rd});function p(m,f){if(!j.isUndefined(m)){if(l.indexOf(m)!==-1)throw Error("Circular reference detected in "+f.join("."));l.push(m),j.forEach(m,function(g,b){(!(j.isUndefined(g)||g===null)&&s.call(e,g,j.isString(b)?b.trim():b,f,d))===!0&&p(g,f?f.concat(b):[b])}),l.pop()}}if(!j.isObject(t))throw new TypeError("data must be an object");return p(t),e}function xm(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function Yh(t,e){this._pairs=[],t&&Ec(t,this,e)}const Ib=Yh.prototype;Ib.append=function(t,e){this._pairs.push([t,e])};Ib.toString=function(t){const e=t?function(n){return t.call(this,n,xm)}:xm;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};function MT(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Nb(t,e,n){if(!e)return t;const r=n&&n.encode||MT,s=n&&n.serialize;let a;if(s?a=s(e,n):a=j.isURLSearchParams(e)?e.toString():new Yh(e,n).toString(r),a){const i=t.indexOf("#");i!==-1&&(t=t.slice(0,i)),t+=(t.indexOf("?")===-1?"?":"&")+a}return t}class Lm{constructor(){this.handlers=[]}use(e,n,r){return this.handlers.push({fulfilled:e,rejected:n,synchronous:r?r.synchronous:!1,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){j.forEach(this.handlers,function(n){n!==null&&e(n)})}}const kb={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},BT=typeof URLSearchParams<"u"?URLSearchParams:Yh,FT=typeof FormData<"u"?FormData:null,UT=typeof Blob<"u"?Blob:null,jT={isBrowser:!0,classes:{URLSearchParams:BT,FormData:FT,Blob:UT},protocols:["http","https","file","blob","url","data"]},Zh=typeof window<"u"&&typeof document<"u",Pd=typeof navigator=="object"&&navigator||void 0,$T=Zh&&(!Pd||["ReactNative","NativeScript","NS"].indexOf(Pd.product)<0),HT=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",qT=Zh&&window.location.href||"http://localhost",VT=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Zh,hasStandardBrowserEnv:$T,hasStandardBrowserWebWorkerEnv:HT,navigator:Pd,origin:qT},Symbol.toStringTag,{value:"Module"})),Xt={...VT,...jT};function zT(t,e){return Ec(t,new Xt.classes.URLSearchParams,Object.assign({visitor:function(n,r,s,a){return Xt.isNode&&j.isBuffer(n)?(this.append(r,n.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},e))}function WT(t){return j.matchAll(/\w+|\[(\w*)]/g,t).map(e=>e[0]==="[]"?"":e[1]||e[0])}function GT(t){const e={},n=Object.keys(t);let r;const s=n.length;let a;for(r=0;r<s;r++)a=n[r],e[a]=t[a];return e}function Rb(t){function e(n,r,s,a){let i=n[a++];if(i==="__proto__")return!0;const o=Number.isFinite(+i),u=a>=n.length;return i=!i&&j.isArray(s)?s.length:i,u?(j.hasOwnProp(s,i)?s[i]=[s[i],r]:s[i]=r,!o):((!s[i]||!j.isObject(s[i]))&&(s[i]=[]),e(n,r,s[i],a)&&j.isArray(s[i])&&(s[i]=GT(s[i])),!o)}if(j.isFormData(t)&&j.isFunction(t.entries)){const n={};return j.forEachEntry(t,(r,s)=>{e(WT(r),s,n,0)}),n}return null}function KT(t,e,n){if(j.isString(t))try{return(e||JSON.parse)(t),j.trim(t)}catch(r){if(r.name!=="SyntaxError")throw r}return(0,JSON.stringify)(t)}const Qi={transitional:kb,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){const n=e.getContentType()||"",r=n.indexOf("application/json")>-1,s=j.isObject(t);if(s&&j.isHTMLForm(t)&&(t=new FormData(t)),j.isFormData(t))return r?JSON.stringify(Rb(t)):t;if(j.isArrayBuffer(t)||j.isBuffer(t)||j.isStream(t)||j.isFile(t)||j.isBlob(t)||j.isReadableStream(t))return t;if(j.isArrayBufferView(t))return t.buffer;if(j.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let a;if(s){if(n.indexOf("application/x-www-form-urlencoded")>-1)return zT(t,this.formSerializer).toString();if((a=j.isFileList(t))||n.indexOf("multipart/form-data")>-1){const i=this.env&&this.env.FormData;return Ec(a?{"files[]":t}:t,i&&new i,this.formSerializer)}}return s||r?(e.setContentType("application/json",!1),KT(t)):t}],transformResponse:[function(t){const e=this.transitional||Qi.transitional,n=e&&e.forcedJSONParsing,r=this.responseType==="json";if(j.isResponse(t)||j.isReadableStream(t))return t;if(t&&j.isString(t)&&(n&&!this.responseType||r)){const s=!(e&&e.silentJSONParsing)&&r;try{return JSON.parse(t)}catch(a){if(s)throw a.name==="SyntaxError"?_e.from(a,_e.ERR_BAD_RESPONSE,this,null,this.response):a}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Xt.classes.FormData,Blob:Xt.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};j.forEach(["delete","get","head","post","put","patch"],t=>{Qi.headers[t]={}});const YT=j.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),ZT=t=>{const e={};let n,r,s;return t&&t.split(`
`).forEach(function(a){s=a.indexOf(":"),n=a.substring(0,s).trim().toLowerCase(),r=a.substring(s+1).trim(),!(!n||e[n]&&YT[n])&&(n==="set-cookie"?e[n]?e[n].push(r):e[n]=[r]:e[n]=e[n]?e[n]+", "+r:r)}),e},Dm=Symbol("internals");function Pa(t){return t&&String(t).trim().toLowerCase()}function hu(t){return t===!1||t==null?t:j.isArray(t)?t.map(hu):String(t)}function JT(t){const e=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=n.exec(t);)e[r[1]]=r[2];return e}const XT=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function gl(t,e,n,r,s){if(j.isFunction(r))return r.call(this,e,n);if(s&&(e=n),!!j.isString(e)){if(j.isString(r))return e.indexOf(r)!==-1;if(j.isRegExp(r))return r.test(e)}}function QT(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,n,r)=>n.toUpperCase()+r)}function eS(t,e){const n=j.toCamelCase(" "+e);["get","set","has"].forEach(r=>{Object.defineProperty(t,r+n,{value:function(s,a,i){return this[r].call(this,e,s,a,i)},configurable:!0})})}let Qt=class{constructor(t){t&&this.set(t)}set(t,e,n){const r=this;function s(i,o,u){const c=Pa(o);if(!c)throw new Error("header name must be a non-empty string");const l=j.findKey(r,c);(!l||r[l]===void 0||u===!0||u===void 0&&r[l]!==!1)&&(r[l||o]=hu(i))}const a=(i,o)=>j.forEach(i,(u,c)=>s(u,c,o));if(j.isPlainObject(t)||t instanceof this.constructor)a(t,e);else if(j.isString(t)&&(t=t.trim())&&!XT(t))a(ZT(t),e);else if(j.isHeaders(t))for(const[i,o]of t.entries())s(o,i,n);else t!=null&&s(e,t,n);return this}get(t,e){if(t=Pa(t),t){const n=j.findKey(this,t);if(n){const r=this[n];if(!e)return r;if(e===!0)return JT(r);if(j.isFunction(e))return e.call(this,r,n);if(j.isRegExp(e))return e.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,e){if(t=Pa(t),t){const n=j.findKey(this,t);return!!(n&&this[n]!==void 0&&(!e||gl(this,this[n],n,e)))}return!1}delete(t,e){const n=this;let r=!1;function s(a){if(a=Pa(a),a){const i=j.findKey(n,a);i&&(!e||gl(n,n[i],i,e))&&(delete n[i],r=!0)}}return j.isArray(t)?t.forEach(s):s(t),r}clear(t){const e=Object.keys(this);let n=e.length,r=!1;for(;n--;){const s=e[n];(!t||gl(this,this[s],s,t,!0))&&(delete this[s],r=!0)}return r}normalize(t){const e=this,n={};return j.forEach(this,(r,s)=>{const a=j.findKey(n,s);if(a){e[a]=hu(r),delete e[s];return}const i=t?QT(s):String(s).trim();i!==s&&delete e[s],e[i]=hu(r),n[i]=!0}),this}concat(...t){return this.constructor.concat(this,...t)}toJSON(t){const e=Object.create(null);return j.forEach(this,(n,r)=>{n!=null&&n!==!1&&(e[r]=t&&j.isArray(n)?n.join(", "):n)}),e}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([t,e])=>t+": "+e).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t,...e){const n=new this(t);return e.forEach(r=>n.set(r)),n}static accessor(t){const e=(this[Dm]=this[Dm]={accessors:{}}).accessors,n=this.prototype;function r(s){const a=Pa(s);e[a]||(eS(n,s),e[a]=!0)}return j.isArray(t)?t.forEach(r):r(t),this}};Qt.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);j.reduceDescriptors(Qt.prototype,({value:t},e)=>{let n=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(r){this[n]=r}}});j.freezeMethods(Qt);function bl(t,e){const n=this||Qi,r=e||n,s=Qt.from(r.headers);let a=r.data;return j.forEach(t,function(i){a=i.call(n,a,s.normalize(),e?e.status:void 0)}),s.normalize(),a}function Pb(t){return!!(t&&t.__CANCEL__)}function ga(t,e,n){_e.call(this,t??"canceled",_e.ERR_CANCELED,e,n),this.name="CanceledError"}j.inherits(ga,_e,{__CANCEL__:!0});function xb(t,e,n){const r=n.config.validateStatus;!n.status||!r||r(n.status)?t(n):e(new _e("Request failed with status code "+n.status,[_e.ERR_BAD_REQUEST,_e.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n))}function tS(t){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}function nS(t,e){t=t||10;const n=new Array(t),r=new Array(t);let s=0,a=0,i;return e=e!==void 0?e:1e3,function(o){const u=Date.now(),c=r[a];i||(i=u),n[s]=o,r[s]=u;let l=a,d=0;for(;l!==s;)d+=n[l++],l=l%t;if(s=(s+1)%t,s===a&&(a=(a+1)%t),u-i<e)return;const p=c&&u-c;return p?Math.round(d*1e3/p):void 0}}function rS(t,e){let n=0,r=1e3/e,s,a;const i=(o,u=Date.now())=>{n=u,s=null,a&&(clearTimeout(a),a=null),t.apply(null,o)};return[(...o)=>{const u=Date.now(),c=u-n;c>=r?i(o,u):(s=o,a||(a=setTimeout(()=>{a=null,i(s)},r-c)))},()=>s&&i(s)]}const vu=(t,e,n=3)=>{let r=0;const s=nS(50,250);return rS(a=>{const i=a.loaded,o=a.lengthComputable?a.total:void 0,u=i-r,c=s(u),l=i<=o;r=i;const d={loaded:i,total:o,progress:o?i/o:void 0,bytes:u,rate:c||void 0,estimated:c&&o&&l?(o-i)/c:void 0,event:a,lengthComputable:o!=null,[e?"download":"upload"]:!0};t(d)},n)},Mm=(t,e)=>{const n=t!=null;return[r=>e[0]({lengthComputable:n,total:t,loaded:r}),e[1]]},Bm=t=>(...e)=>j.asap(()=>t(...e)),sS=Xt.hasStandardBrowserEnv?function(){const t=Xt.navigator&&/(msie|trident)/i.test(Xt.navigator.userAgent),e=document.createElement("a");let n;function r(s){let a=s;return t&&(e.setAttribute("href",a),a=e.href),e.setAttribute("href",a),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:e.pathname.charAt(0)==="/"?e.pathname:"/"+e.pathname}}return n=r(window.location.href),function(s){const a=j.isString(s)?r(s):s;return a.protocol===n.protocol&&a.host===n.host}}():function(){return function(){return!0}}(),aS=Xt.hasStandardBrowserEnv?{write(t,e,n,r,s,a){const i=[t+"="+encodeURIComponent(e)];j.isNumber(n)&&i.push("expires="+new Date(n).toGMTString()),j.isString(r)&&i.push("path="+r),j.isString(s)&&i.push("domain="+s),a===!0&&i.push("secure"),document.cookie=i.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function iS(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function oS(t,e){return e?t.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):t}function Lb(t,e){return t&&!iS(e)?oS(t,e):e}const Fm=t=>t instanceof Qt?{...t}:t;function gs(t,e){e=e||{};const n={};function r(c,l,d){return j.isPlainObject(c)&&j.isPlainObject(l)?j.merge.call({caseless:d},c,l):j.isPlainObject(l)?j.merge({},l):j.isArray(l)?l.slice():l}function s(c,l,d){if(j.isUndefined(l)){if(!j.isUndefined(c))return r(void 0,c,d)}else return r(c,l,d)}function a(c,l){if(!j.isUndefined(l))return r(void 0,l)}function i(c,l){if(j.isUndefined(l)){if(!j.isUndefined(c))return r(void 0,c)}else return r(void 0,l)}function o(c,l,d){if(d in e)return r(c,l);if(d in t)return r(void 0,c)}const u={url:a,method:a,data:a,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:o,headers:(c,l)=>s(Fm(c),Fm(l),!0)};return j.forEach(Object.keys(Object.assign({},t,e)),function(c){const l=u[c]||s,d=l(t[c],e[c],c);j.isUndefined(d)&&l!==o||(n[c]=d)}),n}const Db=t=>{const e=gs({},t);let{data:n,withXSRFToken:r,xsrfHeaderName:s,xsrfCookieName:a,headers:i,auth:o}=e;e.headers=i=Qt.from(i),e.url=Nb(Lb(e.baseURL,e.url),t.params,t.paramsSerializer),o&&i.set("Authorization","Basic "+btoa((o.username||"")+":"+(o.password?unescape(encodeURIComponent(o.password)):"")));let u;if(j.isFormData(n)){if(Xt.hasStandardBrowserEnv||Xt.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((u=i.getContentType())!==!1){const[c,...l]=u?u.split(";").map(d=>d.trim()).filter(Boolean):[];i.setContentType([c||"multipart/form-data",...l].join("; "))}}if(Xt.hasStandardBrowserEnv&&(r&&j.isFunction(r)&&(r=r(e)),r||r!==!1&&sS(e.url))){const c=s&&a&&aS.read(a);c&&i.set(s,c)}return e},uS=typeof XMLHttpRequest<"u",cS=uS&&function(t){return new Promise(function(e,n){const r=Db(t);let s=r.data;const a=Qt.from(r.headers).normalize();let{responseType:i,onUploadProgress:o,onDownloadProgress:u}=r,c,l,d,p,m;function f(){p&&p(),m&&m(),r.cancelToken&&r.cancelToken.unsubscribe(c),r.signal&&r.signal.removeEventListener("abort",c)}let g=new XMLHttpRequest;g.open(r.method.toUpperCase(),r.url,!0),g.timeout=r.timeout;function b(){if(!g)return;const E=Qt.from("getAllResponseHeaders"in g&&g.getAllResponseHeaders()),T={data:!i||i==="text"||i==="json"?g.responseText:g.response,status:g.status,statusText:g.statusText,headers:E,config:t,request:g};xb(function(N){e(N),f()},function(N){n(N),f()},T),g=null}"onloadend"in g?g.onloadend=b:g.onreadystatechange=function(){!g||g.readyState!==4||g.status===0&&!(g.responseURL&&g.responseURL.indexOf("file:")===0)||setTimeout(b)},g.onabort=function(){g&&(n(new _e("Request aborted",_e.ECONNABORTED,t,g)),g=null)},g.onerror=function(){n(new _e("Network Error",_e.ERR_NETWORK,t,g)),g=null},g.ontimeout=function(){let E=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const T=r.transitional||kb;r.timeoutErrorMessage&&(E=r.timeoutErrorMessage),n(new _e(E,T.clarifyTimeoutError?_e.ETIMEDOUT:_e.ECONNABORTED,t,g)),g=null},s===void 0&&a.setContentType(null),"setRequestHeader"in g&&j.forEach(a.toJSON(),function(E,T){g.setRequestHeader(T,E)}),j.isUndefined(r.withCredentials)||(g.withCredentials=!!r.withCredentials),i&&i!=="json"&&(g.responseType=r.responseType),u&&([d,m]=vu(u,!0),g.addEventListener("progress",d)),o&&g.upload&&([l,p]=vu(o),g.upload.addEventListener("progress",l),g.upload.addEventListener("loadend",p)),(r.cancelToken||r.signal)&&(c=E=>{g&&(n(!E||E.type?new ga(null,t,g):E),g.abort(),g=null)},r.cancelToken&&r.cancelToken.subscribe(c),r.signal&&(r.signal.aborted?c():r.signal.addEventListener("abort",c)));const _=tS(r.url);if(_&&Xt.protocols.indexOf(_)===-1){n(new _e("Unsupported protocol "+_+":",_e.ERR_BAD_REQUEST,t));return}g.send(s||null)})},lS=(t,e)=>{const{length:n}=t=t?t.filter(Boolean):[];if(e||n){let r=new AbortController,s;const a=function(c){if(!s){s=!0,o();const l=c instanceof Error?c:this.reason;r.abort(l instanceof _e?l:new ga(l instanceof Error?l.message:l))}};let i=e&&setTimeout(()=>{i=null,a(new _e(`timeout ${e} of ms exceeded`,_e.ETIMEDOUT))},e);const o=()=>{t&&(i&&clearTimeout(i),i=null,t.forEach(c=>{c.unsubscribe?c.unsubscribe(a):c.removeEventListener("abort",a)}),t=null)};t.forEach(c=>c.addEventListener("abort",a));const{signal:u}=r;return u.unsubscribe=()=>j.asap(o),u}},dS=function*(t,e){let n=t.byteLength;if(n<e){yield t;return}let r=0,s;for(;r<n;)s=r+e,yield t.slice(r,s),r=s},hS=async function*(t,e){for await(const n of fS(t))yield*dS(n,e)},fS=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const e=t.getReader();try{for(;;){const{done:n,value:r}=await e.read();if(n)break;yield r}}finally{await e.cancel()}},Um=(t,e,n,r)=>{const s=hS(t,e);let a=0,i,o=u=>{i||(i=!0,r&&r(u))};return new ReadableStream({async pull(u){try{const{done:c,value:l}=await s.next();if(c){o(),u.close();return}let d=l.byteLength;if(n){let p=a+=d;n(p)}u.enqueue(new Uint8Array(l))}catch(c){throw o(c),c}},cancel(u){return o(u),s.return()}},{highWaterMark:2})},wc=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",Mb=wc&&typeof ReadableStream=="function",mS=wc&&(typeof TextEncoder=="function"?(t=>e=>t.encode(e))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),Bb=(t,...e)=>{try{return!!t(...e)}catch{return!1}},pS=Mb&&Bb(()=>{let t=!1;const e=new Request(Xt.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),jm=64*1024,xd=Mb&&Bb(()=>j.isReadableStream(new Response("").body)),Iu={stream:xd&&(t=>t.body)};wc&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!Iu[e]&&(Iu[e]=j.isFunction(t[e])?n=>n[e]():(n,r)=>{throw new _e(`Response type '${e}' is not supported`,_e.ERR_NOT_SUPPORT,r)})})})(new Response);const gS=async t=>{if(t==null)return 0;if(j.isBlob(t))return t.size;if(j.isSpecCompliantForm(t))return(await new Request(Xt.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(j.isArrayBufferView(t)||j.isArrayBuffer(t))return t.byteLength;if(j.isURLSearchParams(t)&&(t=t+""),j.isString(t))return(await mS(t)).byteLength},bS=async(t,e)=>j.toFiniteNumber(t.getContentLength())??gS(e),_S=wc&&(async t=>{let{url:e,method:n,data:r,signal:s,cancelToken:a,timeout:i,onDownloadProgress:o,onUploadProgress:u,responseType:c,headers:l,withCredentials:d="same-origin",fetchOptions:p}=Db(t);c=c?(c+"").toLowerCase():"text";let m=lS([s,a&&a.toAbortSignal()],i),f;const g=m&&m.unsubscribe&&(()=>{m.unsubscribe()});let b;try{if(u&&pS&&n!=="get"&&n!=="head"&&(b=await bS(l,r))!==0){let v=new Request(e,{method:"POST",body:r,duplex:"half"}),A;if(j.isFormData(r)&&(A=v.headers.get("content-type"))&&l.setContentType(A),v.body){const[O,x]=Mm(b,vu(Bm(u)));r=Um(v.body,jm,O,x)}}j.isString(d)||(d=d?"include":"omit");const _="credentials"in Request.prototype;f=new Request(e,{...p,signal:m,method:n.toUpperCase(),headers:l.normalize().toJSON(),body:r,duplex:"half",credentials:_?d:void 0});let E=await fetch(f);const T=xd&&(c==="stream"||c==="response");if(xd&&(o||T&&g)){const v={};["status","statusText","headers"].forEach(D=>{v[D]=E[D]});const A=j.toFiniteNumber(E.headers.get("content-length")),[O,x]=o&&Mm(A,vu(Bm(o),!0))||[];E=new Response(Um(E.body,jm,O,()=>{x&&x(),g&&g()}),v)}c=c||"text";let N=await Iu[j.findKey(Iu,c)||"text"](E,t);return!T&&g&&g(),await new Promise((v,A)=>{xb(v,A,{data:N,headers:Qt.from(E.headers),status:E.status,statusText:E.statusText,config:t,request:f})})}catch(_){throw g&&g(),_&&_.name==="TypeError"&&/fetch/i.test(_.message)?Object.assign(new _e("Network Error",_e.ERR_NETWORK,t,f),{cause:_.cause||_}):_e.from(_,_&&_.code,t,f)}}),Ld={http:xT,xhr:cS,fetch:_S};j.forEach(Ld,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const $m=t=>`- ${t}`,yS=t=>j.isFunction(t)||t===null||t===!1,Fb={getAdapter:t=>{t=j.isArray(t)?t:[t];const{length:e}=t;let n,r;const s={};for(let a=0;a<e;a++){n=t[a];let i;if(r=n,!yS(n)&&(r=Ld[(i=String(n)).toLowerCase()],r===void 0))throw new _e(`Unknown adapter '${i}'`);if(r)break;s[i||"#"+a]=r}if(!r){const a=Object.entries(s).map(([o,u])=>`adapter ${o} `+(u===!1?"is not supported by the environment":"is not available in the build"));let i=e?a.length>1?`since :
`+a.map($m).join(`
`):" "+$m(a[0]):"as no adapter specified";throw new _e("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return r},adapters:Ld};function _l(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new ga(null,t)}function Hm(t){return _l(t),t.headers=Qt.from(t.headers),t.data=bl.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),Fb.getAdapter(t.adapter||Qi.adapter)(t).then(function(e){return _l(t),e.data=bl.call(t,t.transformResponse,e),e.headers=Qt.from(e.headers),e},function(e){return Pb(e)||(_l(t),e&&e.response&&(e.response.data=bl.call(t,t.transformResponse,e.response),e.response.headers=Qt.from(e.response.headers))),Promise.reject(e)})}const Ub="1.7.7",Jh={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{Jh[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});const qm={};Jh.transitional=function(t,e,n){function r(s,a){return"[Axios v"+Ub+"] Transitional option '"+s+"'"+a+(n?". "+n:"")}return(s,a,i)=>{if(t===!1)throw new _e(r(a," has been removed"+(e?" in "+e:"")),_e.ERR_DEPRECATED);return e&&!qm[a]&&(qm[a]=!0,console.warn(r(a," has been deprecated since v"+e+" and will be removed in the near future"))),t?t(s,a,i):!0}};function ES(t,e,n){if(typeof t!="object")throw new _e("options must be an object",_e.ERR_BAD_OPTION_VALUE);const r=Object.keys(t);let s=r.length;for(;s-- >0;){const a=r[s],i=e[a];if(i){const o=t[a],u=o===void 0||i(o,a,t);if(u!==!0)throw new _e("option "+a+" must be "+u,_e.ERR_BAD_OPTION_VALUE);continue}if(n!==!0)throw new _e("Unknown option "+a,_e.ERR_BAD_OPTION)}}const Dd={assertOptions:ES,validators:Jh},Nr=Dd.validators;let us=class{constructor(t){this.defaults=t,this.interceptors={request:new Lm,response:new Lm}}async request(t,e){try{return await this._request(t,e)}catch(n){if(n instanceof Error){let r;Error.captureStackTrace?Error.captureStackTrace(r={}):r=new Error;const s=r.stack?r.stack.replace(/^.+\n/,""):"";try{n.stack?s&&!String(n.stack).endsWith(s.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+s):n.stack=s}catch{}}throw n}}_request(t,e){typeof t=="string"?(e=e||{},e.url=t):e=t||{},e=gs(this.defaults,e);const{transitional:n,paramsSerializer:r,headers:s}=e;n!==void 0&&Dd.assertOptions(n,{silentJSONParsing:Nr.transitional(Nr.boolean),forcedJSONParsing:Nr.transitional(Nr.boolean),clarifyTimeoutError:Nr.transitional(Nr.boolean)},!1),r!=null&&(j.isFunction(r)?e.paramsSerializer={serialize:r}:Dd.assertOptions(r,{encode:Nr.function,serialize:Nr.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let a=s&&j.merge(s.common,s[e.method]);s&&j.forEach(["delete","get","head","post","put","patch","common"],m=>{delete s[m]}),e.headers=Qt.concat(a,s);const i=[];let o=!0;this.interceptors.request.forEach(function(m){typeof m.runWhen=="function"&&m.runWhen(e)===!1||(o=o&&m.synchronous,i.unshift(m.fulfilled,m.rejected))});const u=[];this.interceptors.response.forEach(function(m){u.push(m.fulfilled,m.rejected)});let c,l=0,d;if(!o){const m=[Hm.bind(this),void 0];for(m.unshift.apply(m,i),m.push.apply(m,u),d=m.length,c=Promise.resolve(e);l<d;)c=c.then(m[l++],m[l++]);return c}d=i.length;let p=e;for(l=0;l<d;){const m=i[l++],f=i[l++];try{p=m(p)}catch(g){f.call(this,g);break}}try{c=Hm.call(this,p)}catch(m){return Promise.reject(m)}for(l=0,d=u.length;l<d;)c=c.then(u[l++],u[l++]);return c}getUri(t){t=gs(this.defaults,t);const e=Lb(t.baseURL,t.url);return Nb(e,t.params,t.paramsSerializer)}};j.forEach(["delete","get","head","options"],function(t){us.prototype[t]=function(e,n){return this.request(gs(n||{},{method:t,url:e,data:(n||{}).data}))}});j.forEach(["post","put","patch"],function(t){function e(n){return function(r,s,a){return this.request(gs(a||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:r,data:s}))}}us.prototype[t]=e(),us.prototype[t+"Form"]=e(!0)});let wS=class jb{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(s){n=s});const r=this;this.promise.then(s=>{if(!r._listeners)return;let a=r._listeners.length;for(;a-- >0;)r._listeners[a](s);r._listeners=null}),this.promise.then=s=>{let a;const i=new Promise(o=>{r.subscribe(o),a=o}).then(s);return i.cancel=function(){r.unsubscribe(a)},i},e(function(s,a,i){r.reason||(r.reason=new ga(s,a,i),n(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const e=new AbortController,n=r=>{e.abort(r)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new jb(function(n){e=n}),cancel:e}}};function TS(t){return function(e){return t.apply(null,e)}}function SS(t){return j.isObject(t)&&t.isAxiosError===!0}const Md={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Md).forEach(([t,e])=>{Md[e]=t});function $b(t){const e=new us(t),n=bb(us.prototype.request,e);return j.extend(n,us.prototype,e,{allOwnKeys:!0}),j.extend(n,e,null,{allOwnKeys:!0}),n.create=function(r){return $b(gs(t,r))},n}const at=$b(Qi);at.Axios=us;at.CanceledError=ga;at.CancelToken=wS;at.isCancel=Pb;at.VERSION=Ub;at.toFormData=Ec;at.AxiosError=_e;at.Cancel=at.CanceledError;at.all=function(t){return Promise.all(t)};at.spread=TS;at.isAxiosError=SS;at.mergeConfig=gs;at.AxiosHeaders=Qt;at.formToJSON=t=>Rb(j.isHTMLForm(t)?new FormData(t):t);at.getAdapter=Fb.getAdapter;at.HttpStatusCode=Md;at.default=at;const{Axios:pF,AxiosError:gF,CanceledError:bF,isCancel:_F,CancelToken:yF,VERSION:EF,all:wF,Cancel:TF,isAxiosError:SF,spread:AF,toFormData:CF,AxiosHeaders:AS,HttpStatusCode:Co,formToJSON:OF,getAdapter:vF,mergeConfig:IF}=at;var js=null;typeof WebSocket<"u"?js=WebSocket:typeof MozWebSocket<"u"?js=MozWebSocket:typeof global<"u"?js=global.WebSocket||global.MozWebSocket:typeof window<"u"?js=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(js=self.WebSocket||self.MozWebSocket);const CS=js,Tc=typeof Buffer=="function";typeof TextDecoder=="function"&&new TextDecoder;typeof TextEncoder=="function"&&new TextEncoder;const OS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Ga=Array.prototype.slice.call(OS),Oo=(t=>{let e={};return t.forEach((n,r)=>e[n]=r),e})(Ga),vS=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,fu=String.fromCharCode.bind(String),Vm=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),IS=t=>t.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),Hb=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),NS=t=>{let e,n,r,s,a="";const i=t.length%3;for(let o=0;o<t.length;){if((n=t.charCodeAt(o++))>255||(r=t.charCodeAt(o++))>255||(s=t.charCodeAt(o++))>255)throw new TypeError("invalid character found");e=n<<16|r<<8|s,a+=Ga[e>>18&63]+Ga[e>>12&63]+Ga[e>>6&63]+Ga[e&63]}return i?a.slice(0,i-3)+"===".substring(i):a},kS=typeof btoa=="function"?t=>btoa(t):Tc?t=>Buffer.from(t,"binary").toString("base64"):NS,zm=Tc?t=>Buffer.from(t).toString("base64"):t=>{let e=[];for(let n=0,r=t.length;n<r;n+=4096)e.push(fu.apply(null,t.subarray(n,n+4096)));return kS(e.join(""))},RS=(t,e=!1)=>e?IS(zm(t)):zm(t),PS=t=>{if(t=t.replace(/\s+/g,""),!vS.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,n="",r,s;for(let a=0;a<t.length;)e=Oo[t.charAt(a++)]<<18|Oo[t.charAt(a++)]<<12|(r=Oo[t.charAt(a++)])<<6|(s=Oo[t.charAt(a++)]),n+=r===64?fu(e>>16&255):s===64?fu(e>>16&255,e>>8&255):fu(e>>16&255,e>>8&255,e&255);return n},xS=typeof atob=="function"?t=>atob(Hb(t)):Tc?t=>Buffer.from(t,"base64").toString("binary"):PS,LS=Tc?t=>Vm(Buffer.from(t,"base64")):t=>Vm(xS(t).split("").map(e=>e.charCodeAt(0))),DS=t=>LS(MS(t)),MS=t=>Hb(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),BS=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,FS=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,US=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function jS(t,e){if(t==="__proto__"||t==="constructor"&&e&&typeof e=="object"&&"prototype"in e){$S(t);return}return e}function $S(t){console.warn(`[destr] Dropping "${t}" key to prevent prototype pollution.`)}function HS(t,e={}){if(typeof t!="string")return t;const n=t.trim();if(t[0]==='"'&&t.endsWith('"')&&!t.includes("\\"))return n.slice(1,-1);if(n.length<=9){const r=n.toLowerCase();if(r==="true")return!0;if(r==="false")return!1;if(r==="undefined")return;if(r==="null")return null;if(r==="nan")return Number.NaN;if(r==="infinity")return Number.POSITIVE_INFINITY;if(r==="-infinity")return Number.NEGATIVE_INFINITY}if(!US.test(t)){if(e.strict)throw new SyntaxError("[destr] Invalid JSON");return t}try{if(BS.test(t)||FS.test(t)){if(e.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(t,jS)}return JSON.parse(t)}catch(r){if(e.strict)throw r;return t}}const qS=/#/g,VS=/&/g,zS=/\//g,WS=/=/g,Xh=/\+/g,GS=/%5e/gi,KS=/%60/gi,YS=/%7c/gi,ZS=/%20/gi;function JS(t){return encodeURI(""+t).replace(YS,"|")}function Bd(t){return JS(typeof t=="string"?t:JSON.stringify(t)).replace(Xh,"%2B").replace(ZS,"+").replace(qS,"%23").replace(VS,"%26").replace(KS,"`").replace(GS,"^").replace(zS,"%2F")}function yl(t){return Bd(t).replace(WS,"%3D")}function qb(t=""){try{return decodeURIComponent(""+t)}catch{return""+t}}function XS(t){return qb(t.replace(Xh," "))}function QS(t){return qb(t.replace(Xh," "))}function eA(t=""){const e={};t[0]==="?"&&(t=t.slice(1));for(const n of t.split("&")){const r=n.match(/([^=]+)=?(.*)/)||[];if(r.length<2)continue;const s=XS(r[1]);if(s==="__proto__"||s==="constructor")continue;const a=QS(r[2]||"");e[s]===void 0?e[s]=a:Array.isArray(e[s])?e[s].push(a):e[s]=[e[s],a]}return e}function tA(t,e){return(typeof e=="number"||typeof e=="boolean")&&(e=String(e)),e?Array.isArray(e)?e.map(n=>`${yl(t)}=${Bd(n)}`).join("&"):`${yl(t)}=${Bd(e)}`:yl(t)}function nA(t){return Object.keys(t).filter(e=>t[e]!==void 0).map(e=>tA(e,t[e])).filter(Boolean).join("&")}const rA=/^[\s\w\0+.-]{2,}:([/\\]{1,2})/,sA=/^[\s\w\0+.-]{2,}:([/\\]{2})?/,aA=/^([/\\]\s*){2,}[^/\\]/,iA=/^\.?\//;function Vb(t,e={}){return typeof e=="boolean"&&(e={acceptRelative:e}),e.strict?rA.test(t):sA.test(t)||(e.acceptRelative?aA.test(t):!1)}function oA(t="",e){return t.endsWith("/")}function uA(t="",e){return(oA(t)?t.slice(0,-1):t)||"/"}function cA(t="",e){return t.endsWith("/")?t:t+"/"}function lA(t,e){if(hA(e)||Vb(t))return t;const n=uA(e);return t.startsWith(n)?t:mA(n,t)}function dA(t,e){const n=pA(t),r={...eA(n.search),...e};return n.search=nA(r),gA(n)}function hA(t){return!t||t==="/"}function fA(t){return t&&t!=="/"}function mA(t,...e){let n=t||"";for(const r of e.filter(s=>fA(s)))if(n){const s=r.replace(iA,"");n=cA(n)+s}else n=r;return n}const zb=Symbol.for("ufo:protocolRelative");function pA(t="",e){const n=t.match(/^[\s\0]*(blob:|data:|javascript:|vbscript:)(.*)/i);if(n){const[,d,p=""]=n;return{protocol:d.toLowerCase(),pathname:p,href:d+p,auth:"",host:"",search:"",hash:""}}if(!Vb(t,{acceptRelative:!0}))return Wm(t);const[,r="",s,a=""]=t.replace(/\\/g,"/").match(/^[\s\0]*([\w+.-]{2,}:)?\/\/([^/@]+@)?(.*)/)||[];let[,i="",o=""]=a.match(/([^#/?]*)(.*)?/)||[];r==="file:"&&(o=o.replace(/\/(?=[A-Za-z]:)/,""));const{pathname:u,search:c,hash:l}=Wm(o);return{protocol:r.toLowerCase(),auth:s?s.slice(0,Math.max(0,s.length-1)):"",host:i,pathname:u,search:c,hash:l,[zb]:!r}}function Wm(t=""){const[e="",n="",r=""]=(t.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:e,search:n,hash:r}}function gA(t){const e=t.pathname||"",n=t.search?(t.search.startsWith("?")?"":"?")+t.search:"",r=t.hash||"",s=t.auth?t.auth+"@":"",a=t.host||"";return(t.protocol||t[zb]?(t.protocol||"")+"//":"")+s+a+e+n+r}class bA extends Error{constructor(e,n){super(e,n),this.name="FetchError",n!=null&&n.cause&&!this.cause&&(this.cause=n.cause)}}function _A(t){var e,n,r,s,a;const i=((e=t.error)==null?void 0:e.message)||((n=t.error)==null?void 0:n.toString())||"",o=((r=t.request)==null?void 0:r.method)||((s=t.options)==null?void 0:s.method)||"GET",u=((a=t.request)==null?void 0:a.url)||String(t.request)||"/",c=`[${o}] ${JSON.stringify(u)}`,l=t.response?`${t.response.status} ${t.response.statusText}`:"<no response>",d=`${c}: ${l}${i?` ${i}`:""}`,p=new bA(d,t.error?{cause:t.error}:void 0);for(const m of["request","options","response"])Object.defineProperty(p,m,{get(){return t[m]}});for(const[m,f]of[["data","_data"],["status","status"],["statusCode","status"],["statusText","statusText"],["statusMessage","statusText"]])Object.defineProperty(p,m,{get(){return t.response&&t.response[f]}});return p}const yA=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function Gm(t="GET"){return yA.has(t.toUpperCase())}function EA(t){if(t===void 0)return!1;const e=typeof t;return e==="string"||e==="number"||e==="boolean"||e===null?!0:e!=="object"?!1:Array.isArray(t)?!0:t.buffer?!1:t.constructor&&t.constructor.name==="Object"||typeof t.toJSON=="function"}const wA=new Set(["image/svg","application/xml","application/xhtml","application/html"]),TA=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function SA(t=""){if(!t)return"json";const e=t.split(";").shift()||"";return TA.test(e)?"json":wA.has(e)||e.startsWith("text/")?"text":"blob"}function AA(t,e,n,r){const s=CA((e==null?void 0:e.headers)??(t==null?void 0:t.headers),n==null?void 0:n.headers,r);let a;return(n!=null&&n.query||n!=null&&n.params||e!=null&&e.params||e!=null&&e.query)&&(a={...n==null?void 0:n.params,...n==null?void 0:n.query,...e==null?void 0:e.params,...e==null?void 0:e.query}),{...n,...e,query:a,params:a,headers:s}}function CA(t,e,n){if(!e)return new n(t);const r=new n(e);if(t)for(const[s,a]of Symbol.iterator in t||Array.isArray(t)?t:new n(t))r.set(s,a);return r}async function vo(t,e){if(e)if(Array.isArray(e))for(const n of e)await n(t);else await e(t)}const OA=new Set([408,409,425,429,500,502,503,504]),vA=new Set([101,204,205,304]);function Wb(t={}){const{fetch:e=globalThis.fetch,Headers:n=globalThis.Headers,AbortController:r=globalThis.AbortController}=t;async function s(o){const u=o.error&&o.error.name==="AbortError"&&!o.options.timeout||!1;if(o.options.retry!==!1&&!u){let l;typeof o.options.retry=="number"?l=o.options.retry:l=Gm(o.options.method)?0:1;const d=o.response&&o.response.status||500;if(l>0&&(Array.isArray(o.options.retryStatusCodes)?o.options.retryStatusCodes.includes(d):OA.has(d))){const p=typeof o.options.retryDelay=="function"?o.options.retryDelay(o):o.options.retryDelay||0;return p>0&&await new Promise(m=>setTimeout(m,p)),a(o.request,{...o.options,retry:l-1})}}const c=_A(o);throw Error.captureStackTrace&&Error.captureStackTrace(c,a),c}const a=async function(o,u={}){const c={request:o,options:AA(o,u,t.defaults,n),response:void 0,error:void 0};c.options.method&&(c.options.method=c.options.method.toUpperCase()),c.options.onRequest&&await vo(c,c.options.onRequest),typeof c.request=="string"&&(c.options.baseURL&&(c.request=lA(c.request,c.options.baseURL)),c.options.query&&(c.request=dA(c.request,c.options.query),delete c.options.query),"query"in c.options&&delete c.options.query,"params"in c.options&&delete c.options.params),c.options.body&&Gm(c.options.method)&&(EA(c.options.body)?(c.options.body=typeof c.options.body=="string"?c.options.body:JSON.stringify(c.options.body),c.options.headers=new n(c.options.headers||{}),c.options.headers.has("content-type")||c.options.headers.set("content-type","application/json"),c.options.headers.has("accept")||c.options.headers.set("accept","application/json")):("pipeTo"in c.options.body&&typeof c.options.body.pipeTo=="function"||typeof c.options.body.pipe=="function")&&("duplex"in c.options||(c.options.duplex="half")));let l;if(!c.options.signal&&c.options.timeout){const d=new r;l=setTimeout(()=>{const p=new Error("[TimeoutError]: The operation was aborted due to timeout");p.name="TimeoutError",p.code=23,d.abort(p)},c.options.timeout),c.options.signal=d.signal}try{c.response=await e(c.request,c.options)}catch(d){return c.error=d,c.options.onRequestError&&await vo(c,c.options.onRequestError),await s(c)}finally{l&&clearTimeout(l)}if((c.response.body||c.response._bodyInit)&&!vA.has(c.response.status)&&c.options.method!=="HEAD"){const d=(c.options.parseResponse?"json":c.options.responseType)||SA(c.response.headers.get("content-type")||"");switch(d){case"json":{const p=await c.response.text(),m=c.options.parseResponse||HS;c.response._data=m(p);break}case"stream":{c.response._data=c.response.body||c.response._bodyInit;break}default:c.response._data=await c.response[d]()}}return c.options.onResponse&&await vo(c,c.options.onResponse),!c.options.ignoreResponseError&&c.response.status>=400&&c.response.status<600?(c.options.onResponseError&&await vo(c,c.options.onResponseError),await s(c)):c.response},i=async function(o,u){return(await a(o,u))._data};return i.raw=a,i.native=(...o)=>e(...o),i.create=(o={},u={})=>Wb({...t,...u,defaults:{...t.defaults,...u.defaults,...o}}),i}const Nu=function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")}(),IA=Nu.fetch?(...t)=>Nu.fetch(...t):()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!")),NA=Nu.Headers,kA=Nu.AbortController,Km=Wb({fetch:IA,Headers:NA,AbortController:kA}),El={SCHEMA_DIR_RELATIVE_PATH:"./../schemas/",SCHEMA_FILENAME_PAYLOAD:"payload.schema.json",SCHEMA_FILENAME_RESPONSE:"response.schema.json",SIYUAN_DEFAULT_BASE_URL:"http://localhost:6806/",REQUEST_TIMEOUT:6e4};class RA extends Error{constructor(e){super(e.statusText),un(this,"status"),this.response=e,this.status=e.status}}class Ym extends Error{constructor(e,n){super(e.msg),un(this,"code"),un(this,"msg"),un(this,"data"),this.body=e,this.response=n,this.code=e.code,this.msg=e.msg,this.data=e.data}}var Zm,Jm,Xm,Qm,ep;const Fd=class P{constructor(e={},n="xhr"){un(this,"_type","xhr"),un(this,"_baseURL",((Jm=(Zm=globalThis.top)==null?void 0:Zm.document)==null?void 0:Jm.baseURI)??((Qm=(Xm=globalThis.parent)==null?void 0:Xm.document)==null?void 0:Qm.baseURI)??((ep=globalThis.location)==null?void 0:ep.origin)??El.SIYUAN_DEFAULT_BASE_URL),un(this,"_token",null),un(this,"_ofetch_options",{baseURL:this._baseURL,headers:this._headers}),un(this,"_axios_options",{baseURL:this._baseURL,timeout:El.REQUEST_TIMEOUT,headers:this._headers}),un(this,"_fetch",Km.create(this._ofetch_options)),un(this,"_axios",at.create(this._axios_options)),this._setClientType(n),this._updateOptions(e,n)}static headers2record(e){const n={};return e.forEach((r,s)=>{n[s]=r}),n}static headers2records(e){const n=[];return e.forEach((r,s)=>{n.push({[s]:r})}),n}static headers2entries(e){const n=[];return Object.entries(e).forEach(([r,s])=>{s.forEach(a=>n.push([r,a]))}),n}static entries2record(e){const n={};for(const[r,s]of e)n[r]=s;return n}get _authorization(){return`Token ${this._token}`}get _headers(){return this._token!==null?{Authorization:this._authorization}:{}}_setClientType(e){this._type=e}_updateOptions(e,n=this._type){switch(this._baseURL=e.baseURL??this._baseURL,e.token){case void 0:break;case null:default:this._token=e.token,delete e.token;break}switch(n){case"fetch":{const r=e;switch(!0){case Array.isArray(r.headers):{r.headers.find(([s])=>s.toLowerCase()==="Authorization".toLowerCase())||r.headers.push(["Authorization",this._authorization]);break}case r.headers instanceof Headers:{r.headers.has("Authorization")||r.headers.set("Authorization",this._authorization);break}case typeof r.headers=="object":{"Authorization"in r.headers||(r.headers.Authorization=this._authorization);break}default:{r.headers=this._headers;break}}this._ofetch_options=r,this._fetch=Km.create(this._ofetch_options);break}case"xhr":default:{const r=e;if(r.headers)switch(!0){case r.headers instanceof AS:{r.headers.has("Authorization")||r.headers.set("Authorization",this._authorization);break}case typeof r.headers=="object":{switch(!0){case("common"in r.headers||"get"in r.headers||"post"in r.headers):{"common"in r.headers&&("Authorization"in r.headers.get||(r.headers.get.Authorization=this._authorization)),"get"in r.headers&&("Authorization"in r.headers.get||(r.headers.get.Authorization=this._authorization)),"post"in r.headers&&("Authorization"in r.headers.post||(r.headers.post.Authorization=this._authorization));break}default:{"Authorization"in r.headers||(r.headers.Authorization=this._authorization);break}}break}default:{r.headers=this._headers;break}}else r.headers=this._headers;this._axios_options=r,this._axios=at.create(this._axios_options);break}}}async $fetch(e,n){const r=new Request(e,n),s=await this.forwardProxy({url:r.url,method:r.method,headers:P.headers2records(r.headers),payload:RS(new Uint8Array(await r.arrayBuffer())),timeout:El.REQUEST_TIMEOUT,contentType:"application/json",payloadEncoding:"base64",responseEncoding:"base64"});return new Response(DS(s.data.body),{status:s.data.status,statusText:s.msg,headers:new Headers(P.headers2entries(s.data.headers))})}broadcast(e,n,r){var s;const a=(r==null?void 0:r.baseURL)??this._baseURL,i=(r==null?void 0:r.token)??this._token,o=new URLSearchParams(e);i&&o.set("token",i);const u=new URL(a,(s=globalThis.location)==null?void 0:s.href);return u.protocol=u.protocol.replace(/^http/,"ws"),u.pathname=u.pathname.endsWith("/")?`${u.pathname}${P.ws.broadcast.pathname.substring(1)}`:`${u.pathname}${P.ws.broadcast.pathname}`,u.search=o.toString(),new CS(u,n)}async upload(e,n){const r=new FormData;return e.id!=null&&r.append("id",e.id),e.assetsDirPath!=null&&r.append("assetsDirPath",e.assetsDirPath),e.skipIfDuplicated!=null&&r.append("skipIfDuplicated",String(e.skipIfDuplicated)),e.files.forEach(s=>r.append("file[]",s)),await this._request(P.api.asset.upload.pathname,P.api.asset.upload.method,r,n)}async getBlockAttrs(e,n){return await this._request(P.api.attr.getBlockAttrs.pathname,P.api.attr.getBlockAttrs.method,e,n)}async getBookmarkLabels(e){return await this._request(P.api.attr.getBookmarkLabels.pathname,P.api.attr.getBookmarkLabels.method,void 0,e)}async setBlockAttrs(e,n){return await this._request(P.api.attr.setBlockAttrs.pathname,P.api.attr.setBlockAttrs.method,e,n)}async appendBlock(e,n){return await this._request(P.api.block.appendBlock.pathname,P.api.block.appendBlock.method,e,n)}async deleteBlock(e,n){return await this._request(P.api.block.deleteBlock.pathname,P.api.block.deleteBlock.method,e,n)}async foldBlock(e,n){return await this._request(P.api.block.foldBlock.pathname,P.api.block.foldBlock.method,e,n)}async getBlockBreadcrumb(e,n){return await this._request(P.api.block.getBlockBreadcrumb.pathname,P.api.block.getBlockBreadcrumb.method,e,n)}async getBlockDOM(e,n){return await this._request(P.api.block.getBlockDOM.pathname,P.api.block.getBlockDOM.method,e,n)}async getBlockInfo(e,n){return await this._request(P.api.block.getBlockInfo.pathname,P.api.block.getBlockInfo.method,e,n)}async getBlockKramdown(e,n){return await this._request(P.api.block.getBlockKramdown.pathname,P.api.block.getBlockKramdown.method,e,n)}async getChildBlocks(e,n){return await this._request(P.api.block.getChildBlocks.pathname,P.api.block.getChildBlocks.method,e,n)}async getDocInfo(e,n){return await this._request(P.api.block.getDocInfo.pathname,P.api.block.getDocInfo.method,e,n)}async insertBlock(e,n){return await this._request(P.api.block.insertBlock.pathname,P.api.block.insertBlock.method,e,n)}async moveBlock(e,n){return await this._request(P.api.block.moveBlock.pathname,P.api.block.moveBlock.method,e,n)}async prependBlock(e,n){return await this._request(P.api.block.prependBlock.pathname,P.api.block.prependBlock.method,e,n)}async transferBlockRef(e,n){return await this._request(P.api.block.transferBlockRef.pathname,P.api.block.transferBlockRef.method,e,n)}async unfoldBlock(e,n){return await this._request(P.api.block.unfoldBlock.pathname,P.api.block.unfoldBlock.method,e,n)}async updateBlock(e,n){return await this._request(P.api.block.updateBlock.pathname,P.api.block.updateBlock.method,e,n)}async getChannelInfo(e,n){return await this._request(P.api.broadcast.getChannelInfo.pathname,P.api.broadcast.getChannelInfo.method,e,n)}async getChannels(e){return await this._request(P.api.broadcast.getChannels.pathname,P.api.broadcast.getChannels.method,void 0,e)}async postMessage(e,n){return await this._request(P.api.broadcast.postMessage.pathname,P.api.broadcast.postMessage.method,e,n)}async pandoc(e,n){return await this._request(P.api.convert.pandoc.pathname,P.api.convert.pandoc.method,e,n)}async exportHTML(e,n){return await this._request(P.api.export.exportHTML.pathname,P.api.export.exportHTML.method,e,n)}async exportMdContent(e,n){return await this._request(P.api.export.exportMdContent.pathname,P.api.export.exportMdContent.method,e,n)}async exportResources(e,n){return await this._request(P.api.export.exportResources.pathname,P.api.export.exportResources.method,e,n)}async getFile(e,n="text",r){return await this._request(P.api.file.getFile.pathname,P.api.file.getFile.method,e,r,!1,n)}async putFile(e,n){e.file!==void 0&&!(e.file instanceof File)&&(e.file=new File([e.file],e.path.split("/").pop()));const r=new FormData;for(const[s,a]of Object.entries(e))a instanceof Blob?r.append(s,a):r.append(s,String(a));return await this._request(P.api.file.putFile.pathname,P.api.file.putFile.method,r,n)}async readDir(e,n){return await this._request(P.api.file.readDir.pathname,P.api.file.readDir.method,e,n)}async removeFile(e,n){return await this._request(P.api.file.removeFile.pathname,P.api.file.removeFile.method,e,n)}async renameFile(e,n){return await this._request(P.api.file.renameFile.pathname,P.api.file.renameFile.method,e,n)}async createDailyNote(e,n){return await this._request(P.api.filetree.createDailyNote.pathname,P.api.filetree.createDailyNote.method,e,n)}async createDocWithMd(e,n){return await this._request(P.api.filetree.createDocWithMd.pathname,P.api.filetree.createDocWithMd.method,e,n)}async getDoc(e,n){return await this._request(P.api.filetree.getDoc.pathname,P.api.filetree.getDoc.method,e,n)}async getHPathByID(e,n){return await this._request(P.api.filetree.getHPathByID.pathname,P.api.filetree.getHPathByID.method,e,n)}async getHPathByPath(e,n){return await this._request(P.api.filetree.getHPathByPath.pathname,P.api.filetree.getHPathByPath.method,e,n)}async getIDsByHPath(e,n){return await this._request(P.api.filetree.getIDsByHPath.pathname,P.api.filetree.getIDsByHPath.method,e,n)}async listDocsByPath(e,n){return await this._request(P.api.filetree.listDocsByPath.pathname,P.api.filetree.listDocsByPath.method,e,n)}async moveDocs(e,n){return await this._request(P.api.filetree.moveDocs.pathname,P.api.filetree.moveDocs.method,e,n)}async removeDoc(e,n){return await this._request(P.api.filetree.removeDoc.pathname,P.api.filetree.removeDoc.method,e,n)}async renameDoc(e,n){return await this._request(P.api.filetree.renameDoc.pathname,P.api.filetree.renameDoc.method,e,n)}async searchDocs(e,n){return await this._request(P.api.filetree.searchDocs.pathname,P.api.filetree.searchDocs.method,e,n)}async getDocHistoryContent(e,n){return await this._request(P.api.history.getDocHistoryContent.pathname,P.api.history.getDocHistoryContent.method,e,n)}async getHistoryItems(e,n){return await this._request(P.api.history.getHistoryItems.pathname,P.api.history.getHistoryItems.method,e,n)}async getShorthand(e,n){return await this._request(P.api.inbox.getShorthand.pathname,P.api.inbox.getShorthand.method,e,n)}async echo(e,n){if(e)switch(n??(n={type:this._type}),n==null?void 0:n.type){case"fetch":{const r={};e.headers&&(r.headers=e.headers),e.query&&(r.query=P.entries2record(e.query.entries())),n.options?Object.assign(r,n.options):n.options=r;break}case"xhr":{const r={};e.headers&&(r.headers=Array.isArray(e.headers)?P.entries2record(e.headers):e.headers instanceof Headers?P.headers2record(e.headers):e.headers),e.query&&(r.params=e.query),n.options?Object.assign(r,n.options):n.options=r;break}}return await this._request(P.api.network.echo.pathname,(e==null?void 0:e.method)??P.api.network.echo.method,e==null?void 0:e.body,n)}async forwardProxy(e,n){return await this._request(P.api.network.forwardProxy.pathname,P.api.network.forwardProxy.method,e,n)}async closeNotebook(e,n){return await this._request(P.api.notebook.closeNotebook.pathname,P.api.notebook.closeNotebook.method,e,n)}async createNotebook(e,n){return await this._request(P.api.notebook.createNotebook.pathname,P.api.notebook.createNotebook.method,e,n)}async getNotebookConf(e,n){return await this._request(P.api.notebook.getNotebookConf.pathname,P.api.notebook.getNotebookConf.method,e,n)}async lsNotebooks(e){return await this._request(P.api.notebook.lsNotebooks.pathname,P.api.notebook.lsNotebooks.method,void 0,e)}async openNotebook(e,n){return await this._request(P.api.notebook.openNotebook.pathname,P.api.notebook.openNotebook.method,e,n)}async removeNotebook(e,n){return await this._request(P.api.notebook.removeNotebook.pathname,P.api.notebook.removeNotebook.method,e,n)}async renameNotebook(e,n){return await this._request(P.api.notebook.renameNotebook.pathname,P.api.notebook.renameNotebook.method,e,n)}async setNotebookConf(e,n){return await this._request(P.api.notebook.setNotebookConf.pathname,P.api.notebook.setNotebookConf.method,e,n)}async pushErrMsg(e,n){return await this._request(P.api.notification.pushErrMsg.pathname,P.api.notification.pushErrMsg.method,e,n)}async pushMsg(e,n){return await this._request(P.api.notification.pushMsg.pathname,P.api.notification.pushMsg.method,e,n)}async getDocOutline(e,n){return await this._request(P.api.outline.getDocOutline.pathname,P.api.outline.getDocOutline.method,e,n)}async sql(e,n){return await this._request(P.api.query.sql.pathname,P.api.query.sql.method,e,n)}async openRepoSnapshotDoc(e,n){return await this._request(P.api.repo.openRepoSnapshotDoc.pathname,P.api.repo.openRepoSnapshotDoc.method,e,n)}async fullTextSearchBlock(e,n){return await this._request(P.api.search.fullTextSearchBlock.pathname,P.api.search.fullTextSearchBlock.method,e,n)}async getSnippet(e,n){return await this._request(P.api.snippet.getSnippet.pathname,P.api.snippet.getSnippet.method,e,n)}async setSnippet(e,n){return await this._request(P.api.snippet.setSnippet.pathname,P.api.snippet.setSnippet.method,e,n)}async flushTransaction(e){return await this._request(P.api.sqlite.flushTransaction.pathname,P.api.sqlite.flushTransaction.method,e)}async getLocalStorage(e){return await this._request(P.api.storage.getLocalStorage.pathname,P.api.storage.getLocalStorage.method,void 0,e)}async getRecentDocs(e){return await this._request(P.api.storage.getRecentDocs.pathname,P.api.storage.getRecentDocs.method,void 0,e)}async setLocalStorage(e,n){return await this._request(P.api.storage.setLocalStorage.pathname,P.api.storage.setLocalStorage.method,e,n)}async setLocalStorageVal(e,n){return await this._request(P.api.storage.setLocalStorageVal.pathname,P.api.storage.setLocalStorageVal.method,e,n)}async bootProgress(e){return await this._request(P.api.system.bootProgress.pathname,P.api.system.bootProgress.method,void 0,e)}async currentTime(e){return await this._request(P.api.system.currentTime.pathname,P.api.system.currentTime.method,void 0,e)}async exit(e,n){return await this._request(P.api.system.exit.pathname,P.api.system.exit.method,e,n)}async getConf(e){return await this._request(P.api.system.getConf.pathname,P.api.system.getConf.method,void 0,e)}async logoutAuth(e){return await this._request(P.api.system.logoutAuth.pathname,P.api.system.logoutAuth.method,void 0,e)}async version(e){return await this._request(P.api.system.version.pathname,P.api.system.version.method,void 0,e)}async render(e,n){return await this._request(P.api.template.render.pathname,P.api.template.render.method,e,n)}async renderSprig(e,n){return await this._request(P.api.template.renderSprig.pathname,P.api.template.renderSprig.method,e,n)}async _request(e,n,r,s,a=!0,i="json"){switch((s==null?void 0:s.type)??this._type){case"fetch":{const o=s==null?void 0:s.options;i=(()=>{switch(i){case"arraybuffer":return"arrayBuffer";case"document":return"text";default:return i}})();const u=await this._fetch(e,{method:n,body:r,responseType:i,onResponse:c=>{switch(c.response.status){case Co.Ok:switch(i){case"blob":c.response._data.contentType=c.response.headers.get("content-type");break}break;case Co.Accepted:e===P.api.file.getFile.pathname&&this._parseFetchResponse(c.response._data);break}},...o});return a&&i==="json"&&typeof u=="object"?this._parseFetchResponse(u):u}case"xhr":default:{const o=s==null?void 0:s.options;i=(()=>{switch(i){case"arrayBuffer":return"arraybuffer";default:return i}})();const u=await this._axios.request({url:e,method:n,data:r,responseType:i,...o});switch(u.status){case Co.Ok:if(a&&i==="json"&&typeof u.data=="object")return this._parseAxiosResponse(u);switch(i){case"blob":"content-type"in u.headers&&(u.data.contentType=u.headers["content-type"]);break}return u.data;case Co.Accepted:return e===P.api.file.getFile.pathname?this._parseAxiosResponse(u):u.data;default:throw new RA(u)}}}}_parseFetchResponse(e){if(e.code===0)return e;throw new Ym(e)}_parseAxiosResponse(e){if(e.data.code===0)return e.data;throw new Ym(e.data,e)}};un(Fd,"ws",{broadcast:{pathname:"/ws/broadcast"}}),un(Fd,"api",{asset:{upload:{pathname:"/api/asset/upload",method:"POST"}},attr:{getBlockAttrs:{pathname:"/api/attr/getBlockAttrs",method:"POST"},getBookmarkLabels:{pathname:"/api/attr/getBookmarkLabels",method:"POST"},setBlockAttrs:{pathname:"/api/attr/setBlockAttrs",method:"POST"}},block:{appendBlock:{pathname:"/api/block/appendBlock",method:"POST"},deleteBlock:{pathname:"/api/block/deleteBlock",method:"POST"},foldBlock:{pathname:"/api/block/foldBlock",method:"POST"},getBlockBreadcrumb:{pathname:"/api/block/getBlockBreadcrumb",method:"POST"},getBlockDOM:{pathname:"/api/block/getBlockDOM",method:"POST"},getBlockInfo:{pathname:"/api/block/getBlockInfo",method:"POST"},getBlockKramdown:{pathname:"/api/block/getBlockKramdown",method:"POST"},getChildBlocks:{pathname:"/api/block/getChildBlocks",method:"POST"},getDocInfo:{pathname:"/api/block/getDocInfo",method:"POST"},insertBlock:{pathname:"/api/block/insertBlock",method:"POST"},moveBlock:{pathname:"/api/block/moveBlock",method:"POST"},prependBlock:{pathname:"/api/block/prependBlock",method:"POST"},transferBlockRef:{pathname:"/api/block/transferBlockRef",method:"POST"},unfoldBlock:{pathname:"/api/block/unfoldBlock",method:"POST"},updateBlock:{pathname:"/api/block/updateBlock",method:"POST"}},broadcast:{getChannelInfo:{pathname:"/api/broadcast/getChannelInfo",method:"POST"},getChannels:{pathname:"/api/broadcast/getChannels",method:"POST"},postMessage:{pathname:"/api/broadcast/postMessage",method:"POST"}},convert:{pandoc:{pathname:"/api/convert/pandoc",method:"POST"}},export:{exportHTML:{pathname:"/api/export/exportHTML",method:"POST"},exportMdContent:{pathname:"/api/export/exportMdContent",method:"POST"},exportResources:{pathname:"/api/export/exportResources",method:"POST"}},file:{getFile:{pathname:"/api/file/getFile",method:"POST"},putFile:{pathname:"/api/file/putFile",method:"POST"},readDir:{pathname:"/api/file/readDir",method:"POST"},removeFile:{pathname:"/api/file/removeFile",method:"POST"},renameFile:{pathname:"/api/file/renameFile",method:"POST"}},filetree:{createDailyNote:{pathname:"/api/filetree/createDailyNote",method:"POST"},createDocWithMd:{pathname:"/api/filetree/createDocWithMd",method:"POST"},getDoc:{pathname:"/api/filetree/getDoc",method:"POST"},getHPathByID:{pathname:"/api/filetree/getHPathByID",method:"POST"},getHPathByPath:{pathname:"/api/filetree/getHPathByPath",method:"POST"},getIDsByHPath:{pathname:"/api/filetree/getIDsByHPath",method:"POST"},listDocsByPath:{pathname:"/api/filetree/listDocsByPath",method:"POST"},moveDocs:{pathname:"/api/filetree/moveDocs",method:"POST"},removeDoc:{pathname:"/api/filetree/removeDoc",method:"POST"},renameDoc:{pathname:"/api/filetree/renameDoc",method:"POST"},searchDocs:{pathname:"/api/filetree/searchDocs",method:"POST"}},history:{getDocHistoryContent:{pathname:"/api/history/getDocHistoryContent",method:"POST"},getHistoryItems:{pathname:"/api/history/getHistoryItems",method:"POST"}},inbox:{getShorthand:{pathname:"/api/inbox/getShorthand",method:"POST"}},network:{echo:{pathname:"/api/network/echo",method:"POST"},forwardProxy:{pathname:"/api/network/forwardProxy",method:"POST"}},notebook:{closeNotebook:{pathname:"/api/notebook/closeNotebook",method:"POST"},createNotebook:{pathname:"/api/notebook/createNotebook",method:"POST"},getNotebookConf:{pathname:"/api/notebook/getNotebookConf",method:"POST"},lsNotebooks:{pathname:"/api/notebook/lsNotebooks",method:"POST"},openNotebook:{pathname:"/api/notebook/openNotebook",method:"POST"},removeNotebook:{pathname:"/api/notebook/removeNotebook",method:"POST"},renameNotebook:{pathname:"/api/notebook/renameNotebook",method:"POST"},setNotebookConf:{pathname:"/api/notebook/setNotebookConf",method:"POST"}},notification:{pushErrMsg:{pathname:"/api/notification/pushErrMsg",method:"POST"},pushMsg:{pathname:"/api/notification/pushMsg",method:"POST"}},outline:{getDocOutline:{pathname:"/api/outline/getDocOutline",method:"POST"}},query:{sql:{pathname:"/api/query/sql",method:"POST"}},repo:{openRepoSnapshotDoc:{pathname:"/api/repo/openRepoSnapshotDoc",method:"POST"}},search:{fullTextSearchBlock:{pathname:"/api/search/fullTextSearchBlock",method:"POST"}},snippet:{getSnippet:{pathname:"/api/snippet/getSnippet",method:"POST"},setSnippet:{pathname:"/api/snippet/setSnippet",method:"POST"}},sqlite:{flushTransaction:{pathname:"/api/sqlite/flushTransaction",method:"POST"}},storage:{getLocalStorage:{pathname:"/api/storage/getLocalStorage",method:"POST"},getRecentDocs:{pathname:"/api/storage/getRecentDocs",method:"POST"},setLocalStorage:{pathname:"/api/storage/setLocalStorage",method:"POST"},setLocalStorageVal:{pathname:"/api/storage/setLocalStorageVal",method:"POST"}},system:{bootProgress:{pathname:"/api/system/bootProgress",method:"POST"},currentTime:{pathname:"/api/system/currentTime",method:"POST"},exit:{pathname:"/api/system/exit",method:"POST"},getConf:{pathname:"/api/system/getConf",method:"POST"},logoutAuth:{pathname:"/api/system/logoutAuth",method:"POST"},version:{pathname:"/api/system/version",method:"POST"}},template:{render:{pathname:"/api/template/render",method:"POST"},renderSprig:{pathname:"/api/template/renderSprig",method:"POST"}}});let PA=Fd;function Xn(t){if(typeof t!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(t))}function tp(t,e){for(var n="",r=0,s=-1,a=0,i,o=0;o<=t.length;++o){if(o<t.length)i=t.charCodeAt(o);else{if(i===47)break;i=47}if(i===47){if(!(s===o-1||a===1))if(s!==o-1&&a===2){if(n.length<2||r!==2||n.charCodeAt(n.length-1)!==46||n.charCodeAt(n.length-2)!==46){if(n.length>2){var u=n.lastIndexOf("/");if(u!==n.length-1){u===-1?(n="",r=0):(n=n.slice(0,u),r=n.length-1-n.lastIndexOf("/")),s=o,a=0;continue}}else if(n.length===2||n.length===1){n="",r=0,s=o,a=0;continue}}e&&(n.length>0?n+="/..":n="..",r=2)}else n.length>0?n+="/"+t.slice(s+1,o):n=t.slice(s+1,o),r=o-s-1;s=o,a=0}else i===46&&a!==-1?++a:a=-1}return n}function xA(t,e){var n=e.dir||e.root,r=e.base||(e.name||"")+(e.ext||"");return n?n===e.root?n+r:n+t+r:r}var ai={resolve:function(){for(var t="",e=!1,n,r=arguments.length-1;r>=-1&&!e;r--){var s;r>=0?s=arguments[r]:(n===void 0&&(n=process.cwd()),s=n),Xn(s),s.length!==0&&(t=s+"/"+t,e=s.charCodeAt(0)===47)}return t=tp(t,!e),e?t.length>0?"/"+t:"/":t.length>0?t:"."},normalize:function(t){if(Xn(t),t.length===0)return".";var e=t.charCodeAt(0)===47,n=t.charCodeAt(t.length-1)===47;return t=tp(t,!e),t.length===0&&!e&&(t="."),t.length>0&&n&&(t+="/"),e?"/"+t:t},isAbsolute:function(t){return Xn(t),t.length>0&&t.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var t,e=0;e<arguments.length;++e){var n=arguments[e];Xn(n),n.length>0&&(t===void 0?t=n:t+="/"+n)}return t===void 0?".":ai.normalize(t)},relative:function(t,e){if(Xn(t),Xn(e),t===e||(t=ai.resolve(t),e=ai.resolve(e),t===e))return"";for(var n=1;n<t.length&&t.charCodeAt(n)===47;++n);for(var r=t.length,s=r-n,a=1;a<e.length&&e.charCodeAt(a)===47;++a);for(var i=e.length,o=i-a,u=s<o?s:o,c=-1,l=0;l<=u;++l){if(l===u){if(o>u){if(e.charCodeAt(a+l)===47)return e.slice(a+l+1);if(l===0)return e.slice(a+l)}else s>u&&(t.charCodeAt(n+l)===47?c=l:l===0&&(c=0));break}var d=t.charCodeAt(n+l),p=e.charCodeAt(a+l);if(d!==p)break;d===47&&(c=l)}var m="";for(l=n+c+1;l<=r;++l)(l===r||t.charCodeAt(l)===47)&&(m.length===0?m+="..":m+="/..");return m.length>0?m+e.slice(a+c):(a+=c,e.charCodeAt(a)===47&&++a,e.slice(a))},_makeLong:function(t){return t},dirname:function(t){if(Xn(t),t.length===0)return".";for(var e=t.charCodeAt(0),n=e===47,r=-1,s=!0,a=t.length-1;a>=1;--a)if(e=t.charCodeAt(a),e===47){if(!s){r=a;break}}else s=!1;return r===-1?n?"/":".":n&&r===1?"//":t.slice(0,r)},basename:function(t,e){if(e!==void 0&&typeof e!="string")throw new TypeError('"ext" argument must be a string');Xn(t);var n=0,r=-1,s=!0,a;if(e!==void 0&&e.length>0&&e.length<=t.length){if(e.length===t.length&&e===t)return"";var i=e.length-1,o=-1;for(a=t.length-1;a>=0;--a){var u=t.charCodeAt(a);if(u===47){if(!s){n=a+1;break}}else o===-1&&(s=!1,o=a+1),i>=0&&(u===e.charCodeAt(i)?--i===-1&&(r=a):(i=-1,r=o))}return n===r?r=o:r===-1&&(r=t.length),t.slice(n,r)}else{for(a=t.length-1;a>=0;--a)if(t.charCodeAt(a)===47){if(!s){n=a+1;break}}else r===-1&&(s=!1,r=a+1);return r===-1?"":t.slice(n,r)}},extname:function(t){Xn(t);for(var e=-1,n=0,r=-1,s=!0,a=0,i=t.length-1;i>=0;--i){var o=t.charCodeAt(i);if(o===47){if(!s){n=i+1;break}continue}r===-1&&(s=!1,r=i+1),o===46?e===-1?e=i:a!==1&&(a=1):e!==-1&&(a=-1)}return e===-1||r===-1||a===0||a===1&&e===r-1&&e===n+1?"":t.slice(e,r)},format:function(t){if(t===null||typeof t!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof t);return xA("/",t)},parse:function(t){Xn(t);var e={root:"",dir:"",base:"",ext:"",name:""};if(t.length===0)return e;var n=t.charCodeAt(0),r=n===47,s;r?(e.root="/",s=1):s=0;for(var a=-1,i=0,o=-1,u=!0,c=t.length-1,l=0;c>=s;--c){if(n=t.charCodeAt(c),n===47){if(!u){i=c+1;break}continue}o===-1&&(u=!1,o=c+1),n===46?a===-1?a=c:l!==1&&(l=1):a!==-1&&(l=-1)}return a===-1||o===-1||l===0||l===1&&a===o-1&&a===i+1?o!==-1&&(i===0&&r?e.base=e.name=t.slice(1,o):e.base=e.name=t.slice(i,o)):(i===0&&r?(e.name=t.slice(1,a),e.base=t.slice(1,o)):(e.name=t.slice(i,a),e.base=t.slice(i,o)),e.ext=t.slice(a,o)),i>0?e.dir=t.slice(0,i-1):r&&(e.dir="/"),e},sep:"/",delimiter:":",win32:null,posix:null};ai.posix=ai;async function vs(t,e){let n=await Dn.fetchSyncPost(t,e);return n.code===0?n.data:null}async function Gb(t){return vs("/api/block/getChildBlocks",{id:t})}async function LA(t){return vs("/api/block/getBlockIndex",{id:t})}async function Xs(t,e=7e3){return vs("/api/notification/pushMsg",{msg:t,timeout:e})}async function eo(t,e=7e3){return vs("/api/notification/pushErrMsg",{msg:t,timeout:e})}async function DA(){return vs("/api/notebook/lsNotebooks","")}function MA(){var n;let t=((n=window.getSelection())==null?void 0:n.toString())||"";return t||(document.querySelectorAll(".protyle-wysiwyg--select").forEach(r=>{const s=r.textContent;t+=`
`+s}),t)}function BA(){var r;let t="",e="";return t=(r=document.getElementsByClassName("protyle-title__input")[0])==null?void 0:r.textContent,document.querySelectorAll("[data-node-index]").forEach(s=>{e+=s.textContent+`
`}),{title:t,content:e}}function ut(){}function ku(t,e){for(const n in e)t[n]=e[n];return t}function Kb(t){return t()}function np(){return Object.create(null)}function ct(t){t.forEach(Kb)}function Yb(t){return typeof t=="function"}function gt(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function FA(t){return Object.keys(t).length===0}function Qh(t,e,n,r){if(t){const s=Zb(t,e,n,r);return t[0](s)}}function Zb(t,e,n,r){return t[1]&&r?ku(n.ctx.slice(),t[1](r(e))):n.ctx}function ef(t,e,n,r){if(t[2]&&r){const s=t[2](r(n));if(e.dirty===void 0)return s;if(typeof s=="object"){const a=[],i=Math.max(e.dirty.length,s.length);for(let o=0;o<i;o+=1)a[o]=e.dirty[o]|s[o];return a}return e.dirty|s}return e.dirty}function tf(t,e,n,r,s,a){if(s){const i=Zb(e,n,r,a);t.p(i,s)}}function nf(t){if(t.ctx.length>32){const e=[],n=t.ctx.length/32;for(let r=0;r<n;r++)e[r]=-1;return e}return-1}function rp(t){const e={};for(const n in t)n[0]!=="$"&&(e[n]=t[n]);return e}const UA=["",!0,1,"true","contenteditable"];function R(t,e){t.appendChild(e)}function ge(t,e,n){t.insertBefore(e,n||null)}function pe(t){t.parentNode&&t.parentNode.removeChild(t)}function Sc(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function G(t){return document.createElement(t)}function cn(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function Ze(t){return document.createTextNode(t)}function re(){return Ze(" ")}function Ac(){return Ze("")}function ce(t,e,n,r){return t.addEventListener(e,n,r),()=>t.removeEventListener(e,n,r)}function jA(t){return function(e){return e.stopPropagation(),t.call(this,e)}}function C(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}const $A=["width","height"];function sp(t,e){const n=Object.getOwnPropertyDescriptors(t.__proto__);for(const r in e)e[r]==null?t.removeAttribute(r):r==="style"?t.style.cssText=e[r]:r==="__value"?t.value=t[r]=e[r]:n[r]&&n[r].set&&$A.indexOf(r)===-1?t[r]=e[r]:C(t,r,e[r])}function Ud(t){return t===""?null:+t}function HA(t){return Array.from(t.childNodes)}function ht(t,e){e=""+e,t.data!==e&&(t.data=e)}function qA(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function VA(t,e,n){~UA.indexOf(n)?qA(t,e):ht(t,e)}function tn(t,e){t.value=e??""}function Ut(t,e,n,r){n==null?t.style.removeProperty(e):t.style.setProperty(e,n,"")}function ap(t,e,n){for(let r=0;r<t.options.length;r+=1){const s=t.options[r];if(s.__value===e){s.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function zA(t){const e=t.querySelector(":checked");return e&&e.__value}function Ce(t,e,n){t.classList.toggle(e,!!n)}function WA(t,e,{bubbles:n=!1,cancelable:r=!1}={}){return new CustomEvent(t,{detail:e,bubbles:n,cancelable:r})}let wi;function ii(t){wi=t}function rf(){if(!wi)throw new Error("Function called outside component initialization");return wi}function Cc(t){rf().$$.on_mount.push(t)}function GA(t){rf().$$.after_update.push(t)}function Kr(){const t=rf();return(e,n,{cancelable:r=!1}={})=>{const s=t.$$.callbacks[e];if(s){const a=WA(e,n,{cancelable:r});return s.slice().forEach(i=>{i.call(t,a)}),!a.defaultPrevented}return!0}}function KA(t,e){const n=t.$$.callbacks[e.type];n&&n.slice().forEach(r=>r.call(this,e))}const $s=[],Ne=[];let Qs=[];const jd=[],YA=Promise.resolve();let $d=!1;function ZA(){$d||($d=!0,YA.then(Jb))}function Ru(t){Qs.push(t)}function Ue(t){jd.push(t)}const wl=new Set;let Rs=0;function Jb(){if(Rs!==0)return;const t=wi;do{try{for(;Rs<$s.length;){const e=$s[Rs];Rs++,ii(e),JA(e.$$)}}catch(e){throw $s.length=0,Rs=0,e}for(ii(null),$s.length=0,Rs=0;Ne.length;)Ne.pop()();for(let e=0;e<Qs.length;e+=1){const n=Qs[e];wl.has(n)||(wl.add(n),n())}Qs.length=0}while($s.length);for(;jd.length;)jd.pop()();$d=!1,wl.clear(),ii(t)}function JA(t){if(t.fragment!==null){t.update(),ct(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(Ru)}}function XA(t){const e=[],n=[];Qs.forEach(r=>t.indexOf(r)===-1?e.push(r):n.push(r)),n.forEach(r=>r()),Qs=e}const mu=new Set;let ss;function cs(){ss={r:0,c:[],p:ss}}function ls(){ss.r||ct(ss.c),ss=ss.p}function he(t,e){t&&t.i&&(mu.delete(t),t.i(e))}function Te(t,e,n,r){if(t&&t.o){if(mu.has(t))return;mu.add(t),ss.c.push(()=>{mu.delete(t),r&&(n&&t.d(1),r())}),t.o(e)}else r&&r()}function Cn(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function QA(t,e){t.d(1),e.delete(t.key)}function e2(t,e){Te(t,1,1,()=>{e.delete(t.key)})}function Xb(t,e,n,r,s,a,i,o,u,c,l,d){let p=t.length,m=a.length,f=p;const g={};for(;f--;)g[t[f].key]=f;const b=[],_=new Map,E=new Map,T=[];for(f=m;f--;){const O=d(s,a,f),x=n(O);let D=i.get(x);D?T.push(()=>D.p(O,e)):(D=c(x,O),D.c()),_.set(x,b[f]=D),x in g&&E.set(x,Math.abs(f-g[x]))}const N=new Set,v=new Set;function A(O){he(O,1),O.m(o,l),i.set(O.key,O),l=O.first,m--}for(;p&&m;){const O=b[m-1],x=t[p-1],D=O.key,U=x.key;O===x?(l=O.first,p--,m--):_.has(U)?!i.has(D)||N.has(D)?A(O):v.has(U)?p--:E.get(D)>E.get(U)?(v.add(D),A(O)):(N.add(U),p--):(u(x,i),p--)}for(;p--;){const O=t[p];_.has(O.key)||u(O,i)}for(;m;)A(b[m-1]);return ct(T),b}function t2(t,e){const n={},r={},s={$$scope:1};let a=t.length;for(;a--;){const i=t[a],o=e[a];if(o){for(const u in i)u in o||(r[u]=1);for(const u in o)s[u]||(n[u]=o[u],s[u]=1);t[a]=o}else for(const u in i)s[u]=1}for(const i in r)i in n||(n[i]=void 0);return n}function je(t,e,n){const r=t.$$.props[e];r!==void 0&&(t.$$.bound[r]=n,n(t.$$.ctx[r]))}function et(t){t&&t.c()}function Je(t,e,n){const{fragment:r,after_update:s}=t.$$;r&&r.m(e,n),Ru(()=>{const a=t.$$.on_mount.map(Kb).filter(Yb);t.$$.on_destroy?t.$$.on_destroy.push(...a):ct(a),t.$$.on_mount=[]}),s.forEach(Ru)}function Xe(t,e){const n=t.$$;n.fragment!==null&&(XA(n.after_update),ct(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function n2(t,e){t.$$.dirty[0]===-1&&($s.push(t),ZA(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function bt(t,e,n,r,s,a,i=null,o=[-1]){const u=wi;ii(t);const c=t.$$={fragment:null,ctx:[],props:a,update:ut,not_equal:s,bound:np(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(u?u.$$.context:[])),callbacks:np(),dirty:o,skip_bound:!1,root:e.target||u.$$.root};i&&i(c.root);let l=!1;if(c.ctx=n?n(t,e.props||{},(d,p,...m)=>{const f=m.length?m[0]:p;return c.ctx&&s(c.ctx[d],c.ctx[d]=f)&&(!c.skip_bound&&c.bound[d]&&c.bound[d](f),l&&n2(t,d)),p}):[],c.update(),l=!0,ct(c.before_update),c.fragment=r?r(c.ctx):!1,e.target){if(e.hydrate){const d=HA(e.target);c.fragment&&c.fragment.l(d),d.forEach(pe)}else c.fragment&&c.fragment.c();e.intro&&he(t.$$.fragment),Je(t,e.target,e.anchor),Jb()}ii(u)}class _t{constructor(){ve(this,"$$");ve(this,"$$set")}$destroy(){Xe(this,1),this.$destroy=ut}$on(e,n){if(!Yb(n))return ut;const r=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return r.push(n),()=>{const s=r.indexOf(n);s!==-1&&r.splice(s,1)}}$set(e){this.$$set&&!FA(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const r2="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(r2);var s2=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function to(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Qb={exports:{}};(function(t,e){(function(n,r){t.exports=r()})(s2,function(){var n=1e3,r=6e4,s=36e5,a="millisecond",i="second",o="minute",u="hour",c="day",l="week",d="month",p="quarter",m="year",f="date",g="Invalid Date",b=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,_=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,E={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(L){var I=["th","st","nd","rd"],B=L%100;return"["+L+(I[(B-20)%10]||I[B]||I[0])+"]"}},T=function(L,I,B){var q=String(L);return!q||q.length>=I?L:""+Array(I+1-q.length).join(B)+L},N={s:T,z:function(L){var I=-L.utcOffset(),B=Math.abs(I),q=Math.floor(B/60),M=B%60;return(I<=0?"+":"-")+T(q,2,"0")+":"+T(M,2,"0")},m:function L(I,B){if(I.date()<B.date())return-L(B,I);var q=12*(B.year()-I.year())+(B.month()-I.month()),M=I.clone().add(q,d),V=B-M<0,X=I.clone().add(q+(V?-1:1),d);return+(-(q+(B-M)/(V?M-X:X-M))||0)},a:function(L){return L<0?Math.ceil(L)||0:Math.floor(L)},p:function(L){return{M:d,y:m,w:l,d:c,D:f,h:u,m:o,s:i,ms:a,Q:p}[L]||String(L||"").toLowerCase().replace(/s$/,"")},u:function(L){return L===void 0}},v="en",A={};A[v]=E;var O="$isDayjsObject",x=function(L){return L instanceof K||!(!L||!L[O])},D=function L(I,B,q){var M;if(!I)return v;if(typeof I=="string"){var V=I.toLowerCase();A[V]&&(M=V),B&&(A[V]=B,M=V);var X=I.split("-");if(!M&&X.length>1)return L(X[0])}else{var z=I.name;A[z]=I,M=z}return!q&&M&&(v=M),M||!q&&v},U=function(L,I){if(x(L))return L.clone();var B=typeof I=="object"?I:{};return B.date=L,B.args=arguments,new K(B)},Q=N;Q.l=D,Q.i=x,Q.w=function(L,I){return U(L,{locale:I.$L,utc:I.$u,x:I.$x,$offset:I.$offset})};var K=function(){function L(B){this.$L=D(B.locale,null,!0),this.parse(B),this.$x=this.$x||B.x||{},this[O]=!0}var I=L.prototype;return I.parse=function(B){this.$d=function(q){var M=q.date,V=q.utc;if(M===null)return new Date(NaN);if(Q.u(M))return new Date;if(M instanceof Date)return new Date(M);if(typeof M=="string"&&!/Z$/i.test(M)){var X=M.match(b);if(X){var z=X[2]-1||0,ne=(X[7]||"0").substring(0,3);return V?new Date(Date.UTC(X[1],z,X[3]||1,X[4]||0,X[5]||0,X[6]||0,ne)):new Date(X[1],z,X[3]||1,X[4]||0,X[5]||0,X[6]||0,ne)}}return new Date(M)}(B),this.init()},I.init=function(){var B=this.$d;this.$y=B.getFullYear(),this.$M=B.getMonth(),this.$D=B.getDate(),this.$W=B.getDay(),this.$H=B.getHours(),this.$m=B.getMinutes(),this.$s=B.getSeconds(),this.$ms=B.getMilliseconds()},I.$utils=function(){return Q},I.isValid=function(){return this.$d.toString()!==g},I.isSame=function(B,q){var M=U(B);return this.startOf(q)<=M&&M<=this.endOf(q)},I.isAfter=function(B,q){return U(B)<this.startOf(q)},I.isBefore=function(B,q){return this.endOf(q)<U(B)},I.$g=function(B,q,M){return Q.u(B)?this[q]:this.set(M,B)},I.unix=function(){return Math.floor(this.valueOf()/1e3)},I.valueOf=function(){return this.$d.getTime()},I.startOf=function(B,q){var M=this,V=!!Q.u(q)||q,X=Q.p(B),z=function(vn,Et){var Jn=Q.w(M.$u?Date.UTC(M.$y,Et,vn):new Date(M.$y,Et,vn),M);return V?Jn:Jn.endOf(c)},ne=function(vn,Et){return Q.w(M.toDate()[vn].apply(M.toDate("s"),(V?[0,0,0,0]:[23,59,59,999]).slice(Et)),M)},me=this.$W,ke=this.$M,Se=this.$D,yt="set"+(this.$u?"UTC":"");switch(X){case m:return V?z(1,0):z(31,11);case d:return V?z(1,ke):z(0,ke+1);case l:var Ot=this.$locale().weekStart||0,Ir=(me<Ot?me+7:me)-Ot;return z(V?Se-Ir:Se+(6-Ir),ke);case c:case f:return ne(yt+"Hours",0);case u:return ne(yt+"Minutes",1);case o:return ne(yt+"Seconds",2);case i:return ne(yt+"Milliseconds",3);default:return this.clone()}},I.endOf=function(B){return this.startOf(B,!1)},I.$set=function(B,q){var M,V=Q.p(B),X="set"+(this.$u?"UTC":""),z=(M={},M[c]=X+"Date",M[f]=X+"Date",M[d]=X+"Month",M[m]=X+"FullYear",M[u]=X+"Hours",M[o]=X+"Minutes",M[i]=X+"Seconds",M[a]=X+"Milliseconds",M)[V],ne=V===c?this.$D+(q-this.$W):q;if(V===d||V===m){var me=this.clone().set(f,1);me.$d[z](ne),me.init(),this.$d=me.set(f,Math.min(this.$D,me.daysInMonth())).$d}else z&&this.$d[z](ne);return this.init(),this},I.set=function(B,q){return this.clone().$set(B,q)},I.get=function(B){return this[Q.p(B)]()},I.add=function(B,q){var M,V=this;B=Number(B);var X=Q.p(q),z=function(ke){var Se=U(V);return Q.w(Se.date(Se.date()+Math.round(ke*B)),V)};if(X===d)return this.set(d,this.$M+B);if(X===m)return this.set(m,this.$y+B);if(X===c)return z(1);if(X===l)return z(7);var ne=(M={},M[o]=r,M[u]=s,M[i]=n,M)[X]||1,me=this.$d.getTime()+B*ne;return Q.w(me,this)},I.subtract=function(B,q){return this.add(-1*B,q)},I.format=function(B){var q=this,M=this.$locale();if(!this.isValid())return M.invalidDate||g;var V=B||"YYYY-MM-DDTHH:mm:ssZ",X=Q.z(this),z=this.$H,ne=this.$m,me=this.$M,ke=M.weekdays,Se=M.months,yt=M.meridiem,Ot=function(Et,Jn,Ra,Ao){return Et&&(Et[Jn]||Et(q,V))||Ra[Jn].slice(0,Ao)},Ir=function(Et){return Q.s(z%12||12,Et,"0")},vn=yt||function(Et,Jn,Ra){var Ao=Et<12?"AM":"PM";return Ra?Ao.toLowerCase():Ao};return V.replace(_,function(Et,Jn){return Jn||function(Ra){switch(Ra){case"YY":return String(q.$y).slice(-2);case"YYYY":return Q.s(q.$y,4,"0");case"M":return me+1;case"MM":return Q.s(me+1,2,"0");case"MMM":return Ot(M.monthsShort,me,Se,3);case"MMMM":return Ot(Se,me);case"D":return q.$D;case"DD":return Q.s(q.$D,2,"0");case"d":return String(q.$W);case"dd":return Ot(M.weekdaysMin,q.$W,ke,2);case"ddd":return Ot(M.weekdaysShort,q.$W,ke,3);case"dddd":return ke[q.$W];case"H":return String(z);case"HH":return Q.s(z,2,"0");case"h":return Ir(1);case"hh":return Ir(2);case"a":return vn(z,ne,!0);case"A":return vn(z,ne,!1);case"m":return String(ne);case"mm":return Q.s(ne,2,"0");case"s":return String(q.$s);case"ss":return Q.s(q.$s,2,"0");case"SSS":return Q.s(q.$ms,3,"0");case"Z":return X}return null}(Et)||X.replace(":","")})},I.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},I.diff=function(B,q,M){var V,X=this,z=Q.p(q),ne=U(B),me=(ne.utcOffset()-this.utcOffset())*r,ke=this-ne,Se=function(){return Q.m(X,ne)};switch(z){case m:V=Se()/12;break;case d:V=Se();break;case p:V=Se()/3;break;case l:V=(ke-me)/6048e5;break;case c:V=(ke-me)/864e5;break;case u:V=ke/s;break;case o:V=ke/r;break;case i:V=ke/n;break;default:V=ke}return M?V:Q.a(V)},I.daysInMonth=function(){return this.endOf(d).$D},I.$locale=function(){return A[this.$L]},I.locale=function(B,q){if(!B)return this.$L;var M=this.clone(),V=D(B,q,!0);return V&&(M.$L=V),M},I.clone=function(){return Q.w(this.$d,this)},I.toDate=function(){return new Date(this.valueOf())},I.toJSON=function(){return this.isValid()?this.toISOString():null},I.toISOString=function(){return this.$d.toISOString()},I.toString=function(){return this.$d.toUTCString()},L}(),oe=K.prototype;return U.prototype=oe,[["$ms",a],["$s",i],["$m",o],["$H",u],["$W",c],["$M",d],["$y",m],["$D",f]].forEach(function(L){oe[L[1]]=function(I){return this.$g(I,L[0],L[1])}}),U.extend=function(L,I){return L.$i||(L(I,K,U),L.$i=!0),U},U.locale=D,U.isDayjs=x,U.unix=function(L){return U(1e3*L)},U.en=A[v],U.Ls=A,U.p={},U})})(Qb);var a2=Qb.exports;const i2=to(a2),Hd="siyuan-ai-plugin-setting",e_="siyuan-ai-plugin-chat-history",qd="siyuan-ai-plugin-prompts",t_="siyuan-ai-plugin-blockid",Vd="siyuan-ai-plugin-document-vector",Io=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTYwNzg"),o2=atob("aHR0cHM6Ly9zZWFyY2guZ2Vla3NwaGVyZS5vbmxpbmUv"),ip=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTMwNTkvY2Fs"),op=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTMwNTkvY2Fs");atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTA5ODE");atob("cm9vdDo3emFJR3RUTHUyIXc5IWlTXmE2OQ");const u2=atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTMwNTk"),Tl=["qwen-vl-plus-latest","doubao-vision-pro-32k","qwen-vl-max-latest"];async function c2(t){let e={path:t},n="/api/file/getFile";return new Promise((r,s)=>{Dn.fetchPost(n,e,a=>{r(a)})})}async function l2(t,e,n){let r=new FormData;return r.append("path",t),r.append("isDir",e.toString()),r.append("modTime",Math.floor(Date.now()/1e3).toString()),r.append("file",n),vs("/api/file/putFile",r)}async function d2(t,e){return vs("/api/filetree/listDocTree",{notebook:t,path:e})}const Hs="0.32.1";let up=!1,oi,n_,zd,r_,s_,a_;function h2(t,e={auto:!1}){if(up)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${t.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(oi)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${t.kind}'\` after \`import '@anthropic-ai/sdk/shims/${oi}'\``);up=e.auto,oi=t.kind,n_=t.fetch,zd=t.File,r_=t.ReadableStream,s_=t.getDefaultAgent,a_=t.fileFromPath}let f2=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function m2({manuallyImported:t}={}){const e=t?"You may need to use polyfills":"Add one of these imports before your first `import  from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new f2(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:i=>!1}}oi||h2(m2(),{auto:!0});class Fe extends Error{}let gn=class Wd extends Fe{constructor(e,n,r,s){super(`${Wd.makeMessage(e,n,r)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["request-id"],this.error=n}static makeMessage(e,n,r){const s=n!=null&&n.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,n,r,s){if(!e)return new Oc({message:r,cause:Kd(n)});const a=n;return e===400?new o_(e,a,r,s):e===401?new u_(e,a,r,s):e===403?new c_(e,a,r,s):e===404?new l_(e,a,r,s):e===409?new d_(e,a,r,s):e===422?new h_(e,a,r,s):e===429?new f_(e,a,r,s):e>=500?new m_(e,a,r,s):new Wd(e,a,r,s)}},Mn=class extends gn{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},Oc=class extends gn{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,n&&(this.cause=n)}},i_=class extends Oc{constructor({message:e}={}){super({message:e??"Request timed out."})}},o_=class extends gn{constructor(){super(...arguments),this.status=400}},u_=class extends gn{constructor(){super(...arguments),this.status=401}},c_=class extends gn{constructor(){super(...arguments),this.status=403}},l_=class extends gn{constructor(){super(...arguments),this.status=404}},d_=class extends gn{constructor(){super(...arguments),this.status=409}},h_=class extends gn{constructor(){super(...arguments),this.status=422}},f_=class extends gn{constructor(){super(...arguments),this.status=429}},m_=class extends gn{},no=class Gd{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let n=this.decodeText(e);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];const r=Gd.NEWLINE_CHARS.has(n[n.length-1]||"");let s=n.split(Gd.NEWLINE_REGEXP);return r&&s.pop(),s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Fe(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Fe(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Fe("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};no.NEWLINE_CHARS=new Set([`
`,"\r"]);no.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let Ti=class Ka{constructor(e,n){this.iterator=e,this.controller=n}static fromSSEResponse(e,n){let r=!1;async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const i of p2(e,n)){if(i.event==="completion")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event==="message_start"||i.event==="message_delta"||i.event==="message_stop"||i.event==="content_block_start"||i.event==="content_block_delta"||i.event==="content_block_stop")try{yield JSON.parse(i.data)}catch(o){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),o}if(i.event!=="ping"&&i.event==="error")throw gn.generate(void 0,`SSE Error: ${i.data}`,i.data,__(e.headers))}a=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{a||n.abort()}}return new Ka(s,n)}static fromReadableStream(e,n){let r=!1;async function*s(){const i=new no,o=sf(e);for await(const u of o)for(const c of i.decode(u))yield c;for(const u of i.flush())yield u}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of s())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||n.abort()}}return new Ka(a,n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],n=[],r=this.iterator(),s=a=>({next:()=>{if(a.length===0){const i=r.next();e.push(i),n.push(i)}return a.shift()}});return[new Ka(()=>s(e),this.controller),new Ka(()=>s(n),this.controller)]}toReadableStream(){const e=this;let n;const r=new TextEncoder;return new r_({async start(){n=e[Symbol.asyncIterator]()},async pull(s){try{const{value:a,done:i}=await n.next();if(i)return s.close();const o=r.encode(JSON.stringify(a)+`
`);s.enqueue(o)}catch(a){s.error(a)}},async cancel(){var s;await((s=n.return)==null?void 0:s.call(n))}})}};async function*p2(t,e){if(!t.body)throw e.abort(),new Fe("Attempted to iterate over a response with no body");const n=new _2,r=new no,s=sf(t.body);for await(const a of g2(s))for(const i of r.decode(a)){const o=n.decode(i);o&&(yield o)}for(const a of r.flush()){const i=n.decode(a);i&&(yield i)}}async function*g2(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let a;for(;(a=b2(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}function b2(t){for(let r=0;r<t.length-2;r++){if(t[r]===10&&t[r+1]===10||t[r]===13&&t[r+1]===13)return r+2;if(t[r]===13&&t[r+1]===10&&r+3<t.length&&t[r+2]===13&&t[r+3]===10)return r+4}return-1}let _2=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,r,s]=y2(e,":");return s.startsWith(" ")&&(s=s.substring(1)),n==="event"?this.event=s:n==="data"&&this.data.push(s),null}};function y2(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}function sf(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n!=null&&n.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const E2=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function",w2=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&vc(t),vc=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function";async function T2(t,e,n){var s;if(t=await t,w2(t))return t;if(E2(t)){const a=await t.blob();e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=vc(a)?[await a.arrayBuffer()]:[a];return new zd(i,e,n)}const r=await S2(t);if(e||(e=C2(t)??"unknown_file"),!(n!=null&&n.type)){const a=(s=r[0])==null?void 0:s.type;typeof a=="string"&&(n={...n,type:a})}return new zd(r,e,n)}async function S2(t){var n;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(vc(t))e.push(await t.arrayBuffer());else if(O2(t))for await(const r of t)e.push(r);else throw new Error(`Unexpected data type: ${typeof t}; constructor: ${(n=t==null?void 0:t.constructor)==null?void 0:n.name}; props: ${A2(t)}`);return e}function A2(t){return`[${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}function C2(t){var e;return Sl(t.name)||Sl(t.filename)||((e=Sl(t.path))==null?void 0:e.split(/[\\/]/).pop())}const Sl=t=>{if(typeof t=="string")return t;if(typeof Buffer<"u"&&t instanceof Buffer)return String(t)},O2=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",cp=t=>t&&typeof t=="object"&&t.body&&t[Symbol.toStringTag]==="MultipartBody";var v2=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},I2=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},No;async function p_(t){const{response:e}=t;if(t.options.stream)return ea("response",e.status,e.url,e.headers,e.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(e,t.controller):Ti.fromSSEResponse(e,t.controller);if(e.status===204)return null;if(t.options.__binaryResponse)return e;const n=e.headers.get("content-type");if((n==null?void 0:n.includes("application/json"))||(n==null?void 0:n.includes("application/vnd.api+json"))){const a=await e.json();return ea("response",e.status,e.url,e.headers,a),a}const s=await e.text();return ea("response",e.status,e.url,e.headers,s),s}let g_=class b_ extends Promise{constructor(e,n=p_){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=n}_thenUnwrap(e){return new b_(this.responsePromise,async n=>e(await this.parseResponse(n),n))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},N2=class{constructor({baseURL:e,maxRetries:n=2,timeout:r=6e5,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=Al("maxRetries",n),this.timeout=Al("timeout",r),this.httpAgent=s,this.fetch=a??n_}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...D2(),...this.authHeaders(e)}}validateHeaders(e,n){}defaultIdempotencyKey(){return`stainless-node-retry-${j2()}`}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,r){return this.request(Promise.resolve(r).then(async s=>{const a=s&&vc(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:n,...s,body:a}}))}getAPIList(e,n,r){return this.requestAPIList(n,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:n=0}={}){var g;const{method:r,path:s,query:a,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:cp(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(s,a);"timeout"in e&&Al("timeout",e.timeout);const l=e.timeout??this.timeout,d=e.httpAgent??this.httpAgent??s_(c),p=l+1e3;typeof((g=d==null?void 0:d.options)==null?void 0:g.timeout)=="number"&&p>(d.options.timeout??0)&&(d.options.timeout=p),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const m=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:n});return{req:{method:r,...o&&{body:o},headers:m,...d&&{agent:d},signal:e.signal??null},url:c,timeout:l}}buildHeaders({options:e,headers:n,contentLength:r,retryCount:s}){const a={};r&&(a["content-length"]=r);const i=this.defaultHeaders(e);return fp(a,i),fp(a,n),cp(e.body)&&oi!=="node"&&delete a["content-type"],mp(i,"x-stainless-retry-count")===void 0&&mp(n,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),this.validateHeaders(a,n),a}async prepareOptions(e){}async prepareRequest(e,{url:n,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(n=>[...n])):{...e}:{}}makeStatusError(e,n,r,s){return gn.generate(e,n,r,s)}request(e,n=null){return new g_(this.makeRequest(e,n))}async makeRequest(e,n){var d,p;const r=await e,s=r.maxRetries??this.maxRetries;n==null&&(n=s),await this.prepareOptions(r);const{req:a,url:i,timeout:o}=this.buildRequest(r,{retryCount:s-n});if(await this.prepareRequest(a,{url:i,options:r}),ea("request",i,r,a.headers),(d=r.signal)!=null&&d.aborted)throw new Mn;const u=new AbortController,c=await this.fetchWithTimeout(i,a,o,u).catch(Kd);if(c instanceof Error){if((p=r.signal)!=null&&p.aborted)throw new Mn;if(n)return this.retryRequest(r,n);throw c.name==="AbortError"?new i_:new Oc({cause:c})}const l=__(c.headers);if(!c.ok){if(n&&this.shouldRetry(c)){const E=`retrying, ${n} attempts remaining`;return ea(`response (error; ${E})`,c.status,i,l),this.retryRequest(r,n,l)}const m=await c.text().catch(E=>Kd(E).message),f=M2(m),g=f?void 0:m;throw ea(`response (error; ${n?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,g),this.makeStatusError(c.status,f,g,l)}return{response:c,options:r,controller:u}}requestAPIList(e,n){const r=this.makeRequest(n,null);return new R2(this,r,e)}buildURL(e,n){const r=F2(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return Pu(s)||(n={...s,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(r.search=this.stringifyQuery(n)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([n,r])=>typeof r<"u").map(([n,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(n)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(n)}=`;throw new Fe(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,n,r,s){const{signal:a,...i}=n||{};a&&a.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,r){let s;const a=r==null?void 0:r["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(s=o)}const i=r==null?void 0:r["retry-after"];if(i&&!s){const o=parseFloat(i);Number.isNaN(o)?s=Date.parse(i)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(n,o)}return await U2(s),this.makeRequest(e,n-1)}calculateDefaultRetryTimeoutMillis(e,n){const a=n-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Hs}`}},k2=class{constructor(e,n,r,s){No.set(this,void 0),v2(this,No,e,"f"),this.options=s,this.response=n,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Fe("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const n={...this.options};if("params"in e&&typeof n.query=="object")n.query={...n.query,...e.params};else if("url"in e){const r=[...Object.entries(n.query||{}),...e.url.searchParams.entries()];for(const[s,a]of r)e.url.searchParams.set(s,a);n.query=void 0,n.path=e.url.toString()}return await I2(this,No,"f").requestAPIList(this.constructor,n)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(No=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}},R2=class extends g_{constructor(e,n,r){super(n,async s=>new r(e,s.response,await p_(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}};const __=t=>new Proxy(Object.fromEntries(t.entries()),{get(e,n){const r=n.toString();return e[r.toLowerCase()]||e[r]}}),P2={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ko=t=>typeof t=="object"&&t!==null&&!Pu(t)&&Object.keys(t).every(e=>y_(P2,e)),x2=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":dp(Deno.build.os),"X-Stainless-Arch":lp(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":dp(process.platform),"X-Stainless-Arch":lp(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const t=L2();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function L2(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const r=n.exec(navigator.userAgent);if(r){const s=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${s}.${a}.${i}`}}}return null}const lp=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",dp=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let hp;const D2=()=>hp??(hp=x2()),M2=t=>{try{return JSON.parse(t)}catch{return}},B2=new RegExp("^(?:[a-z]+:)?//","i"),F2=t=>B2.test(t),U2=t=>new Promise(e=>setTimeout(e,t)),Al=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Fe(`${t} must be an integer`);if(e<0)throw new Fe(`${t} must be a positive integer`);return e},Kd=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null)try{return new Error(JSON.stringify(t))}catch{}return new Error(String(t))},Cl=t=>{var e,n,r,s,a;if(typeof process<"u")return((n=(e=process.env)==null?void 0:e[t])==null?void 0:n.trim())??void 0;if(typeof Deno<"u")return(a=(s=(r=Deno.env)==null?void 0:r.get)==null?void 0:s.call(r,t))==null?void 0:a.trim()};function Pu(t){if(!t)return!0;for(const e in t)return!1;return!0}function y_(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function fp(t,e){for(const n in e){if(!y_(e,n))continue;const r=n.toLowerCase();if(!r)continue;const s=e[n];s===null?delete t[r]:s!==void 0&&(t[r]=s)}}function ea(t,...e){var n;typeof process<"u"&&((n=process==null?void 0:process.env)==null?void 0:n.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${t}`,...e)}const j2=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),$2=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",H2=t=>typeof(t==null?void 0:t.get)=="function",mp=(t,e)=>{var r;const n=e.toLowerCase();if(H2(t)){const s=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,i,o)=>i+o.toUpperCase());for(const a of[e,n,e.toUpperCase(),s]){const i=t.get(a);if(i)return i}}for(const[s,a]of Object.entries(t))if(s.toLowerCase()===n)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a};let q2=class extends k2{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.first_id=r.first_id||null,this.last_id=r.last_id||null}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const n=Object.fromEntries(e.url.searchParams);return Object.keys(n).length?n:null}nextPageInfo(){var n;if((n=this.options.query)!=null&&n.before_id){const r=this.first_id;return r?{params:{before_id:r}}:null}const e=this.last_id;return e?{params:{after_id:e}}:null}},Is=class{constructor(e){this._client=e}};class af{constructor(e,n){this.iterator=e,this.controller=n}async*decoder(){const e=new no;for await(const n of this.iterator)for(const r of e.decode(n))yield JSON.parse(r);for(const n of e.flush())yield JSON.parse(n)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,n){if(!e.body)throw n.abort(),new Fe("Attempted to iterate over a response with no body");return new af(sf(e.body),n)}}let of=class extends Is{create(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages/batches?beta=true",{body:s,...n,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...n==null?void 0:n.headers}})}retrieve(e,n={},r){if(ko(n))return this.retrieve(e,{},n);const{betas:s}=n;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...r,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}list(e={},n){if(ko(e))return this.list({},e);const{betas:r,...s}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",uf,{query:s,...n,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...n==null?void 0:n.headers}})}cancel(e,n={},r){if(ko(n))return this.cancel(e,{},n);const{betas:s}=n;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...r,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}async results(e,n={},r){if(ko(n))return this.results(e,{},n);const s=await this.retrieve(e);if(!s.results_url)throw new Fe(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);const{betas:a}=n;return this._client.get(s.results_url,{...r,headers:{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers},__binaryResponse:!0})._thenUnwrap((i,o)=>af.fromResponse(o.response,o.controller))}};class uf extends q2{}of.BetaMessageBatchesPage=uf;let Ic=class extends Is{constructor(){super(...arguments),this.batches=new of(this._client)}create(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages?beta=true",{body:s,timeout:this._client._options.timeout??6e5,...n,headers:{...(r==null?void 0:r.toString())!=null?{"anthropic-beta":r==null?void 0:r.toString()}:void 0,...n==null?void 0:n.headers},stream:e.stream??!1})}countTokens(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:s,...n,headers:{"anthropic-beta":[...r??[],"token-counting-2024-11-01"].toString(),...n==null?void 0:n.headers}})}};Ic.Batches=of;Ic.BetaMessageBatchesPage=uf;const V2=t=>{let e=0,n=[];for(;e<t.length;){let r=t[e];if(r==="\\"){e++;continue}if(r==="{"){n.push({type:"brace",value:"{"}),e++;continue}if(r==="}"){n.push({type:"brace",value:"}"}),e++;continue}if(r==="["){n.push({type:"paren",value:"["}),e++;continue}if(r==="]"){n.push({type:"paren",value:"]"}),e++;continue}if(r===":"){n.push({type:"separator",value:":"}),e++;continue}if(r===","){n.push({type:"delimiter",value:","}),e++;continue}if(r==='"'){let o="",u=!1;for(r=t[++e];r!=='"';){if(e===t.length){u=!0;break}if(r==="\\"){if(e++,e===t.length){u=!0;break}o+=r+t[e],r=t[++e]}else o+=r,r=t[++e]}r=t[++e],u||n.push({type:"string",value:o});continue}if(r&&/\s/.test(r)){e++;continue}let a=/[0-9]/;if(r&&a.test(r)||r==="-"||r==="."){let o="";for(r==="-"&&(o+=r,r=t[++e]);r&&a.test(r)||r===".";)o+=r,r=t[++e];n.push({type:"number",value:o});continue}let i=/[a-z]/i;if(r&&i.test(r)){let o="";for(;r&&i.test(r)&&e!==t.length;)o+=r,r=t[++e];if(o=="true"||o=="false"||o==="null")n.push({type:"name",value:o});else{e++;continue}continue}e++}return n},qs=t=>{if(t.length===0)return t;let e=t[t.length-1];switch(e.type){case"separator":return t=t.slice(0,t.length-1),qs(t);case"number":let n=e.value[e.value.length-1];if(n==="."||n==="-")return t=t.slice(0,t.length-1),qs(t);case"string":let r=t[t.length-2];if((r==null?void 0:r.type)==="delimiter")return t=t.slice(0,t.length-1),qs(t);if((r==null?void 0:r.type)==="brace"&&r.value==="{")return t=t.slice(0,t.length-1),qs(t);break;case"delimiter":return t=t.slice(0,t.length-1),qs(t)}return t},z2=t=>{let e=[];return t.map(n=>{n.type==="brace"&&(n.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),n.type==="paren"&&(n.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(n=>{n==="}"?t.push({type:"brace",value:"}"}):n==="]"&&t.push({type:"paren",value:"]"})}),t},W2=t=>{let e="";return t.map(n=>{switch(n.type){case"string":e+='"'+n.value+'"';break;default:e+=n.value;break}}),e},E_=t=>JSON.parse(W2(z2(qs(V2(t)))));var qt=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Re=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},bn,kr,Ro,Po,xa,La,xo,Da,mr,Ma,Lo,Do,Ps,Ol,pp,vl,Il,Nl,kl,gp;const bp="__json_buf";class xu{constructor(){bn.add(this),this.messages=[],this.receivedMessages=[],kr.set(this,void 0),this.controller=new AbortController,Ro.set(this,void 0),Po.set(this,()=>{}),xa.set(this,()=>{}),La.set(this,void 0),xo.set(this,()=>{}),Da.set(this,()=>{}),mr.set(this,{}),Ma.set(this,!1),Lo.set(this,!1),Do.set(this,!1),Ps.set(this,!1),vl.set(this,e=>{if(qt(this,Lo,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Mn),e instanceof Mn)return qt(this,Do,!0,"f"),this._emit("abort",e);if(e instanceof Fe)return this._emit("error",e);if(e instanceof Error){const n=new Fe(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new Fe(String(e)))}),qt(this,Ro,new Promise((e,n)=>{qt(this,Po,e,"f"),qt(this,xa,n,"f")}),"f"),qt(this,La,new Promise((e,n)=>{qt(this,xo,e,"f"),qt(this,Da,n,"f")}),"f"),Re(this,Ro,"f").catch(()=>{}),Re(this,La,"f").catch(()=>{})}static fromReadableStream(e){const n=new xu;return n._run(()=>n._fromReadableStream(e)),n}static createMessage(e,n,r){const s=new xu;for(const a of n.messages)s._addPromptCachingBetaMessageParam(a);return s._run(()=>s._createPromptCachingBetaMessage(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},Re(this,vl,"f"))}_addPromptCachingBetaMessageParam(e){this.messages.push(e)}_addPromptCachingBetaMessage(e,n=!0){this.receivedMessages.push(e),n&&this._emit("message",e)}async _createPromptCachingBetaMessage(e,n,r){var i;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Re(this,bn,"m",Il).call(this);const a=await e.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)Re(this,bn,"m",Nl).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new Mn;Re(this,bn,"m",kl).call(this)}_connected(){this.ended||(Re(this,Po,"f").call(this),this._emit("connect"))}get ended(){return Re(this,Ma,"f")}get errored(){return Re(this,Lo,"f")}get aborted(){return Re(this,Do,"f")}abort(){this.controller.abort()}on(e,n){return(Re(this,mr,"f")[e]||(Re(this,mr,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=Re(this,mr,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(Re(this,mr,"f")[e]||(Re(this,mr,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{qt(this,Ps,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){qt(this,Ps,!0,"f"),await Re(this,La,"f")}get currentMessage(){return Re(this,kr,"f")}async finalMessage(){return await this.done(),Re(this,bn,"m",Ol).call(this)}async finalText(){return await this.done(),Re(this,bn,"m",pp).call(this)}_emit(e,...n){if(Re(this,Ma,"f"))return;e==="end"&&(qt(this,Ma,!0,"f"),Re(this,xo,"f").call(this));const r=Re(this,mr,"f")[e];if(r&&(Re(this,mr,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!Re(this,Ps,"f")&&!(r!=null&&r.length)&&Promise.reject(s),Re(this,xa,"f").call(this,s),Re(this,Da,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!Re(this,Ps,"f")&&!(r!=null&&r.length)&&Promise.reject(s),Re(this,xa,"f").call(this,s),Re(this,Da,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalPromptCachingBetaMessage",Re(this,bn,"m",Ol).call(this))}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Re(this,bn,"m",Il).call(this),this._connected();const s=Ti.fromReadableStream(e,this.controller);for await(const i of s)Re(this,bn,"m",Nl).call(this,i);if((a=s.controller.signal)!=null&&a.aborted)throw new Mn;Re(this,bn,"m",kl).call(this)}[(kr=new WeakMap,Ro=new WeakMap,Po=new WeakMap,xa=new WeakMap,La=new WeakMap,xo=new WeakMap,Da=new WeakMap,mr=new WeakMap,Ma=new WeakMap,Lo=new WeakMap,Do=new WeakMap,Ps=new WeakMap,vl=new WeakMap,bn=new WeakSet,Ol=function(){if(this.receivedMessages.length===0)throw new Fe("stream ended without producing a PromptCachingBetaMessage with role=assistant");return this.receivedMessages.at(-1)},pp=function(){if(this.receivedMessages.length===0)throw new Fe("stream ended without producing a PromptCachingBetaMessage with role=assistant");const n=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(n.length===0)throw new Fe("stream ended without producing a content block with type=text");return n.join(" ")},Il=function(){this.ended||qt(this,kr,void 0,"f")},Nl=function(n){if(this.ended)return;const r=Re(this,bn,"m",gp).call(this,n);switch(this._emit("streamEvent",n,r),n.type){case"content_block_delta":{const s=r.content.at(-1);n.delta.type==="text_delta"&&s.type==="text"?this._emit("text",n.delta.text,s.text||""):n.delta.type==="input_json_delta"&&s.type==="tool_use"&&s.input&&this._emit("inputJson",n.delta.partial_json,s.input);break}case"message_stop":{this._addPromptCachingBetaMessageParam(r),this._addPromptCachingBetaMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{qt(this,kr,r,"f");break}}},kl=function(){if(this.ended)throw new Fe("stream has ended, this shouldn't happen");const n=Re(this,kr,"f");if(!n)throw new Fe("request ended without sending any chunks");return qt(this,kr,void 0,"f"),n},gp=function(n){let r=Re(this,kr,"f");if(n.type==="message_start"){if(r)throw new Fe(`Unexpected event order, got ${n.type} before receiving "message_stop"`);return n.message}if(!r)throw new Fe(`Unexpected event order, got ${n.type} before "message_start"`);switch(n.type){case"message_stop":return r;case"message_delta":return r.stop_reason=n.delta.stop_reason,r.stop_sequence=n.delta.stop_sequence,r.usage.output_tokens=n.usage.output_tokens,r;case"content_block_start":return r.content.push(n.content_block),r;case"content_block_delta":{const s=r.content.at(n.index);if((s==null?void 0:s.type)==="text"&&n.delta.type==="text_delta")s.text+=n.delta.text;else if((s==null?void 0:s.type)==="tool_use"&&n.delta.type==="input_json_delta"){let a=s[bp]||"";a+=n.delta.partial_json,Object.defineProperty(s,bp,{value:a,enumerable:!1,writable:!0}),a&&(s.input=E_(a))}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("streamEvent",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ti(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}let w_=class extends Is{create(e,n){const{betas:r,...s}=e;return this._client.post("/v1/messages?beta=prompt_caching",{body:s,timeout:this._client._options.timeout??6e5,...n,headers:{"anthropic-beta":[...r??[],"prompt-caching-2024-07-31"].toString(),...n==null?void 0:n.headers},stream:e.stream??!1})}stream(e,n){return xu.createMessage(this,e,n)}};class cf extends Is{constructor(){super(...arguments),this.messages=new w_(this._client)}}cf.Messages=w_;let Nc=class extends Is{constructor(){super(...arguments),this.messages=new Ic(this._client),this.promptCaching=new cf(this._client)}};Nc.Messages=Ic;Nc.PromptCaching=cf;let T_=class extends Is{create(e,n){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...n,stream:e.stream??!1})}};var Vt=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Pe=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},_n,Rr,Mo,Bo,Ba,Fa,Fo,Ua,pr,ja,Uo,jo,xs,Rl,_p,Pl,xl,Ll,Dl,yp;const Ep="__json_buf";class Lu{constructor(){_n.add(this),this.messages=[],this.receivedMessages=[],Rr.set(this,void 0),this.controller=new AbortController,Mo.set(this,void 0),Bo.set(this,()=>{}),Ba.set(this,()=>{}),Fa.set(this,void 0),Fo.set(this,()=>{}),Ua.set(this,()=>{}),pr.set(this,{}),ja.set(this,!1),Uo.set(this,!1),jo.set(this,!1),xs.set(this,!1),Pl.set(this,e=>{if(Vt(this,Uo,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Mn),e instanceof Mn)return Vt(this,jo,!0,"f"),this._emit("abort",e);if(e instanceof Fe)return this._emit("error",e);if(e instanceof Error){const n=new Fe(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new Fe(String(e)))}),Vt(this,Mo,new Promise((e,n)=>{Vt(this,Bo,e,"f"),Vt(this,Ba,n,"f")}),"f"),Vt(this,Fa,new Promise((e,n)=>{Vt(this,Fo,e,"f"),Vt(this,Ua,n,"f")}),"f"),Pe(this,Mo,"f").catch(()=>{}),Pe(this,Fa,"f").catch(()=>{})}static fromReadableStream(e){const n=new Lu;return n._run(()=>n._fromReadableStream(e)),n}static createMessage(e,n,r){const s=new Lu;for(const a of n.messages)s._addMessageParam(a);return s._run(()=>s._createMessage(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},Pe(this,Pl,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,n=!0){this.receivedMessages.push(e),n&&this._emit("message",e)}async _createMessage(e,n,r){var i;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Pe(this,_n,"m",xl).call(this);const a=await e.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)Pe(this,_n,"m",Ll).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new Mn;Pe(this,_n,"m",Dl).call(this)}_connected(){this.ended||(Pe(this,Bo,"f").call(this),this._emit("connect"))}get ended(){return Pe(this,ja,"f")}get errored(){return Pe(this,Uo,"f")}get aborted(){return Pe(this,jo,"f")}abort(){this.controller.abort()}on(e,n){return(Pe(this,pr,"f")[e]||(Pe(this,pr,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=Pe(this,pr,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(Pe(this,pr,"f")[e]||(Pe(this,pr,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{Vt(this,xs,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){Vt(this,xs,!0,"f"),await Pe(this,Fa,"f")}get currentMessage(){return Pe(this,Rr,"f")}async finalMessage(){return await this.done(),Pe(this,_n,"m",Rl).call(this)}async finalText(){return await this.done(),Pe(this,_n,"m",_p).call(this)}_emit(e,...n){if(Pe(this,ja,"f"))return;e==="end"&&(Vt(this,ja,!0,"f"),Pe(this,Fo,"f").call(this));const r=Pe(this,pr,"f")[e];if(r&&(Pe(this,pr,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!Pe(this,xs,"f")&&!(r!=null&&r.length)&&Promise.reject(s),Pe(this,Ba,"f").call(this,s),Pe(this,Ua,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!Pe(this,xs,"f")&&!(r!=null&&r.length)&&Promise.reject(s),Pe(this,Ba,"f").call(this,s),Pe(this,Ua,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",Pe(this,_n,"m",Rl).call(this))}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Pe(this,_n,"m",xl).call(this),this._connected();const s=Ti.fromReadableStream(e,this.controller);for await(const i of s)Pe(this,_n,"m",Ll).call(this,i);if((a=s.controller.signal)!=null&&a.aborted)throw new Mn;Pe(this,_n,"m",Dl).call(this)}[(Rr=new WeakMap,Mo=new WeakMap,Bo=new WeakMap,Ba=new WeakMap,Fa=new WeakMap,Fo=new WeakMap,Ua=new WeakMap,pr=new WeakMap,ja=new WeakMap,Uo=new WeakMap,jo=new WeakMap,xs=new WeakMap,Pl=new WeakMap,_n=new WeakSet,Rl=function(){if(this.receivedMessages.length===0)throw new Fe("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},_p=function(){if(this.receivedMessages.length===0)throw new Fe("stream ended without producing a Message with role=assistant");const n=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(n.length===0)throw new Fe("stream ended without producing a content block with type=text");return n.join(" ")},xl=function(){this.ended||Vt(this,Rr,void 0,"f")},Ll=function(n){if(this.ended)return;const r=Pe(this,_n,"m",yp).call(this,n);switch(this._emit("streamEvent",n,r),n.type){case"content_block_delta":{const s=r.content.at(-1);n.delta.type==="text_delta"&&s.type==="text"?this._emit("text",n.delta.text,s.text||""):n.delta.type==="input_json_delta"&&s.type==="tool_use"&&s.input&&this._emit("inputJson",n.delta.partial_json,s.input);break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{Vt(this,Rr,r,"f");break}}},Dl=function(){if(this.ended)throw new Fe("stream has ended, this shouldn't happen");const n=Pe(this,Rr,"f");if(!n)throw new Fe("request ended without sending any chunks");return Vt(this,Rr,void 0,"f"),n},yp=function(n){let r=Pe(this,Rr,"f");if(n.type==="message_start"){if(r)throw new Fe(`Unexpected event order, got ${n.type} before receiving "message_stop"`);return n.message}if(!r)throw new Fe(`Unexpected event order, got ${n.type} before "message_start"`);switch(n.type){case"message_stop":return r;case"message_delta":return r.stop_reason=n.delta.stop_reason,r.stop_sequence=n.delta.stop_sequence,r.usage.output_tokens=n.usage.output_tokens,r;case"content_block_start":return r.content.push(n.content_block),r;case"content_block_delta":{const s=r.content.at(n.index);if((s==null?void 0:s.type)==="text"&&n.delta.type==="text_delta")s.text+=n.delta.text;else if((s==null?void 0:s.type)==="tool_use"&&n.delta.type==="input_json_delta"){let a=s[Ep]||"";a+=n.delta.partial_json,Object.defineProperty(s,Ep,{value:a,enumerable:!1,writable:!0}),a&&(s.input=E_(a))}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("streamEvent",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ti(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}let S_=class extends Is{create(e,n){return e.model in wp&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${wp[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??6e5,...n,stream:e.stream??!1})}stream(e,n){return Lu.createMessage(this,e,n)}};const wp={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024"};var A_;class tt extends N2{constructor({baseURL:e=Cl("ANTHROPIC_BASE_URL"),apiKey:n=Cl("ANTHROPIC_API_KEY")??null,authToken:r=Cl("ANTHROPIC_AUTH_TOKEN")??null,...s}={}){const a={apiKey:n,authToken:r,...s,baseURL:e||"https://api.anthropic.com"};if(!a.dangerouslyAllowBrowser&&$2())throw new Fe(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });

TODO: link!
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new T_(this),this.messages=new S_(this),this.beta=new Nc(this),this._options=a,this.apiKey=n,this.authToken=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,n){if(!(this.apiKey&&e["x-api-key"])&&n["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&n.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){const n=this.apiKeyAuth(e),r=this.bearerAuth(e);return n!=null&&!Pu(n)?n:r!=null&&!Pu(r)?r:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}}A_=tt;tt.Anthropic=A_;tt.HUMAN_PROMPT=`

Human:`;tt.AI_PROMPT=`

Assistant:`;tt.DEFAULT_TIMEOUT=6e5;tt.AnthropicError=Fe;tt.APIError=gn;tt.APIConnectionError=Oc;tt.APIConnectionTimeoutError=i_;tt.APIUserAbortError=Mn;tt.NotFoundError=l_;tt.ConflictError=d_;tt.RateLimitError=f_;tt.BadRequestError=o_;tt.AuthenticationError=u_;tt.InternalServerError=m_;tt.PermissionDeniedError=c_;tt.UnprocessableEntityError=h_;tt.toFile=T2;tt.fileFromPath=a_;tt.Completions=T_;tt.Messages=S_;tt.Beta=Nc;function Tp(t,e=lf){t=t.trim();const n=/```(json)?(.*)```/s.exec(t);return e(n?n[2]:t)}function lf(t){if(typeof t>"u")return null;try{return JSON.parse(t)}catch{}let e="";const n=[];let r=!1,s=!1;for(let a of t){if(r)a==='"'&&!s?r=!1:a===`
`&&!s?a="\\n":a==="\\"?s=!s:s=!1;else if(a==='"')r=!0,s=!1;else if(a==="{")n.push("}");else if(a==="[")n.push("]");else if(a==="}"||a==="]")if(n[n.length-1]===a)n.pop();else return null;e+=a}r&&(e+='"');for(let a=n.length-1;a>=0;a-=1)e+=n[a];try{return JSON.parse(e)}catch{return null}}var G2=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const K2=to(G2);var C_={exports:{}};const Y2=/[\p{Lu}]/u,Z2=/[\p{Ll}]/u,Sp=/^[\p{Lu}](?![\p{Lu}])/gu,O_=/([\p{Alpha}\p{N}_]|$)/u,v_=/[_.\- ]+/,J2=new RegExp("^"+v_.source),Ap=new RegExp(v_.source+O_.source,"gu"),Cp=new RegExp("\\d+"+O_.source,"gu"),X2=(t,e,n)=>{let r=!1,s=!1,a=!1;for(let i=0;i<t.length;i++){const o=t[i];r&&Y2.test(o)?(t=t.slice(0,i)+"-"+t.slice(i),r=!1,a=s,s=!0,i++):s&&a&&Z2.test(o)?(t=t.slice(0,i-1)+"-"+t.slice(i-1),a=s,s=!1,r=!0):(r=e(o)===o&&n(o)!==o,a=s,s=n(o)===o&&e(o)!==o)}return t},Q2=(t,e)=>(Sp.lastIndex=0,t.replace(Sp,n=>e(n))),eC=(t,e)=>(Ap.lastIndex=0,Cp.lastIndex=0,t.replace(Ap,(n,r)=>e(r)).replace(Cp,n=>e(n))),I_=(t,e)=>{if(!(typeof t=="string"||Array.isArray(t)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(t)?t=t.map(a=>a.trim()).filter(a=>a.length).join("-"):t=t.trim(),t.length===0)return"";const n=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),r=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return t.length===1?e.pascalCase?r(t):n(t):(t!==n(t)&&(t=X2(t,n,r)),t=t.replace(J2,""),e.preserveConsecutiveUppercase?t=Q2(t,n):t=n(t),e.pascalCase&&(t=r(t.charAt(0))+t.slice(1)),eC(t,r))};C_.exports=I_;C_.exports.default=I_;function tC(t,e){return(e==null?void 0:e[t])||K2(t)}function nC(t,e,n){const r={};for(const s in t)Object.hasOwn(t,s)&&(r[e(s,n)]=t[s]);return r}function Op(t){return Array.isArray(t)?[...t]:{...t}}function rC(t,e){const n=Op(t);for(const[r,s]of Object.entries(e)){const[a,...i]=r.split(".").reverse();let o=n;for(const u of i.reverse()){if(o[u]===void 0)break;o[u]=Op(o[u]),o=o[u]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[s]})}return n}function N_(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}class $r{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,N_(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...n){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof $r||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},n={},r=Object.keys(this.lc_kwargs).reduce((s,a)=>(s[a]=a in this?this[a]:this.lc_kwargs[a],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(n,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(n).forEach(s=>{let a=this,i=r;const[o,...u]=s.split(".").reverse();for(const c of u.reverse()){if(!(c in a)||a[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof a[c]=="object"&&a[c]!=null?i[c]={}:Array.isArray(a[c])&&(i[c]=[])),a=a[c],i=i[c]}o in a&&a[o]!==void 0&&(i[o]=i[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:nC(Object.keys(n).length?rC(r,n):r,tC,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function ba(t,e){return typeof t=="string"?typeof e=="string"?t+e:[{type:"text",text:t},...e]:Array.isArray(e)?kc(t,e)??[...t,...e]:[...t,{type:"text",text:e}]}function sC(t,e){return t==="error"||e==="error"?"error":"success"}function aC(t,e){function n(r,s){if(typeof r!="object"||r===null||r===void 0)return r;if(s>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>n(i,s+1));const a={};for(const i of Object.keys(r))a[i]=n(r[i],s+1);return a}return JSON.stringify(n(t,0),null,2)}class _a extends $r{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}getType(){return this._getType()}constructor(e,n){typeof e=="string"&&(e={content:e,additional_kwargs:n,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const n=aC(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${n}`}}function jt(t,e){const n={...t};for(const[r,s]of Object.entries(e))if(n[r]==null)n[r]=s;else{if(s==null)continue;if(typeof n[r]!=typeof s||Array.isArray(n[r])!==Array.isArray(s))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof n[r]=="string"){if(r==="type")continue;n[r]+=s}else if(typeof n[r]=="object"&&!Array.isArray(n[r]))n[r]=jt(n[r],s);else if(Array.isArray(n[r]))n[r]=kc(n[r],s);else{if(n[r]===s)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return n}function kc(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t||e;{const n=[...t];for(const r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){const s=n.findIndex(a=>a.index===r.index);s!==-1?n[s]=jt(n[s],r):n.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;n.push(r)}return n}}}function iC(t,e){if(!t&&!e)throw new Error("Cannot merge two undefined objects.");if(!t||!e)return t||e;if(typeof t!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof t}
Right ${typeof e}`);if(typeof t=="string"&&typeof e=="string")return t+e;if(Array.isArray(t)&&Array.isArray(e))return kc(t,e);if(typeof t=="object"&&typeof e=="object")return jt(t,e);if(t===e)return t;throw new Error(`Can not merge objects of different types.
Left ${t}
Right ${e}`)}class ya extends _a{}function oC(t){return typeof t.role=="string"}function Rc(t){return typeof(t==null?void 0:t._getType)=="function"}function uC(t){return Rc(t)&&typeof t.concat=="function"}function cC(t){return t!=null&&typeof t=="object"&&"lc_direct_tool_output"in t&&t.lc_direct_tool_output===!0}class Yd extends _a{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,n,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:n}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class df extends ya{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new df({content:ba(this.content,e.content),additional_kwargs:jt(this.additional_kwargs,e.additional_kwargs),response_metadata:jt(this.response_metadata,e.response_metadata),artifact:iC(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:sC(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function lC(t){const e=[],n=[];for(const r of t)if(r.function){const s=r.function.name;try{const a=JSON.parse(r.function.arguments),i={name:s||"",args:a||{},id:r.id};e.push(i)}catch{n.push({name:s,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,n]}class bs extends _a{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,n){var s;let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:n??{}};else{r=e;const a=(s=r.additional_kwargs)==null?void 0:s.tool_calls,i=r.tool_calls;a!=null&&a.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&i===void 0){const[o,u]=lC(a);r.tool_calls=o??[],r.invalid_tool_calls=u??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function ro(t){return t._getType()==="ai"}function vp(t){return t._getType()==="ai"}class Yt extends ya{constructor(e){let n;if(typeof e=="string")n={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)n={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const r=[],s=[];for(const a of e.tool_call_chunks){let i={};try{if(i=lf(a.args||"{}"),i===null||typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:a.name??"",args:i,id:a.id,type:"tool_call"})}catch{s.push({name:a.name,args:a.args,id:a.id,error:"Malformed args.",type:"invalid_tool_call"})}}n={...e,tool_calls:r,invalid_tool_calls:s,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=n.tool_call_chunks??this.tool_call_chunks,this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){var r,s,a,i,o,u,c,l,d,p,m,f,g,b,_,E,T,N,v,A,O,x,D,U,Q,K,oe,L,I,B,q,M,V,X,z,ne,me,ke,Se,yt;const n={content:ba(this.content,e.content),additional_kwargs:jt(this.additional_kwargs,e.additional_kwargs),response_metadata:jt(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const Ot=kc(this.tool_call_chunks,e.tool_call_chunks);Ot!==void 0&&Ot.length>0&&(n.tool_call_chunks=Ot)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){const Ot={...(((s=(r=this.usage_metadata)==null?void 0:r.input_token_details)==null?void 0:s.audio)!==void 0||((i=(a=e.usage_metadata)==null?void 0:a.input_token_details)==null?void 0:i.audio)!==void 0)&&{audio:(((u=(o=this.usage_metadata)==null?void 0:o.input_token_details)==null?void 0:u.audio)??0)+(((l=(c=e.usage_metadata)==null?void 0:c.input_token_details)==null?void 0:l.audio)??0)},...(((p=(d=this.usage_metadata)==null?void 0:d.input_token_details)==null?void 0:p.cache_read)!==void 0||((f=(m=e.usage_metadata)==null?void 0:m.input_token_details)==null?void 0:f.cache_read)!==void 0)&&{cache_read:(((b=(g=this.usage_metadata)==null?void 0:g.input_token_details)==null?void 0:b.cache_read)??0)+(((E=(_=e.usage_metadata)==null?void 0:_.input_token_details)==null?void 0:E.cache_read)??0)},...(((N=(T=this.usage_metadata)==null?void 0:T.input_token_details)==null?void 0:N.cache_creation)!==void 0||((A=(v=e.usage_metadata)==null?void 0:v.input_token_details)==null?void 0:A.cache_creation)!==void 0)&&{cache_creation:(((x=(O=this.usage_metadata)==null?void 0:O.input_token_details)==null?void 0:x.cache_creation)??0)+(((U=(D=e.usage_metadata)==null?void 0:D.input_token_details)==null?void 0:U.cache_creation)??0)}},Ir={...(((K=(Q=this.usage_metadata)==null?void 0:Q.output_token_details)==null?void 0:K.audio)!==void 0||((L=(oe=e.usage_metadata)==null?void 0:oe.output_token_details)==null?void 0:L.audio)!==void 0)&&{audio:(((B=(I=this.usage_metadata)==null?void 0:I.output_token_details)==null?void 0:B.audio)??0)+(((M=(q=e.usage_metadata)==null?void 0:q.output_token_details)==null?void 0:M.audio)??0)},...(((X=(V=this.usage_metadata)==null?void 0:V.output_token_details)==null?void 0:X.reasoning)!==void 0||((ne=(z=e.usage_metadata)==null?void 0:z.output_token_details)==null?void 0:ne.reasoning)!==void 0)&&{reasoning:(((ke=(me=this.usage_metadata)==null?void 0:me.output_token_details)==null?void 0:ke.reasoning)??0)+(((yt=(Se=e.usage_metadata)==null?void 0:Se.output_token_details)==null?void 0:yt.reasoning)??0)}},vn=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},Et=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},Jn={input_tokens:vn.input_tokens+Et.input_tokens,output_tokens:vn.output_tokens+Et.output_tokens,total_tokens:vn.total_tokens+Et.total_tokens,...Object.keys(Ot).length>0&&{input_token_details:Ot},...Object.keys(Ir).length>0&&{output_token_details:Ir}};n.usage_metadata=Jn}return new Yt(n)}}class so extends _a{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return so}constructor(e,n){typeof e=="string"&&(e={content:e,role:n}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}}class Pc extends ya{static lc_name(){return"ChatMessageChunk"}constructor(e,n){typeof e=="string"&&(e={content:e,role:n}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new Pc({content:ba(this.content,e.content),additional_kwargs:jt(this.additional_kwargs,e.additional_kwargs),response_metadata:jt(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class xc extends ya{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new xc({content:ba(this.content,e.content),additional_kwargs:jt(this.additional_kwargs,e.additional_kwargs),response_metadata:jt(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class or extends _a{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class Lc extends ya{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new Lc({content:ba(this.content,e.content),additional_kwargs:jt(this.additional_kwargs,e.additional_kwargs),response_metadata:jt(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class Zd extends _a{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Si extends ya{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Si({content:ba(this.content,e.content),additional_kwargs:jt(this.additional_kwargs,e.additional_kwargs),response_metadata:jt(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function k_(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function hf(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}class R_ extends Error{constructor(e,n){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=n}}function dC(t){return hf(t)?t:typeof t.id=="string"&&t.type==="function"&&typeof t.function=="object"&&t.function!==null&&"arguments"in t.function&&typeof t.function.arguments=="string"&&"name"in t.function&&typeof t.function.name=="string"?{id:t.id,args:JSON.parse(t.function.arguments),name:t.function.name,type:"tool_call"}:t}function hC(t){return typeof t=="object"&&t!=null&&t.lc===1&&Array.isArray(t.id)&&t.kwargs!=null&&typeof t.kwargs=="object"}function Ml(t){let e,n;if(hC(t)){const r=t.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":e="unknown",n=t.kwargs}else{const{type:r,...s}=t;e=r,n=s}if(e==="human"||e==="user")return new or(n);if(e==="ai"||e==="assistant"){const{tool_calls:r,...s}=n;if(!Array.isArray(r))return new bs(n);const a=r.map(dC);return new bs({...s,tool_calls:a})}else{if(e==="system")return new Zd(n);if(e==="developer")return new Zd({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in n)return new Yd({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});throw k_(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(t,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Ya(t){if(typeof t=="string")return new or(t);if(Rc(t))return t;if(Array.isArray(t)){const[e,n]=t;return Ml({type:e,content:n})}else if(oC(t)){const{role:e,...n}=t;return Ml({...n,type:e})}else return Ml(t)}function P_(t,e="Human",n="AI"){const r=[];for(const s of t){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=n;else if(s._getType()==="system")a="System";else if(s._getType()==="function")a="Function";else if(s._getType()==="tool")a="Tool";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const i=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);r.push(`${a}: ${i}${o}`)}return r.join(`
`)}function fC(t){var n;const e=t._getType();if(e==="human")return new Lc({...t});if(e==="ai"){let r={...t};return"tool_calls"in r&&(r={...r,tool_call_chunks:(n=r.tool_calls)==null?void 0:n.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new Yt({...r})}else{if(e==="system")return new Si({...t});if(e==="function")return new xc({...t});if(so.isInstance(t))return new Pc({...t});throw new Error("Unknown message type.")}}var Le;(function(t){t.assertEqual=s=>s;function e(s){}t.assertIs=e;function n(s){throw new Error}t.assertNever=n,t.arrayToEnum=s=>{const a={};for(const i of s)a[i]=i;return a},t.getValidEnumValues=s=>{const a=t.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),i={};for(const o of a)i[o]=s[o];return t.objectValues(i)},t.objectValues=s=>t.objectKeys(s).map(function(a){return s[a]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const a=[];for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&a.push(i);return a},t.find=(s,a)=>{for(const i of s)if(a(i))return i},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&isFinite(s)&&Math.floor(s)===s;function r(s,a=" | "){return s.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}t.joinValues=r,t.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(Le||(Le={}));var Jd;(function(t){t.mergeShapes=(e,n)=>({...e,...n})})(Jd||(Jd={}));const te=Le.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Tr=t=>{switch(typeof t){case"undefined":return te.undefined;case"string":return te.string;case"number":return isNaN(t)?te.nan:te.number;case"boolean":return te.boolean;case"function":return te.function;case"bigint":return te.bigint;case"symbol":return te.symbol;case"object":return Array.isArray(t)?te.array:t===null?te.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?te.promise:typeof Map<"u"&&t instanceof Map?te.map:typeof Set<"u"&&t instanceof Set?te.set:typeof Date<"u"&&t instanceof Date?te.date:te.object;default:return te.unknown}},J=Le.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),mC=t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:");class hn extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const n=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,n):this.__proto__=n,this.name="ZodError",this.issues=e}format(e){const n=e||function(a){return a.message},r={_errors:[]},s=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(s);else if(i.code==="invalid_return_type")s(i.returnTypeError);else if(i.code==="invalid_arguments")s(i.argumentsError);else if(i.path.length===0)r._errors.push(n(i));else{let o=r,u=0;for(;u<i.path.length;){const c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(n(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return s(this),r}static assert(e){if(!(e instanceof hn))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Le.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=n=>n.message){const n={},r=[];for(const s of this.issues)s.path.length>0?(n[s.path[0]]=n[s.path[0]]||[],n[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:n}}get formErrors(){return this.flatten()}}hn.create=t=>new hn(t);const ia=(t,e)=>{let n;switch(t.code){case J.invalid_type:t.received===te.undefined?n="Required":n=`Expected ${t.expected}, received ${t.received}`;break;case J.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(t.expected,Le.jsonStringifyReplacer)}`;break;case J.unrecognized_keys:n=`Unrecognized key(s) in object: ${Le.joinValues(t.keys,", ")}`;break;case J.invalid_union:n="Invalid input";break;case J.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${Le.joinValues(t.options)}`;break;case J.invalid_enum_value:n=`Invalid enum value. Expected ${Le.joinValues(t.options)}, received '${t.received}'`;break;case J.invalid_arguments:n="Invalid function arguments";break;case J.invalid_return_type:n="Invalid function return type";break;case J.invalid_date:n="Invalid date";break;case J.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(n=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(n=`${n} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?n=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?n=`Invalid input: must end with "${t.validation.endsWith}"`:Le.assertNever(t.validation):t.validation!=="regex"?n=`Invalid ${t.validation}`:n="Invalid";break;case J.too_small:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:n="Invalid input";break;case J.too_big:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?n=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:n="Invalid input";break;case J.custom:n="Invalid input";break;case J.invalid_intersection_types:n="Intersection results could not be merged";break;case J.not_multiple_of:n=`Number must be a multiple of ${t.multipleOf}`;break;case J.not_finite:n="Number must be finite";break;default:n=e.defaultError,Le.assertNever(t)}return{message:n}};let x_=ia;function pC(t){x_=t}function Du(){return x_}const Mu=t=>{const{data:e,path:n,errorMaps:r,issueData:s}=t,a=[...n,...s.path||[]],i={...s,path:a};if(s.message!==void 0)return{...s,path:a,message:s.message};let o="";const u=r.filter(c=>!!c).slice().reverse();for(const c of u)o=c(i,{data:e,defaultError:o}).message;return{...s,path:a,message:o}},gC=[];function ee(t,e){const n=Du(),r=Mu({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,n,n===ia?void 0:ia].filter(s=>!!s)});t.common.issues.push(r)}class Dt{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,n){const r=[];for(const s of n){if(s.status==="aborted")return de;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,n){const r=[];for(const s of n){const a=await s.key,i=await s.value;r.push({key:a,value:i})}return Dt.mergeObjectSync(e,r)}static mergeObjectSync(e,n){const r={};for(const s of n){const{key:a,value:i}=s;if(a.status==="aborted"||i.status==="aborted")return de;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||s.alwaysSet)&&(r[a.value]=i.value)}return{status:e.value,value:r}}}const de=Object.freeze({status:"aborted"}),Gs=t=>({status:"dirty",value:t}),$t=t=>({status:"valid",value:t}),Xd=t=>t.status==="aborted",Qd=t=>t.status==="dirty",_s=t=>t.status==="valid",Ai=t=>typeof Promise<"u"&&t instanceof Promise;function Bu(t,e,n,r){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(t)}function L_(t,e,n,r,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n}var se;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(se||(se={}));var Za,Ja;class hr{constructor(e,n,r,s){this._cachedPath=[],this.parent=e,this.data=n,this._path=r,this._key=s}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Ip=(t,e)=>{if(_s(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const n=new hn(t.common.issues);return this._error=n,this._error}}};function Ee(t){if(!t)return{};const{errorMap:e,invalid_type_error:n,required_error:r,description:s}=t;if(e&&(n||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(i,o)=>{var u,c;const{message:l}=t;return i.code==="invalid_enum_value"?{message:l??o.defaultError}:typeof o.data>"u"?{message:(u=l??r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(c=l??n)!==null&&c!==void 0?c:o.defaultError}},description:s}}class Oe{get description(){return this._def.description}_getType(e){return Tr(e.data)}_getOrReturnCtx(e,n){return n||{common:e.parent.common,data:e.data,parsedType:Tr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Dt,ctx:{common:e.parent.common,data:e.data,parsedType:Tr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const n=this._parse(e);if(Ai(n))throw new Error("Synchronous parse encountered promise.");return n}_parseAsync(e){const n=this._parse(e);return Promise.resolve(n)}parse(e,n){const r=this.safeParse(e,n);if(r.success)return r.data;throw r.error}safeParse(e,n){var r;const s={common:{issues:[],async:(r=n==null?void 0:n.async)!==null&&r!==void 0?r:!1,contextualErrorMap:n==null?void 0:n.errorMap},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tr(e)},a=this._parseSync({data:e,path:s.path,parent:s});return Ip(s,a)}"~validate"(e){var n,r;const s={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tr(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:s});return _s(a)?{value:a.value}:{issues:s.common.issues}}catch(a){!((r=(n=a==null?void 0:a.message)===null||n===void 0?void 0:n.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),s.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:s}).then(a=>_s(a)?{value:a.value}:{issues:s.common.issues})}async parseAsync(e,n){const r=await this.safeParseAsync(e,n);if(r.success)return r.data;throw r.error}async safeParseAsync(e,n){const r={common:{issues:[],contextualErrorMap:n==null?void 0:n.errorMap,async:!0},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tr(e)},s=this._parse({data:e,path:r.path,parent:r}),a=await(Ai(s)?s:Promise.resolve(s));return Ip(r,a)}refine(e,n){const r=s=>typeof n=="string"||typeof n>"u"?{message:n}:typeof n=="function"?n(s):n;return this._refinement((s,a)=>{const i=e(s),o=()=>a.addIssue({code:J.custom,...r(s)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,n){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof n=="function"?n(r,s):n),!1))}_refinement(e){return new qn({schema:this,typeName:H.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:n=>this["~validate"](n)}}optional(){return jn.create(this,this._def)}nullable(){return zr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Un.create(this)}promise(){return ua.create(this,this._def)}or(e){return Ii.create([this,e],this._def)}and(e){return Ni.create(this,e,this._def)}transform(e){return new qn({...Ee(this._def),schema:this,typeName:H.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const n=typeof e=="function"?e:()=>e;return new Li({...Ee(this._def),innerType:this,defaultValue:n,typeName:H.ZodDefault})}brand(){return new ff({typeName:H.ZodBranded,type:this,...Ee(this._def)})}catch(e){const n=typeof e=="function"?e:()=>e;return new Di({...Ee(this._def),innerType:this,catchValue:n,typeName:H.ZodCatch})}describe(e){const n=this.constructor;return new n({...this._def,description:e})}pipe(e){return ao.create(this,e)}readonly(){return Mi.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const bC=/^c[^\s-]{8,}$/i,_C=/^[0-9a-z]+$/,yC=/^[0-9A-HJKMNP-TV-Z]{26}$/i,EC=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,wC=/^[a-z0-9_-]{21}$/i,TC=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,SC=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,AC=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,CC="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Bl;const OC=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,vC=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,IC=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,NC=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,kC=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,RC=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,D_="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",PC=new RegExp(`^${D_}$`);function M_(t){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`),e}function xC(t){return new RegExp(`^${M_(t)}$`)}function B_(t){let e=`${D_}T${M_(t)}`;const n=[];return n.push(t.local?"Z?":"Z"),t.offset&&n.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${n.join("|")})`,new RegExp(`^${e}$`)}function LC(t,e){return!!((e==="v4"||!e)&&OC.test(t)||(e==="v6"||!e)&&IC.test(t))}function DC(t,e){if(!TC.test(t))return!1;try{const[n]=t.split("."),r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||!s.typ||!s.alg||e&&s.alg!==e)}catch{return!1}}function MC(t,e){return!!((e==="v4"||!e)&&vC.test(t)||(e==="v6"||!e)&&NC.test(t))}class Bn extends Oe{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==te.string){const a=this._getOrReturnCtx(e);return ee(a,{code:J.invalid_type,expected:te.string,received:a.parsedType}),de}const r=new Dt;let s;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:J.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:J.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(s=this._getOrReturnCtx(e,s),i?ee(s,{code:J.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&ee(s,{code:J.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),r.dirty())}else if(a.kind==="email")AC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"email",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="emoji")Bl||(Bl=new RegExp(CC,"u")),Bl.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"emoji",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="uuid")EC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"uuid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="nanoid")wC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"nanoid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid")bC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"cuid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid2")_C.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"cuid2",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="ulid")yC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"ulid",code:J.invalid_string,message:a.message}),r.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),ee(s,{validation:"url",code:J.invalid_string,message:a.message}),r.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"regex",code:J.invalid_string,message:a.message}),r.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),ee(s,{code:J.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),r.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),ee(s,{code:J.invalid_string,validation:{startsWith:a.value},message:a.message}),r.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),ee(s,{code:J.invalid_string,validation:{endsWith:a.value},message:a.message}),r.dirty()):a.kind==="datetime"?B_(a).test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{code:J.invalid_string,validation:"datetime",message:a.message}),r.dirty()):a.kind==="date"?PC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{code:J.invalid_string,validation:"date",message:a.message}),r.dirty()):a.kind==="time"?xC(a).test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{code:J.invalid_string,validation:"time",message:a.message}),r.dirty()):a.kind==="duration"?SC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"duration",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="ip"?LC(e.data,a.version)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"ip",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="jwt"?DC(e.data,a.alg)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"jwt",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="cidr"?MC(e.data,a.version)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"cidr",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="base64"?kC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"base64",code:J.invalid_string,message:a.message}),r.dirty()):a.kind==="base64url"?RC.test(e.data)||(s=this._getOrReturnCtx(e,s),ee(s,{validation:"base64url",code:J.invalid_string,message:a.message}),r.dirty()):Le.assertNever(a);return{status:r.value,value:e.data}}_regex(e,n,r){return this.refinement(s=>e.test(s),{validation:n,code:J.invalid_string,...se.errToObj(r)})}_addCheck(e){return new Bn({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...se.errToObj(e)})}url(e){return this._addCheck({kind:"url",...se.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...se.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...se.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...se.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...se.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...se.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...se.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...se.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...se.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...se.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...se.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...se.errToObj(e)})}datetime(e){var n,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(n=e==null?void 0:e.offset)!==null&&n!==void 0?n:!1,local:(r=e==null?void 0:e.local)!==null&&r!==void 0?r:!1,...se.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...se.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...se.errToObj(e)})}regex(e,n){return this._addCheck({kind:"regex",regex:e,...se.errToObj(n)})}includes(e,n){return this._addCheck({kind:"includes",value:e,position:n==null?void 0:n.position,...se.errToObj(n==null?void 0:n.message)})}startsWith(e,n){return this._addCheck({kind:"startsWith",value:e,...se.errToObj(n)})}endsWith(e,n){return this._addCheck({kind:"endsWith",value:e,...se.errToObj(n)})}min(e,n){return this._addCheck({kind:"min",value:e,...se.errToObj(n)})}max(e,n){return this._addCheck({kind:"max",value:e,...se.errToObj(n)})}length(e,n){return this._addCheck({kind:"length",value:e,...se.errToObj(n)})}nonempty(e){return this.min(1,se.errToObj(e))}trim(){return new Bn({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Bn({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Bn({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxLength(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}Bn.create=t=>{var e;return new Bn({checks:[],typeName:H.ZodString,coerce:(e=t==null?void 0:t.coerce)!==null&&e!==void 0?e:!1,...Ee(t)})};function BC(t,e){const n=(t.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=n>r?n:r,a=parseInt(t.toFixed(s).replace(".","")),i=parseInt(e.toFixed(s).replace(".",""));return a%i/Math.pow(10,s)}class Hr extends Oe{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==te.number){const a=this._getOrReturnCtx(e);return ee(a,{code:J.invalid_type,expected:te.number,received:a.parsedType}),de}let r;const s=new Dt;for(const a of this._def.checks)a.kind==="int"?Le.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),ee(r,{code:J.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:J.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:J.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?BC(e.data,a.value)!==0&&(r=this._getOrReturnCtx(e,r),ee(r,{code:J.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),ee(r,{code:J.not_finite,message:a.message}),s.dirty()):Le.assertNever(a);return{status:s.value,value:e.data}}gte(e,n){return this.setLimit("min",e,!0,se.toString(n))}gt(e,n){return this.setLimit("min",e,!1,se.toString(n))}lte(e,n){return this.setLimit("max",e,!0,se.toString(n))}lt(e,n){return this.setLimit("max",e,!1,se.toString(n))}setLimit(e,n,r,s){return new Hr({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:se.toString(s)}]})}_addCheck(e){return new Hr({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:se.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:se.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:se.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:se.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:se.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:se.toString(n)})}finite(e){return this._addCheck({kind:"finite",message:se.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:se.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:se.toString(e)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&Le.isInteger(e.value))}get isFinite(){let e=null,n=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(n===null||r.value>n)&&(n=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(n)&&Number.isFinite(e)}}Hr.create=t=>new Hr({checks:[],typeName:H.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...Ee(t)});class qr extends Oe{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==te.bigint)return this._getInvalidInput(e);let r;const s=new Dt;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:J.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:J.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),ee(r,{code:J.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):Le.assertNever(a);return{status:s.value,value:e.data}}_getInvalidInput(e){const n=this._getOrReturnCtx(e);return ee(n,{code:J.invalid_type,expected:te.bigint,received:n.parsedType}),de}gte(e,n){return this.setLimit("min",e,!0,se.toString(n))}gt(e,n){return this.setLimit("min",e,!1,se.toString(n))}lte(e,n){return this.setLimit("max",e,!0,se.toString(n))}lt(e,n){return this.setLimit("max",e,!1,se.toString(n))}setLimit(e,n,r,s){return new qr({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:se.toString(s)}]})}_addCheck(e){return new qr({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:se.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:se.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:se.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:se.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:se.toString(n)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}qr.create=t=>{var e;return new qr({checks:[],typeName:H.ZodBigInt,coerce:(e=t==null?void 0:t.coerce)!==null&&e!==void 0?e:!1,...Ee(t)})};class Ci extends Oe{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==te.boolean){const r=this._getOrReturnCtx(e);return ee(r,{code:J.invalid_type,expected:te.boolean,received:r.parsedType}),de}return $t(e.data)}}Ci.create=t=>new Ci({typeName:H.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...Ee(t)});class ys extends Oe{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==te.date){const a=this._getOrReturnCtx(e);return ee(a,{code:J.invalid_type,expected:te.date,received:a.parsedType}),de}if(isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return ee(a,{code:J.invalid_date}),de}const r=new Dt;let s;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:J.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),ee(s,{code:J.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):Le.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ys({...this._def,checks:[...this._def.checks,e]})}min(e,n){return this._addCheck({kind:"min",value:e.getTime(),message:se.toString(n)})}max(e,n){return this._addCheck({kind:"max",value:e.getTime(),message:se.toString(n)})}get minDate(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e!=null?new Date(e):null}}ys.create=t=>new ys({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:H.ZodDate,...Ee(t)});class Fu extends Oe{_parse(e){if(this._getType(e)!==te.symbol){const r=this._getOrReturnCtx(e);return ee(r,{code:J.invalid_type,expected:te.symbol,received:r.parsedType}),de}return $t(e.data)}}Fu.create=t=>new Fu({typeName:H.ZodSymbol,...Ee(t)});class Oi extends Oe{_parse(e){if(this._getType(e)!==te.undefined){const r=this._getOrReturnCtx(e);return ee(r,{code:J.invalid_type,expected:te.undefined,received:r.parsedType}),de}return $t(e.data)}}Oi.create=t=>new Oi({typeName:H.ZodUndefined,...Ee(t)});class vi extends Oe{_parse(e){if(this._getType(e)!==te.null){const r=this._getOrReturnCtx(e);return ee(r,{code:J.invalid_type,expected:te.null,received:r.parsedType}),de}return $t(e.data)}}vi.create=t=>new vi({typeName:H.ZodNull,...Ee(t)});class oa extends Oe{constructor(){super(...arguments),this._any=!0}_parse(e){return $t(e.data)}}oa.create=t=>new oa({typeName:H.ZodAny,...Ee(t)});class ds extends Oe{constructor(){super(...arguments),this._unknown=!0}_parse(e){return $t(e.data)}}ds.create=t=>new ds({typeName:H.ZodUnknown,...Ee(t)});class vr extends Oe{_parse(e){const n=this._getOrReturnCtx(e);return ee(n,{code:J.invalid_type,expected:te.never,received:n.parsedType}),de}}vr.create=t=>new vr({typeName:H.ZodNever,...Ee(t)});class Uu extends Oe{_parse(e){if(this._getType(e)!==te.undefined){const r=this._getOrReturnCtx(e);return ee(r,{code:J.invalid_type,expected:te.void,received:r.parsedType}),de}return $t(e.data)}}Uu.create=t=>new Uu({typeName:H.ZodVoid,...Ee(t)});class Un extends Oe{_parse(e){const{ctx:n,status:r}=this._processInputParams(e),s=this._def;if(n.parsedType!==te.array)return ee(n,{code:J.invalid_type,expected:te.array,received:n.parsedType}),de;if(s.exactLength!==null){const i=n.data.length>s.exactLength.value,o=n.data.length<s.exactLength.value;(i||o)&&(ee(n,{code:i?J.too_big:J.too_small,minimum:o?s.exactLength.value:void 0,maximum:i?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&n.data.length<s.minLength.value&&(ee(n,{code:J.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&n.data.length>s.maxLength.value&&(ee(n,{code:J.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),n.common.async)return Promise.all([...n.data].map((i,o)=>s.type._parseAsync(new hr(n,i,n.path,o)))).then(i=>Dt.mergeArray(r,i));const a=[...n.data].map((i,o)=>s.type._parseSync(new hr(n,i,n.path,o)));return Dt.mergeArray(r,a)}get element(){return this._def.type}min(e,n){return new Un({...this._def,minLength:{value:e,message:se.toString(n)}})}max(e,n){return new Un({...this._def,maxLength:{value:e,message:se.toString(n)}})}length(e,n){return new Un({...this._def,exactLength:{value:e,message:se.toString(n)}})}nonempty(e){return this.min(1,e)}}Un.create=(t,e)=>new Un({type:t,minLength:null,maxLength:null,exactLength:null,typeName:H.ZodArray,...Ee(e)});function Vs(t){if(t instanceof rt){const e={};for(const n in t.shape){const r=t.shape[n];e[n]=jn.create(Vs(r))}return new rt({...t._def,shape:()=>e})}else return t instanceof Un?new Un({...t._def,type:Vs(t.element)}):t instanceof jn?jn.create(Vs(t.unwrap())):t instanceof zr?zr.create(Vs(t.unwrap())):t instanceof fr?fr.create(t.items.map(e=>Vs(e))):t}class rt extends Oe{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),n=Le.objectKeys(e);return this._cached={shape:e,keys:n}}_parse(e){if(this._getType(e)!==te.object){const c=this._getOrReturnCtx(e);return ee(c,{code:J.invalid_type,expected:te.object,received:c.parsedType}),de}const{status:r,ctx:s}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof vr&&this._def.unknownKeys==="strip"))for(const c in s.data)i.includes(c)||o.push(c);const u=[];for(const c of i){const l=a[c],d=s.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new hr(s,d,s.path,c)),alwaysSet:c in s.data})}if(this._def.catchall instanceof vr){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(c==="strict")o.length>0&&(ee(s,{code:J.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const d=s.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new hr(s,d,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const d=await l.key,p=await l.value;c.push({key:d,value:p,alwaysSet:l.alwaysSet})}return c}).then(c=>Dt.mergeObjectSync(r,c)):Dt.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return se.errToObj,new rt({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(n,r)=>{var s,a,i,o;const u=(i=(a=(s=this._def).errorMap)===null||a===void 0?void 0:a.call(s,n,r).message)!==null&&i!==void 0?i:r.defaultError;return n.code==="unrecognized_keys"?{message:(o=se.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new rt({...this._def,unknownKeys:"strip"})}passthrough(){return new rt({...this._def,unknownKeys:"passthrough"})}extend(e){return new rt({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new rt({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:H.ZodObject})}setKey(e,n){return this.augment({[e]:n})}catchall(e){return new rt({...this._def,catchall:e})}pick(e){const n={};return Le.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(n[r]=this.shape[r])}),new rt({...this._def,shape:()=>n})}omit(e){const n={};return Le.objectKeys(this.shape).forEach(r=>{e[r]||(n[r]=this.shape[r])}),new rt({...this._def,shape:()=>n})}deepPartial(){return Vs(this)}partial(e){const n={};return Le.objectKeys(this.shape).forEach(r=>{const s=this.shape[r];e&&!e[r]?n[r]=s:n[r]=s.optional()}),new rt({...this._def,shape:()=>n})}required(e){const n={};return Le.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])n[r]=this.shape[r];else{let a=this.shape[r];for(;a instanceof jn;)a=a._def.innerType;n[r]=a}}),new rt({...this._def,shape:()=>n})}keyof(){return F_(Le.objectKeys(this.shape))}}rt.create=(t,e)=>new rt({shape:()=>t,unknownKeys:"strip",catchall:vr.create(),typeName:H.ZodObject,...Ee(e)});rt.strictCreate=(t,e)=>new rt({shape:()=>t,unknownKeys:"strict",catchall:vr.create(),typeName:H.ZodObject,...Ee(e)});rt.lazycreate=(t,e)=>new rt({shape:t,unknownKeys:"strip",catchall:vr.create(),typeName:H.ZodObject,...Ee(e)});class Ii extends Oe{_parse(e){const{ctx:n}=this._processInputParams(e),r=this._def.options;function s(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return n.common.issues.push(...o.ctx.common.issues),o.result;const i=a.map(o=>new hn(o.ctx.common.issues));return ee(n,{code:J.invalid_union,unionErrors:i}),de}if(n.common.async)return Promise.all(r.map(async a=>{const i={...n,common:{...n.common,issues:[]},parent:null};return{result:await a._parseAsync({data:n.data,path:n.path,parent:i}),ctx:i}})).then(s);{let a;const i=[];for(const u of r){const c={...n,common:{...n.common,issues:[]},parent:null},l=u._parseSync({data:n.data,path:n.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!a&&(a={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(a)return n.common.issues.push(...a.ctx.common.issues),a.result;const o=i.map(u=>new hn(u));return ee(n,{code:J.invalid_union,unionErrors:o}),de}}get options(){return this._def.options}}Ii.create=(t,e)=>new Ii({options:t,typeName:H.ZodUnion,...Ee(e)});const _r=t=>t instanceof Ri?_r(t.schema):t instanceof qn?_r(t.innerType()):t instanceof Pi?[t.value]:t instanceof Vr?t.options:t instanceof xi?Le.objectValues(t.enum):t instanceof Li?_r(t._def.innerType):t instanceof Oi?[void 0]:t instanceof vi?[null]:t instanceof jn?[void 0,..._r(t.unwrap())]:t instanceof zr?[null,..._r(t.unwrap())]:t instanceof ff||t instanceof Mi?_r(t.unwrap()):t instanceof Di?_r(t._def.innerType):[];class Dc extends Oe{_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==te.object)return ee(n,{code:J.invalid_type,expected:te.object,received:n.parsedType}),de;const r=this.discriminator,s=n.data[r],a=this.optionsMap.get(s);return a?n.common.async?a._parseAsync({data:n.data,path:n.path,parent:n}):a._parseSync({data:n.data,path:n.path,parent:n}):(ee(n,{code:J.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),de)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,n,r){const s=new Map;for(const a of n){const i=_r(a.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,a)}}return new Dc({typeName:H.ZodDiscriminatedUnion,discriminator:e,options:n,optionsMap:s,...Ee(r)})}}function eh(t,e){const n=Tr(t),r=Tr(e);if(t===e)return{valid:!0,data:t};if(n===te.object&&r===te.object){const s=Le.objectKeys(e),a=Le.objectKeys(t).filter(o=>s.indexOf(o)!==-1),i={...t,...e};for(const o of a){const u=eh(t[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(n===te.array&&r===te.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let a=0;a<t.length;a++){const i=t[a],o=e[a],u=eh(i,o);if(!u.valid)return{valid:!1};s.push(u.data)}return{valid:!0,data:s}}else return n===te.date&&r===te.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}class Ni extends Oe{_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=(a,i)=>{if(Xd(a)||Xd(i))return de;const o=eh(a.value,i.value);return o.valid?((Qd(a)||Qd(i))&&n.dirty(),{status:n.value,value:o.data}):(ee(r,{code:J.invalid_intersection_types}),de)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([a,i])=>s(a,i)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}Ni.create=(t,e,n)=>new Ni({left:t,right:e,typeName:H.ZodIntersection,...Ee(n)});class fr extends Oe{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==te.array)return ee(r,{code:J.invalid_type,expected:te.array,received:r.parsedType}),de;if(r.data.length<this._def.items.length)return ee(r,{code:J.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),de;!this._def.rest&&r.data.length>this._def.items.length&&(ee(r,{code:J.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),n.dirty());const a=[...r.data].map((i,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new hr(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(a).then(i=>Dt.mergeArray(n,i)):Dt.mergeArray(n,a)}get items(){return this._def.items}rest(e){return new fr({...this._def,rest:e})}}fr.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new fr({items:t,typeName:H.ZodTuple,rest:null,...Ee(e)})};class ki extends Oe{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==te.object)return ee(r,{code:J.invalid_type,expected:te.object,received:r.parsedType}),de;const s=[],a=this._def.keyType,i=this._def.valueType;for(const o in r.data)s.push({key:a._parse(new hr(r,o,r.path,o)),value:i._parse(new hr(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Dt.mergeObjectAsync(n,s):Dt.mergeObjectSync(n,s)}get element(){return this._def.valueType}static create(e,n,r){return n instanceof Oe?new ki({keyType:e,valueType:n,typeName:H.ZodRecord,...Ee(r)}):new ki({keyType:Bn.create(),valueType:e,typeName:H.ZodRecord,...Ee(n)})}}class ju extends Oe{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==te.map)return ee(r,{code:J.invalid_type,expected:te.map,received:r.parsedType}),de;const s=this._def.keyType,a=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:s._parse(new hr(r,o,r.path,[c,"key"])),value:a._parse(new hr(r,u,r.path,[c,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of i){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return de;(c.status==="dirty"||l.status==="dirty")&&n.dirty(),o.set(c.value,l.value)}return{status:n.value,value:o}})}else{const o=new Map;for(const u of i){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return de;(c.status==="dirty"||l.status==="dirty")&&n.dirty(),o.set(c.value,l.value)}return{status:n.value,value:o}}}}ju.create=(t,e,n)=>new ju({valueType:e,keyType:t,typeName:H.ZodMap,...Ee(n)});class Es extends Oe{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==te.set)return ee(r,{code:J.invalid_type,expected:te.set,received:r.parsedType}),de;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(ee(r,{code:J.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),n.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(ee(r,{code:J.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),n.dirty());const a=this._def.valueType;function i(u){const c=new Set;for(const l of u){if(l.status==="aborted")return de;l.status==="dirty"&&n.dirty(),c.add(l.value)}return{status:n.value,value:c}}const o=[...r.data.values()].map((u,c)=>a._parse(new hr(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,n){return new Es({...this._def,minSize:{value:e,message:se.toString(n)}})}max(e,n){return new Es({...this._def,maxSize:{value:e,message:se.toString(n)}})}size(e,n){return this.min(e,n).max(e,n)}nonempty(e){return this.min(1,e)}}Es.create=(t,e)=>new Es({valueType:t,minSize:null,maxSize:null,typeName:H.ZodSet,...Ee(e)});class ta extends Oe{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==te.function)return ee(n,{code:J.invalid_type,expected:te.function,received:n.parsedType}),de;function r(o,u){return Mu({data:o,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,Du(),ia].filter(c=>!!c),issueData:{code:J.invalid_arguments,argumentsError:u}})}function s(o,u){return Mu({data:o,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,Du(),ia].filter(c=>!!c),issueData:{code:J.invalid_return_type,returnTypeError:u}})}const a={errorMap:n.common.contextualErrorMap},i=n.data;if(this._def.returns instanceof ua){const o=this;return $t(async function(...u){const c=new hn([]),l=await o._def.args.parseAsync(u,a).catch(m=>{throw c.addIssue(r(u,m)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,a).catch(m=>{throw c.addIssue(s(d,m)),c})})}else{const o=this;return $t(function(...u){const c=o._def.args.safeParse(u,a);if(!c.success)throw new hn([r(u,c.error)]);const l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,a);if(!d.success)throw new hn([s(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new ta({...this._def,args:fr.create(e).rest(ds.create())})}returns(e){return new ta({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,n,r){return new ta({args:e||fr.create([]).rest(ds.create()),returns:n||ds.create(),typeName:H.ZodFunction,...Ee(r)})}}class Ri extends Oe{get schema(){return this._def.getter()}_parse(e){const{ctx:n}=this._processInputParams(e);return this._def.getter()._parse({data:n.data,path:n.path,parent:n})}}Ri.create=(t,e)=>new Ri({getter:t,typeName:H.ZodLazy,...Ee(e)});class Pi extends Oe{_parse(e){if(e.data!==this._def.value){const n=this._getOrReturnCtx(e);return ee(n,{received:n.data,code:J.invalid_literal,expected:this._def.value}),de}return{status:"valid",value:e.data}}get value(){return this._def.value}}Pi.create=(t,e)=>new Pi({value:t,typeName:H.ZodLiteral,...Ee(e)});function F_(t,e){return new Vr({values:t,typeName:H.ZodEnum,...Ee(e)})}class Vr extends Oe{constructor(){super(...arguments),Za.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const n=this._getOrReturnCtx(e),r=this._def.values;return ee(n,{expected:Le.joinValues(r),received:n.parsedType,code:J.invalid_type}),de}if(Bu(this,Za)||L_(this,Za,new Set(this._def.values)),!Bu(this,Za).has(e.data)){const n=this._getOrReturnCtx(e),r=this._def.values;return ee(n,{received:n.data,code:J.invalid_enum_value,options:r}),de}return $t(e.data)}get options(){return this._def.values}get enum(){const e={};for(const n of this._def.values)e[n]=n;return e}get Values(){const e={};for(const n of this._def.values)e[n]=n;return e}get Enum(){const e={};for(const n of this._def.values)e[n]=n;return e}extract(e,n=this._def){return Vr.create(e,{...this._def,...n})}exclude(e,n=this._def){return Vr.create(this.options.filter(r=>!e.includes(r)),{...this._def,...n})}}Za=new WeakMap;Vr.create=F_;class xi extends Oe{constructor(){super(...arguments),Ja.set(this,void 0)}_parse(e){const n=Le.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==te.string&&r.parsedType!==te.number){const s=Le.objectValues(n);return ee(r,{expected:Le.joinValues(s),received:r.parsedType,code:J.invalid_type}),de}if(Bu(this,Ja)||L_(this,Ja,new Set(Le.getValidEnumValues(this._def.values))),!Bu(this,Ja).has(e.data)){const s=Le.objectValues(n);return ee(r,{received:r.data,code:J.invalid_enum_value,options:s}),de}return $t(e.data)}get enum(){return this._def.values}}Ja=new WeakMap;xi.create=(t,e)=>new xi({values:t,typeName:H.ZodNativeEnum,...Ee(e)});class ua extends Oe{unwrap(){return this._def.type}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==te.promise&&n.common.async===!1)return ee(n,{code:J.invalid_type,expected:te.promise,received:n.parsedType}),de;const r=n.parsedType===te.promise?n.data:Promise.resolve(n.data);return $t(r.then(s=>this._def.type.parseAsync(s,{path:n.path,errorMap:n.common.contextualErrorMap})))}}ua.create=(t,e)=>new ua({type:t,typeName:H.ZodPromise,...Ee(e)});class qn extends Oe{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===H.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:i=>{ee(r,i),i.fatal?n.abort():n.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){const i=s.transform(r.data,a);if(r.common.async)return Promise.resolve(i).then(async o=>{if(n.value==="aborted")return de;const u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?de:u.status==="dirty"||n.value==="dirty"?Gs(u.value):u});{if(n.value==="aborted")return de;const o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?de:o.status==="dirty"||n.value==="dirty"?Gs(o.value):o}}if(s.type==="refinement"){const i=o=>{const u=s.refinement(o,a);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?de:(o.status==="dirty"&&n.dirty(),i(o.value),{status:n.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?de:(o.status==="dirty"&&n.dirty(),i(o.value).then(()=>({status:n.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!_s(i))return i;const o=s.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:n.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>_s(i)?Promise.resolve(s.transform(i.value,a)).then(o=>({status:n.value,value:o})):i);Le.assertNever(s)}}qn.create=(t,e,n)=>new qn({schema:t,typeName:H.ZodEffects,effect:e,...Ee(n)});qn.createWithPreprocess=(t,e,n)=>new qn({schema:e,effect:{type:"preprocess",transform:t},typeName:H.ZodEffects,...Ee(n)});class jn extends Oe{_parse(e){return this._getType(e)===te.undefined?$t(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}jn.create=(t,e)=>new jn({innerType:t,typeName:H.ZodOptional,...Ee(e)});class zr extends Oe{_parse(e){return this._getType(e)===te.null?$t(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}zr.create=(t,e)=>new zr({innerType:t,typeName:H.ZodNullable,...Ee(e)});class Li extends Oe{_parse(e){const{ctx:n}=this._processInputParams(e);let r=n.data;return n.parsedType===te.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:n.path,parent:n})}removeDefault(){return this._def.innerType}}Li.create=(t,e)=>new Li({innerType:t,typeName:H.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...Ee(e)});class Di extends Oe{_parse(e){const{ctx:n}=this._processInputParams(e),r={...n,common:{...n.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Ai(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new hn(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new hn(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Di.create=(t,e)=>new Di({innerType:t,typeName:H.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...Ee(e)});class $u extends Oe{_parse(e){if(this._getType(e)!==te.nan){const r=this._getOrReturnCtx(e);return ee(r,{code:J.invalid_type,expected:te.nan,received:r.parsedType}),de}return{status:"valid",value:e.data}}}$u.create=t=>new $u({typeName:H.ZodNaN,...Ee(t)});const FC=Symbol("zod_brand");class ff extends Oe{_parse(e){const{ctx:n}=this._processInputParams(e),r=n.data;return this._def.type._parse({data:r,path:n.path,parent:n})}unwrap(){return this._def.type}}class ao extends Oe{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?de:a.status==="dirty"?(n.dirty(),Gs(a.value)):this._def.out._parseAsync({data:a.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?de:s.status==="dirty"?(n.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,n){return new ao({in:e,out:n,typeName:H.ZodPipeline})}}class Mi extends Oe{_parse(e){const n=this._def.innerType._parse(e),r=s=>(_s(s)&&(s.value=Object.freeze(s.value)),s);return Ai(n)?n.then(s=>r(s)):r(n)}unwrap(){return this._def.innerType}}Mi.create=(t,e)=>new Mi({innerType:t,typeName:H.ZodReadonly,...Ee(e)});function U_(t,e={},n){return t?oa.create().superRefine((r,s)=>{var a,i;if(!t(r)){const o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(a=o.fatal)!==null&&a!==void 0?a:n)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;s.addIssue({code:"custom",...c,fatal:u})}}):oa.create()}const UC={object:rt.lazycreate};var H;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(H||(H={}));const jC=(t,e={message:`Input not instance of ${t.name}`})=>U_(n=>n instanceof t,e),j_=Bn.create,$_=Hr.create,$C=$u.create,HC=qr.create,H_=Ci.create,qC=ys.create,VC=Fu.create,zC=Oi.create,WC=vi.create,GC=oa.create,KC=ds.create,YC=vr.create,ZC=Uu.create,JC=Un.create,XC=rt.create,QC=rt.strictCreate,eO=Ii.create,tO=Dc.create,nO=Ni.create,rO=fr.create,sO=ki.create,aO=ju.create,iO=Es.create,oO=ta.create,uO=Ri.create,cO=Pi.create,lO=Vr.create,dO=xi.create,hO=ua.create,Np=qn.create,fO=jn.create,mO=zr.create,pO=qn.createWithPreprocess,gO=ao.create,bO=()=>j_().optional(),_O=()=>$_().optional(),yO=()=>H_().optional(),EO={string:t=>Bn.create({...t,coerce:!0}),number:t=>Hr.create({...t,coerce:!0}),boolean:t=>Ci.create({...t,coerce:!0}),bigint:t=>qr.create({...t,coerce:!0}),date:t=>ys.create({...t,coerce:!0})},wO=de;var Ar=Object.freeze({__proto__:null,defaultErrorMap:ia,setErrorMap:pC,getErrorMap:Du,makeIssue:Mu,EMPTY_PATH:gC,addIssueToContext:ee,ParseStatus:Dt,INVALID:de,DIRTY:Gs,OK:$t,isAborted:Xd,isDirty:Qd,isValid:_s,isAsync:Ai,get util(){return Le},get objectUtil(){return Jd},ZodParsedType:te,getParsedType:Tr,ZodType:Oe,datetimeRegex:B_,ZodString:Bn,ZodNumber:Hr,ZodBigInt:qr,ZodBoolean:Ci,ZodDate:ys,ZodSymbol:Fu,ZodUndefined:Oi,ZodNull:vi,ZodAny:oa,ZodUnknown:ds,ZodNever:vr,ZodVoid:Uu,ZodArray:Un,ZodObject:rt,ZodUnion:Ii,ZodDiscriminatedUnion:Dc,ZodIntersection:Ni,ZodTuple:fr,ZodRecord:ki,ZodMap:ju,ZodSet:Es,ZodFunction:ta,ZodLazy:Ri,ZodLiteral:Pi,ZodEnum:Vr,ZodNativeEnum:xi,ZodPromise:ua,ZodEffects:qn,ZodTransformer:qn,ZodOptional:jn,ZodNullable:zr,ZodDefault:Li,ZodCatch:Di,ZodNaN:$u,BRAND:FC,ZodBranded:ff,ZodPipeline:ao,ZodReadonly:Mi,custom:U_,Schema:Oe,ZodSchema:Oe,late:UC,get ZodFirstPartyTypeKind(){return H},coerce:EO,any:GC,array:JC,bigint:HC,boolean:H_,date:qC,discriminatedUnion:tO,effect:Np,enum:lO,function:oO,instanceof:jC,intersection:nO,lazy:uO,literal:cO,map:aO,nan:$C,nativeEnum:dO,never:YC,null:WC,nullable:mO,number:$_,object:XC,oboolean:yO,onumber:_O,optional:fO,ostring:bO,pipeline:gO,preprocess:pO,promise:hO,record:sO,set:iO,strictObject:QC,string:j_,symbol:VC,transformer:Np,tuple:rO,undefined:zC,union:eO,unknown:KC,void:ZC,NEVER:wO,ZodIssueCode:J,quotelessJson:mC,ZodError:hn}),Mc={exports:{}},q_={};function On(t,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var TO=On;On.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};On.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};On.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=new Date().getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},n),this._options.unref&&this._timer.unref(),!0};On.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};On.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)};On.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)};On.prototype.start=On.prototype.try;On.prototype.errors=function(){return this._errors};On.prototype.attempts=function(){return this._attempts};On.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},e=null,n=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,i=(t[a]||0)+1;t[a]=i,i>=n&&(e=s,n=i)}return e};(function(t){var e=TO;t.operation=function(n){var r=t.timeouts(n);return new e(r,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})},t.timeouts=function(n){if(n instanceof Array)return[].concat(n);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in n)r[s]=n[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],i=0;i<r.retries;i++)a.push(this.createTimeout(i,r));return n&&n.forever&&!a.length&&a.push(this.createTimeout(i,r)),a.sort(function(o,u){return o-u}),a},t.createTimeout=function(n,r){var s=r.randomize?Math.random()+1:1,a=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,n));return a=Math.min(a,r.maxTimeout),a},t.wrap=function(n,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var a in n)typeof n[a]=="function"&&s.push(a)}for(var i=0;i<s.length;i++){var o=s[i],u=n[o];n[o]=(function(l){var d=t.operation(r),p=Array.prototype.slice.call(arguments,1),m=p.pop();p.push(function(f){d.retry(f)||(f&&(arguments[0]=d.mainError()),m.apply(this,arguments))}),d.attempt(function(){l.apply(n,p)})}).bind(n,u),n[o].options=r}}})(q_);var SO=q_;const AO=SO,CO=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class V_ extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const OO=(t,e,n)=>{const r=n.retries-(e-1);return t.attemptNumber=e,t.retriesLeft=r,t},vO=t=>CO.includes(t),z_=(t,e)=>new Promise((n,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const s=AO.operation(e);s.attempt(async a=>{try{n(await t(a))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof V_)s.stop(),r(i.originalError);else if(i instanceof TypeError&&!vO(i.message))s.stop(),r(i);else{OO(i,a,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}s.retry(i)||r(s.mainError())}}})});Mc.exports=z_;Mc.exports.default=z_;Mc.exports.AbortError=V_;var IO=Mc.exports;const Hu=to(IO),NO=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function ui(t){return typeof t=="string"&&NO.test(t)}var It=[];for(var Fl=0;Fl<256;++Fl)It.push((Fl+256).toString(16).slice(1));function kO(t,e=0){return(It[t[e+0]]+It[t[e+1]]+It[t[e+2]]+It[t[e+3]]+"-"+It[t[e+4]]+It[t[e+5]]+"-"+It[t[e+6]]+It[t[e+7]]+"-"+It[t[e+8]]+It[t[e+9]]+"-"+It[t[e+10]]+It[t[e+11]]+It[t[e+12]]+It[t[e+13]]+It[t[e+14]]+It[t[e+15]]).toLowerCase()}var $o,RO=new Uint8Array(16);function PO(){if(!$o&&($o=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!$o))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $o(RO)}var xO=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const kp={randomUUID:xO};function Zt(t,e,n){if(kp.randomUUID&&!t)return kp.randomUUID();t=t||{};var r=t.random||(t.rng||PO)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,kO(r)}var W_={},G_={exports:{}};(function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function s(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function a(u,c,l,d,p){if(typeof l!="function")throw new TypeError("The listener must be a function");var m=new s(l,d||u,p),f=n?n+c:c;return u._events[f]?u._events[f].fn?u._events[f]=[u._events[f],m]:u._events[f].push(m):(u._events[f]=m,u._eventsCount++),u}function i(u,c){--u._eventsCount===0?u._events=new r:delete u._events[c]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,d;if(this._eventsCount===0)return c;for(d in l=this._events)e.call(l,d)&&c.push(n?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=n?n+c:c,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var p=0,m=d.length,f=new Array(m);p<m;p++)f[p]=d[p].fn;return f},o.prototype.listenerCount=function(c){var l=n?n+c:c,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,l,d,p,m,f){var g=n?n+c:c;if(!this._events[g])return!1;var b=this._events[g],_=arguments.length,E,T;if(b.fn){switch(b.once&&this.removeListener(c,b.fn,void 0,!0),_){case 1:return b.fn.call(b.context),!0;case 2:return b.fn.call(b.context,l),!0;case 3:return b.fn.call(b.context,l,d),!0;case 4:return b.fn.call(b.context,l,d,p),!0;case 5:return b.fn.call(b.context,l,d,p,m),!0;case 6:return b.fn.call(b.context,l,d,p,m,f),!0}for(T=1,E=new Array(_-1);T<_;T++)E[T-1]=arguments[T];b.fn.apply(b.context,E)}else{var N=b.length,v;for(T=0;T<N;T++)switch(b[T].once&&this.removeListener(c,b[T].fn,void 0,!0),_){case 1:b[T].fn.call(b[T].context);break;case 2:b[T].fn.call(b[T].context,l);break;case 3:b[T].fn.call(b[T].context,l,d);break;case 4:b[T].fn.call(b[T].context,l,d,p);break;default:if(!E)for(v=1,E=new Array(_-1);v<_;v++)E[v-1]=arguments[v];b[T].fn.apply(b[T].context,E)}}return!0},o.prototype.on=function(c,l,d){return a(this,c,l,d,!1)},o.prototype.once=function(c,l,d){return a(this,c,l,d,!0)},o.prototype.removeListener=function(c,l,d,p){var m=n?n+c:c;if(!this._events[m])return this;if(!l)return i(this,m),this;var f=this._events[m];if(f.fn)f.fn===l&&(!p||f.once)&&(!d||f.context===d)&&i(this,m);else{for(var g=0,b=[],_=f.length;g<_;g++)(f[g].fn!==l||p&&!f[g].once||d&&f[g].context!==d)&&b.push(f[g]);b.length?this._events[m]=b.length===1?b[0]:b:i(this,m)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=n?n+c:c,this._events[l]&&i(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,t.exports=o})(G_);var LO=G_.exports,Bc={exports:{}},DO=(t,e)=>(e=e||(()=>{}),t.then(n=>new Promise(r=>{r(e())}).then(()=>n),n=>new Promise(r=>{r(e())}).then(()=>{throw n})));const MO=DO;class K_ extends Error{constructor(e){super(e),this.name="TimeoutError"}}const Y_=(t,e,n)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(t);return}const a=setTimeout(()=>{if(typeof n=="function"){try{r(n())}catch(u){s(u)}return}const i=typeof n=="string"?n:`Promise timed out after ${e} milliseconds`,o=n instanceof Error?n:new K_(i);typeof t.cancel=="function"&&t.cancel(),s(o)},e);MO(t.then(r,s),()=>{clearTimeout(a)})});Bc.exports=Y_;Bc.exports.default=Y_;Bc.exports.TimeoutError=K_;var BO=Bc.exports,mf={},pf={};Object.defineProperty(pf,"__esModule",{value:!0});function FO(t,e,n){let r=0,s=t.length;for(;s>0;){const a=s/2|0;let i=r+a;n(t[i],e)<=0?(r=++i,s-=a+1):s=a}return r}pf.default=FO;Object.defineProperty(mf,"__esModule",{value:!0});const UO=pf;class jO{constructor(){this._queue=[]}enqueue(e,n){n=Object.assign({priority:0},n);const r={priority:n.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=n.priority){this._queue.push(r);return}const s=UO.default(this._queue,r,(a,i)=>i.priority-a.priority);this._queue.splice(s,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(n=>n.priority===e.priority).map(n=>n.run)}get size(){return this._queue.length}}mf.default=jO;Object.defineProperty(W_,"__esModule",{value:!0});const $O=LO,Z_=BO,HO=mf,Ho=()=>{},qO=new Z_.TimeoutError;class VO extends $O{constructor(e){var n,r,s,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Ho,this._resolveIdle=Ho,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:HO.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(n=e.intervalCap)===null||n===void 0?void 0:n.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Ho,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Ho,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const n=this._intervalEnd-e;if(n<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},n)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const n=this._queue.dequeue();return n?(this.emit("active"),n(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,n={}){return new Promise((r,s)=>{const a=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&n.timeout===void 0?e():Z_.default(Promise.resolve(e()),n.timeout===void 0?this._timeout:n.timeout,()=>{(n.throwOnTimeout===void 0?this._throwOnTimeout:n.throwOnTimeout)&&s(qO)});r(await i)}catch(i){s(i)}this._next()};this._queue.enqueue(a,n),this._tryToStartAnother(),this.emit("add")})}async addAll(e,n){return Promise.all(e.map(async r=>this.add(r,n)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const n=this._resolveEmpty;this._resolveEmpty=()=>{n(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const n=this._resolveIdle;this._resolveIdle=()=>{n(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var Cr=W_.default=VO;const zO=(...t)=>fetch(...t),WO=Symbol.for("ls:fetch_implementation"),ae=()=>globalThis[WO]??zO,GO=[400,401,403,404,405,406,407,408],KO=[409];let Rp=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Cr?this.queue=new Cr.default({concurrency:this.maxConcurrency}):this.queue=new Cr({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...n){const r=this.onFailedResponseHook;return this.queue.add(()=>Hu(()=>e(...n).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const a=s==null?void 0:s.response,i=a==null?void 0:a.status;if(i){if(GO.includes(+i))throw s;if(KO.includes(+i))return;r&&await r(a)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,n,...r){return e.signal?Promise.race([this.call(n,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(n,...r)}fetch(...e){return this.call(()=>ae()(...e).then(n=>n.ok?n:Promise.reject(n)))}};function Pp(t){return typeof(t==null?void 0:t._getType)=="function"}function xp(t){const e={type:t._getType(),data:{content:t.content}};return t!=null&&t.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}function we(t,e){if(!ui(t)){const n=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(n)}return t}const Lp={};function J_(t){Lp[t]||(console.warn(t),Lp[t]=!0)}var th={exports:{}};const YO="2.0.0",X_=256,ZO=Number.MAX_SAFE_INTEGER||9007199254740991,JO=16,XO=X_-6,QO=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var Fc={MAX_LENGTH:X_,MAX_SAFE_COMPONENT_LENGTH:JO,MAX_SAFE_BUILD_LENGTH:XO,MAX_SAFE_INTEGER:ZO,RELEASE_TYPES:QO,SEMVER_SPEC_VERSION:YO,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2};const ev=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{};var Uc=ev;(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=Fc,a=Uc;e=t.exports={};const i=e.re=[],o=e.safeRe=[],u=e.src=[],c=e.t={};let l=0;const d="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",s],[d,r]],m=g=>{for(const[b,_]of p)g=g.split(`${b}*`).join(`${b}{0,${_}}`).split(`${b}+`).join(`${b}{1,${_}}`);return g},f=(g,b,_)=>{const E=m(b),T=l++;a(g,T,b),c[g]=T,u[T]=b,i[T]=new RegExp(b,_?"g":void 0),o[T]=new RegExp(E,_?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),f("MAINVERSION",`(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${u[c.NUMERICIDENTIFIER]}|${u[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${u[c.NUMERICIDENTIFIERLOOSE]}|${u[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASE",`(?:-(${u[c.PRERELEASEIDENTIFIER]}(?:\\.${u[c.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${u[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[c.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${d}+`),f("BUILD",`(?:\\+(${u[c.BUILDIDENTIFIER]}(?:\\.${u[c.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${u[c.MAINVERSION]}${u[c.PRERELEASE]}?${u[c.BUILD]}?`),f("FULL",`^${u[c.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${u[c.MAINVERSIONLOOSE]}${u[c.PRERELEASELOOSE]}?${u[c.BUILD]}?`),f("LOOSE",`^${u[c.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${u[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${u[c.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:${u[c.PRERELEASE]})?${u[c.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:${u[c.PRERELEASELOOSE]})?${u[c.BUILD]}?)?)?`),f("XRANGE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),f("COERCE",`${u[c.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",u[c.COERCEPLAIN]+`(?:${u[c.PRERELEASE]})?(?:${u[c.BUILD]})?(?:$|[^\\d])`),f("COERCERTL",u[c.COERCE],!0),f("COERCERTLFULL",u[c.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${u[c.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",f("TILDE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${u[c.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",f("CARET",`^${u[c.LONECARET]}${u[c.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${u[c.LONECARET]}${u[c.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${u[c.GTLT]}\\s*(${u[c.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]}|${u[c.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${u[c.XRANGEPLAIN]})\\s+-\\s+(${u[c.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${u[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[c.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(th,th.exports);var io=th.exports;const tv=Object.freeze({loose:!0}),nv=Object.freeze({}),rv=t=>t?typeof t!="object"?tv:t:nv;var gf=rv;const Dp=/^[0-9]+$/,Q_=(t,e)=>{const n=Dp.test(t),r=Dp.test(e);return n&&r&&(t=+t,e=+e),t===e?0:n&&!r?-1:r&&!n?1:t<e?-1:1},sv=(t,e)=>Q_(e,t);var ey={compareIdentifiers:Q_,rcompareIdentifiers:sv};const qo=Uc,{MAX_LENGTH:Mp,MAX_SAFE_INTEGER:Vo}=Fc,{safeRe:zo,t:Wo}=io,av=gf,{compareIdentifiers:Ls}=ey;let iv=class tr{constructor(e,n){if(n=av(n),e instanceof tr){if(e.loose===!!n.loose&&e.includePrerelease===!!n.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Mp)throw new TypeError(`version is longer than ${Mp} characters`);qo("SemVer",e,n),this.options=n,this.loose=!!n.loose,this.includePrerelease=!!n.includePrerelease;const r=e.trim().match(n.loose?zo[Wo.LOOSE]:zo[Wo.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Vo||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Vo||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Vo||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(s=>{if(/^[0-9]+$/.test(s)){const a=+s;if(a>=0&&a<Vo)return a}return s}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(qo("SemVer.compare",this.version,this.options,e),!(e instanceof tr)){if(typeof e=="string"&&e===this.version)return 0;e=new tr(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof tr||(e=new tr(e,this.options)),Ls(this.major,e.major)||Ls(this.minor,e.minor)||Ls(this.patch,e.patch)}comparePre(e){if(e instanceof tr||(e=new tr(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let n=0;do{const r=this.prerelease[n],s=e.prerelease[n];if(qo("prerelease compare",n,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return Ls(r,s)}while(++n)}compareBuild(e){e instanceof tr||(e=new tr(e,this.options));let n=0;do{const r=this.build[n],s=e.build[n];if(qo("build compare",n,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return Ls(r,s)}while(++n)}inc(e,n,r){if(e.startsWith("pre")){if(!n&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(n){const s=`-${n}`.match(this.options.loose?zo[Wo.PRERELEASELOOSE]:zo[Wo.PRERELEASE]);if(!s||s[1]!==n)throw new Error(`invalid identifier: ${n}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",n,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",n,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",n,r),this.inc("pre",n,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",n,r),this.inc("pre",n,r);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const s=Number(r)?1:0;if(this.prerelease.length===0)this.prerelease=[s];else{let a=this.prerelease.length;for(;--a>=0;)typeof this.prerelease[a]=="number"&&(this.prerelease[a]++,a=-2);if(a===-1){if(n===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(s)}}if(n){let a=[n,s];r===!1&&(a=[n]),Ls(this.prerelease[0],n)===0?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var Ht=iv;const Bp=Ht,ov=(t,e,n=!1)=>{if(t instanceof Bp)return t;try{return new Bp(t,e)}catch(r){if(!n)return null;throw r}};var Ea=ov;const uv=Ea,cv=(t,e)=>{const n=uv(t,e);return n?n.version:null};var lv=cv;const dv=Ea,hv=(t,e)=>{const n=dv(t.trim().replace(/^[=v]+/,""),e);return n?n.version:null};var fv=hv;const Fp=Ht,mv=(t,e,n,r,s)=>{typeof n=="string"&&(s=r,r=n,n=void 0);try{return new Fp(t instanceof Fp?t.version:t,n).inc(e,r,s).version}catch{return null}};var pv=mv;const Up=Ea,gv=(t,e)=>{const n=Up(t,null,!0),r=Up(e,null,!0),s=n.compare(r);if(s===0)return null;const a=s>0,i=a?n:r,o=a?r:n,u=!!i.prerelease.length;if(!!o.prerelease.length&&!u){if(!o.patch&&!o.minor)return"major";if(o.compareMain(i)===0)return o.minor&&!o.patch?"minor":"patch"}const l=u?"pre":"";return n.major!==r.major?l+"major":n.minor!==r.minor?l+"minor":n.patch!==r.patch?l+"patch":"prerelease"};var bv=gv;const _v=Ht,yv=(t,e)=>new _v(t,e).major;var Ev=yv;const wv=Ht,Tv=(t,e)=>new wv(t,e).minor;var Sv=Tv;const Av=Ht,Cv=(t,e)=>new Av(t,e).patch;var Ov=Cv;const vv=Ea,Iv=(t,e)=>{const n=vv(t,e);return n&&n.prerelease.length?n.prerelease:null};var Nv=Iv;const jp=Ht,kv=(t,e,n)=>new jp(t,n).compare(new jp(e,n));var Wn=kv;const Rv=Wn,Pv=(t,e,n)=>Rv(e,t,n);var xv=Pv;const Lv=Wn,Dv=(t,e)=>Lv(t,e,!0);var Mv=Dv;const $p=Ht,Bv=(t,e,n)=>{const r=new $p(t,n),s=new $p(e,n);return r.compare(s)||r.compareBuild(s)};var bf=Bv;const Fv=bf,Uv=(t,e)=>t.sort((n,r)=>Fv(n,r,e));var jv=Uv;const $v=bf,Hv=(t,e)=>t.sort((n,r)=>$v(r,n,e));var qv=Hv;const Vv=Wn,zv=(t,e,n)=>Vv(t,e,n)>0;var jc=zv;const Wv=Wn,Gv=(t,e,n)=>Wv(t,e,n)<0;var _f=Gv;const Kv=Wn,Yv=(t,e,n)=>Kv(t,e,n)===0;var ty=Yv;const Zv=Wn,Jv=(t,e,n)=>Zv(t,e,n)!==0;var ny=Jv;const Xv=Wn,Qv=(t,e,n)=>Xv(t,e,n)>=0;var yf=Qv;const eI=Wn,tI=(t,e,n)=>eI(t,e,n)<=0;var Ef=tI;const nI=ty,rI=ny,sI=jc,aI=yf,iI=_f,oI=Ef,uI=(t,e,n,r)=>{switch(e){case"===":return typeof t=="object"&&(t=t.version),typeof n=="object"&&(n=n.version),t===n;case"!==":return typeof t=="object"&&(t=t.version),typeof n=="object"&&(n=n.version),t!==n;case"":case"=":case"==":return nI(t,n,r);case"!=":return rI(t,n,r);case">":return sI(t,n,r);case">=":return aI(t,n,r);case"<":return iI(t,n,r);case"<=":return oI(t,n,r);default:throw new TypeError(`Invalid operator: ${e}`)}};var ry=uI;const cI=Ht,lI=Ea,{safeRe:Go,t:Ko}=io,dI=(t,e)=>{if(t instanceof cI)return t;if(typeof t=="number"&&(t=String(t)),typeof t!="string")return null;e=e||{};let n=null;if(!e.rtl)n=t.match(e.includePrerelease?Go[Ko.COERCEFULL]:Go[Ko.COERCE]);else{const u=e.includePrerelease?Go[Ko.COERCERTLFULL]:Go[Ko.COERCERTL];let c;for(;(c=u.exec(t))&&(!n||n.index+n[0].length!==t.length);)(!n||c.index+c[0].length!==n.index+n[0].length)&&(n=c),u.lastIndex=c.index+c[1].length+c[2].length;u.lastIndex=-1}if(n===null)return null;const r=n[2],s=n[3]||"0",a=n[4]||"0",i=e.includePrerelease&&n[5]?`-${n[5]}`:"",o=e.includePrerelease&&n[6]?`+${n[6]}`:"";return lI(`${r}.${s}.${a}${i}${o}`,e)};var hI=dI;class fI{constructor(){this.max=1e3,this.map=new Map}get(e){const n=this.map.get(e);if(n!==void 0)return this.map.delete(e),this.map.set(e,n),n}delete(e){return this.map.delete(e)}set(e,n){if(!this.delete(e)&&n!==void 0){if(this.map.size>=this.max){const s=this.map.keys().next().value;this.delete(s)}this.map.set(e,n)}return this}}var mI=fI,Ul,Hp;function Gn(){if(Hp)return Ul;Hp=1;const t=/\s+/g;class e{constructor(I,B){if(B=s(B),I instanceof e)return I.loose===!!B.loose&&I.includePrerelease===!!B.includePrerelease?I:new e(I.raw,B);if(I instanceof a)return this.raw=I.value,this.set=[[I]],this.formatted=void 0,this;if(this.options=B,this.loose=!!B.loose,this.includePrerelease=!!B.includePrerelease,this.raw=I.trim().replace(t," "),this.set=this.raw.split("||").map(q=>this.parseRange(q.trim())).filter(q=>q.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const q=this.set[0];if(this.set=this.set.filter(M=>!g(M[0])),this.set.length===0)this.set=[q];else if(this.set.length>1){for(const M of this.set)if(M.length===1&&b(M[0])){this.set=[M];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let I=0;I<this.set.length;I++){I>0&&(this.formatted+="||");const B=this.set[I];for(let q=0;q<B.length;q++)q>0&&(this.formatted+=" "),this.formatted+=B[q].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(I){const q=((this.options.includePrerelease&&m)|(this.options.loose&&f))+":"+I,M=r.get(q);if(M)return M;const V=this.options.loose,X=V?u[c.HYPHENRANGELOOSE]:u[c.HYPHENRANGE];I=I.replace(X,K(this.options.includePrerelease)),i("hyphen replace",I),I=I.replace(u[c.COMPARATORTRIM],l),i("comparator trim",I),I=I.replace(u[c.TILDETRIM],d),i("tilde trim",I),I=I.replace(u[c.CARETTRIM],p),i("caret trim",I);let z=I.split(" ").map(Se=>E(Se,this.options)).join(" ").split(/\s+/).map(Se=>Q(Se,this.options));V&&(z=z.filter(Se=>(i("loose invalid filter",Se,this.options),!!Se.match(u[c.COMPARATORLOOSE])))),i("range list",z);const ne=new Map,me=z.map(Se=>new a(Se,this.options));for(const Se of me){if(g(Se))return[Se];ne.set(Se.value,Se)}ne.size>1&&ne.has("")&&ne.delete("");const ke=[...ne.values()];return r.set(q,ke),ke}intersects(I,B){if(!(I instanceof e))throw new TypeError("a Range is required");return this.set.some(q=>_(q,B)&&I.set.some(M=>_(M,B)&&q.every(V=>M.every(X=>V.intersects(X,B)))))}test(I){if(!I)return!1;if(typeof I=="string")try{I=new o(I,this.options)}catch{return!1}for(let B=0;B<this.set.length;B++)if(oe(this.set[B],I,this.options))return!0;return!1}}Ul=e;const n=mI,r=new n,s=gf,a=$c(),i=Uc,o=Ht,{safeRe:u,t:c,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:p}=io,{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:f}=Fc,g=L=>L.value==="<0.0.0-0",b=L=>L.value==="",_=(L,I)=>{let B=!0;const q=L.slice();let M=q.pop();for(;B&&q.length;)B=q.every(V=>M.intersects(V,I)),M=q.pop();return B},E=(L,I)=>(i("comp",L,I),L=A(L,I),i("caret",L),L=N(L,I),i("tildes",L),L=x(L,I),i("xrange",L),L=U(L,I),i("stars",L),L),T=L=>!L||L.toLowerCase()==="x"||L==="*",N=(L,I)=>L.trim().split(/\s+/).map(B=>v(B,I)).join(" "),v=(L,I)=>{const B=I.loose?u[c.TILDELOOSE]:u[c.TILDE];return L.replace(B,(q,M,V,X,z)=>{i("tilde",L,q,M,V,X,z);let ne;return T(M)?ne="":T(V)?ne=`>=${M}.0.0 <${+M+1}.0.0-0`:T(X)?ne=`>=${M}.${V}.0 <${M}.${+V+1}.0-0`:z?(i("replaceTilde pr",z),ne=`>=${M}.${V}.${X}-${z} <${M}.${+V+1}.0-0`):ne=`>=${M}.${V}.${X} <${M}.${+V+1}.0-0`,i("tilde return",ne),ne})},A=(L,I)=>L.trim().split(/\s+/).map(B=>O(B,I)).join(" "),O=(L,I)=>{i("caret",L,I);const B=I.loose?u[c.CARETLOOSE]:u[c.CARET],q=I.includePrerelease?"-0":"";return L.replace(B,(M,V,X,z,ne)=>{i("caret",L,M,V,X,z,ne);let me;return T(V)?me="":T(X)?me=`>=${V}.0.0${q} <${+V+1}.0.0-0`:T(z)?V==="0"?me=`>=${V}.${X}.0${q} <${V}.${+X+1}.0-0`:me=`>=${V}.${X}.0${q} <${+V+1}.0.0-0`:ne?(i("replaceCaret pr",ne),V==="0"?X==="0"?me=`>=${V}.${X}.${z}-${ne} <${V}.${X}.${+z+1}-0`:me=`>=${V}.${X}.${z}-${ne} <${V}.${+X+1}.0-0`:me=`>=${V}.${X}.${z}-${ne} <${+V+1}.0.0-0`):(i("no pr"),V==="0"?X==="0"?me=`>=${V}.${X}.${z}${q} <${V}.${X}.${+z+1}-0`:me=`>=${V}.${X}.${z}${q} <${V}.${+X+1}.0-0`:me=`>=${V}.${X}.${z} <${+V+1}.0.0-0`),i("caret return",me),me})},x=(L,I)=>(i("replaceXRanges",L,I),L.split(/\s+/).map(B=>D(B,I)).join(" ")),D=(L,I)=>{L=L.trim();const B=I.loose?u[c.XRANGELOOSE]:u[c.XRANGE];return L.replace(B,(q,M,V,X,z,ne)=>{i("xRange",L,q,M,V,X,z,ne);const me=T(V),ke=me||T(X),Se=ke||T(z),yt=Se;return M==="="&&yt&&(M=""),ne=I.includePrerelease?"-0":"",me?M===">"||M==="<"?q="<0.0.0-0":q="*":M&&yt?(ke&&(X=0),z=0,M===">"?(M=">=",ke?(V=+V+1,X=0,z=0):(X=+X+1,z=0)):M==="<="&&(M="<",ke?V=+V+1:X=+X+1),M==="<"&&(ne="-0"),q=`${M+V}.${X}.${z}${ne}`):ke?q=`>=${V}.0.0${ne} <${+V+1}.0.0-0`:Se&&(q=`>=${V}.${X}.0${ne} <${V}.${+X+1}.0-0`),i("xRange return",q),q})},U=(L,I)=>(i("replaceStars",L,I),L.trim().replace(u[c.STAR],"")),Q=(L,I)=>(i("replaceGTE0",L,I),L.trim().replace(u[I.includePrerelease?c.GTE0PRE:c.GTE0],"")),K=L=>(I,B,q,M,V,X,z,ne,me,ke,Se,yt)=>(T(q)?B="":T(M)?B=`>=${q}.0.0${L?"-0":""}`:T(V)?B=`>=${q}.${M}.0${L?"-0":""}`:X?B=`>=${B}`:B=`>=${B}${L?"-0":""}`,T(me)?ne="":T(ke)?ne=`<${+me+1}.0.0-0`:T(Se)?ne=`<${me}.${+ke+1}.0-0`:yt?ne=`<=${me}.${ke}.${Se}-${yt}`:L?ne=`<${me}.${ke}.${+Se+1}-0`:ne=`<=${ne}`,`${B} ${ne}`.trim()),oe=(L,I,B)=>{for(let q=0;q<L.length;q++)if(!L[q].test(I))return!1;if(I.prerelease.length&&!B.includePrerelease){for(let q=0;q<L.length;q++)if(i(L[q].semver),L[q].semver!==a.ANY&&L[q].semver.prerelease.length>0){const M=L[q].semver;if(M.major===I.major&&M.minor===I.minor&&M.patch===I.patch)return!0}return!1}return!0};return Ul}var jl,qp;function $c(){if(qp)return jl;qp=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(l,d){if(d=n(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),i("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===t?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(l){const d=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],p=l.match(d);if(!p)throw new TypeError(`Invalid comparator: ${l}`);this.operator=p[1]!==void 0?p[1]:"",this.operator==="="&&(this.operator=""),p[2]?this.semver=new o(p[2],this.options.loose):this.semver=t}toString(){return this.value}test(l){if(i("Comparator.test",l,this.options.loose),this.semver===t||l===t)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return a(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new u(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new u(this.value,d).test(l.semver):(d=n(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||a(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||a(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}jl=e;const n=gf,{safeRe:r,t:s}=io,a=ry,i=Uc,o=Ht,u=Gn();return jl}const pI=Gn(),gI=(t,e,n)=>{try{e=new pI(e,n)}catch{return!1}return e.test(t)};var Hc=gI;const bI=Gn(),_I=(t,e)=>new bI(t,e).set.map(n=>n.map(r=>r.value).join(" ").trim().split(" "));var yI=_I;const EI=Ht,wI=Gn(),TI=(t,e,n)=>{let r=null,s=null,a=null;try{a=new wI(e,n)}catch{return null}return t.forEach(i=>{a.test(i)&&(!r||s.compare(i)===-1)&&(r=i,s=new EI(r,n))}),r};var SI=TI;const AI=Ht,CI=Gn(),OI=(t,e,n)=>{let r=null,s=null,a=null;try{a=new CI(e,n)}catch{return null}return t.forEach(i=>{a.test(i)&&(!r||s.compare(i)===1)&&(r=i,s=new AI(r,n))}),r};var vI=OI;const $l=Ht,II=Gn(),Vp=jc,NI=(t,e)=>{t=new II(t,e);let n=new $l("0.0.0");if(t.test(n)||(n=new $l("0.0.0-0"),t.test(n)))return n;n=null;for(let r=0;r<t.set.length;++r){const s=t.set[r];let a=null;s.forEach(i=>{const o=new $l(i.semver.version);switch(i.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!a||Vp(o,a))&&(a=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${i.operator}`)}}),a&&(!n||Vp(n,a))&&(n=a)}return n&&t.test(n)?n:null};var kI=NI;const RI=Gn(),PI=(t,e)=>{try{return new RI(t,e).range||"*"}catch{return null}};var xI=PI;const LI=Ht,sy=$c(),{ANY:DI}=sy,MI=Gn(),BI=Hc,zp=jc,Wp=_f,FI=Ef,UI=yf,jI=(t,e,n,r)=>{t=new LI(t,r),e=new MI(e,r);let s,a,i,o,u;switch(n){case">":s=zp,a=FI,i=Wp,o=">",u=">=";break;case"<":s=Wp,a=UI,i=zp,o="<",u="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(BI(t,e,r))return!1;for(let c=0;c<e.set.length;++c){const l=e.set[c];let d=null,p=null;if(l.forEach(m=>{m.semver===DI&&(m=new sy(">=0.0.0")),d=d||m,p=p||m,s(m.semver,d.semver,r)?d=m:i(m.semver,p.semver,r)&&(p=m)}),d.operator===o||d.operator===u||(!p.operator||p.operator===o)&&a(t,p.semver))return!1;if(p.operator===u&&i(t,p.semver))return!1}return!0};var wf=jI;const $I=wf,HI=(t,e,n)=>$I(t,e,">",n);var qI=HI;const VI=wf,zI=(t,e,n)=>VI(t,e,"<",n);var WI=zI;const Gp=Gn(),GI=(t,e,n)=>(t=new Gp(t,n),e=new Gp(e,n),t.intersects(e,n));var KI=GI;const YI=Hc,ZI=Wn;var JI=(t,e,n)=>{const r=[];let s=null,a=null;const i=t.sort((l,d)=>ZI(l,d,n));for(const l of i)YI(l,e,n)?(a=l,s||(s=l)):(a&&r.push([s,a]),a=null,s=null);s&&r.push([s,null]);const o=[];for(const[l,d]of r)l===d?o.push(l):!d&&l===i[0]?o.push("*"):d?l===i[0]?o.push(`<=${d}`):o.push(`${l} - ${d}`):o.push(`>=${l}`);const u=o.join(" || "),c=typeof e.raw=="string"?e.raw:String(e);return u.length<c.length?u:e};const Kp=Gn(),Tf=$c(),{ANY:Hl}=Tf,$a=Hc,Sf=Wn,XI=(t,e,n={})=>{if(t===e)return!0;t=new Kp(t,n),e=new Kp(e,n);let r=!1;e:for(const s of t.set){for(const a of e.set){const i=eN(s,a,n);if(r=r||i!==null,i)continue e}if(r)return!1}return!0},QI=[new Tf(">=0.0.0-0")],Yp=[new Tf(">=0.0.0")],eN=(t,e,n)=>{if(t===e)return!0;if(t.length===1&&t[0].semver===Hl){if(e.length===1&&e[0].semver===Hl)return!0;n.includePrerelease?t=QI:t=Yp}if(e.length===1&&e[0].semver===Hl){if(n.includePrerelease)return!0;e=Yp}const r=new Set;let s,a;for(const m of t)m.operator===">"||m.operator===">="?s=Zp(s,m,n):m.operator==="<"||m.operator==="<="?a=Jp(a,m,n):r.add(m.semver);if(r.size>1)return null;let i;if(s&&a){if(i=Sf(s.semver,a.semver,n),i>0)return null;if(i===0&&(s.operator!==">="||a.operator!=="<="))return null}for(const m of r){if(s&&!$a(m,String(s),n)||a&&!$a(m,String(a),n))return null;for(const f of e)if(!$a(m,String(f),n))return!1;return!0}let o,u,c,l,d=a&&!n.includePrerelease&&a.semver.prerelease.length?a.semver:!1,p=s&&!n.includePrerelease&&s.semver.prerelease.length?s.semver:!1;d&&d.prerelease.length===1&&a.operator==="<"&&d.prerelease[0]===0&&(d=!1);for(const m of e){if(l=l||m.operator===">"||m.operator===">=",c=c||m.operator==="<"||m.operator==="<=",s){if(p&&m.semver.prerelease&&m.semver.prerelease.length&&m.semver.major===p.major&&m.semver.minor===p.minor&&m.semver.patch===p.patch&&(p=!1),m.operator===">"||m.operator===">="){if(o=Zp(s,m,n),o===m&&o!==s)return!1}else if(s.operator===">="&&!$a(s.semver,String(m),n))return!1}if(a){if(d&&m.semver.prerelease&&m.semver.prerelease.length&&m.semver.major===d.major&&m.semver.minor===d.minor&&m.semver.patch===d.patch&&(d=!1),m.operator==="<"||m.operator==="<="){if(u=Jp(a,m,n),u===m&&u!==a)return!1}else if(a.operator==="<="&&!$a(a.semver,String(m),n))return!1}if(!m.operator&&(a||s)&&i!==0)return!1}return!(s&&c&&!a&&i!==0||a&&l&&!s&&i!==0||p||d)},Zp=(t,e,n)=>{if(!t)return e;const r=Sf(t.semver,e.semver,n);return r>0?t:r<0||e.operator===">"&&t.operator===">="?e:t},Jp=(t,e,n)=>{if(!t)return e;const r=Sf(t.semver,e.semver,n);return r<0?t:r>0||e.operator==="<"&&t.operator==="<="?e:t};var tN=XI;const ql=io,Xp=Fc,nN=Ht,Qp=ey,rN=Ea,sN=lv,aN=fv,iN=pv,oN=bv,uN=Ev,cN=Sv,lN=Ov,dN=Nv,hN=Wn,fN=xv,mN=Mv,pN=bf,gN=jv,bN=qv,_N=jc,yN=_f,EN=ty,wN=ny,TN=yf,SN=Ef,AN=ry,CN=hI,ON=$c(),vN=Gn(),IN=Hc,NN=yI,kN=SI,RN=vI,PN=kI,xN=xI,LN=wf,DN=qI,MN=WI,BN=KI,FN=JI,UN=tN;ql.re,ql.src,ql.t,Xp.SEMVER_SPEC_VERSION,Xp.RELEASE_TYPES,Qp.compareIdentifiers,Qp.rcompareIdentifiers;function Pr(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,n]=t.split(":"),r=n||"latest";if(e.includes("/")){const[s,a]=e.split("/",2);if(!s||!a)throw new Error(`Invalid identifier format: ${t}`);return[s,a,r]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,r]}}class jN extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function be(t,e,n){let r;if(t.ok){n&&(r=await t.text());return}r=await t.text();const s=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Server response: ${r}`;throw t.status===409?new jN(s):new Error(s)}var eg="[...]",$N={result:"[Circular]"},qu=[],Ks=[];function HN(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function sn(t,e,n,r){var i;try{return JSON.stringify(t,e,n)}catch(o){if(!((i=o.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r>"u"&&(r=HN()),nh(t,"",0,[],void 0,0,r);var s;try{Ks.length===0?s=JSON.stringify(t,e,n):s=JSON.stringify(t,qN(e),n)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;qu.length!==0;){var a=qu.pop();a.length===4?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return s}}function Vl(t,e,n,r){var s=Object.getOwnPropertyDescriptor(r,n);s.get!==void 0?s.configurable?(Object.defineProperty(r,n,{value:t}),qu.push([r,n,e,s])):Ks.push([e,n,t]):(r[n]=t,qu.push([r,n,e]))}function nh(t,e,n,r,s,a,i){a+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<r.length;o++)if(r[o]===t){Vl($N,t,e,s);return}if(typeof i.depthLimit<"u"&&a>i.depthLimit){Vl(eg,t,e,s);return}if(typeof i.edgesLimit<"u"&&n+1>i.edgesLimit){Vl(eg,t,e,s);return}if(r.push(t),Array.isArray(t))for(o=0;o<t.length;o++)nh(t[o],o,o,r,t,a,i);else{var u=Object.keys(t);for(o=0;o<u.length;o++){var c=u[o];nh(t[c],c,o,r,t,a,i)}}r.pop()}}function qN(t){return t=typeof t<"u"?t:function(e,n){return n},function(e,n){if(Ks.length>0)for(var r=0;r<Ks.length;r++){var s=Ks[r];if(s[1]===e&&s[0]===n){n=s[2],Ks.splice(r,1);break}}return t.call(this,e,n)}}function tg(t){const e=oy(),n=nk(),r=t.extra??{},s=r.metadata;return t.extra={...r,runtime:{...e,...r==null?void 0:r.runtime},metadata:{...n,...n.revision_id||t.revision_id?{revision_id:t.revision_id??n.revision_id}:{},...s}},t}const VN=()=>{const t=Fr("TRACING_SAMPLING_RATE");if(t===void 0)return;const e=parseFloat(t);if(e<0||e>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},zN=t=>{const n=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return n==="localhost"||n==="127.0.0.1"||n==="::1"};async function WN(t){const e=[];for await(const n of t)e.push(n);return e}function zl(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const GN=async t=>{if((t==null?void 0:t.status)===429){const e=parseInt(t.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(n=>setTimeout(n,e)),!0}return!1};class KN{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let n;const r=new Promise(a=>{n=a}),s=sn(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:n,itemPromise:r,size:s}),this.sizeBytes+=s,r}pop(e){var s;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let r=0;for(;r+(((s=this.peek())==null?void 0:s.size)??0)<e&&this.items.length>0;){const a=this.items.shift();a&&(n.push(a),r+=a.size,this.sizeBytes-=a.size)}if(n.length===0&&this.items.length>0){const a=this.items.shift();n.push(a),r+=a.size,this.sizeBytes-=a.size}return[n.map(a=>({action:a.action,item:a.payload})),()=>n.forEach(a=>a.itemPromiseResolve())]}}const YN=20971520,ZN=2500;class Bi{constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new KN}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:hs("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});const n=Bi.getDefaultClientConfig();if(this.tracingSampleRate=VN(),this.apiUrl=zl(e.apiUrl??n.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=zl(e.apiKey??n.apiKey),this.webUrl=zl(e.webUrl??n.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Rp(e.callerOptions??{}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new Rp({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:GN}),this.hideInputs=e.hideInputs??e.anonymizer??n.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??n.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=Fr("API_KEY"),n=Fr("ENDPOINT")??"https://api.smith.langchain.com",r=Fr("HIDE_INPUTS")==="true",s=Fr("HIDE_OUTPUTS")==="true";return{apiUrl:n,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:zN(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${ay}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const n={...e};return n.inputs!==void 0&&(n.inputs=this.processInputs(n.inputs)),n.outputs!==void 0&&(n.outputs=this.processOutputs(n.outputs)),n}async _getResponse(e,n){const r=(n==null?void 0:n.toString())??"",s=`${this.apiUrl}${e}?${r}`,a=await this.caller.call(ae(),s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(a,`Failed to fetch ${e}`),a}async _get(e,n){return(await this._getResponse(e,n)).json()}async*_getPaginated(e,n=new URLSearchParams,r){let s=Number(n.get("offset"))||0;const a=Number(n.get("limit"))||100;for(;;){n.set("offset",String(s)),n.set("limit",String(a));const i=`${this.apiUrl}${e}?${n}`,o=await this.caller.call(ae(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(o,`Failed to fetch ${e}`);const u=r?r(await o.json()):await o.json();if(u.length===0||(yield u,u.length<a))break;s+=u.length}}async*_getCursorPaginatedList(e,n=null,r="POST",s="runs"){const a=n?{...n}:{};for(;;){const o=await(await this.caller.call(ae(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)})).json();if(!o||!o[s])break;yield o[s];const u=o.cursors;if(!u||!u.next)break;a.cursor=u.next}}_filterForSampling(e,n=!1){if(this.tracingSampleRate===void 0)return e;if(n){const r=[];for(const s of e)this.filteredPostUuids.has(s.id)?this.filteredPostUuids.delete(s.id):r.push(s);return r}else{const r=[];for(const s of e)s.id!==s.trace_id&&!this.filteredPostUuids.has(s.trace_id)||Math.random()<this.tracingSampleRate?r.push(s):this.filteredPostUuids.add(s.id);return r}}async _getBatchSizeLimitBytes(){var n;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((n=e.batch_ingest_config)==null?void 0:n.size_limit_bytes)??YN}async _getMultiPartSupport(){var n;return((n=(await this._ensureServerInfo()).instance_flags)==null?void 0:n.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue(e){const n=[];for(;this.autoBatchQueue.items.length>0;){const[r,s]=this.autoBatchQueue.pop(e);if(!r.length){s();break}const a=this._processBatch(r,s).catch(console.error);n.push(a)}return Promise.all(n)}async _processBatch(e,n){var r;if(!e.length){n();return}try{const s={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)},a=await this._ensureServerInfo();(r=a==null?void 0:a.batch_ingest_config)!=null&&r.use_multipart_endpoint?await this.multipartIngestRuns(s):await this.batchIngestRuns(s)}finally{n()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=tg(e.item));const n=this.autoBatchQueue.push(e);if(this.manualFlushMode)return n;const r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),n}async _getServerInfo(){const e=await ae()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(ZN),...this.fetchOptions});return await be(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch{console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const s=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){this.processRunOperation({action:"create",item:s}).catch(console.error);return}const a=tg(s),i=await this.caller.call(ae(),`${this.apiUrl}/runs`,{method:"POST",headers:n,body:sn(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:n}){if(e===void 0&&n===void 0)return;let r=(e==null?void 0:e.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[],s=(n==null?void 0:n.map(o=>this.prepareRunCreateOrUpdateInputs(o)))??[];if(r.length>0&&s.length>0){const o=r.reduce((c,l)=>(l.id&&(c[l.id]=l),c),{}),u=[];for(const c of s)c.id!==void 0&&o[c.id]?o[c.id]={...o[c.id],...c}:u.push(c);r=Object.values(o),s=u}const a={post:this._filterForSampling(r),patch:this._filterForSampling(s,!0)};if(!a.post.length&&!a.patch.length)return;const i={post:[],patch:[]};for(const o of["post","patch"]){const u=o,c=a[u].reverse();let l=c.pop();for(;l!==void 0;)i[u].push(l),l=c.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(sn(i))}async _postBatchIngestRuns(e){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(ae(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:n,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:n}){if(e===void 0&&n===void 0)return;const r={};let s=[];for(const l of e??[]){const d=this.prepareRunCreateOrUpdateInputs(l);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,s.push(d)}let a=[];for(const l of n??[])a.push(this.prepareRunCreateOrUpdateInputs(l));if(s.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(s.length>0&&a.length>0){const l=s.reduce((p,m)=>(m.id&&(p[m.id]=m),p),{}),d=[];for(const p of a)p.id!==void 0&&l[p.id]?l[p.id]={...l[p.id],...p}:d.push(p);s=Object.values(l),a=d}if(s.length===0&&a.length===0)return;const u=[],c=[];for(const[l,d]of[["post",s],["patch",a]])for(const p of d){const{inputs:m,outputs:f,events:g,attachments:b,..._}=p,E={inputs:m,outputs:f,events:g},T=sn(_);c.push({name:`${l}.${_.id}`,payload:new Blob([T],{type:`application/json; length=${T.length}`})});for(const[N,v]of Object.entries(E)){if(v===void 0)continue;const A=sn(v);c.push({name:`${l}.${_.id}.${N}`,payload:new Blob([A],{type:`application/json; length=${A.length}`})})}if(_.id!==void 0){const N=r[_.id];if(N){delete r[_.id];for(const[v,A]of Object.entries(N)){let O,x;if(Array.isArray(A)?[O,x]=A:(O=A.mimeType,x=A.data),v.includes(".")){console.warn(`Skipping attachment '${v}' for run ${_.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}c.push({name:`attachment.${_.id}.${v}`,payload:new Blob([x],{type:`${O}; length=${x.byteLength}`})})}}}u.push(`trace=${_.trace_id},id=${_.id}`)}await this._sendMultipartRequest(c,u.join("; "))}async _sendMultipartRequest(e,n){try{const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),s=[];for(const u of e)s.push(new Blob([`--${r}\r
`])),s.push(new Blob([`Content-Disposition: form-data; name="${u.name}"\r
`,`Content-Type: ${u.payload.type}\r
\r
`])),s.push(u.payload),s.push(new Blob([`\r
`]));s.push(new Blob([`--${r}--\r
`]));const i=await new Blob(s).arrayBuffer(),o=await this.batchIngestCaller.call(ae(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(o,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${n}`)}}async updateRun(e,n){we(e),n.inputs&&(n.inputs=this.processInputs(n.inputs)),n.outputs&&(n.outputs=this.processOutputs(n.outputs));const r={...n,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(n.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const s={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(ae(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,body:sn(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(a,"update run",!0)}async readRun(e,{loadChildRuns:n}={loadChildRuns:!1}){we(e);let r=await this._get(`/runs/${e}`);return n&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:n,projectOpts:r}){if(n!==void 0){let s;n.session_id?s=n.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:Fr("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${s}/r/${n.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const n=await WN(this.listRuns({id:e.child_run_ids})),r={},s={};n.sort((a,i)=>((a==null?void 0:a.dotted_order)??"").localeCompare((i==null?void 0:i.dotted_order)??""));for(const a of n){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),s[a.id]=a}e.child_runs=r[e.id]||[];for(const a in r)a!==e.id&&(s[a].child_runs=r[a]);return e}async*listRuns(e){const{projectId:n,projectName:r,parentRunId:s,traceId:a,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:c,runType:l,error:d,id:p,query:m,filter:f,traceFilter:g,treeFilter:b,limit:_,select:E}=e;let T=[];if(n&&(T=Array.isArray(n)?n:[n]),r){const O=Array.isArray(r)?r:[r],x=await Promise.all(O.map(D=>this.readProject({projectName:D}).then(U=>U.id)));T.push(...x)}const N=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],v={session:T.length?T:null,run_type:l,reference_example:i,query:m,filter:f,trace_filter:g,tree_filter:b,execution_order:u,parent_run:s,start_time:o?o.toISOString():null,error:d,id:p,limit:_,trace:a,select:E||N,is_root:c};let A=0;for await(const O of this._getCursorPaginatedList("/runs/query",v))if(_){if(A>=_)break;if(O.length+A>_){yield*O.slice(0,_-A);break}A+=O.length,yield*O}else yield*O}async getRunStats({id:e,trace:n,parentRun:r,runType:s,projectNames:a,projectIds:i,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:d,filter:p,traceFilter:m,treeFilter:f,isRoot:g,dataSourceType:b}){let _=i||[];a&&(_=[...i||[],...await Promise.all(a.map(A=>this.readProject({projectName:A}).then(O=>O.id)))]);const T=Object.fromEntries(Object.entries({id:e,trace:n,parent_run:r,run_type:s,session:_,reference_example:o,start_time:u,end_time:c,error:l,query:d,filter:p,trace_filter:m,tree_filter:f,is_root:g,data_source_type:b}).filter(([A,O])=>O!==void 0));return await(await this.caller.call(ae(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(T),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:n}={}){const r={run_id:e,share_token:n||Zt()};we(e);const a=await(await this.caller.call(ae(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){we(e);const n=await this.caller.call(ae(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(n,"unshare run",!0)}async readRunSharedLink(e){we(e);const r=await(await this.caller.call(ae(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:n}={}){const r=new URLSearchParams({share_token:e});if(n!==void 0)for(const i of n)r.append("id",i);return we(e),await(await this.caller.call(ae(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id),we(e);const s=await(await this.caller.call(ae(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id);const r={dataset_id:e};we(e);const a=await(await this.caller.call(ae(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){we(e);const n=await this.caller.call(ae(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(n,"unshare dataset",!0)}async readSharedDataset(e){return we(e),await(await this.caller.call(ae(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,n){const r={};n!=null&&n.exampleIds&&(r.id=n.exampleIds);const s=new URLSearchParams;Object.entries(r).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>s.append(o,c)):s.append(o,u)});const a=await this.caller.call(ae(),`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();if(!a.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:n=null,metadata:r=null,upsert:s=!1,projectExtra:a=null,referenceDatasetId:i=null}){const o=s?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=a||{};r&&(c.metadata=r);const l={name:e,extra:c,description:n};i!==null&&(l.reference_dataset_id=i);const d=await this.caller.call(ae(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(d,"create project"),await d.json()}async updateProject(e,{name:n=null,description:r=null,metadata:s=null,projectExtra:a=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=a;s&&(u={...u||{},metadata:s});const c={name:n,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(ae(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:n}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)we(e),r+=`/${e}`;else if(n!==void 0)s.append("name",n);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(ae(),`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const i=await a.json();return a.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:n,includeStats:r}){let s="/sessions";const a=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)we(e),s+=`/${e}`;else if(n!==void 0)a.append("name",n);else throw new Error("Must provide projectName or projectId");r!==void 0&&a.append("include_stats",r.toString());const i=await this._get(s,a);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${n}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const n of this._getPaginated("/sessions",e))return this._tenantId=n[0].tenant_id,n[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:n,nameContains:r,referenceDatasetId:s,referenceDatasetName:a,referenceFree:i,metadata:o}={}){const u=new URLSearchParams;if(e!==void 0)for(const c of e)u.append("id",c);if(n!==void 0&&u.append("name",n),r!==void 0&&u.append("name_contains",r),s!==void 0)u.append("reference_dataset",s);else if(a!==void 0){const c=await this.readDataset({datasetName:a});u.append("reference_dataset",c.id)}i!==void 0&&u.append("reference_free",i.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(const c of this._getPaginated("/sessions",u))yield*c}async deleteProject({projectId:e,projectName:n}){let r;if(e===void 0&&n===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:n})).id:r=e,we(r);const s=await this.caller.call(ae(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(s,`delete session ${r} (${n})`,!0)}async uploadCsv({csvFile:e,fileName:n,inputKeys:r,outputKeys:s,description:a,dataType:i,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,n),r.forEach(p=>{c.append("input_keys",p)}),s.forEach(p=>{c.append("output_keys",p)}),a&&c.append("description",a),i&&c.append("data_type",i),o&&c.append("name",o);const l=await this.caller.call(ae(),u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(l,"upload CSV"),await l.json()}async createDataset(e,{description:n,dataType:r,inputsSchema:s,outputsSchema:a,metadata:i}={}){const o={name:e,description:n,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),s&&(o.inputs_schema_definition=s),a&&(o.outputs_schema_definition=a);const u=await this.caller.call(ae(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:n}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)we(e),r+=`/${e}`;else if(n!==void 0)s.append("name",n);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(r,s);let i;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${n}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:n}){try{return await this.readDataset({datasetId:e,datasetName:n}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:n,fromVersion:r,toVersion:s}){let a=e;if(a===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:n})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:n}){const r="/datasets";if(e===void 0)if(n!==void 0)e=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:n=0,datasetIds:r,datasetName:s,datasetNameContains:a,metadata:i}={}){const o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:n.toString()});if(r!==void 0)for(const c of r)u.append("id",c);s!==void 0&&u.append("name",s),a!==void 0&&u.append("name_contains",a),i!==void 0&&u.append("metadata",JSON.stringify(i));for await(const c of this._getPaginated(o,u))yield*c}async updateDataset(e){const{datasetId:n,datasetName:r,...s}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const a=n??(await this.readDataset({datasetName:r})).id;we(a);const i=await this.caller.call(ae(),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(i,"update dataset"),await i.json()}async updateDatasetTag(e){const{datasetId:n,datasetName:r,asOf:s,tag:a}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const i=n??(await this.readDataset({datasetName:r})).id;we(i);const o=await this.caller.call(ae(),`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(o,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:n}){let r="/datasets",s=e;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(n!==void 0&&(s=(await this.readDataset({datasetName:n})).id),s!==void 0)we(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");const a=await this.caller.call(ae(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(a,`delete ${r}`),await a.json()}async indexDataset({datasetId:e,datasetName:n,tag:r}){let s=e;if(!s&&!n)throw new Error("Must provide either datasetName or datasetId");if(s&&n)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:n})).id),we(s);const a={tag:r},i=await this.caller.call(ae(),`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(i,"index dataset"),await i.json()}async similarExamples(e,n,r,{filter:s}={}){const a={limit:r,inputs:e};s!==void 0&&(a.filter=s),we(n);const i=await this.caller.call(ae(),`${this.apiUrl}/datasets/${n}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,n,{datasetId:r,datasetName:s,createdAt:a,exampleId:i,metadata:o,split:u,sourceRunId:c}){let l=r;if(l===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:s})).id);const d=a||new Date,p={dataset_id:l,inputs:e,outputs:n,created_at:d==null?void 0:d.toISOString(),id:i,metadata:o,split:u,source_run_id:c},m=await this.caller.call(ae(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(m,"create example"),await m.json()}async createExamples(e){const{inputs:n,outputs:r,metadata:s,sourceRunIds:a,exampleIds:i,datasetId:o,datasetName:u}=e;let c=o;if(c===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(c!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");c===void 0&&(c=(await this.readDataset({datasetName:u})).id);const l=n.map((m,f)=>({dataset_id:c,inputs:m,outputs:r?r[f]:void 0,metadata:s?s[f]:void 0,split:e.splits?e.splits[f]:void 0,id:i?i[f]:void 0,source_run_id:a?a[f]:void 0})),d=await this.caller.call(ae(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(d,"create examples"),await d.json()}async createLLMExample(e,n,r){return this.createExample({input:e},{output:n},r)}async createChatExample(e,n,r){const s=e.map(i=>Pp(i)?xp(i):i),a=Pp(n)?xp(n):n;return this.createExample({input:s},{output:a},r)}async readExample(e){we(e);const n=`/examples/${e}`,r=await this._get(n),{attachment_urls:s,...a}=r,i=a;return s&&(i.attachments=Object.entries(s).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url,mime_type:c.mime_type},o),{})),i}async*listExamples({datasetId:e,datasetName:n,exampleIds:r,asOf:s,splits:a,inlineS3Urls:i,metadata:o,limit:u,offset:c,filter:l,includeAttachments:d}={}){let p;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)p=e;else if(n!==void 0)p=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide a datasetName or datasetId");const m=new URLSearchParams({dataset:p}),f=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;f&&m.append("as_of",f);const g=i??!0;if(m.append("inline_s3_urls",g.toString()),r!==void 0)for(const _ of r)m.append("id",_);if(a!==void 0)for(const _ of a)m.append("splits",_);if(o!==void 0){const _=JSON.stringify(o);m.append("metadata",_)}u!==void 0&&m.append("limit",u.toString()),c!==void 0&&m.append("offset",c.toString()),l!==void 0&&m.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(_=>m.append("select",_));let b=0;for await(const _ of this._getPaginated("/examples",m)){for(const E of _){const{attachment_urls:T,...N}=E,v=N;T&&(v.attachments=Object.entries(T).reduce((A,[O,x])=>(A[O.slice(11)]={presigned_url:x.presigned_url,mime_type:x.mime_type||void 0},A),{})),yield v,b++}if(u!==void 0&&b>=u)break}}async deleteExample(e){we(e);const n=`/examples/${e}`,r=await this.caller.call(ae(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(r,`delete ${n}`),await r.json()}async updateExample(e,n){we(e);const r=await this.caller.call(ae(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(r,"update example"),await r.json()}async updateExamples(e){const n=await this.caller.call(ae(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(n,"update examples"),await n.json()}async readDatasetVersion({datasetId:e,datasetName:n,asOf:r,tag:s}){let a;if(e?a=e:a=(await this.readDataset({datasetName:n})).id,we(a),r&&s||!r&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;r!==void 0&&i.append("as_of",typeof r=="string"?r:r.toISOString()),s!==void 0&&i.append("tag",s);const o=await this.caller.call(ae(),`${this.apiUrl}/datasets/${a}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(o,"read dataset version"),await o.json()}async listDatasetSplits({datasetId:e,datasetName:n,asOf:r}){let s;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:n})).id:s=e,we(s);const a=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&a.append("as_of",i),await this._get(`/datasets/${s}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:n,splitName:r,exampleIds:s,remove:a=!1}){let i;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:n})).id:i=e,we(i);const o={split_name:r,examples:s.map(c=>(we(c),c)),remove:a},u=await this.caller.call(ae(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(u,"update dataset splits",!0)}async evaluateRun(e,n,{sourceInfo:r,loadChildRuns:s,referenceExample:a}={loadChildRuns:!1}){J_("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));const o=await n.evaluateRun(i,a),[u,c]=await this._logEvaluationFeedback(o,i,r);return c[0]}async createFeedback(e,n,{score:r,value:s,correction:a,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d,projectId:p,comparativeExperimentId:m}){var E;if(!e&&!p)throw new Error("One of runId or projectId must be provided");if(e&&p)throw new Error("Only one of runId or projectId can be provided");const f={type:u??"api",metadata:o??{}};c!==void 0&&(f==null?void 0:f.metadata)!==void 0&&!f.metadata.__run&&(f.metadata.__run={run_id:c}),(f==null?void 0:f.metadata)!==void 0&&((E=f.metadata.__run)==null?void 0:E.run_id)!==void 0&&we(f.metadata.__run.run_id);const g={id:l??Zt(),run_id:e,key:n,score:r,value:s,correction:a,comment:i,feedback_source:f,comparative_experiment_id:m,feedbackConfig:d,session_id:p},b=`${this.apiUrl}/feedback`,_=await this.caller.call(ae(),b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(g),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(_,"create feedback",!0),g}async updateFeedback(e,{score:n,value:r,correction:s,comment:a}){const i={};n!=null&&(i.score=n),r!=null&&(i.value=r),s!=null&&(i.correction=s),a!=null&&(i.comment=a),we(e);const o=await this.caller.call(ae(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(o,"update feedback",!0)}async readFeedback(e){we(e);const n=`/feedback/${e}`;return await this._get(n)}async deleteFeedback(e){we(e);const n=`/feedback/${e}`,r=await this.caller.call(ae(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(r,`delete ${n}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:n,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e&&s.append("run",e.join(",")),n)for(const a of n)s.append("key",a);if(r)for(const a of r)s.append("source",a);for await(const a of this._getPaginated("/feedback",s))yield*a}async createPresignedFeedbackToken(e,n,{expiration:r,feedbackConfig:s}={}){const a={run_id:e,feedback_key:n,feedback_config:s};return r?typeof r=="string"?a.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(a.expires_in=r):a.expires_in={hours:3},await(await this.caller.call(ae(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:n,referenceDatasetId:r,createdAt:s,description:a,metadata:i,id:o}){var l;if(n.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:n[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const u={id:o,name:e,experiment_ids:n,reference_dataset_id:r,description:a,created_at:(l=s??new Date)==null?void 0:l.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(ae(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){we(e);const n=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",n))yield*r}_selectEvalResults(e){let n;return"results"in e?n=e.results:n=[e],n}async _logEvaluationFeedback(e,n,r){const s=this._selectEvalResults(e),a=[];for(const i of s){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:n&&(u=n.id),a.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[s,a]}async logEvaluationFeedback(e,n,r){const[s]=await this._logEvaluationFeedback(e,n,r);return s}async*listAnnotationQueues(e={}){const{queueIds:n,name:r,nameContains:s,limit:a}=e,i=new URLSearchParams;n&&n.forEach((u,c)=>{we(u,`queueIds[${c}]`),i.append("ids",u)}),r&&i.append("name",r),s&&i.append("name_contains",s),i.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(const u of this._getPaginated("/annotation-queues",i))if(yield*u,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(e){const{name:n,description:r,queueId:s}=e,a={name:n,description:r,id:s||Zt()},i=await this.caller.call(ae(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(a).filter(([u,c])=>c!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){const n=await this.listAnnotationQueues({queueIds:[e]}).next();if(n.done)throw new Error(`Annotation queue with ID ${e} not found`);return n.value}async updateAnnotationQueue(e,n){const{name:r,description:s}=n,a=await this.caller.call(ae(),`${this.apiUrl}/annotation-queues/${we(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:s}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(a,"update annotation queue")}async deleteAnnotationQueue(e){const n=await this.caller.call(ae(),`${this.apiUrl}/annotation-queues/${we(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(n,"delete annotation queue")}async addRunsToAnnotationQueue(e,n){const r=await this.caller.call(ae(),`${this.apiUrl}/annotation-queues/${we(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n.map((s,a)=>we(s,`runIds[${a}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,n){const r=`/annotation-queues/${we(e,"queueId")}/run`,s=await this.caller.call(ae(),`${this.apiUrl}${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(s,"get run from annotation queue"),await s.json()}async deleteRunFromAnnotationQueue(e,n){const r=await this.caller.call(ae(),`${this.apiUrl}/annotation-queues/${we(e,"queueId")}/runs/${we(n,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(r,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const n=await this.caller.call(ae(),`${this.apiUrl}/annotation-queues/${we(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(n,"get size from annotation queue"),await n.json()}async _currentTenantIsOwner(e){const n=await this._getSettings();return e=="-"||n.tenant_handle===e}async _ownerConflictError(e,n){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${n}`)}async _getLatestCommitHash(e){const n=await this.caller.call(ae(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();if(!n.ok){const s=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),a=new Error(`Error ${n.status}: ${n.statusText}
${s}`);throw a.statusCode=n.status,a}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,n){const[r,s,a]=Pr(e),i=await this.caller.call(ae(),`${this.apiUrl}/likes/${r}/${s}`,{method:"POST",body:JSON.stringify({like:n}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(i,`${n?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){const[n,r,s]=Pr(e);if(await this._currentTenantIsOwner(n)){const a=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${r}/${s.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${a.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${n}/${r}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${n}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const n of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*n}async*listPrompts(e){const n=new URLSearchParams;n.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),n.append("sort_direction","desc"),n.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&n.append("is_public",e.isPublic.toString()),e!=null&&e.query&&n.append("query",e.query);for await(const r of this._getPaginated("/repos",n,s=>s.repos))yield*r}async getPrompt(e){const[n,r,s]=Pr(e),a=await this.caller.call(ae(),`${this.apiUrl}/repos/${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(a.status===404)return null;await be(a,"get prompt");const i=await a.json();return i.repo?i.repo:null}async createPrompt(e,n){const r=await this._getSettings();if(n!=null&&n.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,a,i]=Pr(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:a,...(n==null?void 0:n.description)&&{description:n.description},...(n==null?void 0:n.readme)&&{readme:n.readme},...(n==null?void 0:n.tags)&&{tags:n.tags},is_public:!!(n!=null&&n.isPublic)},u=await this.caller.call(ae(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(u,"create prompt");const{repo:c}=await u.json();return c}async createCommit(e,n,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,a,i]=Pr(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${s}/${a}`):r==null?void 0:r.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(n)),parent_commit:o},c=await this.caller.call(ae(),`${this.apiUrl}/commits/${s}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(c,"create commit");const l=await c.json();return this._getPromptUrl(`${s}/${a}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,n=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of n){const o=i.id,u={...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=sn(u),l=new Blob([c],{type:"application/json"});if(r.append(o,l),i.inputs){const d=sn(i.inputs),p=new Blob([d],{type:"application/json"});r.append(`${o}.inputs`,p)}if(i.outputs){const d=sn(i.outputs),p=new Blob([d],{type:"application/json"});r.append(`${o}.outputs`,p)}if(i.attachments)for(const[d,p]of Object.entries(i.attachments)){let m,f;Array.isArray(p)?[m,f]=p:(m=p.mimeType,f=p.data);const g=new Blob([f],{type:`${m}; length=${f.byteLength}`});r.append(`${o}.attachment.${d}`,g)}if(i.attachments_operations){const d=sn(i.attachments_operations),p=new Blob([d],{type:"application/json"});r.append(`${o}.attachments_operations`,p)}}return await(await this.caller.call(ae(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,n=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of n){const o=(i.id??Zt()).toString(),u={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=sn(u),l=new Blob([c],{type:"application/json"});r.append(o,l);const d=sn(i.inputs),p=new Blob([d],{type:"application/json"});if(r.append(`${o}.inputs`,p),i.outputs){const m=sn(i.outputs),f=new Blob([m],{type:"application/json"});r.append(`${o}.outputs`,f)}if(i.attachments)for(const[m,f]of Object.entries(i.attachments)){let g,b;Array.isArray(f)?[g,b]=f:(g=f.mimeType,b=f.data);const _=new Blob([b],{type:`${g}; length=${b.byteLength}`});r.append(`${o}.attachment.${m}`,_)}}return await(await this.caller.call(ae(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r})).json()}async updatePrompt(e,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s]=Pr(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if((n==null?void 0:n.description)!==void 0&&(a.description=n.description),(n==null?void 0:n.readme)!==void 0&&(a.readme=n.readme),(n==null?void 0:n.tags)!==void 0&&(a.tags=n.tags),(n==null?void 0:n.isPublic)!==void 0&&(a.is_public=n.isPublic),(n==null?void 0:n.isArchived)!==void 0&&(a.is_archived=n.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const i=await this.caller.call(ae(),`${this.apiUrl}/repos/${r}/${s}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await be(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r,s]=Pr(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("delete a prompt",n);return await(await this.caller.call(ae(),`${this.apiUrl}/repos/${n}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,n){const[r,s,a]=Pr(e),i=await this.caller.call(ae(),`${this.apiUrl}/commits/${r}/${s}/${a}${n!=null&&n.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await be(i,"pull prompt commit");const o=await i.json();return{owner:r,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,n){const r=await this.pullPromptCommit(e,{includeModel:n==null?void 0:n.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,n){return await this.promptExists(e)?n&&Object.keys(n).some(s=>s!=="object")&&await this.updatePrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}):await this.createPrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}),n!=null&&n.object?await this.createCommit(e,n==null?void 0:n.object,{parentCommitHash:n==null?void 0:n.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,n={}){const{sourceApiUrl:r=this.apiUrl,datasetName:s}=n,[a,i]=this.parseTokenOrUrl(e,r),o=new Bi({apiUrl:a,apiKey:"placeholder"}),u=await o.readSharedDataset(i),c=s||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(i),d=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(p=>p.inputs),outputs:l.flatMap(p=>p.outputs?[p.outputs]:[]),datasetId:d.id})}catch(p){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),p}}parseTokenOrUrl(e,n,r=2,s="dataset"){try{return we(e),[n,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){const o=i[i.length-r];return[n,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}}const ay="0.3.3";let gr;const JN=()=>typeof window<"u"&&typeof window.document<"u",XN=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",QN=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),iy=()=>typeof Deno<"u",ek=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!iy(),tk=()=>gr||(JN()?gr="browser":ek()?gr="node":XN()?gr="webworker":QN()?gr="jsdom":iy()?gr="deno":gr="other",gr);let Wl;function oy(){if(Wl===void 0){const t=tk(),e=sk();Wl={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:ay,...e}}return Wl}function nk(){const t=rk()||{},e={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(t))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof s=="string"&&!n.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function rk(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((t,[e,n])=>(t[e]=String(n),t),{}):void 0}catch{return}}function hs(t){var e;try{return typeof process<"u"?(e=process.env)==null?void 0:e[t]:void 0}catch{return}}function Fr(t){return hs(`LANGSMITH_${t}`)||hs(`LANGCHAIN_${t}`)}let Gl;function sk(){if(Gl!==void 0)return Gl;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const n of t){const r=hs(n);r!==void 0&&(e[n]=r)}return Gl=e,e}const ak=t=>!!["TRACING_V2","TRACING"].find(n=>Fr(n)==="true"),Kl=Symbol.for("lc:context_variables");function ik(t){return t.replace(/[-:.]/g,"")}function ok(t,e,n=1){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return ik(`${new Date(t).toISOString().slice(0,-1)}${r}Z`)+e}class Vu{constructor(e,n){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=n}static fromHeader(e){const n=e.split(",");let r={},s=[];for(const a of n){const[i,o]=a.split("="),u=decodeURIComponent(o);i==="langsmith-metadata"?r=JSON.parse(u):i==="langsmith-tags"&&(s=u.split(","))}return new Vu(r,s)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class on{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),uy(e)){Object.assign(this,{...e});return}const n=on.getDefaultConfig(),{metadata:r,...s}=e,a=s.client??on.getSharedClient(),i={...r,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:i},Object.assign(this,{...n,...s,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const u=ok(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+u:this.dotted_order=u}}static getDefaultConfig(){return{id:Zt(),run_type:"chain",project_name:Fr("PROJECT")??hs("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:hs("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:hs("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return on.sharedClient||(on.sharedClient=new Bi),on.sharedClient}createChild(e){var u,c,l,d,p,m;const n=this.child_execution_order+1,r=new on({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:n,child_execution_order:n});Kl in this&&(r[Kl]=this[Kl]);const s=Symbol.for("lc:child_config"),a=((u=e.extra)==null?void 0:u[s])??this.extra[s];if(ck(a)){const f={...a},g=uk(f.callbacks)?(l=(c=f.callbacks).copy)==null?void 0:l.call(c):void 0;g&&(Object.assign(g,{_parentRunId:r.id}),(m=(p=(d=g.handlers)==null?void 0:d.find(cy))==null?void 0:p.updateFromRunTree)==null||m.call(p,r),f.callbacks=g),r.extra[s]=f}const i=new Set;let o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,n),o=o.parent_run;return this.child_runs.push(r),r}async end(e,n,r=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??n,this.end_time=this.end_time??r,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,n,r=!0){var u;const s=e.extra??{};if(s.runtime||(s.runtime={}),n)for(const[c,l]of Object.entries(n))s.runtime[c]||(s.runtime[c]=l);let a,i;return r?(i=(u=e.parent_run)==null?void 0:u.id,a=[]):(a=e.child_runs.map(c=>this._convertToCreate(c,n,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const n=oy(),r=await this._convertToCreate(this,n,!0);if(await this.client.createRun(r),!e){J_("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const s of this.child_runs)await s.postRun(!1)}}catch(n){console.error(`Error in postRun for run ${this.id}:`,n)}}async patchRun(){var e;try{const n={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:(e=this.parent_run)==null?void 0:e.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,n)}catch(n){console.error(`Error in patchRun for run ${this.id}`,n)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,n){var c,l,d,p;const r=e==null?void 0:e.callbacks;let s,a,i,o=ak();if(r){const m=((c=r==null?void 0:r.getParentRunId)==null?void 0:c.call(r))??"",f=(l=r==null?void 0:r.handlers)==null?void 0:l.find(g=>(g==null?void 0:g.name)=="langchain_tracer");s=(d=f==null?void 0:f.getRun)==null?void 0:d.call(f,m),a=f==null?void 0:f.projectName,i=f==null?void 0:f.client,o=o||!!f}return s?new on({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:i,tracingEnabled:o,project_name:a,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(p=s==null?void 0:s.extra)==null?void 0:p.metadata,...e==null?void 0:e.metadata}}}).createChild(n):new on({...n,client:i,tracingEnabled:o,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,n){var c;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=r["langsmith-trace"];if(!s||typeof s!="string")return;const a=s.trim(),i=a.split(".").map(l=>{const[d,p]=l.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:p}}),o=i[0].uuid,u={...n,name:(n==null?void 0:n.name)??"parent",run_type:(n==null?void 0:n.run_type)??"chain",start_time:(n==null?void 0:n.start_time)??Date.now(),id:(c=i.at(-1))==null?void 0:c.uuid,trace_id:o,dotted_order:a};if(r.baggage&&typeof r.baggage=="string"){const l=Vu.fromHeader(r.baggage);u.metadata=l.metadata,u.tags=l.tags}return new on(u)}toHeaders(e){var r;const n={"langsmith-trace":this.dotted_order,baggage:new Vu((r=this.extra)==null?void 0:r.metadata,this.tags).toHeader()};if(e)for(const[s,a]of Object.entries(n))e.set(s,a);return n}}Object.defineProperty(on,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function uy(t){return t!==void 0&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function cy(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function ng(t){return Array.isArray(t)&&t.some(e=>cy(e))}function uk(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function ck(t){var e;return t!==void 0&&typeof t.callbacks=="object"&&(ng((e=t.callbacks)==null?void 0:e.handlers)||ng(t.callbacks))}let lk=class{getStore(){}run(e,n){return n()}};const Yl=Symbol.for("ls:tracing_async_local_storage"),dk=new lk;let hk=class{getInstance(){return globalThis[Yl]??dk}initializeGlobalInstance(e){globalThis[Yl]===void 0&&(globalThis[Yl]=e)}};const fk=new hk,mk=()=>{const t=fk.getInstance().getStore();if(!uy(t))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function and that tracing is enabled."].join(`
`));return t};function Af(t){return typeof t=="function"&&"langsmith:traceable"in t}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const pk=Object.prototype.hasOwnProperty;function rh(t,e){return pk.call(t,e)}function sh(t){if(Array.isArray(t)){const n=new Array(t.length);for(let r=0;r<n.length;r++)n[r]=""+r;return n}if(Object.keys)return Object.keys(t);let e=[];for(let n in t)rh(t,n)&&e.push(n);return e}function ur(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function ah(t){let e=0;const n=t.length;let r;for(;e<n;){if(r=t.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Ds(t){return t.indexOf("/")===-1&&t.indexOf("~")===-1?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}function gk(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function ih(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let n=0,r=t.length;n<r;n++)if(ih(t[n]))return!0}else if(typeof t=="object"){const n=sh(t),r=n.length;for(var e=0;e<r;e++)if(ih(t[n[e]]))return!0}}return!1}function rg(t,e){const n=[t];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&n.push(`${r}: ${s}`)}return n.join(`
`)}class bk extends Error{constructor(e,n,r,s,a){super(rg(e,{name:n,index:r,operation:s,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=rg(e,{name:n,index:r,operation:s,tree:a})}}const ot=bk,Ys={add:function(t,e,n){return t[e]=this.value,{newDocument:n}},remove:function(t,e,n){var r=t[e];return delete t[e],{newDocument:n,removed:r}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:function(t,e,n){let r=oh(n,this.path);r&&(r=ur(r));const s=ci(n,{op:"remove",path:this.from}).removed;return ci(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(t,e,n){const r=oh(n,this.from);return ci(n,{op:"add",path:this.path,value:ur(r)}),{newDocument:n}},test:function(t,e,n){return{newDocument:n,test:Wu(t[e],this.value)}},_get:function(t,e,n){return this.value=t[e],{newDocument:n}}};var _k={add:function(t,e,n){return ah(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:n,index:e}},remove:function(t,e,n){var r=t.splice(e,1);return{newDocument:n,removed:r[0]}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:Ys.move,copy:Ys.copy,test:Ys.test,_get:Ys._get};function oh(t,e){if(e=="")return t;var n={op:"_get",path:e};return ci(t,n),n.value}function ci(t,e,n=!1,r=!0,s=!0,a=0){if(n&&(typeof n=="function"?n(e,0,t,e.path):uh(e,0)),e.path===""){let i={newDocument:t};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=t,i;if(e.op==="move"||e.op==="copy")return i.newDocument=oh(t,e.from),e.op==="move"&&(i.removed=t),i;if(e.op==="test"){if(i.test=Wu(t,e.value),i.test===!1)throw new ot("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return i.newDocument=t,i}else{if(e.op==="remove")return i.removed=t,i.newDocument=null,i;if(e.op==="_get")return e.value=t,i;if(n)throw new ot("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,t);return i}}else{r||(t=ur(t));const o=(e.path||"").split("/");let u=t,c=1,l=o.length,d,p,m;for(typeof n=="function"?m=n:m=uh;;){if(p=o[c],p&&p.indexOf("~")!=-1&&(p=gk(p)),s&&(p=="__proto__"||p=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&d===void 0&&(u[p]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&m(e,0,t,d)),c++,Array.isArray(u)){if(p==="-")p=u.length;else{if(n&&!ah(p))throw new ot("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,t);ah(p)&&(p=~~p)}if(c>=l){if(n&&e.op==="add"&&p>u.length)throw new ot("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,t);const f=_k[e.op].call(e,u,p,t);if(f.test===!1)throw new ot("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return f}}else if(c>=l){const f=Ys[e.op].call(e,u,p,t);if(f.test===!1)throw new ot("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return f}if(u=u[p],n&&c<l&&(!u||typeof u!="object"))throw new ot("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,t)}}}function zu(t,e,n,r=!0,s=!0){if(n&&!Array.isArray(e))throw new ot("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(t=ur(t));const a=new Array(e.length);for(let i=0,o=e.length;i<o;i++)a[i]=ci(t,e[i],n,!0,s,i),t=a[i].newDocument;return a.newDocument=t,a}function uh(t,e,n,r){if(typeof t!="object"||t===null||Array.isArray(t))throw new ot("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,n);if(Ys[t.op]){if(typeof t.path!="string")throw new ot("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,n);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new ot('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,n);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new ot("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new ot("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&ih(t.value))throw new ot("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,n);if(n){if(t.op=="add"){var s=t.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new ot("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,n)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==r)throw new ot("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,n)}else if(t.op==="move"||t.op==="copy"){var i={op:"_get",path:t.from,value:void 0},o=yk([i],n);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ot("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,n)}}}else throw new ot("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,n)}function yk(t,e,n){try{if(!Array.isArray(t))throw new ot("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)zu(ur(e),ur(t),n||!0);else{n=n||uh;for(var r=0;r<t.length;r++)n(t[r],r,e,void 0)}}catch(s){if(s instanceof ot)return s;throw s}}function Wu(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var n=Array.isArray(t),r=Array.isArray(e),s,a,i;if(n&&r){if(a=t.length,a!=e.length)return!1;for(s=a;s--!==0;)if(!Wu(t[s],e[s]))return!1;return!0}if(n!=r)return!1;var o=Object.keys(t);if(a=o.length,a!==Object.keys(e).length)return!1;for(s=a;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=a;s--!==0;)if(i=o[s],!Wu(t[i],e[i]))return!1;return!0}return t!==t&&e!==e}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function ly(t,e,n,r,s){if(e!==t){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=sh(e),i=sh(t),o=!1,u=i.length-1;u>=0;u--){var c=i[u],l=t[c];if(rh(e,c)&&!(e[c]===void 0&&l!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof l=="object"&&l!=null&&typeof d=="object"&&d!=null&&Array.isArray(l)===Array.isArray(d)?ly(l,d,n,r+"/"+Ds(c),s):l!==d&&(s&&n.push({op:"test",path:r+"/"+Ds(c),value:ur(l)}),n.push({op:"replace",path:r+"/"+Ds(c),value:ur(d)}))}else Array.isArray(t)===Array.isArray(e)?(s&&n.push({op:"test",path:r+"/"+Ds(c),value:ur(l)}),n.push({op:"remove",path:r+"/"+Ds(c)}),o=!0):(s&&n.push({op:"test",path:r,value:t}),n.push({op:"replace",path:r,value:e}))}if(!(!o&&a.length==i.length))for(var u=0;u<a.length;u++){var c=a[u];!rh(t,c)&&e[c]!==void 0&&n.push({op:"add",path:r+"/"+Ds(c),value:ur(e[c])})}}}function Ek(t,e,n=!1){var r=[];return ly(t,e,r,"",n),r}const wk=()=>typeof window<"u"&&typeof window.document<"u",Tk=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Sk=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Cf=()=>typeof Deno<"u",Ak=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Cf(),Ck=()=>{let t;return wk()?t="browser":Ak()?t="node":Tk()?t="webworker":Sk()?t="jsdom":Cf()?t="deno":t="other",t};let Zl;async function Ok(){return Zl===void 0&&(Zl={library:"langchain-js",runtime:Ck()}),Zl}function fn(t){var e;try{return typeof process<"u"?(e=process.env)==null?void 0:e[t]:Cf()?Deno==null?void 0:Deno.env.get(t):void 0}catch{return}}class vk{}function Ik(t){return"lc_prefer_streaming"in t&&t.lc_prefer_streaming}class oo extends vk{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,N_(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:fn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return $r.prototype.toJSON.call(this)}toJSONNotImplemented(){return $r.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class n extends oo{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Zt()}),Object.assign(this,e)}}return new n}}const Nk=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function Jl(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function kk(t){return t.replace(/[-:.]/g,"")}function Rk(t,e,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return kk(`${new Date(t).toISOString().slice(0,-1)}${r}Z`)+e}function Ha(t){return typeof t._addRunToRunMap=="function"}class uo extends oo{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,n){e.child_runs.push(n)}_addRunToRunMap(e){const n=Rk(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){const s=this.runMap.get(r.parent_run_id);s&&(this._addChildRun(s,r),s.child_execution_order=Math.max(s.child_execution_order,r.child_execution_order),r.trace_id=s.trace_id,s.dotted_order!==void 0&&(r.dotted_order=[s.dotted_order,n].join(".")))}else r.trace_id=r.id,r.dotted_order=n;return this.runMap.set(r.id,r),r}async _endTrace(e){var r;const n=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);n?n.child_execution_order=Math.max(n.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const n=e!==void 0&&this.runMap.get(e);return n?n.child_execution_order+1:1}_createRunForLLMStart(e,n,r,s,a,i,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,p={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:n},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(p)}async handleLLMStart(e,n,r,s,a,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForLLMStart(e,n,r,s,a,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}_createRunForChatModelStart(e,n,r,s,a,i,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,p={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:n},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(p)}async handleChatModelStart(e,n,r,s,a,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForChatModelStart(e,n,r,s,a,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}async handleLLMEnd(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleLLMError(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForChainStart(e,n,r,s,a,i,o,u){const c=this._getExecutionOrder(s),l=Date.now(),d={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:n,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(d)}async handleChainStart(e,n,r,s,a,i,o,u){var l,d;const c=this.runMap.get(r)??this._createRunForChainStart(e,n,r,s,a,i,o,u);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((d=this.onChainStart)==null?void 0:d.call(this,c)),c}async handleChainEnd(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Jl(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Jl(a.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,n,r,s,a){var o;const i=this.runMap.get(n);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Jl(a.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,n,r,s,a,i,o){const u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:n},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleToolStart(e,n,r,s,a,i,o){var c,l;const u=this.runMap.get(r)??this._createRunForToolStart(e,n,r,s,a,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,u)),await((l=this.onToolStart)==null?void 0:l.call(this,u)),u}async handleToolEnd(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,n){var a;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,r))}async handleAgentEnd(e,n){var s;const r=this.runMap.get(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}_createRunForRetrieverStart(e,n,r,s,a,i,o){const u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:n},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,n,r,s,a,i,o){var c,l;const u=this.runMap.get(r)??this._createRunForRetrieverStart(e,n,r,s,a,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,u)),await((l=this.onRetrieverStart)==null?void 0:l.call(this,u)),u}async handleRetrieverEnd(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,n){var s;const r=this.runMap.get(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,n){var s;const r=this.runMap.get(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,n,r,s,a,i){var u;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:n,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}}var Of={exports:{}};Of.exports;(function(t){const n=(a=0)=>i=>`\x1B[${38+a};5;${i}m`,r=(a=0)=>(i,o,u)=>`\x1B[${38+a};2;${i};${o};${u}m`;function s(){const a=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,u]of Object.entries(i)){for(const[c,l]of Object.entries(u))i[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=i[c],a.set(l[0],l[1]);Object.defineProperty(i,o,{value:u,enumerable:!1})}return Object.defineProperty(i,"codes",{value:a,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=n(),i.color.ansi16m=r(),i.bgColor.ansi256=n(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(t,"exports",{enumerable:!0,get:s})})(Of);var Pk=Of.exports;const dy=to(Pk);function Bt(t,e){return`${t.open}${e}${t.close}`}function yn(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function sg(t){return typeof t=="string"?t.trim():t==null?t:yn(t,t.toString())}function xr(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:zt}=dy;class ag extends uo{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const n=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)n.push(s),r=s;else break}return n}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,a,i)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return a===i.length-1?Bt(dy.bold,o):o}).join(" > ");return Bt(zt.grey,r)}onChainStart(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.green,"[chain/start]")} [${n}] Entering Chain run with input: ${yn(e.inputs,"[inputs]")}`)}onChainEnd(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.cyan,"[chain/end]")} [${n}] [${xr(e)}] Exiting Chain run with output: ${yn(e.outputs,"[outputs]")}`)}onChainError(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.red,"[chain/error]")} [${n}] [${xr(e)}] Chain run errored with error: ${yn(e.error,"[error]")}`)}onLLMStart(e){const n=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${Bt(zt.green,"[llm/start]")} [${n}] Entering LLM run with input: ${yn(r,"[inputs]")}`)}onLLMEnd(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.cyan,"[llm/end]")} [${n}] [${xr(e)}] Exiting LLM run with output: ${yn(e.outputs,"[response]")}`)}onLLMError(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.red,"[llm/error]")} [${n}] [${xr(e)}] LLM run errored with error: ${yn(e.error,"[error]")}`)}onToolStart(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.green,"[tool/start]")} [${n}] Entering Tool run with input: "${sg(e.inputs.input)}"`)}onToolEnd(e){var r;const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.cyan,"[tool/end]")} [${n}] [${xr(e)}] Exiting Tool run with output: "${sg((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.red,"[tool/error]")} [${n}] [${xr(e)}] Tool run errored with error: ${yn(e.error,"[error]")}`)}onRetrieverStart(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.green,"[retriever/start]")} [${n}] Entering Retriever run with input: ${yn(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.cyan,"[retriever/end]")} [${n}] [${xr(e)}] Exiting Retriever run with output: ${yn(e.outputs,"[outputs]")}`)}onRetrieverError(e){const n=this.getBreadcrumbs(e);console.log(`${Bt(zt.red,"[retriever/error]")} [${n}] [${xr(e)}] Retriever run errored with error: ${yn(e.error,"[error]")}`)}onAgentAction(e){const n=e,r=this.getBreadcrumbs(e);console.log(`${Bt(zt.blue,"[agent/action]")} [${r}] Agent selected action: ${yn(n.actions[n.actions.length-1],"[action]")}`)}}let Xl;const xk=()=>{if(Xl===void 0){const t=fn("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Xl=new Bi(t)}return Xl};class li extends uo{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:n,projectName:r,client:s}=e;this.projectName=r??fn("LANGCHAIN_PROJECT")??fn("LANGCHAIN_SESSION"),this.exampleId=n,this.client=s??xk();const a=li.getTraceableRunTree();a&&this.updateFromRunTree(a)}async _convertToCreate(e,n=void 0){return{...e,extra:{...e.extra,runtime:await Ok()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:n}}async persistRun(e){}async onRunCreate(e){const n=await this._convertToCreate(e,this.exampleId);await this.client.createRun(n)}async onRunUpdate(e){const n={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id,extra:e.extra};await this.client.updateRun(e.id,n)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let n=e;const r=new Set;for(;n.parent_run&&!(r.has(n.id)||(r.add(n.id),!n.parent_run));)n=n.parent_run;r.clear();const s=[n];for(;s.length>0;){const a=s.shift();!a||r.has(a.id)||(r.add(a.id),this.runMap.set(a.id,a),a.child_runs&&s.push(...a.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const n={},r=[];for(const[s,a]of this.runMap){const i=new on({...a,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});n[s]=i,r.push([s,a.dotted_order])}r.sort((s,a)=>!s[1]||!a[1]?0:s[1].localeCompare(a[1]));for(const[s]of r){const a=this.runMap.get(s),i=n[s];if(!(!a||!i)&&a.parent_run_id){const o=n[a.parent_run_id];o&&(o.child_runs.push(i),i.parent_run=o)}}return n[e]}static getTraceableRunTree(){try{return mk()}catch{return}}}const hy=Symbol.for("ls:tracing_async_local_storage"),pu=Symbol.for("lc:context_variables"),Lk=t=>{globalThis[hy]=t},Fi=()=>globalThis[hy];let di;function Dk(){const t="default"in Cr?Cr.default:Cr;return new t({autoStart:!0,concurrency:1})}function Mk(){return typeof di>"u"&&(di=Dk()),di}async function ft(t,e){if(e===!0){const n=Fi();n!==void 0?await n.run(void 0,async()=>t()):await t()}else di=Mk(),di.add(async()=>{const n=Fi();n!==void 0?await n.run(void 0,async()=>t()):await t()})}const Bk=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(n=>fn(n)==="true");function fy(t){var r;const e=Fi();if(e===void 0)return;const n=e.getStore();return(r=n==null?void 0:n[pu])==null?void 0:r[t]}const Fk=Symbol("lc:configure_hooks"),Uk=()=>fy(Fk)||[];function my(t){return t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{}}class jk{setHandler(e){return this.setHandlers([e])}}class qc{constructor(e,n,r,s,a,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(n=>ft(async()=>{var r;try{await((r=n.handleText)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleText: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleCustomEvent(e,n,r,s,a){await Promise.all(this.handlers.map(i=>ft(async()=>{var o;try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,n,this.runId,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}}class $k extends qc{getChild(e){const n=new Lt(this.runId);return n.setHandlers(this.inheritableHandlers),n.addTags(this.inheritableTags),n.addMetadata(this.inheritableMetadata),e&&n.addTags([e],!1),n}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(n=>ft(async()=>{var r;if(!n.ignoreRetriever)try{await((r=n.handleRetrieverEnd)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetriever`),n.raiseError)throw s}},n.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(n=>ft(async()=>{var r;if(!n.ignoreRetriever)try{await((r=n.handleRetrieverError)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetrieverError: ${s}`),n.raiseError)throw e}},n.awaitHandlers)))}}class ig extends qc{async handleLLMNewToken(e,n,r,s,a,i){await Promise.all(this.handlers.map(o=>ft(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,n??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`),o.raiseError)throw c}},o.awaitHandlers)))}async handleLLMError(e,n,r,s,a){await Promise.all(this.handlers.map(i=>ft(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleLLMEnd(e,n,r,s,a){await Promise.all(this.handlers.map(i=>ft(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}}class Hk extends qc{getChild(e){const n=new Lt(this.runId);return n.setHandlers(this.inheritableHandlers),n.addTags(this.inheritableTags),n.addMetadata(this.inheritableMetadata),e&&n.addTags([e],!1),n}async handleChainError(e,n,r,s,a){await Promise.all(this.handlers.map(i=>ft(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleChainEnd(e,n,r,s,a){await Promise.all(this.handlers.map(i=>ft(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(n=>ft(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleAgentAction)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleAgentAction: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(n=>ft(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleAgentEnd)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleAgentEnd: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}}class qk extends qc{getChild(e){const n=new Lt(this.runId);return n.setHandlers(this.inheritableHandlers),n.addTags(this.inheritableTags),n.addMetadata(this.inheritableMetadata),e&&n.addTags([e],!1),n}async handleToolError(e){await Promise.all(this.handlers.map(n=>ft(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleToolError)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolError: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(n=>ft(async()=>{var r;if(!n.ignoreAgent)try{await((r=n.handleToolEnd)==null?void 0:r.call(n,e,this.runId,this._parentRunId,this.tags))}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolEnd: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}}class Lt extends jk{constructor(e,n){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(n==null?void 0:n.handlers)??this.handlers,this.inheritableHandlers=(n==null?void 0:n.inheritableHandlers)??this.inheritableHandlers,this.tags=(n==null?void 0:n.tags)??this.tags,this.inheritableTags=(n==null?void 0:n.inheritableTags)??this.inheritableTags,this.metadata=(n==null?void 0:n.metadata)??this.metadata,this.inheritableMetadata=(n==null?void 0:n.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(n.map(async(c,l)=>{const d=l===0&&r?r:Zt();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return Ha(p)&&p._createRunForLLMStart(e,[c],d,this._parentRunId,a,this.tags,this.metadata,u),ft(async()=>{var m;try{await((m=p.handleLLMStart)==null?void 0:m.call(p,e,[c],d,this._parentRunId,a,this.tags,this.metadata,u))}catch(f){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${f}`),p.raiseError)throw f}},p.awaitHandlers)})),new ig(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(n.map(async(c,l)=>{const d=l===0&&r?r:Zt();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return Ha(p)&&p._createRunForChatModelStart(e,[c],d,this._parentRunId,a,this.tags,this.metadata,u),ft(async()=>{var m,f;try{if(p.handleChatModelStart)await((m=p.handleChatModelStart)==null?void 0:m.call(p,e,[c],d,this._parentRunId,a,this.tags,this.metadata,u));else if(p.handleLLMStart){const g=P_(c);await((f=p.handleLLMStart)==null?void 0:f.call(p,e,[g],d,this._parentRunId,a,this.tags,this.metadata,u))}}catch(g){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${g}`),p.raiseError)throw g}},p.awaitHandlers)})),new ig(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,n,r=Zt(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return Ha(u)&&u._createRunForChainStart(e,n,r,this._parentRunId,this.tags,this.metadata,s,o),ft(async()=>{var c;try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,n,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Hk(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,n,r=Zt(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return Ha(u)&&u._createRunForToolStart(e,n,r,this._parentRunId,this.tags,this.metadata,o),ft(async()=>{var c;try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new qk(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,n,r=Zt(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return Ha(u)&&u._createRunForRetrieverStart(e,n,r,this._parentRunId,this.tags,this.metadata,o),ft(async()=>{var c;try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new $k(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,n,r,s,a){await Promise.all(this.handlers.map(i=>ft(async()=>{var o;if(!i.ignoreCustomEvent)try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,n,r,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}addHandler(e,n=!0){this.handlers.push(e),n&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(n=>n!==e),this.inheritableHandlers=this.inheritableHandlers.filter(n=>n!==e)}setHandlers(e,n=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,n)}addTags(e,n=!0){this.removeTags(e),this.tags.push(...e),n&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(n=>!e.includes(n)),this.inheritableTags=this.inheritableTags.filter(n=>!e.includes(n))}addMetadata(e,n=!0){this.metadata={...this.metadata,...e},n&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const n of Object.keys(e))delete this.metadata[n],delete this.inheritableMetadata[n]}copy(e=[],n=!0){const r=new Lt(this._parentRunId);for(const s of this.handlers){const a=this.inheritableHandlers.includes(s);r.addHandler(s,a)}for(const s of this.tags){const a=this.inheritableTags.includes(s);r.addTags([s],a)}for(const s of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(s);r.addMetadata({[s]:this.metadata[s]},a)}for(const s of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===s.name)||r.addHandler(s,n);return r}static fromHandlers(e){class n extends oo{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Zt()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new n),r}static configure(e,n,r,s,a,i,o){return this._configureSync(e,n,r,s,a,i,o)}static _configureSync(e,n,r,s,a,i,o){var p,m;let u;(e||n)&&(Array.isArray(e)||!e?(u=new Lt,u.setHandlers((e==null?void 0:e.map(Gu))??[],!0)):u=e,u=u.copy(Array.isArray(n)?n.map(Gu):n==null?void 0:n.handlers,!1));const c=fn("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=((p=li.getTraceableRunTree())==null?void 0:p.tracingEnabled)||Bk(),d=l||(fn("LANGCHAIN_TRACING")??!1);if(c||d){if(u||(u=new Lt),c&&!u.handlers.some(f=>f.name===ag.prototype.name)){const f=new ag;u.addHandler(f,!0)}if(d&&!u.handlers.some(f=>f.name==="langchain_tracer")&&l){const f=new li;u.addHandler(f,!0),u._parentRunId=((m=li.getTraceableRunTree())==null?void 0:m.id)??u._parentRunId}}for(const{contextVar:f,inheritable:g=!0,handlerClass:b,envVar:_}of Uk()){const E=_&&fn(_)==="true"&&b;let T;const N=f!==void 0?fy(f):void 0;N&&Nk(N)?T=N:E&&(T=new b({})),T!==void 0&&(u||(u=new Lt),u.handlers.some(v=>v.name===T.name)||u.addHandler(T,g))}return(r||s)&&u&&(u.addTags(r??[]),u.addTags(s??[],!1)),(a||i)&&u&&(u.addMetadata(a??{}),u.addMetadata(i??{},!1)),u}}function Gu(t){return"name"in t?t:oo.fromMethods(t)}class Vk{getStore(){}run(e,n){return n()}enterWith(e){}}const zk=new Vk,og=Symbol.for("lc:child_config");class Wk{getInstance(){return Fi()??zk}getRunnableConfig(){var n,r;return(r=(n=this.getInstance().getStore())==null?void 0:n.extra)==null?void 0:r[og]}runWithConfig(e,n,r){var l;const s=Lt._configureSync(e==null?void 0:e.callbacks,void 0,e==null?void 0:e.tags,void 0,e==null?void 0:e.metadata),a=this.getInstance(),i=a.getStore(),o=s==null?void 0:s.getParentRunId(),u=(l=s==null?void 0:s.handlers)==null?void 0:l.find(d=>(d==null?void 0:d.name)==="langchain_tracer");let c;return u&&o?c=u.convertToRunTree(o):r||(c=new on({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[og]:e}),i!==void 0&&i[pu]!==void 0&&(c[pu]=i[pu]),a.run(c,n)}initializeGlobalInstance(e){Fi()===void 0&&Lk(e)}}const Wr=new Wk,Ql=25;async function $n(t){return Lt._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata)}function ug(...t){const e={};for(const n of t.filter(r=>!!r))for(const r of Object.keys(n))if(r==="metadata")e[r]={...e[r],...n[r]};else if(r==="tags"){const s=e[r]??[];e[r]=[...new Set(s.concat(n[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...n[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=n.timeout:n.timeout!==void 0&&(e.timeout=Math.min(e.timeout,n.timeout));else if(r==="signal")e.signal===void 0?e.signal=n.signal:n.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,n.signal]):e.signal=n.signal);else if(r==="callbacks"){const s=e.callbacks,a=n.callbacks;if(Array.isArray(a))if(!s)e.callbacks=a;else if(Array.isArray(s))e.callbacks=s.concat(a);else{const i=s.copy();for(const o of a)i.addHandler(Gu(o),!0);e.callbacks=i}else if(a)if(!s)e.callbacks=a;else if(Array.isArray(s)){const i=a.copy();for(const o of s)i.addHandler(Gu(o),!0);e.callbacks=i}else e.callbacks=new Lt(a._parentRunId,{handlers:s.handlers.concat(a.handlers),inheritableHandlers:s.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(a.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(a.inheritableTags))),metadata:{...s.metadata,...a.metadata}})}else{const s=r;e[s]=n[s]??e[s]}return e}const Gk=new Set(["string","number","boolean"]);function Be(t){var r;const e=Wr.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:a,...i}=e;n=Object.entries(i).reduce((o,[u,c])=>(c!==void 0&&(o[u]=c),o),n)}if(t&&(n=Object.entries(t).reduce((s,[a,i])=>(i!==void 0&&(s[a]=i),s),n)),n!=null&&n.configurable)for(const s of Object.keys(n.configurable))Gk.has(typeof n.configurable[s])&&!((r=n.metadata)!=null&&r[s])&&(n.metadata||(n.metadata={}),n.metadata[s]=n.configurable[s]);if(n.timeout!==void 0){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(n.timeout);n.signal!==void 0?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,s])):n.signal=s,delete n.timeout}return n}function Pt(t={},{callbacks:e,maxConcurrency:n,recursionLimit:r,runName:s,configurable:a,runId:i}={}){const o=Be(t);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),n!==void 0&&(o.maxConcurrency=n),s!==void 0&&(o.runName=s),a!==void 0&&(o.configurable={...o.configurable,...a}),i!==void 0&&delete o.runId,o}function ca(t){return t?{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal}:void 0}async function Gr(t,e){if(e===void 0)return t;let n;return Promise.race([t.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,s)=>{n=()=>{s(new Error("Aborted"))},e.addEventListener("abort",n),e.aborted&&s(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",n))}class pn extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const n=e.getReader();return new pn({start(r){return s();function s(){return n.read().then(({done:a,value:i})=>{if(a){r.close();return}return r.enqueue(i),s()})}},cancel(){n.releaseLock()}})}static fromAsyncGenerator(e){return new pn({async pull(n){const{value:r,done:s}=await e.next();s&&n.close(),n.enqueue(r)},async cancel(n){await e.return(n)}})}}function py(t,e=2){const n=Array.from({length:e},()=>[]);return n.map(async function*(s){for(;;)if(s.length===0){const a=await t.next();for(const i of n)i.push(a)}else{if(s[0].done)return;yield s.shift().value}})}function Hn(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const n={...t};for(const[r,s]of Object.entries(e))r in n&&!Array.isArray(n[r])?n[r]=Hn(n[r],s):n[r]=s;return n}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}class wa{constructor(e){var n;Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??((n=this.config)==null?void 0:n.signal),this.setup=new Promise((r,s)=>{Wr.runWithConfig(ca(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(r,s):this.firstResult.then(a=>r(void 0),s)},!0)})}async next(...e){var n;return(n=this.signal)==null||n.throwIfAborted(),this.firstResultUsed?Wr.runWithConfig(ca(this.config),this.signal?async()=>Gr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function Kk(t,e,n,r,...s){const a=new wa({generator:e,startSetup:n,signal:r}),i=await a.setup;return{output:t(a,i,...s),setup:i}}class Mr{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const n=this.ops.concat(e.ops),r=zu({},n);return new Ui({ops:n,state:r[r.length-1].newDocument})}}class Ui extends Mr{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const n=this.ops.concat(e.ops),r=zu(this.state,e.ops);return new Ui({ops:n,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const n=zu({},e.ops);return new Ui({ops:e.ops,state:n[n.length-1].newDocument})}}const Yk=t=>t.name==="log_stream_tracer";async function cg(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=t;if(["retriever","llm","prompt"].includes(t.run_type))return n;if(!(Object.keys(n).length===1&&(n==null?void 0:n.input)===""))return n.input}async function lg(t,e){const{outputs:n}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?n:n!==void 0&&Object.keys(n).length===1&&(n==null?void 0:n.output)!==void 0?n.output:n}function Zk(t){return t!==void 0&&t.message!==void 0}class dg extends uo{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=pn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||n.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,n){for await(const r of n){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new Mr({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Mr({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const n=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=n===1?e.name:`${e.name}:${n}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await cg(e,this._schemaFormat)),await this.writer.write(new Mr({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const n=this.keyMapByRunId[e.id];if(n===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${n}/inputs`,value:await cg(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${n}/final_output`,value:await lg(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${n}/end_time`,value:new Date(e.end_time).toISOString()});const s=new Mr({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const n=new Mr({ops:[{op:"replace",path:"/final_output",value:await lg(e,this._schemaFormat)}]});await this.writer.write(n),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,n,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const a=e.inputs.messages!==void 0;let i;a?Zk(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new Yt({id:`run-${e.id}`,content:n}):i=n;const o=new Mr({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:n},{op:"add",path:`/logs/${s}/streamed_output/-`,value:i}]});await this.writer.write(o)}}const hg="__run";class la{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new la({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class ws extends la{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new ws({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function Yo({name:t,serialized:e}){return t!==void 0?t:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const Jk=t=>t.name==="event_stream_tracer";class Xk extends uo{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=pn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||n.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,n){const r=await n.next();if(r.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield r.value;return}function a(o,u){return o==="llm"&&typeof u=="string"?new la({text:u}):u}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(u=>{o=u}),this.tappedPromises.set(e,i);try{const u={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...u,data:{chunk:a(s.runType,r.value)}},s),yield r.value;for await(const c of n)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...u,data:{chunk:a(s.runType,c)}},s),yield c}finally{o()}}else{yield r.value;for await(const o of n)yield o}}async send(e,n){this._includeRun(n)&&await this.writer.write(e)}async sendEndEvent(e,n){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,n)}):await this.send(e,n)}async onLLMStart(e){var i,o;const n=Yo(e),r=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:n,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,s);const a=`on_${r}_start`;await this.send({event:a,data:{input:e.inputs},name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,n,r){const s=this.runInfoMap.get(e.id);let a,i;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")i="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?a=new Yt({content:n,id:`run-${e.id}`}):a=r.chunk.message;else if(s.runType==="llm")i="on_llm_stream",(r==null?void 0:r.chunk)===void 0?a=new la({text:n}):a=r.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:i,data:{chunk:a},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var i,o,u;const n=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(n===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(i=e.outputs)==null?void 0:i.generations;let a;if(n.runType==="chat_model"){for(const c of s??[]){if(a!==void 0)break;a=(o=c[0])==null?void 0:o.message}r="on_chat_model_end"}else if(n.runType==="llm")a={generations:s==null?void 0:s.map(c=>c.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:((u=e.outputs)==null?void 0:u.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${n.runType}`);await this.sendEndEvent({event:r,data:{output:a,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onChainStart(e){var i,o;const n=Yo(e),r=e.run_type??"chain",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:n,runType:e.run_type};let a={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(a={},s.inputs={}):e.inputs.input!==void 0?(a.input=e.inputs.input,s.inputs=e.inputs.input):(a.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${r}_start`,data:a,name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,s=e.inputs??n.inputs??{},i={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(i.input=s.input,n.inputs=s.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata??{}},n)}async onToolStart(e){var s,a;const n=Yo(e),r={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:n,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:n,run_id:e.id,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{}},r)}async onToolEnd(e){var s;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(n.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onRetrieverStart(e){var a,i;const n=Yo(e),s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:n,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:n,tags:e.tags??[],run_id:e.id,metadata:((i=e.extra)==null?void 0:i.metadata)??{}},s)}async onRetrieverEnd(e){var r;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async handleCustomEvent(e,n,r){const s=this.runInfoMap.get(r);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:s.tags,metadata:s.metadata,data:n},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const Qk=[400,401,402,403,404,405,406,407,409],eR=t=>{var n,r;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||(t==null?void 0:t.code)==="ECONNABORTED")throw t;const e=((n=t==null?void 0:t.response)==null?void 0:n.status)??(t==null?void 0:t.status);if(e&&Qk.includes(+e))throw t;if(((r=t==null?void 0:t.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(t==null?void 0:t.message);throw s.name="InsufficientQuotaError",s}};class vf{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??eR;const n="default"in Cr?Cr.default:Cr;this.queue=new n({concurrency:this.maxConcurrency})}call(e,...n){return this.queue.add(()=>Hu(()=>e(...n).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,n,...r){return e.signal?Promise.race([this.call(n,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(n,...r)}fetch(...e){return this.call(()=>fetch(...e).then(n=>n.ok?n:Promise.reject(n)))}}class gy extends uo{constructor({config:e,onStart:n,onEnd:r,onError:s}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=n,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function If(t){return t?t.lc_runnable:!1}class tR{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,n){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const s=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(n)),this.includeTags!==void 0&&(r=r||s.some(a=>{var i;return(i=this.includeTags)==null?void 0:i.includes(a)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(n)),this.excludeTags!==void 0&&(r=r&&s.every(a=>{var i;return!((i=this.excludeTags)!=null&&i.includes(a))})),r}}const nR=Symbol("Let zodToJsonSchema decide on which parser to use"),rR={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},sR=t=>({...rR,...t}),aR=t=>{const e=sR(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function by(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function ze(t,e,n,r,s){t[e]=n,by(t,e,r,s)}function iR(){return{}}function oR(t,e){var r,s,a;const n={type:"array"};return(r=t.type)!=null&&r._def&&((a=(s=t.type)==null?void 0:s._def)==null?void 0:a.typeName)!==H.ZodAny&&(n.items=He(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&ze(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&ze(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(ze(n,"minItems",t.exactLength.value,t.exactLength.message,e),ze(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function uR(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?ze(n,"minimum",r.value,r.message,e):ze(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),ze(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ze(n,"maximum",r.value,r.message,e):ze(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),ze(n,"maximum",r.value,r.message,e));break;case"multipleOf":ze(n,"multipleOf",r.value,r.message,e);break}return n}function cR(){return{type:"boolean"}}function _y(t,e){return He(t.type._def,e)}const lR=(t,e)=>He(t.innerType._def,e);function yy(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,a)=>yy(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return dR(t,e)}}const dR=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":ze(n,"minimum",r.value,r.message,e);break;case"max":ze(n,"maximum",r.value,r.message,e);break}return n};function hR(t,e){return{...He(t.innerType._def,e),default:t.defaultValue()}}function fR(t,e){return e.effectStrategy==="input"?He(t.schema._def,e):{}}function mR(t){return{type:"string",enum:Array.from(t.values)}}const pR=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function gR(t,e){const n=[He(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),He(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(a=>{if(pR(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...u}=a;i=u}else r=void 0;s.push(i)}}),s.length?{allOf:s,...r}:void 0}function bR(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let ed;const In={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(ed===void 0&&(ed=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ed),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Ey(t,e){const n={type:"string"};if(t.checks)for(const r of t.checks)switch(r.kind){case"min":ze(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e);break;case"max":ze(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Nn(n,"email",r.message,e);break;case"format:idn-email":Nn(n,"idn-email",r.message,e);break;case"pattern:zod":Ft(n,In.email,r.message,e);break}break;case"url":Nn(n,"uri",r.message,e);break;case"uuid":Nn(n,"uuid",r.message,e);break;case"regex":Ft(n,r.regex,r.message,e);break;case"cuid":Ft(n,In.cuid,r.message,e);break;case"cuid2":Ft(n,In.cuid2,r.message,e);break;case"startsWith":Ft(n,RegExp(`^${td(r.value,e)}`),r.message,e);break;case"endsWith":Ft(n,RegExp(`${td(r.value,e)}$`),r.message,e);break;case"datetime":Nn(n,"date-time",r.message,e);break;case"date":Nn(n,"date",r.message,e);break;case"time":Nn(n,"time",r.message,e);break;case"duration":Nn(n,"duration",r.message,e);break;case"length":ze(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e),ze(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"includes":{Ft(n,RegExp(td(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&Nn(n,"ipv4",r.message,e),r.version!=="v4"&&Nn(n,"ipv6",r.message,e);break}case"base64url":Ft(n,In.base64url,r.message,e);break;case"jwt":Ft(n,In.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&Ft(n,In.ipv4Cidr,r.message,e),r.version!=="v4"&&Ft(n,In.ipv6Cidr,r.message,e);break}case"emoji":Ft(n,In.emoji(),r.message,e);break;case"ulid":{Ft(n,In.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Nn(n,"binary",r.message,e);break}case"contentEncoding:base64":{ze(n,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{Ft(n,In.base64,r.message,e);break}}break}case"nanoid":Ft(n,In.nanoid,r.message,e)}return n}function td(t,e){return e.patternStrategy==="escape"?yR(t):t}const _R=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function yR(t){let e="";for(let n=0;n<t.length;n++)_R.has(t[n])||(e+="\\"),e+=t[n];return e}function Nn(t,e,n,r){var s;t.format||(s=t.anyOf)!=null&&s.some(a=>a.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):ze(t,"format",e,n,r)}function Ft(t,e,n,r){var s;t.pattern||(s=t.allOf)!=null&&s.some(a=>a.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:fg(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):ze(t,"pattern",fg(e,r),n,r)}function fg(t,e){var u;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},r=n.i?t.source.toLowerCase():t.source;let s="",a=!1,i=!1,o=!1;for(let c=0;c<r.length;c++){if(a){s+=r[c],a=!1;continue}if(n.i){if(i){if(r[c].match(/[a-z]/)){o?(s+=r[c],s+=`${r[c-2]}-${r[c]}`.toUpperCase(),o=!1):r[c+1]==="-"&&((u=r[c+2])!=null&&u.match(/[a-z]/))?(s+=r[c],o=!0):s+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){s+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(n.m){if(r[c]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){s+=`($|(?=[\r
]))`;continue}}if(n.s&&r[c]==="."){s+=i?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}s+=r[c],r[c]==="\\"?a=!0:i&&r[c]==="]"?i=!1:!i&&r[c]==="["&&(i=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s}function wy(t,e){var r,s,a,i,o,u;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===H.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((c,l)=>({...c,[l]:He(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:He(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===H.ZodString&&((a=t.keyType._def.checks)!=null&&a.length)){const{type:c,...l}=Ey(t.keyType._def,e);return{...n,propertyNames:l}}else{if(((i=t.keyType)==null?void 0:i._def.typeName)===H.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};if(((o=t.keyType)==null?void 0:o._def.typeName)===H.ZodBranded&&t.keyType._def.type._def.typeName===H.ZodString&&((u=t.keyType._def.type._def.checks)!=null&&u.length)){const{type:c,...l}=_y(t.keyType._def,e);return{...n,propertyNames:l}}}return n}function ER(t,e){if(e.mapStrategy==="record")return wy(t,e);const n=He(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=He(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function wR(t){const e=t.values,r=Object.keys(t.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function TR(){return{not:{}}}function SR(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Ku={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function AR(t,e){if(e.target==="openApi3")return mg(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in Ku&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,a)=>{const i=Ku[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":if(a._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:n.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return mg(t,e)}const mg=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>He(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function CR(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:Ku[t.innerType._def.typeName],nullable:!0}:{type:[Ku[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=He(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=He(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function OR(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",by(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?ze(n,"minimum",r.value,r.message,e):ze(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),ze(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ze(n,"maximum",r.value,r.message,e):ze(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),ze(n,"maximum",r.value,r.message,e));break;case"multipleOf":ze(n,"multipleOf",r.value,r.message,e);break}return n}function vR(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":He(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":He(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function IR(t,e){const n=e.target==="openAi",r={type:"object",...Object.entries(t.shape()).reduce((s,[a,i])=>{if(i===void 0||i._def===void 0)return s;let o=i.isOptional();o&&n&&(i instanceof jn&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);const u=He(i._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return u===void 0?s:{properties:{...s.properties,[a]:u},required:o?s.required:[...s.required,a]}},{properties:{},required:[]}),additionalProperties:vR(t,e)};return r.required.length||delete r.required,r}const NR=(t,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return He(t.innerType._def,e);const n=He(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},kR=(t,e)=>{if(e.pipeStrategy==="input")return He(t.in._def,e);if(e.pipeStrategy==="output")return He(t.out._def,e);const n=He(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=He(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function RR(t,e){return He(t.type._def,e)}function PR(t,e){const r={type:"array",uniqueItems:!0,items:He(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&ze(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&ze(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function xR(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>He(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:He(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>He(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function LR(){return{not:{}}}function DR(){return{}}const MR=(t,e)=>He(t.innerType._def,e);function He(t,e,n=!1){var i;const r=e.seen.get(t);if(e.override){const o=(i=e.override)==null?void 0:i.call(e,t,e,r,n);if(o!==nR)return o}if(r&&!n){const o=BR(r,e);if(o!==void 0)return o}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const a=UR(t,t.typeName,e);return a&&jR(t,e,a),s.jsonSchema=a,a}const BR=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:FR(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((n,r)=>e.currentPath[r]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},FR=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")},UR=(t,e,n)=>{switch(e){case H.ZodString:return Ey(t,n);case H.ZodNumber:return OR(t,n);case H.ZodObject:return IR(t,n);case H.ZodBigInt:return uR(t,n);case H.ZodBoolean:return cR();case H.ZodDate:return yy(t,n);case H.ZodUndefined:return LR();case H.ZodNull:return SR(n);case H.ZodArray:return oR(t,n);case H.ZodUnion:case H.ZodDiscriminatedUnion:return AR(t,n);case H.ZodIntersection:return gR(t,n);case H.ZodTuple:return xR(t,n);case H.ZodRecord:return wy(t,n);case H.ZodLiteral:return bR(t,n);case H.ZodEnum:return mR(t);case H.ZodNativeEnum:return wR(t);case H.ZodNullable:return CR(t,n);case H.ZodOptional:return NR(t,n);case H.ZodMap:return ER(t,n);case H.ZodSet:return PR(t,n);case H.ZodLazy:return He(t.getter()._def,n);case H.ZodPromise:return RR(t,n);case H.ZodNaN:case H.ZodNever:return TR();case H.ZodEffects:return fR(t,n);case H.ZodAny:return iR();case H.ZodUnknown:return DR();case H.ZodDefault:return hR(t,n);case H.ZodBranded:return _y(t,n);case H.ZodReadonly:return MR(t,n);case H.ZodCatch:return lR(t,n);case H.ZodPipeline:return kR(t,n);case H.ZodFunction:case H.ZodVoid:case H.ZodSymbol:return;default:return(r=>{})()}},jR=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),Ts=(t,e)=>{const n=aR(e),r=void 0,s=e==null?void 0:e.name,a=He(t._def,n,!1)??{},i=s===void 0?r?{...a,[n.definitionPath]:r}:a:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...r,[s]:a}};return n.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(n.target==="jsonSchema2019-09"||n.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),n.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function nd(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const $R=["*","_","`"];function HR(t){let e="";for(const[n,r]of Object.entries(t))e+=`	classDef ${n} ${r};
`;return e}function qR(t,e,n){const{firstNode:r,lastNode:s,nodeColors:a,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=n;let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){const m="default",f={[m]:"{0}({1})"};r!==void 0&&(f[r]="{0}([{1}]):::first"),s!==void 0&&(f[s]="{0}([{1}]):::last");for(const[g,b]of Object.entries(t)){const _=b.name.split(":").pop()??"";let T=$R.some(v=>_.startsWith(v)&&_.endsWith(v))?`<p>${_}</p>`:_;Object.keys(b.metadata??{}).length&&(T+=`<hr/><small><em>${Object.entries(b.metadata??{}).map(([v,A])=>`${v} = ${A}`).join(`
`)}</em></small>`);const N=(f[g]??f[m]).replace("{0}",nd(g)).replace("{1}",T);c+=`	${N}
`}}const l={};for(const m of e){const f=m.source.split(":"),g=m.target.split(":"),b=f.filter((_,E)=>_===g[E]).join(":");l[b]||(l[b]=[]),l[b].push(m)}const d=new Set;function p(m,f){const g=m.length===1&&m[0].source===m[0].target;if(f&&!g){const b=f.split(":").pop();if(d.has(b))throw new Error(`Found duplicate subgraph '${b}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(b),c+=`	subgraph ${b}
`}for(const b of m){const{source:_,target:E,data:T,conditional:N}=b;let v="";if(T!==void 0){let A=T;const O=A.split(" ");O.length>u&&(A=Array.from({length:Math.ceil(O.length/u)},(x,D)=>O.slice(D*u,(D+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),v=N?` -. &nbsp;${A}&nbsp; .-> `:` -- &nbsp;${A}&nbsp; --> `}else v=N?" -.-> ":" --> ";c+=`	${nd(_)}${v}${nd(E)};
`}for(const b in l)b.startsWith(`${f}:`)&&b!==f&&p(l[b],b);f&&!g&&(c+=`	end
`)}p(l[""]??[],"");for(const m in l)!m.includes(":")&&m!==""&&p(l[m],m);return i&&(c+=HR(a??{})),c}async function VR(t,e){let{backgroundColor:n="white"}=e;const r=btoa(t);n!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const s=`https://mermaid.ink/img/${r}?bgColor=${n}`,a=await fetch(s);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}function zR(t,e){if(t!==void 0&&!ui(t))return t;if(If(e))try{let n=e.getName();return n=n.startsWith("Runnable")?n.slice(8):n,n}catch{return e.getName()}else return e.name??"UnknownSchema"}function WR(t){return If(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...Ts(t.data.schema),title:t.data.name}}}class Vc{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((n,r)=>{e[n.id]=ui(n.id)?r:n.id}),{nodes:Object.values(this.nodes).map(n=>({id:e[n.id],...WR(n)})),edges:this.edges.map(n=>{const r={source:e[n.source],target:e[n.target]};return typeof n.data<"u"&&(r.data=n.data),typeof n.conditional<"u"&&(r.conditional=n.conditional),r})}}addNode(e,n,r){if(n!==void 0&&this.nodes[n]!==void 0)throw new Error(`Node with id ${n} already exists`);const s=n??Zt(),a={id:s,data:e,name:zR(n,e),metadata:r};return this.nodes[s]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(n=>n.source!==e.id&&n.target!==e.id)}addEdge(e,n,r,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[n.id]===void 0)throw new Error(`Target node ${n.id} not in graph`);const a={source:e.id,target:n.id,data:r,conditional:s};return this.edges.push(a),a}firstNode(){return pg(this)}lastNode(){return gg(this)}extend(e,n=""){let r=n;Object.values(e.nodes).map(c=>c.id).every(ui)&&(r="");const a=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[a(c)]={...l,id:a(c)}});const i=e.edges.map(c=>({...c,source:a(c.source),target:a(c.target)}));this.edges=[...this.edges,...i];const o=e.firstNode(),u=e.lastNode();return[o?{id:a(o.id),data:o.data}:void 0,u?{id:a(u.id),data:u.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&pg(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&gg(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),n=new Map;Object.values(e).forEach(s=>{n.set(s,(n.get(s)||0)+1)});const r=s=>{const a=e[s];return ui(s)&&n.get(a)===1?a:s};return new Vc({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,a])=>[r(s),{...a,id:r(s)}])),edges:this.edges.map(s=>({...s,source:r(s.source),target:r(s.target)}))})}drawMermaid(e){const{withStyles:n,curveStyle:r,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},i=this.reid(),o=i.firstNode(),u=i.lastNode();return qR(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:u==null?void 0:u.id,withStyles:n,curveStyle:r,nodeColors:s,wrapLabelNWords:a})}async drawMermaidPng(e){const n=this.drawMermaid(e);return VR(n,{backgroundColor:e==null?void 0:e.backgroundColor})}}function pg(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function gg(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function GR(t){const e=new TextEncoder,n=new ReadableStream({async start(r){for await(const s of t)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return pn.fromReadableStream(n)}function bg(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const KR=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function ch(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*_g(t,e){for(;;){const{value:n,done:r}=Wr.runWithConfig(ca(t),e.next.bind(e),!0);if(r)break;yield n}}async function*lh(t,e){const n=e[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await Wr.runWithConfig(ca(t),n.next.bind(e),!0);if(s)break;yield r}}function At(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}class pt extends $r{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const n=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${n}${e}`:n}bind(e){return new fs({bound:this,kwargs:e,config:{}})}map(){return new Yu({bound:this})}withRetry(e){return new YR({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new fs({bound:this,config:e,kwargs:{}})}withFallbacks(e){const n=Array.isArray(e)?e:e.fallbacks;return new JR({runnable:this,fallbacks:n})}_getOptionsList(e,n=0){if(Array.isArray(e)&&e.length!==n)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${n} inputs`);if(Array.isArray(e))return e.map(Be);if(n>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:n},(s,a)=>Be(a===0?e:r))}return Array.from({length:n},()=>Be(e))}async batch(e,n,r){var u;const s=this._getOptionsList(n??{},e.length),a=((u=s[0])==null?void 0:u.maxConcurrency)??(r==null?void 0:r.maxConcurrency),i=new vf({maxConcurrency:a,onFailedAttempt:c=>{throw c}}),o=e.map((c,l)=>i.call(async()=>{try{return await this.invoke(c,s[l])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,n){yield this.invoke(e,n)}async stream(e,n){const r=Be(n),s=new wa({generator:this._streamIterator(e,r),config:r});return await s.setup,pn.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let n;e===void 0?n=Be(e):n=Be({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[n,r]}async _callWithConfig(e,n,r){const s=Be(r),a=await $n(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),At(n,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const u=e.call(this,n,s,i);o=await Gr(u,r==null?void 0:r.signal)}catch(u){throw await(i==null?void 0:i.handleChainError(u)),u}return await(i==null?void 0:i.handleChainEnd(At(o,"output"))),o}async _batchWithConfig(e,n,r,s){var c;const a=this._getOptionsList(r??{},n.length),i=await Promise.all(a.map($n)),o=await Promise.all(i.map(async(l,d)=>{const p=await(l==null?void 0:l.handleChainStart(this.toJSON(),At(n[d],"input"),a[d].runId,a[d].runType,void 0,void 0,a[d].runName??this.getName()));return delete a[d].runId,p}));let u;try{const l=e.call(this,n,a,o,s);u=await Gr(l,(c=a==null?void 0:a[0])==null?void 0:c.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(At(u,"output")))),u}async*_transformStreamWithConfig(e,n,r){let s,a=!0,i,o=!0;const u=Be(r),c=await $n(u);async function*l(){for await(const p of e){if(a)if(s===void 0)s=p;else try{s=Hn(s,p)}catch{s=void 0,a=!1}yield p}}let d;try{const p=await Kk(n.bind(this),l(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),r==null?void 0:r.signal,u);delete u.runId,d=p.setup;const m=d==null?void 0:d.handlers.find(Jk);let f=p.output;m!==void 0&&d!==void 0&&(f=m.tapOutputIterable(d.runId,f));const g=d==null?void 0:d.handlers.find(Yk);g!==void 0&&d!==void 0&&(f=g.tapOutputIterable(d.runId,f));for await(const b of f)if(yield b,o)if(i===void 0)i=b;else try{i=Hn(i,b)}catch{i=void 0,o=!1}}catch(p){throw await(d==null?void 0:d.handleChainError(p,void 0,void 0,void 0,{inputs:At(s,"input")})),p}await(d==null?void 0:d.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:At(s,"input")}))}getGraph(e){const n=new Vc,r=n.addNode({name:`${this.getName()}Input`,schema:Ar.any()}),s=n.addNode(this),a=n.addNode({name:`${this.getName()}Output`,schema:Ar.any()});return n.addEdge(r,s),n.addEdge(s,a),n}pipe(e){return new cr({first:this,last:as(e)})}pick(e){return this.pipe(new XR(e))}assign(e){return this.pipe(new Ty(new Ta({steps:e})))}async*transform(e,n){let r;for await(const s of e)r===void 0?r=s:r=Hn(r,s);yield*this._streamIterator(r,Be(n))}async*streamLog(e,n,r){const s=new dg({...r,autoClose:!1,_schemaFormat:"original"}),a=Be(n);yield*this._streamLog(e,s,a)}async*_streamLog(e,n,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[n];else if(Array.isArray(s))r.callbacks=s.concat([n]);else{const u=s.copy();u.addHandler(n,!0),r.callbacks=u}const a=this.stream(e,r);async function i(){try{const u=await a;for await(const c of u){const l=new Mr({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await n.writer.write(l)}}finally{await n.writer.close()}}const o=i();try{for await(const u of n)yield u}finally{await o}}streamEvents(e,n,r){let s;if(n.version==="v1")s=this._streamEventsV1(e,n,r);else if(n.version==="v2")s=this._streamEventsV2(e,n,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return n.encoding==="text/event-stream"?GR(s):pn.fromAsyncGenerator(s)}async*_streamEventsV2(e,n,r){var m;const s=new Xk({...r,autoClose:!1}),a=Be(n),i=a.runId??Zt();a.runId=i;const o=a.callbacks;if(o===void 0)a.callbacks=[s];else if(Array.isArray(o))a.callbacks=o.concat(s);else{const f=o.copy();f.addHandler(s,!0),a.callbacks=f}const u=this;async function c(){try{const f=await u.stream(e,a),g=s.tapOutputIterable(i,f);for await(const b of g);}finally{await s.finish()}}const l=c();let d=!1,p;try{for await(const f of s){if(!d){f.data.input=e,d=!0,p=f.run_id,yield f;continue}f.run_id===p&&f.event.endsWith("_end")&&(m=f.data)!=null&&m.input&&delete f.data.input,yield f}}finally{await l}}async*_streamEventsV1(e,n,r){let s,a=!1;const i=Be(n),o=i.tags??[],u=i.metadata??{},c=i.runName??this.getName(),l=new dg({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new tR({...r}),p=this._streamLog(e,l,i);for await(const f of p){if(s?s=s.concat(f):s=Ui.fromRunLogPatch(f),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const E={...s.state},T={run_id:E.id,event:`on_${E.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(T,E.type)&&(yield T)}const g=f.ops.filter(E=>E.path.startsWith("/logs/")).map(E=>E.path.split("/")[2]),b=[...new Set(g)];for(const E of b){let T,N={};const v=s.state.logs[E];if(v.end_time===void 0?v.streamed_output.length>0?T="stream":T="start":T="end",T==="start")v.inputs!==void 0&&(N.input=v.inputs);else if(T==="end")v.inputs!==void 0&&(N.input=v.inputs),N.output=v.final_output;else if(T==="stream"){const A=v.streamed_output.length;if(A!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${A} instead. Encountered in: "${v.name}"`);N={chunk:v.streamed_output[0]},v.streamed_output=[]}yield{event:`on_${v.type}_${T}`,name:v.name,run_id:v.id,tags:v.tags,metadata:v.metadata,data:N}}const{state:_}=s;if(_.streamed_output.length>0){const E=_.streamed_output.length;if(E!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${E} instead. Encountered in: "${_.name}"`);const T={chunk:_.streamed_output[0]};_.streamed_output=[];const N={event:`on_${_.type}_stream`,run_id:_.id,tags:o,metadata:u,name:c,data:T};d.includeEvent(N,_.type)&&(yield N)}}const m=s==null?void 0:s.state;if(m!==void 0){const f={event:`on_${m.type}_end`,name:c,run_id:m.id,tags:o,metadata:u,data:{output:m.final_output}};d.includeEvent(f,m.type)&&(yield f)}}static isRunnable(e){return If(e)}withListeners({onStart:e,onEnd:n,onError:r}){return new fs({bound:this,config:{},configFactories:[s=>({callbacks:[new gy({config:s,onStart:e,onEnd:n,onError:r})]})]})}asTool(e){return QR(this,e)}}class fs extends pt{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const n=ug(this.config,...e);return ug(n,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(n))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,n){return this.bound.invoke(e,await this._mergeConfig(Be(n),this.kwargs))}async batch(e,n,r){const s=Array.isArray(n)?await Promise.all(n.map(async a=>this._mergeConfig(Be(a),this.kwargs))):await this._mergeConfig(Be(n),this.kwargs);return this.bound.batch(e,s,r)}async*_streamIterator(e,n){yield*this.bound._streamIterator(e,await this._mergeConfig(Be(n),this.kwargs))}async stream(e,n){return this.bound.stream(e,await this._mergeConfig(Be(n),this.kwargs))}async*transform(e,n){yield*this.bound.transform(e,await this._mergeConfig(Be(n),this.kwargs))}streamEvents(e,n,r){const s=this,a=async function*(){yield*s.bound.streamEvents(e,{...await s._mergeConfig(Be(n),s.kwargs),version:n.version},r)};return pn.fromAsyncGenerator(a())}static isRunnableBinding(e){return e.bound&&pt.isRunnable(e.bound)}withListeners({onStart:e,onEnd:n,onError:r}){return new fs({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new gy({config:s,onStart:e,onEnd:n,onError:r})]})]})}}class Yu extends pt{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Yu({bound:this.bound.bind(e)})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async _invoke(e,n,r){return this.bound.batch(e,Pt(n,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:n,onError:r}){return new Yu({bound:this.bound.withListeners({onStart:e,onEnd:n,onError:r})})}}class YR extends fs{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,n,r){const s=e>1?`retry:attempt:${e}`:void 0;return Pt(n,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,n,r){return Hu(s=>super.invoke(e,this._patchConfigForRetry(s,n,r)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async _batch(e,n,r,s){const a={};try{await Hu(async i=>{const o=e.map((p,m)=>m).filter(p=>a[p.toString()]===void 0||a[p.toString()]instanceof Error),u=o.map(p=>e[p]),c=o.map(p=>this._patchConfigForRetry(i,n==null?void 0:n[p],r==null?void 0:r[p])),l=await super.batch(u,c,{...s,returnExceptions:!0});let d;for(let p=0;p<l.length;p+=1){const m=l[p],f=o[p];m instanceof Error&&d===void 0&&(d=m,d.input=u[p]),a[f.toString()]=m}if(d)throw d;return l},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((s==null?void 0:s.returnExceptions)!==!0)throw i}return Object.keys(a).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>a[parseInt(i,10)])}async batch(e,n,r){return this._batchWithConfig(this._batch.bind(this),e,n,r)}}class cr extends pt{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,n){var u;const r=Be(n),s=await $n(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),At(e,"input"),r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i=e,o;try{const c=[this.first,...this.middle];for(let l=0;l<c.length;l+=1){const p=c[l].invoke(i,Pt(r,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));i=await Gr(p,n==null?void 0:n.signal)}if((u=n==null?void 0:n.signal)!=null&&u.aborted)throw new Error("Aborted");o=await this.last.invoke(i,Pt(r,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(At(o,"output"))),o}async batch(e,n,r){var u;const s=this._getOptionsList(n??{},e.length),a=await Promise.all(s.map($n)),i=await Promise.all(a.map(async(c,l)=>{const d=await(c==null?void 0:c.handleChainStart(this.toJSON(),At(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,d}));let o=e;try{for(let c=0;c<this.steps.length;c+=1){const d=this.steps[c].batch(o,i.map((p,m)=>{const f=p==null?void 0:p.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return Pt(s[m],{callbacks:f})}),r);o=await Gr(d,(u=s[0])==null?void 0:u.signal)}}catch(c){throw await Promise.all(i.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(i.map(c=>c==null?void 0:c.handleChainEnd(At(o,"output")))),o}async*_streamIterator(e,n){var d;const r=await $n(n),{runId:s,...a}=n??{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),At(e,"input"),s,void 0,void 0,void 0,a==null?void 0:a.runName)),o=[this.first,...this.middle,this.last];let u=!0,c;async function*l(){yield e}try{let p=o[0].transform(l(),Pt(a,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<o.length;m+=1)p=await o[m].transform(p,Pt(a,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of p)if((d=n==null?void 0:n.signal)==null||d.throwIfAborted(),yield m,u)if(c===void 0)c=m;else try{c=Hn(c,m)}catch{c=void 0,u=!1}}catch(p){throw await(i==null?void 0:i.handleChainError(p)),p}await(i==null?void 0:i.handleChainEnd(At(c,"output")))}getGraph(e){const n=new Vc;let r=null;return this.steps.forEach((s,a)=>{const i=s.getGraph(e);a!==0&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),n.extend(i);const o=i.firstNode();if(!o)throw new Error(`Runnable ${s} has no first node`);r&&n.addEdge(r,o),r=i.lastNode()}),n}pipe(e){return cr.isRunnableSequence(e)?new cr({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new cr({first:this.first,middle:[...this.middle,this.last],last:as(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&pt.isRunnable(e)}static from([e,...n],r){let s={};return typeof r=="string"?s.name=r:r!==void 0&&(s=r),new cr({...s,first:as(e),middle:n.slice(0,-1).map(as),last:as(n[n.length-1])})}}class Ta extends pt{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[n,r]of Object.entries(e.steps))this.steps[n]=as(r)}static from(e){return new Ta({steps:e})}async invoke(e,n){const r=Be(n),s=await $n(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;const i={};try{const o=Object.entries(this.steps).map(async([u,c])=>{i[u]=await c.invoke(e,Pt(r,{callbacks:a==null?void 0:a.getChild(`map:key:${u}`)}))});await Gr(Promise.all(o),n==null?void 0:n.signal)}catch(o){throw await(a==null?void 0:a.handleChainError(o)),o}return await(a==null?void 0:a.handleChainEnd(i)),i}async*_transform(e,n,r){const s={...this.steps},a=py(e,Object.keys(s).length),i=new Map(Object.entries(s).map(([o,u],c)=>{const l=u.transform(a[c],Pt(r,{callbacks:n==null?void 0:n.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){const o=Promise.race(i.values()),{key:u,result:c,gen:l}=await Gr(o,r==null?void 0:r.signal);i.delete(u),c.done||(yield{[u]:c.value},i.set(u,l.next().then(d=>({key:u,gen:l,result:d}))))}}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Be(n),a=new wa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class Nf extends pt{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Af(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,n){const[r]=this._getOptionsList(n??{},1),s=await $n(r),a=this.func(Pt(r,{callbacks:s}),e);return Gr(a,r==null?void 0:r.signal)}async*_streamIterator(e,n){var a,i;const[r]=this._getOptionsList(n??{},1),s=await this.invoke(e,n);if(ch(s)){for await(const o of s)(a=r==null?void 0:r.signal)==null||a.throwIfAborted(),yield o;return}if(KR(s)){for(;;){(i=r==null?void 0:r.signal)==null||i.throwIfAborted();const o=s.next();if(o.done)break;yield o.value}return}yield s}static from(e){return new Nf({func:e})}}function ZR(t){if(Af(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class co extends pt{static lc_name(){return"RunnableLambda"}constructor(e){if(Af(e.func))return Nf.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),ZR(e.func),this.func=e.func}static from(e){return new co({func:e})}async _invoke(e,n,r){return new Promise((s,a)=>{const i=Pt(n,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((n==null?void 0:n.recursionLimit)??Ql)-1});Wr.runWithConfig(ca(i),async()=>{var o,u;try{let c=await this.func(e,{...i});if(c&&pt.isRunnable(c)){if((n==null?void 0:n.recursionLimit)===0)throw new Error("Recursion limit reached.");c=await c.invoke(e,{...i,recursionLimit:(i.recursionLimit??Ql)-1})}else if(ch(c)){let l;for await(const d of lh(i,c))if((o=n==null?void 0:n.signal)==null||o.throwIfAborted(),l===void 0)l=d;else try{l=Hn(l,d)}catch{l=d}c=l}else if(bg(c)){let l;for(const d of _g(i,c))if((u=n==null?void 0:n.signal)==null||u.throwIfAborted(),l===void 0)l=d;else try{l=Hn(l,d)}catch{l=d}c=l}s(c)}catch(c){a(c)}})})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async*_transform(e,n,r){var o,u;let s;for await(const c of e)if(s===void 0)s=c;else try{s=Hn(s,c)}catch{s=c}const a=Pt(r,{callbacks:n==null?void 0:n.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??Ql)-1}),i=await new Promise((c,l)=>{Wr.runWithConfig(ca(a),async()=>{try{const d=await this.func(s,{...a,config:a});c(d)}catch(d){l(d)}})});if(i&&pt.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const c=await i.stream(s,a);for await(const l of c)yield l}else if(ch(i))for await(const c of lh(a,i))(o=r==null?void 0:r.signal)==null||o.throwIfAborted(),yield c;else if(bg(i))for(const c of _g(a,i))(u=r==null?void 0:r.signal)==null||u.throwIfAborted(),yield c;else yield i}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Be(n),a=new wa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class JR extends pt{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,n){const r=Be(n),s=await $n(r),{runId:a,...i}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),At(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName)),u=Pt(i,{callbacks:o==null?void 0:o.getChild()});return await Wr.runWithConfig(u,async()=>{var d;let l;for(const p of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{const m=await p.invoke(e,u);return await(o==null?void 0:o.handleChainEnd(At(m,"output"))),m}catch(m){l===void 0&&(l=m)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,n){var d;const r=Be(n),s=await $n(r),{runId:a,...i}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),At(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName));let u,c;for(const p of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();const m=Pt(i,{callbacks:o==null?void 0:o.getChild()});try{const f=await p.stream(e,m);c=lh(m,f);break}catch(f){u===void 0&&(u=f)}}if(c===void 0){const p=u??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(p)),p}let l;try{for await(const p of c){yield p;try{l=l===void 0?l:Hn(l,p)}catch{l=void 0}}}catch(p){throw await(o==null?void 0:o.handleChainError(p)),p}await(o==null?void 0:o.handleChainEnd(At(l,"output")))}async batch(e,n,r){var u;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(n??{},e.length),a=await Promise.all(s.map(c=>$n(c))),i=await Promise.all(a.map(async(c,l)=>{const d=await(c==null?void 0:c.handleChainStart(this.toJSON(),At(e[l],"input"),s[l].runId,void 0,void 0,void 0,s[l].runName));return delete s[l].runId,d}));let o;for(const c of this.runnables()){(u=s[0].signal)==null||u.throwIfAborted();try{const l=await c.batch(e,i.map((d,p)=>Pt(s[p],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(i.map((d,p)=>d==null?void 0:d.handleChainEnd(At(l[p],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function as(t){if(typeof t=="function")return new co({func:t});if(pt.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[n,r]of Object.entries(t))e[n]=as(r);return new Ta({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class Ty extends pt{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Ta&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,n){const r=await this.mapper.invoke(e,n);return{...e,...r}}async*_transform(e,n,r){const s=this.mapper.getStepsKeys(),[a,i]=py(e),o=this.mapper.transform(i,Pt(r,{callbacks:n==null?void 0:n.getChild()})),u=o.next();for await(const c of a){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([d])=>!s.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Be(n),a=new wa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class XR extends pt{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const n=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return n.length===0?void 0:Object.fromEntries(n)}}async invoke(e,n){return this._callWithConfig(this._pick.bind(this),e,n)}async*_transform(e){for await(const n of e){const r=await this._pick(n);r!==void 0&&(yield r)}}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Be(n),a=new wa({generator:this.transform(r(),s),config:s});return await a.setup,pn.fromAsyncGenerator(a)}}class yg extends fs{constructor(e){const n=cr.from([co.from(async r=>{let s;if(hf(r))try{s=await this.schema.parseAsync(r.args)}catch{throw new R_("Received tool input did not match expected schema",JSON.stringify(r.args))}else s=r;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:n,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function QR(t,e){var s;const n=e.name??t.getName(),r=e.description??((s=e.schema)==null?void 0:s.description);return e.schema.constructor===Ar.ZodString?new yg({name:n,description:r,schema:Ar.object({input:Ar.string()}).transform(a=>a.input),bound:t}):new yg({name:n,description:r,schema:e.schema,bound:t})}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var eP=typeof window=="object"?window:{},Ae="0123456789abcdef".split(""),tP=[-2147483648,8388608,32768,128],kn=[24,16,8,0],wt=[];function Vn(t){t?(wt[0]=wt[16]=wt[1]=wt[2]=wt[3]=wt[4]=wt[5]=wt[6]=wt[7]=wt[8]=wt[9]=wt[10]=wt[11]=wt[12]=wt[13]=wt[14]=wt[15]=0,this.blocks=wt):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Vn.prototype.update=function(t){if(!this.finalized){var e=typeof t!="string";e&&t.constructor===eP.ArrayBuffer&&(t=new Uint8Array(t));for(var n,r=0,s,a=t.length||0,i=this.blocks;r<a;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(s=this.start;r<a&&s<64;++r)i[s>>2]|=t[r]<<kn[s++&3];else for(s=this.start;r<a&&s<64;++r)n=t.charCodeAt(r),n<128?i[s>>2]|=n<<kn[s++&3]:n<2048?(i[s>>2]|=(192|n>>6)<<kn[s++&3],i[s>>2]|=(128|n&63)<<kn[s++&3]):n<55296||n>=57344?(i[s>>2]|=(224|n>>12)<<kn[s++&3],i[s>>2]|=(128|n>>6&63)<<kn[s++&3],i[s>>2]|=(128|n&63)<<kn[s++&3]):(n=65536+((n&1023)<<10|t.charCodeAt(++r)&1023),i[s>>2]|=(240|n>>18)<<kn[s++&3],i[s>>2]|=(128|n>>12&63)<<kn[s++&3],i[s>>2]|=(128|n>>6&63)<<kn[s++&3],i[s>>2]|=(128|n&63)<<kn[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=i[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Vn.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>2]|=tP[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}};Vn.prototype.hash=function(){var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,a,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)a=e&n|~e&r,o=t<<5|t>>>27,s=o+a+s+1518500249+u[i]<<0,e=e<<30|e>>>2,a=t&e|~t&n,o=s<<5|s>>>27,r=o+a+r+1518500249+u[i+1]<<0,t=t<<30|t>>>2,a=s&t|~s&e,o=r<<5|r>>>27,n=o+a+n+1518500249+u[i+2]<<0,s=s<<30|s>>>2,a=r&s|~r&t,o=n<<5|n>>>27,e=o+a+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,a=n&r|~n&s,o=e<<5|e>>>27,t=o+a+t+1518500249+u[i+4]<<0,n=n<<30|n>>>2;for(;i<40;i+=5)a=e^n^r,o=t<<5|t>>>27,s=o+a+s+1859775393+u[i]<<0,e=e<<30|e>>>2,a=t^e^n,o=s<<5|s>>>27,r=o+a+r+1859775393+u[i+1]<<0,t=t<<30|t>>>2,a=s^t^e,o=r<<5|r>>>27,n=o+a+n+1859775393+u[i+2]<<0,s=s<<30|s>>>2,a=r^s^t,o=n<<5|n>>>27,e=o+a+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,a=n^r^s,o=e<<5|e>>>27,t=o+a+t+1859775393+u[i+4]<<0,n=n<<30|n>>>2;for(;i<60;i+=5)a=e&n|e&r|n&r,o=t<<5|t>>>27,s=o+a+s-1894007588+u[i]<<0,e=e<<30|e>>>2,a=t&e|t&n|e&n,o=s<<5|s>>>27,r=o+a+r-1894007588+u[i+1]<<0,t=t<<30|t>>>2,a=s&t|s&e|t&e,o=r<<5|r>>>27,n=o+a+n-1894007588+u[i+2]<<0,s=s<<30|s>>>2,a=r&s|r&t|s&t,o=n<<5|n>>>27,e=o+a+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,a=n&r|n&s|r&s,o=e<<5|e>>>27,t=o+a+t-1894007588+u[i+4]<<0,n=n<<30|n>>>2;for(;i<80;i+=5)a=e^n^r,o=t<<5|t>>>27,s=o+a+s-899497514+u[i]<<0,e=e<<30|e>>>2,a=t^e^n,o=s<<5|s>>>27,r=o+a+r-899497514+u[i+1]<<0,t=t<<30|t>>>2,a=s^t^e,o=r<<5|r>>>27,n=o+a+n-899497514+u[i+2]<<0,s=s<<30|s>>>2,a=r^s^t,o=n<<5|n>>>27,e=o+a+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,a=n^r^s,o=e<<5|e>>>27,t=o+a+t-899497514+u[i+4]<<0,n=n<<30|n>>>2;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+n<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0};Vn.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4;return Ae[t>>28&15]+Ae[t>>24&15]+Ae[t>>20&15]+Ae[t>>16&15]+Ae[t>>12&15]+Ae[t>>8&15]+Ae[t>>4&15]+Ae[t&15]+Ae[e>>28&15]+Ae[e>>24&15]+Ae[e>>20&15]+Ae[e>>16&15]+Ae[e>>12&15]+Ae[e>>8&15]+Ae[e>>4&15]+Ae[e&15]+Ae[n>>28&15]+Ae[n>>24&15]+Ae[n>>20&15]+Ae[n>>16&15]+Ae[n>>12&15]+Ae[n>>8&15]+Ae[n>>4&15]+Ae[n&15]+Ae[r>>28&15]+Ae[r>>24&15]+Ae[r>>20&15]+Ae[r>>16&15]+Ae[r>>12&15]+Ae[r>>8&15]+Ae[r>>4&15]+Ae[r&15]+Ae[s>>28&15]+Ae[s>>24&15]+Ae[s>>20&15]+Ae[s>>16&15]+Ae[s>>12&15]+Ae[s>>8&15]+Ae[s>>4&15]+Ae[s&15]};Vn.prototype.toString=Vn.prototype.hex;Vn.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4;return[t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,n>>24&255,n>>16&255,n>>8&255,n&255,r>>24&255,r>>16&255,r>>8&255,r&255,s>>24&255,s>>16&255,s>>8&255,s&255]};Vn.prototype.array=Vn.prototype.digest;Vn.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(20),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),t};const nP=t=>new Vn(!0).update(t).hex(),Eg=(...t)=>nP(t.join("_"));class rP{}const sP=new Map;class kf extends rP{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,n){return Promise.resolve(this.cache.get(Eg(e,n))??null)}async update(e,n,r){this.cache.set(Eg(e,n),r)}static global(){return new kf(sP)}}class Sy extends $r{}class aP extends Sy{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new or(this.value)]}}class iP extends Sy{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return P_(this.messages)}toChatMessages(){return this.messages}}var zc={};zc.byteLength=cP;zc.toByteArray=dP;zc.fromByteArray=mP;var ar=[],En=[],oP=typeof Uint8Array<"u"?Uint8Array:Array,rd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Ms=0,uP=rd.length;Ms<uP;++Ms)ar[Ms]=rd[Ms],En[rd.charCodeAt(Ms)]=Ms;En[45]=62;En[95]=63;function Ay(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function cP(t){var e=Ay(t),n=e[0],r=e[1];return(n+r)*3/4-r}function lP(t,e,n){return(e+n)*3/4-n}function dP(t){var e,n=Ay(t),r=n[0],s=n[1],a=new oP(lP(t,r,s)),i=0,o=s>0?r-4:r,u;for(u=0;u<o;u+=4)e=En[t.charCodeAt(u)]<<18|En[t.charCodeAt(u+1)]<<12|En[t.charCodeAt(u+2)]<<6|En[t.charCodeAt(u+3)],a[i++]=e>>16&255,a[i++]=e>>8&255,a[i++]=e&255;return s===2&&(e=En[t.charCodeAt(u)]<<2|En[t.charCodeAt(u+1)]>>4,a[i++]=e&255),s===1&&(e=En[t.charCodeAt(u)]<<10|En[t.charCodeAt(u+1)]<<4|En[t.charCodeAt(u+2)]>>2,a[i++]=e>>8&255,a[i++]=e&255),a}function hP(t){return ar[t>>18&63]+ar[t>>12&63]+ar[t>>6&63]+ar[t&63]}function fP(t,e,n){for(var r,s=[],a=e;a<n;a+=3)r=(t[a]<<16&16711680)+(t[a+1]<<8&65280)+(t[a+2]&255),s.push(hP(r));return s.join("")}function mP(t){for(var e,n=t.length,r=n%3,s=[],a=16383,i=0,o=n-r;i<o;i+=a)s.push(fP(t,i,i+a>o?o:i+a));return r===1?(e=t[n-1],s.push(ar[e>>2]+ar[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(ar[e>>10]+ar[e>>4&63]+ar[e<<2&63]+"=")),s.join("")}var pP=Object.defineProperty,gP=(t,e,n)=>e in t?pP(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,bP=(t,e,n)=>(gP(t,e+"",n),n);function _P(t,e){let n=Array.from({length:t.length},(r,s)=>({start:s,end:s+1}));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const a=t.slice(n[s].start,n[s+1].end),i=e.get(a.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,s])}if(r!=null){const s=r[1];n[s]={start:n[s].start,end:n[s+1].end},n.splice(s+1,1)}else break}return n}function yP(t,e){return t.length===1?[e.get(t.join(","))]:_P(t,e).map(n=>e.get(t.slice(n.start,n.end).join(","))).filter(n=>n!=null)}function EP(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var dh=class{constructor(t,e){ve(this,"specialTokens");ve(this,"inverseSpecialTokens");ve(this,"patStr");ve(this,"textEncoder",new TextEncoder);ve(this,"textDecoder",new TextDecoder("utf-8"));ve(this,"rankMap",new Map);ve(this,"textMap",new Map);this.patStr=t.pat_str;const n=t.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[a,i,...o]=s.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(const[r,s]of Object.entries(n)){const a=zc.toByteArray(r);this.rankMap.set(a.join(","),s),this.textMap.set(s,a)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,a])=>(r[a]=this.textEncoder.encode(s),r),{})}encode(t,e=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=dh.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(n==="all"?Object.keys(this.specialTokens).filter(c=>!i.has(c)):n);if(o.size>0){const c=dh.specialTokenRegex([...o]),l=t.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;s.lastIndex=l,c=s.exec(t),!(c==null||i.has(c[0]));)l=c.index+1;const d=(c==null?void 0:c.index)??t.length;for(const m of t.substring(u,d).matchAll(r)){const f=this.textEncoder.encode(m[0]),g=this.rankMap.get(f.join(","));if(g!=null){a.push(g);continue}a.push(...yP(f,this.rankMap))}if(c==null)break;let p=this.specialTokens[c[0]];a.push(p),u=c.index+c[0].length}return a}decode(t){const e=[];let n=0;for(let a=0;a<t.length;++a){const i=t[a],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),n+=o.length)}const r=new Uint8Array(n);let s=0;for(const a of e)r.set(a,s),s+=a.length;return this.textDecoder.decode(r)}},Cy=dh;bP(Cy,"specialTokenRegex",t=>new RegExp(t.map(e=>EP(e)).join("|"),"g"));function wP(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}const Zo={},TP=new vf({});async function SP(t){return t in Zo||(Zo[t]=TP.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new Cy(e)).catch(e=>{throw delete Zo[t],e})),await Zo[t]}async function AP(t){return SP(wP(t))}const CP=t=>t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t.startsWith("gpt-4o")?"gpt-4o":t;function Oy(t){return typeof t!="object"||!t?!1:!!("type"in t&&t.type==="function"&&"function"in t&&typeof t.function=="object"&&t.function&&"name"in t.function&&"parameters"in t.function)}const OP=()=>!1;class vy extends pt{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??OP(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class vP extends vy{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:n,...r}){const{cache:s,...a}=r;super({callbacks:e??n,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof s=="object"?this.cache=s:s?this.cache=kf.global():this.cache=void 0,this.caller=new vf(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let n=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await AP("modelName"in this?CP(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{n=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new aP(e):Array.isArray(e)?new iP(e.map(Ya)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...n}){const r={...this._identifyingParams(),...n,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class da extends pt{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,n){const r=Be(n);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,n){const r=Be(n);let s,a=!0;for await(const i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,a)if(s===void 0)s=i;else try{s=Hn(s,i)}catch{s=void 0,a=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new Ty(new Ta({steps:e}))}}function Rf(t){return typeof(t==null?void 0:t.parse)=="function"}class Sr extends vP{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[n,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=n.signal,[n,r]}async invoke(e,n){const r=Sr._convertInputToPromptValue(e);return(await this.generatePrompt([r],n,n==null?void 0:n.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,n,r){throw new Error("Not implemented.")}async*_streamIterator(e,n){var r;if(this._streamResponseChunks===Sr.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,n);else{const a=Sr._convertInputToPromptValue(e).toChatMessages(),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(n),u={...i.metadata,...this.getLsParams(o)},c=await Lt.configure(i.callbacks,this.callbacks,i.tags,this.tags,u,this.metadata,{verbose:this.verbose}),l={options:o,invocation_params:this==null?void 0:this.invocationParams(o),batch_size:1},d=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[a],i.runId,void 0,l,void 0,void 0,i.runName));let p,m;try{for await(const f of this._streamResponseChunks(a,o,d==null?void 0:d[0])){if(f.message.id==null){const g=(r=d==null?void 0:d.at(0))==null?void 0:r.runId;g!=null&&f.message._updateId(`run-${g}`)}f.message.response_metadata={...f.generationInfo,...f.message.response_metadata},yield f.message,p?p=p.concat(f):p=f,vp(f.message)&&f.message.usage_metadata!==void 0&&(m={tokenUsage:{promptTokens:f.message.usage_metadata.input_tokens,completionTokens:f.message.usage_metadata.output_tokens,totalTokens:f.message.usage_metadata.total_tokens}})}}catch(f){throw await Promise.all((d??[]).map(g=>g==null?void 0:g.handleLLMError(f))),f}await Promise.all((d??[]).map(f=>f==null?void 0:f.handleLLMEnd({generations:[[p]],llmOutput:m})))}}getLsParams(e){const n=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:n}}async _generateUncached(e,n,r,s){var d,p;const a=e.map(m=>m.map(Ya));let i;if(s!==void 0&&s.length===a.length)i=s;else{const m={...r.metadata,...this.getLsParams(n)},f=await Lt.configure(r.callbacks,this.callbacks,r.tags,this.tags,m,this.metadata,{verbose:this.verbose}),g={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:1};i=await(f==null?void 0:f.handleChatModelStart(this.toJSON(),a,r.runId,void 0,g,void 0,void 0,r.runName))}const o=[],u=[];if(!!(i!=null&&i[0].handlers.find(Ik))&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==Sr.prototype._streamResponseChunks)try{const m=await this._streamResponseChunks(a[0],n,i==null?void 0:i[0]);let f,g;for await(const b of m){if(b.message.id==null){const _=(d=i==null?void 0:i.at(0))==null?void 0:d.runId;_!=null&&b.message._updateId(`run-${_}`)}f===void 0?f=b:f=Hn(f,b),vp(b.message)&&b.message.usage_metadata!==void 0&&(g={tokenUsage:{promptTokens:b.message.usage_metadata.input_tokens,completionTokens:b.message.usage_metadata.output_tokens,totalTokens:b.message.usage_metadata.total_tokens}})}if(f===void 0)throw new Error("Received empty response from chat model call.");o.push([f]),await(i==null?void 0:i[0].handleLLMEnd({generations:o,llmOutput:g}))}catch(m){throw await(i==null?void 0:i[0].handleLLMError(m)),m}else{const m=await Promise.allSettled(a.map((f,g)=>this._generate(f,{...n,promptIndex:g},i==null?void 0:i[g])));await Promise.all(m.map(async(f,g)=>{var b,_,E;if(f.status==="fulfilled"){const T=f.value;for(const N of T.generations){if(N.message.id==null){const v=(b=i==null?void 0:i.at(0))==null?void 0:b.runId;v!=null&&N.message._updateId(`run-${v}`)}N.message.response_metadata={...N.generationInfo,...N.message.response_metadata}}return T.generations.length===1&&(T.generations[0].message.response_metadata={...T.llmOutput,...T.generations[0].message.response_metadata}),o[g]=T.generations,u[g]=T.llmOutput,(_=i==null?void 0:i[g])==null?void 0:_.handleLLMEnd({generations:[T.generations],llmOutput:T.llmOutput})}else return await((E=i==null?void 0:i[g])==null?void 0:E.handleLLMError(f.reason)),Promise.reject(f.reason)}))}const l={generations:o,llmOutput:u.length?(p=this._combineLLMOutput)==null?void 0:p.call(this,...u):void 0};return Object.defineProperty(l,hg,{value:i?{runIds:i==null?void 0:i.map(m=>m.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:n,llmStringKey:r,parsedOptions:s,handledOptions:a}){const i=e.map(b=>b.map(Ya)),o={...a.metadata,...this.getLsParams(s)},u=await Lt.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1},l=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),i,a.runId,void 0,c,void 0,void 0,a.runName)),d=[],m=(await Promise.allSettled(i.map(async(b,_)=>{const E=Sr._convertInputToPromptValue(b).toString(),T=await n.lookup(E,r);return T==null&&d.push(_),T}))).map((b,_)=>({result:b,runManager:l==null?void 0:l[_]})).filter(({result:b})=>b.status==="fulfilled"&&b.value!=null||b.status==="rejected"),f=[];await Promise.all(m.map(async({result:b,runManager:_},E)=>{if(b.status==="fulfilled"){const T=b.value;return f[E]=T.map(N=>("message"in N&&Rc(N.message)&&ro(N.message)&&(N.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),N.generationInfo={...N.generationInfo,tokenUsage:{}},N)),T.length&&await(_==null?void 0:_.handleLLMNewToken(T[0].text)),_==null?void 0:_.handleLLMEnd({generations:[T]},void 0,void 0,void 0,{cached:!0})}else return await(_==null?void 0:_.handleLLMError(b.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(b.reason)}));const g={generations:f,missingPromptIndices:d,startedRunManagers:l};return Object.defineProperty(g,hg,{value:l?{runIds:l==null?void 0:l.map(b=>b.runId)}:void 0,configurable:!0}),g}async generate(e,n,r){let s;Array.isArray(n)?s={stop:n}:s=n;const a=e.map(f=>f.map(Ya)),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(s);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(a,o,i);const{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d,startedRunManagers:p}=await this._generateCached({messages:a,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i});let m={};if(d.length>0){const f=await this._generateUncached(d.map(g=>a[g]),o,i,p!==void 0?d.map(g=>p==null?void 0:p[g]):void 0);await Promise.all(f.generations.map(async(g,b)=>{const _=d[b];l[_]=g;const E=Sr._convertInputToPromptValue(a[_]).toString();return u.update(E,c,g)})),m=f.llmOutput??{}}return{generations:l,llmOutput:m}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,n,r){const s=e.map(a=>a.toChatMessages());return this.generate(s,n,r)}async call(e,n,r){return(await this.generate([e.map(Ya)],n,r)).generations[0][0].message}async callPrompt(e,n,r){const s=e.toChatMessages();return this.call(s,n,r)}async predictMessages(e,n,r){return this.call(e,n,r)}async predict(e,n,r){const s=new or(e),a=await this.call([s],n,r);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,n){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(n!=null&&n.strict)throw new Error('"strict" mode is not supported for this model by default.');const r=e,s=n==null?void 0:n.name,a=r.description??"A function available to call.",i=n==null?void 0:n.method,o=n==null?void 0:n.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=s??"extract",c;Rf(r)?c=[{type:"function",function:{name:u,description:a,parameters:Ts(r)}}]:("name"in r&&(u=r.name),c=[{type:"function",function:{name:u,description:a,parameters:r}}]);const l=this.bindTools(c),d=co.from(g=>{if(!g.tool_calls||g.tool_calls.length===0)throw new Error("No tool calls found in the response.");const b=g.tool_calls.find(_=>_.name===u);if(!b)throw new Error(`No tool call found with name ${u}.`);return b.args});if(!o)return l.pipe(d).withConfig({runName:"StructuredOutput"});const p=da.assign({parsed:(g,b)=>d.invoke(g.raw,b)}),m=da.assign({parsed:()=>null}),f=p.withFallbacks({fallbacks:[m]});return cr.from([{raw:l},f]).withConfig({runName:"StructuredOutputRunnable"})}}function IP(t,e){const n=typeof e=="number"?void 0:e;return{name:t.name,description:t.description,parameters:Ts(t.schema),...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}}function NP(t){return t!==void 0&&Array.isArray(t.lc_namespace)}function kP(t){return t!==void 0&&pt.isRunnable(t)&&"lc_name"in t.constructor&&typeof t.constructor.lc_name=="function"&&t.constructor.lc_name()==="RunnableToolLike"}function RP(t){return!!t&&typeof t=="object"&&"name"in t&&"schema"in t&&Rf(t.schema)}function Iy(t){return RP(t)||kP(t)||NP(t)}class Ny extends pt{parseResultWithPrompt(e,n,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,n){return typeof e=="string"?this._callWithConfig(async(r,s)=>this.parseResult([{text:r}],s==null?void 0:s.callbacks),e,{...n,runType:"parser"}):this._callWithConfig(async(r,s)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],s==null?void 0:s.callbacks),e,{...n,runType:"parser"})}}class ky extends Ny{parseResult(e,n){return this.parse(e[0].text,n)}async parseWithPrompt(e,n,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class ji extends Error{constructor(e,n,r,s=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=n,this.observation=r,this.sendToLLM=s,s&&(r===void 0||n===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");k_(this,"OUTPUT_PARSING_FAILURE")}}function hh(t,e){const n=typeof t;if(n!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const r=t.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!hh(t[s],e[s]))return!1;return!0}if(n==="object"){if(!t||!e)return t===e;const r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(const i of r)if(!hh(t[i],e[i]))return!1;return!0}return t===e}class PP extends ky{async*_transform(e){for await(const n of e)typeof n=="string"?yield this.parseResult([{text:n}]):yield this.parseResult([{message:n,text:this._baseMessageToString(n)}])}async*transform(e,n){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...n,runType:"parser"})}}class Ry extends PP{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let n,r;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let a;if(uC(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new ws({message:s,text:s.content})}else if(Rc(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new ws({message:fC(s),text:s.content})}else a=new la({text:s});r===void 0?r=a:r=r.concat(a);const i=await this.parsePartialResult([r]);i!=null&&!hh(i,n)&&(this.diff?yield this._diff(n,i):yield i,n=i)}}getFormatInstructions(){return""}}class wg extends ky{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const n=Ar.object(Object.fromEntries(Object.entries(e).map(([r,s])=>[r,Ar.string().describe(s)])));return new this(n)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Ts(this.schema))}
\`\`\`
`}async parse(e){try{const r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(s,a)=>`"${a.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(n){throw new ji(`Failed to parse. Text: "${e}". Error: ${n}`,e)}}}class Tg extends Ry{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,n){if(n)return e?Ek(e,n):[{op:"replace",path:"",value:n}]}async parsePartialResult(e){return Tp(e[0].text)}async parse(e){return Tp(e,JSON.parse)}getFormatInstructions(){return""}}class Sg extends Ny{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){let n=e;if(typeof e=="string")try{n=JSON.parse(e)}catch(s){throw new ji(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(s.message)}`,e)}else n=e;if(this.zodSchema===void 0)return n;const r=await this.zodSchema.safeParseAsync(n);if(r.success)return r.data;throw new ji(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(r.error.errors)}`,JSON.stringify(n,null,2))}async parseResult(e){const n=e.flatMap(a=>{const{message:i}=a;return Array.isArray(i.content)?Py(i.content)[0]:[]});if(n[0]===void 0)throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");const[r]=n;return await this._validateResult(r.args)}}function Py(t){const e=[];for(const n of t)n.type==="tool_use"&&e.push({name:n.name,args:n.input,id:n.id,type:"tool_call"});return e}function xP(t){if(t)return t==="any"?{type:"any"}:t==="auto"?{type:"auto"}:typeof t=="string"?{type:"tool",name:t}:t}function Ag(t){const e=/^data:(image\/.+);base64,(.+)$/,n=t.match(e);if(n===null)throw new Error(["Anthropic only supports base64-encoded images currently.","Example: data:image/png;base64,/9j/4AAQSk..."].join(`

`));return{type:"base64",media_type:n[1]??"",data:n[2]??""}}function LP(t){const e=[];for(const n of t)if(n._getType()==="tool")if(typeof n.content=="string"){const r=e[e.length-1];(r==null?void 0:r._getType())==="human"&&Array.isArray(r.content)&&"type"in r.content[0]&&r.content[0].type==="tool_result"?r.content.push({type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}):e.push(new or({content:[{type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}]}))}else e.push(new or({content:[{type:"tool_result",content:fh(n.content),tool_use_id:n.tool_call_id}]}));else e.push(n);return e}function Cg(t){if(t.id===void 0)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:t.id,name:t.name,input:t.args}}function fh(t){const e=["tool_use","tool_result","input_json_delta"],n=["text","text_delta"];return typeof t=="string"?t:t.map(s=>{const a="cache_control"in s?s.cache_control:void 0;if(s.type==="image_url"){let i;return typeof s.image_url=="string"?i=Ag(s.image_url):i=Ag(s.image_url.url),{type:"image",source:i,...a?{cache_control:a}:{}}}else{if(s.type==="document")return{type:"document",source:s.source,...a?{cache_control:a}:{}};if(n.find(i=>i===s.type)&&"text"in s)return{type:"text",text:s.text,...a?{cache_control:a}:{}};if(e.find(i=>i===s.type)){const i={...s};if("index"in i&&delete i.index,i.type==="input_json_delta"&&(i.type="tool_use"),"input"in i)try{i.input=JSON.parse(i.input)}catch{}return{...i,...a?{cache_control:a}:{}}}else throw new Error("Unsupported message content format")}})}function Og(t){const e=LP(t);let n;e.length>0&&e[0]._getType()==="system"&&(n=t[0].content);const s=(n!==void 0?e.slice(1):e).map(a=>{var o;let i;if(a._getType()==="human")i="user";else if(a._getType()==="ai")i="assistant";else if(a._getType()==="tool")i="user";else throw a._getType()==="system"?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${a._getType()}" is not supported.`);if(ro(a)&&((o=a.tool_calls)!=null&&o.length)){if(typeof a.content=="string")return a.content===""?{role:i,content:a.tool_calls.map(Cg)}:{role:i,content:[{type:"text",text:a.content},...a.tool_calls.map(Cg)]};{const{content:u}=a;return!a.tool_calls.every(l=>u.find(d=>(d.type==="tool_use"||d.type==="input_json_delta")&&d.id===l.id))&&console.warn('The "tool_calls" field on a message is only respected if content is a string.'),{role:i,content:fh(a.content)}}}else return{role:i,content:fh(a.content)}});return{messages:DP(s),system:n}}function DP(t){if(!t||t.length<=1)return t;const e=[];let n=t[0];const r=a=>typeof a=="string"?[{type:"text",text:a}]:a,s=a=>a.role!=="user"||typeof a.content=="string"?!1:Array.isArray(a.content)&&a.content.every(i=>i.type==="tool_result");for(let a=1;a<t.length;a+=1){const i=t[a];s(n)&&s(i)?n={...n,content:[...r(n.content),...r(i.content)]}:(e.push(n),n=i)}return e.push(n),e}function MP(t,e){var n,r;if(t.type==="message_start"){const{content:s,usage:a,...i}=t.message,o={};for(const[p,m]of Object.entries(i))m!=null&&(o[p]=m);const{input_tokens:u,output_tokens:c,...l}=a??{},d={input_tokens:u,output_tokens:c,total_tokens:u+c,input_token_details:{cache_creation:l.cache_creation_input_tokens,cache_read:l.cache_read_input_tokens}};return{chunk:new Yt({content:e.coerceContentToString?"":[],additional_kwargs:o,usage_metadata:e.streamUsage?d:void 0,response_metadata:{usage:{...l}},id:t.message.id})}}else if(t.type==="message_delta"){const s={input_tokens:0,output_tokens:t.usage.output_tokens,total_tokens:t.usage.output_tokens,input_token_details:{cache_creation:t.usage.cache_creation_input_tokens,cache_read:t.usage.cache_read_input_tokens}};return{chunk:new Yt({content:e.coerceContentToString?"":[],additional_kwargs:{...t.delta},usage_metadata:e.streamUsage?s:void 0})}}else if(t.type==="content_block_start"&&t.content_block.type==="tool_use"){const s=t.content_block;return{chunk:new Yt({content:e.coerceContentToString?"":[{index:t.index,...t.content_block,input:""}],additional_kwargs:{},tool_call_chunks:[{id:s.id,index:t.index,name:s.name,args:""}]})}}else if(t.type==="content_block_delta"&&t.delta.type==="text_delta"){const s=(n=t.delta)==null?void 0:n.text;if(s!==void 0)return{chunk:new Yt({content:e.coerceContentToString?s:[{index:t.index,...t.delta}],additional_kwargs:{}})}}else{if(t.type==="content_block_delta"&&t.delta.type==="input_json_delta")return{chunk:new Yt({content:e.coerceContentToString?"":[{index:t.index,input:t.delta.partial_json,type:t.delta.type}],additional_kwargs:{},tool_call_chunks:[{index:t.index,args:t.delta.partial_json}]})};if(t.type==="content_block_start"&&t.content_block.type==="text"){const s=(r=t.content_block)==null?void 0:r.text;if(s!==void 0)return{chunk:new Yt({content:e.coerceContentToString?s:[{index:t.index,...t.content_block}],additional_kwargs:{}})}}}return null}function BP(t,e){const n=e.usage,r=n!=null?{input_tokens:n.input_tokens??0,output_tokens:n.output_tokens??0,total_tokens:(n.input_tokens??0)+(n.output_tokens??0),input_token_details:{cache_creation:n.cache_creation_input_tokens,cache_read:n.cache_read_input_tokens}}:void 0;if(t.length===1&&t[0].type==="text")return[{text:t[0].text,message:new bs({content:t[0].text,additional_kwargs:e,usage_metadata:r,response_metadata:e,id:e.id})}];{const s=Py(t);return[{text:"",message:new bs({content:t,additional_kwargs:e,tool_calls:s,usage_metadata:r,response_metadata:e,id:e.id})}]}}function Jo(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function vg(t){let e;return t.status===400&&t.message.includes("tool")?e=Jo(t,"INVALID_TOOL_RESULTS"):t.status===401?e=Jo(t,"MODEL_AUTHENTICATION"):t.status===404?e=Jo(t,"MODEL_NOT_FOUND"):t.status===429?e=Jo(t,"MODEL_RATE_LIMIT"):e=t,e}function FP(t){return!!(t.tools&&t.tools.length>0)}function UP(t){return"input_schema"in t}function jP(t){if(typeof t.content=="string")return t.content;if(Array.isArray(t.content)&&t.content.length>=1&&"input"in t.content[0])return typeof t.content[0].input=="string"?t.content[0].input:JSON.stringify(t.content[0].input);if(Array.isArray(t.content)&&t.content.length>=1&&"text"in t.content[0])return t.content[0].text}class $P extends Sr{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"createClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.anthropicApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.anthropicApiKey)??fn("ANTHROPIC_API_KEY"),!this.anthropicApiKey&&!(e!=null&&e.createClient))throw new Error("Anthropic API key not found");this.clientOptions=(e==null?void 0:e.clientOptions)??{},this.apiKey=this.anthropicApiKey,this.apiUrl=e==null?void 0:e.anthropicApiUrl,this.modelName=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.model=this.modelName,this.invocationKwargs=(e==null?void 0:e.invocationKwargs)??{},this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topK=(e==null?void 0:e.topK)??this.topK,this.topP=(e==null?void 0:e.topP)??this.topP,this.maxTokens=(e==null?void 0:e.maxTokensToSample)??(e==null?void 0:e.maxTokens)??this.maxTokens,this.stopSequences=(e==null?void 0:e.stopSequences)??this.stopSequences,this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.createClient=(e==null?void 0:e.createClient)??(n=>new tt(n))}getLsParams(e){const n=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:n.temperature??void 0,ls_max_tokens:n.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(!(!e||!e.length))return e.map(n=>{if(UP(n))return n;if(Oy(n))return{name:n.function.name,description:n.function.description,input_schema:n.function.parameters};if(Iy(n))return{name:n.name,description:n.description,input_schema:Ts(n.schema)};throw new Error(`Unknown tool type passed to ChatAnthropic: ${JSON.stringify(n,null,2)}`)})}bindTools(e,n){return this.bind({tools:this.formatStructuredToolToAnthropic(e),...n})}invocationParams(e){const n=xP(e==null?void 0:e.tool_choice);return{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:(e==null?void 0:e.stop)??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e==null?void 0:e.tools),tool_choice:n,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,n,r){var u;const s=this.invocationParams(n),a=Og(e),i=!FP({...s,...a,stream:!1}),o=await this.createStreamWithRetry({...s,...a,stream:!0},{headers:n.headers});for await(const c of o){if((u=n.signal)!=null&&u.aborted)throw o.controller.abort(),new Error("AbortError: User aborted the request.");const l=this.streamUsage??n.streamUsage,d=MP(c,{streamUsage:l,coerceContentToString:i});if(!d)continue;const{chunk:p}=d,m=jP(p),f=new ws({message:new Yt({content:p.content,additional_kwargs:p.additional_kwargs,tool_call_chunks:p.tool_call_chunks,usage_metadata:l?p.usage_metadata:void 0,response_metadata:p.response_metadata,id:p.id}),text:m??""});yield f,await(r==null?void 0:r.handleLLMNewToken(m??"",void 0,void 0,void 0,void 0,{chunk:f}))}}async _generateNonStreaming(e,n,r){const s=await this.completionWithRetry({...n,stream:!1,...Og(e)},r),{content:a,...i}=s,o=BP(a,i),{role:u,type:c,...l}=i;return{generations:o,llmOutput:l}}async _generate(e,n,r){if(this.stopSequences&&n.stop)throw new Error('"stopSequence" parameter found in input and default params');const s=this.invocationParams(n);if(s.stream){let a;const i=this._streamResponseChunks(e,n,r);for await(const o of i)a===void 0?a=o:a=a.concat(o);if(a===void 0)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:a.text,message:a.message}]}}else return this._generateNonStreaming(e,s,{signal:n.signal,headers:n.headers})}async createStreamWithRetry(e,n){if(!this.streamingClient){const s=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...s,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},n)}catch(s){throw vg(s)}};return this.caller.call(r)}async completionWithRetry(e,n){if(!this.batchClient){const s=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.batchClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...s,apiKey:this.apiKey,maxRetries:0})}const r=async()=>{try{return await this.batchClient.messages.create({...e,...this.invocationKwargs},n)}catch(s){throw vg(s)}};return this.caller.callWithOptions({signal:n.signal??void 0},r)}_llmType(){return"anthropic"}withStructuredOutput(e,n){const r=e,s=n==null?void 0:n.name,a=n==null?void 0:n.method,i=n==null?void 0:n.includeRaw;if(a==="jsonMode")throw new Error('Anthropic only supports "functionCalling" as a method.');let o=s??"extract",u,c;if(Rf(r)){const f=Ts(r);c=[{name:o,description:f.description??"A function available to call.",input_schema:f}],u=new Sg({returnSingle:!0,keyName:o,zodSchema:r})}else{let f;typeof r.name=="string"&&typeof r.description=="string"&&typeof r.input_schema=="object"&&r.input_schema!=null?(f=r,o=r.name):f={name:o,description:r.description??"",input_schema:r},c=[f],u=new Sg({returnSingle:!0,keyName:o})}const l=this.bind({tools:c,tool_choice:{type:"tool",name:o}});if(!i)return l.pipe(u).withConfig({runName:"ChatAnthropicStructuredOutput"});const d=da.assign({parsed:(f,g)=>u.invoke(f.raw,g)}),p=da.assign({parsed:()=>null}),m=d.withFallbacks({fallbacks:[p]});return cr.from([{raw:l},m]).withConfig({runName:"StructuredOutputRunnable"})}}class HP extends $P{}const mh="RFC3986",ph={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:t=>String(t)},qP="RFC1738",VP=Array.isArray,Qn=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),sd=1024,zP=(t,e,n,r,s)=>{if(t.length===0)return t;let a=t;if(typeof t=="symbol"?a=Symbol.prototype.toString.call(t):typeof t!="string"&&(a=String(t)),n==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<a.length;o+=sd){const u=a.length>=sd?a.slice(o,o+sd):a,c=[];for(let l=0;l<u.length;++l){let d=u.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||s===qP&&(d===40||d===41)){c[c.length]=u.charAt(l);continue}if(d<128){c[c.length]=Qn[d];continue}if(d<2048){c[c.length]=Qn[192|d>>6]+Qn[128|d&63];continue}if(d<55296||d>=57344){c[c.length]=Qn[224|d>>12]+Qn[128|d>>6&63]+Qn[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=Qn[240|d>>18]+Qn[128|d>>12&63]+Qn[128|d>>6&63]+Qn[128|d&63]}i+=c.join("")}return i};function WP(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function Ig(t,e){if(VP(t)){const n=[];for(let r=0;r<t.length;r+=1)n.push(e(t[r]));return n}return e(t)}const GP=Object.prototype.hasOwnProperty,xy={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},nr=Array.isArray,KP=Array.prototype.push,Ly=function(t,e){KP.apply(t,nr(e)?e:[e])},YP=Date.prototype.toISOString,dt={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:zP,encodeValuesOnly:!1,format:mh,formatter:ph[mh],indices:!1,serializeDate(t){return YP.call(t)},skipNulls:!1,strictNullHandling:!1};function ZP(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const ad={};function Dy(t,e,n,r,s,a,i,o,u,c,l,d,p,m,f,g,b,_){let E=t,T=_,N=0,v=!1;for(;(T=T.get(ad))!==void 0&&!v;){const U=T.get(t);if(N+=1,typeof U<"u"){if(U===N)throw new RangeError("Cyclic object value");v=!0}typeof T.get(ad)>"u"&&(N=0)}if(typeof c=="function"?E=c(e,E):E instanceof Date?E=p==null?void 0:p(E):n==="comma"&&nr(E)&&(E=Ig(E,function(U){return U instanceof Date?p==null?void 0:p(U):U})),E===null){if(a)return u&&!g?u(e,dt.encoder,b,"key",m):e;E=""}if(ZP(E)||WP(E)){if(u){const U=g?e:u(e,dt.encoder,b,"key",m);return[(f==null?void 0:f(U))+"="+(f==null?void 0:f(u(E,dt.encoder,b,"value",m)))]}return[(f==null?void 0:f(e))+"="+(f==null?void 0:f(String(E)))]}const A=[];if(typeof E>"u")return A;let O;if(n==="comma"&&nr(E))g&&u&&(E=Ig(E,u)),O=[{value:E.length>0?E.join(",")||null:void 0}];else if(nr(c))O=c;else{const U=Object.keys(E);O=l?U.sort(l):U}const x=o?String(e).replace(/\./g,"%2E"):String(e),D=r&&nr(E)&&E.length===1?x+"[]":x;if(s&&nr(E)&&E.length===0)return D+"[]";for(let U=0;U<O.length;++U){const Q=O[U],K=typeof Q=="object"&&typeof Q.value<"u"?Q.value:E[Q];if(i&&K===null)continue;const oe=d&&o?Q.replace(/\./g,"%2E"):Q,L=nr(E)?typeof n=="function"?n(D,oe):D:D+(d?"."+oe:"["+oe+"]");_.set(t,N);const I=new WeakMap;I.set(ad,_),Ly(A,Dy(K,L,n,r,s,a,i,o,n==="comma"&&g&&nr(E)?null:u,c,l,d,p,m,f,g,b,I))}return A}function JP(t=dt){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||dt.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=mh;if(typeof t.format<"u"){if(!GP.call(ph,t.format))throw new TypeError("Unknown format option provided.");n=t.format}const r=ph[n];let s=dt.filter;(typeof t.filter=="function"||nr(t.filter))&&(s=t.filter);let a;if(t.arrayFormat&&t.arrayFormat in xy?a=t.arrayFormat:"indices"in t?a=t.indices?"indices":"repeat":a=dt.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:dt.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:dt.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:dt.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:dt.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?dt.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:dt.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:dt.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:dt.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:dt.encodeValuesOnly,filter:s,format:n,formatter:r,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:dt.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:dt.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:dt.strictNullHandling}}function XP(t,e={}){let n=t;const r=JP(e);let s,a;typeof r.filter=="function"?(a=r.filter,n=a("",n)):nr(r.filter)&&(a=r.filter,s=a);const i=[];if(typeof n!="object"||n===null)return"";const o=xy[r.arrayFormat],u=o==="comma"&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const c=new WeakMap;for(let p=0;p<s.length;++p){const m=s[p];r.skipNulls&&n[m]===null||Ly(i,Dy(n[m],m,o,u,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const l=i.join(r.delimiter);let d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}const zs="4.83.0";let Ng=!1,hi,My,By,gh,Fy,Uy,jy,$y,Hy;function QP(t,e={auto:!1}){if(Ng)throw new Error(`you must \`import 'openai/shims/${t.kind}'\` before importing anything else from openai`);if(hi)throw new Error(`can't \`import 'openai/shims/${t.kind}'\` after \`import 'openai/shims/${hi}'\``);Ng=e.auto,hi=t.kind,My=t.fetch,By=t.FormData,gh=t.File,Fy=t.ReadableStream,Uy=t.getMultipartRequestOptions,jy=t.getDefaultAgent,$y=t.fileFromPath,Hy=t.isFsReadStream}class e3{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function t3({manuallyImported:t}={}){const e=t?"You may need to use polyfills":"Add one of these imports before your first `import  from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new e3(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}hi||QP(t3(),{auto:!0});class xe extends Error{}class kt extends xe{constructor(e,n,r,s){super(`${kt.makeMessage(e,n,r)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["x-request-id"],this.error=n;const a=n;this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,n,r){const s=n!=null&&n.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,n,r,s){if(!e||!s)return new Wc({message:r,cause:_h(n)});const a=n==null?void 0:n.error;return e===400?new qy(e,a,r,s):e===401?new Vy(e,a,r,s):e===403?new zy(e,a,r,s):e===404?new Wy(e,a,r,s):e===409?new Gy(e,a,r,s):e===422?new Ky(e,a,r,s):e===429?new Yy(e,a,r,s):e>=500?new Zy(e,a,r,s):new kt(e,a,r,s)}}class An extends kt{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Wc extends kt{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),n&&(this.cause=n)}}class Gc extends Wc{constructor({message:e}={}){super({message:e??"Request timed out."})}}class qy extends kt{}class Vy extends kt{}class zy extends kt{}class Wy extends kt{}class Gy extends kt{}class Ky extends kt{}class Yy extends kt{}class Zy extends kt{}class Jy extends xe{constructor(){super("Could not parse response content as the length limit was reached")}}class Xy extends xe{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Ss{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let n=this.decodeText(e);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];const r=Ss.NEWLINE_CHARS.has(n[n.length-1]||"");let s=n.split(Ss.NEWLINE_REGEXP);return r&&s.pop(),s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new xe(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new xe(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new xe("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}Ss.NEWLINE_CHARS=new Set([`
`,"\r"]);Ss.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Qy(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n!=null&&n.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class lr{constructor(e,n){this.iterator=e,this.controller=n}static fromSSEResponse(e,n){let r=!1;async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const i of n3(e,n))if(!a){if(i.data.startsWith("[DONE]")){a=!0;continue}if(i.event===null){let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(o&&o.error)throw new kt(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(i.event=="error")throw new kt(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}a=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{a||n.abort()}}return new lr(s,n)}static fromReadableStream(e,n){let r=!1;async function*s(){const i=new Ss,o=Qy(e);for await(const u of o)for(const c of i.decode(u))yield c;for(const u of i.flush())yield u}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const o of s())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||n.abort()}}return new lr(a,n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],n=[],r=this.iterator(),s=a=>({next:()=>{if(a.length===0){const i=r.next();e.push(i),n.push(i)}return a.shift()}});return[new lr(()=>s(e),this.controller),new lr(()=>s(n),this.controller)]}toReadableStream(){const e=this;let n;const r=new TextEncoder;return new Fy({async start(){n=e[Symbol.asyncIterator]()},async pull(s){try{const{value:a,done:i}=await n.next();if(i)return s.close();const o=r.encode(JSON.stringify(a)+`
`);s.enqueue(o)}catch(a){s.error(a)}},async cancel(){var s;await((s=n.return)==null?void 0:s.call(n))}})}}async function*n3(t,e){if(!t.body)throw e.abort(),new xe("Attempted to iterate over a response with no body");const n=new a3,r=new Ss,s=Qy(t.body);for await(const a of r3(s))for(const i of r.decode(a)){const o=n.decode(i);o&&(yield o)}for(const a of r.flush()){const i=n.decode(a);i&&(yield i)}}async function*r3(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let a;for(;(a=s3(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}function s3(t){for(let r=0;r<t.length-2;r++){if(t[r]===10&&t[r+1]===10||t[r]===13&&t[r+1]===13)return r+2;if(t[r]===13&&t[r+1]===10&&r+3<t.length&&t[r+2]===13&&t[r+3]===10)return r+4}return-1}class a3{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,r,s]=i3(e,":");return s.startsWith(" ")&&(s=s.substring(1)),n==="event"?this.event=s:n==="data"&&this.data.push(s),null}}function i3(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}const e1=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function",t1=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&Kc(t),Kc=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",o3=t=>t1(t)||e1(t)||Hy(t);async function n1(t,e,n){var s;if(t=await t,t1(t))return t;if(e1(t)){const a=await t.blob();e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=Kc(a)?[await a.arrayBuffer()]:[a];return new gh(i,e,n)}const r=await u3(t);if(e||(e=l3(t)??"unknown_file"),!(n!=null&&n.type)){const a=(s=r[0])==null?void 0:s.type;typeof a=="string"&&(n={...n,type:a})}return new gh(r,e,n)}async function u3(t){var n;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(Kc(t))e.push(await t.arrayBuffer());else if(d3(t))for await(const r of t)e.push(r);else throw new Error(`Unexpected data type: ${typeof t}; constructor: ${(n=t==null?void 0:t.constructor)==null?void 0:n.name}; props: ${c3(t)}`);return e}function c3(t){return`[${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}function l3(t){var e;return id(t.name)||id(t.filename)||((e=id(t.path))==null?void 0:e.split(/[\\/]/).pop())}const id=t=>{if(typeof t=="string")return t;if(typeof Buffer<"u"&&t instanceof Buffer)return String(t)},d3=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",kg=t=>t&&typeof t=="object"&&t.body&&t[Symbol.toStringTag]==="MultipartBody",ha=async t=>{const e=await h3(t.body);return Uy(e,t)},h3=async t=>{const e=new By;return await Promise.all(Object.entries(t||{}).map(([n,r])=>bh(e,n,r))),e},bh=async(t,e,n)=>{if(n!==void 0){if(n==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")t.append(e,String(n));else if(o3(n)){const r=await n1(n);t.append(e,r)}else if(Array.isArray(n))await Promise.all(n.map(r=>bh(t,e+"[]",r)));else if(typeof n=="object")await Promise.all(Object.entries(n).map(([r,s])=>bh(t,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}};var f3=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},m3=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},Xo;async function r1(t){const{response:e}=t;if(t.options.stream)return na("response",e.status,e.url,e.headers,e.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(e,t.controller):lr.fromSSEResponse(e,t.controller);if(e.status===204)return null;if(t.options.__binaryResponse)return e;const n=e.headers.get("content-type");if((n==null?void 0:n.includes("application/json"))||(n==null?void 0:n.includes("application/vnd.api+json"))){const a=await e.json();return na("response",e.status,e.url,e.headers,a),s1(a,e)}const s=await e.text();return na("response",e.status,e.url,e.headers,s),s}function s1(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class Yc extends Promise{constructor(e,n=r1){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=n}_thenUnwrap(e){return new Yc(this.responsePromise,async n=>s1(e(await this.parseResponse(n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n,request_id:n.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class p3{constructor({baseURL:e,maxRetries:n=2,timeout:r=6e5,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=od("maxRetries",n),this.timeout=od("timeout",r),this.httpAgent=s,this.fetch=a??My}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...w3(),...this.authHeaders(e)}}validateHeaders(e,n){}defaultIdempotencyKey(){return`stainless-node-retry-${C3()}`}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,r){return this.request(Promise.resolve(r).then(async s=>{const a=s&&Kc(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:n,...s,body:a}}))}getAPIList(e,n,r){return this.requestAPIList(n,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:n=0}={}){var f;e={...e};const{method:r,path:s,query:a,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:kg(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(s,a);"timeout"in e&&od("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const l=e.httpAgent??this.httpAgent??jy(c),d=e.timeout+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const p=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:n});return{req:{method:r,...o&&{body:o},headers:p,...l&&{agent:l},signal:e.signal??null},url:c,timeout:e.timeout}}buildHeaders({options:e,headers:n,contentLength:r,retryCount:s}){const a={};r&&(a["content-length"]=r);const i=this.defaultHeaders(e);return Lg(a,i),Lg(a,n),kg(e.body)&&hi!=="node"&&delete a["content-type"],eu(i,"x-stainless-retry-count")===void 0&&eu(n,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),eu(i,"x-stainless-timeout")===void 0&&eu(n,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(a,n),a}async prepareOptions(e){}async prepareRequest(e,{url:n,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(n=>[...n])):{...e}:{}}makeStatusError(e,n,r,s){return kt.generate(e,n,r,s)}request(e,n=null){return new Yc(this.makeRequest(e,n))}async makeRequest(e,n){var d,p;const r=await e,s=r.maxRetries??this.maxRetries;n==null&&(n=s),await this.prepareOptions(r);const{req:a,url:i,timeout:o}=this.buildRequest(r,{retryCount:s-n});if(await this.prepareRequest(a,{url:i,options:r}),na("request",i,r,a.headers),(d=r.signal)!=null&&d.aborted)throw new An;const u=new AbortController,c=await this.fetchWithTimeout(i,a,o,u).catch(_h);if(c instanceof Error){if((p=r.signal)!=null&&p.aborted)throw new An;if(n)return this.retryRequest(r,n);throw c.name==="AbortError"?new Gc:new Wc({cause:c})}const l=b3(c.headers);if(!c.ok){if(n&&this.shouldRetry(c)){const E=`retrying, ${n} attempts remaining`;return na(`response (error; ${E})`,c.status,i,l),this.retryRequest(r,n,l)}const m=await c.text().catch(E=>_h(E).message),f=T3(m),g=f?void 0:m;throw na(`response (error; ${n?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,g),this.makeStatusError(c.status,f,g,l)}return{response:c,options:r,controller:u}}requestAPIList(e,n){const r=this.makeRequest(n,null);return new g3(this,r,e)}buildURL(e,n){const r=A3(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return i1(s)||(n={...s,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(r.search=this.stringifyQuery(n)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([n,r])=>typeof r<"u").map(([n,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(n)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(n)}=`;throw new xe(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,n,r,s){const{signal:a,...i}=n||{};a&&a.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r),u={signal:s.signal,...i};return u.method&&(u.method=u.method.toUpperCase()),this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o)})}shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,r){let s;const a=r==null?void 0:r["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(s=o)}const i=r==null?void 0:r["retry-after"];if(i&&!s){const o=parseFloat(i);Number.isNaN(o)?s=Date.parse(i)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(n,o)}return await lo(s),this.makeRequest(e,n-1)}calculateDefaultRetryTimeoutMillis(e,n){const a=n-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${zs}`}}class a1{constructor(e,n,r,s){Xo.set(this,void 0),f3(this,Xo,e,"f"),this.options=s,this.response=n,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new xe("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const n={...this.options};if("params"in e&&typeof n.query=="object")n.query={...n.query,...e.params};else if("url"in e){const r=[...Object.entries(n.query||{}),...e.url.searchParams.entries()];for(const[s,a]of r)e.url.searchParams.set(s,a);n.query=void 0,n.path=e.url.toString()}return await m3(this,Xo,"f").requestAPIList(this.constructor,n)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Xo=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}}class g3 extends Yc{constructor(e,n,r){super(n,async s=>new r(e,s.response,await r1(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}}const b3=t=>new Proxy(Object.fromEntries(t.entries()),{get(e,n){const r=n.toString();return e[r.toLowerCase()]||e[r]}}),_3={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},nn=t=>typeof t=="object"&&t!==null&&!i1(t)&&Object.keys(t).every(e=>o1(_3,e)),y3=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":Pg(Deno.build.os),"X-Stainless-Arch":Rg(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":Pg(process.platform),"X-Stainless-Arch":Rg(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const t=E3();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function E3(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const r=n.exec(navigator.userAgent);if(r){const s=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${s}.${a}.${i}`}}}return null}const Rg=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",Pg=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let xg;const w3=()=>xg??(xg=y3()),T3=t=>{try{return JSON.parse(t)}catch{return}},S3=/^[a-z][a-z0-9+.-]*:/i,A3=t=>S3.test(t),lo=t=>new Promise(e=>setTimeout(e,t)),od=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new xe(`${t} must be an integer`);if(e<0)throw new xe(`${t} must be a positive integer`);return e},_h=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null)try{return new Error(JSON.stringify(t))}catch{}return new Error(t)},Qo=t=>{var e,n,r,s,a;if(typeof process<"u")return((n=(e=process.env)==null?void 0:e[t])==null?void 0:n.trim())??void 0;if(typeof Deno<"u")return(a=(s=(r=Deno.env)==null?void 0:r.get)==null?void 0:s.call(r,t))==null?void 0:a.trim()};function i1(t){if(!t)return!0;for(const e in t)return!1;return!0}function o1(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Lg(t,e){for(const n in e){if(!o1(e,n))continue;const r=n.toLowerCase();if(!r)continue;const s=e[n];s===null?delete t[r]:s!==void 0&&(t[r]=s)}}const Dg=new Set(["authorization","api-key"]);function na(t,...e){var n;if(typeof process<"u"&&((n=process==null?void 0:process.env)==null?void 0:n.DEBUG)==="true"){const r=e.map(s=>{if(!s)return s;if(s.headers){const i={...s,headers:{...s.headers}};for(const o in s.headers)Dg.has(o.toLowerCase())&&(i.headers[o]="REDACTED");return i}let a=null;for(const i in s)Dg.has(i.toLowerCase())&&(a??(a={...s}),a[i]="REDACTED");return a??s});console.log(`OpenAI:DEBUG:${t}`,...r)}}const C3=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),O3=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",v3=t=>typeof(t==null?void 0:t.get)=="function",eu=(t,e)=>{var r;const n=e.toLowerCase();if(v3(t)){const s=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,i,o)=>i+o.toUpperCase());for(const a of[e,n,e.toUpperCase(),s]){const i=t.get(a);if(i)return i}}for(const[s,a]of Object.entries(t))if(s.toLowerCase()===n)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a};function ud(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}class I3 extends a1{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Kn extends a1{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const n=Object.fromEntries(e.url.searchParams);return Object.keys(n).length?n:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const n=(r=e[e.length-1])==null?void 0:r.id;return n?{params:{after:n}}:null}}class Ve{constructor(e){this._client=e}}let u1=class extends Ve{create(e,n){return this._client.post("/chat/completions",{body:e,...n,stream:e.stream??!1})}},Pf=class extends Ve{constructor(){super(...arguments),this.completions=new u1(this._client)}};Pf.Completions=u1;class c1 extends Ve{create(e,n){return this._client.post("/audio/speech",{body:e,...n,headers:{Accept:"application/octet-stream",...n==null?void 0:n.headers},__binaryResponse:!0})}}class l1 extends Ve{create(e,n){return this._client.post("/audio/transcriptions",ha({body:e,...n,__metadata:{model:e.model}}))}}class d1 extends Ve{create(e,n){return this._client.post("/audio/translations",ha({body:e,...n,__metadata:{model:e.model}}))}}class ho extends Ve{constructor(){super(...arguments),this.transcriptions=new l1(this._client),this.translations=new d1(this._client),this.speech=new c1(this._client)}}ho.Transcriptions=l1;ho.Translations=d1;ho.Speech=c1;class xf extends Ve{create(e,n){return this._client.post("/batches",{body:e,...n})}retrieve(e,n){return this._client.get(`/batches/${e}`,n)}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/batches",Lf,{query:e,...n})}cancel(e,n){return this._client.post(`/batches/${e}/cancel`,n)}}class Lf extends Kn{}xf.BatchesPage=Lf;class Df extends Ve{create(e,n){return this._client.post("/assistants",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/assistants/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/assistants/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/assistants",Mf,{query:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,n){return this._client.delete(`/assistants/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class Mf extends Kn{}Df.AssistantsPage=Mf;function Mg(t){return typeof t.parse=="function"}const ra=t=>(t==null?void 0:t.role)==="assistant",h1=t=>(t==null?void 0:t.role)==="function",f1=t=>(t==null?void 0:t.role)==="tool";var xn=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},nt=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},yh,gu,bu,Xa,Qa,_u,ei,yr,ti,Zu,Ju,Ws,m1;class p1{constructor(){yh.add(this),this.controller=new AbortController,gu.set(this,void 0),bu.set(this,()=>{}),Xa.set(this,()=>{}),Qa.set(this,void 0),_u.set(this,()=>{}),ei.set(this,()=>{}),yr.set(this,{}),ti.set(this,!1),Zu.set(this,!1),Ju.set(this,!1),Ws.set(this,!1),xn(this,gu,new Promise((e,n)=>{xn(this,bu,e,"f"),xn(this,Xa,n,"f")}),"f"),xn(this,Qa,new Promise((e,n)=>{xn(this,_u,e,"f"),xn(this,ei,n,"f")}),"f"),nt(this,gu,"f").catch(()=>{}),nt(this,Qa,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},nt(this,yh,"m",m1).bind(this))},0)}_connected(){this.ended||(nt(this,bu,"f").call(this),this._emit("connect"))}get ended(){return nt(this,ti,"f")}get errored(){return nt(this,Zu,"f")}get aborted(){return nt(this,Ju,"f")}abort(){this.controller.abort()}on(e,n){return(nt(this,yr,"f")[e]||(nt(this,yr,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=nt(this,yr,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(nt(this,yr,"f")[e]||(nt(this,yr,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{xn(this,Ws,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){xn(this,Ws,!0,"f"),await nt(this,Qa,"f")}_emit(e,...n){if(nt(this,ti,"f"))return;e==="end"&&(xn(this,ti,!0,"f"),nt(this,_u,"f").call(this));const r=nt(this,yr,"f")[e];if(r&&(nt(this,yr,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!nt(this,Ws,"f")&&!(r!=null&&r.length)&&Promise.reject(s),nt(this,Xa,"f").call(this,s),nt(this,ei,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!nt(this,Ws,"f")&&!(r!=null&&r.length)&&Promise.reject(s),nt(this,Xa,"f").call(this,s),nt(this,ei,"f").call(this,s),this._emit("end")}}_emitFinal(){}}gu=new WeakMap,bu=new WeakMap,Xa=new WeakMap,Qa=new WeakMap,_u=new WeakMap,ei=new WeakMap,yr=new WeakMap,ti=new WeakMap,Zu=new WeakMap,Ju=new WeakMap,Ws=new WeakMap,yh=new WeakSet,m1=function(e){if(xn(this,Zu,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new An),e instanceof An)return xn(this,Ju,!0,"f"),this._emit("abort",e);if(e instanceof xe)return this._emit("error",e);if(e instanceof Error){const n=new xe(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new xe(String(e)))};function N3(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function g1(t){return(t==null?void 0:t.$brand)==="auto-parseable-response-format"}function k3(t,{parser:e,callback:n}){const r={...t};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:n,enumerable:!1}}),r}function fo(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function R3(t,e){return!e||!b1(e)?{...t,choices:t.choices.map(n=>({...n,message:{...n.message,parsed:null,tool_calls:n.message.tool_calls??[]}}))}:Bf(t,e)}function Bf(t,e){const n=t.choices.map(r=>{var s;if(r.finish_reason==="length")throw new Jy;if(r.finish_reason==="content_filter")throw new Xy;return{...r,message:{...r.message,tool_calls:((s=r.message.tool_calls)==null?void 0:s.map(a=>x3(e,a)))??[],parsed:r.message.content&&!r.message.refusal?P3(e,r.message.content):null}}});return{...t,choices:n}}function P3(t,e){var n,r;return((n=t.response_format)==null?void 0:n.type)!=="json_schema"?null:((r=t.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function x3(t,e){var r;const n=(r=t.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:fo(n)?n.$parseRaw(e.function.arguments):n!=null&&n.function.strict?JSON.parse(e.function.arguments):null}}}function L3(t,e){var r;if(!t)return!1;const n=(r=t.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return fo(n)||(n==null?void 0:n.function.strict)||!1}function b1(t){var e;return g1(t.response_format)?!0:((e=t.tools)==null?void 0:e.some(n=>fo(n)||n.type==="function"&&n.function.strict===!0))??!1}function D3(t){for(const e of t??[]){if(e.type!=="function")throw new xe(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new xe(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Gt=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},Rt,Eh,Xu,wh,Th,Sh,_1,Ah;const Bg=10;class y1 extends p1{constructor(){super(...arguments),Rt.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const n=(r=e.choices[0])==null?void 0:r.message;return n&&this._addMessage(n),e}_addMessage(e,n=!0){if("content"in e||(e.content=null),this.messages.push(e),n){if(this._emit("message",e),(h1(e)||f1(e))&&e.content)this._emit("functionCallResult",e.content);else if(ra(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(ra(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new xe("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Gt(this,Rt,"m",Eh).call(this)}async finalMessage(){return await this.done(),Gt(this,Rt,"m",Xu).call(this)}async finalFunctionCall(){return await this.done(),Gt(this,Rt,"m",wh).call(this)}async finalFunctionCallResult(){return await this.done(),Gt(this,Rt,"m",Th).call(this)}async totalUsage(){return await this.done(),Gt(this,Rt,"m",Sh).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const n=Gt(this,Rt,"m",Xu).call(this);n&&this._emit("finalMessage",n);const r=Gt(this,Rt,"m",Eh).call(this);r&&this._emit("finalContent",r);const s=Gt(this,Rt,"m",wh).call(this);s&&this._emit("finalFunctionCall",s);const a=Gt(this,Rt,"m",Th).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",Gt(this,Rt,"m",Sh).call(this))}async _createChatCompletion(e,n,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Gt(this,Rt,"m",_1).call(this,n);const a=await e.chat.completions.create({...n,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Bf(a,n))}async _runChatCompletion(e,n,r){for(const s of n.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,n,r)}async _runFunctions(e,n,r){var p;const s="function",{function_call:a="auto",stream:i,...o}=n,u=typeof a!="string"&&(a==null?void 0:a.name),{maxChatCompletions:c=Bg}=r||{},l={};for(const m of n.functions)l[m.name||m.function.name]=m;const d=n.functions.map(m=>({name:m.name||m.function.name,parameters:m.parameters,description:m.description}));for(const m of n.messages)this._addMessage(m,!1);for(let m=0;m<c;++m){const g=(p=(await this._createChatCompletion(e,{...o,function_call:a,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:p.message;if(!g)throw new xe("missing message in ChatCompletion response");if(!g.function_call)return;const{name:b,arguments:_}=g.function_call,E=l[b];if(E){if(u&&u!==b){const A=`Invalid function_call: ${JSON.stringify(b)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,name:b,content:A});continue}}else{const A=`Invalid function_call: ${JSON.stringify(b)}. Available options are: ${d.map(O=>JSON.stringify(O.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:b,content:A});continue}let T;try{T=Mg(E)?await E.parse(_):_}catch(A){this._addMessage({role:s,name:b,content:A instanceof Error?A.message:String(A)});continue}const N=await E.function(T,this),v=Gt(this,Rt,"m",Ah).call(this,N);if(this._addMessage({role:s,name:b,content:v}),u)return}}async _runTools(e,n,r){var m,f,g;const s="tool",{tool_choice:a="auto",stream:i,...o}=n,u=typeof a!="string"&&((m=a==null?void 0:a.function)==null?void 0:m.name),{maxChatCompletions:c=Bg}=r||{},l=n.tools.map(b=>{if(fo(b)){if(!b.$callback)throw new xe("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:b.$callback,name:b.function.name,description:b.function.description||"",parameters:b.function.parameters,parse:b.$parseRaw,strict:!0}}}return b}),d={};for(const b of l)b.type==="function"&&(d[b.function.name||b.function.function.name]=b.function);const p="tools"in n?l.map(b=>b.type==="function"?{type:"function",function:{name:b.function.name||b.function.function.name,parameters:b.function.parameters,description:b.function.description,strict:b.function.strict}}:b):void 0;for(const b of n.messages)this._addMessage(b,!1);for(let b=0;b<c;++b){const E=(f=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:p,messages:[...this.messages]},r)).choices[0])==null?void 0:f.message;if(!E)throw new xe("missing message in ChatCompletion response");if(!((g=E.tool_calls)!=null&&g.length))return;for(const T of E.tool_calls){if(T.type!=="function")continue;const N=T.id,{name:v,arguments:A}=T.function,O=d[v];if(O){if(u&&u!==v){const Q=`Invalid tool_call: ${JSON.stringify(v)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,tool_call_id:N,content:Q});continue}}else{const Q=`Invalid tool_call: ${JSON.stringify(v)}. Available options are: ${Object.keys(d).map(K=>JSON.stringify(K)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:N,content:Q});continue}let x;try{x=Mg(O)?await O.parse(A):A}catch(Q){const K=Q instanceof Error?Q.message:String(Q);this._addMessage({role:s,tool_call_id:N,content:K});continue}const D=await O.function(x,this),U=Gt(this,Rt,"m",Ah).call(this,D);if(this._addMessage({role:s,tool_call_id:N,content:U}),u)return}}}}Rt=new WeakSet,Eh=function(){return Gt(this,Rt,"m",Xu).call(this).content??null},Xu=function(){let e=this.messages.length;for(;e-- >0;){const n=this.messages[e];if(ra(n)){const{function_call:r,...s}=n,a={...s,content:n.content??null,refusal:n.refusal??null};return r&&(a.function_call=r),a}}throw new xe("stream ended without producing a ChatCompletionMessage with role=assistant")},wh=function(){var e,n;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(ra(s)&&(s!=null&&s.function_call))return s.function_call;if(ra(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(n=s.tool_calls.at(-1))==null?void 0:n.function}},Th=function(){for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];if(h1(n)&&n.content!=null||f1(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(a=>a.type==="function"&&a.id===n.tool_call_id))}))return n.content}},Sh=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:n}of this._chatCompletions)n&&(e.completion_tokens+=n.completion_tokens,e.prompt_tokens+=n.prompt_tokens,e.total_tokens+=n.total_tokens);return e},_1=function(e){if(e.n!=null&&e.n>1)throw new xe("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Ah=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class $i extends y1{static runFunctions(e,n,r){const s=new $i,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,n,a)),s}static runTools(e,n,r){const s=new $i,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,a)),s}_addMessage(e,n=!0){super._addMessage(e,n),ra(e)&&e.content&&this._emit("content",e.content)}}const E1=1,w1=2,T1=4,S1=8,A1=16,C1=32,O1=64,v1=128,I1=256,N1=v1|I1,k1=A1|C1|N1|O1,R1=E1|w1|k1,P1=T1|S1,M3=R1|P1,St={STR:E1,NUM:w1,ARR:T1,OBJ:S1,NULL:A1,BOOL:C1,NAN:O1,INFINITY:v1,MINUS_INFINITY:I1,INF:N1,SPECIAL:k1,ATOM:R1,COLLECTION:P1,ALL:M3};class B3 extends Error{}class F3 extends Error{}function U3(t,e=St.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return j3(t.trim(),e)}const j3=(t,e)=>{const n=t.length;let r=0;const s=p=>{throw new B3(`${p} at position ${r}`)},a=p=>{throw new F3(`${p} at position ${r}`)},i=()=>(d(),r>=n&&s("Unexpected end of input"),t[r]==='"'?o():t[r]==="{"?u():t[r]==="["?c():t.substring(r,r+4)==="null"||St.NULL&e&&n-r<4&&"null".startsWith(t.substring(r))?(r+=4,null):t.substring(r,r+4)==="true"||St.BOOL&e&&n-r<4&&"true".startsWith(t.substring(r))?(r+=4,!0):t.substring(r,r+5)==="false"||St.BOOL&e&&n-r<5&&"false".startsWith(t.substring(r))?(r+=5,!1):t.substring(r,r+8)==="Infinity"||St.INFINITY&e&&n-r<8&&"Infinity".startsWith(t.substring(r))?(r+=8,1/0):t.substring(r,r+9)==="-Infinity"||St.MINUS_INFINITY&e&&1<n-r&&n-r<9&&"-Infinity".startsWith(t.substring(r))?(r+=9,-1/0):t.substring(r,r+3)==="NaN"||St.NAN&e&&n-r<3&&"NaN".startsWith(t.substring(r))?(r+=3,NaN):l()),o=()=>{const p=r;let m=!1;for(r++;r<n&&(t[r]!=='"'||m&&t[r-1]==="\\");)m=t[r]==="\\"?!m:!1,r++;if(t.charAt(r)=='"')try{return JSON.parse(t.substring(p,++r-Number(m)))}catch(f){a(String(f))}else if(St.STR&e)try{return JSON.parse(t.substring(p,r-Number(m))+'"')}catch{return JSON.parse(t.substring(p,t.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},u=()=>{r++,d();const p={};try{for(;t[r]!=="}";){if(d(),r>=n&&St.OBJ&e)return p;const m=o();d(),r++;try{const f=i();Object.defineProperty(p,m,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(St.OBJ&e)return p;throw f}d(),t[r]===","&&r++}}catch{if(St.OBJ&e)return p;s("Expected '}' at end of object")}return r++,p},c=()=>{r++;const p=[];try{for(;t[r]!=="]";)p.push(i()),d(),t[r]===","&&r++}catch{if(St.ARR&e)return p;s("Expected ']' at end of array")}return r++,p},l=()=>{if(r===0){t==="-"&&St.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t)}catch(m){if(St.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}a(String(m))}}const p=r;for(t[r]==="-"&&r++;t[r]&&!",]}".includes(t[r]);)r++;r==n&&!(St.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(t.substring(p,r))}catch{t.substring(p,r)==="-"&&St.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t.substring(p,t.lastIndexOf("e")))}catch(f){a(String(f))}}},d=()=>{for(;r<n&&` 
\r	`.includes(t[r]);)r++};return i()},Fg=t=>U3(t,St.ALL^St.NUM);var Bs=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Ge=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},lt,br,Fs,Lr,cd,tu,ld,dd,hd,nu,fd,Ug;class Hi extends y1{constructor(e){super(),lt.add(this),br.set(this,void 0),Fs.set(this,void 0),Lr.set(this,void 0),Bs(this,br,e,"f"),Bs(this,Fs,[],"f")}get currentChatCompletionSnapshot(){return Ge(this,Lr,"f")}static fromReadableStream(e){const n=new Hi(null);return n._run(()=>n._fromReadableStream(e)),n}static createChatCompletion(e,n,r){const s=new Hi(n);return s._run(()=>s._runChatCompletion(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,n,r){var i;super._createChatCompletion;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Ge(this,lt,"m",cd).call(this);const a=await e.chat.completions.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of a)Ge(this,lt,"m",ld).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new An;return this._addChatCompletion(Ge(this,lt,"m",nu).call(this))}async _fromReadableStream(e,n){var i;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Ge(this,lt,"m",cd).call(this),this._connected();const s=lr.fromReadableStream(e,this.controller);let a;for await(const o of s)a&&a!==o.id&&this._addChatCompletion(Ge(this,lt,"m",nu).call(this)),Ge(this,lt,"m",ld).call(this,o),a=o.id;if((i=s.controller.signal)!=null&&i.aborted)throw new An;return this._addChatCompletion(Ge(this,lt,"m",nu).call(this))}[(br=new WeakMap,Fs=new WeakMap,Lr=new WeakMap,lt=new WeakSet,cd=function(){this.ended||Bs(this,Lr,void 0,"f")},tu=function(n){let r=Ge(this,Fs,"f")[n.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Ge(this,Fs,"f")[n.index]=r,r)},ld=function(n){var s,a,i,o,u,c,l,d,p,m,f,g,b,_,E;if(this.ended)return;const r=Ge(this,lt,"m",Ug).call(this,n);this._emit("chunk",n,r);for(const T of n.choices){const N=r.choices[T.index];T.delta.content!=null&&((s=N.message)==null?void 0:s.role)==="assistant"&&((a=N.message)!=null&&a.content)&&(this._emit("content",T.delta.content,N.message.content),this._emit("content.delta",{delta:T.delta.content,snapshot:N.message.content,parsed:N.message.parsed})),T.delta.refusal!=null&&((i=N.message)==null?void 0:i.role)==="assistant"&&((o=N.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:T.delta.refusal,snapshot:N.message.refusal}),((u=T.logprobs)==null?void 0:u.content)!=null&&((c=N.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=T.logprobs)==null?void 0:l.content,snapshot:((d=N.logprobs)==null?void 0:d.content)??[]}),((p=T.logprobs)==null?void 0:p.refusal)!=null&&((m=N.message)==null?void 0:m.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(f=T.logprobs)==null?void 0:f.refusal,snapshot:((g=N.logprobs)==null?void 0:g.refusal)??[]});const v=Ge(this,lt,"m",tu).call(this,N);N.finish_reason&&(Ge(this,lt,"m",hd).call(this,N),v.current_tool_call_index!=null&&Ge(this,lt,"m",dd).call(this,N,v.current_tool_call_index));for(const A of T.delta.tool_calls??[])v.current_tool_call_index!==A.index&&(Ge(this,lt,"m",hd).call(this,N),v.current_tool_call_index!=null&&Ge(this,lt,"m",dd).call(this,N,v.current_tool_call_index)),v.current_tool_call_index=A.index;for(const A of T.delta.tool_calls??[]){const O=(b=N.message.tool_calls)==null?void 0:b[A.index];O!=null&&O.type&&((O==null?void 0:O.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(_=O.function)==null?void 0:_.name,index:A.index,arguments:O.function.arguments,parsed_arguments:O.function.parsed_arguments,arguments_delta:((E=A.function)==null?void 0:E.arguments)??""}):(O==null||O.type,void 0))}}},dd=function(n,r){var i,o,u;if(Ge(this,lt,"m",tu).call(this,n).done_tool_calls.has(r))return;const a=(i=n.message.tool_calls)==null?void 0:i[r];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const c=(u=(o=Ge(this,br,"f"))==null?void 0:o.tools)==null?void 0:u.find(l=>l.type==="function"&&l.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:r,arguments:a.function.arguments,parsed_arguments:fo(c)?c.$parseRaw(a.function.arguments):c!=null&&c.function.strict?JSON.parse(a.function.arguments):null})}else a.type},hd=function(n){var s,a;const r=Ge(this,lt,"m",tu).call(this,n);if(n.message.content&&!r.content_done){r.content_done=!0;const i=Ge(this,lt,"m",fd).call(this);this._emit("content.done",{content:n.message.content,parsed:i?i.$parseRaw(n.message.content):null})}n.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:n.message.refusal})),(s=n.logprobs)!=null&&s.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:n.logprobs.content})),(a=n.logprobs)!=null&&a.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:n.logprobs.refusal}))},nu=function(){if(this.ended)throw new xe("stream has ended, this shouldn't happen");const n=Ge(this,Lr,"f");if(!n)throw new xe("request ended without sending any chunks");return Bs(this,Lr,void 0,"f"),Bs(this,Fs,[],"f"),$3(n,Ge(this,br,"f"))},fd=function(){var r;const n=(r=Ge(this,br,"f"))==null?void 0:r.response_format;return g1(n)?n:null},Ug=function(n){var r,s,a,i;let o=Ge(this,Lr,"f");const{choices:u,...c}=n;o?Object.assign(o,c):o=Bs(this,Lr,{...c,choices:[]},"f");for(const{delta:l,finish_reason:d,index:p,logprobs:m=null,...f}of n.choices){let g=o.choices[p];if(g||(g=o.choices[p]={finish_reason:d,index:p,message:{},logprobs:m,...f}),m)if(!g.logprobs)g.logprobs=Object.assign({},m);else{const{content:A,refusal:O,...x}=m;Object.assign(g.logprobs,x),A&&((r=g.logprobs).content??(r.content=[]),g.logprobs.content.push(...A)),O&&((s=g.logprobs).refusal??(s.refusal=[]),g.logprobs.refusal.push(...O))}if(d&&(g.finish_reason=d,Ge(this,br,"f")&&b1(Ge(this,br,"f")))){if(d==="length")throw new Jy;if(d==="content_filter")throw new Xy}if(Object.assign(g,f),!l)continue;const{content:b,refusal:_,function_call:E,role:T,tool_calls:N,...v}=l;if(Object.assign(g.message,v),_&&(g.message.refusal=(g.message.refusal||"")+_),T&&(g.message.role=T),E&&(g.message.function_call?(E.name&&(g.message.function_call.name=E.name),E.arguments&&((a=g.message.function_call).arguments??(a.arguments=""),g.message.function_call.arguments+=E.arguments)):g.message.function_call=E),b&&(g.message.content=(g.message.content||"")+b,!g.message.refusal&&Ge(this,lt,"m",fd).call(this)&&(g.message.parsed=Fg(g.message.content))),N){g.message.tool_calls||(g.message.tool_calls=[]);for(const{index:A,id:O,type:x,function:D,...U}of N){const Q=(i=g.message.tool_calls)[A]??(i[A]={});Object.assign(Q,U),O&&(Q.id=O),x&&(Q.type=x),D&&(Q.function??(Q.function={name:D.name??"",arguments:""})),D!=null&&D.name&&(Q.function.name=D.name),D!=null&&D.arguments&&(Q.function.arguments+=D.arguments,L3(Ge(this,br,"f"),Q)&&(Q.function.parsed_arguments=Fg(Q.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("chunk",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new lr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function $3(t,e){const{id:n,choices:r,created:s,model:a,system_fingerprint:i,...o}=t,u={...o,id:n,choices:r.map(({message:c,finish_reason:l,index:d,logprobs:p,...m})=>{if(!l)throw new xe(`missing finish_reason for choice ${d}`);const{content:f=null,function_call:g,tool_calls:b,..._}=c,E=c.role;if(!E)throw new xe(`missing role for choice ${d}`);if(g){const{arguments:T,name:N}=g;if(T==null)throw new xe(`missing function_call.arguments for choice ${d}`);if(!N)throw new xe(`missing function_call.name for choice ${d}`);return{...m,message:{content:f,function_call:{arguments:T,name:N},role:E,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:p}}return b?{...m,index:d,finish_reason:l,logprobs:p,message:{..._,role:E,content:f,refusal:c.refusal??null,tool_calls:b.map((T,N)=>{const{function:v,type:A,id:O,...x}=T,{arguments:D,name:U,...Q}=v||{};if(O==null)throw new xe(`missing choices[${d}].tool_calls[${N}].id
${ru(t)}`);if(A==null)throw new xe(`missing choices[${d}].tool_calls[${N}].type
${ru(t)}`);if(U==null)throw new xe(`missing choices[${d}].tool_calls[${N}].function.name
${ru(t)}`);if(D==null)throw new xe(`missing choices[${d}].tool_calls[${N}].function.arguments
${ru(t)}`);return{...x,id:O,type:A,function:{...Q,name:U,arguments:D}}})}}:{...m,message:{..._,content:f,role:E,refusal:c.refusal??null},finish_reason:l,index:d,logprobs:p}}),created:s,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return R3(u,e)}function ru(t){return JSON.stringify(t)}class sa extends Hi{static fromReadableStream(e){const n=new sa(null);return n._run(()=>n._fromReadableStream(e)),n}static runFunctions(e,n,r){const s=new sa(null),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,n,a)),s}static runTools(e,n,r){const s=new sa(n),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,a)),s}}let x1=class extends Ve{parse(e,n){return D3(e.tools),this._client.chat.completions.create(e,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>Bf(r,e))}runFunctions(e,n){return e.stream?sa.runFunctions(this._client,e,n):$i.runFunctions(this._client,e,n)}runTools(e,n){return e.stream?sa.runTools(this._client,e,n):$i.runTools(this._client,e,n)}stream(e,n){return Hi.createChatCompletion(this._client,e,n)}},L1=class extends Ve{constructor(){super(...arguments),this.completions=new x1(this._client)}};(function(t){t.Completions=x1})(L1);class D1 extends Ve{create(e,n){return this._client.post("/realtime/sessions",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class Ff extends Ve{constructor(){super(...arguments),this.sessions=new D1(this._client)}}Ff.Sessions=D1;var ie=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},rn=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Nt,Ch,rr,yu,Ln,is,Zs,es,Qu,an,Eu,wu,fi,ni,ri,jg,$g,Hg,qg,Vg,zg,Wg;class Fn extends p1{constructor(){super(...arguments),Nt.add(this),Ch.set(this,[]),rr.set(this,{}),yu.set(this,{}),Ln.set(this,void 0),is.set(this,void 0),Zs.set(this,void 0),es.set(this,void 0),Qu.set(this,void 0),an.set(this,void 0),Eu.set(this,void 0),wu.set(this,void 0),fi.set(this,void 0)}[(Ch=new WeakMap,rr=new WeakMap,yu=new WeakMap,Ln=new WeakMap,is=new WeakMap,Zs=new WeakMap,es=new WeakMap,Qu=new WeakMap,an=new WeakMap,Eu=new WeakMap,wu=new WeakMap,fi=new WeakMap,Nt=new WeakSet,Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const n=new Fn;return n._run(()=>n._fromReadableStream(e)),n}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=lr.fromReadableStream(e,this.controller);for await(const i of s)ie(this,Nt,"m",ni).call(this,i);if((a=s.controller.signal)!=null&&a.aborted)throw new An;return this._addRun(ie(this,Nt,"m",ri).call(this))}toReadableStream(){return new lr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,n,r,s,a){const i=new Fn;return i._run(()=>i._runToolAssistantStream(e,n,r,s,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,n,r,s,a){var c;const i=a==null?void 0:a.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const o={...s,stream:!0},u=await e.submitToolOutputs(n,r,o,{...a,signal:this.controller.signal});this._connected();for await(const l of u)ie(this,Nt,"m",ni).call(this,l);if((c=u.controller.signal)!=null&&c.aborted)throw new An;return this._addRun(ie(this,Nt,"m",ri).call(this))}static createThreadAssistantStream(e,n,r){const s=new Fn;return s._run(()=>s._threadAssistantStream(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,n,r,s){const a=new Fn;return a._run(()=>a._runAssistantStream(e,n,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return ie(this,Eu,"f")}currentRun(){return ie(this,wu,"f")}currentMessageSnapshot(){return ie(this,Ln,"f")}currentRunStepSnapshot(){return ie(this,fi,"f")}async finalRunSteps(){return await this.done(),Object.values(ie(this,rr,"f"))}async finalMessages(){return await this.done(),Object.values(ie(this,yu,"f"))}async finalRun(){if(await this.done(),!ie(this,is,"f"))throw Error("Final run was not received.");return ie(this,is,"f")}async _createThreadAssistantStream(e,n,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await e.createAndRun(a,{...r,signal:this.controller.signal});this._connected();for await(const u of i)ie(this,Nt,"m",ni).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new An;return this._addRun(ie(this,Nt,"m",ri).call(this))}async _createAssistantStream(e,n,r,s){var u;const a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...r,stream:!0},o=await e.create(n,i,{...s,signal:this.controller.signal});this._connected();for await(const c of o)ie(this,Nt,"m",ni).call(this,c);if((u=o.controller.signal)!=null&&u.aborted)throw new An;return this._addRun(ie(this,Nt,"m",ri).call(this))}static accumulateDelta(e,n){for(const[r,s]of Object.entries(n)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let a=e[r];if(a==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof a=="string"&&typeof s=="string")a+=s;else if(typeof a=="number"&&typeof s=="number")a+=s;else if(ud(a)&&ud(s))a=this.accumulateDelta(a,s);else if(Array.isArray(a)&&Array.isArray(s)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...s);continue}for(const i of s){if(!ud(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const u=a[o];u==null?a.push(i):a[o]=this.accumulateDelta(u,i)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${a}`);e[r]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,n,r){return await this._createThreadAssistantStream(n,e,r)}async _runAssistantStream(e,n,r,s){return await this._createAssistantStream(n,e,r,s)}async _runToolAssistantStream(e,n,r,s,a){return await this._createToolAssistantStream(r,e,n,s,a)}}ni=function(e){if(!this.ended)switch(rn(this,Eu,e,"f"),ie(this,Nt,"m",Hg).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":ie(this,Nt,"m",Wg).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ie(this,Nt,"m",$g).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":ie(this,Nt,"m",jg).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},ri=function(){if(this.ended)throw new xe("stream has ended, this shouldn't happen");if(!ie(this,is,"f"))throw Error("Final run has not been received");return ie(this,is,"f")},jg=function(e){const[n,r]=ie(this,Nt,"m",Vg).call(this,e,ie(this,Ln,"f"));rn(this,Ln,n,"f"),ie(this,yu,"f")[n.id]=n;for(const s of r){const a=n.content[s.index];(a==null?void 0:a.type)=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,n),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let a=s.text,i=n.content[s.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=ie(this,Zs,"f")){if(ie(this,es,"f"))switch(ie(this,es,"f").type){case"text":this._emit("textDone",ie(this,es,"f").text,ie(this,Ln,"f"));break;case"image_file":this._emit("imageFileDone",ie(this,es,"f").image_file,ie(this,Ln,"f"));break}rn(this,Zs,s.index,"f")}rn(this,es,n.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(ie(this,Zs,"f")!==void 0){const s=e.data.content[ie(this,Zs,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,ie(this,Ln,"f"));break;case"text":this._emit("textDone",s.text,ie(this,Ln,"f"));break}}ie(this,Ln,"f")&&this._emit("messageDone",e.data),rn(this,Ln,void 0,"f")}},$g=function(e){const n=ie(this,Nt,"m",qg).call(this,e);switch(rn(this,fi,n,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&n.step_details.type=="tool_calls")for(const a of r.step_details.tool_calls)a.index==ie(this,Qu,"f")?this._emit("toolCallDelta",a,n.step_details.tool_calls[a.index]):(ie(this,an,"f")&&this._emit("toolCallDone",ie(this,an,"f")),rn(this,Qu,a.index,"f"),rn(this,an,n.step_details.tool_calls[a.index],"f"),ie(this,an,"f")&&this._emit("toolCallCreated",ie(this,an,"f")));this._emit("runStepDelta",e.data.delta,n);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":rn(this,fi,void 0,"f"),e.data.step_details.type=="tool_calls"&&ie(this,an,"f")&&(this._emit("toolCallDone",ie(this,an,"f")),rn(this,an,void 0,"f")),this._emit("runStepDone",e.data,n);break}},Hg=function(e){ie(this,Ch,"f").push(e),this._emit("event",e)},qg=function(e){switch(e.event){case"thread.run.step.created":return ie(this,rr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let n=ie(this,rr,"f")[e.data.id];if(!n)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const s=Fn.accumulateDelta(n,r.delta);ie(this,rr,"f")[e.data.id]=s}return ie(this,rr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":ie(this,rr,"f")[e.data.id]=e.data;break}if(ie(this,rr,"f")[e.data.id])return ie(this,rr,"f")[e.data.id];throw new Error("No snapshot available")},Vg=function(e,n){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!n)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const a of s.delta.content)if(a.index in n.content){let i=n.content[a.index];n.content[a.index]=ie(this,Nt,"m",zg).call(this,a,i)}else n.content[a.index]=a,r.push(a);return[n,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(n)return[n,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},zg=function(e,n){return Fn.accumulateDelta(n,e)},Wg=function(e){switch(rn(this,wu,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":rn(this,is,e.data,"f"),ie(this,an,"f")&&(this._emit("toolCallDone",ie(this,an,"f")),rn(this,an,void 0,"f"));break}};class Uf extends Ve{create(e,n,r){return this._client.post(`/threads/${e}/messages`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/threads/${e}/messages/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,n,r,s){return this._client.post(`/threads/${e}/messages/${n}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/threads/${e}/messages`,jf,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n,r){return this._client.delete(`/threads/${e}/messages/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class jf extends Kn{}Uf.MessagesPage=jf;class $f extends Ve{retrieve(e,n,r,s={},a){return nn(s)?this.retrieve(e,n,r,{},s):this._client.get(`/threads/${e}/runs/${n}/steps/${r}`,{query:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,n,r={},s){return nn(r)?this.list(e,n,{},r):this._client.getAPIList(`/threads/${e}/runs/${n}/steps`,Hf,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}}class Hf extends Kn{}$f.RunStepsPage=Hf;class mo extends Ve{constructor(){super(...arguments),this.steps=new $f(this._client)}create(e,n,r){const{include:s,...a}=n;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:n.stream??!1})}retrieve(e,n,r){return this._client.get(`/threads/${e}/runs/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,n,r,s){return this._client.post(`/threads/${e}/runs/${n}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/threads/${e}/runs`,qf,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,n,r){return this._client.post(`/threads/${e}/runs/${n}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}createAndStream(e,n,r){return Fn.createAssistantStream(e,this._client.beta.threads.runs,n,r)}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,n,{...r,headers:{...r==null?void 0:r.headers,...s}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await lo(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,n,r){return Fn.createAssistantStream(e,this._client.beta.threads.runs,n,r)}submitToolOutputs(e,n,r,s){return this._client.post(`/threads/${e}/runs/${n}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,n,r,s){const a=await this.submitToolOutputs(e,n,r,s);return await this.poll(e,a.id,s)}submitToolOutputsStream(e,n,r,s){return Fn.createToolAssistantStream(e,n,this._client.beta.threads.runs,r,s)}}class qf extends Kn{}mo.RunsPage=qf;mo.Steps=$f;mo.RunStepsPage=Hf;class Sa extends Ve{constructor(){super(...arguments),this.runs=new mo(this._client),this.messages=new Uf(this._client)}create(e={},n){return nn(e)?this.create({},e):this._client.post("/threads",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/threads/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/threads/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n){return this._client.delete(`/threads/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}createAndRun(e,n){return this._client.post("/threads/runs",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers},stream:e.stream??!1})}async createAndRunPoll(e,n){const r=await this.createAndRun(e,n);return await this.runs.poll(r.thread_id,r.id,n)}createAndRunStream(e,n){return Fn.createThreadAssistantStream(e,this._client.beta.threads,n)}}Sa.Runs=mo;Sa.RunsPage=qf;Sa.Messages=Uf;Sa.MessagesPage=jf;const H3=async t=>{const e=await Promise.allSettled(t),n=e.filter(s=>s.status==="rejected");if(n.length){for(const s of n)console.error(s.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const s of e)s.status==="fulfilled"&&r.push(s.value);return r};let Vf=class extends Ve{create(e,n,r){return this._client.post(`/vector_stores/${e}/files`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/vector_stores/${e}/files/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/vector_stores/${e}/files`,Zc,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n,r){return this._client.delete(`/vector_stores/${e}/files/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const a=await this.retrieve(e,n,{...r,headers:s}).withResponse(),i=a.data;switch(i.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=a.response.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await lo(o);break;case"failed":case"completed":return i}}}async upload(e,n,r){const s=await this._client.files.create({file:n,purpose:"assistants"},r);return this.create(e,{file_id:s.id},r)}async uploadAndPoll(e,n,r){const s=await this.upload(e,n,r);return await this.poll(e,s.id,r)}};class Zc extends Kn{}Vf.VectorStoreFilesPage=Zc;class M1 extends Ve{create(e,n,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/vector_stores/${e}/file_batches/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,n,r){return this._client.post(`/vector_stores/${e}/file_batches/${n}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n);return await this.poll(e,s.id,r)}listFiles(e,n,r={},s){return nn(r)?this.listFiles(e,n,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${n}/files`,Zc,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,n,{...r,headers:s}).withResponse();switch(a.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{const u=i.headers.get("openai-poll-after-ms");if(u){const c=parseInt(u);isNaN(c)||(o=c)}}await lo(o);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:n,fileIds:r=[]},s){if(n==null||n.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(s==null?void 0:s.maxConcurrency)??5,i=Math.min(a,n.length),o=this._client,u=n.values(),c=[...r];async function l(p){for(let m of p){const f=await o.files.create({file:m,purpose:"assistants"},s);c.push(f.id)}}const d=Array(i).fill(u).map(l);return await H3(d),await this.createAndPoll(e,{file_ids:c})}}class Aa extends Ve{constructor(){super(...arguments),this.files=new Vf(this._client),this.fileBatches=new M1(this._client)}create(e,n){return this._client.post("/vector_stores",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/vector_stores/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/vector_stores/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/vector_stores",zf,{query:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,n){return this._client.delete(`/vector_stores/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class zf extends Kn{}Aa.VectorStoresPage=zf;Aa.Files=Vf;Aa.VectorStoreFilesPage=Zc;Aa.FileBatches=M1;class Yr extends Ve{constructor(){super(...arguments),this.realtime=new Ff(this._client),this.vectorStores=new Aa(this._client),this.chat=new L1(this._client),this.assistants=new Df(this._client),this.threads=new Sa(this._client)}}Yr.Realtime=Ff;Yr.VectorStores=Aa;Yr.VectorStoresPage=zf;Yr.Assistants=Df;Yr.AssistantsPage=Mf;Yr.Threads=Sa;class B1 extends Ve{create(e,n){return this._client.post("/completions",{body:e,...n,stream:e.stream??!1})}}class F1 extends Ve{create(e,n){return this._client.post("/embeddings",{body:e,...n})}}class Wf extends Ve{create(e,n){return this._client.post("/files",ha({body:e,...n}))}retrieve(e,n){return this._client.get(`/files/${e}`,n)}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/files",Gf,{query:e,...n})}del(e,n){return this._client.delete(`/files/${e}`,n)}content(e,n){return this._client.get(`/files/${e}/content`,{...n,headers:{Accept:"application/binary",...n==null?void 0:n.headers},__binaryResponse:!0})}retrieveContent(e,n){return this._client.get(`/files/${e}/content`,n)}async waitForProcessing(e,{pollInterval:n=5e3,maxWait:r=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!s.has(i.status);)if(await lo(n),i=await this.retrieve(e),Date.now()-a>r)throw new Gc({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}}class Gf extends Kn{}Wf.FileObjectsPage=Gf;class Kf extends Ve{list(e,n={},r){return nn(n)?this.list(e,{},n):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Yf,{query:n,...r})}}class Yf extends Kn{}Kf.FineTuningJobCheckpointsPage=Yf;class Ca extends Ve{constructor(){super(...arguments),this.checkpoints=new Kf(this._client)}create(e,n){return this._client.post("/fine_tuning/jobs",{body:e,...n})}retrieve(e,n){return this._client.get(`/fine_tuning/jobs/${e}`,n)}list(e={},n){return nn(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Zf,{query:e,...n})}cancel(e,n){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,n)}listEvents(e,n={},r){return nn(n)?this.listEvents(e,{},n):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Jf,{query:n,...r})}}class Zf extends Kn{}class Jf extends Kn{}Ca.FineTuningJobsPage=Zf;Ca.FineTuningJobEventsPage=Jf;Ca.Checkpoints=Kf;Ca.FineTuningJobCheckpointsPage=Yf;class po extends Ve{constructor(){super(...arguments),this.jobs=new Ca(this._client)}}po.Jobs=Ca;po.FineTuningJobsPage=Zf;po.FineTuningJobEventsPage=Jf;class U1 extends Ve{createVariation(e,n){return this._client.post("/images/variations",ha({body:e,...n}))}edit(e,n){return this._client.post("/images/edits",ha({body:e,...n}))}generate(e,n){return this._client.post("/images/generations",{body:e,...n})}}class Xf extends Ve{retrieve(e,n){return this._client.get(`/models/${e}`,n)}list(e){return this._client.getAPIList("/models",Qf,e)}del(e,n){return this._client.delete(`/models/${e}`,n)}}class Qf extends I3{}Xf.ModelsPage=Qf;class j1 extends Ve{create(e,n){return this._client.post("/moderations",{body:e,...n})}}class $1 extends Ve{create(e,n,r){return this._client.post(`/uploads/${e}/parts`,ha({body:n,...r}))}}class em extends Ve{constructor(){super(...arguments),this.parts=new $1(this._client)}create(e,n){return this._client.post("/uploads",{body:e,...n})}cancel(e,n){return this._client.post(`/uploads/${e}/cancel`,n)}complete(e,n,r){return this._client.post(`/uploads/${e}/complete`,{body:n,...r})}}em.Parts=$1;var H1;let De=class extends p3{constructor({baseURL:e=Qo("OPENAI_BASE_URL"),apiKey:n=Qo("OPENAI_API_KEY"),organization:r=Qo("OPENAI_ORG_ID")??null,project:s=Qo("OPENAI_PROJECT_ID")??null,...a}={}){if(n===void 0)throw new xe("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:n,organization:r,project:s,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&O3())throw new xe(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new B1(this),this.chat=new Pf(this),this.embeddings=new F1(this),this.files=new Wf(this),this.images=new U1(this),this.audio=new ho(this),this.moderations=new j1(this),this.models=new Xf(this),this.fineTuning=new po(this),this.beta=new Yr(this),this.batches=new xf(this),this.uploads=new em(this),this._options=i,this.apiKey=n,this.organization=r,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return XP(e,{arrayFormat:"brackets"})}};H1=De;De.OpenAI=H1;De.DEFAULT_TIMEOUT=6e5;De.OpenAIError=xe;De.APIError=kt;De.APIConnectionError=Wc;De.APIConnectionTimeoutError=Gc;De.APIUserAbortError=An;De.NotFoundError=Wy;De.ConflictError=Gy;De.RateLimitError=Yy;De.BadRequestError=qy;De.AuthenticationError=Vy;De.InternalServerError=Zy;De.PermissionDeniedError=zy;De.UnprocessableEntityError=Ky;De.toFile=n1;De.fileFromPath=$y;De.Completions=B1;De.Chat=Pf;De.Embeddings=F1;De.Files=Wf;De.FileObjectsPage=Gf;De.Images=U1;De.Audio=ho;De.Moderations=j1;De.Models=Xf;De.ModelsPage=Qf;De.FineTuning=po;De.Beta=Yr;De.Batches=xf;De.BatchesPage=Lf;De.Uploads=em;function q1(t,e){if(t.function===void 0)return;let n;if(e!=null&&e.partial)try{n=lf(t.function.arguments??"{}")}catch{return}else try{n=JSON.parse(t.function.arguments)}catch(s){throw new ji([`Function "${t.function.name}" arguments:`,"",t.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const r={name:t.function.name,args:n,type:"tool_call"};return e!=null&&e.returnId&&(r.id=t.id),r}function q3(t){if(t.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.args)}}}function V3(t,e){var n,r;return{name:(n=t.function)==null?void 0:n.name,args:(r=t.function)==null?void 0:r.arguments,id:t.id,error:e,type:"invalid_tool_call"}}class z3 extends Ry{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,n=!0){var i;const r=e[0].message;let s;if(ro(r)&&((i=r.tool_calls)!=null&&i.length)?s=r.tool_calls.map(o=>{const{id:u,...c}=o;return this.returnId?{id:u,...c}:c}):r.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(u=>q1(u,{returnId:this.returnId,partial:n}))),!s)return[];const a=[];for(const o of s)if(o!==void 0){const u={type:o.name,args:o.args,id:o.id};a.push(u)}return a}}class Gg extends z3{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const n=await this.zodSchema.safeParseAsync(e);if(n.success)return n.data;throw new ji(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(n.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const r=(await super.parsePartialResult(e)).filter(a=>a.type===this.keyName);let s=r;if(r.length)return this.returnId||(s=r.map(a=>a.args)),this.returnSingle?s[0]:s}async parseResult(e){const r=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName);let s=r;return r.length?(this.returnId||(s=r.map(i=>i.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(i=>this._validateResult(i)))):void 0}}const W3=Symbol("Let zodToJsonSchema decide on which parser to use"),Kg={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},G3=t=>typeof t=="string"?{...Kg,basePath:["#"],definitions:{},name:t}:{...Kg,basePath:["#"],definitions:{},...t},Oh=t=>"_def"in t?t._def:t;function K3(t){if(!t)return!0;for(const e in t)return!1;return!0}const Y3=t=>{const e=G3(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[Oh(s),{def:Oh(s),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function V1(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function We(t,e,n,r,s){t[e]=n,V1(t,e,r,s)}function Z3(){return{}}function J3(t,e){var r,s;const n={type:"array"};return((s=(r=t.type)==null?void 0:r._def)==null?void 0:s.typeName)!==H.ZodAny&&(n.items=$e(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&We(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&We(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(We(n,"minItems",t.exactLength.value,t.exactLength.message,e),We(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function X3(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?We(n,"minimum",r.value,r.message,e):We(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),We(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?We(n,"maximum",r.value,r.message,e):We(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),We(n,"maximum",r.value,r.message,e));break;case"multipleOf":We(n,"multipleOf",r.value,r.message,e);break}return n}function Q3(){return{type:"boolean"}}function ex(t,e){return $e(t.type._def,e)}const tx=(t,e)=>$e(t.innerType._def,e);function z1(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,a)=>z1(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return nx(t,e)}}const nx=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":We(n,"minimum",r.value,r.message,e);break;case"max":We(n,"maximum",r.value,r.message,e);break}return n};function rx(t,e){return{...$e(t.innerType._def,e),default:t.defaultValue()}}function sx(t,e,n){return e.effectStrategy==="input"?$e(t.schema._def,e,n):{}}function ax(t){return{type:"string",enum:[...t.values]}}const ix=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function ox(t,e){const n=[$e(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),$e(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(a=>{if(ix(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...u}=a;i=u}else r=void 0;s.push(i)}}),s.length?{allOf:s,...r}:void 0}function ux(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let md;const Xr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(md===void 0&&(md=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),md),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function W1(t,e){const n={type:"string"};function r(s){return e.patternStrategy==="escape"?cx(s):s}if(t.checks)for(const s of t.checks)switch(s.kind){case"min":We(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e);break;case"max":We(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Rn(n,"email",s.message,e);break;case"format:idn-email":Rn(n,"idn-email",s.message,e);break;case"pattern:zod":Pn(n,Xr.email,s.message,e);break}break;case"url":Rn(n,"uri",s.message,e);break;case"uuid":Rn(n,"uuid",s.message,e);break;case"regex":Pn(n,s.regex,s.message,e);break;case"cuid":Pn(n,Xr.cuid,s.message,e);break;case"cuid2":Pn(n,Xr.cuid2,s.message,e);break;case"startsWith":Pn(n,RegExp(`^${r(s.value)}`),s.message,e);break;case"endsWith":Pn(n,RegExp(`${r(s.value)}$`),s.message,e);break;case"datetime":Rn(n,"date-time",s.message,e);break;case"date":Rn(n,"date",s.message,e);break;case"time":Rn(n,"time",s.message,e);break;case"duration":Rn(n,"duration",s.message,e);break;case"length":We(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e),We(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"includes":{Pn(n,RegExp(r(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&Rn(n,"ipv4",s.message,e),s.version!=="v4"&&Rn(n,"ipv6",s.message,e);break}case"emoji":Pn(n,Xr.emoji,s.message,e);break;case"ulid":{Pn(n,Xr.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Rn(n,"binary",s.message,e);break}case"contentEncoding:base64":{We(n,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{Pn(n,Xr.base64,s.message,e);break}}break}case"nanoid":Pn(n,Xr.nanoid,s.message,e)}return n}const cx=t=>Array.from(t).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Rn=(t,e,n,r)=>{var s;t.format||(s=t.anyOf)!=null&&s.some(a=>a.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):We(t,"format",e,n,r)},Pn=(t,e,n,r)=>{var s;t.pattern||(s=t.allOf)!=null&&s.some(a=>a.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:Yg(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):We(t,"pattern",Yg(e,r),n,r)},Yg=(t,e)=>{var c;const n=typeof t=="function"?t():t;if(!e.applyRegexFlags||!n.flags)return n.source;const r={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},s=r.i?n.source.toLowerCase():n.source;let a="",i=!1,o=!1,u=!1;for(let l=0;l<s.length;l++){if(i){a+=s[l],i=!1;continue}if(r.i){if(o){if(s[l].match(/[a-z]/)){u?(a+=s[l],a+=`${s[l-2]}-${s[l]}`.toUpperCase(),u=!1):s[l+1]==="-"&&((c=s[l+2])!=null&&c.match(/[a-z]/))?(a+=s[l],u=!0):a+=`${s[l]}${s[l].toUpperCase()}`;continue}}else if(s[l].match(/[a-z]/)){a+=`[${s[l]}${s[l].toUpperCase()}]`;continue}}if(r.m){if(s[l]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(s[l]==="$"){a+=`($|(?=[\r
]))`;continue}}if(r.s&&s[l]==="."){a+=o?`${s[l]}\r
`:`[${s[l]}\r
]`;continue}a+=s[l],s[l]==="\\"?i=!0:o&&s[l]==="]"?o=!1:!o&&s[l]==="["&&(o=!0)}try{const l=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a};function G1(t,e){var r,s,a,i;if(e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===H.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((o,u)=>({...o,[u]:$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===H.ZodString&&((a=t.keyType._def.checks)!=null&&a.length)){const o=Object.entries(W1(t.keyType._def,e)).reduce((u,[c,l])=>c==="type"?u:{...u,[c]:l},{});return{...n,propertyNames:o}}else if(((i=t.keyType)==null?void 0:i._def.typeName)===H.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};return n}function lx(t,e){if(e.mapStrategy==="record")return G1(t,e);const n=$e(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function dx(t){const e=t.values,r=Object.keys(t.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function hx(){return{not:{}}}function fx(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const ec={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function mx(t,e){if(e.target==="openApi3")return Zg(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in ec&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,a)=>{const i=ec[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":if(a._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:n.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return Zg(t,e)}const Zg=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>$e(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function px(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:ec[t.innerType._def.typeName],nullable:!0}:{type:[ec[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=$e(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=$e(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function gx(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",V1(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?We(n,"minimum",r.value,r.message,e):We(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),We(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?We(n,"maximum",r.value,r.message,e):We(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),We(n,"maximum",r.value,r.message,e));break;case"multipleOf":We(n,"multipleOf",r.value,r.message,e);break}return n}function bx(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":$e(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":$e(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function _x(t,e){const n={type:"object",...Object.entries(t.shape()).reduce((r,[s,a])=>{if(a===void 0||a._def===void 0)return r;const i=$e(a._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return i===void 0?r:{properties:{...r.properties,[s]:i},required:a.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,s]}},{properties:{},required:[]}),additionalProperties:bx(t,e)};return n.required.length||delete n.required,n}const yx=(t,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return $e(t.innerType._def,e);const n=$e(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},Ex=(t,e)=>{if(e.pipeStrategy==="input")return $e(t.in._def,e);if(e.pipeStrategy==="output")return $e(t.out._def,e);const n=$e(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=$e(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function wx(t,e){return $e(t.type._def,e)}function Tx(t,e){const r={type:"array",uniqueItems:!0,items:$e(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&We(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&We(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function Sx(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>$e(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:$e(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>$e(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function Ax(){return{not:{}}}function Cx(){return{}}const Ox=(t,e)=>$e(t.innerType._def,e);function $e(t,e,n=!1){var i;const r=e.seen.get(t);if(e.override){const o=(i=e.override)==null?void 0:i.call(e,t,e,r,n);if(o!==W3)return o}if(r&&!n){const o=vx(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const a=Nx(t,t.typeName,e,n);return a&&kx(t,e,a),s.jsonSchema=a,a}const vx=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"extract-to-root":const n=t.path.slice(e.basePath.length+1).join("_");return n!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[n]=t.def),{$ref:[...e.basePath,e.definitionPath,n].join("/")};case"relative":return{$ref:Ix(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((r,s)=>e.currentPath[s]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Ix=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")},Nx=(t,e,n,r)=>{switch(e){case H.ZodString:return W1(t,n);case H.ZodNumber:return gx(t,n);case H.ZodObject:return _x(t,n);case H.ZodBigInt:return X3(t,n);case H.ZodBoolean:return Q3();case H.ZodDate:return z1(t,n);case H.ZodUndefined:return Ax();case H.ZodNull:return fx(n);case H.ZodArray:return J3(t,n);case H.ZodUnion:case H.ZodDiscriminatedUnion:return mx(t,n);case H.ZodIntersection:return ox(t,n);case H.ZodTuple:return Sx(t,n);case H.ZodRecord:return G1(t,n);case H.ZodLiteral:return ux(t,n);case H.ZodEnum:return ax(t);case H.ZodNativeEnum:return dx(t);case H.ZodNullable:return px(t,n);case H.ZodOptional:return yx(t,n);case H.ZodMap:return lx(t,n);case H.ZodSet:return Tx(t,n);case H.ZodLazy:return $e(t.getter()._def,n);case H.ZodPromise:return wx(t,n);case H.ZodNaN:case H.ZodNever:return hx();case H.ZodEffects:return sx(t,n,r);case H.ZodAny:return Z3();case H.ZodUnknown:return Cx();case H.ZodDefault:return rx(t,n);case H.ZodBranded:return ex(t,n);case H.ZodReadonly:return Ox(t,n);case H.ZodCatch:return tx(t,n);case H.ZodPipeline:return Ex(t,n);case H.ZodFunction:case H.ZodVoid:case H.ZodSymbol:return;default:return(s=>{})()}},kx=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),Rx=(t,e)=>{const n=Y3(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=$e(t._def,r===void 0?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(s.title=a);const i=(()=>{if(K3(n.definitions))return;const u={},c=new Set;for(let l=0;l<500;l++){const d=Object.entries(n.definitions).filter(([p])=>!c.has(p));if(d.length===0)break;for(const[p,m]of d)u[p]=$e(Oh(m),{...n,currentPath:[...n.basePath,n.definitionPath,p]},!0)??{},c.add(p)}return u})(),o=r===void 0?i?{...s,[n.definitionPath]:i}:s:n.nameStrategy==="duplicate-ref"?{...s,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[r]:s}:void 0}}:void 0}:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...i,[r]:s}};return n.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":n.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function K1(t,e){return Rx(t,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Px(t,e,n){return N3({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:K1(t,{name:e})}},r=>t.parse(JSON.parse(r)))}function xx(t){return k3({type:"function",function:{name:t.name,parameters:K1(t.parameters,{name:t.name}),strict:!0,...t.description?{description:t.description}:void 0}},{callback:t.function,parser:e=>t.parameters.parse(JSON.parse(e))})}function Lx(t){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:a,azureADTokenProvider:i,azureOpenAIEndpoint:o}=t;if((r||i)&&s&&e)return`${s}/${e}`;if((r||i)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${e}`}return a}function su(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,t}function Jg(t){let e;return t.constructor.name===Gc.name?(e=new Error(t.message),e.name="TimeoutError"):t.constructor.name===An.name?(e=new Error(t.message),e.name="AbortError"):t.status===400&&t.message.includes("tool_calls")?e=su(t,"INVALID_TOOL_RESULTS"):t.status===401?e=su(t,"MODEL_AUTHENTICATION"):t.status===429?e=su(t,"MODEL_RATE_LIMIT"):t.status===404?e=su(t,"MODEL_NOT_FOUND"):e=t,e}function Dx(t){if(t)return t==="any"||t==="required"?"required":t==="auto"?"auto":t==="none"?"none":typeof t=="string"?{type:"function",function:{name:t}}:t}function Mx(t){return t.anyOf!==void 0&&Array.isArray(t.anyOf)}function Bx(t){const e=["namespace functions {",""];for(const n of t)n.description&&e.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(e.push(`type ${n.name} = (_: {`),e.push(Y1(n.parameters,0)),e.push("}) => any;")):e.push(`type ${n.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Y1(t,e){var r;const n=[];for(const[s,a]of Object.entries(t.properties??{}))a.description&&e<2&&n.push(`// ${a.description}`),(r=t.required)!=null&&r.includes(s)?n.push(`${s}: ${tc(a,e)},`):n.push(`${s}?: ${tc(a,e)},`);return n.map(s=>" ".repeat(e)+s).join(`
`)}function tc(t,e){if(Mx(t))return t.anyOf.map(n=>tc(n,e)).join(" | ");switch(t.type){case"string":return t.enum?t.enum.map(n=>`"${n}"`).join(" | "):"string";case"number":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"integer":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Y1(t,e+2),"}"].join(`
`);case"array":return t.items?`${tc(t.items,e)}[]`:"any[]";default:return""}}function Fx(t,e){let n;if(Iy(t)){const r=xx({name:t.name,parameters:t.schema,description:t.description});r.function.parameters?n={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...(e==null?void 0:e.strict)!==void 0?{strict:e.strict}:{}}}:n={type:"function",function:IP(t,e)}}else n=t;return(e==null?void 0:e.strict)!==void 0&&(n.function.strict=e.strict),n}function Ux(t){return t.role!=="system"&&t.role!=="developer"&&t.role!=="assistant"&&t.role!=="user"&&t.role!=="function"&&t.role!=="tool"&&console.warn(`Unknown message role: ${t.role}`),t.role}function Z1(t){const e=t._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!so.isInstance(t))throw new Error("Invalid generic chat message");return Ux(t)}default:throw new Error(`Unknown message type: ${e}`)}}function Xg(t,e){return t.flatMap(n=>{var a;let r=Z1(n);r==="system"&&(e!=null&&e.startsWith("o1"))&&(r="developer");const s={role:r,content:n.content};if(n.name!=null&&(s.name=n.name),n.additional_kwargs.function_call!=null&&(s.function_call=n.additional_kwargs.function_call,s.content=null),ro(n)&&((a=n.tool_calls)!=null&&a.length)?(s.tool_calls=n.tool_calls.map(q3),s.content=null):(n.additional_kwargs.tool_calls!=null&&(s.tool_calls=n.additional_kwargs.tool_calls),n.tool_call_id!=null&&(s.tool_call_id=n.tool_call_id)),n.additional_kwargs.audio&&typeof n.additional_kwargs.audio=="object"&&"id"in n.additional_kwargs.audio){const i={role:"assistant",audio:{id:n.additional_kwargs.audio.id}};return[s,i]}return s})}function Qg(t,e){return Oy(t)?(e==null?void 0:e.strict)!==void 0?{...t,function:{...t.function,strict:e.strict}}:t:Fx(t,e)}class vh extends Sr{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}constructor(e){var n,r;super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((n=e==null?void 0:e.configuration)==null?void 0:n.apiKey)??fn("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??fn("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelName=this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this==null?void 0:this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=e==null?void 0:e.reasoningEffort,this.model==="o1"&&(this.disableStreaming=!0),this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const n=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:n.temperature??void 0,ls_max_tokens:n.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,n){let r;return(n==null?void 0:n.strict)!==void 0?r=n.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(s=>Qg(s,{strict:r})),...n})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&au(e.json_schema.schema)?Px(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,n){var o;let r;(e==null?void 0:e.strict)!==void 0?r=e.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling);let s={};(e==null?void 0:e.stream_options)!==void 0?s={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||n!=null&&n.streaming)&&(s={stream_options:{include_usage:!0}});const a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(o=e==null?void 0:e.tools)!=null&&o.length?e.tools.map(u=>Qg(u,{strict:r})):void 0,tool_choice:Dx(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...s,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(a.prediction=e.prediction);const i=(e==null?void 0:e.reasoning_effort)??this.reasoningEffort;return i!==void 0&&(a.reasoning_effort=i),a}_convertOpenAIChatCompletionMessageToBaseMessage(e,n){const r=e.tool_calls;switch(e.role){case"assistant":{const s=[],a=[];for(const u of r??[])try{s.push(q1(u,{returnId:!0}))}catch(c){a.push(V3(u,c.message))}const i={function_call:e.function_call,tool_calls:r};this.__includeRawResponse!==void 0&&(i.__raw_response=n);const o={model_name:n.model,...n.system_fingerprint?{usage:{...n.usage},system_fingerprint:n.system_fingerprint}:{}};return e.audio&&(i.audio=e.audio),new bs({content:e.content||"",tool_calls:s,invalid_tool_calls:a,additional_kwargs:i,response_metadata:o,id:n.id})}default:return new so(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,n,r){var u,c;const s=e.role??r,a=e.content??"";let i;e.function_call?i={function_call:e.function_call}:e.tool_calls?i={tool_calls:e.tool_calls}:i={},this.__includeRawResponse&&(i.__raw_response=n),e.audio&&(i.audio={...e.audio,index:n.choices[0].index});const o={usage:{...n.usage}};if(s==="user")return new Lc({content:a,response_metadata:o});if(s==="assistant"){const l=[];if(Array.isArray(e.tool_calls))for(const d of e.tool_calls)l.push({name:(u=d.function)==null?void 0:u.name,args:(c=d.function)==null?void 0:c.arguments,id:d.id,index:d.index,type:"tool_call_chunk"});return new Yt({content:a,tool_call_chunks:l,additional_kwargs:i,id:n.id,response_metadata:o})}else return s==="system"?new Si({content:a,response_metadata:o}):s==="developer"?new Si({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new xc({content:a,additional_kwargs:i,name:e.name,response_metadata:o}):s==="tool"?new df({content:a,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new Pc({content:a,role:s,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,n,r){var c,l,d,p,m,f,g,b,_,E;const s=Xg(e,this.model),a={...this.invocationParams(n,{streaming:!0}),messages:s,stream:!0};let i;const o=await this.completionWithRetry(a,n);let u;for await(const T of o){const N=(c=T==null?void 0:T.choices)==null?void 0:c[0];if(T.usage&&(u=T.usage),!N)continue;const{delta:v}=N;if(!v)continue;const A=this._convertOpenAIDeltaToBaseMessageChunk(v,T,i);i=v.role??i;const O={prompt:n.promptIndex??0,completion:N.index??0};if(typeof A.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const x={...O};N.finish_reason!=null&&(x.finish_reason=N.finish_reason,x.system_fingerprint=T.system_fingerprint,x.model_name=T.model),this.logprobs&&(x.logprobs=N.logprobs);const D=new ws({message:A,text:A.content,generationInfo:x});yield D,await(r==null?void 0:r.handleLLMNewToken(D.text??"",O,void 0,void 0,void 0,{chunk:D}))}if(u){const T={...((l=u.prompt_tokens_details)==null?void 0:l.audio_tokens)!==null&&{audio:(d=u.prompt_tokens_details)==null?void 0:d.audio_tokens},...((p=u.prompt_tokens_details)==null?void 0:p.cached_tokens)!==null&&{cache_read:(m=u.prompt_tokens_details)==null?void 0:m.cached_tokens}},N={...((f=u.completion_tokens_details)==null?void 0:f.audio_tokens)!==null&&{audio:(g=u.completion_tokens_details)==null?void 0:g.audio_tokens},...((b=u.completion_tokens_details)==null?void 0:b.reasoning_tokens)!==null&&{reasoning:(_=u.completion_tokens_details)==null?void 0:_.reasoning_tokens}};yield new ws({message:new Yt({content:"",response_metadata:{usage:{...u}},usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens,...Object.keys(T).length>0&&{input_token_details:T},...Object.keys(N).length>0&&{output_token_details:N}}}),text:""})}if((E=n.signal)!=null&&E.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,n,r){var o,u;const s={},a=this.invocationParams(n),i=Xg(e,this.model);if(a.stream){const c=this._streamResponseChunks(e,n,r),l={};for await(const b of c){b.message.response_metadata={...b.generationInfo,...b.message.response_metadata};const _=((o=b.generationInfo)==null?void 0:o.completion)??0;l[_]===void 0?l[_]=b:l[_]=l[_].concat(b)}const d=Object.entries(l).sort(([b],[_])=>parseInt(b,10)-parseInt(_,10)).map(([b,_])=>_),{functions:p,function_call:m}=this.invocationParams(n),f=await this.getEstimatedTokenCountFromPrompt(e,p,m),g=await this.getNumTokensFromGenerations(d);return s.input_tokens=f,s.output_tokens=g,s.total_tokens=f+g,{generations:d,llmOutput:{estimatedTokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}else{let c;n.response_format&&n.response_format.type==="json_schema"?c=await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:i},{signal:n==null?void 0:n.signal,...n==null?void 0:n.options}):c=await this.completionWithRetry({...a,stream:!1,messages:i},{signal:n==null?void 0:n.signal,...n==null?void 0:n.options});const{completion_tokens:l,prompt_tokens:d,total_tokens:p,prompt_tokens_details:m,completion_tokens_details:f}=(c==null?void 0:c.usage)??{};l&&(s.output_tokens=(s.output_tokens??0)+l),d&&(s.input_tokens=(s.input_tokens??0)+d),p&&(s.total_tokens=(s.total_tokens??0)+p),((m==null?void 0:m.audio_tokens)!==null||(m==null?void 0:m.cached_tokens)!==null)&&(s.input_token_details={...(m==null?void 0:m.audio_tokens)!==null&&{audio:m==null?void 0:m.audio_tokens},...(m==null?void 0:m.cached_tokens)!==null&&{cache_read:m==null?void 0:m.cached_tokens}}),((f==null?void 0:f.audio_tokens)!==null||(f==null?void 0:f.reasoning_tokens)!==null)&&(s.output_token_details={...(f==null?void 0:f.audio_tokens)!==null&&{audio:f==null?void 0:f.audio_tokens},...(f==null?void 0:f.reasoning_tokens)!==null&&{reasoning:f==null?void 0:f.reasoning_tokens}});const g=[];for(const b of(c==null?void 0:c.choices)??[]){const E={text:((u=b.message)==null?void 0:u.content)??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(b.message??{role:"assistant"},c)};E.generationInfo={...b.finish_reason?{finish_reason:b.finish_reason}:{},...b.logprobs?{logprobs:b.logprobs}:{}},ro(E.message)&&(E.message.usage_metadata=s),E.message=new bs(Object.fromEntries(Object.entries(E.message).filter(([T])=>!T.startsWith("lc_")))),g.push(E)}return{generations:g,llmOutput:{tokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,n,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(n&&r!=="auto"){const a=Bx(n);s+=await this.getNumTokens(a),s+=9}return n&&e.find(a=>a._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async getNumTokensFromMessages(e){let n=0,r=0,s=0;this.model==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const a=await Promise.all(e.map(async i=>{var p,m,f,g,b,_;const o=await this.getNumTokens(i.content),u=await this.getNumTokens(Z1(i)),c=i.name!==void 0?s+await this.getNumTokens(i.name):0;let l=o+r+u+c;const d=i;if(d._getType()==="function"&&(l-=2),(p=d.additional_kwargs)!=null&&p.function_call&&(l+=3),(m=d==null?void 0:d.additional_kwargs.function_call)!=null&&m.name&&(l+=await this.getNumTokens((f=d.additional_kwargs.function_call)==null?void 0:f.name)),(g=d.additional_kwargs.function_call)!=null&&g.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((b=d.additional_kwargs.function_call)==null?void 0:b.arguments)))}catch(E){console.error("Error parsing function arguments",E,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((_=d.additional_kwargs.function_call)==null?void 0:_.arguments)}return n+=l,l}));return n+=3,{totalCount:n,countPerMessage:a}}async completionWithRetry(e,n){const r=this._getClientOptions(n);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(s){throw Jg(s)}})}async betaParsedCompletionWithRetry(e,n){const r=this._getClientOptions(n);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(s){throw Jg(s)}})}_getClientOptions(e){if(!this.client){const r={baseURL:this.clientConfig.baseURL},s=Lx(r),a={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};a.baseURL||delete a.baseURL,this.client=new De(a)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((n,r)=>(r&&r.tokenUsage&&(n.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,n.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,n.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),n),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,n){let r,s,a,i;jx(e)?(r=e.schema,s=e.name,a=e.method,i=e.includeRaw):(r=e,s=n==null?void 0:n.name,a=n==null?void 0:n.method,i=n==null?void 0:n.includeRaw);let o,u;if((n==null?void 0:n.strict)!==void 0&&a==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?a===void 0&&(a="jsonSchema"):a==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),a==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),au(r)?u=wg.fromZodSchema(r):u=new Tg;else if(a==="jsonSchema")o=this.bind({response_format:{type:"json_schema",json_schema:{name:s??"extract",description:r.description,schema:r,strict:n==null?void 0:n.strict}}}),au(r)?u=wg.fromZodSchema(r):u=new Tg;else{let p=s??"extract";if(au(r)){const m=Ts(r);o=this.bind({tools:[{type:"function",function:{name:p,description:m.description,parameters:m}}],tool_choice:{type:"function",function:{name:p}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),u=new Gg({returnSingle:!0,keyName:p,zodSchema:r})}else{let m;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(m=r,p=r.name):(p=r.title??p,m={name:p,description:r.description??"",parameters:r}),o=this.bind({tools:[{type:"function",function:m}],tool_choice:{type:"function",function:{name:p}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),u=new Gg({returnSingle:!0,keyName:p})}}if(!i)return o.pipe(u);const c=da.assign({parsed:(p,m)=>u.invoke(p.raw,m)}),l=da.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return cr.from([{raw:o},d])}}function au(t){return typeof(t==null?void 0:t.parse)=="function"}function jx(t){return t!==void 0&&typeof t.schema=="object"}class $x extends vy{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=(e==null?void 0:e.verboseParsingErrors)??this.verboseParsingErrors,this.responseFormat=(e==null?void 0:e.responseFormat)??this.responseFormat}async invoke(e,n){let r,s,a=Be(n);return hf(e)?(r=e.id,s=e.args,a={...a,toolCall:e,configurable:{...a.configurable,tool_call_id:r}}):s=e,this.call(s,a)}async call(e,n,r){let s;try{s=await this.schema.parseAsync(e)}catch(m){let f="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(f=`${f}
Details: ${m.message}`),new R_(f,JSON.stringify(e))}const a=my(n),i=Lt.configure(a.callbacks,this.callbacks,a.tags||r,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o=await(i==null?void 0:i.handleToolStart(this.toJSON(),typeof s=="string"?s:JSON.stringify(s),a.runId,void 0,void 0,void 0,a.runName));delete a.runId;let u;try{u=await this._call(s,o,a)}catch(m){throw await(o==null?void 0:o.handleToolError(m)),m}let c,l;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[c,l]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else c=u;let d;a&&"configurable"in a&&(d=a.configurable.tool_call_id);const p=qx({content:c,artifact:l,toolCallId:d,name:this.name});return await(o==null?void 0:o.handleToolEnd(p)),p}}class Hx extends $x{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Ar.object({input:Ar.string().optional()}).transform(n=>n.input)})}call(e,n){return super.call(typeof e=="string"||!e?{input:e}:e,n)}}function qx(t){const{content:e,artifact:n,toolCallId:r}=t;return r&&!cC(e)?typeof e=="string"||Array.isArray(e)&&e.every(s=>typeof s=="object")?new Yd({content:e,artifact:n,tool_call_id:r,name:t.name}):new Yd({content:Vx(e),artifact:n,tool_call_id:r,name:t.name}):e}function Vx(t){try{return JSON.stringify(t,null,2)}catch{return`${t}`}}class zx extends Hx{static lc_name(){return"SearxngSearch"}get lc_secrets(){return{apiBase:"SEARXNG_API_BASE"}}constructor({apiBase:e,params:n,headers:r}){if(super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"searxng-search"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A meta search engine. Useful for when you need to answer questions about current events. Input should be a search query. Output is a JSON array of the query results"}),Object.defineProperty(this,"apiBase",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:{numResults:10,pageNumber:1,format:"json",imageProxy:!0,safesearch:0}}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.apiBase=fn("SEARXNG_API_BASE")||e,this.headers={"content-type":"application/json",...r},!this.apiBase)throw new Error('SEARXNG_API_BASE not set. You can set it as "SEARXNG_API_BASE" in your environment variables.');n&&(this.params={...this.params,...n})}buildUrl(e,n,r){const s=Object.entries(n).filter(([i,o])=>o!==void 0).map(([i,o])=>[i,o.toString()]),a=new URLSearchParams(s);return`${r}/${e}?${a}`}async _call(e){var i,o;const n={q:e,...this.params},r=this.buildUrl("search",n,this.apiBase),s=await fetch(r,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(5*1e3)});if(!s.ok)throw new Error(s.statusText);const a=await s.json();if(!a.results.length&&!a.answers.length&&!a.infoboxes.length&&!a.suggestions.length)return"No good results found.";if(a.results.length){const u=[];return a.results.forEach(c=>{u.push(JSON.stringify({title:c.title||"",link:c.url||"",snippet:c.content||""}))}),u.slice(0,(i=this.params)==null?void 0:i.numResults).toString()}else{if(a.answers.length)return a.answers[0];if(a.infoboxes.length)return(o=a.infoboxes[0])==null?void 0:o.content.replaceAll(/<[^>]+>/gi,"");if(a.suggestions.length){let u="Suggestions: ";return a.suggestions.forEach(c=>{u+=`${c}, `}),u}else return"No good results found."}}}function J1(t,e){return function(){return t.apply(e,arguments)}}const{toString:Wx}=Object.prototype,{getPrototypeOf:tm}=Object,Jc=(t=>e=>{const n=Wx.call(e);return t[n]||(t[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),Yn=t=>(t=t.toLowerCase(),e=>Jc(e)===t),Xc=t=>e=>typeof e===t,{isArray:Oa}=Array,qi=Xc("undefined");function Gx(t){return t!==null&&!qi(t)&&t.constructor!==null&&!qi(t.constructor)&&mn(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const X1=Yn("ArrayBuffer");function Kx(t){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(t):e=t&&t.buffer&&X1(t.buffer),e}const Yx=Xc("string"),mn=Xc("function"),Q1=Xc("number"),Qc=t=>t!==null&&typeof t=="object",Zx=t=>t===!0||t===!1,Tu=t=>{if(Jc(t)!=="object")return!1;const e=tm(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},Jx=Yn("Date"),Xx=Yn("File"),Qx=Yn("Blob"),e6=Yn("FileList"),t6=t=>Qc(t)&&mn(t.pipe),n6=t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||mn(t.append)&&((e=Jc(t))==="formdata"||e==="object"&&mn(t.toString)&&t.toString()==="[object FormData]"))},r6=Yn("URLSearchParams"),[s6,a6,i6,o6]=["ReadableStream","Request","Response","Headers"].map(Yn),u6=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function go(t,e,{allOwnKeys:n=!1}={}){if(t===null||typeof t>"u")return;let r,s;if(typeof t!="object"&&(t=[t]),Oa(t))for(r=0,s=t.length;r<s;r++)e.call(null,t[r],r,t);else{const a=n?Object.getOwnPropertyNames(t):Object.keys(t),i=a.length;let o;for(r=0;r<i;r++)o=a[r],e.call(null,t[o],o,t)}}function eE(t,e){e=e.toLowerCase();const n=Object.keys(t);let r=n.length,s;for(;r-- >0;)if(s=n[r],e===s.toLowerCase())return s;return null}const os=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,tE=t=>!qi(t)&&t!==os;function Ih(){const{caseless:t}=tE(this)&&this||{},e={},n=(r,s)=>{const a=t&&eE(e,s)||s;Tu(e[a])&&Tu(r)?e[a]=Ih(e[a],r):Tu(r)?e[a]=Ih({},r):Oa(r)?e[a]=r.slice():e[a]=r};for(let r=0,s=arguments.length;r<s;r++)arguments[r]&&go(arguments[r],n);return e}const c6=(t,e,n,{allOwnKeys:r}={})=>(go(e,(s,a)=>{n&&mn(s)?t[a]=J1(s,n):t[a]=s},{allOwnKeys:r}),t),l6=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),d6=(t,e,n,r)=>{t.prototype=Object.create(e.prototype,r),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},h6=(t,e,n,r)=>{let s,a,i;const o={};if(e=e||{},t==null)return e;do{for(s=Object.getOwnPropertyNames(t),a=s.length;a-- >0;)i=s[a],(!r||r(i,t,e))&&!o[i]&&(e[i]=t[i],o[i]=!0);t=n!==!1&&tm(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},f6=(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;const r=t.indexOf(e,n);return r!==-1&&r===n},m6=t=>{if(!t)return null;if(Oa(t))return t;let e=t.length;if(!Q1(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},p6=(t=>e=>t&&e instanceof t)(typeof Uint8Array<"u"&&tm(Uint8Array)),g6=(t,e)=>{const r=(t&&t[Symbol.iterator]).call(t);let s;for(;(s=r.next())&&!s.done;){const a=s.value;e.call(t,a[0],a[1])}},b6=(t,e)=>{let n;const r=[];for(;(n=t.exec(e))!==null;)r.push(n);return r},_6=Yn("HTMLFormElement"),y6=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(n,r,s){return r.toUpperCase()+s}),e0=(({hasOwnProperty:t})=>(e,n)=>t.call(e,n))(Object.prototype),E6=Yn("RegExp"),nE=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),r={};go(n,(s,a)=>{let i;(i=e(s,a,t))!==!1&&(r[a]=i||s)}),Object.defineProperties(t,r)},w6=t=>{nE(t,(e,n)=>{if(mn(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const r=t[n];if(mn(r)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")})}})},T6=(t,e)=>{const n={},r=s=>{s.forEach(a=>{n[a]=!0})};return Oa(t)?r(t):r(String(t).split(e)),n},S6=()=>{},A6=(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,pd="abcdefghijklmnopqrstuvwxyz",t0="0123456789",rE={DIGIT:t0,ALPHA:pd,ALPHA_DIGIT:pd+pd.toUpperCase()+t0},C6=(t=16,e=rE.ALPHA_DIGIT)=>{let n="";const{length:r}=e;for(;t--;)n+=e[Math.random()*r|0];return n};function O6(t){return!!(t&&mn(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])}const v6=t=>{const e=new Array(10),n=(r,s)=>{if(Qc(r)){if(e.indexOf(r)>=0)return;if(!("toJSON"in r)){e[s]=r;const a=Oa(r)?[]:{};return go(r,(i,o)=>{const u=n(i,s+1);!qi(u)&&(a[o]=u)}),e[s]=void 0,a}}return r};return n(t,0)},I6=Yn("AsyncFunction"),N6=t=>t&&(Qc(t)||mn(t))&&mn(t.then)&&mn(t.catch),sE=((t,e)=>t?setImmediate:e?((n,r)=>(os.addEventListener("message",({source:s,data:a})=>{s===os&&a===n&&r.length&&r.shift()()},!1),s=>{r.push(s),os.postMessage(n,"*")}))(`axios@${Math.random()}`,[]):n=>setTimeout(n))(typeof setImmediate=="function",mn(os.postMessage)),k6=typeof queueMicrotask<"u"?queueMicrotask.bind(os):typeof process<"u"&&process.nextTick||sE,$={isArray:Oa,isArrayBuffer:X1,isBuffer:Gx,isFormData:n6,isArrayBufferView:Kx,isString:Yx,isNumber:Q1,isBoolean:Zx,isObject:Qc,isPlainObject:Tu,isReadableStream:s6,isRequest:a6,isResponse:i6,isHeaders:o6,isUndefined:qi,isDate:Jx,isFile:Xx,isBlob:Qx,isRegExp:E6,isFunction:mn,isStream:t6,isURLSearchParams:r6,isTypedArray:p6,isFileList:e6,forEach:go,merge:Ih,extend:c6,trim:u6,stripBOM:l6,inherits:d6,toFlatObject:h6,kindOf:Jc,kindOfTest:Yn,endsWith:f6,toArray:m6,forEachEntry:g6,matchAll:b6,isHTMLForm:_6,hasOwnProperty:e0,hasOwnProp:e0,reduceDescriptors:nE,freezeMethods:w6,toObjectSet:T6,toCamelCase:y6,noop:S6,toFiniteNumber:A6,findKey:eE,global:os,isContextDefined:tE,ALPHABET:rE,generateString:C6,isSpecCompliantForm:O6,toJSONObject:v6,isAsyncFn:I6,isThenable:N6,setImmediate:sE,asap:k6};function ye(t,e,n,r,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),r&&(this.request=r),s&&(this.response=s,this.status=s.status?s.status:null)}$.inherits(ye,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:$.toJSONObject(this.config),code:this.code,status:this.status}}});const aE=ye.prototype,iE={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{iE[t]={value:t}});Object.defineProperties(ye,iE);Object.defineProperty(aE,"isAxiosError",{value:!0});ye.from=(t,e,n,r,s,a)=>{const i=Object.create(aE);return $.toFlatObject(t,i,function(u){return u!==Error.prototype},o=>o!=="isAxiosError"),ye.call(i,t.message,e,n,r,s),i.cause=t,i.name=t.name,a&&Object.assign(i,a),i};const R6=null;function Nh(t){return $.isPlainObject(t)||$.isArray(t)}function oE(t){return $.endsWith(t,"[]")?t.slice(0,-2):t}function n0(t,e,n){return t?t.concat(e).map(function(s,a){return s=oE(s),!n&&a?"["+s+"]":s}).join(n?".":""):e}function P6(t){return $.isArray(t)&&!t.some(Nh)}const x6=$.toFlatObject($,{},null,function(e){return/^is[A-Z]/.test(e)});function el(t,e,n){if(!$.isObject(t))throw new TypeError("target must be an object");e=e||new FormData,n=$.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(g,b){return!$.isUndefined(b[g])});const r=n.metaTokens,s=n.visitor||l,a=n.dots,i=n.indexes,u=(n.Blob||typeof Blob<"u"&&Blob)&&$.isSpecCompliantForm(e);if(!$.isFunction(s))throw new TypeError("visitor must be a function");function c(f){if(f===null)return"";if($.isDate(f))return f.toISOString();if(!u&&$.isBlob(f))throw new ye("Blob is not supported. Use a Buffer instead.");return $.isArrayBuffer(f)||$.isTypedArray(f)?u&&typeof Blob=="function"?new Blob([f]):Buffer.from(f):f}function l(f,g,b){let _=f;if(f&&!b&&typeof f=="object"){if($.endsWith(g,"{}"))g=r?g:g.slice(0,-2),f=JSON.stringify(f);else if($.isArray(f)&&P6(f)||($.isFileList(f)||$.endsWith(g,"[]"))&&(_=$.toArray(f)))return g=oE(g),_.forEach(function(T,N){!($.isUndefined(T)||T===null)&&e.append(i===!0?n0([g],N,a):i===null?g:g+"[]",c(T))}),!1}return Nh(f)?!0:(e.append(n0(b,g,a),c(f)),!1)}const d=[],p=Object.assign(x6,{defaultVisitor:l,convertValue:c,isVisitable:Nh});function m(f,g){if(!$.isUndefined(f)){if(d.indexOf(f)!==-1)throw Error("Circular reference detected in "+g.join("."));d.push(f),$.forEach(f,function(_,E){(!($.isUndefined(_)||_===null)&&s.call(e,_,$.isString(E)?E.trim():E,g,p))===!0&&m(_,g?g.concat(E):[E])}),d.pop()}}if(!$.isObject(t))throw new TypeError("data must be an object");return m(t),e}function r0(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(r){return e[r]})}function nm(t,e){this._pairs=[],t&&el(t,this,e)}const uE=nm.prototype;uE.append=function(e,n){this._pairs.push([e,n])};uE.toString=function(e){const n=e?function(r){return e.call(this,r,r0)}:r0;return this._pairs.map(function(s){return n(s[0])+"="+n(s[1])},"").join("&")};function L6(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function cE(t,e,n){if(!e)return t;const r=n&&n.encode||L6;$.isFunction(n)&&(n={serialize:n});const s=n&&n.serialize;let a;if(s?a=s(e,n):a=$.isURLSearchParams(e)?e.toString():new nm(e,n).toString(r),a){const i=t.indexOf("#");i!==-1&&(t=t.slice(0,i)),t+=(t.indexOf("?")===-1?"?":"&")+a}return t}class s0{constructor(){this.handlers=[]}use(e,n,r){return this.handlers.push({fulfilled:e,rejected:n,synchronous:r?r.synchronous:!1,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){$.forEach(this.handlers,function(r){r!==null&&e(r)})}}const lE={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},D6=typeof URLSearchParams<"u"?URLSearchParams:nm,M6=typeof FormData<"u"?FormData:null,B6=typeof Blob<"u"?Blob:null,F6={isBrowser:!0,classes:{URLSearchParams:D6,FormData:M6,Blob:B6},protocols:["http","https","file","blob","url","data"]},rm=typeof window<"u"&&typeof document<"u",kh=typeof navigator=="object"&&navigator||void 0,U6=rm&&(!kh||["ReactNative","NativeScript","NS"].indexOf(kh.product)<0),j6=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",$6=rm&&window.location.href||"http://localhost",H6=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:rm,hasStandardBrowserEnv:U6,hasStandardBrowserWebWorkerEnv:j6,navigator:kh,origin:$6},Symbol.toStringTag,{value:"Module"})),xt={...H6,...F6};function q6(t,e){return el(t,new xt.classes.URLSearchParams,Object.assign({visitor:function(n,r,s,a){return xt.isNode&&$.isBuffer(n)?(this.append(r,n.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},e))}function V6(t){return $.matchAll(/\w+|\[(\w*)]/g,t).map(e=>e[0]==="[]"?"":e[1]||e[0])}function z6(t){const e={},n=Object.keys(t);let r;const s=n.length;let a;for(r=0;r<s;r++)a=n[r],e[a]=t[a];return e}function dE(t){function e(n,r,s,a){let i=n[a++];if(i==="__proto__")return!0;const o=Number.isFinite(+i),u=a>=n.length;return i=!i&&$.isArray(s)?s.length:i,u?($.hasOwnProp(s,i)?s[i]=[s[i],r]:s[i]=r,!o):((!s[i]||!$.isObject(s[i]))&&(s[i]=[]),e(n,r,s[i],a)&&$.isArray(s[i])&&(s[i]=z6(s[i])),!o)}if($.isFormData(t)&&$.isFunction(t.entries)){const n={};return $.forEachEntry(t,(r,s)=>{e(V6(r),s,n,0)}),n}return null}function W6(t,e,n){if($.isString(t))try{return(e||JSON.parse)(t),$.trim(t)}catch(r){if(r.name!=="SyntaxError")throw r}return(0,JSON.stringify)(t)}const bo={transitional:lE,adapter:["xhr","http","fetch"],transformRequest:[function(e,n){const r=n.getContentType()||"",s=r.indexOf("application/json")>-1,a=$.isObject(e);if(a&&$.isHTMLForm(e)&&(e=new FormData(e)),$.isFormData(e))return s?JSON.stringify(dE(e)):e;if($.isArrayBuffer(e)||$.isBuffer(e)||$.isStream(e)||$.isFile(e)||$.isBlob(e)||$.isReadableStream(e))return e;if($.isArrayBufferView(e))return e.buffer;if($.isURLSearchParams(e))return n.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(a){if(r.indexOf("application/x-www-form-urlencoded")>-1)return q6(e,this.formSerializer).toString();if((o=$.isFileList(e))||r.indexOf("multipart/form-data")>-1){const u=this.env&&this.env.FormData;return el(o?{"files[]":e}:e,u&&new u,this.formSerializer)}}return a||s?(n.setContentType("application/json",!1),W6(e)):e}],transformResponse:[function(e){const n=this.transitional||bo.transitional,r=n&&n.forcedJSONParsing,s=this.responseType==="json";if($.isResponse(e)||$.isReadableStream(e))return e;if(e&&$.isString(e)&&(r&&!this.responseType||s)){const i=!(n&&n.silentJSONParsing)&&s;try{return JSON.parse(e)}catch(o){if(i)throw o.name==="SyntaxError"?ye.from(o,ye.ERR_BAD_RESPONSE,this,null,this.response):o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:xt.classes.FormData,Blob:xt.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};$.forEach(["delete","get","head","post","put","patch"],t=>{bo.headers[t]={}});const G6=$.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),K6=t=>{const e={};let n,r,s;return t&&t.split(`
`).forEach(function(i){s=i.indexOf(":"),n=i.substring(0,s).trim().toLowerCase(),r=i.substring(s+1).trim(),!(!n||e[n]&&G6[n])&&(n==="set-cookie"?e[n]?e[n].push(r):e[n]=[r]:e[n]=e[n]?e[n]+", "+r:r)}),e},a0=Symbol("internals");function qa(t){return t&&String(t).trim().toLowerCase()}function Su(t){return t===!1||t==null?t:$.isArray(t)?t.map(Su):String(t)}function Y6(t){const e=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=n.exec(t);)e[r[1]]=r[2];return e}const Z6=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function gd(t,e,n,r,s){if($.isFunction(r))return r.call(this,e,n);if(s&&(e=n),!!$.isString(e)){if($.isString(r))return e.indexOf(r)!==-1;if($.isRegExp(r))return r.test(e)}}function J6(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,n,r)=>n.toUpperCase()+r)}function X6(t,e){const n=$.toCamelCase(" "+e);["get","set","has"].forEach(r=>{Object.defineProperty(t,r+n,{value:function(s,a,i){return this[r].call(this,e,s,a,i)},configurable:!0})})}class en{constructor(e){e&&this.set(e)}set(e,n,r){const s=this;function a(o,u,c){const l=qa(u);if(!l)throw new Error("header name must be a non-empty string");const d=$.findKey(s,l);(!d||s[d]===void 0||c===!0||c===void 0&&s[d]!==!1)&&(s[d||u]=Su(o))}const i=(o,u)=>$.forEach(o,(c,l)=>a(c,l,u));if($.isPlainObject(e)||e instanceof this.constructor)i(e,n);else if($.isString(e)&&(e=e.trim())&&!Z6(e))i(K6(e),n);else if($.isHeaders(e))for(const[o,u]of e.entries())a(u,o,r);else e!=null&&a(n,e,r);return this}get(e,n){if(e=qa(e),e){const r=$.findKey(this,e);if(r){const s=this[r];if(!n)return s;if(n===!0)return Y6(s);if($.isFunction(n))return n.call(this,s,r);if($.isRegExp(n))return n.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=qa(e),e){const r=$.findKey(this,e);return!!(r&&this[r]!==void 0&&(!n||gd(this,this[r],r,n)))}return!1}delete(e,n){const r=this;let s=!1;function a(i){if(i=qa(i),i){const o=$.findKey(r,i);o&&(!n||gd(r,r[o],o,n))&&(delete r[o],s=!0)}}return $.isArray(e)?e.forEach(a):a(e),s}clear(e){const n=Object.keys(this);let r=n.length,s=!1;for(;r--;){const a=n[r];(!e||gd(this,this[a],a,e,!0))&&(delete this[a],s=!0)}return s}normalize(e){const n=this,r={};return $.forEach(this,(s,a)=>{const i=$.findKey(r,a);if(i){n[i]=Su(s),delete n[a];return}const o=e?J6(a):String(a).trim();o!==a&&delete n[a],n[o]=Su(s),r[o]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const n=Object.create(null);return $.forEach(this,(r,s)=>{r!=null&&r!==!1&&(n[s]=e&&$.isArray(r)?r.join(", "):r)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,n])=>e+": "+n).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...n){const r=new this(e);return n.forEach(s=>r.set(s)),r}static accessor(e){const r=(this[a0]=this[a0]={accessors:{}}).accessors,s=this.prototype;function a(i){const o=qa(i);r[o]||(X6(s,i),r[o]=!0)}return $.isArray(e)?e.forEach(a):a(e),this}}en.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);$.reduceDescriptors(en.prototype,({value:t},e)=>{let n=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(r){this[n]=r}}});$.freezeMethods(en);function bd(t,e){const n=this||bo,r=e||n,s=en.from(r.headers);let a=r.data;return $.forEach(t,function(o){a=o.call(n,a,s.normalize(),e?e.status:void 0)}),s.normalize(),a}function hE(t){return!!(t&&t.__CANCEL__)}function va(t,e,n){ye.call(this,t??"canceled",ye.ERR_CANCELED,e,n),this.name="CanceledError"}$.inherits(va,ye,{__CANCEL__:!0});function fE(t,e,n){const r=n.config.validateStatus;!n.status||!r||r(n.status)?t(n):e(new ye("Request failed with status code "+n.status,[ye.ERR_BAD_REQUEST,ye.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n))}function Q6(t){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}function eL(t,e){t=t||10;const n=new Array(t),r=new Array(t);let s=0,a=0,i;return e=e!==void 0?e:1e3,function(u){const c=Date.now(),l=r[a];i||(i=c),n[s]=u,r[s]=c;let d=a,p=0;for(;d!==s;)p+=n[d++],d=d%t;if(s=(s+1)%t,s===a&&(a=(a+1)%t),c-i<e)return;const m=l&&c-l;return m?Math.round(p*1e3/m):void 0}}function tL(t,e){let n=0,r=1e3/e,s,a;const i=(c,l=Date.now())=>{n=l,s=null,a&&(clearTimeout(a),a=null),t.apply(null,c)};return[(...c)=>{const l=Date.now(),d=l-n;d>=r?i(c,l):(s=c,a||(a=setTimeout(()=>{a=null,i(s)},r-d)))},()=>s&&i(s)]}const nc=(t,e,n=3)=>{let r=0;const s=eL(50,250);return tL(a=>{const i=a.loaded,o=a.lengthComputable?a.total:void 0,u=i-r,c=s(u),l=i<=o;r=i;const d={loaded:i,total:o,progress:o?i/o:void 0,bytes:u,rate:c||void 0,estimated:c&&o&&l?(o-i)/c:void 0,event:a,lengthComputable:o!=null,[e?"download":"upload"]:!0};t(d)},n)},i0=(t,e)=>{const n=t!=null;return[r=>e[0]({lengthComputable:n,total:t,loaded:r}),e[1]]},o0=t=>(...e)=>$.asap(()=>t(...e)),nL=xt.hasStandardBrowserEnv?((t,e)=>n=>(n=new URL(n,xt.origin),t.protocol===n.protocol&&t.host===n.host&&(e||t.port===n.port)))(new URL(xt.origin),xt.navigator&&/(msie|trident)/i.test(xt.navigator.userAgent)):()=>!0,rL=xt.hasStandardBrowserEnv?{write(t,e,n,r,s,a){const i=[t+"="+encodeURIComponent(e)];$.isNumber(n)&&i.push("expires="+new Date(n).toGMTString()),$.isString(r)&&i.push("path="+r),$.isString(s)&&i.push("domain="+s),a===!0&&i.push("secure"),document.cookie=i.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function sL(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function aL(t,e){return e?t.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):t}function mE(t,e){return t&&!sL(e)?aL(t,e):e}const u0=t=>t instanceof en?{...t}:t;function As(t,e){e=e||{};const n={};function r(c,l,d,p){return $.isPlainObject(c)&&$.isPlainObject(l)?$.merge.call({caseless:p},c,l):$.isPlainObject(l)?$.merge({},l):$.isArray(l)?l.slice():l}function s(c,l,d,p){if($.isUndefined(l)){if(!$.isUndefined(c))return r(void 0,c,d,p)}else return r(c,l,d,p)}function a(c,l){if(!$.isUndefined(l))return r(void 0,l)}function i(c,l){if($.isUndefined(l)){if(!$.isUndefined(c))return r(void 0,c)}else return r(void 0,l)}function o(c,l,d){if(d in e)return r(c,l);if(d in t)return r(void 0,c)}const u={url:a,method:a,data:a,baseURL:i,transformRequest:i,transformResponse:i,paramsSerializer:i,timeout:i,timeoutMessage:i,withCredentials:i,withXSRFToken:i,adapter:i,responseType:i,xsrfCookieName:i,xsrfHeaderName:i,onUploadProgress:i,onDownloadProgress:i,decompress:i,maxContentLength:i,maxBodyLength:i,beforeRedirect:i,transport:i,httpAgent:i,httpsAgent:i,cancelToken:i,socketPath:i,responseEncoding:i,validateStatus:o,headers:(c,l,d)=>s(u0(c),u0(l),d,!0)};return $.forEach(Object.keys(Object.assign({},t,e)),function(l){const d=u[l]||s,p=d(t[l],e[l],l);$.isUndefined(p)&&d!==o||(n[l]=p)}),n}const pE=t=>{const e=As({},t);let{data:n,withXSRFToken:r,xsrfHeaderName:s,xsrfCookieName:a,headers:i,auth:o}=e;e.headers=i=en.from(i),e.url=cE(mE(e.baseURL,e.url),t.params,t.paramsSerializer),o&&i.set("Authorization","Basic "+btoa((o.username||"")+":"+(o.password?unescape(encodeURIComponent(o.password)):"")));let u;if($.isFormData(n)){if(xt.hasStandardBrowserEnv||xt.hasStandardBrowserWebWorkerEnv)i.setContentType(void 0);else if((u=i.getContentType())!==!1){const[c,...l]=u?u.split(";").map(d=>d.trim()).filter(Boolean):[];i.setContentType([c||"multipart/form-data",...l].join("; "))}}if(xt.hasStandardBrowserEnv&&(r&&$.isFunction(r)&&(r=r(e)),r||r!==!1&&nL(e.url))){const c=s&&a&&rL.read(a);c&&i.set(s,c)}return e},iL=typeof XMLHttpRequest<"u",oL=iL&&function(t){return new Promise(function(n,r){const s=pE(t);let a=s.data;const i=en.from(s.headers).normalize();let{responseType:o,onUploadProgress:u,onDownloadProgress:c}=s,l,d,p,m,f;function g(){m&&m(),f&&f(),s.cancelToken&&s.cancelToken.unsubscribe(l),s.signal&&s.signal.removeEventListener("abort",l)}let b=new XMLHttpRequest;b.open(s.method.toUpperCase(),s.url,!0),b.timeout=s.timeout;function _(){if(!b)return;const T=en.from("getAllResponseHeaders"in b&&b.getAllResponseHeaders()),v={data:!o||o==="text"||o==="json"?b.responseText:b.response,status:b.status,statusText:b.statusText,headers:T,config:t,request:b};fE(function(O){n(O),g()},function(O){r(O),g()},v),b=null}"onloadend"in b?b.onloadend=_:b.onreadystatechange=function(){!b||b.readyState!==4||b.status===0&&!(b.responseURL&&b.responseURL.indexOf("file:")===0)||setTimeout(_)},b.onabort=function(){b&&(r(new ye("Request aborted",ye.ECONNABORTED,t,b)),b=null)},b.onerror=function(){r(new ye("Network Error",ye.ERR_NETWORK,t,b)),b=null},b.ontimeout=function(){let N=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const v=s.transitional||lE;s.timeoutErrorMessage&&(N=s.timeoutErrorMessage),r(new ye(N,v.clarifyTimeoutError?ye.ETIMEDOUT:ye.ECONNABORTED,t,b)),b=null},a===void 0&&i.setContentType(null),"setRequestHeader"in b&&$.forEach(i.toJSON(),function(N,v){b.setRequestHeader(v,N)}),$.isUndefined(s.withCredentials)||(b.withCredentials=!!s.withCredentials),o&&o!=="json"&&(b.responseType=s.responseType),c&&([p,f]=nc(c,!0),b.addEventListener("progress",p)),u&&b.upload&&([d,m]=nc(u),b.upload.addEventListener("progress",d),b.upload.addEventListener("loadend",m)),(s.cancelToken||s.signal)&&(l=T=>{b&&(r(!T||T.type?new va(null,t,b):T),b.abort(),b=null)},s.cancelToken&&s.cancelToken.subscribe(l),s.signal&&(s.signal.aborted?l():s.signal.addEventListener("abort",l)));const E=Q6(s.url);if(E&&xt.protocols.indexOf(E)===-1){r(new ye("Unsupported protocol "+E+":",ye.ERR_BAD_REQUEST,t));return}b.send(a||null)})},uL=(t,e)=>{const{length:n}=t=t?t.filter(Boolean):[];if(e||n){let r=new AbortController,s;const a=function(c){if(!s){s=!0,o();const l=c instanceof Error?c:this.reason;r.abort(l instanceof ye?l:new va(l instanceof Error?l.message:l))}};let i=e&&setTimeout(()=>{i=null,a(new ye(`timeout ${e} of ms exceeded`,ye.ETIMEDOUT))},e);const o=()=>{t&&(i&&clearTimeout(i),i=null,t.forEach(c=>{c.unsubscribe?c.unsubscribe(a):c.removeEventListener("abort",a)}),t=null)};t.forEach(c=>c.addEventListener("abort",a));const{signal:u}=r;return u.unsubscribe=()=>$.asap(o),u}},cL=function*(t,e){let n=t.byteLength;if(n<e){yield t;return}let r=0,s;for(;r<n;)s=r+e,yield t.slice(r,s),r=s},lL=async function*(t,e){for await(const n of dL(t))yield*cL(n,e)},dL=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const e=t.getReader();try{for(;;){const{done:n,value:r}=await e.read();if(n)break;yield r}}finally{await e.cancel()}},c0=(t,e,n,r)=>{const s=lL(t,e);let a=0,i,o=u=>{i||(i=!0,r&&r(u))};return new ReadableStream({async pull(u){try{const{done:c,value:l}=await s.next();if(c){o(),u.close();return}let d=l.byteLength;if(n){let p=a+=d;n(p)}u.enqueue(new Uint8Array(l))}catch(c){throw o(c),c}},cancel(u){return o(u),s.return()}},{highWaterMark:2})},tl=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",gE=tl&&typeof ReadableStream=="function",hL=tl&&(typeof TextEncoder=="function"?(t=>e=>t.encode(e))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),bE=(t,...e)=>{try{return!!t(...e)}catch{return!1}},fL=gE&&bE(()=>{let t=!1;const e=new Request(xt.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),l0=64*1024,Rh=gE&&bE(()=>$.isReadableStream(new Response("").body)),rc={stream:Rh&&(t=>t.body)};tl&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!rc[e]&&(rc[e]=$.isFunction(t[e])?n=>n[e]():(n,r)=>{throw new ye(`Response type '${e}' is not supported`,ye.ERR_NOT_SUPPORT,r)})})})(new Response);const mL=async t=>{if(t==null)return 0;if($.isBlob(t))return t.size;if($.isSpecCompliantForm(t))return(await new Request(xt.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if($.isArrayBufferView(t)||$.isArrayBuffer(t))return t.byteLength;if($.isURLSearchParams(t)&&(t=t+""),$.isString(t))return(await hL(t)).byteLength},pL=async(t,e)=>{const n=$.toFiniteNumber(t.getContentLength());return n??mL(e)},gL=tl&&(async t=>{let{url:e,method:n,data:r,signal:s,cancelToken:a,timeout:i,onDownloadProgress:o,onUploadProgress:u,responseType:c,headers:l,withCredentials:d="same-origin",fetchOptions:p}=pE(t);c=c?(c+"").toLowerCase():"text";let m=uL([s,a&&a.toAbortSignal()],i),f;const g=m&&m.unsubscribe&&(()=>{m.unsubscribe()});let b;try{if(u&&fL&&n!=="get"&&n!=="head"&&(b=await pL(l,r))!==0){let v=new Request(e,{method:"POST",body:r,duplex:"half"}),A;if($.isFormData(r)&&(A=v.headers.get("content-type"))&&l.setContentType(A),v.body){const[O,x]=i0(b,nc(o0(u)));r=c0(v.body,l0,O,x)}}$.isString(d)||(d=d?"include":"omit");const _="credentials"in Request.prototype;f=new Request(e,{...p,signal:m,method:n.toUpperCase(),headers:l.normalize().toJSON(),body:r,duplex:"half",credentials:_?d:void 0});let E=await fetch(f);const T=Rh&&(c==="stream"||c==="response");if(Rh&&(o||T&&g)){const v={};["status","statusText","headers"].forEach(D=>{v[D]=E[D]});const A=$.toFiniteNumber(E.headers.get("content-length")),[O,x]=o&&i0(A,nc(o0(o),!0))||[];E=new Response(c0(E.body,l0,O,()=>{x&&x(),g&&g()}),v)}c=c||"text";let N=await rc[$.findKey(rc,c)||"text"](E,t);return!T&&g&&g(),await new Promise((v,A)=>{fE(v,A,{data:N,headers:en.from(E.headers),status:E.status,statusText:E.statusText,config:t,request:f})})}catch(_){throw g&&g(),_&&_.name==="TypeError"&&/fetch/i.test(_.message)?Object.assign(new ye("Network Error",ye.ERR_NETWORK,t,f),{cause:_.cause||_}):ye.from(_,_&&_.code,t,f)}}),Ph={http:R6,xhr:oL,fetch:gL};$.forEach(Ph,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const d0=t=>`- ${t}`,bL=t=>$.isFunction(t)||t===null||t===!1,_E={getAdapter:t=>{t=$.isArray(t)?t:[t];const{length:e}=t;let n,r;const s={};for(let a=0;a<e;a++){n=t[a];let i;if(r=n,!bL(n)&&(r=Ph[(i=String(n)).toLowerCase()],r===void 0))throw new ye(`Unknown adapter '${i}'`);if(r)break;s[i||"#"+a]=r}if(!r){const a=Object.entries(s).map(([o,u])=>`adapter ${o} `+(u===!1?"is not supported by the environment":"is not available in the build"));let i=e?a.length>1?`since :
`+a.map(d0).join(`
`):" "+d0(a[0]):"as no adapter specified";throw new ye("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return r},adapters:Ph};function _d(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new va(null,t)}function h0(t){return _d(t),t.headers=en.from(t.headers),t.data=bd.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),_E.getAdapter(t.adapter||bo.adapter)(t).then(function(r){return _d(t),r.data=bd.call(t,t.transformResponse,r),r.headers=en.from(r.headers),r},function(r){return hE(r)||(_d(t),r&&r.response&&(r.response.data=bd.call(t,t.transformResponse,r.response),r.response.headers=en.from(r.response.headers))),Promise.reject(r)})}const yE="1.7.9",nl={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{nl[t]=function(r){return typeof r===t||"a"+(e<1?"n ":" ")+t}});const f0={};nl.transitional=function(e,n,r){function s(a,i){return"[Axios v"+yE+"] Transitional option '"+a+"'"+i+(r?". "+r:"")}return(a,i,o)=>{if(e===!1)throw new ye(s(i," has been removed"+(n?" in "+n:"")),ye.ERR_DEPRECATED);return n&&!f0[i]&&(f0[i]=!0,console.warn(s(i," has been deprecated since v"+n+" and will be removed in the near future"))),e?e(a,i,o):!0}};nl.spelling=function(e){return(n,r)=>(console.warn(`${r} is likely a misspelling of ${e}`),!0)};function _L(t,e,n){if(typeof t!="object")throw new ye("options must be an object",ye.ERR_BAD_OPTION_VALUE);const r=Object.keys(t);let s=r.length;for(;s-- >0;){const a=r[s],i=e[a];if(i){const o=t[a],u=o===void 0||i(o,a,t);if(u!==!0)throw new ye("option "+a+" must be "+u,ye.ERR_BAD_OPTION_VALUE);continue}if(n!==!0)throw new ye("Unknown option "+a,ye.ERR_BAD_OPTION)}}const Au={assertOptions:_L,validators:nl},er=Au.validators;class ms{constructor(e){this.defaults=e,this.interceptors={request:new s0,response:new s0}}async request(e,n){try{return await this._request(e,n)}catch(r){if(r instanceof Error){let s={};Error.captureStackTrace?Error.captureStackTrace(s):s=new Error;const a=s.stack?s.stack.replace(/^.+\n/,""):"";try{r.stack?a&&!String(r.stack).endsWith(a.replace(/^.+\n.+\n/,""))&&(r.stack+=`
`+a):r.stack=a}catch{}}throw r}}_request(e,n){typeof e=="string"?(n=n||{},n.url=e):n=e||{},n=As(this.defaults,n);const{transitional:r,paramsSerializer:s,headers:a}=n;r!==void 0&&Au.assertOptions(r,{silentJSONParsing:er.transitional(er.boolean),forcedJSONParsing:er.transitional(er.boolean),clarifyTimeoutError:er.transitional(er.boolean)},!1),s!=null&&($.isFunction(s)?n.paramsSerializer={serialize:s}:Au.assertOptions(s,{encode:er.function,serialize:er.function},!0)),Au.assertOptions(n,{baseUrl:er.spelling("baseURL"),withXsrfToken:er.spelling("withXSRFToken")},!0),n.method=(n.method||this.defaults.method||"get").toLowerCase();let i=a&&$.merge(a.common,a[n.method]);a&&$.forEach(["delete","get","head","post","put","patch","common"],f=>{delete a[f]}),n.headers=en.concat(i,a);const o=[];let u=!0;this.interceptors.request.forEach(function(g){typeof g.runWhen=="function"&&g.runWhen(n)===!1||(u=u&&g.synchronous,o.unshift(g.fulfilled,g.rejected))});const c=[];this.interceptors.response.forEach(function(g){c.push(g.fulfilled,g.rejected)});let l,d=0,p;if(!u){const f=[h0.bind(this),void 0];for(f.unshift.apply(f,o),f.push.apply(f,c),p=f.length,l=Promise.resolve(n);d<p;)l=l.then(f[d++],f[d++]);return l}p=o.length;let m=n;for(d=0;d<p;){const f=o[d++],g=o[d++];try{m=f(m)}catch(b){g.call(this,b);break}}try{l=h0.call(this,m)}catch(f){return Promise.reject(f)}for(d=0,p=c.length;d<p;)l=l.then(c[d++],c[d++]);return l}getUri(e){e=As(this.defaults,e);const n=mE(e.baseURL,e.url);return cE(n,e.params,e.paramsSerializer)}}$.forEach(["delete","get","head","options"],function(e){ms.prototype[e]=function(n,r){return this.request(As(r||{},{method:e,url:n,data:(r||{}).data}))}});$.forEach(["post","put","patch"],function(e){function n(r){return function(a,i,o){return this.request(As(o||{},{method:e,headers:r?{"Content-Type":"multipart/form-data"}:{},url:a,data:i}))}}ms.prototype[e]=n(),ms.prototype[e+"Form"]=n(!0)});class sm{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(a){n=a});const r=this;this.promise.then(s=>{if(!r._listeners)return;let a=r._listeners.length;for(;a-- >0;)r._listeners[a](s);r._listeners=null}),this.promise.then=s=>{let a;const i=new Promise(o=>{r.subscribe(o),a=o}).then(s);return i.cancel=function(){r.unsubscribe(a)},i},e(function(a,i,o){r.reason||(r.reason=new va(a,i,o),n(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const e=new AbortController,n=r=>{e.abort(r)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new sm(function(s){e=s}),cancel:e}}}function yL(t){return function(n){return t.apply(null,n)}}function EL(t){return $.isObject(t)&&t.isAxiosError===!0}const xh={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(xh).forEach(([t,e])=>{xh[e]=t});function EE(t){const e=new ms(t),n=J1(ms.prototype.request,e);return $.extend(n,ms.prototype,e,{allOwnKeys:!0}),$.extend(n,e,null,{allOwnKeys:!0}),n.create=function(s){return EE(As(t,s))},n}const Ye=EE(bo);Ye.Axios=ms;Ye.CanceledError=va;Ye.CancelToken=sm;Ye.isCancel=hE;Ye.VERSION=yE;Ye.toFormData=el;Ye.AxiosError=ye;Ye.Cancel=Ye.CanceledError;Ye.all=function(e){return Promise.all(e)};Ye.spread=yL;Ye.isAxiosError=EL;Ye.mergeConfig=As;Ye.AxiosHeaders=en;Ye.formToJSON=t=>dE($.isHTMLForm(t)?new FormData(t):t);Ye.getAdapter=_E.getAdapter;Ye.HttpStatusCode=xh;Ye.default=Ye;var qe;(function(t){t.Root="root",t.Text="text",t.Directive="directive",t.Comment="comment",t.Script="script",t.Style="style",t.Tag="tag",t.CDATA="cdata",t.Doctype="doctype"})(qe||(qe={}));function wL(t){return t.type===qe.Tag||t.type===qe.Script||t.type===qe.Style}const TL=qe.Root,SL=qe.Text,AL=qe.Directive,CL=qe.Comment,OL=qe.Script,vL=qe.Style,IL=qe.Tag,NL=qe.CDATA,kL=qe.Doctype;class wE{constructor(){this.parent=null,this.prev=null,this.next=null,this.startIndex=null,this.endIndex=null}get parentNode(){return this.parent}set parentNode(e){this.parent=e}get previousSibling(){return this.prev}set previousSibling(e){this.prev=e}get nextSibling(){return this.next}set nextSibling(e){this.next=e}cloneNode(e=!1){return zi(this,e)}}class am extends wE{constructor(e){super(),this.data=e}get nodeValue(){return this.data}set nodeValue(e){this.data=e}}class Vi extends am{constructor(){super(...arguments),this.type=qe.Text}get nodeType(){return 3}}class im extends am{constructor(){super(...arguments),this.type=qe.Comment}get nodeType(){return 8}}class om extends am{constructor(e,n){super(n),this.name=e,this.type=qe.Directive}get nodeType(){return 1}}class um extends wE{constructor(e){super(),this.children=e}get firstChild(){var e;return(e=this.children[0])!==null&&e!==void 0?e:null}get lastChild(){return this.children.length>0?this.children[this.children.length-1]:null}get childNodes(){return this.children}set childNodes(e){this.children=e}}class TE extends um{constructor(){super(...arguments),this.type=qe.CDATA}get nodeType(){return 4}}let Cs=class extends um{constructor(){super(...arguments),this.type=qe.Root}get nodeType(){return 9}};class cm extends um{constructor(e,n,r=[],s=e==="script"?qe.Script:e==="style"?qe.Style:qe.Tag){super(r),this.name=e,this.attribs=n,this.type=s}get nodeType(){return 1}get tagName(){return this.name}set tagName(e){this.name=e}get attributes(){return Object.keys(this.attribs).map(e=>{var n,r;return{name:e,value:this.attribs[e],namespace:(n=this["x-attribsNamespace"])===null||n===void 0?void 0:n[e],prefix:(r=this["x-attribsPrefix"])===null||r===void 0?void 0:r[e]}})}}function fe(t){return wL(t)}function rl(t){return t.type===qe.CDATA}function dr(t){return t.type===qe.Text}function sl(t){return t.type===qe.Comment}function Lh(t){return t.type===qe.Directive}function Zr(t){return t.type===qe.Root}function it(t){return Object.prototype.hasOwnProperty.call(t,"children")}function zi(t,e=!1){let n;if(dr(t))n=new Vi(t.data);else if(sl(t))n=new im(t.data);else if(fe(t)){const r=e?yd(t.children):[],s=new cm(t.name,{...t.attribs},r);r.forEach(a=>a.parent=s),t.namespace!=null&&(s.namespace=t.namespace),t["x-attribsNamespace"]&&(s["x-attribsNamespace"]={...t["x-attribsNamespace"]}),t["x-attribsPrefix"]&&(s["x-attribsPrefix"]={...t["x-attribsPrefix"]}),n=s}else if(rl(t)){const r=e?yd(t.children):[],s=new TE(r);r.forEach(a=>a.parent=s),n=s}else if(Zr(t)){const r=e?yd(t.children):[],s=new Cs(r);r.forEach(a=>a.parent=s),t["x-mode"]&&(s["x-mode"]=t["x-mode"]),n=s}else if(Lh(t)){const r=new om(t.name,t.data);t["x-name"]!=null&&(r["x-name"]=t["x-name"],r["x-publicId"]=t["x-publicId"],r["x-systemId"]=t["x-systemId"]),n=r}else throw new Error(`Not implemented yet: ${t.type}`);return n.startIndex=t.startIndex,n.endIndex=t.endIndex,t.sourceCodeLocation!=null&&(n.sourceCodeLocation=t.sourceCodeLocation),n}function yd(t){const e=t.map(n=>zi(n,!0));for(let n=1;n<e.length;n++)e[n].prev=e[n-1],e[n-1].next=e[n];return e}const m0={withStartIndices:!1,withEndIndices:!1,xmlMode:!1};class RL{constructor(e,n,r){this.dom=[],this.root=new Cs(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null,typeof n=="function"&&(r=n,n=m0),typeof e=="object"&&(n=e,e=void 0),this.callback=e??null,this.options=n??m0,this.elementCB=r??null}onparserinit(e){this.parser=e}onreset(){this.dom=[],this.root=new Cs(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null}onend(){this.done||(this.done=!0,this.parser=null,this.handleCallback(null))}onerror(e){this.handleCallback(e)}onclosetag(){this.lastNode=null;const e=this.tagStack.pop();this.options.withEndIndices&&(e.endIndex=this.parser.endIndex),this.elementCB&&this.elementCB(e)}onopentag(e,n){const r=this.options.xmlMode?qe.Tag:void 0,s=new cm(e,n,void 0,r);this.addNode(s),this.tagStack.push(s)}ontext(e){const{lastNode:n}=this;if(n&&n.type===qe.Text)n.data+=e,this.options.withEndIndices&&(n.endIndex=this.parser.endIndex);else{const r=new Vi(e);this.addNode(r),this.lastNode=r}}oncomment(e){if(this.lastNode&&this.lastNode.type===qe.Comment){this.lastNode.data+=e;return}const n=new im(e);this.addNode(n),this.lastNode=n}oncommentend(){this.lastNode=null}oncdatastart(){const e=new Vi(""),n=new TE([e]);this.addNode(n),e.parent=n,this.lastNode=e}oncdataend(){this.lastNode=null}onprocessinginstruction(e,n){const r=new om(e,n);this.addNode(r)}handleCallback(e){if(typeof this.callback=="function")this.callback(e,this.dom);else if(e)throw e}addNode(e){const n=this.tagStack[this.tagStack.length-1],r=n.children[n.children.length-1];this.options.withStartIndices&&(e.startIndex=this.parser.startIndex),this.options.withEndIndices&&(e.endIndex=this.parser.endIndex),n.children.push(e),r&&(e.prev=r,r.next=e),e.parent=n,this.lastNode=null}}const lm=new Uint16Array('<\0\0\0\0\0\0EMabcfglmnoprstu\\bfmsligP&cutereve;iyx}rc;r;ravepha;acr;d;gpon;f;plyFunction;ingcsr;ign;ildemlaceforsucrkslash;;ed;y;crtause;noullis;a;r;pf;eve;cmpeq;HOacdefhilorsucy;PYcpyute;;italDifferentialD;leys;aeioron;dilrc;nint;ot;dnilla;terDot;i;rcleDMPTot;inus;lus;imes;ocskwiseContourIntegral;eCurlyDQoubleQuote;uote;lnpuon;e;gitruent;nt;ourIntegral;fr;oduct;nterClockwiseContourIntegral;oss;cr;p;Cap;DJSZacefios;otrahd;cy;cy;cy;grsger;r;hv;ayron;;l;ta;r;afcmriticalADGTcute;o;bleAcute;rave;ilde;ond;ferentialD;\0\0\0\0f;;DEot;qual;bleCDLRUVontourIntegrao\0\0nArrow;eoftARTrrow;ightArrow;engLReftARrrow;ightArrow;ightArrow;ightATrrow;ee;p\0\0rrow;ownArrow;erticalBar;nABLRTarrow;BUar;pArrow;reve;eft\0\0ightVector;eeVector;ector;Bar;ight\0eeVector;ector;Bar;ee;Arrow;ctr;rok;NTacdfglmopqstuxG;Hcuteaiyron;rc;ot;r;raveement;apcr;ty\0\0mallSquare;erySmallSquare;gpon;f;silon;uail;Tilde;librium;cir;m;a;mlipsts;onentialE;cfiosy;r;lled\0\0mallSquare;erySmallSquare;\0\0\0f;All;riertrf;cJTabcdfgorstcy;>mma;d;reve;eiydil;rc;;ot;r;;pf;eaterEFGLSTqual;Less;ullEqual;reater;ess;lantEqual;ilde;cr;;AacfiosuRDcy;ctek;;irc;r;lbertSpace;\0f;izontalLine;ctrok;mpownHumqual;EJOacdfgmnostucy;lig;cy;cuteiyrc;ot;r;rave;apcgr;inaryI;lie\0;egrral;section;isibleCTomma;imes;gpton;f;a;cr;ilde;\0cy;lcfosuiyrc;;r;pf;\0r;rcy;kcy;HJacfoscy;cy;ppa;eydil;;r;pf;cr;JTaceflmostcy;<cmnprute;bda;g;lacetrf;r;aeyron;dil;;fstACDFRTUVarnrgleBracket;row;BRar;ightArrow;eiling;o\0bleBracket;n\0eeVector;ector;Bar;loor;ightAVrrow;ector;ere;AVrrow;ector;iangle;BEar;qual;pDTVownVector;eeVector;ector;Bar;ector;Bar;ightsEFGLSTqualGreater;ullEqual;reater;ess;lantEqual;ilde;r;;eftarrow;idot;npwgLRlreftARrrow;ightArrow;ightArrow;eftarightightf;erLReftArrow;ightArrow;cht;rok;;acefiosup;y;dliumSpace;lintrf;r;nusPlus;pf;c;Jacefostucy;cute;aeyron;dil;;gswativeMTVediumSpace;hicneryThitedGLreaterGreateessLesLine;r;Bnptreak;BreakingSpace;f;;CDEGHLNPRSTVoungruent;pCap;oubleVerticalBar;lqxement;ual;Tilde;ists;reater;EFGLSTqual;ullEqual;reater;ess;lantEqual;ilde;umpownHump;qual;efstTriangle;BEar;qual;s;EGLSTqual;reater;ess;lantEqual;ilde;estedGLreaterGreater;essLess;recedes;ESqual;lantEqual;eiverseElement;ghtTriangle;BEar;qual;quuareSubpset;Equal;erset;Equal;bcpset;Equal;ceeds;ESTqual;lantEqual;ilde;erset;Equal;ilde;EFTqual;ullEqual;ilde;erticalBar;cr;ilde;Eacdfgmoprstuvlig;cuteiyrc;blac;r;raveaeicr;ga;cron;pf;enCurlyDQoubleQuote;uote;;clr;ashidees;mlerBParr;acek;et;arenthesis;acfhilorsrtialD;y;r;i;;usMinus;ipncareplanf;;eiocedes;ESTqual;lantEqual;ilde;me;dpuct;ortion;al;cir;;UfosOT"r;pf;cr;BEacefhiorsuarr;Gcnrute;g;r;tl;aeyron;dil;;;verseEUlqement;uilibrium;pEquilibrium;ro;ghtACDFTUVanrgleBracket;row;BLar;eftArrow;eiling;o\0bleBracket;n\0eeVector;ector;Bar;loor;ere;AVrrow;ector;iangle;BEar;qual;pDTVownVector;eeVector;ector;Bar;ector;Bar;puf;ndImplies;ightarrow;chr;;leDelayed;HOacfhimoqstuCcHcy;y;FTcy;cute;;aeiyron;dil;rc;;r;ortDLRUownArroweftArrowightArrowpArrow;gma;allCircle;pf;\0\0t;are;ISUntersection;ubpset;Equal;erset;Equal;nion;cr;ar;bcmp;set;Equal;cheeds;ESTqual;lantEqual;ilde;Th;;esrset;Equal;etHRSacfhiorsORNADE;Hccy;y;bu;;aeyron;dil;;r;ei\0efore;a;cnkSpace;Space;lde;EFTqual;ullEqual;ilde;pf;ipleDot;ctr;rok;\0\0\0\0\0\0\0cruter;ocir;r\0y;ve;iyrc;blac;r;raveacr;dierBParr;acek;et;arenthesis;on;Plus;gpon;f;ADETadpsrrow;BDar;ownArrow;ownArrow;quilibrium;ee;Arrow;ownerLReftArrow;ightArrow;i;lon;ing;cr;ilde;mlDbcdefosvash;ar;y;ash;l;er;btyar;;icalBLSTar;ine;eparator;ilde;ThinSpace;r;pf;cr;dash;cefosirc;dge;r;pf;cr;fiosr;;pf;cr;AIUacfosucy;cy;cy;cuteiyrc;;r;pf;cr;ml;Hacdefoscy;cute;ayron;;ot;\0oWidta;r;pf;cr;\0\0\0\0\0\0\0cutereve;;Ediuy;;rcte;lig;r;raveepfpsym;ha;apcclr;g;\0\0;adsvnd;;lope;;;elmrsz;esd;a;;;;;;;;t;vb;d;pth;arr;gpon;f;;Eaeiop;cir;;d;s;rox;eingctyr;;mp;eildemlcioninnt;Nabcdefiklnoprsuot;crkcepsong;psilon;rime;im;eq;ee;ed;gerk;tbrk;oy;quo;cmprtaus;eptyv;snoahw;;een;r;gcostuvwaiurc;pdptot;lus;imes;\0\0cup;ar;riangleduown;p;plus;earow;akocnklstozenge;riangle;dlrown;eft;ight;k;\0\0;;4;ck;eo;q=uiv;t;ptwxf;;tomtie;DHUVbdhmptuvLRlr;;;;;DUdu;;;;LRlr;;;;;HLRhlr;;;;;;ox;LRlr;;;;;DUdu;;;;inus;lus;imes;LRlr;;;;;HLRhlr;;;;;;evbarceior;mi;m;el;bh;sub;l;etp;Ee;;q\0\0\0\0\0\0\0\0\0\0cprute;;abcdsnd;rcup;aup;p;ot;;eot;aeiu\0s;on;dilrc;ps;sm;ot;dmnilptyv;t;err;ceiy;ck;mark;r;Ecefms;;elq;e\0\0rrowlreft;ight;RSacd;st;irc;ash;nint;id;cir;ubs;uit\0on;e;q\0\0a;t;;flemxente\0;dot;nfry;o;sr;aorr;ss;cur;bp;e;;e;dot;delprvwarrlr;;\0\0r;c;arr;p;;bcdosrcap;aup;p;ot;r;;alrvrr;m;yevwq\0\0reuee;edge;enearrowlreftightecioninnt;lcty;AHabcdefhijlorstuwzrar;glrsger;eth;h;varow;aayron;;;aogrr;tseq;glmta;ptyv;irsht;;arlraegsvm;osnd;suit;amma;in;;iode;ontimes;ncy;c\0\0rn;op;lptuwlar;f;;empsq;dot;inus;lus;quare;blebarwedgnadhownarrowarpoonlrefighkaro\0\0rn;op;cotry;;l;rok;drot;i;fahraangle;ciy;grarr;DacdefglmnopqrstuxDoocsuteter;aioyron;r;clon;;ot;Drot;;;rsave;dot;;ilsnters;;;dot;apscr;ty;svetp1;;;gs;p;gpon;f;alsr;sl;us;i;lvon;csuviorc\0\0antgltressaeils;st;v;DD;parsl;Daot;rr;cdir;oah;mrlo;cipl;seoctationential\0\0\0\0\0\0\0llingdotsey;male;ilrlig;\0\0g;ig;;lig;lig;fjaltt;ig;ns;of;\0f;ak;v;artint;aocs\0\0;;;;\0;;\0\0;;5;\0;;8;l;wn;cr;Eabcdefgijlnorstv;l;cmpute;ma;d;reve;iyrc;;ot;;lqs;qslan;cdlc;ot;o;l;;es;r;;gmel;cy;;Eaj;;;Eaes;p;prox;q;qim;pf;cir;m;el;;>;cdlqrci;r;ot;Par;uest;adels\0pror;qlqlesienrtneqq;Aabcefkosyrilmrrsfildrcy;;cwir;;ar;irc;alrrts;uitlip;con;r;sewarow;arow;amoprrr;tht;klreftarrow;ightarrow;f;bar;cltr;asrok;bpull;hen\0\0\0\0\0\0cute;iyrc;cxy;clfr;rave;inoinnt;t;fin;ta;lig;aopcgtr;elpinarh;f;ed;;cfotare;in;tie;do;celpal;grerarhk;rod;cgpty;on;f;a;uestcir;n;Edsv;ot;;v;;ilde;\0cy;lcfmosuiyrc;;r;ath;pf;\0r;rcy;kcy;acfghjosppa;v;eydil;;r;reen;cy;cy;pf;cr;ABEHabcdefghjlmnoprstuvartrail;arr;;g;ar;\0\0\0\0\0\0\0\0\0ute;mptyv;rabda;g;dl;;uor;bfhlpst;fs;s;p;l;im;l;;aeil;;s;abrrr;rk;akcek;;es;ldu;;aeuyron;diil;;cqrsa;uo;rduhar;shar;h;;fgqstahlrtrrow;taarpoonduownpeftarrows;ightahsrrow;sarpoonquigarrohreetimes;;qslan;cdgsc;ot;o;r;;es;adegspproot;qgqgtiilrsht;;;E;rdu;l;lk;cy;;achtrorneard;ri;iodot;ust;acheEaes;p;prox;q;qim;abnoptwznrg;r;rglmreftarightapsto;ightparrowlrefight;aflr;;us;imes;st;;efngear;lt;achmtrornear;d;;ri;achiqtquo;r;m;eg;;buo;r;rok;<;cdhilqrci;r;remes;arr;uest;Piar;;efrdushar;har;enrtneqq;DacdefhilnopsuDot;clprret;;ese;sto;dluowefker;oymma;;ash;asuredangler;o;cdnro;acdsir;otus;bd;u;p;dpels;f;ctr;pos;lmtimap;GLRVabcdefghijlmoprstuvwgt;;veltftarrrow;ightarrow;;;vightarrow;Ddash;ash;bcnptlaute;g;;Eiop;d;s;rour;al;s\0pmp;eaeouy\0;on;dil;ng;dot;p;;ash;;Aadqsxrr;rhrk;;oot;uieiar;ist;sr;Eest;qs;qslani;rAaprrr;ar;;sv;d;cy;AEadestr;rr;r;;fqstarrroightarro;qslan;si;ri;eiptf;;inn;Edv;ot;;;i;v;;aorr;astllel;;lint;;ceu;c;eAaitrrr;cw;;ghtarrowri;echimpqu;ceru;ort\0\0arm;e;qsubpbcp;Ees;et;eq;qc;e;Ees;et;eq;qgilrldeianglelreft;eight;e;m;esro;p;DHadgilrsash;arr;p;ash;et;;>nfin;Aetrr;;;r<ie;Atrr;rie;im;Aanrr;rhrk;;oear;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0csuteiyr;c;abioslac;v;old;lig;crir;;\0\0\0n;ave;bmar;acitrirr;oss;n;aeicr;ga;cdnron;;pf;aelr;rp;;adiosvr;efmr;ofgof;r;lope;;cloashl;idees;as;mlbar;\0\0\0\0\0\0\0\0\0r;ast;lle\0\0m;;y;rcimptnt;od;il;enk;r;imo;v;mane;;tvchfork;aunckk;h;s;abcdemstcir;ir;ou;;nim;wo;ipuntint;f;nd;Eaceinosu;p;u;c;acenspprourlyeaespprox;qq;im;ime;sEasdfpalslar;ine;urf;;trel;cir;;ncsp;fiopsur;pf;rime;cr;aeoteirnionnt;st;eABHabcdefhilmnoprstuxartrail;arar;cdenqrteu;te;imptyv;g;del;;uor;abcfhlpstwp;;fs;;s;l;im;l;;aiil;o;nalabrrrk;akcek;;es;ldu;;aeuyron;diil;;clqsa;dhar;uo;rh;acgl;ipsnart;ilrsht;;aordu;l;;v;gnshtahlrstrrow;taarpoonduowpeftahrrowarpoonightarrows;quigarrohreetimes;g;ingdotseahmra;oust;achemid;abptnrg;r;raflr;;us;imes;apr;gt;olint;arachqquo;r;buo;rhirremes;i;efltri;luhar;;\0\0\0\0\0\0\0cute;qu;Eaceinpsy;\0;on;u;dil;rc;Eas;p;im;olint;i;ot;be;Aacmstxrr;rhr;oti;war;minnut;r;oacoyrp;hycy;;rt\0\0iaragmma;fv;;deglnprot;;q;E;;E;e;lus;arr;araeitlslsetmhp;parsl;dle;;e;s;flptcy;;b;ar;f;adres;uitcsuaup;s;p;s;ubp;eset;e;eset;e;afrarcemtr;tmiararr;fanighteppsilohsbcmnp;Edemnprs;ot;;dot;ult;Ee;;lus;arr;eiut;enq;qeq;qm;bp;;c;acenspprourlyeaespproqg;123;Edehlmnps;ost;ub;;dot;soul;b;arr;ult;Ee;;lus;eiut;enq;qeq;qm;bp;;Aanrr;rhr;owar;lig\0\0\0\0\0\0\0\0\0\0\0\0get;;raeyron;dil;;lrec;r;eiko\0e4fa;svym;cnkaspproimsasrnes;bd;ar;;eps;bcfot;ir;;ork;rime;aipdadempstngle;dlqrowneft;e;ight;eot;inus;lus;b;ime;ezium;chtry;;cy;rok;ioxheadlreftarroightarrowAHabcdfghlmoprstuwrar;cruter\0y;ve;iyrc;abhrlac;airsht;;raverlrlk;ct\0\0rn;erop;ri;alcr;gpon;f;adhlsuownarpoonlrefighi;hlonparrows;cit\0\0rn;erop;ng;ri;cr;dirot;lde;i;famrlangle;ABDacdeflnoprszrar;v;asnrgrt;eknprstappothinhirop;hiugmbpsetneq;q;setneq;q;hretianglelreftighty;ashelr;bear;q;lip;btar;trsubppf;rotrcur;bpnEenEeigzag;cefoprsirc;dibgar;e;q;erp;r;pf;;eatcr;\0\0\0\0\0\0\0trr;Aarr;Aarrais;dptfl;imAarrcqr;ptracefiosucuyte;iyrc;;nr;cy;pf;cr;cmy;lacdefhioswcute;ayron;;ot;ettra;r;cy;grarr;pf;cr;jn;j;'.split("").map(t=>t.charCodeAt(0))),SE=new Uint16Array("aglq	\x1B\0\0p;os;t;t;uot;".split("").map(t=>t.charCodeAt(0)));var Ed;const PL=new Map([[0,65533],[128,8364],[130,8218],[131,402],[132,8222],[133,8230],[134,8224],[135,8225],[136,710],[137,8240],[138,352],[139,8249],[140,338],[142,381],[145,8216],[146,8217],[147,8220],[148,8221],[149,8226],[150,8211],[151,8212],[152,732],[153,8482],[154,353],[155,8250],[156,339],[158,382],[159,376]]),Dh=(Ed=String.fromCodePoint)!==null&&Ed!==void 0?Ed:function(t){let e="";return t>65535&&(t-=65536,e+=String.fromCharCode(t>>>10&1023|55296),t=56320|t&1023),e+=String.fromCharCode(t),e};function xL(t){var e;return t>=55296&&t<=57343||t>1114111?65533:(e=PL.get(t))!==null&&e!==void 0?e:t}var Ct;(function(t){t[t.NUM=35]="NUM",t[t.SEMI=59]="SEMI",t[t.EQUALS=61]="EQUALS",t[t.ZERO=48]="ZERO",t[t.NINE=57]="NINE",t[t.LOWER_A=97]="LOWER_A",t[t.LOWER_F=102]="LOWER_F",t[t.LOWER_X=120]="LOWER_X",t[t.LOWER_Z=122]="LOWER_Z",t[t.UPPER_A=65]="UPPER_A",t[t.UPPER_F=70]="UPPER_F",t[t.UPPER_Z=90]="UPPER_Z"})(Ct||(Ct={}));const LL=32;var Ur;(function(t){t[t.VALUE_LENGTH=49152]="VALUE_LENGTH",t[t.BRANCH_LENGTH=16256]="BRANCH_LENGTH",t[t.JUMP_TABLE=127]="JUMP_TABLE"})(Ur||(Ur={}));function Mh(t){return t>=Ct.ZERO&&t<=Ct.NINE}function DL(t){return t>=Ct.UPPER_A&&t<=Ct.UPPER_F||t>=Ct.LOWER_A&&t<=Ct.LOWER_F}function ML(t){return t>=Ct.UPPER_A&&t<=Ct.UPPER_Z||t>=Ct.LOWER_A&&t<=Ct.LOWER_Z||Mh(t)}function BL(t){return t===Ct.EQUALS||ML(t)}var Tt;(function(t){t[t.EntityStart=0]="EntityStart",t[t.NumericStart=1]="NumericStart",t[t.NumericDecimal=2]="NumericDecimal",t[t.NumericHex=3]="NumericHex",t[t.NamedEntity=4]="NamedEntity"})(Tt||(Tt={}));var Sn;(function(t){t[t.Legacy=0]="Legacy",t[t.Strict=1]="Strict",t[t.Attribute=2]="Attribute"})(Sn||(Sn={}));class dm{constructor(e,n,r){this.decodeTree=e,this.emitCodePoint=n,this.errors=r,this.state=Tt.EntityStart,this.consumed=1,this.result=0,this.treeIndex=0,this.excess=1,this.decodeMode=Sn.Strict}startEntity(e){this.decodeMode=e,this.state=Tt.EntityStart,this.result=0,this.treeIndex=0,this.excess=1,this.consumed=1}write(e,n){switch(this.state){case Tt.EntityStart:return e.charCodeAt(n)===Ct.NUM?(this.state=Tt.NumericStart,this.consumed+=1,this.stateNumericStart(e,n+1)):(this.state=Tt.NamedEntity,this.stateNamedEntity(e,n));case Tt.NumericStart:return this.stateNumericStart(e,n);case Tt.NumericDecimal:return this.stateNumericDecimal(e,n);case Tt.NumericHex:return this.stateNumericHex(e,n);case Tt.NamedEntity:return this.stateNamedEntity(e,n)}}stateNumericStart(e,n){return n>=e.length?-1:(e.charCodeAt(n)|LL)===Ct.LOWER_X?(this.state=Tt.NumericHex,this.consumed+=1,this.stateNumericHex(e,n+1)):(this.state=Tt.NumericDecimal,this.stateNumericDecimal(e,n))}addToNumericResult(e,n,r,s){if(n!==r){const a=r-n;this.result=this.result*Math.pow(s,a)+parseInt(e.substr(n,a),s),this.consumed+=a}}stateNumericHex(e,n){const r=n;for(;n<e.length;){const s=e.charCodeAt(n);if(Mh(s)||DL(s))n+=1;else return this.addToNumericResult(e,r,n,16),this.emitNumericEntity(s,3)}return this.addToNumericResult(e,r,n,16),-1}stateNumericDecimal(e,n){const r=n;for(;n<e.length;){const s=e.charCodeAt(n);if(Mh(s))n+=1;else return this.addToNumericResult(e,r,n,10),this.emitNumericEntity(s,2)}return this.addToNumericResult(e,r,n,10),-1}emitNumericEntity(e,n){var r;if(this.consumed<=n)return(r=this.errors)===null||r===void 0||r.absenceOfDigitsInNumericCharacterReference(this.consumed),0;if(e===Ct.SEMI)this.consumed+=1;else if(this.decodeMode===Sn.Strict)return 0;return this.emitCodePoint(xL(this.result),this.consumed),this.errors&&(e!==Ct.SEMI&&this.errors.missingSemicolonAfterCharacterReference(),this.errors.validateNumericCharacterReference(this.result)),this.consumed}stateNamedEntity(e,n){const{decodeTree:r}=this;let s=r[this.treeIndex],a=(s&Ur.VALUE_LENGTH)>>14;for(;n<e.length;n++,this.excess++){const i=e.charCodeAt(n);if(this.treeIndex=FL(r,s,this.treeIndex+Math.max(1,a),i),this.treeIndex<0)return this.result===0||this.decodeMode===Sn.Attribute&&(a===0||BL(i))?0:this.emitNotTerminatedNamedEntity();if(s=r[this.treeIndex],a=(s&Ur.VALUE_LENGTH)>>14,a!==0){if(i===Ct.SEMI)return this.emitNamedEntityData(this.treeIndex,a,this.consumed+this.excess);this.decodeMode!==Sn.Strict&&(this.result=this.treeIndex,this.consumed+=this.excess,this.excess=0)}}return-1}emitNotTerminatedNamedEntity(){var e;const{result:n,decodeTree:r}=this,s=(r[n]&Ur.VALUE_LENGTH)>>14;return this.emitNamedEntityData(n,s,this.consumed),(e=this.errors)===null||e===void 0||e.missingSemicolonAfterCharacterReference(),this.consumed}emitNamedEntityData(e,n,r){const{decodeTree:s}=this;return this.emitCodePoint(n===1?s[e]&~Ur.VALUE_LENGTH:s[e+1],r),n===3&&this.emitCodePoint(s[e+2],r),r}end(){var e;switch(this.state){case Tt.NamedEntity:return this.result!==0&&(this.decodeMode!==Sn.Attribute||this.result===this.treeIndex)?this.emitNotTerminatedNamedEntity():0;case Tt.NumericDecimal:return this.emitNumericEntity(0,2);case Tt.NumericHex:return this.emitNumericEntity(0,3);case Tt.NumericStart:return(e=this.errors)===null||e===void 0||e.absenceOfDigitsInNumericCharacterReference(this.consumed),0;case Tt.EntityStart:return 0}}}function AE(t){let e="";const n=new dm(t,r=>e+=Dh(r));return function(s,a){let i=0,o=0;for(;(o=s.indexOf("&",o))>=0;){e+=s.slice(i,o),n.startEntity(a);const c=n.write(s,o+1);if(c<0){i=o+n.end();break}i=o+c,o=c===0?i+1:i}const u=e+s.slice(i);return e="",u}}function FL(t,e,n,r){const s=(e&Ur.BRANCH_LENGTH)>>7,a=e&Ur.JUMP_TABLE;if(s===0)return a!==0&&r===a?n:-1;if(a){const u=r-a;return u<0||u>=s?-1:t[n+u]-1}let i=n,o=i+s-1;for(;i<=o;){const u=i+o>>>1,c=t[u];if(c<r)i=u+1;else if(c>r)o=u-1;else return t[u+s]}return-1}AE(lm);AE(SE);const p0=/["&'<>$\x80-\uFFFF]/g,UL=new Map([[34,"&quot;"],[38,"&amp;"],[39,"&apos;"],[60,"&lt;"],[62,"&gt;"]]),jL=String.prototype.codePointAt!=null?(t,e)=>t.codePointAt(e):(t,e)=>(t.charCodeAt(e)&64512)===55296?(t.charCodeAt(e)-55296)*1024+t.charCodeAt(e+1)-56320+65536:t.charCodeAt(e);function CE(t){let e="",n=0,r;for(;(r=p0.exec(t))!==null;){const s=r.index,a=t.charCodeAt(s),i=UL.get(a);i!==void 0?(e+=t.substring(n,s)+i,n=s+1):(e+=`${t.substring(n,s)}&#x${jL(t,s).toString(16)};`,n=p0.lastIndex+=+((a&64512)===55296))}return e+t.substr(n)}function OE(t,e){return function(r){let s,a=0,i="";for(;s=t.exec(r);)a!==s.index&&(i+=r.substring(a,s.index)),i+=e.get(s[0].charCodeAt(0)),a=s.index+1;return i+r.substring(a)}}const vE=OE(/["&\u00A0]/g,new Map([[34,"&quot;"],[38,"&amp;"],[160,"&nbsp;"]])),IE=OE(/[&<>\u00A0]/g,new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[160,"&nbsp;"]])),$L=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(t=>[t.toLowerCase(),t])),HL=new Map(["definitionURL","attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(t=>[t.toLowerCase(),t])),qL=new Set(["style","script","xmp","iframe","noembed","noframes","plaintext","noscript"]);function VL(t){return t.replace(/"/g,"&quot;")}function zL(t,e){var n;if(!t)return;const r=((n=e.encodeEntities)!==null&&n!==void 0?n:e.decodeEntities)===!1?VL:e.xmlMode||e.encodeEntities!=="utf8"?CE:vE;return Object.keys(t).map(s=>{var a,i;const o=(a=t[s])!==null&&a!==void 0?a:"";return e.xmlMode==="foreign"&&(s=(i=HL.get(s))!==null&&i!==void 0?i:s),!e.emptyAttrs&&!e.xmlMode&&o===""?s:`${s}="${r(o)}"`}).join(" ")}const g0=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]);function al(t,e={}){const n="length"in t?t:[t];let r="";for(let s=0;s<n.length;s++)r+=WL(n[s],e);return r}function WL(t,e){switch(t.type){case TL:return al(t.children,e);case kL:case AL:return ZL(t);case CL:return QL(t);case NL:return XL(t);case OL:case vL:case IL:return YL(t,e);case SL:return JL(t,e)}}const GL=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignObject","desc","title"]),KL=new Set(["svg","math"]);function YL(t,e){var n;e.xmlMode==="foreign"&&(t.name=(n=$L.get(t.name))!==null&&n!==void 0?n:t.name,t.parent&&GL.has(t.parent.name)&&(e={...e,xmlMode:!1})),!e.xmlMode&&KL.has(t.name)&&(e={...e,xmlMode:"foreign"});let r=`<${t.name}`;const s=zL(t.attribs,e);return s&&(r+=` ${s}`),t.children.length===0&&(e.xmlMode?e.selfClosingTags!==!1:e.selfClosingTags&&g0.has(t.name))?(e.xmlMode||(r+=" "),r+="/>"):(r+=">",t.children.length>0&&(r+=al(t.children,e)),(e.xmlMode||!g0.has(t.name))&&(r+=`</${t.name}>`)),r}function ZL(t){return`<${t.data}>`}function JL(t,e){var n;let r=t.data||"";return((n=e.encodeEntities)!==null&&n!==void 0?n:e.decodeEntities)!==!1&&!(!e.xmlMode&&t.parent&&qL.has(t.parent.name))&&(r=e.xmlMode||e.encodeEntities!=="utf8"?CE(r):IE(r)),r}function XL(t){return`<![CDATA[${t.children[0].data}]]>`}function QL(t){return`<!--${t.data}-->`}function NE(t,e){return al(t,e)}function e4(t,e){return it(t)?t.children.map(n=>NE(n,e)).join(""):""}function Cu(t){return Array.isArray(t)?t.map(Cu).join(""):fe(t)?t.name==="br"?`
`:Cu(t.children):rl(t)?Cu(t.children):dr(t)?t.data:""}function fa(t){return Array.isArray(t)?t.map(fa).join(""):it(t)&&!sl(t)?fa(t.children):dr(t)?t.data:""}function sc(t){return Array.isArray(t)?t.map(sc).join(""):it(t)&&(t.type===qe.Tag||rl(t))?sc(t.children):dr(t)?t.data:""}function il(t){return it(t)?t.children:[]}function kE(t){return t.parent||null}function RE(t){const e=kE(t);if(e!=null)return il(e);const n=[t];let{prev:r,next:s}=t;for(;r!=null;)n.unshift(r),{prev:r}=r;for(;s!=null;)n.push(s),{next:s}=s;return n}function t4(t,e){var n;return(n=t.attribs)===null||n===void 0?void 0:n[e]}function n4(t,e){return t.attribs!=null&&Object.prototype.hasOwnProperty.call(t.attribs,e)&&t.attribs[e]!=null}function r4(t){return t.name}function hm(t){let{next:e}=t;for(;e!==null&&!fe(e);)({next:e}=e);return e}function fm(t){let{prev:e}=t;for(;e!==null&&!fe(e);)({prev:e}=e);return e}function Ns(t){if(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.parent){const e=t.parent.children,n=e.lastIndexOf(t);n>=0&&e.splice(n,1)}t.next=null,t.prev=null,t.parent=null}function s4(t,e){const n=e.prev=t.prev;n&&(n.next=e);const r=e.next=t.next;r&&(r.prev=e);const s=e.parent=t.parent;if(s){const a=s.children;a[a.lastIndexOf(t)]=e,t.parent=null}}function a4(t,e){if(Ns(e),e.next=null,e.parent=t,t.children.push(e)>1){const n=t.children[t.children.length-2];n.next=e,e.prev=n}else e.prev=null}function i4(t,e){Ns(e);const{parent:n}=t,r=t.next;if(e.next=r,e.prev=t,t.next=e,e.parent=n,r){if(r.prev=e,n){const s=n.children;s.splice(s.lastIndexOf(r),0,e)}}else n&&n.children.push(e)}function o4(t,e){if(Ns(e),e.parent=t,e.prev=null,t.children.unshift(e)!==1){const n=t.children[1];n.prev=e,e.next=n}else e.next=null}function u4(t,e){Ns(e);const{parent:n}=t;if(n){const r=n.children;r.splice(r.indexOf(t),0,e)}t.prev&&(t.prev.next=e),e.parent=n,e.prev=t.prev,e.next=t,t.prev=e}function _o(t,e,n=!0,r=1/0){return mm(t,Array.isArray(e)?e:[e],n,r)}function mm(t,e,n,r){const s=[],a=[Array.isArray(e)?e:[e]],i=[0];for(;;){if(i[0]>=a[0].length){if(i.length===1)return s;a.shift(),i.shift();continue}const o=a[0][i[0]++];if(t(o)&&(s.push(o),--r<=0))return s;n&&it(o)&&o.children.length>0&&(i.unshift(0),a.unshift(o.children))}}function c4(t,e){return e.find(t)}function pm(t,e,n=!0){const r=Array.isArray(e)?e:[e];for(let s=0;s<r.length;s++){const a=r[s];if(fe(a)&&t(a))return a;if(n&&it(a)&&a.children.length>0){const i=pm(t,a.children,!0);if(i)return i}}return null}function PE(t,e){return(Array.isArray(e)?e:[e]).some(n=>fe(n)&&t(n)||it(n)&&PE(t,n.children))}function l4(t,e){const n=[],r=[Array.isArray(e)?e:[e]],s=[0];for(;;){if(s[0]>=r[0].length){if(r.length===1)return n;r.shift(),s.shift();continue}const a=r[0][s[0]++];fe(a)&&t(a)&&n.push(a),it(a)&&a.children.length>0&&(s.unshift(0),r.unshift(a.children))}}const ac={tag_name(t){return typeof t=="function"?e=>fe(e)&&t(e.name):t==="*"?fe:e=>fe(e)&&e.name===t},tag_type(t){return typeof t=="function"?e=>t(e.type):e=>e.type===t},tag_contains(t){return typeof t=="function"?e=>dr(e)&&t(e.data):e=>dr(e)&&e.data===t}};function gm(t,e){return typeof e=="function"?n=>fe(n)&&e(n.attribs[t]):n=>fe(n)&&n.attribs[t]===e}function d4(t,e){return n=>t(n)||e(n)}function xE(t){const e=Object.keys(t).map(n=>{const r=t[n];return Object.prototype.hasOwnProperty.call(ac,n)?ac[n](r):gm(n,r)});return e.length===0?null:e.reduce(d4)}function h4(t,e){const n=xE(t);return n?n(e):!0}function f4(t,e,n,r=1/0){const s=xE(t);return s?_o(s,e,n,r):[]}function m4(t,e,n=!0){return Array.isArray(e)||(e=[e]),pm(gm("id",t),e,n)}function Ia(t,e,n=!0,r=1/0){return _o(ac.tag_name(t),e,n,r)}function p4(t,e,n=!0,r=1/0){return _o(gm("class",t),e,n,r)}function g4(t,e,n=!0,r=1/0){return _o(ac.tag_type(t),e,n,r)}function b4(t){let e=t.length;for(;--e>=0;){const n=t[e];if(e>0&&t.lastIndexOf(n,e-1)>=0){t.splice(e,1);continue}for(let r=n.parent;r;r=r.parent)if(t.includes(r)){t.splice(e,1);break}}return t}var wn;(function(t){t[t.DISCONNECTED=1]="DISCONNECTED",t[t.PRECEDING=2]="PRECEDING",t[t.FOLLOWING=4]="FOLLOWING",t[t.CONTAINS=8]="CONTAINS",t[t.CONTAINED_BY=16]="CONTAINED_BY"})(wn||(wn={}));function LE(t,e){const n=[],r=[];if(t===e)return 0;let s=it(t)?t:t.parent;for(;s;)n.unshift(s),s=s.parent;for(s=it(e)?e:e.parent;s;)r.unshift(s),s=s.parent;const a=Math.min(n.length,r.length);let i=0;for(;i<a&&n[i]===r[i];)i++;if(i===0)return wn.DISCONNECTED;const o=n[i-1],u=o.children,c=n[i],l=r[i];return u.indexOf(c)>u.indexOf(l)?o===e?wn.FOLLOWING|wn.CONTAINED_BY:wn.FOLLOWING:o===t?wn.PRECEDING|wn.CONTAINS:wn.PRECEDING}function Na(t){return t=t.filter((e,n,r)=>!r.includes(e,n+1)),t.sort((e,n)=>{const r=LE(e,n);return r&wn.PRECEDING?-1:r&wn.FOLLOWING?1:0}),t}function _4(t){const e=ic(S4,t);return e?e.name==="feed"?y4(e):E4(e):null}function y4(t){var e;const n=t.children,r={type:"atom",items:Ia("entry",n).map(i=>{var o;const{children:u}=i,c={media:DE(u)};Kt(c,"id","id",u),Kt(c,"title","title",u);const l=(o=ic("link",u))===null||o===void 0?void 0:o.attribs.href;l&&(c.link=l);const d=jr("summary",u)||jr("content",u);d&&(c.description=d);const p=jr("updated",u);return p&&(c.pubDate=new Date(p)),c})};Kt(r,"id","id",n),Kt(r,"title","title",n);const s=(e=ic("link",n))===null||e===void 0?void 0:e.attribs.href;s&&(r.link=s),Kt(r,"description","subtitle",n);const a=jr("updated",n);return a&&(r.updated=new Date(a)),Kt(r,"author","email",n,!0),r}function E4(t){var e,n;const r=(n=(e=ic("channel",t.children))===null||e===void 0?void 0:e.children)!==null&&n!==void 0?n:[],s={type:t.name.substr(0,3),id:"",items:Ia("item",t.children).map(i=>{const{children:o}=i,u={media:DE(o)};Kt(u,"id","guid",o),Kt(u,"title","title",o),Kt(u,"link","link",o),Kt(u,"description","description",o);const c=jr("pubDate",o)||jr("dc:date",o);return c&&(u.pubDate=new Date(c)),u})};Kt(s,"title","title",r),Kt(s,"link","link",r),Kt(s,"description","description",r);const a=jr("lastBuildDate",r);return a&&(s.updated=new Date(a)),Kt(s,"author","managingEditor",r,!0),s}const w4=["url","type","lang"],T4=["fileSize","bitrate","framerate","samplingrate","channels","duration","height","width"];function DE(t){return Ia("media:content",t).map(e=>{const{attribs:n}=e,r={medium:n.medium,isDefault:!!n.isDefault};for(const s of w4)n[s]&&(r[s]=n[s]);for(const s of T4)n[s]&&(r[s]=parseInt(n[s],10));return n.expression&&(r.expression=n.expression),r})}function ic(t,e){return Ia(t,e,!0,1)[0]}function jr(t,e,n=!1){return fa(Ia(t,e,n,1)).trim()}function Kt(t,e,n,r,s=!1){const a=jr(n,r,s);a&&(t[e]=a)}function S4(t){return t==="rss"||t==="feed"||t==="rdf:RDF"}const ol=Object.freeze(Object.defineProperty({__proto__:null,get DocumentPosition(){return wn},append:i4,appendChild:a4,compareDocumentPosition:LE,existsOne:PE,filter:_o,find:mm,findAll:l4,findOne:pm,findOneChild:c4,getAttributeValue:t4,getChildren:il,getElementById:m4,getElements:f4,getElementsByClassName:p4,getElementsByTagName:Ia,getElementsByTagType:g4,getFeed:_4,getInnerHTML:e4,getName:r4,getOuterHTML:NE,getParent:kE,getSiblings:RE,getText:Cu,hasAttrib:n4,hasChildren:it,innerText:sc,isCDATA:rl,isComment:sl,isDocument:Zr,isTag:fe,isText:dr,nextElementSibling:hm,prepend:u4,prependChild:o4,prevElementSibling:fm,removeElement:Ns,removeSubsets:b4,replaceElement:s4,testElement:h4,textContent:fa,uniqueSort:Na},Symbol.toStringTag,{value:"Module"})),A4={_useHtmlParser2:!1};function Bh(t,e){if(!t)return e??A4;const n={_useHtmlParser2:!!t.xmlMode,...e,...t};return t.xml?(n._useHtmlParser2=!0,n.xmlMode=!0,t.xml!==!0&&Object.assign(n,t.xml)):t.xmlMode&&(n._useHtmlParser2=!0),n}function ME(t,e,n){return t?t(e??t._root.children,null,void 0,n).toString():""}function C4(t,e){return typeof t=="object"&&t!=null&&!("length"in t)&&!("type"in t)}function O4(t,e){const n=C4(t)?(e=t,void 0):t,r={...this===null||this===void 0?void 0:this._options,...Bh(e)};return ME(this,n,r)}function v4(t){const e={...this._options,xmlMode:!0};return ME(this,t,e)}function Wi(t){const e=t??(this?this.root():[]);let n="";for(let r=0;r<e.length;r++)n+=fa(e[r]);return n}function I4(t,e,n=typeof e=="boolean"?e:!1){if(!t||typeof t!="string")return null;typeof e=="boolean"&&(n=e);const r=this.load(t,this._options,!1);return n||r("script").remove(),[...r.root()[0].children]}function N4(){return this(this._root)}function BE(t,e){if(e===t)return!1;let n=e;for(;n&&n!==n.parent;)if(n=n.parent,n===t)return!0;return!1}function k4(t){return this.root().extract(t)}function R4(t,e){if(!b0(t)||!b0(e))return;let n=t.length;const r=+e.length;for(let s=0;s<r;s++)t[n++]=e[s];return t.length=n,t}function b0(t){if(Array.isArray(t))return!0;if(typeof t!="object"||t===null||!("length"in t)||typeof t.length!="number"||t.length<0)return!1;for(let e=0;e<t.length;e++)if(!(e in t))return!1;return!0}const P4=Object.freeze(Object.defineProperty({__proto__:null,contains:BE,extract:k4,html:O4,merge:R4,parseHTML:I4,root:N4,text:Wi,xml:v4},Symbol.toStringTag,{value:"Module"}));function Or(t){return t.cheerio!=null}function x4(t){return t.replace(/[._-](\w|$)/g,(e,n)=>n.toUpperCase())}function L4(t){return t.replace(/[A-Z]/g,"-$&").toLowerCase()}function st(t,e){const n=t.length;for(let r=0;r<n;r++)e(t[r],r);return t}var ts;(function(t){t[t.LowerA=97]="LowerA",t[t.LowerZ=122]="LowerZ",t[t.UpperA=65]="UpperA",t[t.UpperZ=90]="UpperZ",t[t.Exclamation=33]="Exclamation"})(ts||(ts={}));function Fh(t){const e=t.indexOf("<");if(e<0||e>t.length-3)return!1;const n=t.charCodeAt(e+1);return(n>=ts.LowerA&&n<=ts.LowerZ||n>=ts.UpperA&&n<=ts.UpperZ||n===ts.Exclamation)&&t.includes(">",e+2)}const Gi=Object.prototype.hasOwnProperty,Ki=/\s+/,Uh="data-",bm=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,D4=/^{[^]*}$|^\[[^]*]$/;function oc(t,e,n){var r;if(!(!t||!fe(t))){if((r=t.attribs)!==null&&r!==void 0||(t.attribs={}),!e)return t.attribs;if(Gi.call(t.attribs,e))return!n&&bm.test(e)?e:t.attribs[e];if(t.name==="option"&&e==="value")return Wi(t.children);if(t.name==="input"&&(t.attribs.type==="radio"||t.attribs.type==="checkbox")&&e==="value")return"on"}}function aa(t,e,n){n===null?UE(t,e):t.attribs[e]=`${n}`}function M4(t,e){if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t!="string")throw new Error("Bad combination of arguments.");return st(this,(n,r)=>{fe(n)&&aa(n,t,e.call(n,r,n.attribs[t]))})}return st(this,n=>{if(fe(n))if(typeof t=="object")for(const r of Object.keys(t)){const s=t[r];aa(n,r,s)}else aa(n,t,e)})}return arguments.length>1?this:oc(this[0],t,this.options.xmlMode)}function _0(t,e,n){return e in t?t[e]:!n&&bm.test(e)?oc(t,e,!1)!==void 0:oc(t,e,n)}function wd(t,e,n,r){e in t?t[e]=n:aa(t,e,!r&&bm.test(e)?n?"":null:`${n}`)}function B4(t,e){var n;if(typeof t=="string"&&e===void 0){const r=this[0];if(!r||!fe(r))return;switch(t){case"style":{const s=this.css(),a=Object.keys(s);for(let i=0;i<a.length;i++)s[i]=a[i];return s.length=a.length,s}case"tagName":case"nodeName":return r.name.toUpperCase();case"href":case"src":{const s=(n=r.attribs)===null||n===void 0?void 0:n[t];return typeof URL<"u"&&(t==="href"&&(r.tagName==="a"||r.tagName==="link")||t==="src"&&(r.tagName==="img"||r.tagName==="iframe"||r.tagName==="audio"||r.tagName==="video"||r.tagName==="source"))&&s!==void 0&&this.options.baseURI?new URL(s,this.options.baseURI).href:s}case"innerText":return sc(r);case"textContent":return fa(r);case"outerHTML":return this.clone().wrap("<container />").parent().html();case"innerHTML":return this.html();default:return _0(r,t,this.options.xmlMode)}}if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t=="object")throw new TypeError("Bad combination of arguments.");return st(this,(r,s)=>{fe(r)&&wd(r,t,e.call(r,s,_0(r,t,this.options.xmlMode)),this.options.xmlMode)})}return st(this,r=>{if(fe(r))if(typeof t=="object")for(const s of Object.keys(t)){const a=t[s];wd(r,s,a,this.options.xmlMode)}else wd(r,t,e,this.options.xmlMode)})}}function y0(t,e,n){var r;(r=t.data)!==null&&r!==void 0||(t.data={}),typeof e=="object"?Object.assign(t.data,e):typeof e=="string"&&n!==void 0&&(t.data[e]=n)}function F4(t){for(const e of Object.keys(t.attribs)){if(!e.startsWith(Uh))continue;const n=x4(e.slice(Uh.length));Gi.call(t.data,n)||(t.data[n]=FE(t.attribs[e]))}return t.data}function U4(t,e){const n=Uh+L4(e),r=t.data;if(Gi.call(r,e))return r[e];if(Gi.call(t.attribs,n))return r[e]=FE(t.attribs[n])}function FE(t){if(t==="null")return null;if(t==="true")return!0;if(t==="false")return!1;const e=Number(t);if(t===String(e))return e;if(D4.test(t))try{return JSON.parse(t)}catch{}return t}function j4(t,e){var n;const r=this[0];if(!r||!fe(r))return;const s=r;return(n=s.data)!==null&&n!==void 0||(s.data={}),t==null?F4(s):typeof t=="object"||e!==void 0?(st(this,a=>{fe(a)&&(typeof t=="object"?y0(a,t):y0(a,t,e))}),this):U4(s,t)}function $4(t){const e=arguments.length===0,n=this[0];if(!n||!fe(n))return e?void 0:this;switch(n.name){case"textarea":return this.text(t);case"select":{const r=this.find("option:selected");if(!e){if(this.attr("multiple")==null&&typeof t=="object")return this;this.find("option").removeAttr("selected");const s=typeof t=="object"?t:[t];for(const a of s)this.find(`option[value="${a}"]`).attr("selected","");return this}return this.attr("multiple")?r.toArray().map(s=>Wi(s.children)):r.attr("value")}case"input":case"option":return e?this.attr("value"):this.attr("value",t)}}function UE(t,e){!t.attribs||!Gi.call(t.attribs,e)||delete t.attribs[e]}function uc(t){return t?t.trim().split(Ki):[]}function H4(t){const e=uc(t);for(const n of e)st(this,r=>{fe(r)&&UE(r,n)});return this}function q4(t){return this.toArray().some(e=>{const n=fe(e)&&e.attribs.class;let r=-1;if(n&&t.length>0)for(;(r=n.indexOf(t,r+1))>-1;){const s=r+t.length;if((r===0||Ki.test(n[r-1]))&&(s===n.length||Ki.test(n[s])))return!0}return!1})}function jE(t){if(typeof t=="function")return st(this,(r,s)=>{if(fe(r)){const a=r.attribs.class||"";jE.call([r],t.call(r,s,a))}});if(!t||typeof t!="string")return this;const e=t.split(Ki),n=this.length;for(let r=0;r<n;r++){const s=this[r];if(!fe(s))continue;const a=oc(s,"class",!1);if(a){let i=` ${a} `;for(const o of e){const u=`${o} `;i.includes(` ${u}`)||(i+=u)}aa(s,"class",i.trim())}else aa(s,"class",e.join(" ").trim())}return this}function $E(t){if(typeof t=="function")return st(this,(s,a)=>{fe(s)&&$E.call([s],t.call(s,a,s.attribs.class||""))});const e=uc(t),n=e.length,r=arguments.length===0;return st(this,s=>{if(fe(s))if(r)s.attribs.class="";else{const a=uc(s.attribs.class);let i=!1;for(let o=0;o<n;o++){const u=a.indexOf(e[o]);u>=0&&(a.splice(u,1),i=!0,o--)}i&&(s.attribs.class=a.join(" "))}})}function HE(t,e){if(typeof t=="function")return st(this,(i,o)=>{fe(i)&&HE.call([i],t.call(i,o,i.attribs.class||"",e),e)});if(!t||typeof t!="string")return this;const n=t.split(Ki),r=n.length,s=typeof e=="boolean"?e?1:-1:0,a=this.length;for(let i=0;i<a;i++){const o=this[i];if(!fe(o))continue;const u=uc(o.attribs.class);for(let c=0;c<r;c++){const l=u.indexOf(n[c]);s>=0&&l<0?u.push(n[c]):s<=0&&l>=0&&u.splice(l,1)}o.attribs.class=u.join(" ")}return this}const V4=Object.freeze(Object.defineProperty({__proto__:null,addClass:jE,attr:M4,data:j4,hasClass:q4,prop:B4,removeAttr:H4,removeClass:$E,toggleClass:HE,val:$4},Symbol.toStringTag,{value:"Module"}));var ue;(function(t){t.Attribute="attribute",t.Pseudo="pseudo",t.PseudoElement="pseudo-element",t.Tag="tag",t.Universal="universal",t.Adjacent="adjacent",t.Child="child",t.Descendant="descendant",t.Parent="parent",t.Sibling="sibling",t.ColumnCombinator="column-combinator"})(ue||(ue={}));var mt;(function(t){t.Any="any",t.Element="element",t.End="end",t.Equals="equals",t.Exists="exists",t.Hyphen="hyphen",t.Not="not",t.Start="start"})(mt||(mt={}));const E0=/^[^\\#]?(?:\\(?:[\da-f]{1,6}\s?|.)|[\w\-\u00b0-\uFFFF])+/,z4=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,W4=new Map([[126,mt.Element],[94,mt.Start],[36,mt.End],[42,mt.Any],[33,mt.Not],[124,mt.Hyphen]]),G4=new Set(["has","not","matches","is","where","host","host-context"]);function mi(t){switch(t.type){case ue.Adjacent:case ue.Child:case ue.Descendant:case ue.Parent:case ue.Sibling:case ue.ColumnCombinator:return!0;default:return!1}}const K4=new Set(["contains","icontains"]);function Y4(t,e,n){const r=parseInt(e,16)-65536;return r!==r||n?e:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,r&1023|56320)}function Va(t){return t.replace(z4,Y4)}function Td(t){return t===39||t===34}function w0(t){return t===32||t===9||t===10||t===12||t===13}function ul(t){const e=[],n=qE(e,`${t}`,0);if(n<t.length)throw new Error(`Unmatched selector: ${t.slice(n)}`);return e}function qE(t,e,n){let r=[];function s(p){const m=e.slice(n+p).match(E0);if(!m)throw new Error(`Expected name, found ${e.slice(n)}`);const[f]=m;return n+=p+f.length,Va(f)}function a(p){for(n+=p;n<e.length&&w0(e.charCodeAt(n));)n++}function i(){n+=1;const p=n;let m=1;for(;m>0&&n<e.length;n++)e.charCodeAt(n)===40&&!o(n)?m++:e.charCodeAt(n)===41&&!o(n)&&m--;if(m)throw new Error("Parenthesis not matched");return Va(e.slice(p,n-1))}function o(p){let m=0;for(;e.charCodeAt(--p)===92;)m++;return(m&1)===1}function u(){if(r.length>0&&mi(r[r.length-1]))throw new Error("Did not expect successive traversals.")}function c(p){if(r.length>0&&r[r.length-1].type===ue.Descendant){r[r.length-1].type=p;return}u(),r.push({type:p})}function l(p,m){r.push({type:ue.Attribute,name:p,action:m,value:s(1),namespace:null,ignoreCase:"quirks"})}function d(){if(r.length&&r[r.length-1].type===ue.Descendant&&r.pop(),r.length===0)throw new Error("Empty sub-selector");t.push(r)}if(a(0),e.length===n)return n;e:for(;n<e.length;){const p=e.charCodeAt(n);switch(p){case 32:case 9:case 10:case 12:case 13:{(r.length===0||r[0].type!==ue.Descendant)&&(u(),r.push({type:ue.Descendant})),a(1);break}case 62:{c(ue.Child),a(1);break}case 60:{c(ue.Parent),a(1);break}case 126:{c(ue.Sibling),a(1);break}case 43:{c(ue.Adjacent),a(1);break}case 46:{l("class",mt.Element);break}case 35:{l("id",mt.Equals);break}case 91:{a(1);let m,f=null;e.charCodeAt(n)===124?m=s(1):e.startsWith("*|",n)?(f="*",m=s(2)):(m=s(0),e.charCodeAt(n)===124&&e.charCodeAt(n+1)!==61&&(f=m,m=s(1))),a(0);let g=mt.Exists;const b=W4.get(e.charCodeAt(n));if(b){if(g=b,e.charCodeAt(n+1)!==61)throw new Error("Expected `=`");a(2)}else e.charCodeAt(n)===61&&(g=mt.Equals,a(1));let _="",E=null;if(g!=="exists"){if(Td(e.charCodeAt(n))){const v=e.charCodeAt(n);let A=n+1;for(;A<e.length&&(e.charCodeAt(A)!==v||o(A));)A+=1;if(e.charCodeAt(A)!==v)throw new Error("Attribute value didn't end");_=Va(e.slice(n+1,A)),n=A+1}else{const v=n;for(;n<e.length&&(!w0(e.charCodeAt(n))&&e.charCodeAt(n)!==93||o(n));)n+=1;_=Va(e.slice(v,n))}a(0);const N=e.charCodeAt(n)|32;N===115?(E=!1,a(1)):N===105&&(E=!0,a(1))}if(e.charCodeAt(n)!==93)throw new Error("Attribute selector didn't terminate");n+=1;const T={type:ue.Attribute,name:m,action:g,value:_,namespace:f,ignoreCase:E};r.push(T);break}case 58:{if(e.charCodeAt(n+1)===58){r.push({type:ue.PseudoElement,name:s(2).toLowerCase(),data:e.charCodeAt(n)===40?i():null});continue}const m=s(1).toLowerCase();let f=null;if(e.charCodeAt(n)===40)if(G4.has(m)){if(Td(e.charCodeAt(n+1)))throw new Error(`Pseudo-selector ${m} cannot be quoted`);if(f=[],n=qE(f,e,n+1),e.charCodeAt(n)!==41)throw new Error(`Missing closing parenthesis in :${m} (${e})`);n+=1}else{if(f=i(),K4.has(m)){const g=f.charCodeAt(0);g===f.charCodeAt(f.length-1)&&Td(g)&&(f=f.slice(1,-1))}f=Va(f)}r.push({type:ue.Pseudo,name:m,data:f});break}case 44:{d(),r=[],a(1);break}default:{if(e.startsWith("/*",n)){const g=e.indexOf("*/",n+2);if(g<0)throw new Error("Comment was not terminated");n=g+2,r.length===0&&a(0);break}let m=null,f;if(p===42)n+=1,f="*";else if(p===124){if(f="",e.charCodeAt(n+1)===124){c(ue.ColumnCombinator),a(2);break}}else if(E0.test(e.slice(n)))f=s(0);else break e;e.charCodeAt(n)===124&&e.charCodeAt(n+1)!==124&&(m=f,e.charCodeAt(n+1)===42?(f="*",n+=2):f=s(1)),r.push(f==="*"?{type:ue.Universal,namespace:m}:{type:ue.Tag,name:f,namespace:m})}}}return d(),n}var cc={trueFunc:function(){return!0},falseFunc:function(){return!1}};const Ie=to(cc),VE=new Map([[ue.Universal,50],[ue.Tag,30],[ue.Attribute,1],[ue.Pseudo,0]]);function _m(t){return!VE.has(t.type)}const Z4=new Map([[mt.Exists,10],[mt.Equals,8],[mt.Not,7],[mt.Start,6],[mt.End,6],[mt.Any,5]]);function J4(t){const e=t.map(zE);for(let n=1;n<t.length;n++){const r=e[n];if(!(r<0))for(let s=n-1;s>=0&&r<e[s];s--){const a=t[s+1];t[s+1]=t[s],t[s]=a,e[s+1]=e[s],e[s]=r}}}function zE(t){var e,n;let r=(e=VE.get(t.type))!==null&&e!==void 0?e:-1;return t.type===ue.Attribute?(r=(n=Z4.get(t.action))!==null&&n!==void 0?n:4,t.action===mt.Equals&&t.name==="id"&&(r=9),t.ignoreCase&&(r>>=1)):t.type===ue.Pseudo&&(t.data?t.name==="has"||t.name==="contains"?r=0:Array.isArray(t.data)?(r=Math.min(...t.data.map(s=>Math.min(...s.map(zE)))),r<0&&(r=0)):r=2:r=3),r}const X4=/[-[\]{}()*+?.,\\^$|#\s]/g;function T0(t){return t.replace(X4,"\\$&")}const Q4=new Set(["accept","accept-charset","align","alink","axis","bgcolor","charset","checked","clear","codetype","color","compact","declare","defer","dir","direction","disabled","enctype","face","frame","hreflang","http-equiv","lang","language","link","media","method","multiple","nohref","noresize","noshade","nowrap","readonly","rel","rev","rules","scope","scrolling","selected","shape","target","text","type","valign","valuetype","vlink"]);function Qr(t,e){return typeof t.ignoreCase=="boolean"?t.ignoreCase:t.ignoreCase==="quirks"?!!e.quirksMode:!e.xmlMode&&Q4.has(t.name)}const eD={equals(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;return Qr(e,n)?(a=a.toLowerCase(),i=>{const o=r.getAttributeValue(i,s);return o!=null&&o.length===a.length&&o.toLowerCase()===a&&t(i)}):i=>r.getAttributeValue(i,s)===a&&t(i)},hyphen(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;const i=a.length;return Qr(e,n)?(a=a.toLowerCase(),function(u){const c=r.getAttributeValue(u,s);return c!=null&&(c.length===i||c.charAt(i)==="-")&&c.substr(0,i).toLowerCase()===a&&t(u)}):function(u){const c=r.getAttributeValue(u,s);return c!=null&&(c.length===i||c.charAt(i)==="-")&&c.substr(0,i)===a&&t(u)}},element(t,e,n){const{adapter:r}=n,{name:s,value:a}=e;if(/\s/.test(a))return Ie.falseFunc;const i=new RegExp(`(?:^|\\s)${T0(a)}(?:$|\\s)`,Qr(e,n)?"i":"");return function(u){const c=r.getAttributeValue(u,s);return c!=null&&c.length>=a.length&&i.test(c)&&t(u)}},exists(t,{name:e},{adapter:n}){return r=>n.hasAttrib(r,e)&&t(r)},start(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;const i=a.length;return i===0?Ie.falseFunc:Qr(e,n)?(a=a.toLowerCase(),o=>{const u=r.getAttributeValue(o,s);return u!=null&&u.length>=i&&u.substr(0,i).toLowerCase()===a&&t(o)}):o=>{var u;return!!(!((u=r.getAttributeValue(o,s))===null||u===void 0)&&u.startsWith(a))&&t(o)}},end(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;const i=-a.length;return i===0?Ie.falseFunc:Qr(e,n)?(a=a.toLowerCase(),o=>{var u;return((u=r.getAttributeValue(o,s))===null||u===void 0?void 0:u.substr(i).toLowerCase())===a&&t(o)}):o=>{var u;return!!(!((u=r.getAttributeValue(o,s))===null||u===void 0)&&u.endsWith(a))&&t(o)}},any(t,e,n){const{adapter:r}=n,{name:s,value:a}=e;if(a==="")return Ie.falseFunc;if(Qr(e,n)){const i=new RegExp(T0(a),"i");return function(u){const c=r.getAttributeValue(u,s);return c!=null&&c.length>=a.length&&i.test(c)&&t(u)}}return i=>{var o;return!!(!((o=r.getAttributeValue(i,s))===null||o===void 0)&&o.includes(a))&&t(i)}},not(t,e,n){const{adapter:r}=n,{name:s}=e;let{value:a}=e;return a===""?i=>!!r.getAttributeValue(i,s)&&t(i):Qr(e,n)?(a=a.toLowerCase(),i=>{const o=r.getAttributeValue(i,s);return(o==null||o.length!==a.length||o.toLowerCase()!==a)&&t(i)}):i=>r.getAttributeValue(i,s)!==a&&t(i)}},tD=new Set([9,10,12,13,32]),S0=48,nD=57;function rD(t){if(t=t.trim().toLowerCase(),t==="even")return[2,0];if(t==="odd")return[2,1];let e=0,n=0,r=a(),s=i();if(e<t.length&&t.charAt(e)==="n"&&(e++,n=r*(s??1),o(),e<t.length?(r=a(),o(),s=i()):r=s=0),s===null||e<t.length)throw new Error(`n-th rule couldn't be parsed ('${t}')`);return[n,r*s];function a(){return t.charAt(e)==="-"?(e++,-1):(t.charAt(e)==="+"&&e++,1)}function i(){const u=e;let c=0;for(;e<t.length&&t.charCodeAt(e)>=S0&&t.charCodeAt(e)<=nD;)c=c*10+(t.charCodeAt(e)-S0),e++;return e===u?null:c}function o(){for(;e<t.length&&tD.has(t.charCodeAt(e));)e++}}function sD(t){const e=t[0],n=t[1]-1;if(n<0&&e<=0)return Ie.falseFunc;if(e===-1)return a=>a<=n;if(e===0)return a=>a===n;if(e===1)return n<0?Ie.trueFunc:a=>a>=n;const r=Math.abs(e),s=(n%r+r)%r;return e>1?a=>a>=n&&a%r===s:a=>a<=n&&a%r===s}function iu(t){return sD(rD(t))}function ou(t,e){return n=>{const r=e.getParent(n);return r!=null&&e.isTag(r)&&t(n)}}const jh={contains(t,e,{adapter:n}){return function(s){return t(s)&&n.getText(s).includes(e)}},icontains(t,e,{adapter:n}){const r=e.toLowerCase();return function(a){return t(a)&&n.getText(a).toLowerCase().includes(r)}},"nth-child"(t,e,{adapter:n,equals:r}){const s=iu(e);return s===Ie.falseFunc?Ie.falseFunc:s===Ie.trueFunc?ou(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=0;c<o.length&&!r(i,o[c]);c++)n.isTag(o[c])&&u++;return s(u)&&t(i)}},"nth-last-child"(t,e,{adapter:n,equals:r}){const s=iu(e);return s===Ie.falseFunc?Ie.falseFunc:s===Ie.trueFunc?ou(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=o.length-1;c>=0&&!r(i,o[c]);c--)n.isTag(o[c])&&u++;return s(u)&&t(i)}},"nth-of-type"(t,e,{adapter:n,equals:r}){const s=iu(e);return s===Ie.falseFunc?Ie.falseFunc:s===Ie.trueFunc?ou(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=0;c<o.length;c++){const l=o[c];if(r(i,l))break;n.isTag(l)&&n.getName(l)===n.getName(i)&&u++}return s(u)&&t(i)}},"nth-last-of-type"(t,e,{adapter:n,equals:r}){const s=iu(e);return s===Ie.falseFunc?Ie.falseFunc:s===Ie.trueFunc?ou(t,n):function(i){const o=n.getSiblings(i);let u=0;for(let c=o.length-1;c>=0;c--){const l=o[c];if(r(i,l))break;n.isTag(l)&&n.getName(l)===n.getName(i)&&u++}return s(u)&&t(i)}},root(t,e,{adapter:n}){return r=>{const s=n.getParent(r);return(s==null||!n.isTag(s))&&t(r)}},scope(t,e,n,r){const{equals:s}=n;return!r||r.length===0?jh.root(t,e,n):r.length===1?a=>s(r[0],a)&&t(a):a=>r.includes(a)&&t(a)},hover:Sd("isHovered"),visited:Sd("isVisited"),active:Sd("isActive")};function Sd(t){return function(n,r,{adapter:s}){const a=s[t];return typeof a!="function"?Ie.falseFunc:function(o){return a(o)&&n(o)}}}const A0={empty(t,{adapter:e}){return!e.getChildren(t).some(n=>e.isTag(n)||e.getText(n)!=="")},"first-child"(t,{adapter:e,equals:n}){if(e.prevElementSibling)return e.prevElementSibling(t)==null;const r=e.getSiblings(t).find(s=>e.isTag(s));return r!=null&&n(t,r)},"last-child"(t,{adapter:e,equals:n}){const r=e.getSiblings(t);for(let s=r.length-1;s>=0;s--){if(n(t,r[s]))return!0;if(e.isTag(r[s]))break}return!1},"first-of-type"(t,{adapter:e,equals:n}){const r=e.getSiblings(t),s=e.getName(t);for(let a=0;a<r.length;a++){const i=r[a];if(n(t,i))return!0;if(e.isTag(i)&&e.getName(i)===s)break}return!1},"last-of-type"(t,{adapter:e,equals:n}){const r=e.getSiblings(t),s=e.getName(t);for(let a=r.length-1;a>=0;a--){const i=r[a];if(n(t,i))return!0;if(e.isTag(i)&&e.getName(i)===s)break}return!1},"only-of-type"(t,{adapter:e,equals:n}){const r=e.getName(t);return e.getSiblings(t).every(s=>n(t,s)||!e.isTag(s)||e.getName(s)!==r)},"only-child"(t,{adapter:e,equals:n}){return e.getSiblings(t).every(r=>n(t,r)||!e.isTag(r))}};function C0(t,e,n,r){if(n===null){if(t.length>r)throw new Error(`Pseudo-class :${e} requires an argument`)}else if(t.length===r)throw new Error(`Pseudo-class :${e} doesn't have any arguments`)}const aD={"any-link":":is(a, area, link)[href]",link:":any-link:not(:visited)",disabled:`:is(
        :is(button, input, select, textarea, optgroup, option)[disabled],
        optgroup[disabled] > option,
        fieldset[disabled]:not(fieldset[disabled] legend:first-of-type *)
    )`,enabled:":not(:disabled)",checked:":is(:is(input[type=radio], input[type=checkbox])[checked], option:selected)",required:":is(input, select, textarea)[required]",optional:":is(input, select, textarea):not([required])",selected:"option:is([selected], select:not([multiple]):not(:has(> option[selected])) > :first-of-type)",checkbox:"[type=checkbox]",file:"[type=file]",password:"[type=password]",radio:"[type=radio]",reset:"[type=reset]",image:"[type=image]",submit:"[type=submit]",parent:":not(:empty)",header:":is(h1, h2, h3, h4, h5, h6)",button:":is(button, input[type=button])",input:":is(input, textarea, select, button)",text:"input:is(:not([type!='']), [type=text])"},WE={};function iD(t,e){return t===Ie.falseFunc?Ie.falseFunc:n=>e.isTag(n)&&t(n)}function GE(t,e){const n=e.getSiblings(t);if(n.length<=1)return[];const r=n.indexOf(t);return r<0||r===n.length-1?[]:n.slice(r+1).filter(e.isTag)}function $h(t){return{xmlMode:!!t.xmlMode,lowerCaseAttributeNames:!!t.lowerCaseAttributeNames,lowerCaseTags:!!t.lowerCaseTags,quirksMode:!!t.quirksMode,cacheResults:!!t.cacheResults,pseudos:t.pseudos,adapter:t.adapter,equals:t.equals}}const Ad=(t,e,n,r,s)=>{const a=s(e,$h(n),r);return a===Ie.trueFunc?t:a===Ie.falseFunc?Ie.falseFunc:i=>a(i)&&t(i)},Cd={is:Ad,matches:Ad,where:Ad,not(t,e,n,r,s){const a=s(e,$h(n),r);return a===Ie.falseFunc?t:a===Ie.trueFunc?Ie.falseFunc:i=>!a(i)&&t(i)},has(t,e,n,r,s){const{adapter:a}=n,i=$h(n);i.relativeSelector=!0;const o=e.some(l=>l.some(_m))?[WE]:void 0,u=s(e,i,o);if(u===Ie.falseFunc)return Ie.falseFunc;const c=iD(u,a);if(o&&u!==Ie.trueFunc){const{shouldTestNextSiblings:l=!1}=u;return d=>{if(!t(d))return!1;o[0]=d;const p=a.getChildren(d),m=l?[...p,...GE(d,a)]:p;return a.existsOne(c,m)}}return l=>t(l)&&a.existsOne(c,a.getChildren(l))}};function oD(t,e,n,r,s){var a;const{name:i,data:o}=e;if(Array.isArray(o)){if(!(i in Cd))throw new Error(`Unknown pseudo-class :${i}(${o})`);return Cd[i](t,o,n,r,s)}const u=(a=n.pseudos)===null||a===void 0?void 0:a[i],c=typeof u=="string"?u:aD[i];if(typeof c=="string"){if(o!=null)throw new Error(`Pseudo ${i} doesn't have any arguments`);const l=ul(c);return Cd.is(t,l,n,r,s)}if(typeof u=="function")return C0(u,i,o,1),l=>u(l,o)&&t(l);if(i in jh)return jh[i](t,o,n,r);if(i in A0){const l=A0[i];return C0(l,i,o,2),d=>l(d,n,o)&&t(d)}throw new Error(`Unknown pseudo-class :${i}`)}function Od(t,e){const n=e.getParent(t);return n&&e.isTag(n)?n:null}function uD(t,e,n,r,s){const{adapter:a,equals:i}=n;switch(e.type){case ue.PseudoElement:throw new Error("Pseudo-elements are not supported by css-select");case ue.ColumnCombinator:throw new Error("Column combinators are not yet supported by css-select");case ue.Attribute:{if(e.namespace!=null)throw new Error("Namespaced attributes are not yet supported by css-select");return(!n.xmlMode||n.lowerCaseAttributeNames)&&(e.name=e.name.toLowerCase()),eD[e.action](t,e,n)}case ue.Pseudo:return oD(t,e,n,r,s);case ue.Tag:{if(e.namespace!=null)throw new Error("Namespaced tag names are not yet supported by css-select");let{name:o}=e;return(!n.xmlMode||n.lowerCaseTags)&&(o=o.toLowerCase()),function(c){return a.getName(c)===o&&t(c)}}case ue.Descendant:{if(n.cacheResults===!1||typeof WeakSet>"u")return function(c){let l=c;for(;l=Od(l,a);)if(t(l))return!0;return!1};const o=new WeakSet;return function(c){let l=c;for(;l=Od(l,a);)if(!o.has(l)){if(a.isTag(l)&&t(l))return!0;o.add(l)}return!1}}case"_flexibleDescendant":return function(u){let c=u;do if(t(c))return!0;while(c=Od(c,a));return!1};case ue.Parent:return function(u){return a.getChildren(u).some(c=>a.isTag(c)&&t(c))};case ue.Child:return function(u){const c=a.getParent(u);return c!=null&&a.isTag(c)&&t(c)};case ue.Sibling:return function(u){const c=a.getSiblings(u);for(let l=0;l<c.length;l++){const d=c[l];if(i(u,d))break;if(a.isTag(d)&&t(d))return!0}return!1};case ue.Adjacent:return a.prevElementSibling?function(u){const c=a.prevElementSibling(u);return c!=null&&t(c)}:function(u){const c=a.getSiblings(u);let l;for(let d=0;d<c.length;d++){const p=c[d];if(i(u,p))break;a.isTag(p)&&(l=p)}return!!l&&t(l)};case ue.Universal:{if(e.namespace!=null&&e.namespace!=="*")throw new Error("Namespaced universal selectors are not yet supported by css-select");return t}}}function KE(t){return t.type===ue.Pseudo&&(t.name==="scope"||Array.isArray(t.data)&&t.data.some(e=>e.some(KE)))}const cD={type:ue.Descendant},lD={type:"_flexibleDescendant"},dD={type:ue.Pseudo,name:"scope",data:null};function hD(t,{adapter:e},n){const r=!!(n!=null&&n.every(s=>{const a=e.isTag(s)&&e.getParent(s);return s===WE||a&&e.isTag(a)}));for(const s of t){if(!(s.length>0&&_m(s[0])&&s[0].type!==ue.Descendant))if(r&&!s.some(KE))s.unshift(cD);else continue;s.unshift(dD)}}function YE(t,e,n){var r;t.forEach(J4),n=(r=e.context)!==null&&r!==void 0?r:n;const s=Array.isArray(n),a=n&&(Array.isArray(n)?n:[n]);if(e.relativeSelector!==!1)hD(t,e,a);else if(t.some(u=>u.length>0&&_m(u[0])))throw new Error("Relative selectors are not allowed when the `relativeSelector` option is disabled");let i=!1;const o=t.map(u=>{if(u.length>=2){const[c,l]=u;c.type!==ue.Pseudo||c.name!=="scope"||(s&&l.type===ue.Descendant?u[1]=lD:(l.type===ue.Adjacent||l.type===ue.Sibling)&&(i=!0))}return fD(u,e,a)}).reduce(mD,Ie.falseFunc);return o.shouldTestNextSiblings=i,o}function fD(t,e,n){var r;return t.reduce((s,a)=>s===Ie.falseFunc?Ie.falseFunc:uD(s,a,e,n,YE),(r=e.rootFunc)!==null&&r!==void 0?r:Ie.trueFunc)}function mD(t,e){return e===Ie.falseFunc||t===Ie.trueFunc?t:t===Ie.falseFunc||e===Ie.trueFunc?e:function(r){return t(r)||e(r)}}const ZE=(t,e)=>t===e,pD={adapter:ol,equals:ZE};function gD(t){var e,n,r,s;const a=t??pD;return(e=a.adapter)!==null&&e!==void 0||(a.adapter=ol),(n=a.equals)!==null&&n!==void 0||(a.equals=(s=(r=a.adapter)===null||r===void 0?void 0:r.equals)!==null&&s!==void 0?s:ZE),a}function bD(t){return function(n,r,s){const a=gD(r);return t(n,a,s)}}const ym=bD(YE);function JE(t,e,n=!1){return n&&(t=_D(t,e)),Array.isArray(t)?e.removeSubsets(t):e.getChildren(t)}function _D(t,e){const n=Array.isArray(t)?t.slice(0):[t],r=n.length;for(let s=0;s<r;s++){const a=GE(n[s],e);n.push(...a)}return n}const yD=new Set(["first","last","eq","gt","nth","lt","even","odd"]);function lc(t){return t.type!=="pseudo"?!1:yD.has(t.name)?!0:t.name==="not"&&Array.isArray(t.data)?t.data.some(e=>e.some(lc)):!1}function ED(t,e,n){const r=e!=null?parseInt(e,10):NaN;switch(t){case"first":return 1;case"nth":case"eq":return isFinite(r)?r>=0?r+1:1/0:0;case"lt":return isFinite(r)?r>=0?Math.min(r,n):1/0:0;case"gt":return isFinite(r)?1/0:0;case"odd":return 2*n;case"even":return 2*n-1;case"last":case"not":return 1/0}}function wD(t){for(;t.parent;)t=t.parent;return t}function Em(t){const e=[],n=[];for(const r of t)r.some(lc)?e.push(r):n.push(r);return[n,e]}const TD={type:ue.Universal,namespace:null},SD={type:ue.Pseudo,name:"scope",data:null};function XE(t,e,n={}){return QE([t],e,n)}function QE(t,e,n={}){if(typeof e=="function")return t.some(e);const[r,s]=Em(ul(e));return r.length>0&&t.some(ym(r,n))||s.some(a=>nw(a,t,n).length>0)}function AD(t,e,n,r){const s=typeof n=="string"?parseInt(n,10):NaN;switch(t){case"first":case"lt":return e;case"last":return e.length>0?[e[e.length-1]]:e;case"nth":case"eq":return isFinite(s)&&Math.abs(s)<e.length?[s<0?e[e.length+s]:e[s]]:[];case"gt":return isFinite(s)?e.slice(s+1):[];case"even":return e.filter((a,i)=>i%2===0);case"odd":return e.filter((a,i)=>i%2===1);case"not":{const a=new Set(tw(n,e,r));return e.filter(i=>!a.has(i))}}}function ew(t,e,n={}){return tw(ul(t),e,n)}function tw(t,e,n){if(e.length===0)return[];const[r,s]=Em(t);let a;if(r.length){const i=qh(e,r,n);if(s.length===0)return i;i.length&&(a=new Set(i))}for(let i=0;i<s.length&&(a==null?void 0:a.size)!==e.length;i++){const o=s[i];if((a?e.filter(l=>fe(l)&&!a.has(l)):e).length===0)break;const c=nw(o,e,n);if(c.length)if(a)c.forEach(l=>a.add(l));else{if(i===s.length-1)return c;a=new Set(c)}}return typeof a<"u"?a.size===e.length?e:e.filter(i=>a.has(i)):[]}function nw(t,e,n){var r;if(t.some(mi)){const s=(r=n.root)!==null&&r!==void 0?r:wD(e[0]),a={...n,context:e,relativeSelector:!1};return t.push(SD),dc(s,t,a,!0,e.length)}return dc(e,t,n,!1,e.length)}function CD(t,e,n={},r=1/0){if(typeof t=="function")return rw(e,t);const[s,a]=Em(ul(t)),i=a.map(o=>dc(e,o,n,!0,r));return s.length&&i.push(Hh(e,s,n,r)),i.length===0?[]:i.length===1?i[0]:Na(i.reduce((o,u)=>[...o,...u]))}function dc(t,e,n,r,s){const a=e.findIndex(lc),i=e.slice(0,a),o=e[a],u=e.length-1===a?s:1/0,c=ED(o.name,o.data,u);if(c===0)return[];const d=(i.length===0&&!Array.isArray(t)?il(t).filter(fe):i.length===0?(Array.isArray(t)?t:[t]).filter(fe):r||i.some(mi)?Hh(t,[i],n,c):qh(t,[i],n)).slice(0,c);let p=AD(o.name,d,o.data,n);if(p.length===0||e.length===a+1)return p;const m=e.slice(a+1),f=m.some(mi);if(f){if(mi(m[0])){const{type:g}=m[0];(g===ue.Sibling||g===ue.Adjacent)&&(p=JE(p,ol,!0)),m.unshift(TD)}n={...n,relativeSelector:!1,rootFunc:g=>p.includes(g)}}else n.rootFunc&&n.rootFunc!==cc.trueFunc&&(n={...n,rootFunc:cc.trueFunc});return m.some(lc)?dc(p,m,n,!1,s):f?Hh(p,[m],n,s):qh(p,[m],n)}function Hh(t,e,n,r){const s=ym(e,n,t);return rw(t,s,r)}function rw(t,e,n=1/0){const r=JE(t,ol,e.shouldTestNextSiblings);return mm(s=>fe(s)&&e(s),r,!0,n)}function qh(t,e,n){const r=(Array.isArray(t)?t:[t]).filter(fe);if(r.length===0)return r;const s=ym(e,n);return s===cc.trueFunc?r:r.filter(s)}const OD=/^\s*[+~]/;function vD(t){if(!t)return this._make([]);if(typeof t!="string"){const e=Or(t)?t.toArray():[t],n=this.toArray();return this._make(e.filter(r=>n.some(s=>BE(s,r))))}return this._findBySelector(t,Number.POSITIVE_INFINITY)}function ID(t,e){var n;const r=this.toArray(),s=OD.test(t)?r:this.children().toArray(),a={context:r,root:(n=this._root)===null||n===void 0?void 0:n[0],xmlMode:this.options.xmlMode,lowerCaseTags:this.options.lowerCaseTags,lowerCaseAttributeNames:this.options.lowerCaseAttributeNames,pseudos:this.options.pseudos,quirksMode:this.options.quirksMode};return this._make(CD(t,s,a,e))}function wm(t){return function(e,...n){return function(r){var s;let a=t(e,this);return r&&(a=Am(a,r,this.options.xmlMode,(s=this._root)===null||s===void 0?void 0:s[0])),this._make(this.length>1&&a.length>1?n.reduce((i,o)=>o(i),a):a)}}}const yo=wm((t,e)=>{let n=[];for(let r=0;r<e.length;r++){const s=t(e[r]);s.length>0&&(n=n.concat(s))}return n}),Tm=wm((t,e)=>{const n=[];for(let r=0;r<e.length;r++){const s=t(e[r]);s!==null&&n.push(s)}return n});function Sm(t,...e){let n=null;const r=wm((s,a)=>{const i=[];return st(a,o=>{for(let u;(u=s(o))&&!(n!=null&&n(u,i.length));o=u)i.push(u)}),i})(t,...e);return function(s,a){n=typeof s=="string"?o=>XE(o,s,this.options):s?Eo(s):null;const i=r.call(this,a);return n=null,i}}function ka(t){return t.length>1?Array.from(new Set(t)):t}const ND=Tm(({parent:t})=>t&&!Zr(t)?t:null,ka),kD=yo(t=>{const e=[];for(;t.parent&&!Zr(t.parent);)e.push(t.parent),t=t.parent;return e},Na,t=>t.reverse()),RD=Sm(({parent:t})=>t&&!Zr(t)?t:null,Na,t=>t.reverse());function PD(t){var e;const n=[];if(!t)return this._make(n);const r={xmlMode:this.options.xmlMode,root:(e=this._root)===null||e===void 0?void 0:e[0]},s=typeof t=="string"?a=>XE(a,t,r):Eo(t);return st(this,a=>{for(a&&!Zr(a)&&!fe(a)&&(a=a.parent);a&&fe(a);){if(s(a,0)){n.includes(a)||n.push(a);break}a=a.parent}}),this._make(n)}const xD=Tm(t=>hm(t)),LD=yo(t=>{const e=[];for(;t.next;)t=t.next,fe(t)&&e.push(t);return e},ka),DD=Sm(t=>hm(t),ka),MD=Tm(t=>fm(t)),BD=yo(t=>{const e=[];for(;t.prev;)t=t.prev,fe(t)&&e.push(t);return e},ka),FD=Sm(t=>fm(t),ka),UD=yo(t=>RE(t).filter(e=>fe(e)&&e!==t),Na),jD=yo(t=>il(t).filter(fe),ka);function $D(){const t=this.toArray().reduce((e,n)=>it(n)?e.concat(n.children):e,[]);return this._make(t)}function HD(t){let e=0;const n=this.length;for(;e<n&&t.call(this[e],e,this[e])!==!1;)++e;return this}function qD(t){let e=[];for(let n=0;n<this.length;n++){const r=this[n],s=t.call(r,n,r);s!=null&&(e=e.concat(s))}return this._make(e)}function Eo(t){return typeof t=="function"?(e,n)=>t.call(e,n,e):Or(t)?e=>Array.prototype.includes.call(t,e):function(e){return t===e}}function VD(t){var e;return this._make(Am(this.toArray(),t,this.options.xmlMode,(e=this._root)===null||e===void 0?void 0:e[0]))}function Am(t,e,n,r){return typeof e=="string"?ew(e,t,{xmlMode:n,root:r}):t.filter(Eo(e))}function zD(t){const e=this.toArray();return typeof t=="string"?QE(e.filter(fe),t,this.options):t?e.some(Eo(t)):!1}function WD(t){let e=this.toArray();if(typeof t=="string"){const n=new Set(ew(t,e,this.options));e=e.filter(r=>!n.has(r))}else{const n=Eo(t);e=e.filter((r,s)=>!n(r,s))}return this._make(e)}function GD(t){return this.filter(typeof t=="string"?`:has(${t})`:(e,n)=>this._make(n).find(t).length>0)}function KD(){return this.length>1?this._make(this[0]):this}function YD(){return this.length>0?this._make(this[this.length-1]):this}function ZD(t){var e;return t=+t,t===0&&this.length<=1?this:(t<0&&(t=this.length+t),this._make((e=this[t])!==null&&e!==void 0?e:[]))}function JD(t){return t==null?this.toArray():this[t<0?this.length+t:t]}function XD(){return Array.prototype.slice.call(this)}function QD(t){let e,n;return t==null?(e=this.parent().children(),n=this[0]):typeof t=="string"?(e=this._make(t),n=this[0]):(e=this,n=Or(t)?t[0]:t),Array.prototype.indexOf.call(e,n)}function eM(t,e){return this._make(Array.prototype.slice.call(this,t,e))}function tM(){var t;return(t=this.prevObject)!==null&&t!==void 0?t:this._make([])}function nM(t,e){const n=this._make(t,e),r=Na([...this.get(),...n.get()]);return this._make(r)}function rM(t){return this.prevObject?this.add(t?this.prevObject.filter(t):this.prevObject):this}const sM=Object.freeze(Object.defineProperty({__proto__:null,_findBySelector:ID,add:nM,addBack:rM,children:jD,closest:PD,contents:$D,each:HD,end:tM,eq:ZD,filter:VD,filterArray:Am,find:vD,first:KD,get:JD,has:GD,index:QD,is:zD,last:YD,map:qD,next:xD,nextAll:LD,nextUntil:DD,not:WD,parent:ND,parents:kD,parentsUntil:RD,prev:MD,prevAll:BD,prevUntil:FD,siblings:UD,slice:eM,toArray:XD},Symbol.toStringTag,{value:"Module"}));function aM(t){return function(n,r,s,a){if(typeof Buffer<"u"&&Buffer.isBuffer(n)&&(n=n.toString()),typeof n=="string")return t(n,r,s,a);const i=n;if(!Array.isArray(i)&&Zr(i))return i;const o=new Cs([]);return Os(i,o),o}}function Os(t,e){const n=Array.isArray(t)?t:[t];e?e.children=n:e=null;for(let r=0;r<n.length;r++){const s=n[r];s.parent&&s.parent.children!==n&&Ns(s),e?(s.prev=n[r-1]||null,s.next=n[r+1]||null):s.prev=s.next=null,s.parent=e}return e}function iM(t,e){if(t==null)return[];if(typeof t=="string")return this._parse(t,this.options,!1,null).children.slice(0);if("length"in t){if(t.length===1)return this._makeDomArray(t[0],e);const n=[];for(let r=0;r<t.length;r++){const s=t[r];if(typeof s=="object"){if(s==null)continue;if(!("length"in s)){n.push(e?zi(s,!0):s);continue}}n.push(...this._makeDomArray(s,e))}return n}return[e?zi(t,!0):t]}function sw(t){return function(...e){const n=this.length-1;return st(this,(r,s)=>{if(!it(r))return;const a=typeof e[0]=="function"?e[0].call(r,s,this._render(r.children)):e,i=this._makeDomArray(a,s<n);t(i,r.children,r)})}}function Jr(t,e,n,r,s){var a,i;const o=[e,n,...r],u=e===0?null:t[e-1],c=e+n>=t.length?null:t[e+n];for(let l=0;l<r.length;++l){const d=r[l],p=d.parent;if(p){const f=p.children.indexOf(d);f>-1&&(p.children.splice(f,1),s===p&&e>f&&o[0]--)}d.parent=s,d.prev&&(d.prev.next=(a=d.next)!==null&&a!==void 0?a:null),d.next&&(d.next.prev=(i=d.prev)!==null&&i!==void 0?i:null),d.prev=l===0?u:r[l-1],d.next=l===r.length-1?c:r[l+1]}return u&&(u.next=r[0]),c&&(c.prev=r[r.length-1]),t.splice(...o)}function oM(t){return(Or(t)?t:this._make(t)).append(this),this}function uM(t){return(Or(t)?t:this._make(t)).prepend(this),this}const cM=sw((t,e,n)=>{Jr(e,e.length,0,t,n)}),lM=sw((t,e,n)=>{Jr(e,0,0,t,n)});function aw(t){return function(e){const n=this.length-1,r=this.parents().last();for(let s=0;s<this.length;s++){const a=this[s],i=typeof e=="function"?e.call(a,s,a):typeof e=="string"&&!Fh(e)?r.find(e).clone():e,[o]=this._makeDomArray(i,s<n);if(!o||!it(o))continue;let u=o,c=0;for(;c<u.children.length;){const l=u.children[c];fe(l)?(u=l,c=0):c++}t(a,u,[o])}return this}}const dM=aw((t,e,n)=>{const{parent:r}=t;if(!r)return;const s=r.children,a=s.indexOf(t);Os([t],e),Jr(s,a,0,n,r)}),hM=aw((t,e,n)=>{it(t)&&(Os(t.children,e),Os(n,t))});function fM(t){return this.parent(t).not("body").each((e,n)=>{this._make(n).replaceWith(n.children)}),this}function mM(t){const e=this[0];if(e){const n=this._make(typeof t=="function"?t.call(e,0,e):t).insertBefore(e);let r;for(let a=0;a<n.length;a++)n[a].type==="tag"&&(r=n[a]);let s=0;for(;r&&s<r.children.length;){const a=r.children[s];a.type==="tag"?(r=a,s=0):s++}r&&this._make(r).append(this)}return this}function pM(...t){const e=this.length-1;return st(this,(n,r)=>{if(!it(n)||!n.parent)return;const s=n.parent.children,a=s.indexOf(n);if(a<0)return;const i=typeof t[0]=="function"?t[0].call(n,r,this._render(n.children)):t,o=this._makeDomArray(i,r<e);Jr(s,a+1,0,o,n.parent)})}function gM(t){typeof t=="string"&&(t=this._make(t)),this.remove();const e=[];for(const n of this._makeDomArray(t)){const r=this.clone().toArray(),{parent:s}=n;if(!s)continue;const a=s.children,i=a.indexOf(n);i<0||(Jr(a,i+1,0,r,s),e.push(...r))}return this._make(e)}function bM(...t){const e=this.length-1;return st(this,(n,r)=>{if(!it(n)||!n.parent)return;const s=n.parent.children,a=s.indexOf(n);if(a<0)return;const i=typeof t[0]=="function"?t[0].call(n,r,this._render(n.children)):t,o=this._makeDomArray(i,r<e);Jr(s,a,0,o,n.parent)})}function _M(t){const e=this._make(t);this.remove();const n=[];return st(e,r=>{const s=this.clone().toArray(),{parent:a}=r;if(!a)return;const i=a.children,o=i.indexOf(r);o<0||(Jr(i,o,0,s,a),n.push(...s))}),this._make(n)}function yM(t){const e=t?this.filter(t):this;return st(e,n=>{Ns(n),n.prev=n.next=n.parent=null}),this}function EM(t){return st(this,(e,n)=>{const{parent:r}=e;if(!r)return;const s=r.children,a=typeof t=="function"?t.call(e,n,e):t,i=this._makeDomArray(a);Os(i,null);const o=s.indexOf(e);Jr(s,o,1,i,r),i.includes(e)||(e.parent=e.prev=e.next=null)})}function wM(){return st(this,t=>{if(it(t)){for(const e of t.children)e.next=e.prev=e.parent=null;t.children.length=0}})}function TM(t){if(t===void 0){const e=this[0];return!e||!it(e)?null:this._render(e.children)}return st(this,e=>{if(!it(e))return;for(const r of e.children)r.next=r.prev=r.parent=null;const n=Or(t)?t.toArray():this._parse(`${t}`,this.options,!1,e).children;Os(n,e)})}function SM(){return this._render(this)}function AM(t){return t===void 0?Wi(this):typeof t=="function"?st(this,(e,n)=>this._make(e).text(t.call(e,n,Wi([e])))):st(this,e=>{if(!it(e))return;for(const r of e.children)r.next=r.prev=r.parent=null;const n=new Vi(`${t}`);Os(n,e)})}function CM(){const t=Array.prototype.map.call(this.get(),n=>zi(n,!0)),e=new Cs(t);for(const n of t)n.parent=e;return this._make(t)}const OM=Object.freeze(Object.defineProperty({__proto__:null,_makeDomArray:iM,after:pM,append:cM,appendTo:oM,before:bM,clone:CM,empty:wM,html:TM,insertAfter:gM,insertBefore:_M,prepend:lM,prependTo:uM,remove:yM,replaceWith:EM,text:AM,toString:SM,unwrap:fM,wrap:dM,wrapAll:mM,wrapInner:hM},Symbol.toStringTag,{value:"Module"}));function vM(t,e){if(t!=null&&e!=null||typeof t=="object"&&!Array.isArray(t))return st(this,(n,r)=>{fe(n)&&iw(n,t,e,r)});if(this.length!==0)return ow(this[0],t)}function iw(t,e,n,r){if(typeof e=="string"){const s=ow(t),a=typeof n=="function"?n.call(t,r,s[e]):n;a===""?delete s[e]:a!=null&&(s[e]=a),t.attribs.style=IM(s)}else if(typeof e=="object"){const s=Object.keys(e);for(let a=0;a<s.length;a++){const i=s[a];iw(t,i,e[i],a)}}}function ow(t,e){if(!t||!fe(t))return;const n=NM(t.attribs.style);if(typeof e=="string")return n[e];if(Array.isArray(e)){const r={};for(const s of e)n[s]!=null&&(r[s]=n[s]);return r}return n}function IM(t){return Object.keys(t).reduce((e,n)=>`${e}${e?" ":""}${n}: ${t[n]};`,"")}function NM(t){if(t=(t||"").trim(),!t)return{};const e={};let n;for(const r of t.split(";")){const s=r.indexOf(":");if(s<1||s===r.length-1){const a=r.trimEnd();a.length>0&&n!==void 0&&(e[n]+=`;${a}`)}else n=r.slice(0,s).trim(),e[n]=r.slice(s+1).trim()}return e}const kM=Object.freeze(Object.defineProperty({__proto__:null,css:vM},Symbol.toStringTag,{value:"Module"})),O0="input,select,textarea,keygen",RM=/%20/g,v0=/\r?\n/g;function PM(){return this.serializeArray().map(n=>`${encodeURIComponent(n.name)}=${encodeURIComponent(n.value)}`).join("&").replace(RM,"+")}function xM(){return this.map((t,e)=>{const n=this._make(e);return fe(e)&&e.name==="form"?n.find(O0).toArray():n.filter(O0).toArray()}).filter('[name!=""]:enabled:not(:submit, :button, :image, :reset, :file):matches([checked], :not(:checkbox, :radio))').map((t,e)=>{var n;const r=this._make(e),s=r.attr("name"),a=(n=r.val())!==null&&n!==void 0?n:"";return Array.isArray(a)?a.map(i=>({name:s,value:i.replace(v0,`\r
`)})):{name:s,value:a.replace(v0,`\r
`)}}).toArray()}const LM=Object.freeze(Object.defineProperty({__proto__:null,serialize:PM,serializeArray:xM},Symbol.toStringTag,{value:"Module"}));function DM(t){var e;return typeof t=="string"?{selector:t,value:"textContent"}:{selector:t.selector,value:(e=t.value)!==null&&e!==void 0?e:"textContent"}}function MM(t){const e={};for(const n in t){const r=t[n],s=Array.isArray(r),{selector:a,value:i}=DM(s?r[0]:r),o=typeof i=="function"?i:typeof i=="string"?u=>this._make(u).prop(i):u=>this._make(u).extract(i);if(s)e[n]=this._findBySelector(a,Number.POSITIVE_INFINITY).map((u,c)=>o(c,n,e)).get();else{const u=this._findBySelector(a,1);e[n]=u.length>0?o(u[0],n,e):void 0}}return e}const BM=Object.freeze(Object.defineProperty({__proto__:null,extract:MM},Symbol.toStringTag,{value:"Module"}));class wo{constructor(e,n,r){if(this.length=0,this.options=r,this._root=n,e){for(let s=0;s<e.length;s++)this[s]=e[s];this.length=e.length}}}wo.prototype.cheerio="[cheerio object]";wo.prototype.splice=Array.prototype.splice;wo.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator];Object.assign(wo.prototype,V4,sM,OM,kM,LM,BM);function FM(t,e){return function n(r,s,a=!0){if(r==null)throw new Error("cheerio.load() expects a string");const i=Bh(s),o=t(r,i,a,null);class u extends wo{_make(d,p){const m=c(d,p);return m.prevObject=this,m}_parse(d,p,m,f){return t(d,p,m,f)}_render(d){return e(d,this.options)}}function c(l,d,p=o,m){if(l&&Or(l))return l;const f=Bh(m,i),g=typeof p=="string"?[t(p,f,!1,null)]:"length"in p?p:[p],b=Or(g)?g:new u(g,null,f);if(b._root=b,!l)return new u(void 0,b,f);const _=typeof l=="string"&&Fh(l)?t(l,f,!1,null).children:UM(l)?[l]:Array.isArray(l)?l:void 0,E=new u(_,b,f);if(_)return E;if(typeof l!="string")throw new TypeError("Unexpected type of selector");let T=l;const N=d?typeof d=="string"?Fh(d)?new u([t(d,f,!1,null)],b,f):(T=`${d} ${T}`,b):Or(d)?d:new u(Array.isArray(d)?d:[d],b,f):b;return N?N.find(T):E}return Object.assign(c,P4,{load:n,_root:o,_options:i,fn:u.prototype,prototype:u.prototype}),c}}function UM(t){return!!t.name||t.type==="root"||t.type==="text"||t.type==="comment"}const jM=new Set([65534,65535,131070,131071,196606,196607,262142,262143,327678,327679,393214,393215,458750,458751,524286,524287,589822,589823,655358,655359,720894,720895,786430,786431,851966,851967,917502,917503,983038,983039,1048574,1048575,1114110,1114111]),Qe="";var y;(function(t){t[t.EOF=-1]="EOF",t[t.NULL=0]="NULL",t[t.TABULATION=9]="TABULATION",t[t.CARRIAGE_RETURN=13]="CARRIAGE_RETURN",t[t.LINE_FEED=10]="LINE_FEED",t[t.FORM_FEED=12]="FORM_FEED",t[t.SPACE=32]="SPACE",t[t.EXCLAMATION_MARK=33]="EXCLAMATION_MARK",t[t.QUOTATION_MARK=34]="QUOTATION_MARK",t[t.AMPERSAND=38]="AMPERSAND",t[t.APOSTROPHE=39]="APOSTROPHE",t[t.HYPHEN_MINUS=45]="HYPHEN_MINUS",t[t.SOLIDUS=47]="SOLIDUS",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_9=57]="DIGIT_9",t[t.SEMICOLON=59]="SEMICOLON",t[t.LESS_THAN_SIGN=60]="LESS_THAN_SIGN",t[t.EQUALS_SIGN=61]="EQUALS_SIGN",t[t.GREATER_THAN_SIGN=62]="GREATER_THAN_SIGN",t[t.QUESTION_MARK=63]="QUESTION_MARK",t[t.LATIN_CAPITAL_A=65]="LATIN_CAPITAL_A",t[t.LATIN_CAPITAL_Z=90]="LATIN_CAPITAL_Z",t[t.RIGHT_SQUARE_BRACKET=93]="RIGHT_SQUARE_BRACKET",t[t.GRAVE_ACCENT=96]="GRAVE_ACCENT",t[t.LATIN_SMALL_A=97]="LATIN_SMALL_A",t[t.LATIN_SMALL_Z=122]="LATIN_SMALL_Z"})(y||(y={}));const Wt={DASH_DASH:"--",CDATA_START:"[CDATA[",DOCTYPE:"doctype",SCRIPT:"script",PUBLIC:"public",SYSTEM:"system"};function uw(t){return t>=55296&&t<=57343}function $M(t){return t>=56320&&t<=57343}function HM(t,e){return(t-55296)*1024+9216+e}function cw(t){return t!==32&&t!==10&&t!==13&&t!==9&&t!==12&&t>=1&&t<=31||t>=127&&t<=159}function lw(t){return t>=64976&&t<=65007||jM.has(t)}var F;(function(t){t.controlCharacterInInputStream="control-character-in-input-stream",t.noncharacterInInputStream="noncharacter-in-input-stream",t.surrogateInInputStream="surrogate-in-input-stream",t.nonVoidHtmlElementStartTagWithTrailingSolidus="non-void-html-element-start-tag-with-trailing-solidus",t.endTagWithAttributes="end-tag-with-attributes",t.endTagWithTrailingSolidus="end-tag-with-trailing-solidus",t.unexpectedSolidusInTag="unexpected-solidus-in-tag",t.unexpectedNullCharacter="unexpected-null-character",t.unexpectedQuestionMarkInsteadOfTagName="unexpected-question-mark-instead-of-tag-name",t.invalidFirstCharacterOfTagName="invalid-first-character-of-tag-name",t.unexpectedEqualsSignBeforeAttributeName="unexpected-equals-sign-before-attribute-name",t.missingEndTagName="missing-end-tag-name",t.unexpectedCharacterInAttributeName="unexpected-character-in-attribute-name",t.unknownNamedCharacterReference="unknown-named-character-reference",t.missingSemicolonAfterCharacterReference="missing-semicolon-after-character-reference",t.unexpectedCharacterAfterDoctypeSystemIdentifier="unexpected-character-after-doctype-system-identifier",t.unexpectedCharacterInUnquotedAttributeValue="unexpected-character-in-unquoted-attribute-value",t.eofBeforeTagName="eof-before-tag-name",t.eofInTag="eof-in-tag",t.missingAttributeValue="missing-attribute-value",t.missingWhitespaceBetweenAttributes="missing-whitespace-between-attributes",t.missingWhitespaceAfterDoctypePublicKeyword="missing-whitespace-after-doctype-public-keyword",t.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers="missing-whitespace-between-doctype-public-and-system-identifiers",t.missingWhitespaceAfterDoctypeSystemKeyword="missing-whitespace-after-doctype-system-keyword",t.missingQuoteBeforeDoctypePublicIdentifier="missing-quote-before-doctype-public-identifier",t.missingQuoteBeforeDoctypeSystemIdentifier="missing-quote-before-doctype-system-identifier",t.missingDoctypePublicIdentifier="missing-doctype-public-identifier",t.missingDoctypeSystemIdentifier="missing-doctype-system-identifier",t.abruptDoctypePublicIdentifier="abrupt-doctype-public-identifier",t.abruptDoctypeSystemIdentifier="abrupt-doctype-system-identifier",t.cdataInHtmlContent="cdata-in-html-content",t.incorrectlyOpenedComment="incorrectly-opened-comment",t.eofInScriptHtmlCommentLikeText="eof-in-script-html-comment-like-text",t.eofInDoctype="eof-in-doctype",t.nestedComment="nested-comment",t.abruptClosingOfEmptyComment="abrupt-closing-of-empty-comment",t.eofInComment="eof-in-comment",t.incorrectlyClosedComment="incorrectly-closed-comment",t.eofInCdata="eof-in-cdata",t.absenceOfDigitsInNumericCharacterReference="absence-of-digits-in-numeric-character-reference",t.nullCharacterReference="null-character-reference",t.surrogateCharacterReference="surrogate-character-reference",t.characterReferenceOutsideUnicodeRange="character-reference-outside-unicode-range",t.controlCharacterReference="control-character-reference",t.noncharacterCharacterReference="noncharacter-character-reference",t.missingWhitespaceBeforeDoctypeName="missing-whitespace-before-doctype-name",t.missingDoctypeName="missing-doctype-name",t.invalidCharacterSequenceAfterDoctypeName="invalid-character-sequence-after-doctype-name",t.duplicateAttribute="duplicate-attribute",t.nonConformingDoctype="non-conforming-doctype",t.missingDoctype="missing-doctype",t.misplacedDoctype="misplaced-doctype",t.endTagWithoutMatchingOpenElement="end-tag-without-matching-open-element",t.closingOfElementWithOpenChildElements="closing-of-element-with-open-child-elements",t.disallowedContentInNoscriptInHead="disallowed-content-in-noscript-in-head",t.openElementsLeftAfterEof="open-elements-left-after-eof",t.abandonedHeadElementChild="abandoned-head-element-child",t.misplacedStartTagForHeadElement="misplaced-start-tag-for-head-element",t.nestedNoscriptInHead="nested-noscript-in-head",t.eofInElementThatCanContainOnlyText="eof-in-element-that-can-contain-only-text"})(F||(F={}));const qM=65536;class VM{constructor(e){this.handler=e,this.html="",this.pos=-1,this.lastGapPos=-2,this.gapStack=[],this.skipNextNewLine=!1,this.lastChunkWritten=!1,this.endOfChunkHit=!1,this.bufferWaterline=qM,this.isEol=!1,this.lineStartPos=0,this.droppedBufferSize=0,this.line=1,this.lastErrOffset=-1}get col(){return this.pos-this.lineStartPos+ +(this.lastGapPos!==this.pos)}get offset(){return this.droppedBufferSize+this.pos}getError(e,n){const{line:r,col:s,offset:a}=this,i=s+n,o=a+n;return{code:e,startLine:r,endLine:r,startCol:i,endCol:i,startOffset:o,endOffset:o}}_err(e){this.handler.onParseError&&this.lastErrOffset!==this.offset&&(this.lastErrOffset=this.offset,this.handler.onParseError(this.getError(e,0)))}_addGap(){this.gapStack.push(this.lastGapPos),this.lastGapPos=this.pos}_processSurrogate(e){if(this.pos!==this.html.length-1){const n=this.html.charCodeAt(this.pos+1);if($M(n))return this.pos++,this._addGap(),HM(e,n)}else if(!this.lastChunkWritten)return this.endOfChunkHit=!0,y.EOF;return this._err(F.surrogateInInputStream),e}willDropParsedChunk(){return this.pos>this.bufferWaterline}dropParsedChunk(){this.willDropParsedChunk()&&(this.html=this.html.substring(this.pos),this.lineStartPos-=this.pos,this.droppedBufferSize+=this.pos,this.pos=0,this.lastGapPos=-2,this.gapStack.length=0)}write(e,n){this.html.length>0?this.html+=e:this.html=e,this.endOfChunkHit=!1,this.lastChunkWritten=n}insertHtmlAtCurrentPos(e){this.html=this.html.substring(0,this.pos+1)+e+this.html.substring(this.pos+1),this.endOfChunkHit=!1}startsWith(e,n){if(this.pos+e.length>this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,!1;if(n)return this.html.startsWith(e,this.pos);for(let r=0;r<e.length;r++)if((this.html.charCodeAt(this.pos+r)|32)!==e.charCodeAt(r))return!1;return!0}peek(e){const n=this.pos+e;if(n>=this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,y.EOF;const r=this.html.charCodeAt(n);return r===y.CARRIAGE_RETURN?y.LINE_FEED:r}advance(){if(this.pos++,this.isEol&&(this.isEol=!1,this.line++,this.lineStartPos=this.pos),this.pos>=this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,y.EOF;let e=this.html.charCodeAt(this.pos);return e===y.CARRIAGE_RETURN?(this.isEol=!0,this.skipNextNewLine=!0,y.LINE_FEED):e===y.LINE_FEED&&(this.isEol=!0,this.skipNextNewLine)?(this.line--,this.skipNextNewLine=!1,this._addGap(),this.advance()):(this.skipNextNewLine=!1,uw(e)&&(e=this._processSurrogate(e)),this.handler.onParseError===null||e>31&&e<127||e===y.LINE_FEED||e===y.CARRIAGE_RETURN||e>159&&e<64976||this._checkForProblematicCharacters(e),e)}_checkForProblematicCharacters(e){cw(e)?this._err(F.controlCharacterInInputStream):lw(e)&&this._err(F.noncharacterInInputStream)}retreat(e){for(this.pos-=e;this.pos<this.lastGapPos;)this.lastGapPos=this.gapStack.pop(),this.pos--;this.isEol=!1}}var Me;(function(t){t[t.CHARACTER=0]="CHARACTER",t[t.NULL_CHARACTER=1]="NULL_CHARACTER",t[t.WHITESPACE_CHARACTER=2]="WHITESPACE_CHARACTER",t[t.START_TAG=3]="START_TAG",t[t.END_TAG=4]="END_TAG",t[t.COMMENT=5]="COMMENT",t[t.DOCTYPE=6]="DOCTYPE",t[t.EOF=7]="EOF",t[t.HIBERNATION=8]="HIBERNATION"})(Me||(Me={}));function dw(t,e){for(let n=t.attrs.length-1;n>=0;n--)if(t.attrs[n].name===e)return t.attrs[n].value;return null}var W;(function(t){t.HTML="http://www.w3.org/1999/xhtml",t.MATHML="http://www.w3.org/1998/Math/MathML",t.SVG="http://www.w3.org/2000/svg",t.XLINK="http://www.w3.org/1999/xlink",t.XML="http://www.w3.org/XML/1998/namespace",t.XMLNS="http://www.w3.org/2000/xmlns/"})(W||(W={}));var ps;(function(t){t.TYPE="type",t.ACTION="action",t.ENCODING="encoding",t.PROMPT="prompt",t.NAME="name",t.COLOR="color",t.FACE="face",t.SIZE="size"})(ps||(ps={}));var ln;(function(t){t.NO_QUIRKS="no-quirks",t.QUIRKS="quirks",t.LIMITED_QUIRKS="limited-quirks"})(ln||(ln={}));var k;(function(t){t.A="a",t.ADDRESS="address",t.ANNOTATION_XML="annotation-xml",t.APPLET="applet",t.AREA="area",t.ARTICLE="article",t.ASIDE="aside",t.B="b",t.BASE="base",t.BASEFONT="basefont",t.BGSOUND="bgsound",t.BIG="big",t.BLOCKQUOTE="blockquote",t.BODY="body",t.BR="br",t.BUTTON="button",t.CAPTION="caption",t.CENTER="center",t.CODE="code",t.COL="col",t.COLGROUP="colgroup",t.DD="dd",t.DESC="desc",t.DETAILS="details",t.DIALOG="dialog",t.DIR="dir",t.DIV="div",t.DL="dl",t.DT="dt",t.EM="em",t.EMBED="embed",t.FIELDSET="fieldset",t.FIGCAPTION="figcaption",t.FIGURE="figure",t.FONT="font",t.FOOTER="footer",t.FOREIGN_OBJECT="foreignObject",t.FORM="form",t.FRAME="frame",t.FRAMESET="frameset",t.H1="h1",t.H2="h2",t.H3="h3",t.H4="h4",t.H5="h5",t.H6="h6",t.HEAD="head",t.HEADER="header",t.HGROUP="hgroup",t.HR="hr",t.HTML="html",t.I="i",t.IMG="img",t.IMAGE="image",t.INPUT="input",t.IFRAME="iframe",t.KEYGEN="keygen",t.LABEL="label",t.LI="li",t.LINK="link",t.LISTING="listing",t.MAIN="main",t.MALIGNMARK="malignmark",t.MARQUEE="marquee",t.MATH="math",t.MENU="menu",t.META="meta",t.MGLYPH="mglyph",t.MI="mi",t.MO="mo",t.MN="mn",t.MS="ms",t.MTEXT="mtext",t.NAV="nav",t.NOBR="nobr",t.NOFRAMES="noframes",t.NOEMBED="noembed",t.NOSCRIPT="noscript",t.OBJECT="object",t.OL="ol",t.OPTGROUP="optgroup",t.OPTION="option",t.P="p",t.PARAM="param",t.PLAINTEXT="plaintext",t.PRE="pre",t.RB="rb",t.RP="rp",t.RT="rt",t.RTC="rtc",t.RUBY="ruby",t.S="s",t.SCRIPT="script",t.SEARCH="search",t.SECTION="section",t.SELECT="select",t.SOURCE="source",t.SMALL="small",t.SPAN="span",t.STRIKE="strike",t.STRONG="strong",t.STYLE="style",t.SUB="sub",t.SUMMARY="summary",t.SUP="sup",t.TABLE="table",t.TBODY="tbody",t.TEMPLATE="template",t.TEXTAREA="textarea",t.TFOOT="tfoot",t.TD="td",t.TH="th",t.THEAD="thead",t.TITLE="title",t.TR="tr",t.TRACK="track",t.TT="tt",t.U="u",t.UL="ul",t.SVG="svg",t.VAR="var",t.WBR="wbr",t.XMP="xmp"})(k||(k={}));var h;(function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A=1]="A",t[t.ADDRESS=2]="ADDRESS",t[t.ANNOTATION_XML=3]="ANNOTATION_XML",t[t.APPLET=4]="APPLET",t[t.AREA=5]="AREA",t[t.ARTICLE=6]="ARTICLE",t[t.ASIDE=7]="ASIDE",t[t.B=8]="B",t[t.BASE=9]="BASE",t[t.BASEFONT=10]="BASEFONT",t[t.BGSOUND=11]="BGSOUND",t[t.BIG=12]="BIG",t[t.BLOCKQUOTE=13]="BLOCKQUOTE",t[t.BODY=14]="BODY",t[t.BR=15]="BR",t[t.BUTTON=16]="BUTTON",t[t.CAPTION=17]="CAPTION",t[t.CENTER=18]="CENTER",t[t.CODE=19]="CODE",t[t.COL=20]="COL",t[t.COLGROUP=21]="COLGROUP",t[t.DD=22]="DD",t[t.DESC=23]="DESC",t[t.DETAILS=24]="DETAILS",t[t.DIALOG=25]="DIALOG",t[t.DIR=26]="DIR",t[t.DIV=27]="DIV",t[t.DL=28]="DL",t[t.DT=29]="DT",t[t.EM=30]="EM",t[t.EMBED=31]="EMBED",t[t.FIELDSET=32]="FIELDSET",t[t.FIGCAPTION=33]="FIGCAPTION",t[t.FIGURE=34]="FIGURE",t[t.FONT=35]="FONT",t[t.FOOTER=36]="FOOTER",t[t.FOREIGN_OBJECT=37]="FOREIGN_OBJECT",t[t.FORM=38]="FORM",t[t.FRAME=39]="FRAME",t[t.FRAMESET=40]="FRAMESET",t[t.H1=41]="H1",t[t.H2=42]="H2",t[t.H3=43]="H3",t[t.H4=44]="H4",t[t.H5=45]="H5",t[t.H6=46]="H6",t[t.HEAD=47]="HEAD",t[t.HEADER=48]="HEADER",t[t.HGROUP=49]="HGROUP",t[t.HR=50]="HR",t[t.HTML=51]="HTML",t[t.I=52]="I",t[t.IMG=53]="IMG",t[t.IMAGE=54]="IMAGE",t[t.INPUT=55]="INPUT",t[t.IFRAME=56]="IFRAME",t[t.KEYGEN=57]="KEYGEN",t[t.LABEL=58]="LABEL",t[t.LI=59]="LI",t[t.LINK=60]="LINK",t[t.LISTING=61]="LISTING",t[t.MAIN=62]="MAIN",t[t.MALIGNMARK=63]="MALIGNMARK",t[t.MARQUEE=64]="MARQUEE",t[t.MATH=65]="MATH",t[t.MENU=66]="MENU",t[t.META=67]="META",t[t.MGLYPH=68]="MGLYPH",t[t.MI=69]="MI",t[t.MO=70]="MO",t[t.MN=71]="MN",t[t.MS=72]="MS",t[t.MTEXT=73]="MTEXT",t[t.NAV=74]="NAV",t[t.NOBR=75]="NOBR",t[t.NOFRAMES=76]="NOFRAMES",t[t.NOEMBED=77]="NOEMBED",t[t.NOSCRIPT=78]="NOSCRIPT",t[t.OBJECT=79]="OBJECT",t[t.OL=80]="OL",t[t.OPTGROUP=81]="OPTGROUP",t[t.OPTION=82]="OPTION",t[t.P=83]="P",t[t.PARAM=84]="PARAM",t[t.PLAINTEXT=85]="PLAINTEXT",t[t.PRE=86]="PRE",t[t.RB=87]="RB",t[t.RP=88]="RP",t[t.RT=89]="RT",t[t.RTC=90]="RTC",t[t.RUBY=91]="RUBY",t[t.S=92]="S",t[t.SCRIPT=93]="SCRIPT",t[t.SEARCH=94]="SEARCH",t[t.SECTION=95]="SECTION",t[t.SELECT=96]="SELECT",t[t.SOURCE=97]="SOURCE",t[t.SMALL=98]="SMALL",t[t.SPAN=99]="SPAN",t[t.STRIKE=100]="STRIKE",t[t.STRONG=101]="STRONG",t[t.STYLE=102]="STYLE",t[t.SUB=103]="SUB",t[t.SUMMARY=104]="SUMMARY",t[t.SUP=105]="SUP",t[t.TABLE=106]="TABLE",t[t.TBODY=107]="TBODY",t[t.TEMPLATE=108]="TEMPLATE",t[t.TEXTAREA=109]="TEXTAREA",t[t.TFOOT=110]="TFOOT",t[t.TD=111]="TD",t[t.TH=112]="TH",t[t.THEAD=113]="THEAD",t[t.TITLE=114]="TITLE",t[t.TR=115]="TR",t[t.TRACK=116]="TRACK",t[t.TT=117]="TT",t[t.U=118]="U",t[t.UL=119]="UL",t[t.SVG=120]="SVG",t[t.VAR=121]="VAR",t[t.WBR=122]="WBR",t[t.XMP=123]="XMP"})(h||(h={}));const zM=new Map([[k.A,h.A],[k.ADDRESS,h.ADDRESS],[k.ANNOTATION_XML,h.ANNOTATION_XML],[k.APPLET,h.APPLET],[k.AREA,h.AREA],[k.ARTICLE,h.ARTICLE],[k.ASIDE,h.ASIDE],[k.B,h.B],[k.BASE,h.BASE],[k.BASEFONT,h.BASEFONT],[k.BGSOUND,h.BGSOUND],[k.BIG,h.BIG],[k.BLOCKQUOTE,h.BLOCKQUOTE],[k.BODY,h.BODY],[k.BR,h.BR],[k.BUTTON,h.BUTTON],[k.CAPTION,h.CAPTION],[k.CENTER,h.CENTER],[k.CODE,h.CODE],[k.COL,h.COL],[k.COLGROUP,h.COLGROUP],[k.DD,h.DD],[k.DESC,h.DESC],[k.DETAILS,h.DETAILS],[k.DIALOG,h.DIALOG],[k.DIR,h.DIR],[k.DIV,h.DIV],[k.DL,h.DL],[k.DT,h.DT],[k.EM,h.EM],[k.EMBED,h.EMBED],[k.FIELDSET,h.FIELDSET],[k.FIGCAPTION,h.FIGCAPTION],[k.FIGURE,h.FIGURE],[k.FONT,h.FONT],[k.FOOTER,h.FOOTER],[k.FOREIGN_OBJECT,h.FOREIGN_OBJECT],[k.FORM,h.FORM],[k.FRAME,h.FRAME],[k.FRAMESET,h.FRAMESET],[k.H1,h.H1],[k.H2,h.H2],[k.H3,h.H3],[k.H4,h.H4],[k.H5,h.H5],[k.H6,h.H6],[k.HEAD,h.HEAD],[k.HEADER,h.HEADER],[k.HGROUP,h.HGROUP],[k.HR,h.HR],[k.HTML,h.HTML],[k.I,h.I],[k.IMG,h.IMG],[k.IMAGE,h.IMAGE],[k.INPUT,h.INPUT],[k.IFRAME,h.IFRAME],[k.KEYGEN,h.KEYGEN],[k.LABEL,h.LABEL],[k.LI,h.LI],[k.LINK,h.LINK],[k.LISTING,h.LISTING],[k.MAIN,h.MAIN],[k.MALIGNMARK,h.MALIGNMARK],[k.MARQUEE,h.MARQUEE],[k.MATH,h.MATH],[k.MENU,h.MENU],[k.META,h.META],[k.MGLYPH,h.MGLYPH],[k.MI,h.MI],[k.MO,h.MO],[k.MN,h.MN],[k.MS,h.MS],[k.MTEXT,h.MTEXT],[k.NAV,h.NAV],[k.NOBR,h.NOBR],[k.NOFRAMES,h.NOFRAMES],[k.NOEMBED,h.NOEMBED],[k.NOSCRIPT,h.NOSCRIPT],[k.OBJECT,h.OBJECT],[k.OL,h.OL],[k.OPTGROUP,h.OPTGROUP],[k.OPTION,h.OPTION],[k.P,h.P],[k.PARAM,h.PARAM],[k.PLAINTEXT,h.PLAINTEXT],[k.PRE,h.PRE],[k.RB,h.RB],[k.RP,h.RP],[k.RT,h.RT],[k.RTC,h.RTC],[k.RUBY,h.RUBY],[k.S,h.S],[k.SCRIPT,h.SCRIPT],[k.SEARCH,h.SEARCH],[k.SECTION,h.SECTION],[k.SELECT,h.SELECT],[k.SOURCE,h.SOURCE],[k.SMALL,h.SMALL],[k.SPAN,h.SPAN],[k.STRIKE,h.STRIKE],[k.STRONG,h.STRONG],[k.STYLE,h.STYLE],[k.SUB,h.SUB],[k.SUMMARY,h.SUMMARY],[k.SUP,h.SUP],[k.TABLE,h.TABLE],[k.TBODY,h.TBODY],[k.TEMPLATE,h.TEMPLATE],[k.TEXTAREA,h.TEXTAREA],[k.TFOOT,h.TFOOT],[k.TD,h.TD],[k.TH,h.TH],[k.THEAD,h.THEAD],[k.TITLE,h.TITLE],[k.TR,h.TR],[k.TRACK,h.TRACK],[k.TT,h.TT],[k.U,h.U],[k.UL,h.UL],[k.SVG,h.SVG],[k.VAR,h.VAR],[k.WBR,h.WBR],[k.XMP,h.XMP]]);function cl(t){var e;return(e=zM.get(t))!==null&&e!==void 0?e:h.UNKNOWN}const Z=h,WM={[W.HTML]:new Set([Z.ADDRESS,Z.APPLET,Z.AREA,Z.ARTICLE,Z.ASIDE,Z.BASE,Z.BASEFONT,Z.BGSOUND,Z.BLOCKQUOTE,Z.BODY,Z.BR,Z.BUTTON,Z.CAPTION,Z.CENTER,Z.COL,Z.COLGROUP,Z.DD,Z.DETAILS,Z.DIR,Z.DIV,Z.DL,Z.DT,Z.EMBED,Z.FIELDSET,Z.FIGCAPTION,Z.FIGURE,Z.FOOTER,Z.FORM,Z.FRAME,Z.FRAMESET,Z.H1,Z.H2,Z.H3,Z.H4,Z.H5,Z.H6,Z.HEAD,Z.HEADER,Z.HGROUP,Z.HR,Z.HTML,Z.IFRAME,Z.IMG,Z.INPUT,Z.LI,Z.LINK,Z.LISTING,Z.MAIN,Z.MARQUEE,Z.MENU,Z.META,Z.NAV,Z.NOEMBED,Z.NOFRAMES,Z.NOSCRIPT,Z.OBJECT,Z.OL,Z.P,Z.PARAM,Z.PLAINTEXT,Z.PRE,Z.SCRIPT,Z.SECTION,Z.SELECT,Z.SOURCE,Z.STYLE,Z.SUMMARY,Z.TABLE,Z.TBODY,Z.TD,Z.TEMPLATE,Z.TEXTAREA,Z.TFOOT,Z.TH,Z.THEAD,Z.TITLE,Z.TR,Z.TRACK,Z.UL,Z.WBR,Z.XMP]),[W.MATHML]:new Set([Z.MI,Z.MO,Z.MN,Z.MS,Z.MTEXT,Z.ANNOTATION_XML]),[W.SVG]:new Set([Z.TITLE,Z.FOREIGN_OBJECT,Z.DESC]),[W.XLINK]:new Set,[W.XML]:new Set,[W.XMLNS]:new Set},Vh=new Set([Z.H1,Z.H2,Z.H3,Z.H4,Z.H5,Z.H6]),GM=new Set([k.STYLE,k.SCRIPT,k.XMP,k.IFRAME,k.NOEMBED,k.NOFRAMES,k.PLAINTEXT]);function KM(t,e){return GM.has(t)||e&&t===k.NOSCRIPT}var w;(function(t){t[t.DATA=0]="DATA",t[t.RCDATA=1]="RCDATA",t[t.RAWTEXT=2]="RAWTEXT",t[t.SCRIPT_DATA=3]="SCRIPT_DATA",t[t.PLAINTEXT=4]="PLAINTEXT",t[t.TAG_OPEN=5]="TAG_OPEN",t[t.END_TAG_OPEN=6]="END_TAG_OPEN",t[t.TAG_NAME=7]="TAG_NAME",t[t.RCDATA_LESS_THAN_SIGN=8]="RCDATA_LESS_THAN_SIGN",t[t.RCDATA_END_TAG_OPEN=9]="RCDATA_END_TAG_OPEN",t[t.RCDATA_END_TAG_NAME=10]="RCDATA_END_TAG_NAME",t[t.RAWTEXT_LESS_THAN_SIGN=11]="RAWTEXT_LESS_THAN_SIGN",t[t.RAWTEXT_END_TAG_OPEN=12]="RAWTEXT_END_TAG_OPEN",t[t.RAWTEXT_END_TAG_NAME=13]="RAWTEXT_END_TAG_NAME",t[t.SCRIPT_DATA_LESS_THAN_SIGN=14]="SCRIPT_DATA_LESS_THAN_SIGN",t[t.SCRIPT_DATA_END_TAG_OPEN=15]="SCRIPT_DATA_END_TAG_OPEN",t[t.SCRIPT_DATA_END_TAG_NAME=16]="SCRIPT_DATA_END_TAG_NAME",t[t.SCRIPT_DATA_ESCAPE_START=17]="SCRIPT_DATA_ESCAPE_START",t[t.SCRIPT_DATA_ESCAPE_START_DASH=18]="SCRIPT_DATA_ESCAPE_START_DASH",t[t.SCRIPT_DATA_ESCAPED=19]="SCRIPT_DATA_ESCAPED",t[t.SCRIPT_DATA_ESCAPED_DASH=20]="SCRIPT_DATA_ESCAPED_DASH",t[t.SCRIPT_DATA_ESCAPED_DASH_DASH=21]="SCRIPT_DATA_ESCAPED_DASH_DASH",t[t.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN=22]="SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN",t[t.SCRIPT_DATA_ESCAPED_END_TAG_OPEN=23]="SCRIPT_DATA_ESCAPED_END_TAG_OPEN",t[t.SCRIPT_DATA_ESCAPED_END_TAG_NAME=24]="SCRIPT_DATA_ESCAPED_END_TAG_NAME",t[t.SCRIPT_DATA_DOUBLE_ESCAPE_START=25]="SCRIPT_DATA_DOUBLE_ESCAPE_START",t[t.SCRIPT_DATA_DOUBLE_ESCAPED=26]="SCRIPT_DATA_DOUBLE_ESCAPED",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_DASH=27]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH=28]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN=29]="SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN",t[t.SCRIPT_DATA_DOUBLE_ESCAPE_END=30]="SCRIPT_DATA_DOUBLE_ESCAPE_END",t[t.BEFORE_ATTRIBUTE_NAME=31]="BEFORE_ATTRIBUTE_NAME",t[t.ATTRIBUTE_NAME=32]="ATTRIBUTE_NAME",t[t.AFTER_ATTRIBUTE_NAME=33]="AFTER_ATTRIBUTE_NAME",t[t.BEFORE_ATTRIBUTE_VALUE=34]="BEFORE_ATTRIBUTE_VALUE",t[t.ATTRIBUTE_VALUE_DOUBLE_QUOTED=35]="ATTRIBUTE_VALUE_DOUBLE_QUOTED",t[t.ATTRIBUTE_VALUE_SINGLE_QUOTED=36]="ATTRIBUTE_VALUE_SINGLE_QUOTED",t[t.ATTRIBUTE_VALUE_UNQUOTED=37]="ATTRIBUTE_VALUE_UNQUOTED",t[t.AFTER_ATTRIBUTE_VALUE_QUOTED=38]="AFTER_ATTRIBUTE_VALUE_QUOTED",t[t.SELF_CLOSING_START_TAG=39]="SELF_CLOSING_START_TAG",t[t.BOGUS_COMMENT=40]="BOGUS_COMMENT",t[t.MARKUP_DECLARATION_OPEN=41]="MARKUP_DECLARATION_OPEN",t[t.COMMENT_START=42]="COMMENT_START",t[t.COMMENT_START_DASH=43]="COMMENT_START_DASH",t[t.COMMENT=44]="COMMENT",t[t.COMMENT_LESS_THAN_SIGN=45]="COMMENT_LESS_THAN_SIGN",t[t.COMMENT_LESS_THAN_SIGN_BANG=46]="COMMENT_LESS_THAN_SIGN_BANG",t[t.COMMENT_LESS_THAN_SIGN_BANG_DASH=47]="COMMENT_LESS_THAN_SIGN_BANG_DASH",t[t.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH=48]="COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH",t[t.COMMENT_END_DASH=49]="COMMENT_END_DASH",t[t.COMMENT_END=50]="COMMENT_END",t[t.COMMENT_END_BANG=51]="COMMENT_END_BANG",t[t.DOCTYPE=52]="DOCTYPE",t[t.BEFORE_DOCTYPE_NAME=53]="BEFORE_DOCTYPE_NAME",t[t.DOCTYPE_NAME=54]="DOCTYPE_NAME",t[t.AFTER_DOCTYPE_NAME=55]="AFTER_DOCTYPE_NAME",t[t.AFTER_DOCTYPE_PUBLIC_KEYWORD=56]="AFTER_DOCTYPE_PUBLIC_KEYWORD",t[t.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER=57]="BEFORE_DOCTYPE_PUBLIC_IDENTIFIER",t[t.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED=58]="DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED",t[t.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED=59]="DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED",t[t.AFTER_DOCTYPE_PUBLIC_IDENTIFIER=60]="AFTER_DOCTYPE_PUBLIC_IDENTIFIER",t[t.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS=61]="BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS",t[t.AFTER_DOCTYPE_SYSTEM_KEYWORD=62]="AFTER_DOCTYPE_SYSTEM_KEYWORD",t[t.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER=63]="BEFORE_DOCTYPE_SYSTEM_IDENTIFIER",t[t.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED=64]="DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED",t[t.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED=65]="DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED",t[t.AFTER_DOCTYPE_SYSTEM_IDENTIFIER=66]="AFTER_DOCTYPE_SYSTEM_IDENTIFIER",t[t.BOGUS_DOCTYPE=67]="BOGUS_DOCTYPE",t[t.CDATA_SECTION=68]="CDATA_SECTION",t[t.CDATA_SECTION_BRACKET=69]="CDATA_SECTION_BRACKET",t[t.CDATA_SECTION_END=70]="CDATA_SECTION_END",t[t.CHARACTER_REFERENCE=71]="CHARACTER_REFERENCE",t[t.AMBIGUOUS_AMPERSAND=72]="AMBIGUOUS_AMPERSAND"})(w||(w={}));const Jt={DATA:w.DATA,RCDATA:w.RCDATA,RAWTEXT:w.RAWTEXT,SCRIPT_DATA:w.SCRIPT_DATA,PLAINTEXT:w.PLAINTEXT,CDATA_SECTION:w.CDATA_SECTION};function YM(t){return t>=y.DIGIT_0&&t<=y.DIGIT_9}function si(t){return t>=y.LATIN_CAPITAL_A&&t<=y.LATIN_CAPITAL_Z}function ZM(t){return t>=y.LATIN_SMALL_A&&t<=y.LATIN_SMALL_Z}function Dr(t){return ZM(t)||si(t)}function I0(t){return Dr(t)||YM(t)}function uu(t){return t+32}function hw(t){return t===y.SPACE||t===y.LINE_FEED||t===y.TABULATION||t===y.FORM_FEED}function N0(t){return hw(t)||t===y.SOLIDUS||t===y.GREATER_THAN_SIGN}function JM(t){return t===y.NULL?F.nullCharacterReference:t>1114111?F.characterReferenceOutsideUnicodeRange:uw(t)?F.surrogateCharacterReference:lw(t)?F.noncharacterCharacterReference:cw(t)||t===y.CARRIAGE_RETURN?F.controlCharacterReference:null}let XM=class{constructor(e,n){this.options=e,this.handler=n,this.paused=!1,this.inLoop=!1,this.inForeignNode=!1,this.lastStartTagName="",this.active=!1,this.state=w.DATA,this.returnState=w.DATA,this.entityStartPos=0,this.consumedAfterSnapshot=-1,this.currentCharacterToken=null,this.currentToken=null,this.currentAttr={name:"",value:""},this.preprocessor=new VM(n),this.currentLocation=this.getCurrentLocation(-1),this.entityDecoder=new dm(lm,(r,s)=>{this.preprocessor.pos=this.entityStartPos+s-1,this._flushCodePointConsumedAsCharacterReference(r)},n.onParseError?{missingSemicolonAfterCharacterReference:()=>{this._err(F.missingSemicolonAfterCharacterReference,1)},absenceOfDigitsInNumericCharacterReference:r=>{this._err(F.absenceOfDigitsInNumericCharacterReference,this.entityStartPos-this.preprocessor.pos+r)},validateNumericCharacterReference:r=>{const s=JM(r);s&&this._err(s,1)}}:void 0)}_err(e,n=0){var r,s;(s=(r=this.handler).onParseError)===null||s===void 0||s.call(r,this.preprocessor.getError(e,n))}getCurrentLocation(e){return this.options.sourceCodeLocationInfo?{startLine:this.preprocessor.line,startCol:this.preprocessor.col-e,startOffset:this.preprocessor.offset-e,endLine:-1,endCol:-1,endOffset:-1}:null}_runParsingLoop(){if(!this.inLoop){for(this.inLoop=!0;this.active&&!this.paused;){this.consumedAfterSnapshot=0;const e=this._consume();this._ensureHibernation()||this._callState(e)}this.inLoop=!1}}pause(){this.paused=!0}resume(e){if(!this.paused)throw new Error("Parser was already resumed");this.paused=!1,!this.inLoop&&(this._runParsingLoop(),this.paused||e==null||e())}write(e,n,r){this.active=!0,this.preprocessor.write(e,n),this._runParsingLoop(),this.paused||r==null||r()}insertHtmlAtCurrentPos(e){this.active=!0,this.preprocessor.insertHtmlAtCurrentPos(e),this._runParsingLoop()}_ensureHibernation(){return this.preprocessor.endOfChunkHit?(this.preprocessor.retreat(this.consumedAfterSnapshot),this.consumedAfterSnapshot=0,this.active=!1,!0):!1}_consume(){return this.consumedAfterSnapshot++,this.preprocessor.advance()}_advanceBy(e){this.consumedAfterSnapshot+=e;for(let n=0;n<e;n++)this.preprocessor.advance()}_consumeSequenceIfMatch(e,n){return this.preprocessor.startsWith(e,n)?(this._advanceBy(e.length-1),!0):!1}_createStartTagToken(){this.currentToken={type:Me.START_TAG,tagName:"",tagID:h.UNKNOWN,selfClosing:!1,ackSelfClosing:!1,attrs:[],location:this.getCurrentLocation(1)}}_createEndTagToken(){this.currentToken={type:Me.END_TAG,tagName:"",tagID:h.UNKNOWN,selfClosing:!1,ackSelfClosing:!1,attrs:[],location:this.getCurrentLocation(2)}}_createCommentToken(e){this.currentToken={type:Me.COMMENT,data:"",location:this.getCurrentLocation(e)}}_createDoctypeToken(e){this.currentToken={type:Me.DOCTYPE,name:e,forceQuirks:!1,publicId:null,systemId:null,location:this.currentLocation}}_createCharacterToken(e,n){this.currentCharacterToken={type:e,chars:n,location:this.currentLocation}}_createAttr(e){this.currentAttr={name:e,value:""},this.currentLocation=this.getCurrentLocation(0)}_leaveAttrName(){var e,n;const r=this.currentToken;if(dw(r,this.currentAttr.name)===null){if(r.attrs.push(this.currentAttr),r.location&&this.currentLocation){const s=(e=(n=r.location).attrs)!==null&&e!==void 0?e:n.attrs=Object.create(null);s[this.currentAttr.name]=this.currentLocation,this._leaveAttrValue()}}else this._err(F.duplicateAttribute)}_leaveAttrValue(){this.currentLocation&&(this.currentLocation.endLine=this.preprocessor.line,this.currentLocation.endCol=this.preprocessor.col,this.currentLocation.endOffset=this.preprocessor.offset)}prepareToken(e){this._emitCurrentCharacterToken(e.location),this.currentToken=null,e.location&&(e.location.endLine=this.preprocessor.line,e.location.endCol=this.preprocessor.col+1,e.location.endOffset=this.preprocessor.offset+1),this.currentLocation=this.getCurrentLocation(-1)}emitCurrentTagToken(){const e=this.currentToken;this.prepareToken(e),e.tagID=cl(e.tagName),e.type===Me.START_TAG?(this.lastStartTagName=e.tagName,this.handler.onStartTag(e)):(e.attrs.length>0&&this._err(F.endTagWithAttributes),e.selfClosing&&this._err(F.endTagWithTrailingSolidus),this.handler.onEndTag(e)),this.preprocessor.dropParsedChunk()}emitCurrentComment(e){this.prepareToken(e),this.handler.onComment(e),this.preprocessor.dropParsedChunk()}emitCurrentDoctype(e){this.prepareToken(e),this.handler.onDoctype(e),this.preprocessor.dropParsedChunk()}_emitCurrentCharacterToken(e){if(this.currentCharacterToken){switch(e&&this.currentCharacterToken.location&&(this.currentCharacterToken.location.endLine=e.startLine,this.currentCharacterToken.location.endCol=e.startCol,this.currentCharacterToken.location.endOffset=e.startOffset),this.currentCharacterToken.type){case Me.CHARACTER:{this.handler.onCharacter(this.currentCharacterToken);break}case Me.NULL_CHARACTER:{this.handler.onNullCharacter(this.currentCharacterToken);break}case Me.WHITESPACE_CHARACTER:{this.handler.onWhitespaceCharacter(this.currentCharacterToken);break}}this.currentCharacterToken=null}}_emitEOFToken(){const e=this.getCurrentLocation(0);e&&(e.endLine=e.startLine,e.endCol=e.startCol,e.endOffset=e.startOffset),this._emitCurrentCharacterToken(e),this.handler.onEof({type:Me.EOF,location:e}),this.active=!1}_appendCharToCurrentCharacterToken(e,n){if(this.currentCharacterToken)if(this.currentCharacterToken.type===e){this.currentCharacterToken.chars+=n;return}else this.currentLocation=this.getCurrentLocation(0),this._emitCurrentCharacterToken(this.currentLocation),this.preprocessor.dropParsedChunk();this._createCharacterToken(e,n)}_emitCodePoint(e){const n=hw(e)?Me.WHITESPACE_CHARACTER:e===y.NULL?Me.NULL_CHARACTER:Me.CHARACTER;this._appendCharToCurrentCharacterToken(n,String.fromCodePoint(e))}_emitChars(e){this._appendCharToCurrentCharacterToken(Me.CHARACTER,e)}_startCharacterReference(){this.returnState=this.state,this.state=w.CHARACTER_REFERENCE,this.entityStartPos=this.preprocessor.pos,this.entityDecoder.startEntity(this._isCharacterReferenceInAttribute()?Sn.Attribute:Sn.Legacy)}_isCharacterReferenceInAttribute(){return this.returnState===w.ATTRIBUTE_VALUE_DOUBLE_QUOTED||this.returnState===w.ATTRIBUTE_VALUE_SINGLE_QUOTED||this.returnState===w.ATTRIBUTE_VALUE_UNQUOTED}_flushCodePointConsumedAsCharacterReference(e){this._isCharacterReferenceInAttribute()?this.currentAttr.value+=String.fromCodePoint(e):this._emitCodePoint(e)}_callState(e){switch(this.state){case w.DATA:{this._stateData(e);break}case w.RCDATA:{this._stateRcdata(e);break}case w.RAWTEXT:{this._stateRawtext(e);break}case w.SCRIPT_DATA:{this._stateScriptData(e);break}case w.PLAINTEXT:{this._statePlaintext(e);break}case w.TAG_OPEN:{this._stateTagOpen(e);break}case w.END_TAG_OPEN:{this._stateEndTagOpen(e);break}case w.TAG_NAME:{this._stateTagName(e);break}case w.RCDATA_LESS_THAN_SIGN:{this._stateRcdataLessThanSign(e);break}case w.RCDATA_END_TAG_OPEN:{this._stateRcdataEndTagOpen(e);break}case w.RCDATA_END_TAG_NAME:{this._stateRcdataEndTagName(e);break}case w.RAWTEXT_LESS_THAN_SIGN:{this._stateRawtextLessThanSign(e);break}case w.RAWTEXT_END_TAG_OPEN:{this._stateRawtextEndTagOpen(e);break}case w.RAWTEXT_END_TAG_NAME:{this._stateRawtextEndTagName(e);break}case w.SCRIPT_DATA_LESS_THAN_SIGN:{this._stateScriptDataLessThanSign(e);break}case w.SCRIPT_DATA_END_TAG_OPEN:{this._stateScriptDataEndTagOpen(e);break}case w.SCRIPT_DATA_END_TAG_NAME:{this._stateScriptDataEndTagName(e);break}case w.SCRIPT_DATA_ESCAPE_START:{this._stateScriptDataEscapeStart(e);break}case w.SCRIPT_DATA_ESCAPE_START_DASH:{this._stateScriptDataEscapeStartDash(e);break}case w.SCRIPT_DATA_ESCAPED:{this._stateScriptDataEscaped(e);break}case w.SCRIPT_DATA_ESCAPED_DASH:{this._stateScriptDataEscapedDash(e);break}case w.SCRIPT_DATA_ESCAPED_DASH_DASH:{this._stateScriptDataEscapedDashDash(e);break}case w.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN:{this._stateScriptDataEscapedLessThanSign(e);break}case w.SCRIPT_DATA_ESCAPED_END_TAG_OPEN:{this._stateScriptDataEscapedEndTagOpen(e);break}case w.SCRIPT_DATA_ESCAPED_END_TAG_NAME:{this._stateScriptDataEscapedEndTagName(e);break}case w.SCRIPT_DATA_DOUBLE_ESCAPE_START:{this._stateScriptDataDoubleEscapeStart(e);break}case w.SCRIPT_DATA_DOUBLE_ESCAPED:{this._stateScriptDataDoubleEscaped(e);break}case w.SCRIPT_DATA_DOUBLE_ESCAPED_DASH:{this._stateScriptDataDoubleEscapedDash(e);break}case w.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH:{this._stateScriptDataDoubleEscapedDashDash(e);break}case w.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN:{this._stateScriptDataDoubleEscapedLessThanSign(e);break}case w.SCRIPT_DATA_DOUBLE_ESCAPE_END:{this._stateScriptDataDoubleEscapeEnd(e);break}case w.BEFORE_ATTRIBUTE_NAME:{this._stateBeforeAttributeName(e);break}case w.ATTRIBUTE_NAME:{this._stateAttributeName(e);break}case w.AFTER_ATTRIBUTE_NAME:{this._stateAfterAttributeName(e);break}case w.BEFORE_ATTRIBUTE_VALUE:{this._stateBeforeAttributeValue(e);break}case w.ATTRIBUTE_VALUE_DOUBLE_QUOTED:{this._stateAttributeValueDoubleQuoted(e);break}case w.ATTRIBUTE_VALUE_SINGLE_QUOTED:{this._stateAttributeValueSingleQuoted(e);break}case w.ATTRIBUTE_VALUE_UNQUOTED:{this._stateAttributeValueUnquoted(e);break}case w.AFTER_ATTRIBUTE_VALUE_QUOTED:{this._stateAfterAttributeValueQuoted(e);break}case w.SELF_CLOSING_START_TAG:{this._stateSelfClosingStartTag(e);break}case w.BOGUS_COMMENT:{this._stateBogusComment(e);break}case w.MARKUP_DECLARATION_OPEN:{this._stateMarkupDeclarationOpen(e);break}case w.COMMENT_START:{this._stateCommentStart(e);break}case w.COMMENT_START_DASH:{this._stateCommentStartDash(e);break}case w.COMMENT:{this._stateComment(e);break}case w.COMMENT_LESS_THAN_SIGN:{this._stateCommentLessThanSign(e);break}case w.COMMENT_LESS_THAN_SIGN_BANG:{this._stateCommentLessThanSignBang(e);break}case w.COMMENT_LESS_THAN_SIGN_BANG_DASH:{this._stateCommentLessThanSignBangDash(e);break}case w.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH:{this._stateCommentLessThanSignBangDashDash(e);break}case w.COMMENT_END_DASH:{this._stateCommentEndDash(e);break}case w.COMMENT_END:{this._stateCommentEnd(e);break}case w.COMMENT_END_BANG:{this._stateCommentEndBang(e);break}case w.DOCTYPE:{this._stateDoctype(e);break}case w.BEFORE_DOCTYPE_NAME:{this._stateBeforeDoctypeName(e);break}case w.DOCTYPE_NAME:{this._stateDoctypeName(e);break}case w.AFTER_DOCTYPE_NAME:{this._stateAfterDoctypeName(e);break}case w.AFTER_DOCTYPE_PUBLIC_KEYWORD:{this._stateAfterDoctypePublicKeyword(e);break}case w.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER:{this._stateBeforeDoctypePublicIdentifier(e);break}case w.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED:{this._stateDoctypePublicIdentifierDoubleQuoted(e);break}case w.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED:{this._stateDoctypePublicIdentifierSingleQuoted(e);break}case w.AFTER_DOCTYPE_PUBLIC_IDENTIFIER:{this._stateAfterDoctypePublicIdentifier(e);break}case w.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS:{this._stateBetweenDoctypePublicAndSystemIdentifiers(e);break}case w.AFTER_DOCTYPE_SYSTEM_KEYWORD:{this._stateAfterDoctypeSystemKeyword(e);break}case w.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER:{this._stateBeforeDoctypeSystemIdentifier(e);break}case w.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED:{this._stateDoctypeSystemIdentifierDoubleQuoted(e);break}case w.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED:{this._stateDoctypeSystemIdentifierSingleQuoted(e);break}case w.AFTER_DOCTYPE_SYSTEM_IDENTIFIER:{this._stateAfterDoctypeSystemIdentifier(e);break}case w.BOGUS_DOCTYPE:{this._stateBogusDoctype(e);break}case w.CDATA_SECTION:{this._stateCdataSection(e);break}case w.CDATA_SECTION_BRACKET:{this._stateCdataSectionBracket(e);break}case w.CDATA_SECTION_END:{this._stateCdataSectionEnd(e);break}case w.CHARACTER_REFERENCE:{this._stateCharacterReference();break}case w.AMBIGUOUS_AMPERSAND:{this._stateAmbiguousAmpersand(e);break}default:throw new Error("Unknown state")}}_stateData(e){switch(e){case y.LESS_THAN_SIGN:{this.state=w.TAG_OPEN;break}case y.AMPERSAND:{this._startCharacterReference();break}case y.NULL:{this._err(F.unexpectedNullCharacter),this._emitCodePoint(e);break}case y.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateRcdata(e){switch(e){case y.AMPERSAND:{this._startCharacterReference();break}case y.LESS_THAN_SIGN:{this.state=w.RCDATA_LESS_THAN_SIGN;break}case y.NULL:{this._err(F.unexpectedNullCharacter),this._emitChars(Qe);break}case y.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateRawtext(e){switch(e){case y.LESS_THAN_SIGN:{this.state=w.RAWTEXT_LESS_THAN_SIGN;break}case y.NULL:{this._err(F.unexpectedNullCharacter),this._emitChars(Qe);break}case y.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptData(e){switch(e){case y.LESS_THAN_SIGN:{this.state=w.SCRIPT_DATA_LESS_THAN_SIGN;break}case y.NULL:{this._err(F.unexpectedNullCharacter),this._emitChars(Qe);break}case y.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_statePlaintext(e){switch(e){case y.NULL:{this._err(F.unexpectedNullCharacter),this._emitChars(Qe);break}case y.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateTagOpen(e){if(Dr(e))this._createStartTagToken(),this.state=w.TAG_NAME,this._stateTagName(e);else switch(e){case y.EXCLAMATION_MARK:{this.state=w.MARKUP_DECLARATION_OPEN;break}case y.SOLIDUS:{this.state=w.END_TAG_OPEN;break}case y.QUESTION_MARK:{this._err(F.unexpectedQuestionMarkInsteadOfTagName),this._createCommentToken(1),this.state=w.BOGUS_COMMENT,this._stateBogusComment(e);break}case y.EOF:{this._err(F.eofBeforeTagName),this._emitChars("<"),this._emitEOFToken();break}default:this._err(F.invalidFirstCharacterOfTagName),this._emitChars("<"),this.state=w.DATA,this._stateData(e)}}_stateEndTagOpen(e){if(Dr(e))this._createEndTagToken(),this.state=w.TAG_NAME,this._stateTagName(e);else switch(e){case y.GREATER_THAN_SIGN:{this._err(F.missingEndTagName),this.state=w.DATA;break}case y.EOF:{this._err(F.eofBeforeTagName),this._emitChars("</"),this._emitEOFToken();break}default:this._err(F.invalidFirstCharacterOfTagName),this._createCommentToken(2),this.state=w.BOGUS_COMMENT,this._stateBogusComment(e)}}_stateTagName(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this.state=w.BEFORE_ATTRIBUTE_NAME;break}case y.SOLIDUS:{this.state=w.SELF_CLOSING_START_TAG;break}case y.GREATER_THAN_SIGN:{this.state=w.DATA,this.emitCurrentTagToken();break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.tagName+=Qe;break}case y.EOF:{this._err(F.eofInTag),this._emitEOFToken();break}default:n.tagName+=String.fromCodePoint(si(e)?uu(e):e)}}_stateRcdataLessThanSign(e){e===y.SOLIDUS?this.state=w.RCDATA_END_TAG_OPEN:(this._emitChars("<"),this.state=w.RCDATA,this._stateRcdata(e))}_stateRcdataEndTagOpen(e){Dr(e)?(this.state=w.RCDATA_END_TAG_NAME,this._stateRcdataEndTagName(e)):(this._emitChars("</"),this.state=w.RCDATA,this._stateRcdata(e))}handleSpecialEndTag(e){if(!this.preprocessor.startsWith(this.lastStartTagName,!1))return!this._ensureHibernation();this._createEndTagToken();const n=this.currentToken;switch(n.tagName=this.lastStartTagName,this.preprocessor.peek(this.lastStartTagName.length)){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:return this._advanceBy(this.lastStartTagName.length),this.state=w.BEFORE_ATTRIBUTE_NAME,!1;case y.SOLIDUS:return this._advanceBy(this.lastStartTagName.length),this.state=w.SELF_CLOSING_START_TAG,!1;case y.GREATER_THAN_SIGN:return this._advanceBy(this.lastStartTagName.length),this.emitCurrentTagToken(),this.state=w.DATA,!1;default:return!this._ensureHibernation()}}_stateRcdataEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=w.RCDATA,this._stateRcdata(e))}_stateRawtextLessThanSign(e){e===y.SOLIDUS?this.state=w.RAWTEXT_END_TAG_OPEN:(this._emitChars("<"),this.state=w.RAWTEXT,this._stateRawtext(e))}_stateRawtextEndTagOpen(e){Dr(e)?(this.state=w.RAWTEXT_END_TAG_NAME,this._stateRawtextEndTagName(e)):(this._emitChars("</"),this.state=w.RAWTEXT,this._stateRawtext(e))}_stateRawtextEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=w.RAWTEXT,this._stateRawtext(e))}_stateScriptDataLessThanSign(e){switch(e){case y.SOLIDUS:{this.state=w.SCRIPT_DATA_END_TAG_OPEN;break}case y.EXCLAMATION_MARK:{this.state=w.SCRIPT_DATA_ESCAPE_START,this._emitChars("<!");break}default:this._emitChars("<"),this.state=w.SCRIPT_DATA,this._stateScriptData(e)}}_stateScriptDataEndTagOpen(e){Dr(e)?(this.state=w.SCRIPT_DATA_END_TAG_NAME,this._stateScriptDataEndTagName(e)):(this._emitChars("</"),this.state=w.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=w.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscapeStart(e){e===y.HYPHEN_MINUS?(this.state=w.SCRIPT_DATA_ESCAPE_START_DASH,this._emitChars("-")):(this.state=w.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscapeStartDash(e){e===y.HYPHEN_MINUS?(this.state=w.SCRIPT_DATA_ESCAPED_DASH_DASH,this._emitChars("-")):(this.state=w.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscaped(e){switch(e){case y.HYPHEN_MINUS:{this.state=w.SCRIPT_DATA_ESCAPED_DASH,this._emitChars("-");break}case y.LESS_THAN_SIGN:{this.state=w.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case y.NULL:{this._err(F.unexpectedNullCharacter),this._emitChars(Qe);break}case y.EOF:{this._err(F.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptDataEscapedDash(e){switch(e){case y.HYPHEN_MINUS:{this.state=w.SCRIPT_DATA_ESCAPED_DASH_DASH,this._emitChars("-");break}case y.LESS_THAN_SIGN:{this.state=w.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.state=w.SCRIPT_DATA_ESCAPED,this._emitChars(Qe);break}case y.EOF:{this._err(F.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=w.SCRIPT_DATA_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataEscapedDashDash(e){switch(e){case y.HYPHEN_MINUS:{this._emitChars("-");break}case y.LESS_THAN_SIGN:{this.state=w.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case y.GREATER_THAN_SIGN:{this.state=w.SCRIPT_DATA,this._emitChars(">");break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.state=w.SCRIPT_DATA_ESCAPED,this._emitChars(Qe);break}case y.EOF:{this._err(F.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=w.SCRIPT_DATA_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataEscapedLessThanSign(e){e===y.SOLIDUS?this.state=w.SCRIPT_DATA_ESCAPED_END_TAG_OPEN:Dr(e)?(this._emitChars("<"),this.state=w.SCRIPT_DATA_DOUBLE_ESCAPE_START,this._stateScriptDataDoubleEscapeStart(e)):(this._emitChars("<"),this.state=w.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataEscapedEndTagOpen(e){Dr(e)?(this.state=w.SCRIPT_DATA_ESCAPED_END_TAG_NAME,this._stateScriptDataEscapedEndTagName(e)):(this._emitChars("</"),this.state=w.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataEscapedEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=w.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataDoubleEscapeStart(e){if(this.preprocessor.startsWith(Wt.SCRIPT,!1)&&N0(this.preprocessor.peek(Wt.SCRIPT.length))){this._emitCodePoint(e);for(let n=0;n<Wt.SCRIPT.length;n++)this._emitCodePoint(this._consume());this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED}else this._ensureHibernation()||(this.state=w.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataDoubleEscaped(e){switch(e){case y.HYPHEN_MINUS:{this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED_DASH,this._emitChars("-");break}case y.LESS_THAN_SIGN:{this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case y.NULL:{this._err(F.unexpectedNullCharacter),this._emitChars(Qe);break}case y.EOF:{this._err(F.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedDash(e){switch(e){case y.HYPHEN_MINUS:{this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH,this._emitChars("-");break}case y.LESS_THAN_SIGN:{this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitChars(Qe);break}case y.EOF:{this._err(F.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedDashDash(e){switch(e){case y.HYPHEN_MINUS:{this._emitChars("-");break}case y.LESS_THAN_SIGN:{this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case y.GREATER_THAN_SIGN:{this.state=w.SCRIPT_DATA,this._emitChars(">");break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitChars(Qe);break}case y.EOF:{this._err(F.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedLessThanSign(e){e===y.SOLIDUS?(this.state=w.SCRIPT_DATA_DOUBLE_ESCAPE_END,this._emitChars("/")):(this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED,this._stateScriptDataDoubleEscaped(e))}_stateScriptDataDoubleEscapeEnd(e){if(this.preprocessor.startsWith(Wt.SCRIPT,!1)&&N0(this.preprocessor.peek(Wt.SCRIPT.length))){this._emitCodePoint(e);for(let n=0;n<Wt.SCRIPT.length;n++)this._emitCodePoint(this._consume());this.state=w.SCRIPT_DATA_ESCAPED}else this._ensureHibernation()||(this.state=w.SCRIPT_DATA_DOUBLE_ESCAPED,this._stateScriptDataDoubleEscaped(e))}_stateBeforeAttributeName(e){switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.SOLIDUS:case y.GREATER_THAN_SIGN:case y.EOF:{this.state=w.AFTER_ATTRIBUTE_NAME,this._stateAfterAttributeName(e);break}case y.EQUALS_SIGN:{this._err(F.unexpectedEqualsSignBeforeAttributeName),this._createAttr("="),this.state=w.ATTRIBUTE_NAME;break}default:this._createAttr(""),this.state=w.ATTRIBUTE_NAME,this._stateAttributeName(e)}}_stateAttributeName(e){switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:case y.SOLIDUS:case y.GREATER_THAN_SIGN:case y.EOF:{this._leaveAttrName(),this.state=w.AFTER_ATTRIBUTE_NAME,this._stateAfterAttributeName(e);break}case y.EQUALS_SIGN:{this._leaveAttrName(),this.state=w.BEFORE_ATTRIBUTE_VALUE;break}case y.QUOTATION_MARK:case y.APOSTROPHE:case y.LESS_THAN_SIGN:{this._err(F.unexpectedCharacterInAttributeName),this.currentAttr.name+=String.fromCodePoint(e);break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.currentAttr.name+=Qe;break}default:this.currentAttr.name+=String.fromCodePoint(si(e)?uu(e):e)}}_stateAfterAttributeName(e){switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.SOLIDUS:{this.state=w.SELF_CLOSING_START_TAG;break}case y.EQUALS_SIGN:{this.state=w.BEFORE_ATTRIBUTE_VALUE;break}case y.GREATER_THAN_SIGN:{this.state=w.DATA,this.emitCurrentTagToken();break}case y.EOF:{this._err(F.eofInTag),this._emitEOFToken();break}default:this._createAttr(""),this.state=w.ATTRIBUTE_NAME,this._stateAttributeName(e)}}_stateBeforeAttributeValue(e){switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.QUOTATION_MARK:{this.state=w.ATTRIBUTE_VALUE_DOUBLE_QUOTED;break}case y.APOSTROPHE:{this.state=w.ATTRIBUTE_VALUE_SINGLE_QUOTED;break}case y.GREATER_THAN_SIGN:{this._err(F.missingAttributeValue),this.state=w.DATA,this.emitCurrentTagToken();break}default:this.state=w.ATTRIBUTE_VALUE_UNQUOTED,this._stateAttributeValueUnquoted(e)}}_stateAttributeValueDoubleQuoted(e){switch(e){case y.QUOTATION_MARK:{this.state=w.AFTER_ATTRIBUTE_VALUE_QUOTED;break}case y.AMPERSAND:{this._startCharacterReference();break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.currentAttr.value+=Qe;break}case y.EOF:{this._err(F.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAttributeValueSingleQuoted(e){switch(e){case y.APOSTROPHE:{this.state=w.AFTER_ATTRIBUTE_VALUE_QUOTED;break}case y.AMPERSAND:{this._startCharacterReference();break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.currentAttr.value+=Qe;break}case y.EOF:{this._err(F.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAttributeValueUnquoted(e){switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this._leaveAttrValue(),this.state=w.BEFORE_ATTRIBUTE_NAME;break}case y.AMPERSAND:{this._startCharacterReference();break}case y.GREATER_THAN_SIGN:{this._leaveAttrValue(),this.state=w.DATA,this.emitCurrentTagToken();break}case y.NULL:{this._err(F.unexpectedNullCharacter),this.currentAttr.value+=Qe;break}case y.QUOTATION_MARK:case y.APOSTROPHE:case y.LESS_THAN_SIGN:case y.EQUALS_SIGN:case y.GRAVE_ACCENT:{this._err(F.unexpectedCharacterInUnquotedAttributeValue),this.currentAttr.value+=String.fromCodePoint(e);break}case y.EOF:{this._err(F.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAfterAttributeValueQuoted(e){switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this._leaveAttrValue(),this.state=w.BEFORE_ATTRIBUTE_NAME;break}case y.SOLIDUS:{this._leaveAttrValue(),this.state=w.SELF_CLOSING_START_TAG;break}case y.GREATER_THAN_SIGN:{this._leaveAttrValue(),this.state=w.DATA,this.emitCurrentTagToken();break}case y.EOF:{this._err(F.eofInTag),this._emitEOFToken();break}default:this._err(F.missingWhitespaceBetweenAttributes),this.state=w.BEFORE_ATTRIBUTE_NAME,this._stateBeforeAttributeName(e)}}_stateSelfClosingStartTag(e){switch(e){case y.GREATER_THAN_SIGN:{const n=this.currentToken;n.selfClosing=!0,this.state=w.DATA,this.emitCurrentTagToken();break}case y.EOF:{this._err(F.eofInTag),this._emitEOFToken();break}default:this._err(F.unexpectedSolidusInTag),this.state=w.BEFORE_ATTRIBUTE_NAME,this._stateBeforeAttributeName(e)}}_stateBogusComment(e){const n=this.currentToken;switch(e){case y.GREATER_THAN_SIGN:{this.state=w.DATA,this.emitCurrentComment(n);break}case y.EOF:{this.emitCurrentComment(n),this._emitEOFToken();break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.data+=Qe;break}default:n.data+=String.fromCodePoint(e)}}_stateMarkupDeclarationOpen(e){this._consumeSequenceIfMatch(Wt.DASH_DASH,!0)?(this._createCommentToken(Wt.DASH_DASH.length+1),this.state=w.COMMENT_START):this._consumeSequenceIfMatch(Wt.DOCTYPE,!1)?(this.currentLocation=this.getCurrentLocation(Wt.DOCTYPE.length+1),this.state=w.DOCTYPE):this._consumeSequenceIfMatch(Wt.CDATA_START,!0)?this.inForeignNode?this.state=w.CDATA_SECTION:(this._err(F.cdataInHtmlContent),this._createCommentToken(Wt.CDATA_START.length+1),this.currentToken.data="[CDATA[",this.state=w.BOGUS_COMMENT):this._ensureHibernation()||(this._err(F.incorrectlyOpenedComment),this._createCommentToken(2),this.state=w.BOGUS_COMMENT,this._stateBogusComment(e))}_stateCommentStart(e){switch(e){case y.HYPHEN_MINUS:{this.state=w.COMMENT_START_DASH;break}case y.GREATER_THAN_SIGN:{this._err(F.abruptClosingOfEmptyComment),this.state=w.DATA;const n=this.currentToken;this.emitCurrentComment(n);break}default:this.state=w.COMMENT,this._stateComment(e)}}_stateCommentStartDash(e){const n=this.currentToken;switch(e){case y.HYPHEN_MINUS:{this.state=w.COMMENT_END;break}case y.GREATER_THAN_SIGN:{this._err(F.abruptClosingOfEmptyComment),this.state=w.DATA,this.emitCurrentComment(n);break}case y.EOF:{this._err(F.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="-",this.state=w.COMMENT,this._stateComment(e)}}_stateComment(e){const n=this.currentToken;switch(e){case y.HYPHEN_MINUS:{this.state=w.COMMENT_END_DASH;break}case y.LESS_THAN_SIGN:{n.data+="<",this.state=w.COMMENT_LESS_THAN_SIGN;break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.data+=Qe;break}case y.EOF:{this._err(F.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+=String.fromCodePoint(e)}}_stateCommentLessThanSign(e){const n=this.currentToken;switch(e){case y.EXCLAMATION_MARK:{n.data+="!",this.state=w.COMMENT_LESS_THAN_SIGN_BANG;break}case y.LESS_THAN_SIGN:{n.data+="<";break}default:this.state=w.COMMENT,this._stateComment(e)}}_stateCommentLessThanSignBang(e){e===y.HYPHEN_MINUS?this.state=w.COMMENT_LESS_THAN_SIGN_BANG_DASH:(this.state=w.COMMENT,this._stateComment(e))}_stateCommentLessThanSignBangDash(e){e===y.HYPHEN_MINUS?this.state=w.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH:(this.state=w.COMMENT_END_DASH,this._stateCommentEndDash(e))}_stateCommentLessThanSignBangDashDash(e){e!==y.GREATER_THAN_SIGN&&e!==y.EOF&&this._err(F.nestedComment),this.state=w.COMMENT_END,this._stateCommentEnd(e)}_stateCommentEndDash(e){const n=this.currentToken;switch(e){case y.HYPHEN_MINUS:{this.state=w.COMMENT_END;break}case y.EOF:{this._err(F.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="-",this.state=w.COMMENT,this._stateComment(e)}}_stateCommentEnd(e){const n=this.currentToken;switch(e){case y.GREATER_THAN_SIGN:{this.state=w.DATA,this.emitCurrentComment(n);break}case y.EXCLAMATION_MARK:{this.state=w.COMMENT_END_BANG;break}case y.HYPHEN_MINUS:{n.data+="-";break}case y.EOF:{this._err(F.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="--",this.state=w.COMMENT,this._stateComment(e)}}_stateCommentEndBang(e){const n=this.currentToken;switch(e){case y.HYPHEN_MINUS:{n.data+="--!",this.state=w.COMMENT_END_DASH;break}case y.GREATER_THAN_SIGN:{this._err(F.incorrectlyClosedComment),this.state=w.DATA,this.emitCurrentComment(n);break}case y.EOF:{this._err(F.eofInComment),this.emitCurrentComment(n),this._emitEOFToken();break}default:n.data+="--!",this.state=w.COMMENT,this._stateComment(e)}}_stateDoctype(e){switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this.state=w.BEFORE_DOCTYPE_NAME;break}case y.GREATER_THAN_SIGN:{this.state=w.BEFORE_DOCTYPE_NAME,this._stateBeforeDoctypeName(e);break}case y.EOF:{this._err(F.eofInDoctype),this._createDoctypeToken(null);const n=this.currentToken;n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.missingWhitespaceBeforeDoctypeName),this.state=w.BEFORE_DOCTYPE_NAME,this._stateBeforeDoctypeName(e)}}_stateBeforeDoctypeName(e){if(si(e))this._createDoctypeToken(String.fromCharCode(uu(e))),this.state=w.DOCTYPE_NAME;else switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.NULL:{this._err(F.unexpectedNullCharacter),this._createDoctypeToken(Qe),this.state=w.DOCTYPE_NAME;break}case y.GREATER_THAN_SIGN:{this._err(F.missingDoctypeName),this._createDoctypeToken(null);const n=this.currentToken;n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.EOF:{this._err(F.eofInDoctype),this._createDoctypeToken(null);const n=this.currentToken;n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._createDoctypeToken(String.fromCodePoint(e)),this.state=w.DOCTYPE_NAME}}_stateDoctypeName(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this.state=w.AFTER_DOCTYPE_NAME;break}case y.GREATER_THAN_SIGN:{this.state=w.DATA,this.emitCurrentDoctype(n);break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.name+=Qe;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.name+=String.fromCodePoint(si(e)?uu(e):e)}}_stateAfterDoctypeName(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.GREATER_THAN_SIGN:{this.state=w.DATA,this.emitCurrentDoctype(n);break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._consumeSequenceIfMatch(Wt.PUBLIC,!1)?this.state=w.AFTER_DOCTYPE_PUBLIC_KEYWORD:this._consumeSequenceIfMatch(Wt.SYSTEM,!1)?this.state=w.AFTER_DOCTYPE_SYSTEM_KEYWORD:this._ensureHibernation()||(this._err(F.invalidCharacterSequenceAfterDoctypeName),n.forceQuirks=!0,this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e))}}_stateAfterDoctypePublicKeyword(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this.state=w.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER;break}case y.QUOTATION_MARK:{this._err(F.missingWhitespaceAfterDoctypePublicKeyword),n.publicId="",this.state=w.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED;break}case y.APOSTROPHE:{this._err(F.missingWhitespaceAfterDoctypePublicKeyword),n.publicId="",this.state=w.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED;break}case y.GREATER_THAN_SIGN:{this._err(F.missingDoctypePublicIdentifier),n.forceQuirks=!0,this.state=w.DATA,this.emitCurrentDoctype(n);break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.missingQuoteBeforeDoctypePublicIdentifier),n.forceQuirks=!0,this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBeforeDoctypePublicIdentifier(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.QUOTATION_MARK:{n.publicId="",this.state=w.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED;break}case y.APOSTROPHE:{n.publicId="",this.state=w.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED;break}case y.GREATER_THAN_SIGN:{this._err(F.missingDoctypePublicIdentifier),n.forceQuirks=!0,this.state=w.DATA,this.emitCurrentDoctype(n);break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.missingQuoteBeforeDoctypePublicIdentifier),n.forceQuirks=!0,this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateDoctypePublicIdentifierDoubleQuoted(e){const n=this.currentToken;switch(e){case y.QUOTATION_MARK:{this.state=w.AFTER_DOCTYPE_PUBLIC_IDENTIFIER;break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.publicId+=Qe;break}case y.GREATER_THAN_SIGN:{this._err(F.abruptDoctypePublicIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.publicId+=String.fromCodePoint(e)}}_stateDoctypePublicIdentifierSingleQuoted(e){const n=this.currentToken;switch(e){case y.APOSTROPHE:{this.state=w.AFTER_DOCTYPE_PUBLIC_IDENTIFIER;break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.publicId+=Qe;break}case y.GREATER_THAN_SIGN:{this._err(F.abruptDoctypePublicIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.publicId+=String.fromCodePoint(e)}}_stateAfterDoctypePublicIdentifier(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this.state=w.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS;break}case y.GREATER_THAN_SIGN:{this.state=w.DATA,this.emitCurrentDoctype(n);break}case y.QUOTATION_MARK:{this._err(F.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case y.APOSTROPHE:{this._err(F.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBetweenDoctypePublicAndSystemIdentifiers(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.GREATER_THAN_SIGN:{this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.QUOTATION_MARK:{n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case y.APOSTROPHE:{n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateAfterDoctypeSystemKeyword(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:{this.state=w.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER;break}case y.QUOTATION_MARK:{this._err(F.missingWhitespaceAfterDoctypeSystemKeyword),n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case y.APOSTROPHE:{this._err(F.missingWhitespaceAfterDoctypeSystemKeyword),n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case y.GREATER_THAN_SIGN:{this._err(F.missingDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=w.DATA,this.emitCurrentDoctype(n);break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBeforeDoctypeSystemIdentifier(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.QUOTATION_MARK:{n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case y.APOSTROPHE:{n.systemId="",this.state=w.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case y.GREATER_THAN_SIGN:{this._err(F.missingDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=w.DATA,this.emitCurrentDoctype(n);break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.missingQuoteBeforeDoctypeSystemIdentifier),n.forceQuirks=!0,this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateDoctypeSystemIdentifierDoubleQuoted(e){const n=this.currentToken;switch(e){case y.QUOTATION_MARK:{this.state=w.AFTER_DOCTYPE_SYSTEM_IDENTIFIER;break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.systemId+=Qe;break}case y.GREATER_THAN_SIGN:{this._err(F.abruptDoctypeSystemIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.systemId+=String.fromCodePoint(e)}}_stateDoctypeSystemIdentifierSingleQuoted(e){const n=this.currentToken;switch(e){case y.APOSTROPHE:{this.state=w.AFTER_DOCTYPE_SYSTEM_IDENTIFIER;break}case y.NULL:{this._err(F.unexpectedNullCharacter),n.systemId+=Qe;break}case y.GREATER_THAN_SIGN:{this._err(F.abruptDoctypeSystemIdentifier),n.forceQuirks=!0,this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:n.systemId+=String.fromCodePoint(e)}}_stateAfterDoctypeSystemIdentifier(e){const n=this.currentToken;switch(e){case y.SPACE:case y.LINE_FEED:case y.TABULATION:case y.FORM_FEED:break;case y.GREATER_THAN_SIGN:{this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.EOF:{this._err(F.eofInDoctype),n.forceQuirks=!0,this.emitCurrentDoctype(n),this._emitEOFToken();break}default:this._err(F.unexpectedCharacterAfterDoctypeSystemIdentifier),this.state=w.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBogusDoctype(e){const n=this.currentToken;switch(e){case y.GREATER_THAN_SIGN:{this.emitCurrentDoctype(n),this.state=w.DATA;break}case y.NULL:{this._err(F.unexpectedNullCharacter);break}case y.EOF:{this.emitCurrentDoctype(n),this._emitEOFToken();break}}}_stateCdataSection(e){switch(e){case y.RIGHT_SQUARE_BRACKET:{this.state=w.CDATA_SECTION_BRACKET;break}case y.EOF:{this._err(F.eofInCdata),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateCdataSectionBracket(e){e===y.RIGHT_SQUARE_BRACKET?this.state=w.CDATA_SECTION_END:(this._emitChars("]"),this.state=w.CDATA_SECTION,this._stateCdataSection(e))}_stateCdataSectionEnd(e){switch(e){case y.GREATER_THAN_SIGN:{this.state=w.DATA;break}case y.RIGHT_SQUARE_BRACKET:{this._emitChars("]");break}default:this._emitChars("]]"),this.state=w.CDATA_SECTION,this._stateCdataSection(e)}}_stateCharacterReference(){let e=this.entityDecoder.write(this.preprocessor.html,this.preprocessor.pos);if(e<0)if(this.preprocessor.lastChunkWritten)e=this.entityDecoder.end();else{this.active=!1,this.preprocessor.pos=this.preprocessor.html.length-1,this.consumedAfterSnapshot=0,this.preprocessor.endOfChunkHit=!0;return}e===0?(this.preprocessor.pos=this.entityStartPos,this._flushCodePointConsumedAsCharacterReference(y.AMPERSAND),this.state=!this._isCharacterReferenceInAttribute()&&I0(this.preprocessor.peek(1))?w.AMBIGUOUS_AMPERSAND:this.returnState):this.state=this.returnState}_stateAmbiguousAmpersand(e){I0(e)?this._flushCodePointConsumedAsCharacterReference(e):(e===y.SEMICOLON&&this._err(F.unknownNamedCharacterReference),this.state=this.returnState,this._callState(e))}};const fw=new Set([h.DD,h.DT,h.LI,h.OPTGROUP,h.OPTION,h.P,h.RB,h.RP,h.RT,h.RTC]),k0=new Set([...fw,h.CAPTION,h.COLGROUP,h.TBODY,h.TD,h.TFOOT,h.TH,h.THEAD,h.TR]),hc=new Set([h.APPLET,h.CAPTION,h.HTML,h.MARQUEE,h.OBJECT,h.TABLE,h.TD,h.TEMPLATE,h.TH]),QM=new Set([...hc,h.OL,h.UL]),e8=new Set([...hc,h.BUTTON]),R0=new Set([h.ANNOTATION_XML,h.MI,h.MN,h.MO,h.MS,h.MTEXT]),P0=new Set([h.DESC,h.FOREIGN_OBJECT,h.TITLE]),t8=new Set([h.TR,h.TEMPLATE,h.HTML]),n8=new Set([h.TBODY,h.TFOOT,h.THEAD,h.TEMPLATE,h.HTML]),r8=new Set([h.TABLE,h.TEMPLATE,h.HTML]),s8=new Set([h.TD,h.TH]);class a8{get currentTmplContentOrNode(){return this._isInTemplate()?this.treeAdapter.getTemplateContent(this.current):this.current}constructor(e,n,r){this.treeAdapter=n,this.handler=r,this.items=[],this.tagIDs=[],this.stackTop=-1,this.tmplCount=0,this.currentTagId=h.UNKNOWN,this.current=e}_indexOf(e){return this.items.lastIndexOf(e,this.stackTop)}_isInTemplate(){return this.currentTagId===h.TEMPLATE&&this.treeAdapter.getNamespaceURI(this.current)===W.HTML}_updateCurrentElement(){this.current=this.items[this.stackTop],this.currentTagId=this.tagIDs[this.stackTop]}push(e,n){this.stackTop++,this.items[this.stackTop]=e,this.current=e,this.tagIDs[this.stackTop]=n,this.currentTagId=n,this._isInTemplate()&&this.tmplCount++,this.handler.onItemPush(e,n,!0)}pop(){const e=this.current;this.tmplCount>0&&this._isInTemplate()&&this.tmplCount--,this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(e,!0)}replace(e,n){const r=this._indexOf(e);this.items[r]=n,r===this.stackTop&&(this.current=n)}insertAfter(e,n,r){const s=this._indexOf(e)+1;this.items.splice(s,0,n),this.tagIDs.splice(s,0,r),this.stackTop++,s===this.stackTop&&this._updateCurrentElement(),this.handler.onItemPush(this.current,this.currentTagId,s===this.stackTop)}popUntilTagNamePopped(e){let n=this.stackTop+1;do n=this.tagIDs.lastIndexOf(e,n-1);while(n>0&&this.treeAdapter.getNamespaceURI(this.items[n])!==W.HTML);this.shortenToLength(n<0?0:n)}shortenToLength(e){for(;this.stackTop>=e;){const n=this.current;this.tmplCount>0&&this._isInTemplate()&&(this.tmplCount-=1),this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(n,this.stackTop<e)}}popUntilElementPopped(e){const n=this._indexOf(e);this.shortenToLength(n<0?0:n)}popUntilPopped(e,n){const r=this._indexOfTagNames(e,n);this.shortenToLength(r<0?0:r)}popUntilNumberedHeaderPopped(){this.popUntilPopped(Vh,W.HTML)}popUntilTableCellPopped(){this.popUntilPopped(s8,W.HTML)}popAllUpToHtmlElement(){this.tmplCount=0,this.shortenToLength(1)}_indexOfTagNames(e,n){for(let r=this.stackTop;r>=0;r--)if(e.has(this.tagIDs[r])&&this.treeAdapter.getNamespaceURI(this.items[r])===n)return r;return-1}clearBackTo(e,n){const r=this._indexOfTagNames(e,n);this.shortenToLength(r+1)}clearBackToTableContext(){this.clearBackTo(r8,W.HTML)}clearBackToTableBodyContext(){this.clearBackTo(n8,W.HTML)}clearBackToTableRowContext(){this.clearBackTo(t8,W.HTML)}remove(e){const n=this._indexOf(e);n>=0&&(n===this.stackTop?this.pop():(this.items.splice(n,1),this.tagIDs.splice(n,1),this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(e,!1)))}tryPeekProperlyNestedBodyElement(){return this.stackTop>=1&&this.tagIDs[1]===h.BODY?this.items[1]:null}contains(e){return this._indexOf(e)>-1}getCommonAncestor(e){const n=this._indexOf(e)-1;return n>=0?this.items[n]:null}isRootHtmlElementCurrent(){return this.stackTop===0&&this.tagIDs[0]===h.HTML}hasInDynamicScope(e,n){for(let r=this.stackTop;r>=0;r--){const s=this.tagIDs[r];switch(this.treeAdapter.getNamespaceURI(this.items[r])){case W.HTML:{if(s===e)return!0;if(n.has(s))return!1;break}case W.SVG:{if(P0.has(s))return!1;break}case W.MATHML:{if(R0.has(s))return!1;break}}}return!0}hasInScope(e){return this.hasInDynamicScope(e,hc)}hasInListItemScope(e){return this.hasInDynamicScope(e,QM)}hasInButtonScope(e){return this.hasInDynamicScope(e,e8)}hasNumberedHeaderInScope(){for(let e=this.stackTop;e>=0;e--){const n=this.tagIDs[e];switch(this.treeAdapter.getNamespaceURI(this.items[e])){case W.HTML:{if(Vh.has(n))return!0;if(hc.has(n))return!1;break}case W.SVG:{if(P0.has(n))return!1;break}case W.MATHML:{if(R0.has(n))return!1;break}}}return!0}hasInTableScope(e){for(let n=this.stackTop;n>=0;n--)if(this.treeAdapter.getNamespaceURI(this.items[n])===W.HTML)switch(this.tagIDs[n]){case e:return!0;case h.TABLE:case h.HTML:return!1}return!0}hasTableBodyContextInTableScope(){for(let e=this.stackTop;e>=0;e--)if(this.treeAdapter.getNamespaceURI(this.items[e])===W.HTML)switch(this.tagIDs[e]){case h.TBODY:case h.THEAD:case h.TFOOT:return!0;case h.TABLE:case h.HTML:return!1}return!0}hasInSelectScope(e){for(let n=this.stackTop;n>=0;n--)if(this.treeAdapter.getNamespaceURI(this.items[n])===W.HTML)switch(this.tagIDs[n]){case e:return!0;case h.OPTION:case h.OPTGROUP:break;default:return!1}return!0}generateImpliedEndTags(){for(;fw.has(this.currentTagId);)this.pop()}generateImpliedEndTagsThoroughly(){for(;k0.has(this.currentTagId);)this.pop()}generateImpliedEndTagsWithExclusion(e){for(;this.currentTagId!==e&&k0.has(this.currentTagId);)this.pop()}}const vd=3;var sr;(function(t){t[t.Marker=0]="Marker",t[t.Element=1]="Element"})(sr||(sr={}));const x0={type:sr.Marker};class i8{constructor(e){this.treeAdapter=e,this.entries=[],this.bookmark=null}_getNoahArkConditionCandidates(e,n){const r=[],s=n.length,a=this.treeAdapter.getTagName(e),i=this.treeAdapter.getNamespaceURI(e);for(let o=0;o<this.entries.length;o++){const u=this.entries[o];if(u.type===sr.Marker)break;const{element:c}=u;if(this.treeAdapter.getTagName(c)===a&&this.treeAdapter.getNamespaceURI(c)===i){const l=this.treeAdapter.getAttrList(c);l.length===s&&r.push({idx:o,attrs:l})}}return r}_ensureNoahArkCondition(e){if(this.entries.length<vd)return;const n=this.treeAdapter.getAttrList(e),r=this._getNoahArkConditionCandidates(e,n);if(r.length<vd)return;const s=new Map(n.map(i=>[i.name,i.value]));let a=0;for(let i=0;i<r.length;i++){const o=r[i];o.attrs.every(u=>s.get(u.name)===u.value)&&(a+=1,a>=vd&&this.entries.splice(o.idx,1))}}insertMarker(){this.entries.unshift(x0)}pushElement(e,n){this._ensureNoahArkCondition(e),this.entries.unshift({type:sr.Element,element:e,token:n})}insertElementAfterBookmark(e,n){const r=this.entries.indexOf(this.bookmark);this.entries.splice(r,0,{type:sr.Element,element:e,token:n})}removeEntry(e){const n=this.entries.indexOf(e);n>=0&&this.entries.splice(n,1)}clearToLastMarker(){const e=this.entries.indexOf(x0);e>=0?this.entries.splice(0,e+1):this.entries.length=0}getElementEntryInScopeWithTagName(e){const n=this.entries.find(r=>r.type===sr.Marker||this.treeAdapter.getTagName(r.element)===e);return n&&n.type===sr.Element?n:null}getElementEntry(e){return this.entries.find(n=>n.type===sr.Element&&n.element===e)}}const wr={createDocument(){return{nodeName:"#document",mode:ln.NO_QUIRKS,childNodes:[]}},createDocumentFragment(){return{nodeName:"#document-fragment",childNodes:[]}},createElement(t,e,n){return{nodeName:t,tagName:t,attrs:n,namespaceURI:e,childNodes:[],parentNode:null}},createCommentNode(t){return{nodeName:"#comment",data:t,parentNode:null}},createTextNode(t){return{nodeName:"#text",value:t,parentNode:null}},appendChild(t,e){t.childNodes.push(e),e.parentNode=t},insertBefore(t,e,n){const r=t.childNodes.indexOf(n);t.childNodes.splice(r,0,e),e.parentNode=t},setTemplateContent(t,e){t.content=e},getTemplateContent(t){return t.content},setDocumentType(t,e,n,r){const s=t.childNodes.find(a=>a.nodeName==="#documentType");if(s)s.name=e,s.publicId=n,s.systemId=r;else{const a={nodeName:"#documentType",name:e,publicId:n,systemId:r,parentNode:null};wr.appendChild(t,a)}},setDocumentMode(t,e){t.mode=e},getDocumentMode(t){return t.mode},detachNode(t){if(t.parentNode){const e=t.parentNode.childNodes.indexOf(t);t.parentNode.childNodes.splice(e,1),t.parentNode=null}},insertText(t,e){if(t.childNodes.length>0){const n=t.childNodes[t.childNodes.length-1];if(wr.isTextNode(n)){n.value+=e;return}}wr.appendChild(t,wr.createTextNode(e))},insertTextBefore(t,e,n){const r=t.childNodes[t.childNodes.indexOf(n)-1];r&&wr.isTextNode(r)?r.value+=e:wr.insertBefore(t,wr.createTextNode(e),n)},adoptAttributes(t,e){const n=new Set(t.attrs.map(r=>r.name));for(let r=0;r<e.length;r++)n.has(e[r].name)||t.attrs.push(e[r])},getFirstChild(t){return t.childNodes[0]},getChildNodes(t){return t.childNodes},getParentNode(t){return t.parentNode},getAttrList(t){return t.attrs},getTagName(t){return t.tagName},getNamespaceURI(t){return t.namespaceURI},getTextNodeContent(t){return t.value},getCommentNodeContent(t){return t.data},getDocumentTypeNodeName(t){return t.name},getDocumentTypeNodePublicId(t){return t.publicId},getDocumentTypeNodeSystemId(t){return t.systemId},isTextNode(t){return t.nodeName==="#text"},isCommentNode(t){return t.nodeName==="#comment"},isDocumentTypeNode(t){return t.nodeName==="#documentType"},isElementNode(t){return Object.prototype.hasOwnProperty.call(t,"tagName")},setNodeSourceCodeLocation(t,e){t.sourceCodeLocation=e},getNodeSourceCodeLocation(t){return t.sourceCodeLocation},updateNodeSourceCodeLocation(t,e){t.sourceCodeLocation={...t.sourceCodeLocation,...e}}},mw="html",o8="about:legacy-compat",u8="http://www.ibm.com/data/dtd/v11/ibmxhtml1-transitional.dtd",pw=["+//silmaril//dtd html pro v0r11 19970101//","-//as//dtd html 3.0 aswedit + extensions//","-//advasoft ltd//dtd html 3.0 aswedit + extensions//","-//ietf//dtd html 2.0 level 1//","-//ietf//dtd html 2.0 level 2//","-//ietf//dtd html 2.0 strict level 1//","-//ietf//dtd html 2.0 strict level 2//","-//ietf//dtd html 2.0 strict//","-//ietf//dtd html 2.0//","-//ietf//dtd html 2.1e//","-//ietf//dtd html 3.0//","-//ietf//dtd html 3.2 final//","-//ietf//dtd html 3.2//","-//ietf//dtd html 3//","-//ietf//dtd html level 0//","-//ietf//dtd html level 1//","-//ietf//dtd html level 2//","-//ietf//dtd html level 3//","-//ietf//dtd html strict level 0//","-//ietf//dtd html strict level 1//","-//ietf//dtd html strict level 2//","-//ietf//dtd html strict level 3//","-//ietf//dtd html strict//","-//ietf//dtd html//","-//metrius//dtd metrius presentational//","-//microsoft//dtd internet explorer 2.0 html strict//","-//microsoft//dtd internet explorer 2.0 html//","-//microsoft//dtd internet explorer 2.0 tables//","-//microsoft//dtd internet explorer 3.0 html strict//","-//microsoft//dtd internet explorer 3.0 html//","-//microsoft//dtd internet explorer 3.0 tables//","-//netscape comm. corp.//dtd html//","-//netscape comm. corp.//dtd strict html//","-//o'reilly and associates//dtd html 2.0//","-//o'reilly and associates//dtd html extended 1.0//","-//o'reilly and associates//dtd html extended relaxed 1.0//","-//sq//dtd html 2.0 hotmetal + extensions//","-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//","-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//","-//spyglass//dtd html 2.0 extended//","-//sun microsystems corp.//dtd hotjava html//","-//sun microsystems corp.//dtd hotjava strict html//","-//w3c//dtd html 3 1995-03-24//","-//w3c//dtd html 3.2 draft//","-//w3c//dtd html 3.2 final//","-//w3c//dtd html 3.2//","-//w3c//dtd html 3.2s draft//","-//w3c//dtd html 4.0 frameset//","-//w3c//dtd html 4.0 transitional//","-//w3c//dtd html experimental 19960712//","-//w3c//dtd html experimental 970421//","-//w3c//dtd w3 html//","-//w3o//dtd w3 html 3.0//","-//webtechs//dtd mozilla html 2.0//","-//webtechs//dtd mozilla html//"],c8=[...pw,"-//w3c//dtd html 4.01 frameset//","-//w3c//dtd html 4.01 transitional//"],l8=new Set(["-//w3o//dtd w3 html strict 3.0//en//","-/w3c/dtd html 4.0 transitional/en","html"]),gw=["-//w3c//dtd xhtml 1.0 frameset//","-//w3c//dtd xhtml 1.0 transitional//"],d8=[...gw,"-//w3c//dtd html 4.01 frameset//","-//w3c//dtd html 4.01 transitional//"];function L0(t,e){return e.some(n=>t.startsWith(n))}function h8(t){return t.name===mw&&t.publicId===null&&(t.systemId===null||t.systemId===o8)}function f8(t){if(t.name!==mw)return ln.QUIRKS;const{systemId:e}=t;if(e&&e.toLowerCase()===u8)return ln.QUIRKS;let{publicId:n}=t;if(n!==null){if(n=n.toLowerCase(),l8.has(n))return ln.QUIRKS;let r=e===null?c8:pw;if(L0(n,r))return ln.QUIRKS;if(r=e===null?gw:d8,L0(n,r))return ln.LIMITED_QUIRKS}return ln.NO_QUIRKS}const D0={TEXT_HTML:"text/html",APPLICATION_XML:"application/xhtml+xml"},m8="definitionurl",p8="definitionURL",g8=new Map(["attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(t=>[t.toLowerCase(),t])),b8=new Map([["xlink:actuate",{prefix:"xlink",name:"actuate",namespace:W.XLINK}],["xlink:arcrole",{prefix:"xlink",name:"arcrole",namespace:W.XLINK}],["xlink:href",{prefix:"xlink",name:"href",namespace:W.XLINK}],["xlink:role",{prefix:"xlink",name:"role",namespace:W.XLINK}],["xlink:show",{prefix:"xlink",name:"show",namespace:W.XLINK}],["xlink:title",{prefix:"xlink",name:"title",namespace:W.XLINK}],["xlink:type",{prefix:"xlink",name:"type",namespace:W.XLINK}],["xml:lang",{prefix:"xml",name:"lang",namespace:W.XML}],["xml:space",{prefix:"xml",name:"space",namespace:W.XML}],["xmlns",{prefix:"",name:"xmlns",namespace:W.XMLNS}],["xmlns:xlink",{prefix:"xmlns",name:"xlink",namespace:W.XMLNS}]]),_8=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(t=>[t.toLowerCase(),t])),y8=new Set([h.B,h.BIG,h.BLOCKQUOTE,h.BODY,h.BR,h.CENTER,h.CODE,h.DD,h.DIV,h.DL,h.DT,h.EM,h.EMBED,h.H1,h.H2,h.H3,h.H4,h.H5,h.H6,h.HEAD,h.HR,h.I,h.IMG,h.LI,h.LISTING,h.MENU,h.META,h.NOBR,h.OL,h.P,h.PRE,h.RUBY,h.S,h.SMALL,h.SPAN,h.STRONG,h.STRIKE,h.SUB,h.SUP,h.TABLE,h.TT,h.U,h.UL,h.VAR]);function E8(t){const e=t.tagID;return e===h.FONT&&t.attrs.some(({name:r})=>r===ps.COLOR||r===ps.SIZE||r===ps.FACE)||y8.has(e)}function bw(t){for(let e=0;e<t.attrs.length;e++)if(t.attrs[e].name===m8){t.attrs[e].name=p8;break}}function _w(t){for(let e=0;e<t.attrs.length;e++){const n=g8.get(t.attrs[e].name);n!=null&&(t.attrs[e].name=n)}}function Cm(t){for(let e=0;e<t.attrs.length;e++){const n=b8.get(t.attrs[e].name);n&&(t.attrs[e].prefix=n.prefix,t.attrs[e].name=n.name,t.attrs[e].namespace=n.namespace)}}function w8(t){const e=_8.get(t.tagName);e!=null&&(t.tagName=e,t.tagID=cl(t.tagName))}function T8(t,e){return e===W.MATHML&&(t===h.MI||t===h.MO||t===h.MN||t===h.MS||t===h.MTEXT)}function S8(t,e,n){if(e===W.MATHML&&t===h.ANNOTATION_XML){for(let r=0;r<n.length;r++)if(n[r].name===ps.ENCODING){const s=n[r].value.toLowerCase();return s===D0.TEXT_HTML||s===D0.APPLICATION_XML}}return e===W.SVG&&(t===h.FOREIGN_OBJECT||t===h.DESC||t===h.TITLE)}function A8(t,e,n,r){return(!r||r===W.HTML)&&S8(t,e,n)||(!r||r===W.MATHML)&&T8(t,e)}const C8="hidden",O8=8,v8=3;var S;(function(t){t[t.INITIAL=0]="INITIAL",t[t.BEFORE_HTML=1]="BEFORE_HTML",t[t.BEFORE_HEAD=2]="BEFORE_HEAD",t[t.IN_HEAD=3]="IN_HEAD",t[t.IN_HEAD_NO_SCRIPT=4]="IN_HEAD_NO_SCRIPT",t[t.AFTER_HEAD=5]="AFTER_HEAD",t[t.IN_BODY=6]="IN_BODY",t[t.TEXT=7]="TEXT",t[t.IN_TABLE=8]="IN_TABLE",t[t.IN_TABLE_TEXT=9]="IN_TABLE_TEXT",t[t.IN_CAPTION=10]="IN_CAPTION",t[t.IN_COLUMN_GROUP=11]="IN_COLUMN_GROUP",t[t.IN_TABLE_BODY=12]="IN_TABLE_BODY",t[t.IN_ROW=13]="IN_ROW",t[t.IN_CELL=14]="IN_CELL",t[t.IN_SELECT=15]="IN_SELECT",t[t.IN_SELECT_IN_TABLE=16]="IN_SELECT_IN_TABLE",t[t.IN_TEMPLATE=17]="IN_TEMPLATE",t[t.AFTER_BODY=18]="AFTER_BODY",t[t.IN_FRAMESET=19]="IN_FRAMESET",t[t.AFTER_FRAMESET=20]="AFTER_FRAMESET",t[t.AFTER_AFTER_BODY=21]="AFTER_AFTER_BODY",t[t.AFTER_AFTER_FRAMESET=22]="AFTER_AFTER_FRAMESET"})(S||(S={}));const I8={startLine:-1,startCol:-1,startOffset:-1,endLine:-1,endCol:-1,endOffset:-1},yw=new Set([h.TABLE,h.TBODY,h.TFOOT,h.THEAD,h.TR]),M0={scriptingEnabled:!0,sourceCodeLocationInfo:!1,treeAdapter:wr,onParseError:null};let Ew=class{constructor(e,n,r=null,s=null){this.fragmentContext=r,this.scriptHandler=s,this.currentToken=null,this.stopped=!1,this.insertionMode=S.INITIAL,this.originalInsertionMode=S.INITIAL,this.headElement=null,this.formElement=null,this.currentNotInHTML=!1,this.tmplInsertionModeStack=[],this.pendingCharacterTokens=[],this.hasNonWhitespacePendingCharacterToken=!1,this.framesetOk=!0,this.skipNextNewLine=!1,this.fosterParentingEnabled=!1,this.options={...M0,...e},this.treeAdapter=this.options.treeAdapter,this.onParseError=this.options.onParseError,this.onParseError&&(this.options.sourceCodeLocationInfo=!0),this.document=n??this.treeAdapter.createDocument(),this.tokenizer=new XM(this.options,this),this.activeFormattingElements=new i8(this.treeAdapter),this.fragmentContextID=r?cl(this.treeAdapter.getTagName(r)):h.UNKNOWN,this._setContextModes(r??this.document,this.fragmentContextID),this.openElements=new a8(this.document,this.treeAdapter,this)}static parse(e,n){const r=new this(n);return r.tokenizer.write(e,!0),r.document}static getFragmentParser(e,n){const r={...M0,...n};e??(e=r.treeAdapter.createElement(k.TEMPLATE,W.HTML,[]));const s=r.treeAdapter.createElement("documentmock",W.HTML,[]),a=new this(r,s,e);return a.fragmentContextID===h.TEMPLATE&&a.tmplInsertionModeStack.unshift(S.IN_TEMPLATE),a._initTokenizerForFragmentParsing(),a._insertFakeRootElement(),a._resetInsertionMode(),a._findFormInFragmentContext(),a}getFragment(){const e=this.treeAdapter.getFirstChild(this.document),n=this.treeAdapter.createDocumentFragment();return this._adoptNodes(e,n),n}_err(e,n,r){var s;if(!this.onParseError)return;const a=(s=e.location)!==null&&s!==void 0?s:I8,i={code:n,startLine:a.startLine,startCol:a.startCol,startOffset:a.startOffset,endLine:r?a.startLine:a.endLine,endCol:r?a.startCol:a.endCol,endOffset:r?a.startOffset:a.endOffset};this.onParseError(i)}onItemPush(e,n,r){var s,a;(a=(s=this.treeAdapter).onItemPush)===null||a===void 0||a.call(s,e),r&&this.openElements.stackTop>0&&this._setContextModes(e,n)}onItemPop(e,n){var r,s;if(this.options.sourceCodeLocationInfo&&this._setEndLocation(e,this.currentToken),(s=(r=this.treeAdapter).onItemPop)===null||s===void 0||s.call(r,e,this.openElements.current),n){let a,i;this.openElements.stackTop===0&&this.fragmentContext?(a=this.fragmentContext,i=this.fragmentContextID):{current:a,currentTagId:i}=this.openElements,this._setContextModes(a,i)}}_setContextModes(e,n){const r=e===this.document||this.treeAdapter.getNamespaceURI(e)===W.HTML;this.currentNotInHTML=!r,this.tokenizer.inForeignNode=!r&&!this._isIntegrationPoint(n,e)}_switchToTextParsing(e,n){this._insertElement(e,W.HTML),this.tokenizer.state=n,this.originalInsertionMode=this.insertionMode,this.insertionMode=S.TEXT}switchToPlaintextParsing(){this.insertionMode=S.TEXT,this.originalInsertionMode=S.IN_BODY,this.tokenizer.state=Jt.PLAINTEXT}_getAdjustedCurrentElement(){return this.openElements.stackTop===0&&this.fragmentContext?this.fragmentContext:this.openElements.current}_findFormInFragmentContext(){let e=this.fragmentContext;for(;e;){if(this.treeAdapter.getTagName(e)===k.FORM){this.formElement=e;break}e=this.treeAdapter.getParentNode(e)}}_initTokenizerForFragmentParsing(){if(!(!this.fragmentContext||this.treeAdapter.getNamespaceURI(this.fragmentContext)!==W.HTML))switch(this.fragmentContextID){case h.TITLE:case h.TEXTAREA:{this.tokenizer.state=Jt.RCDATA;break}case h.STYLE:case h.XMP:case h.IFRAME:case h.NOEMBED:case h.NOFRAMES:case h.NOSCRIPT:{this.tokenizer.state=Jt.RAWTEXT;break}case h.SCRIPT:{this.tokenizer.state=Jt.SCRIPT_DATA;break}case h.PLAINTEXT:{this.tokenizer.state=Jt.PLAINTEXT;break}}}_setDocumentType(e){const n=e.name||"",r=e.publicId||"",s=e.systemId||"";if(this.treeAdapter.setDocumentType(this.document,n,r,s),e.location){const i=this.treeAdapter.getChildNodes(this.document).find(o=>this.treeAdapter.isDocumentTypeNode(o));i&&this.treeAdapter.setNodeSourceCodeLocation(i,e.location)}}_attachElementToTree(e,n){if(this.options.sourceCodeLocationInfo){const r=n&&{...n,startTag:n};this.treeAdapter.setNodeSourceCodeLocation(e,r)}if(this._shouldFosterParentOnInsertion())this._fosterParentElement(e);else{const r=this.openElements.currentTmplContentOrNode;this.treeAdapter.appendChild(r,e)}}_appendElement(e,n){const r=this.treeAdapter.createElement(e.tagName,n,e.attrs);this._attachElementToTree(r,e.location)}_insertElement(e,n){const r=this.treeAdapter.createElement(e.tagName,n,e.attrs);this._attachElementToTree(r,e.location),this.openElements.push(r,e.tagID)}_insertFakeElement(e,n){const r=this.treeAdapter.createElement(e,W.HTML,[]);this._attachElementToTree(r,null),this.openElements.push(r,n)}_insertTemplate(e){const n=this.treeAdapter.createElement(e.tagName,W.HTML,e.attrs),r=this.treeAdapter.createDocumentFragment();this.treeAdapter.setTemplateContent(n,r),this._attachElementToTree(n,e.location),this.openElements.push(n,e.tagID),this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(r,null)}_insertFakeRootElement(){const e=this.treeAdapter.createElement(k.HTML,W.HTML,[]);this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(e,null),this.treeAdapter.appendChild(this.openElements.current,e),this.openElements.push(e,h.HTML)}_appendCommentNode(e,n){const r=this.treeAdapter.createCommentNode(e.data);this.treeAdapter.appendChild(n,r),this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(r,e.location)}_insertCharacters(e){let n,r;if(this._shouldFosterParentOnInsertion()?({parent:n,beforeElement:r}=this._findFosterParentingLocation(),r?this.treeAdapter.insertTextBefore(n,e.chars,r):this.treeAdapter.insertText(n,e.chars)):(n=this.openElements.currentTmplContentOrNode,this.treeAdapter.insertText(n,e.chars)),!e.location)return;const s=this.treeAdapter.getChildNodes(n),a=r?s.lastIndexOf(r):s.length,i=s[a-1];if(this.treeAdapter.getNodeSourceCodeLocation(i)){const{endLine:u,endCol:c,endOffset:l}=e.location;this.treeAdapter.updateNodeSourceCodeLocation(i,{endLine:u,endCol:c,endOffset:l})}else this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(i,e.location)}_adoptNodes(e,n){for(let r=this.treeAdapter.getFirstChild(e);r;r=this.treeAdapter.getFirstChild(e))this.treeAdapter.detachNode(r),this.treeAdapter.appendChild(n,r)}_setEndLocation(e,n){if(this.treeAdapter.getNodeSourceCodeLocation(e)&&n.location){const r=n.location,s=this.treeAdapter.getTagName(e),a=n.type===Me.END_TAG&&s===n.tagName?{endTag:{...r},endLine:r.endLine,endCol:r.endCol,endOffset:r.endOffset}:{endLine:r.startLine,endCol:r.startCol,endOffset:r.startOffset};this.treeAdapter.updateNodeSourceCodeLocation(e,a)}}shouldProcessStartTagTokenInForeignContent(e){if(!this.currentNotInHTML)return!1;let n,r;return this.openElements.stackTop===0&&this.fragmentContext?(n=this.fragmentContext,r=this.fragmentContextID):{current:n,currentTagId:r}=this.openElements,e.tagID===h.SVG&&this.treeAdapter.getTagName(n)===k.ANNOTATION_XML&&this.treeAdapter.getNamespaceURI(n)===W.MATHML?!1:this.tokenizer.inForeignNode||(e.tagID===h.MGLYPH||e.tagID===h.MALIGNMARK)&&!this._isIntegrationPoint(r,n,W.HTML)}_processToken(e){switch(e.type){case Me.CHARACTER:{this.onCharacter(e);break}case Me.NULL_CHARACTER:{this.onNullCharacter(e);break}case Me.COMMENT:{this.onComment(e);break}case Me.DOCTYPE:{this.onDoctype(e);break}case Me.START_TAG:{this._processStartTag(e);break}case Me.END_TAG:{this.onEndTag(e);break}case Me.EOF:{this.onEof(e);break}case Me.WHITESPACE_CHARACTER:{this.onWhitespaceCharacter(e);break}}}_isIntegrationPoint(e,n,r){const s=this.treeAdapter.getNamespaceURI(n),a=this.treeAdapter.getAttrList(n);return A8(e,s,a,r)}_reconstructActiveFormattingElements(){const e=this.activeFormattingElements.entries.length;if(e){const n=this.activeFormattingElements.entries.findIndex(s=>s.type===sr.Marker||this.openElements.contains(s.element)),r=n<0?e-1:n-1;for(let s=r;s>=0;s--){const a=this.activeFormattingElements.entries[s];this._insertElement(a.token,this.treeAdapter.getNamespaceURI(a.element)),a.element=this.openElements.current}}}_closeTableCell(){this.openElements.generateImpliedEndTags(),this.openElements.popUntilTableCellPopped(),this.activeFormattingElements.clearToLastMarker(),this.insertionMode=S.IN_ROW}_closePElement(){this.openElements.generateImpliedEndTagsWithExclusion(h.P),this.openElements.popUntilTagNamePopped(h.P)}_resetInsertionMode(){for(let e=this.openElements.stackTop;e>=0;e--)switch(e===0&&this.fragmentContext?this.fragmentContextID:this.openElements.tagIDs[e]){case h.TR:{this.insertionMode=S.IN_ROW;return}case h.TBODY:case h.THEAD:case h.TFOOT:{this.insertionMode=S.IN_TABLE_BODY;return}case h.CAPTION:{this.insertionMode=S.IN_CAPTION;return}case h.COLGROUP:{this.insertionMode=S.IN_COLUMN_GROUP;return}case h.TABLE:{this.insertionMode=S.IN_TABLE;return}case h.BODY:{this.insertionMode=S.IN_BODY;return}case h.FRAMESET:{this.insertionMode=S.IN_FRAMESET;return}case h.SELECT:{this._resetInsertionModeForSelect(e);return}case h.TEMPLATE:{this.insertionMode=this.tmplInsertionModeStack[0];return}case h.HTML:{this.insertionMode=this.headElement?S.AFTER_HEAD:S.BEFORE_HEAD;return}case h.TD:case h.TH:{if(e>0){this.insertionMode=S.IN_CELL;return}break}case h.HEAD:{if(e>0){this.insertionMode=S.IN_HEAD;return}break}}this.insertionMode=S.IN_BODY}_resetInsertionModeForSelect(e){if(e>0)for(let n=e-1;n>0;n--){const r=this.openElements.tagIDs[n];if(r===h.TEMPLATE)break;if(r===h.TABLE){this.insertionMode=S.IN_SELECT_IN_TABLE;return}}this.insertionMode=S.IN_SELECT}_isElementCausesFosterParenting(e){return yw.has(e)}_shouldFosterParentOnInsertion(){return this.fosterParentingEnabled&&this._isElementCausesFosterParenting(this.openElements.currentTagId)}_findFosterParentingLocation(){for(let e=this.openElements.stackTop;e>=0;e--){const n=this.openElements.items[e];switch(this.openElements.tagIDs[e]){case h.TEMPLATE:{if(this.treeAdapter.getNamespaceURI(n)===W.HTML)return{parent:this.treeAdapter.getTemplateContent(n),beforeElement:null};break}case h.TABLE:{const r=this.treeAdapter.getParentNode(n);return r?{parent:r,beforeElement:n}:{parent:this.openElements.items[e-1],beforeElement:null}}}}return{parent:this.openElements.items[0],beforeElement:null}}_fosterParentElement(e){const n=this._findFosterParentingLocation();n.beforeElement?this.treeAdapter.insertBefore(n.parent,e,n.beforeElement):this.treeAdapter.appendChild(n.parent,e)}_isSpecialElement(e,n){const r=this.treeAdapter.getNamespaceURI(e);return WM[r].has(n)}onCharacter(e){if(this.skipNextNewLine=!1,this.tokenizer.inForeignNode){sB(this,e);return}switch(this.insertionMode){case S.INITIAL:{za(this,e);break}case S.BEFORE_HTML:{pi(this,e);break}case S.BEFORE_HEAD:{gi(this,e);break}case S.IN_HEAD:{bi(this,e);break}case S.IN_HEAD_NO_SCRIPT:{_i(this,e);break}case S.AFTER_HEAD:{yi(this,e);break}case S.IN_BODY:case S.IN_CAPTION:case S.IN_CELL:case S.IN_TEMPLATE:{Tw(this,e);break}case S.TEXT:case S.IN_SELECT:case S.IN_SELECT_IN_TABLE:{this._insertCharacters(e);break}case S.IN_TABLE:case S.IN_TABLE_BODY:case S.IN_ROW:{Id(this,e);break}case S.IN_TABLE_TEXT:{Iw(this,e);break}case S.IN_COLUMN_GROUP:{fc(this,e);break}case S.AFTER_BODY:{mc(this,e);break}case S.AFTER_AFTER_BODY:{Ou(this,e);break}}}onNullCharacter(e){if(this.skipNextNewLine=!1,this.tokenizer.inForeignNode){rB(this,e);return}switch(this.insertionMode){case S.INITIAL:{za(this,e);break}case S.BEFORE_HTML:{pi(this,e);break}case S.BEFORE_HEAD:{gi(this,e);break}case S.IN_HEAD:{bi(this,e);break}case S.IN_HEAD_NO_SCRIPT:{_i(this,e);break}case S.AFTER_HEAD:{yi(this,e);break}case S.TEXT:{this._insertCharacters(e);break}case S.IN_TABLE:case S.IN_TABLE_BODY:case S.IN_ROW:{Id(this,e);break}case S.IN_COLUMN_GROUP:{fc(this,e);break}case S.AFTER_BODY:{mc(this,e);break}case S.AFTER_AFTER_BODY:{Ou(this,e);break}}}onComment(e){if(this.skipNextNewLine=!1,this.currentNotInHTML){zh(this,e);return}switch(this.insertionMode){case S.INITIAL:case S.BEFORE_HTML:case S.BEFORE_HEAD:case S.IN_HEAD:case S.IN_HEAD_NO_SCRIPT:case S.AFTER_HEAD:case S.IN_BODY:case S.IN_TABLE:case S.IN_CAPTION:case S.IN_COLUMN_GROUP:case S.IN_TABLE_BODY:case S.IN_ROW:case S.IN_CELL:case S.IN_SELECT:case S.IN_SELECT_IN_TABLE:case S.IN_TEMPLATE:case S.IN_FRAMESET:case S.AFTER_FRAMESET:{zh(this,e);break}case S.IN_TABLE_TEXT:{Wa(this,e);break}case S.AFTER_BODY:{D8(this,e);break}case S.AFTER_AFTER_BODY:case S.AFTER_AFTER_FRAMESET:{M8(this,e);break}}}onDoctype(e){switch(this.skipNextNewLine=!1,this.insertionMode){case S.INITIAL:{B8(this,e);break}case S.BEFORE_HEAD:case S.IN_HEAD:case S.IN_HEAD_NO_SCRIPT:case S.AFTER_HEAD:{this._err(e,F.misplacedDoctype);break}case S.IN_TABLE_TEXT:{Wa(this,e);break}}}onStartTag(e){this.skipNextNewLine=!1,this.currentToken=e,this._processStartTag(e),e.selfClosing&&!e.ackSelfClosing&&this._err(e,F.nonVoidHtmlElementStartTagWithTrailingSolidus)}_processStartTag(e){this.shouldProcessStartTagTokenInForeignContent(e)?aB(this,e):this._startTagOutsideForeignContent(e)}_startTagOutsideForeignContent(e){switch(this.insertionMode){case S.INITIAL:{za(this,e);break}case S.BEFORE_HTML:{F8(this,e);break}case S.BEFORE_HEAD:{j8(this,e);break}case S.IN_HEAD:{Zn(this,e);break}case S.IN_HEAD_NO_SCRIPT:{q8(this,e);break}case S.AFTER_HEAD:{z8(this,e);break}case S.IN_BODY:{Mt(this,e);break}case S.IN_TABLE:{ma(this,e);break}case S.IN_TABLE_TEXT:{Wa(this,e);break}case S.IN_CAPTION:{$5(this,e);break}case S.IN_COLUMN_GROUP:{Im(this,e);break}case S.IN_TABLE_BODY:{hl(this,e);break}case S.IN_ROW:{fl(this,e);break}case S.IN_CELL:{V5(this,e);break}case S.IN_SELECT:{Rw(this,e);break}case S.IN_SELECT_IN_TABLE:{W5(this,e);break}case S.IN_TEMPLATE:{K5(this,e);break}case S.AFTER_BODY:{Z5(this,e);break}case S.IN_FRAMESET:{J5(this,e);break}case S.AFTER_FRAMESET:{Q5(this,e);break}case S.AFTER_AFTER_BODY:{tB(this,e);break}case S.AFTER_AFTER_FRAMESET:{nB(this,e);break}}}onEndTag(e){this.skipNextNewLine=!1,this.currentToken=e,this.currentNotInHTML?iB(this,e):this._endTagOutsideForeignContent(e)}_endTagOutsideForeignContent(e){switch(this.insertionMode){case S.INITIAL:{za(this,e);break}case S.BEFORE_HTML:{U8(this,e);break}case S.BEFORE_HEAD:{$8(this,e);break}case S.IN_HEAD:{H8(this,e);break}case S.IN_HEAD_NO_SCRIPT:{V8(this,e);break}case S.AFTER_HEAD:{W8(this,e);break}case S.IN_BODY:{dl(this,e);break}case S.TEXT:{R5(this,e);break}case S.IN_TABLE:{Yi(this,e);break}case S.IN_TABLE_TEXT:{Wa(this,e);break}case S.IN_CAPTION:{H5(this,e);break}case S.IN_COLUMN_GROUP:{q5(this,e);break}case S.IN_TABLE_BODY:{Wh(this,e);break}case S.IN_ROW:{kw(this,e);break}case S.IN_CELL:{z5(this,e);break}case S.IN_SELECT:{Pw(this,e);break}case S.IN_SELECT_IN_TABLE:{G5(this,e);break}case S.IN_TEMPLATE:{Y5(this,e);break}case S.AFTER_BODY:{Lw(this,e);break}case S.IN_FRAMESET:{X5(this,e);break}case S.AFTER_FRAMESET:{eB(this,e);break}case S.AFTER_AFTER_BODY:{Ou(this,e);break}}}onEof(e){switch(this.insertionMode){case S.INITIAL:{za(this,e);break}case S.BEFORE_HTML:{pi(this,e);break}case S.BEFORE_HEAD:{gi(this,e);break}case S.IN_HEAD:{bi(this,e);break}case S.IN_HEAD_NO_SCRIPT:{_i(this,e);break}case S.AFTER_HEAD:{yi(this,e);break}case S.IN_BODY:case S.IN_TABLE:case S.IN_CAPTION:case S.IN_COLUMN_GROUP:case S.IN_TABLE_BODY:case S.IN_ROW:case S.IN_CELL:case S.IN_SELECT:case S.IN_SELECT_IN_TABLE:{Ow(this,e);break}case S.TEXT:{P5(this,e);break}case S.IN_TABLE_TEXT:{Wa(this,e);break}case S.IN_TEMPLATE:{xw(this,e);break}case S.AFTER_BODY:case S.IN_FRAMESET:case S.AFTER_FRAMESET:case S.AFTER_AFTER_BODY:case S.AFTER_AFTER_FRAMESET:{vm(this,e);break}}}onWhitespaceCharacter(e){if(this.skipNextNewLine&&(this.skipNextNewLine=!1,e.chars.charCodeAt(0)===y.LINE_FEED)){if(e.chars.length===1)return;e.chars=e.chars.substr(1)}if(this.tokenizer.inForeignNode){this._insertCharacters(e);return}switch(this.insertionMode){case S.IN_HEAD:case S.IN_HEAD_NO_SCRIPT:case S.AFTER_HEAD:case S.TEXT:case S.IN_COLUMN_GROUP:case S.IN_SELECT:case S.IN_SELECT_IN_TABLE:case S.IN_FRAMESET:case S.AFTER_FRAMESET:{this._insertCharacters(e);break}case S.IN_BODY:case S.IN_CAPTION:case S.IN_CELL:case S.IN_TEMPLATE:case S.AFTER_BODY:case S.AFTER_AFTER_BODY:case S.AFTER_AFTER_FRAMESET:{ww(this,e);break}case S.IN_TABLE:case S.IN_TABLE_BODY:case S.IN_ROW:{Id(this,e);break}case S.IN_TABLE_TEXT:{vw(this,e);break}}}};function N8(t,e){let n=t.activeFormattingElements.getElementEntryInScopeWithTagName(e.tagName);return n?t.openElements.contains(n.element)?t.openElements.hasInScope(e.tagID)||(n=null):(t.activeFormattingElements.removeEntry(n),n=null):Cw(t,e),n}function k8(t,e){let n=null,r=t.openElements.stackTop;for(;r>=0;r--){const s=t.openElements.items[r];if(s===e.element)break;t._isSpecialElement(s,t.openElements.tagIDs[r])&&(n=s)}return n||(t.openElements.shortenToLength(r<0?0:r),t.activeFormattingElements.removeEntry(e)),n}function R8(t,e,n){let r=e,s=t.openElements.getCommonAncestor(e);for(let a=0,i=s;i!==n;a++,i=s){s=t.openElements.getCommonAncestor(i);const o=t.activeFormattingElements.getElementEntry(i),u=o&&a>=v8;!o||u?(u&&t.activeFormattingElements.removeEntry(o),t.openElements.remove(i)):(i=P8(t,o),r===e&&(t.activeFormattingElements.bookmark=o),t.treeAdapter.detachNode(r),t.treeAdapter.appendChild(i,r),r=i)}return r}function P8(t,e){const n=t.treeAdapter.getNamespaceURI(e.element),r=t.treeAdapter.createElement(e.token.tagName,n,e.token.attrs);return t.openElements.replace(e.element,r),e.element=r,r}function x8(t,e,n){const r=t.treeAdapter.getTagName(e),s=cl(r);if(t._isElementCausesFosterParenting(s))t._fosterParentElement(n);else{const a=t.treeAdapter.getNamespaceURI(e);s===h.TEMPLATE&&a===W.HTML&&(e=t.treeAdapter.getTemplateContent(e)),t.treeAdapter.appendChild(e,n)}}function L8(t,e,n){const r=t.treeAdapter.getNamespaceURI(n.element),{token:s}=n,a=t.treeAdapter.createElement(s.tagName,r,s.attrs);t._adoptNodes(e,a),t.treeAdapter.appendChild(e,a),t.activeFormattingElements.insertElementAfterBookmark(a,s),t.activeFormattingElements.removeEntry(n),t.openElements.remove(n.element),t.openElements.insertAfter(e,a,s.tagID)}function Om(t,e){for(let n=0;n<O8;n++){const r=N8(t,e);if(!r)break;const s=k8(t,r);if(!s)break;t.activeFormattingElements.bookmark=r;const a=R8(t,s,r.element),i=t.openElements.getCommonAncestor(r.element);t.treeAdapter.detachNode(a),i&&x8(t,i,a),L8(t,s,r)}}function zh(t,e){t._appendCommentNode(e,t.openElements.currentTmplContentOrNode)}function D8(t,e){t._appendCommentNode(e,t.openElements.items[0])}function M8(t,e){t._appendCommentNode(e,t.document)}function vm(t,e){if(t.stopped=!0,e.location){const n=t.fragmentContext?0:2;for(let r=t.openElements.stackTop;r>=n;r--)t._setEndLocation(t.openElements.items[r],e);if(!t.fragmentContext&&t.openElements.stackTop>=0){const r=t.openElements.items[0],s=t.treeAdapter.getNodeSourceCodeLocation(r);if(s&&!s.endTag&&(t._setEndLocation(r,e),t.openElements.stackTop>=1)){const a=t.openElements.items[1],i=t.treeAdapter.getNodeSourceCodeLocation(a);i&&!i.endTag&&t._setEndLocation(a,e)}}}}function B8(t,e){t._setDocumentType(e);const n=e.forceQuirks?ln.QUIRKS:f8(e);h8(e)||t._err(e,F.nonConformingDoctype),t.treeAdapter.setDocumentMode(t.document,n),t.insertionMode=S.BEFORE_HTML}function za(t,e){t._err(e,F.missingDoctype,!0),t.treeAdapter.setDocumentMode(t.document,ln.QUIRKS),t.insertionMode=S.BEFORE_HTML,t._processToken(e)}function F8(t,e){e.tagID===h.HTML?(t._insertElement(e,W.HTML),t.insertionMode=S.BEFORE_HEAD):pi(t,e)}function U8(t,e){const n=e.tagID;(n===h.HTML||n===h.HEAD||n===h.BODY||n===h.BR)&&pi(t,e)}function pi(t,e){t._insertFakeRootElement(),t.insertionMode=S.BEFORE_HEAD,t._processToken(e)}function j8(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.HEAD:{t._insertElement(e,W.HTML),t.headElement=t.openElements.current,t.insertionMode=S.IN_HEAD;break}default:gi(t,e)}}function $8(t,e){const n=e.tagID;n===h.HEAD||n===h.BODY||n===h.HTML||n===h.BR?gi(t,e):t._err(e,F.endTagWithoutMatchingOpenElement)}function gi(t,e){t._insertFakeElement(k.HEAD,h.HEAD),t.headElement=t.openElements.current,t.insertionMode=S.IN_HEAD,t._processToken(e)}function Zn(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.BASE:case h.BASEFONT:case h.BGSOUND:case h.LINK:case h.META:{t._appendElement(e,W.HTML),e.ackSelfClosing=!0;break}case h.TITLE:{t._switchToTextParsing(e,Jt.RCDATA);break}case h.NOSCRIPT:{t.options.scriptingEnabled?t._switchToTextParsing(e,Jt.RAWTEXT):(t._insertElement(e,W.HTML),t.insertionMode=S.IN_HEAD_NO_SCRIPT);break}case h.NOFRAMES:case h.STYLE:{t._switchToTextParsing(e,Jt.RAWTEXT);break}case h.SCRIPT:{t._switchToTextParsing(e,Jt.SCRIPT_DATA);break}case h.TEMPLATE:{t._insertTemplate(e),t.activeFormattingElements.insertMarker(),t.framesetOk=!1,t.insertionMode=S.IN_TEMPLATE,t.tmplInsertionModeStack.unshift(S.IN_TEMPLATE);break}case h.HEAD:{t._err(e,F.misplacedStartTagForHeadElement);break}default:bi(t,e)}}function H8(t,e){switch(e.tagID){case h.HEAD:{t.openElements.pop(),t.insertionMode=S.AFTER_HEAD;break}case h.BODY:case h.BR:case h.HTML:{bi(t,e);break}case h.TEMPLATE:{ks(t,e);break}default:t._err(e,F.endTagWithoutMatchingOpenElement)}}function ks(t,e){t.openElements.tmplCount>0?(t.openElements.generateImpliedEndTagsThoroughly(),t.openElements.currentTagId!==h.TEMPLATE&&t._err(e,F.closingOfElementWithOpenChildElements),t.openElements.popUntilTagNamePopped(h.TEMPLATE),t.activeFormattingElements.clearToLastMarker(),t.tmplInsertionModeStack.shift(),t._resetInsertionMode()):t._err(e,F.endTagWithoutMatchingOpenElement)}function bi(t,e){t.openElements.pop(),t.insertionMode=S.AFTER_HEAD,t._processToken(e)}function q8(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.BASEFONT:case h.BGSOUND:case h.HEAD:case h.LINK:case h.META:case h.NOFRAMES:case h.STYLE:{Zn(t,e);break}case h.NOSCRIPT:{t._err(e,F.nestedNoscriptInHead);break}default:_i(t,e)}}function V8(t,e){switch(e.tagID){case h.NOSCRIPT:{t.openElements.pop(),t.insertionMode=S.IN_HEAD;break}case h.BR:{_i(t,e);break}default:t._err(e,F.endTagWithoutMatchingOpenElement)}}function _i(t,e){const n=e.type===Me.EOF?F.openElementsLeftAfterEof:F.disallowedContentInNoscriptInHead;t._err(e,n),t.openElements.pop(),t.insertionMode=S.IN_HEAD,t._processToken(e)}function z8(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.BODY:{t._insertElement(e,W.HTML),t.framesetOk=!1,t.insertionMode=S.IN_BODY;break}case h.FRAMESET:{t._insertElement(e,W.HTML),t.insertionMode=S.IN_FRAMESET;break}case h.BASE:case h.BASEFONT:case h.BGSOUND:case h.LINK:case h.META:case h.NOFRAMES:case h.SCRIPT:case h.STYLE:case h.TEMPLATE:case h.TITLE:{t._err(e,F.abandonedHeadElementChild),t.openElements.push(t.headElement,h.HEAD),Zn(t,e),t.openElements.remove(t.headElement);break}case h.HEAD:{t._err(e,F.misplacedStartTagForHeadElement);break}default:yi(t,e)}}function W8(t,e){switch(e.tagID){case h.BODY:case h.HTML:case h.BR:{yi(t,e);break}case h.TEMPLATE:{ks(t,e);break}default:t._err(e,F.endTagWithoutMatchingOpenElement)}}function yi(t,e){t._insertFakeElement(k.BODY,h.BODY),t.insertionMode=S.IN_BODY,ll(t,e)}function ll(t,e){switch(e.type){case Me.CHARACTER:{Tw(t,e);break}case Me.WHITESPACE_CHARACTER:{ww(t,e);break}case Me.COMMENT:{zh(t,e);break}case Me.START_TAG:{Mt(t,e);break}case Me.END_TAG:{dl(t,e);break}case Me.EOF:{Ow(t,e);break}}}function ww(t,e){t._reconstructActiveFormattingElements(),t._insertCharacters(e)}function Tw(t,e){t._reconstructActiveFormattingElements(),t._insertCharacters(e),t.framesetOk=!1}function G8(t,e){t.openElements.tmplCount===0&&t.treeAdapter.adoptAttributes(t.openElements.items[0],e.attrs)}function K8(t,e){const n=t.openElements.tryPeekProperlyNestedBodyElement();n&&t.openElements.tmplCount===0&&(t.framesetOk=!1,t.treeAdapter.adoptAttributes(n,e.attrs))}function Y8(t,e){const n=t.openElements.tryPeekProperlyNestedBodyElement();t.framesetOk&&n&&(t.treeAdapter.detachNode(n),t.openElements.popAllUpToHtmlElement(),t._insertElement(e,W.HTML),t.insertionMode=S.IN_FRAMESET)}function Z8(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,W.HTML)}function J8(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),Vh.has(t.openElements.currentTagId)&&t.openElements.pop(),t._insertElement(e,W.HTML)}function X8(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,W.HTML),t.skipNextNewLine=!0,t.framesetOk=!1}function Q8(t,e){const n=t.openElements.tmplCount>0;(!t.formElement||n)&&(t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,W.HTML),n||(t.formElement=t.openElements.current))}function e5(t,e){t.framesetOk=!1;const n=e.tagID;for(let r=t.openElements.stackTop;r>=0;r--){const s=t.openElements.tagIDs[r];if(n===h.LI&&s===h.LI||(n===h.DD||n===h.DT)&&(s===h.DD||s===h.DT)){t.openElements.generateImpliedEndTagsWithExclusion(s),t.openElements.popUntilTagNamePopped(s);break}if(s!==h.ADDRESS&&s!==h.DIV&&s!==h.P&&t._isSpecialElement(t.openElements.items[r],s))break}t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,W.HTML)}function t5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,W.HTML),t.tokenizer.state=Jt.PLAINTEXT}function n5(t,e){t.openElements.hasInScope(h.BUTTON)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(h.BUTTON)),t._reconstructActiveFormattingElements(),t._insertElement(e,W.HTML),t.framesetOk=!1}function r5(t,e){const n=t.activeFormattingElements.getElementEntryInScopeWithTagName(k.A);n&&(Om(t,e),t.openElements.remove(n.element),t.activeFormattingElements.removeEntry(n)),t._reconstructActiveFormattingElements(),t._insertElement(e,W.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function s5(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,W.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function a5(t,e){t._reconstructActiveFormattingElements(),t.openElements.hasInScope(h.NOBR)&&(Om(t,e),t._reconstructActiveFormattingElements()),t._insertElement(e,W.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function i5(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,W.HTML),t.activeFormattingElements.insertMarker(),t.framesetOk=!1}function o5(t,e){t.treeAdapter.getDocumentMode(t.document)!==ln.QUIRKS&&t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._insertElement(e,W.HTML),t.framesetOk=!1,t.insertionMode=S.IN_TABLE}function Sw(t,e){t._reconstructActiveFormattingElements(),t._appendElement(e,W.HTML),t.framesetOk=!1,e.ackSelfClosing=!0}function Aw(t){const e=dw(t,ps.TYPE);return e!=null&&e.toLowerCase()===C8}function u5(t,e){t._reconstructActiveFormattingElements(),t._appendElement(e,W.HTML),Aw(e)||(t.framesetOk=!1),e.ackSelfClosing=!0}function c5(t,e){t._appendElement(e,W.HTML),e.ackSelfClosing=!0}function l5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._appendElement(e,W.HTML),t.framesetOk=!1,e.ackSelfClosing=!0}function d5(t,e){e.tagName=k.IMG,e.tagID=h.IMG,Sw(t,e)}function h5(t,e){t._insertElement(e,W.HTML),t.skipNextNewLine=!0,t.tokenizer.state=Jt.RCDATA,t.originalInsertionMode=t.insertionMode,t.framesetOk=!1,t.insertionMode=S.TEXT}function f5(t,e){t.openElements.hasInButtonScope(h.P)&&t._closePElement(),t._reconstructActiveFormattingElements(),t.framesetOk=!1,t._switchToTextParsing(e,Jt.RAWTEXT)}function m5(t,e){t.framesetOk=!1,t._switchToTextParsing(e,Jt.RAWTEXT)}function B0(t,e){t._switchToTextParsing(e,Jt.RAWTEXT)}function p5(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,W.HTML),t.framesetOk=!1,t.insertionMode=t.insertionMode===S.IN_TABLE||t.insertionMode===S.IN_CAPTION||t.insertionMode===S.IN_TABLE_BODY||t.insertionMode===S.IN_ROW||t.insertionMode===S.IN_CELL?S.IN_SELECT_IN_TABLE:S.IN_SELECT}function g5(t,e){t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t._reconstructActiveFormattingElements(),t._insertElement(e,W.HTML)}function b5(t,e){t.openElements.hasInScope(h.RUBY)&&t.openElements.generateImpliedEndTags(),t._insertElement(e,W.HTML)}function _5(t,e){t.openElements.hasInScope(h.RUBY)&&t.openElements.generateImpliedEndTagsWithExclusion(h.RTC),t._insertElement(e,W.HTML)}function y5(t,e){t._reconstructActiveFormattingElements(),bw(e),Cm(e),e.selfClosing?t._appendElement(e,W.MATHML):t._insertElement(e,W.MATHML),e.ackSelfClosing=!0}function E5(t,e){t._reconstructActiveFormattingElements(),_w(e),Cm(e),e.selfClosing?t._appendElement(e,W.SVG):t._insertElement(e,W.SVG),e.ackSelfClosing=!0}function F0(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,W.HTML)}function Mt(t,e){switch(e.tagID){case h.I:case h.S:case h.B:case h.U:case h.EM:case h.TT:case h.BIG:case h.CODE:case h.FONT:case h.SMALL:case h.STRIKE:case h.STRONG:{s5(t,e);break}case h.A:{r5(t,e);break}case h.H1:case h.H2:case h.H3:case h.H4:case h.H5:case h.H6:{J8(t,e);break}case h.P:case h.DL:case h.OL:case h.UL:case h.DIV:case h.DIR:case h.NAV:case h.MAIN:case h.MENU:case h.ASIDE:case h.CENTER:case h.FIGURE:case h.FOOTER:case h.HEADER:case h.HGROUP:case h.DIALOG:case h.DETAILS:case h.ADDRESS:case h.ARTICLE:case h.SEARCH:case h.SECTION:case h.SUMMARY:case h.FIELDSET:case h.BLOCKQUOTE:case h.FIGCAPTION:{Z8(t,e);break}case h.LI:case h.DD:case h.DT:{e5(t,e);break}case h.BR:case h.IMG:case h.WBR:case h.AREA:case h.EMBED:case h.KEYGEN:{Sw(t,e);break}case h.HR:{l5(t,e);break}case h.RB:case h.RTC:{b5(t,e);break}case h.RT:case h.RP:{_5(t,e);break}case h.PRE:case h.LISTING:{X8(t,e);break}case h.XMP:{f5(t,e);break}case h.SVG:{E5(t,e);break}case h.HTML:{G8(t,e);break}case h.BASE:case h.LINK:case h.META:case h.STYLE:case h.TITLE:case h.SCRIPT:case h.BGSOUND:case h.BASEFONT:case h.TEMPLATE:{Zn(t,e);break}case h.BODY:{K8(t,e);break}case h.FORM:{Q8(t,e);break}case h.NOBR:{a5(t,e);break}case h.MATH:{y5(t,e);break}case h.TABLE:{o5(t,e);break}case h.INPUT:{u5(t,e);break}case h.PARAM:case h.TRACK:case h.SOURCE:{c5(t,e);break}case h.IMAGE:{d5(t,e);break}case h.BUTTON:{n5(t,e);break}case h.APPLET:case h.OBJECT:case h.MARQUEE:{i5(t,e);break}case h.IFRAME:{m5(t,e);break}case h.SELECT:{p5(t,e);break}case h.OPTION:case h.OPTGROUP:{g5(t,e);break}case h.NOEMBED:case h.NOFRAMES:{B0(t,e);break}case h.FRAMESET:{Y8(t,e);break}case h.TEXTAREA:{h5(t,e);break}case h.NOSCRIPT:{t.options.scriptingEnabled?B0(t,e):F0(t,e);break}case h.PLAINTEXT:{t5(t,e);break}case h.COL:case h.TH:case h.TD:case h.TR:case h.HEAD:case h.FRAME:case h.TBODY:case h.TFOOT:case h.THEAD:case h.CAPTION:case h.COLGROUP:break;default:F0(t,e)}}function w5(t,e){if(t.openElements.hasInScope(h.BODY)&&(t.insertionMode=S.AFTER_BODY,t.options.sourceCodeLocationInfo)){const n=t.openElements.tryPeekProperlyNestedBodyElement();n&&t._setEndLocation(n,e)}}function T5(t,e){t.openElements.hasInScope(h.BODY)&&(t.insertionMode=S.AFTER_BODY,Lw(t,e))}function S5(t,e){const n=e.tagID;t.openElements.hasInScope(n)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(n))}function A5(t){const e=t.openElements.tmplCount>0,{formElement:n}=t;e||(t.formElement=null),(n||e)&&t.openElements.hasInScope(h.FORM)&&(t.openElements.generateImpliedEndTags(),e?t.openElements.popUntilTagNamePopped(h.FORM):n&&t.openElements.remove(n))}function C5(t){t.openElements.hasInButtonScope(h.P)||t._insertFakeElement(k.P,h.P),t._closePElement()}function O5(t){t.openElements.hasInListItemScope(h.LI)&&(t.openElements.generateImpliedEndTagsWithExclusion(h.LI),t.openElements.popUntilTagNamePopped(h.LI))}function v5(t,e){const n=e.tagID;t.openElements.hasInScope(n)&&(t.openElements.generateImpliedEndTagsWithExclusion(n),t.openElements.popUntilTagNamePopped(n))}function I5(t){t.openElements.hasNumberedHeaderInScope()&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilNumberedHeaderPopped())}function N5(t,e){const n=e.tagID;t.openElements.hasInScope(n)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(n),t.activeFormattingElements.clearToLastMarker())}function k5(t){t._reconstructActiveFormattingElements(),t._insertFakeElement(k.BR,h.BR),t.openElements.pop(),t.framesetOk=!1}function Cw(t,e){const n=e.tagName,r=e.tagID;for(let s=t.openElements.stackTop;s>0;s--){const a=t.openElements.items[s],i=t.openElements.tagIDs[s];if(r===i&&(r!==h.UNKNOWN||t.treeAdapter.getTagName(a)===n)){t.openElements.generateImpliedEndTagsWithExclusion(r),t.openElements.stackTop>=s&&t.openElements.shortenToLength(s);break}if(t._isSpecialElement(a,i))break}}function dl(t,e){switch(e.tagID){case h.A:case h.B:case h.I:case h.S:case h.U:case h.EM:case h.TT:case h.BIG:case h.CODE:case h.FONT:case h.NOBR:case h.SMALL:case h.STRIKE:case h.STRONG:{Om(t,e);break}case h.P:{C5(t);break}case h.DL:case h.UL:case h.OL:case h.DIR:case h.DIV:case h.NAV:case h.PRE:case h.MAIN:case h.MENU:case h.ASIDE:case h.BUTTON:case h.CENTER:case h.FIGURE:case h.FOOTER:case h.HEADER:case h.HGROUP:case h.DIALOG:case h.ADDRESS:case h.ARTICLE:case h.DETAILS:case h.SEARCH:case h.SECTION:case h.SUMMARY:case h.LISTING:case h.FIELDSET:case h.BLOCKQUOTE:case h.FIGCAPTION:{S5(t,e);break}case h.LI:{O5(t);break}case h.DD:case h.DT:{v5(t,e);break}case h.H1:case h.H2:case h.H3:case h.H4:case h.H5:case h.H6:{I5(t);break}case h.BR:{k5(t);break}case h.BODY:{w5(t,e);break}case h.HTML:{T5(t,e);break}case h.FORM:{A5(t);break}case h.APPLET:case h.OBJECT:case h.MARQUEE:{N5(t,e);break}case h.TEMPLATE:{ks(t,e);break}default:Cw(t,e)}}function Ow(t,e){t.tmplInsertionModeStack.length>0?xw(t,e):vm(t,e)}function R5(t,e){var n;e.tagID===h.SCRIPT&&((n=t.scriptHandler)===null||n===void 0||n.call(t,t.openElements.current)),t.openElements.pop(),t.insertionMode=t.originalInsertionMode}function P5(t,e){t._err(e,F.eofInElementThatCanContainOnlyText),t.openElements.pop(),t.insertionMode=t.originalInsertionMode,t.onEof(e)}function Id(t,e){if(yw.has(t.openElements.currentTagId))switch(t.pendingCharacterTokens.length=0,t.hasNonWhitespacePendingCharacterToken=!1,t.originalInsertionMode=t.insertionMode,t.insertionMode=S.IN_TABLE_TEXT,e.type){case Me.CHARACTER:{Iw(t,e);break}case Me.WHITESPACE_CHARACTER:{vw(t,e);break}}else To(t,e)}function x5(t,e){t.openElements.clearBackToTableContext(),t.activeFormattingElements.insertMarker(),t._insertElement(e,W.HTML),t.insertionMode=S.IN_CAPTION}function L5(t,e){t.openElements.clearBackToTableContext(),t._insertElement(e,W.HTML),t.insertionMode=S.IN_COLUMN_GROUP}function D5(t,e){t.openElements.clearBackToTableContext(),t._insertFakeElement(k.COLGROUP,h.COLGROUP),t.insertionMode=S.IN_COLUMN_GROUP,Im(t,e)}function M5(t,e){t.openElements.clearBackToTableContext(),t._insertElement(e,W.HTML),t.insertionMode=S.IN_TABLE_BODY}function B5(t,e){t.openElements.clearBackToTableContext(),t._insertFakeElement(k.TBODY,h.TBODY),t.insertionMode=S.IN_TABLE_BODY,hl(t,e)}function F5(t,e){t.openElements.hasInTableScope(h.TABLE)&&(t.openElements.popUntilTagNamePopped(h.TABLE),t._resetInsertionMode(),t._processStartTag(e))}function U5(t,e){Aw(e)?t._appendElement(e,W.HTML):To(t,e),e.ackSelfClosing=!0}function j5(t,e){!t.formElement&&t.openElements.tmplCount===0&&(t._insertElement(e,W.HTML),t.formElement=t.openElements.current,t.openElements.pop())}function ma(t,e){switch(e.tagID){case h.TD:case h.TH:case h.TR:{B5(t,e);break}case h.STYLE:case h.SCRIPT:case h.TEMPLATE:{Zn(t,e);break}case h.COL:{D5(t,e);break}case h.FORM:{j5(t,e);break}case h.TABLE:{F5(t,e);break}case h.TBODY:case h.TFOOT:case h.THEAD:{M5(t,e);break}case h.INPUT:{U5(t,e);break}case h.CAPTION:{x5(t,e);break}case h.COLGROUP:{L5(t,e);break}default:To(t,e)}}function Yi(t,e){switch(e.tagID){case h.TABLE:{t.openElements.hasInTableScope(h.TABLE)&&(t.openElements.popUntilTagNamePopped(h.TABLE),t._resetInsertionMode());break}case h.TEMPLATE:{ks(t,e);break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:case h.TBODY:case h.TD:case h.TFOOT:case h.TH:case h.THEAD:case h.TR:break;default:To(t,e)}}function To(t,e){const n=t.fosterParentingEnabled;t.fosterParentingEnabled=!0,ll(t,e),t.fosterParentingEnabled=n}function vw(t,e){t.pendingCharacterTokens.push(e)}function Iw(t,e){t.pendingCharacterTokens.push(e),t.hasNonWhitespacePendingCharacterToken=!0}function Wa(t,e){let n=0;if(t.hasNonWhitespacePendingCharacterToken)for(;n<t.pendingCharacterTokens.length;n++)To(t,t.pendingCharacterTokens[n]);else for(;n<t.pendingCharacterTokens.length;n++)t._insertCharacters(t.pendingCharacterTokens[n]);t.insertionMode=t.originalInsertionMode,t._processToken(e)}const Nw=new Set([h.CAPTION,h.COL,h.COLGROUP,h.TBODY,h.TD,h.TFOOT,h.TH,h.THEAD,h.TR]);function $5(t,e){const n=e.tagID;Nw.has(n)?t.openElements.hasInTableScope(h.CAPTION)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(h.CAPTION),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=S.IN_TABLE,ma(t,e)):Mt(t,e)}function H5(t,e){const n=e.tagID;switch(n){case h.CAPTION:case h.TABLE:{t.openElements.hasInTableScope(h.CAPTION)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(h.CAPTION),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=S.IN_TABLE,n===h.TABLE&&Yi(t,e));break}case h.BODY:case h.COL:case h.COLGROUP:case h.HTML:case h.TBODY:case h.TD:case h.TFOOT:case h.TH:case h.THEAD:case h.TR:break;default:dl(t,e)}}function Im(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.COL:{t._appendElement(e,W.HTML),e.ackSelfClosing=!0;break}case h.TEMPLATE:{Zn(t,e);break}default:fc(t,e)}}function q5(t,e){switch(e.tagID){case h.COLGROUP:{t.openElements.currentTagId===h.COLGROUP&&(t.openElements.pop(),t.insertionMode=S.IN_TABLE);break}case h.TEMPLATE:{ks(t,e);break}case h.COL:break;default:fc(t,e)}}function fc(t,e){t.openElements.currentTagId===h.COLGROUP&&(t.openElements.pop(),t.insertionMode=S.IN_TABLE,t._processToken(e))}function hl(t,e){switch(e.tagID){case h.TR:{t.openElements.clearBackToTableBodyContext(),t._insertElement(e,W.HTML),t.insertionMode=S.IN_ROW;break}case h.TH:case h.TD:{t.openElements.clearBackToTableBodyContext(),t._insertFakeElement(k.TR,h.TR),t.insertionMode=S.IN_ROW,fl(t,e);break}case h.CAPTION:case h.COL:case h.COLGROUP:case h.TBODY:case h.TFOOT:case h.THEAD:{t.openElements.hasTableBodyContextInTableScope()&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=S.IN_TABLE,ma(t,e));break}default:ma(t,e)}}function Wh(t,e){const n=e.tagID;switch(e.tagID){case h.TBODY:case h.TFOOT:case h.THEAD:{t.openElements.hasInTableScope(n)&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=S.IN_TABLE);break}case h.TABLE:{t.openElements.hasTableBodyContextInTableScope()&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=S.IN_TABLE,Yi(t,e));break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:case h.TD:case h.TH:case h.TR:break;default:Yi(t,e)}}function fl(t,e){switch(e.tagID){case h.TH:case h.TD:{t.openElements.clearBackToTableRowContext(),t._insertElement(e,W.HTML),t.insertionMode=S.IN_CELL,t.activeFormattingElements.insertMarker();break}case h.CAPTION:case h.COL:case h.COLGROUP:case h.TBODY:case h.TFOOT:case h.THEAD:case h.TR:{t.openElements.hasInTableScope(h.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=S.IN_TABLE_BODY,hl(t,e));break}default:ma(t,e)}}function kw(t,e){switch(e.tagID){case h.TR:{t.openElements.hasInTableScope(h.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=S.IN_TABLE_BODY);break}case h.TABLE:{t.openElements.hasInTableScope(h.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=S.IN_TABLE_BODY,Wh(t,e));break}case h.TBODY:case h.TFOOT:case h.THEAD:{(t.openElements.hasInTableScope(e.tagID)||t.openElements.hasInTableScope(h.TR))&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=S.IN_TABLE_BODY,Wh(t,e));break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:case h.TD:case h.TH:break;default:Yi(t,e)}}function V5(t,e){const n=e.tagID;Nw.has(n)?(t.openElements.hasInTableScope(h.TD)||t.openElements.hasInTableScope(h.TH))&&(t._closeTableCell(),fl(t,e)):Mt(t,e)}function z5(t,e){const n=e.tagID;switch(n){case h.TD:case h.TH:{t.openElements.hasInTableScope(n)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(n),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=S.IN_ROW);break}case h.TABLE:case h.TBODY:case h.TFOOT:case h.THEAD:case h.TR:{t.openElements.hasInTableScope(n)&&(t._closeTableCell(),kw(t,e));break}case h.BODY:case h.CAPTION:case h.COL:case h.COLGROUP:case h.HTML:break;default:dl(t,e)}}function Rw(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.OPTION:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t._insertElement(e,W.HTML);break}case h.OPTGROUP:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t.openElements.currentTagId===h.OPTGROUP&&t.openElements.pop(),t._insertElement(e,W.HTML);break}case h.HR:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop(),t.openElements.currentTagId===h.OPTGROUP&&t.openElements.pop(),t._appendElement(e,W.HTML),e.ackSelfClosing=!0;break}case h.INPUT:case h.KEYGEN:case h.TEXTAREA:case h.SELECT:{t.openElements.hasInSelectScope(h.SELECT)&&(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode(),e.tagID!==h.SELECT&&t._processStartTag(e));break}case h.SCRIPT:case h.TEMPLATE:{Zn(t,e);break}}}function Pw(t,e){switch(e.tagID){case h.OPTGROUP:{t.openElements.stackTop>0&&t.openElements.currentTagId===h.OPTION&&t.openElements.tagIDs[t.openElements.stackTop-1]===h.OPTGROUP&&t.openElements.pop(),t.openElements.currentTagId===h.OPTGROUP&&t.openElements.pop();break}case h.OPTION:{t.openElements.currentTagId===h.OPTION&&t.openElements.pop();break}case h.SELECT:{t.openElements.hasInSelectScope(h.SELECT)&&(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode());break}case h.TEMPLATE:{ks(t,e);break}}}function W5(t,e){const n=e.tagID;n===h.CAPTION||n===h.TABLE||n===h.TBODY||n===h.TFOOT||n===h.THEAD||n===h.TR||n===h.TD||n===h.TH?(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode(),t._processStartTag(e)):Rw(t,e)}function G5(t,e){const n=e.tagID;n===h.CAPTION||n===h.TABLE||n===h.TBODY||n===h.TFOOT||n===h.THEAD||n===h.TR||n===h.TD||n===h.TH?t.openElements.hasInTableScope(n)&&(t.openElements.popUntilTagNamePopped(h.SELECT),t._resetInsertionMode(),t.onEndTag(e)):Pw(t,e)}function K5(t,e){switch(e.tagID){case h.BASE:case h.BASEFONT:case h.BGSOUND:case h.LINK:case h.META:case h.NOFRAMES:case h.SCRIPT:case h.STYLE:case h.TEMPLATE:case h.TITLE:{Zn(t,e);break}case h.CAPTION:case h.COLGROUP:case h.TBODY:case h.TFOOT:case h.THEAD:{t.tmplInsertionModeStack[0]=S.IN_TABLE,t.insertionMode=S.IN_TABLE,ma(t,e);break}case h.COL:{t.tmplInsertionModeStack[0]=S.IN_COLUMN_GROUP,t.insertionMode=S.IN_COLUMN_GROUP,Im(t,e);break}case h.TR:{t.tmplInsertionModeStack[0]=S.IN_TABLE_BODY,t.insertionMode=S.IN_TABLE_BODY,hl(t,e);break}case h.TD:case h.TH:{t.tmplInsertionModeStack[0]=S.IN_ROW,t.insertionMode=S.IN_ROW,fl(t,e);break}default:t.tmplInsertionModeStack[0]=S.IN_BODY,t.insertionMode=S.IN_BODY,Mt(t,e)}}function Y5(t,e){e.tagID===h.TEMPLATE&&ks(t,e)}function xw(t,e){t.openElements.tmplCount>0?(t.openElements.popUntilTagNamePopped(h.TEMPLATE),t.activeFormattingElements.clearToLastMarker(),t.tmplInsertionModeStack.shift(),t._resetInsertionMode(),t.onEof(e)):vm(t,e)}function Z5(t,e){e.tagID===h.HTML?Mt(t,e):mc(t,e)}function Lw(t,e){var n;if(e.tagID===h.HTML){if(t.fragmentContext||(t.insertionMode=S.AFTER_AFTER_BODY),t.options.sourceCodeLocationInfo&&t.openElements.tagIDs[0]===h.HTML){t._setEndLocation(t.openElements.items[0],e);const r=t.openElements.items[1];r&&!(!((n=t.treeAdapter.getNodeSourceCodeLocation(r))===null||n===void 0)&&n.endTag)&&t._setEndLocation(r,e)}}else mc(t,e)}function mc(t,e){t.insertionMode=S.IN_BODY,ll(t,e)}function J5(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.FRAMESET:{t._insertElement(e,W.HTML);break}case h.FRAME:{t._appendElement(e,W.HTML),e.ackSelfClosing=!0;break}case h.NOFRAMES:{Zn(t,e);break}}}function X5(t,e){e.tagID===h.FRAMESET&&!t.openElements.isRootHtmlElementCurrent()&&(t.openElements.pop(),!t.fragmentContext&&t.openElements.currentTagId!==h.FRAMESET&&(t.insertionMode=S.AFTER_FRAMESET))}function Q5(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.NOFRAMES:{Zn(t,e);break}}}function eB(t,e){e.tagID===h.HTML&&(t.insertionMode=S.AFTER_AFTER_FRAMESET)}function tB(t,e){e.tagID===h.HTML?Mt(t,e):Ou(t,e)}function Ou(t,e){t.insertionMode=S.IN_BODY,ll(t,e)}function nB(t,e){switch(e.tagID){case h.HTML:{Mt(t,e);break}case h.NOFRAMES:{Zn(t,e);break}}}function rB(t,e){e.chars=Qe,t._insertCharacters(e)}function sB(t,e){t._insertCharacters(e),t.framesetOk=!1}function Dw(t){for(;t.treeAdapter.getNamespaceURI(t.openElements.current)!==W.HTML&&!t._isIntegrationPoint(t.openElements.currentTagId,t.openElements.current);)t.openElements.pop()}function aB(t,e){if(E8(e))Dw(t),t._startTagOutsideForeignContent(e);else{const n=t._getAdjustedCurrentElement(),r=t.treeAdapter.getNamespaceURI(n);r===W.MATHML?bw(e):r===W.SVG&&(w8(e),_w(e)),Cm(e),e.selfClosing?t._appendElement(e,r):t._insertElement(e,r),e.ackSelfClosing=!0}}function iB(t,e){if(e.tagID===h.P||e.tagID===h.BR){Dw(t),t._endTagOutsideForeignContent(e);return}for(let n=t.openElements.stackTop;n>0;n--){const r=t.openElements.items[n];if(t.treeAdapter.getNamespaceURI(r)===W.HTML){t._endTagOutsideForeignContent(e);break}const s=t.treeAdapter.getTagName(r);if(s.toLowerCase()===e.tagName){e.tagName=s,t.openElements.shortenToLength(n);break}}}const oB=new Set([k.AREA,k.BASE,k.BASEFONT,k.BGSOUND,k.BR,k.COL,k.EMBED,k.FRAME,k.HR,k.IMG,k.INPUT,k.KEYGEN,k.LINK,k.META,k.PARAM,k.SOURCE,k.TRACK,k.WBR]);function uB(t,e){return e.treeAdapter.isElementNode(t)&&e.treeAdapter.getNamespaceURI(t)===W.HTML&&oB.has(e.treeAdapter.getTagName(t))}const cB={treeAdapter:wr,scriptingEnabled:!0};function lB(t,e){const n={...cB,...e};return Mw(t,n)}function dB(t,e){let n="";const r=e.treeAdapter.isElementNode(t)&&e.treeAdapter.getTagName(t)===k.TEMPLATE&&e.treeAdapter.getNamespaceURI(t)===W.HTML?e.treeAdapter.getTemplateContent(t):t,s=e.treeAdapter.getChildNodes(r);if(s)for(const a of s)n+=Mw(a,e);return n}function Mw(t,e){return e.treeAdapter.isElementNode(t)?hB(t,e):e.treeAdapter.isTextNode(t)?mB(t,e):e.treeAdapter.isCommentNode(t)?pB(t,e):e.treeAdapter.isDocumentTypeNode(t)?gB(t,e):""}function hB(t,e){const n=e.treeAdapter.getTagName(t);return`<${n}${fB(t,e)}>${uB(t,e)?"":`${dB(t,e)}</${n}>`}`}function fB(t,{treeAdapter:e}){let n="";for(const r of e.getAttrList(t)){if(n+=" ",r.namespace)switch(r.namespace){case W.XML:{n+=`xml:${r.name}`;break}case W.XMLNS:{r.name!=="xmlns"&&(n+="xmlns:"),n+=r.name;break}case W.XLINK:{n+=`xlink:${r.name}`;break}default:n+=`${r.prefix}:${r.name}`}else n+=r.name;n+=`="${vE(r.value)}"`}return n}function mB(t,e){const{treeAdapter:n}=e,r=n.getTextNodeContent(t),s=n.getParentNode(t),a=s&&n.isElementNode(s)&&n.getTagName(s);return a&&n.getNamespaceURI(s)===W.HTML&&KM(a,e.scriptingEnabled)?r:IE(r)}function pB(t,{treeAdapter:e}){return`<!--${e.getCommentNodeContent(t)}-->`}function gB(t,{treeAdapter:e}){return`<!DOCTYPE ${e.getDocumentTypeNodeName(t)}>`}function bB(t,e){return Ew.parse(t,e)}function _B(t,e,n){typeof t=="string"&&(n=e,e=t,t=null);const r=Ew.getFragmentParser(t,n);return r.tokenizer.write(e,!0),r.getFragment()}function U0(t){const e=t.includes('"')?"'":'"';return e+t+e}function yB(t,e,n){let r="!DOCTYPE ";return t&&(r+=t),e?r+=` PUBLIC ${U0(e)}`:n&&(r+=" SYSTEM"),n&&(r+=` ${U0(n)}`),r}const Br={isCommentNode:sl,isElementNode:fe,isTextNode:dr,createDocument(){const t=new Cs([]);return t["x-mode"]=ln.NO_QUIRKS,t},createDocumentFragment(){return new Cs([])},createElement(t,e,n){const r=Object.create(null),s=Object.create(null),a=Object.create(null);for(let o=0;o<n.length;o++){const u=n[o].name;r[u]=n[o].value,s[u]=n[o].namespace,a[u]=n[o].prefix}const i=new cm(t,r,[]);return i.namespace=e,i["x-attribsNamespace"]=s,i["x-attribsPrefix"]=a,i},createCommentNode(t){return new im(t)},createTextNode(t){return new Vi(t)},appendChild(t,e){const n=t.children[t.children.length-1];n&&(n.next=e,e.prev=n),t.children.push(e),e.parent=t},insertBefore(t,e,n){const r=t.children.indexOf(n),{prev:s}=n;s&&(s.next=e,e.prev=s),n.prev=e,e.next=n,t.children.splice(r,0,e),e.parent=t},setTemplateContent(t,e){Br.appendChild(t,e)},getTemplateContent(t){return t.children[0]},setDocumentType(t,e,n,r){const s=yB(e,n,r);let a=t.children.find(i=>Lh(i)&&i.name==="!doctype");a?a.data=s??null:(a=new om("!doctype",s),Br.appendChild(t,a)),a["x-name"]=e,a["x-publicId"]=n,a["x-systemId"]=r},setDocumentMode(t,e){t["x-mode"]=e},getDocumentMode(t){return t["x-mode"]},detachNode(t){if(t.parent){const e=t.parent.children.indexOf(t),{prev:n,next:r}=t;t.prev=null,t.next=null,n&&(n.next=r),r&&(r.prev=n),t.parent.children.splice(e,1),t.parent=null}},insertText(t,e){const n=t.children[t.children.length-1];n&&dr(n)?n.data+=e:Br.appendChild(t,Br.createTextNode(e))},insertTextBefore(t,e,n){const r=t.children[t.children.indexOf(n)-1];r&&dr(r)?r.data+=e:Br.insertBefore(t,Br.createTextNode(e),n)},adoptAttributes(t,e){for(let n=0;n<e.length;n++){const r=e[n].name;t.attribs[r]===void 0&&(t.attribs[r]=e[n].value,t["x-attribsNamespace"][r]=e[n].namespace,t["x-attribsPrefix"][r]=e[n].prefix)}},getFirstChild(t){return t.children[0]},getChildNodes(t){return t.children},getParentNode(t){return t.parent},getAttrList(t){return t.attributes},getTagName(t){return t.name},getNamespaceURI(t){return t.namespace},getTextNodeContent(t){return t.data},getCommentNodeContent(t){return t.data},getDocumentTypeNodeName(t){var e;return(e=t["x-name"])!==null&&e!==void 0?e:""},getDocumentTypeNodePublicId(t){var e;return(e=t["x-publicId"])!==null&&e!==void 0?e:""},getDocumentTypeNodeSystemId(t){var e;return(e=t["x-systemId"])!==null&&e!==void 0?e:""},isDocumentTypeNode(t){return Lh(t)&&t.name==="!doctype"},setNodeSourceCodeLocation(t,e){e&&(t.startIndex=e.startOffset,t.endIndex=e.endOffset),t.sourceCodeLocation=e},getNodeSourceCodeLocation(t){return t.sourceCodeLocation},updateNodeSourceCodeLocation(t,e){e.endOffset!=null&&(t.endIndex=e.endOffset),t.sourceCodeLocation={...t.sourceCodeLocation,...e}}};function EB(t,e,n,r){var s;return(s=e.treeAdapter)!==null&&s!==void 0||(e.treeAdapter=Br),e.scriptingEnabled!==!1&&(e.scriptingEnabled=!0),n?bB(t,e):_B(r,t,e)}const wB={treeAdapter:Br};function TB(t){const e="length"in t?t:[t];for(let r=0;r<e.length;r+=1){const s=e[r];Zr(s)&&Array.prototype.splice.call(e,r,1,...s.children)}let n="";for(let r=0;r<e.length;r+=1){const s=e[r];n+=lB(s,wB)}return n}var le;(function(t){t[t.Tab=9]="Tab",t[t.NewLine=10]="NewLine",t[t.FormFeed=12]="FormFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.Number=35]="Number",t[t.Amp=38]="Amp",t[t.SingleQuote=39]="SingleQuote",t[t.DoubleQuote=34]="DoubleQuote",t[t.Dash=45]="Dash",t[t.Slash=47]="Slash",t[t.Zero=48]="Zero",t[t.Nine=57]="Nine",t[t.Semi=59]="Semi",t[t.Lt=60]="Lt",t[t.Eq=61]="Eq",t[t.Gt=62]="Gt",t[t.Questionmark=63]="Questionmark",t[t.UpperA=65]="UpperA",t[t.LowerA=97]="LowerA",t[t.UpperF=70]="UpperF",t[t.LowerF=102]="LowerF",t[t.UpperZ=90]="UpperZ",t[t.LowerZ=122]="LowerZ",t[t.LowerX=120]="LowerX",t[t.OpeningSquareBracket=91]="OpeningSquareBracket"})(le||(le={}));var Y;(function(t){t[t.Text=1]="Text",t[t.BeforeTagName=2]="BeforeTagName",t[t.InTagName=3]="InTagName",t[t.InSelfClosingTag=4]="InSelfClosingTag",t[t.BeforeClosingTagName=5]="BeforeClosingTagName",t[t.InClosingTagName=6]="InClosingTagName",t[t.AfterClosingTagName=7]="AfterClosingTagName",t[t.BeforeAttributeName=8]="BeforeAttributeName",t[t.InAttributeName=9]="InAttributeName",t[t.AfterAttributeName=10]="AfterAttributeName",t[t.BeforeAttributeValue=11]="BeforeAttributeValue",t[t.InAttributeValueDq=12]="InAttributeValueDq",t[t.InAttributeValueSq=13]="InAttributeValueSq",t[t.InAttributeValueNq=14]="InAttributeValueNq",t[t.BeforeDeclaration=15]="BeforeDeclaration",t[t.InDeclaration=16]="InDeclaration",t[t.InProcessingInstruction=17]="InProcessingInstruction",t[t.BeforeComment=18]="BeforeComment",t[t.CDATASequence=19]="CDATASequence",t[t.InSpecialComment=20]="InSpecialComment",t[t.InCommentLike=21]="InCommentLike",t[t.BeforeSpecialS=22]="BeforeSpecialS",t[t.BeforeSpecialT=23]="BeforeSpecialT",t[t.SpecialStartSequence=24]="SpecialStartSequence",t[t.InSpecialTag=25]="InSpecialTag",t[t.InEntity=26]="InEntity"})(Y||(Y={}));function Er(t){return t===le.Space||t===le.NewLine||t===le.Tab||t===le.FormFeed||t===le.CarriageReturn}function cu(t){return t===le.Slash||t===le.Gt||Er(t)}function SB(t){return t>=le.LowerA&&t<=le.LowerZ||t>=le.UpperA&&t<=le.UpperZ}var ir;(function(t){t[t.NoValue=0]="NoValue",t[t.Unquoted=1]="Unquoted",t[t.Single=2]="Single",t[t.Double=3]="Double"})(ir||(ir={}));const vt={Cdata:new Uint8Array([67,68,65,84,65,91]),CdataEnd:new Uint8Array([93,93,62]),CommentEnd:new Uint8Array([45,45,62]),ScriptEnd:new Uint8Array([60,47,115,99,114,105,112,116]),StyleEnd:new Uint8Array([60,47,115,116,121,108,101]),TitleEnd:new Uint8Array([60,47,116,105,116,108,101]),TextareaEnd:new Uint8Array([60,47,116,101,120,116,97,114,101,97])};class AB{constructor({xmlMode:e=!1,decodeEntities:n=!0},r){this.cbs=r,this.state=Y.Text,this.buffer="",this.sectionStart=0,this.index=0,this.entityStart=0,this.baseState=Y.Text,this.isSpecial=!1,this.running=!0,this.offset=0,this.currentSequence=void 0,this.sequenceIndex=0,this.xmlMode=e,this.decodeEntities=n,this.entityDecoder=new dm(e?SE:lm,(s,a)=>this.emitCodePoint(s,a))}reset(){this.state=Y.Text,this.buffer="",this.sectionStart=0,this.index=0,this.baseState=Y.Text,this.currentSequence=void 0,this.running=!0,this.offset=0}write(e){this.offset+=this.buffer.length,this.buffer=e,this.parse()}end(){this.running&&this.finish()}pause(){this.running=!1}resume(){this.running=!0,this.index<this.buffer.length+this.offset&&this.parse()}stateText(e){e===le.Lt||!this.decodeEntities&&this.fastForwardTo(le.Lt)?(this.index>this.sectionStart&&this.cbs.ontext(this.sectionStart,this.index),this.state=Y.BeforeTagName,this.sectionStart=this.index):this.decodeEntities&&e===le.Amp&&this.startEntity()}stateSpecialStartSequence(e){const n=this.sequenceIndex===this.currentSequence.length;if(!(n?cu(e):(e|32)===this.currentSequence[this.sequenceIndex]))this.isSpecial=!1;else if(!n){this.sequenceIndex++;return}this.sequenceIndex=0,this.state=Y.InTagName,this.stateInTagName(e)}stateInSpecialTag(e){if(this.sequenceIndex===this.currentSequence.length){if(e===le.Gt||Er(e)){const n=this.index-this.currentSequence.length;if(this.sectionStart<n){const r=this.index;this.index=n,this.cbs.ontext(this.sectionStart,n),this.index=r}this.isSpecial=!1,this.sectionStart=n+2,this.stateInClosingTagName(e);return}this.sequenceIndex=0}(e|32)===this.currentSequence[this.sequenceIndex]?this.sequenceIndex+=1:this.sequenceIndex===0?this.currentSequence===vt.TitleEnd?this.decodeEntities&&e===le.Amp&&this.startEntity():this.fastForwardTo(le.Lt)&&(this.sequenceIndex=1):this.sequenceIndex=+(e===le.Lt)}stateCDATASequence(e){e===vt.Cdata[this.sequenceIndex]?++this.sequenceIndex===vt.Cdata.length&&(this.state=Y.InCommentLike,this.currentSequence=vt.CdataEnd,this.sequenceIndex=0,this.sectionStart=this.index+1):(this.sequenceIndex=0,this.state=Y.InDeclaration,this.stateInDeclaration(e))}fastForwardTo(e){for(;++this.index<this.buffer.length+this.offset;)if(this.buffer.charCodeAt(this.index-this.offset)===e)return!0;return this.index=this.buffer.length+this.offset-1,!1}stateInCommentLike(e){e===this.currentSequence[this.sequenceIndex]?++this.sequenceIndex===this.currentSequence.length&&(this.currentSequence===vt.CdataEnd?this.cbs.oncdata(this.sectionStart,this.index,2):this.cbs.oncomment(this.sectionStart,this.index,2),this.sequenceIndex=0,this.sectionStart=this.index+1,this.state=Y.Text):this.sequenceIndex===0?this.fastForwardTo(this.currentSequence[0])&&(this.sequenceIndex=1):e!==this.currentSequence[this.sequenceIndex-1]&&(this.sequenceIndex=0)}isTagStartChar(e){return this.xmlMode?!cu(e):SB(e)}startSpecial(e,n){this.isSpecial=!0,this.currentSequence=e,this.sequenceIndex=n,this.state=Y.SpecialStartSequence}stateBeforeTagName(e){if(e===le.ExclamationMark)this.state=Y.BeforeDeclaration,this.sectionStart=this.index+1;else if(e===le.Questionmark)this.state=Y.InProcessingInstruction,this.sectionStart=this.index+1;else if(this.isTagStartChar(e)){const n=e|32;this.sectionStart=this.index,this.xmlMode?this.state=Y.InTagName:n===vt.ScriptEnd[2]?this.state=Y.BeforeSpecialS:n===vt.TitleEnd[2]?this.state=Y.BeforeSpecialT:this.state=Y.InTagName}else e===le.Slash?this.state=Y.BeforeClosingTagName:(this.state=Y.Text,this.stateText(e))}stateInTagName(e){cu(e)&&(this.cbs.onopentagname(this.sectionStart,this.index),this.sectionStart=-1,this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e))}stateBeforeClosingTagName(e){Er(e)||(e===le.Gt?this.state=Y.Text:(this.state=this.isTagStartChar(e)?Y.InClosingTagName:Y.InSpecialComment,this.sectionStart=this.index))}stateInClosingTagName(e){(e===le.Gt||Er(e))&&(this.cbs.onclosetag(this.sectionStart,this.index),this.sectionStart=-1,this.state=Y.AfterClosingTagName,this.stateAfterClosingTagName(e))}stateAfterClosingTagName(e){(e===le.Gt||this.fastForwardTo(le.Gt))&&(this.state=Y.Text,this.sectionStart=this.index+1)}stateBeforeAttributeName(e){e===le.Gt?(this.cbs.onopentagend(this.index),this.isSpecial?(this.state=Y.InSpecialTag,this.sequenceIndex=0):this.state=Y.Text,this.sectionStart=this.index+1):e===le.Slash?this.state=Y.InSelfClosingTag:Er(e)||(this.state=Y.InAttributeName,this.sectionStart=this.index)}stateInSelfClosingTag(e){e===le.Gt?(this.cbs.onselfclosingtag(this.index),this.state=Y.Text,this.sectionStart=this.index+1,this.isSpecial=!1):Er(e)||(this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e))}stateInAttributeName(e){(e===le.Eq||cu(e))&&(this.cbs.onattribname(this.sectionStart,this.index),this.sectionStart=this.index,this.state=Y.AfterAttributeName,this.stateAfterAttributeName(e))}stateAfterAttributeName(e){e===le.Eq?this.state=Y.BeforeAttributeValue:e===le.Slash||e===le.Gt?(this.cbs.onattribend(ir.NoValue,this.sectionStart),this.sectionStart=-1,this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e)):Er(e)||(this.cbs.onattribend(ir.NoValue,this.sectionStart),this.state=Y.InAttributeName,this.sectionStart=this.index)}stateBeforeAttributeValue(e){e===le.DoubleQuote?(this.state=Y.InAttributeValueDq,this.sectionStart=this.index+1):e===le.SingleQuote?(this.state=Y.InAttributeValueSq,this.sectionStart=this.index+1):Er(e)||(this.sectionStart=this.index,this.state=Y.InAttributeValueNq,this.stateInAttributeValueNoQuotes(e))}handleInAttributeValue(e,n){e===n||!this.decodeEntities&&this.fastForwardTo(n)?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(n===le.DoubleQuote?ir.Double:ir.Single,this.index+1),this.state=Y.BeforeAttributeName):this.decodeEntities&&e===le.Amp&&this.startEntity()}stateInAttributeValueDoubleQuotes(e){this.handleInAttributeValue(e,le.DoubleQuote)}stateInAttributeValueSingleQuotes(e){this.handleInAttributeValue(e,le.SingleQuote)}stateInAttributeValueNoQuotes(e){Er(e)||e===le.Gt?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(ir.Unquoted,this.index),this.state=Y.BeforeAttributeName,this.stateBeforeAttributeName(e)):this.decodeEntities&&e===le.Amp&&this.startEntity()}stateBeforeDeclaration(e){e===le.OpeningSquareBracket?(this.state=Y.CDATASequence,this.sequenceIndex=0):this.state=e===le.Dash?Y.BeforeComment:Y.InDeclaration}stateInDeclaration(e){(e===le.Gt||this.fastForwardTo(le.Gt))&&(this.cbs.ondeclaration(this.sectionStart,this.index),this.state=Y.Text,this.sectionStart=this.index+1)}stateInProcessingInstruction(e){(e===le.Gt||this.fastForwardTo(le.Gt))&&(this.cbs.onprocessinginstruction(this.sectionStart,this.index),this.state=Y.Text,this.sectionStart=this.index+1)}stateBeforeComment(e){e===le.Dash?(this.state=Y.InCommentLike,this.currentSequence=vt.CommentEnd,this.sequenceIndex=2,this.sectionStart=this.index+1):this.state=Y.InDeclaration}stateInSpecialComment(e){(e===le.Gt||this.fastForwardTo(le.Gt))&&(this.cbs.oncomment(this.sectionStart,this.index,0),this.state=Y.Text,this.sectionStart=this.index+1)}stateBeforeSpecialS(e){const n=e|32;n===vt.ScriptEnd[3]?this.startSpecial(vt.ScriptEnd,4):n===vt.StyleEnd[3]?this.startSpecial(vt.StyleEnd,4):(this.state=Y.InTagName,this.stateInTagName(e))}stateBeforeSpecialT(e){const n=e|32;n===vt.TitleEnd[3]?this.startSpecial(vt.TitleEnd,4):n===vt.TextareaEnd[3]?this.startSpecial(vt.TextareaEnd,4):(this.state=Y.InTagName,this.stateInTagName(e))}startEntity(){this.baseState=this.state,this.state=Y.InEntity,this.entityStart=this.index,this.entityDecoder.startEntity(this.xmlMode?Sn.Strict:this.baseState===Y.Text||this.baseState===Y.InSpecialTag?Sn.Legacy:Sn.Attribute)}stateInEntity(){const e=this.entityDecoder.write(this.buffer,this.index-this.offset);e>=0?(this.state=this.baseState,e===0&&(this.index=this.entityStart)):this.index=this.offset+this.buffer.length-1}cleanup(){this.running&&this.sectionStart!==this.index&&(this.state===Y.Text||this.state===Y.InSpecialTag&&this.sequenceIndex===0?(this.cbs.ontext(this.sectionStart,this.index),this.sectionStart=this.index):(this.state===Y.InAttributeValueDq||this.state===Y.InAttributeValueSq||this.state===Y.InAttributeValueNq)&&(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=this.index))}shouldContinue(){return this.index<this.buffer.length+this.offset&&this.running}parse(){for(;this.shouldContinue();){const e=this.buffer.charCodeAt(this.index-this.offset);switch(this.state){case Y.Text:{this.stateText(e);break}case Y.SpecialStartSequence:{this.stateSpecialStartSequence(e);break}case Y.InSpecialTag:{this.stateInSpecialTag(e);break}case Y.CDATASequence:{this.stateCDATASequence(e);break}case Y.InAttributeValueDq:{this.stateInAttributeValueDoubleQuotes(e);break}case Y.InAttributeName:{this.stateInAttributeName(e);break}case Y.InCommentLike:{this.stateInCommentLike(e);break}case Y.InSpecialComment:{this.stateInSpecialComment(e);break}case Y.BeforeAttributeName:{this.stateBeforeAttributeName(e);break}case Y.InTagName:{this.stateInTagName(e);break}case Y.InClosingTagName:{this.stateInClosingTagName(e);break}case Y.BeforeTagName:{this.stateBeforeTagName(e);break}case Y.AfterAttributeName:{this.stateAfterAttributeName(e);break}case Y.InAttributeValueSq:{this.stateInAttributeValueSingleQuotes(e);break}case Y.BeforeAttributeValue:{this.stateBeforeAttributeValue(e);break}case Y.BeforeClosingTagName:{this.stateBeforeClosingTagName(e);break}case Y.AfterClosingTagName:{this.stateAfterClosingTagName(e);break}case Y.BeforeSpecialS:{this.stateBeforeSpecialS(e);break}case Y.BeforeSpecialT:{this.stateBeforeSpecialT(e);break}case Y.InAttributeValueNq:{this.stateInAttributeValueNoQuotes(e);break}case Y.InSelfClosingTag:{this.stateInSelfClosingTag(e);break}case Y.InDeclaration:{this.stateInDeclaration(e);break}case Y.BeforeDeclaration:{this.stateBeforeDeclaration(e);break}case Y.BeforeComment:{this.stateBeforeComment(e);break}case Y.InProcessingInstruction:{this.stateInProcessingInstruction(e);break}case Y.InEntity:{this.stateInEntity();break}}this.index++}this.cleanup()}finish(){this.state===Y.InEntity&&(this.entityDecoder.end(),this.state=this.baseState),this.handleTrailingData(),this.cbs.onend()}handleTrailingData(){const e=this.buffer.length+this.offset;this.sectionStart>=e||(this.state===Y.InCommentLike?this.currentSequence===vt.CdataEnd?this.cbs.oncdata(this.sectionStart,e,0):this.cbs.oncomment(this.sectionStart,e,0):this.state===Y.InTagName||this.state===Y.BeforeAttributeName||this.state===Y.BeforeAttributeValue||this.state===Y.AfterAttributeName||this.state===Y.InAttributeName||this.state===Y.InAttributeValueSq||this.state===Y.InAttributeValueDq||this.state===Y.InAttributeValueNq||this.state===Y.InClosingTagName||this.cbs.ontext(this.sectionStart,e))}emitCodePoint(e,n){this.baseState!==Y.Text&&this.baseState!==Y.InSpecialTag?(this.sectionStart<this.entityStart&&this.cbs.onattribdata(this.sectionStart,this.entityStart),this.sectionStart=this.entityStart+n,this.index=this.sectionStart-1,this.cbs.onattribentity(e)):(this.sectionStart<this.entityStart&&this.cbs.ontext(this.sectionStart,this.entityStart),this.sectionStart=this.entityStart+n,this.index=this.sectionStart-1,this.cbs.ontextentity(e,this.sectionStart))}}const Us=new Set(["input","option","optgroup","select","button","datalist","textarea"]),Ke=new Set(["p"]),j0=new Set(["thead","tbody"]),$0=new Set(["dd","dt"]),H0=new Set(["rt","rp"]),CB=new Map([["tr",new Set(["tr","th","td"])],["th",new Set(["th"])],["td",new Set(["thead","th","td"])],["body",new Set(["head","link","script"])],["li",new Set(["li"])],["p",Ke],["h1",Ke],["h2",Ke],["h3",Ke],["h4",Ke],["h5",Ke],["h6",Ke],["select",Us],["input",Us],["output",Us],["button",Us],["datalist",Us],["textarea",Us],["option",new Set(["option"])],["optgroup",new Set(["optgroup","option"])],["dd",$0],["dt",$0],["address",Ke],["article",Ke],["aside",Ke],["blockquote",Ke],["details",Ke],["div",Ke],["dl",Ke],["fieldset",Ke],["figcaption",Ke],["figure",Ke],["footer",Ke],["form",Ke],["header",Ke],["hr",Ke],["main",Ke],["nav",Ke],["ol",Ke],["pre",Ke],["section",Ke],["table",Ke],["ul",Ke],["rt",H0],["rp",H0],["tbody",j0],["tfoot",j0]]),OB=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]),q0=new Set(["math","svg"]),V0=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignobject","desc","title"]),vB=/\s|\//;class IB{constructor(e,n={}){var r,s,a,i,o,u;this.options=n,this.startIndex=0,this.endIndex=0,this.openTagStart=0,this.tagname="",this.attribname="",this.attribvalue="",this.attribs=null,this.stack=[],this.buffers=[],this.bufferOffset=0,this.writeIndex=0,this.ended=!1,this.cbs=e??{},this.htmlMode=!this.options.xmlMode,this.lowerCaseTagNames=(r=n.lowerCaseTags)!==null&&r!==void 0?r:this.htmlMode,this.lowerCaseAttributeNames=(s=n.lowerCaseAttributeNames)!==null&&s!==void 0?s:this.htmlMode,this.recognizeSelfClosing=(a=n.recognizeSelfClosing)!==null&&a!==void 0?a:!this.htmlMode,this.tokenizer=new((i=n.Tokenizer)!==null&&i!==void 0?i:AB)(this.options,this),this.foreignContext=[!this.htmlMode],(u=(o=this.cbs).onparserinit)===null||u===void 0||u.call(o,this)}ontext(e,n){var r,s;const a=this.getSlice(e,n);this.endIndex=n-1,(s=(r=this.cbs).ontext)===null||s===void 0||s.call(r,a),this.startIndex=n}ontextentity(e,n){var r,s;this.endIndex=n-1,(s=(r=this.cbs).ontext)===null||s===void 0||s.call(r,Dh(e)),this.startIndex=n}isVoidElement(e){return this.htmlMode&&OB.has(e)}onopentagname(e,n){this.endIndex=n;let r=this.getSlice(e,n);this.lowerCaseTagNames&&(r=r.toLowerCase()),this.emitOpenTag(r)}emitOpenTag(e){var n,r,s,a;this.openTagStart=this.startIndex,this.tagname=e;const i=this.htmlMode&&CB.get(e);if(i)for(;this.stack.length>0&&i.has(this.stack[0]);){const o=this.stack.shift();(r=(n=this.cbs).onclosetag)===null||r===void 0||r.call(n,o,!0)}this.isVoidElement(e)||(this.stack.unshift(e),this.htmlMode&&(q0.has(e)?this.foreignContext.unshift(!0):V0.has(e)&&this.foreignContext.unshift(!1))),(a=(s=this.cbs).onopentagname)===null||a===void 0||a.call(s,e),this.cbs.onopentag&&(this.attribs={})}endOpenTag(e){var n,r;this.startIndex=this.openTagStart,this.attribs&&((r=(n=this.cbs).onopentag)===null||r===void 0||r.call(n,this.tagname,this.attribs,e),this.attribs=null),this.cbs.onclosetag&&this.isVoidElement(this.tagname)&&this.cbs.onclosetag(this.tagname,!0),this.tagname=""}onopentagend(e){this.endIndex=e,this.endOpenTag(!1),this.startIndex=e+1}onclosetag(e,n){var r,s,a,i,o,u,c,l;this.endIndex=n;let d=this.getSlice(e,n);if(this.lowerCaseTagNames&&(d=d.toLowerCase()),this.htmlMode&&(q0.has(d)||V0.has(d))&&this.foreignContext.shift(),this.isVoidElement(d))this.htmlMode&&d==="br"&&((i=(a=this.cbs).onopentagname)===null||i===void 0||i.call(a,"br"),(u=(o=this.cbs).onopentag)===null||u===void 0||u.call(o,"br",{},!0),(l=(c=this.cbs).onclosetag)===null||l===void 0||l.call(c,"br",!1));else{const p=this.stack.indexOf(d);if(p!==-1)for(let m=0;m<=p;m++){const f=this.stack.shift();(s=(r=this.cbs).onclosetag)===null||s===void 0||s.call(r,f,m!==p)}else this.htmlMode&&d==="p"&&(this.emitOpenTag("p"),this.closeCurrentTag(!0))}this.startIndex=n+1}onselfclosingtag(e){this.endIndex=e,this.recognizeSelfClosing||this.foreignContext[0]?(this.closeCurrentTag(!1),this.startIndex=e+1):this.onopentagend(e)}closeCurrentTag(e){var n,r;const s=this.tagname;this.endOpenTag(e),this.stack[0]===s&&((r=(n=this.cbs).onclosetag)===null||r===void 0||r.call(n,s,!e),this.stack.shift())}onattribname(e,n){this.startIndex=e;const r=this.getSlice(e,n);this.attribname=this.lowerCaseAttributeNames?r.toLowerCase():r}onattribdata(e,n){this.attribvalue+=this.getSlice(e,n)}onattribentity(e){this.attribvalue+=Dh(e)}onattribend(e,n){var r,s;this.endIndex=n,(s=(r=this.cbs).onattribute)===null||s===void 0||s.call(r,this.attribname,this.attribvalue,e===ir.Double?'"':e===ir.Single?"'":e===ir.NoValue?void 0:null),this.attribs&&!Object.prototype.hasOwnProperty.call(this.attribs,this.attribname)&&(this.attribs[this.attribname]=this.attribvalue),this.attribvalue=""}getInstructionName(e){const n=e.search(vB);let r=n<0?e:e.substr(0,n);return this.lowerCaseTagNames&&(r=r.toLowerCase()),r}ondeclaration(e,n){this.endIndex=n;const r=this.getSlice(e,n);if(this.cbs.onprocessinginstruction){const s=this.getInstructionName(r);this.cbs.onprocessinginstruction(`!${s}`,`!${r}`)}this.startIndex=n+1}onprocessinginstruction(e,n){this.endIndex=n;const r=this.getSlice(e,n);if(this.cbs.onprocessinginstruction){const s=this.getInstructionName(r);this.cbs.onprocessinginstruction(`?${s}`,`?${r}`)}this.startIndex=n+1}oncomment(e,n,r){var s,a,i,o;this.endIndex=n,(a=(s=this.cbs).oncomment)===null||a===void 0||a.call(s,this.getSlice(e,n-r)),(o=(i=this.cbs).oncommentend)===null||o===void 0||o.call(i),this.startIndex=n+1}oncdata(e,n,r){var s,a,i,o,u,c,l,d,p,m;this.endIndex=n;const f=this.getSlice(e,n-r);!this.htmlMode||this.options.recognizeCDATA?((a=(s=this.cbs).oncdatastart)===null||a===void 0||a.call(s),(o=(i=this.cbs).ontext)===null||o===void 0||o.call(i,f),(c=(u=this.cbs).oncdataend)===null||c===void 0||c.call(u)):((d=(l=this.cbs).oncomment)===null||d===void 0||d.call(l,`[CDATA[${f}]]`),(m=(p=this.cbs).oncommentend)===null||m===void 0||m.call(p)),this.startIndex=n+1}onend(){var e,n;if(this.cbs.onclosetag){this.endIndex=this.startIndex;for(let r=0;r<this.stack.length;r++)this.cbs.onclosetag(this.stack[r],!0)}(n=(e=this.cbs).onend)===null||n===void 0||n.call(e)}reset(){var e,n,r,s;(n=(e=this.cbs).onreset)===null||n===void 0||n.call(e),this.tokenizer.reset(),this.tagname="",this.attribname="",this.attribs=null,this.stack.length=0,this.startIndex=0,this.endIndex=0,(s=(r=this.cbs).onparserinit)===null||s===void 0||s.call(r,this),this.buffers.length=0,this.foreignContext.length=0,this.foreignContext.unshift(!this.htmlMode),this.bufferOffset=0,this.writeIndex=0,this.ended=!1}parseComplete(e){this.reset(),this.end(e)}getSlice(e,n){for(;e-this.bufferOffset>=this.buffers[0].length;)this.shiftBuffer();let r=this.buffers[0].slice(e-this.bufferOffset,n-this.bufferOffset);for(;n-this.bufferOffset>this.buffers[0].length;)this.shiftBuffer(),r+=this.buffers[0].slice(0,n-this.bufferOffset);return r}shiftBuffer(){this.bufferOffset+=this.buffers[0].length,this.writeIndex--,this.buffers.shift()}write(e){var n,r;if(this.ended){(r=(n=this.cbs).onerror)===null||r===void 0||r.call(n,new Error(".write() after done!"));return}this.buffers.push(e),this.tokenizer.running&&(this.tokenizer.write(e),this.writeIndex++)}end(e){var n,r;if(this.ended){(r=(n=this.cbs).onerror)===null||r===void 0||r.call(n,new Error(".end() after done!"));return}e&&this.write(e),this.ended=!0,this.tokenizer.end()}pause(){this.tokenizer.pause()}resume(){for(this.tokenizer.resume();this.tokenizer.running&&this.writeIndex<this.buffers.length;)this.tokenizer.write(this.buffers[this.writeIndex++]);this.ended&&this.tokenizer.end()}parseChunk(e){this.write(e)}done(e){this.end(e)}}function NB(t,e){const n=new RL(void 0,e);return new IB(n,e).end(t),n.root}const kB=aM((t,e,n,r)=>e._useHtmlParser2?NB(t,e):EB(t,e,n,r)),RB=FM(kB,(t,e)=>e._useHtmlParser2?al(t,e):TB(t));async function PB(t,e){try{const n=await t.invoke(e),r=typeof n=="string"?JSON.parse(`[${n}]`):n;return r.length===0?(eo(""),[]):r}catch(n){console.error(":",n)}return[]}async function xB(t){let e="";try{const n=await Ye.get(t),r=RB(n.data);r("script").remove(),r("style").remove(),r("noscript").remove(),r("iframe").remove(),r("nav").remove(),r("footer").remove(),e=r("body").text().replace(/&nbsp;/g," ").trim()}catch(n){console.error(`Error crawling ${t}:`,n)}return e}class LB extends vh{static lc_name(){return"ChatDeepSeek"}_llmType(){return"deepseek"}get lc_secrets(){return{apiKey:"DEEPSEEK_API_KEY"}}constructor(e){const n=(e==null?void 0:e.apiKey)||fn("DEEPSEEK_API_KEY");if(!n)throw new Error('Deepseek API key not found. Please set the DEEPSEEK_API_KEY environment variable or pass the key into "apiKey" field.');super({...e,apiKey:n,configuration:{baseURL:"https://api.deepseek.com",...e==null?void 0:e.configuration}}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","deepseek"]})}_convertOpenAIDeltaToBaseMessageChunk(e,n,r){const s=super._convertOpenAIDeltaToBaseMessageChunk(e,n,r);return s.additional_kwargs.reasoning_content=e.reasoning_content,s}_convertOpenAIChatCompletionMessageToBaseMessage(e,n){const r=super._convertOpenAIChatCompletionMessageToBaseMessage(e,n);return r.additional_kwargs.reasoning_content=e.reasoning_content,r}withStructuredOutput(e,n){const r={...n};return(r==null?void 0:r.method)===void 0&&(r.method="functionCalling"),super.withStructuredOutput(e,r)}}async function DB(t,e,n){const r=await LA(e),s=r-n,a=r+n,i=await Gb(t);let o=[];for(let[u,c]of i.entries())u<s||u>a||o.push({link:`siyuan://blocks/${c.id}`,content:c.markdown});return o}let Tn;function Bw(t){Tn=t}async function MB(t){try{await navigator.clipboard.writeText(t)}catch{const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}}function BB(t,e){let n=[],r="";for(let[s,a]of t.entries())switch(s===t.length-1&&e.length>0?r=`${Tn.searchResults}${JSON.stringify(e)}

${Tn.answerBasedOnSearch}${a.content};`:r=a.content,!0){case a.role==="system":n.push(new Zd(r));break;case a.role==="assistant":n.push(new bs(r));break;case a.role==="user":a.image?n.push(new or({content:[{type:"text",text:r},{type:"image_url",image_url:{url:a.image}}]})):a.fileContent?n.push(new or(`${a.fileContent}

${r}`)):n.push(new or(r));break;case a.role==="image":break;default:n.push(new or(r));break}return n}async function lu(t,e){let n=[],r=[],s=[],a="",i=e.isReason?`${Tn.thinking}

`:"",o=!1;if(e.isSearch){let l=e.messages[e.messages.length-1].content;l||(l=e.messages[e.messages.length-2].content);const d=new zx({apiBase:o2,params:{format:"json",engines:"google,bing",numResults:3},headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}}),p=await PB(d,l);for(let[m,f]of p.entries()){if(f.link.includes("zhihu"))continue;m===0&&(a+=`${Tn.relatedWebPages}:

`);const g=await xB(f.link),b=await Fw(g.replace(`
`,""),e.apiKey);console.debug(b),n.push(b),a+=`${Tn.webLink}: ${f.link}
`,e.callback(a),a+=`${Tn.title}:${f.title}
`,e.callback(a),a+=`${Tn.summary}: ${f.snippet}

`,e.callback(a)}a+=`

---------------------------------------
`}if(e.isKnowledge){const l=e.messages[e.messages.length-1].content,d=await e.knowledgeCallback(l);for(let p of d){const m=await DB(p.metadata.docId,p.metadata.blockId,3);r.push(JSON.stringify(m))}s=[...e.messages.splice(0,-1),{role:"user",content:Tn.knowledgeBasePrompt},{role:"assistant",content:`${Tn.retrievedContent}:
${r}`},{role:"user",content:e.messages[e.messages.length-1].content}],e.messages=s}let u=BB(e.messages,n);if(e.isStream){const l=await t.stream(u,{timeout:e.timeout*1e3});try{for await(const d of l)d.additional_kwargs&&d.additional_kwargs.reasoning_content&&(i+=d.additional_kwargs.reasoning_content.toString()),d.content&&(e.isReason&&!o&&(i+=`

--------- 
`),o=!0,a+=d.content.toString()),e.callback(i+a,!0)}catch{throw new Error("User interrupted")}finally{e.callback(i+a,!1)}return a}const c=await t.invoke(u,{timeout:e.timeout*1e3});return c.additional_kwargs.reasoning_content?(i+=c.additional_kwargs.reasoning_content.toString(),i+=`

--------- 
`,a+=c.content.toString(),e.callback(`${i}${a}`),a):(a+=c.content.toString(),e.callback(a),a)}async function ml(t){let e="",n;try{switch(!0){case t.model.includes("claude"):n=new HP({model:t.model,apiKey:t.apiKey,anthropicApiUrl:`${Io}/claude`,maxTokens:t.maxTokens,temperature:t.temperature}),e=await lu(n,t);break;case t.model.includes("deepseek-reasoner"):n=new LB({model:t.model,apiKey:t.apiKey,maxTokens:t.maxTokens,temperature:t.temperature,configuration:{baseURL:`${Io}/v1`}}),t.isReason=!0,e=await lu(n,t);break;case t.model.includes("o3-mini"):n=new vh({openAIApiKey:t.apiKey,modelName:t.model,configuration:{baseURL:`${Io}/v1`}}),e=await lu(n,t);break;default:n=new vh({openAIApiKey:t.apiKey,modelName:t.model,maxTokens:t.maxTokens,temperature:t.temperature,configuration:{baseURL:`${Io}/v1`,timeout:t.timeout*1e3}}),e=await lu(n,t);break}t.isClipboard&&(document.body.focus(),await MB(e),Xs(Tn.contentCopied))}catch(r){return console.error(Tn.generateAnswerError,r),e}finally{return e}}async function FB(t,e){return await ml({apiKey:e,model:"glm-4-flash",maxTokens:100,temperature:.5,timeout:90,isSearch:!1,isStream:!1,isClipboard:!1,callback:()=>{},messages:t})}async function Fw(t,e){return await ml({apiKey:e,model:"glm-4-flash",maxTokens:4e3,temperature:.5,timeout:90,isSearch:!1,isStream:!1,isClipboard:!1,callback:()=>{},messages:[{role:"system",content:""},{role:"user",content:t}]})}class So{constructor(e,n){ve(this,"data");ve(this,"plugin");ve(this,"name");ve(this,"file");ve(this,"i18n");this.name=n,this.plugin=e,this.i18n=e.i18n}async customSaveData(e,n){n=n||this.file;const r=`/ai/${n}`;let s;return typeof e=="object"?s=new File([new Blob([JSON.stringify(e)],{type:"application/json"})],r.split("/").pop()):s=new File([new Blob([e])],r.split("/").pop()),l2(r,!1,s)}async customLoadData(e){e=e||this.file;const n=`/ai/${e}`;return new Promise(r=>{Dn.fetchPost("/api/file/getFile",{path:n},s=>{s.code!==404&&(this.data=s),r(this.data)})})}async load(){let e=await this.plugin.loadData(this.file);return e?this.data=e:this.save(),this.data}async save(e){return e=e??this.data,this.plugin.saveData(this.file,e),e}}class UB extends So{constructor(n,r,s,a,i,o){super(n,r);ve(this,"apiKey");ve(this,"documentVectorStorage");ve(this,"data",new Map);ve(this,"BATCH_SIZE",20);ve(this,"MAX_CONTENT_LENGTH",510);ve(this,"includeNotebooks");ve(this,"excludeNotebooks");this.name=r??t_,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this.apiKey=s,this.documentVectorStorage=a,this.includeNotebooks=i,this.excludeNotebooks=o}async load(){return console.debug("BlockStorage load"),this.data.size===0&&(this.data=await this.documentVectorStorage.embeddingBlocks()),await this.knowledgeProcess(),await this.documentVectorStorage.release(),this.data}get(n){return this.data[n]}has(n){return this.data.has(n)}add(n,r){this.data.set(n,r)}async getDocuments(){const n=[],r=a=>{if(!Array.isArray(a)){console.warn(this.i18n.invalidNodesArray);return}a.forEach(i=>{var o;n.push(i.id),((o=i.children)==null?void 0:o.length)>0&&r(i.children)})},s=await DA();if(!s)return n;for(const a of s.notebooks)if(!(this.excludeNotebooks&&this.excludeNotebooks.includes(a.name))&&(this.includeNotebooks===""||this.includeNotebooks.includes(a.name))){const i=await d2(a.id,"/");r(i.tree)}return n}async getBlocks(){const n=[],r=new Set(["widget","iframe","audio"]);try{const s=await this.getDocuments();return await Promise.allSettled(s.map(async a=>{try{const o=(await Gb(a)).filter(u=>{var c;return!r.has(u.type)&&((c=u.content)==null?void 0:c.length)>2}).map(u=>({docId:a,blockId:u.id,content:u.content}));n.push(...o)}catch(i){console.error(` ${a} :`,i)}})),n}catch(s){return console.error(":",s),[]}}async blocksToInsert(){return console.debug("BlockStorage::blocksToInsert"),(await this.getBlocks()).filter(r=>!this.has(r.blockId))}async blocksToDelete(){console.debug("BlockStorage::blocksToDelete");const n=[];try{const r=await this.getBlocks(),s=new Set(r.map(a=>a.blockId));for(const[a,i]of this.data.entries())s.has(a)||(this.data.delete(a),n.push({blockId:a,docId:i}));return n}catch(r){return console.error("ID:",r),n}}async processSingleBlock(n){let r=n.content;const a=n.content.length>this.MAX_CONTENT_LENGTH;a&&(r=await Fw(r,this.apiKey));const i=r.substring(0,this.MAX_CONTENT_LENGTH);return{blockId:n.blockId,docId:n.docId,content:i,isSummary:a}}async genBatchBlocks(n){const r=[];let s=[];for(const a of n){const i=await this.processSingleBlock(a);s.push({pageContent:i.content,metadata:{blockId:i.blockId,docId:i.docId,isSummary:i.isSummary},id:i.blockId}),s.length===this.BATCH_SIZE&&(r.push(s),s=[])}return s.length>0&&r.push(s),r}async knowledgeProcess(){const n=await this.blocksToInsert(),r=await this.genBatchBlocks(n),s=r.length;let a=0,i=0;for(const u of r){a++;const c=Math.round(a/s*100);c>=i+5&&(Xs(`${this.documentVectorStorage.i18n.knowledgeBaseProgress}: ${c}%`,2e3),i=c,await this.documentVectorStorage.save()),console.log(`${a}${s}`),await this.documentVectorStorage.addDocuments(u)}await this.documentVectorStorage.save(),Xs(this.documentVectorStorage.i18n.knowledgeReady,1e4);const o=await this.blocksToDelete();(o==null?void 0:o.length)>0&&this.documentVectorStorage.deleteDocuments(o)}}class jB extends So{constructor(n,r){super(n,r);ve(this,"data",[{id:1,title:this.i18n.translation,time:"2025/1/22 17:06:59",messages:[{id:1,role:"system",content:this.i18n.defaultSystemPrompt},{id:2,role:"user",content:this.i18n.defaultTranslationExample},{id:3,role:"assistant",content:this.i18n.defaultTranslationResponse}]},{id:2,title:this.i18n.greeting,time:"2025/1/22 17:05:59",messages:[{id:1,role:"system",content:this.i18n.defaultSystemPrompt},{id:2,role:"user",content:this.i18n.helloMessage},{id:3,role:"assistant",content:this.i18n.helloResponse}]}]);this.name=r??e_,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`}add(n){return this.data.unshift(n),this.save()}update(n){const r=this.data.findIndex(s=>s.id===n.id);if(r!==-1)return this.data[r]=n,this.save()}updateMessage(n){return this.data=this.data.map(r=>({...r,messages:r.messages.map(s=>s.id===n.id?n:s)})),this.save()}delete(n){return this.data=this.data.filter(r=>r.id!==n),this.save()}deleteMessage(n){return this.data=this.data.map(r=>({...r,messages:r.messages.filter(s=>s.id!==n)})),this.save()}get(n){return this.data.find(r=>r.id===n)}set(n){return this.data.push(n),this.save()}dump(){return this.data}}class $B extends So{constructor(n,r){super(n,r);ve(this,"data",[{id:0,title:this.i18n.translationPromptTitle,content:this.i18n.translationPromptContent},{id:1,title:this.i18n.extractTitlePromptTitle,content:this.i18n.extractTitlePromptContent}]);this.name=r??qd,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`}addPrompt(n){this.data=[...this.data,n],this.save()}updatePrompt(n){this.data=this.data.map(r=>r.id===n.id?n:r),this.save()}deletePrompt(n){this.data=this.data.filter(r=>r.id!==n),this.save()}get(n){return this.data.find(r=>r.id===n)}set(n){this.data.push(n),this.save()}}class HB extends So{constructor(n,r){super(n,r);ve(this,"data",new Map);this.name=r??Hd,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this._defaultSettings()}async load(){let n=await this.plugin.loadData(this.file);if(n){for(let[r,s]of this.data)if(r!=="modelSelections"){if(r==="isKnowledgeBaseInstruction"||r==="isKnowledgeBaseChat"){s.value=!1;continue}s.value=(n==null?void 0:n[r])??s.value}}else this.save();return n}async save(n){return n=n??this.dump(),await this.plugin.saveData(this.file,n),n}get(n){return this.data.get(n)}getValue(n){var s;let r=(s=this.data.get(n))==null?void 0:s.value;return n==="apiKey"&&(r==null?void 0:r.length)===0&&eo(this.i18n.pleaseConfigureApiKey,2e3),r}getSettingItems(n){let r=[];for(let[s,a]of this.data)n&&a.group!==n||r.push(a);return r}set(n,r){this.data.set(n,r)}setValue(n,r){let s=this.data.get(n);s.value=r}dump(){let n={};for(let[r,s]of this.data)n[r]=s.value;return n}_defaultSettings(){const n={group:" ",title:this.i18n.apiKeyTitle,description:this.i18n.apiKeyDescription,type:"textinput",key:"apiKey",value:"",placeholder:this.i18n.apiKeyPlaceholder};this.data.set(n.key,n);const r={group:" ",title:"",description:"[]",type:"checkbox",key:"isVectorOnline",value:!1};this.data.set(r.key,r);const s={group:" ",title:"",description:"[,]",type:"textinput",key:"phoneNumber",value:"",placeholder:""};this.data.set(s.key,s);const a={group:" ",title:this.i18n.excludeknowledgeBookTitle,description:this.i18n.excludeknowledgeBookDescription,type:"textinput",key:"excludeKnowledgeBook",value:"",placeholder:this.i18n.knowledgeBookPlaceholder};this.data.set(a.key,a);const i={group:" ",title:this.i18n.includeknowledgeBookTitle,description:this.i18n.includeknowledgeBookDescription,type:"textinput",key:"includeKnowledgeBook",value:"",placeholder:this.i18n.knowledgeBookPlaceholder};this.data.set(i.key,i);const o={group:"instruction",title:"",description:"token5",key:"knowledgeBaseRecallNumInstruction",type:"number",value:5};this.data.set(o.key,o);const u={group:"chat",title:"",description:"token5",key:"knowledgeBaseRecallNumChat",type:"number",value:5},c={group:"instructionIcon",title:this.i18n.searchInstructionTitle,description:this.i18n.searchInstructionDesc,type:"checkbox",key:"isSearchInstruction",value:!1};this.data.set(c.key,c);const l={group:"instruction",title:this.i18n.pageContentTitle,description:this.i18n.pageContentDesc,type:"checkbox",key:"isPageContent",value:!1};this.data.set(l.key,l);const d={group:"instruction",title:this.i18n.temperatureTitle,description:this.i18n.temperatureDesc,type:"slider",key:"temperatureInstruction",slider:{min:0,max:1,step:.1},value:.5};this.data.set(d.key,d);const p={group:"instruction",title:this.i18n.maxTokensTitle,description:this.i18n.maxTokensDesc,type:"number",key:"maxOutputLengthInstruction",value:4e3};this.data.set(p.key,p);const m={group:"custom",title:this.i18n.searchChatTitle,description:this.i18n.searchChatDesc,key:"isSearchChat",type:"checkbox",value:!1};this.data.set(m.key,m),this.data.set(u.key,u);const f={group:"chat",title:this.i18n.maxTokensTitle,description:this.i18n.maxTokensDesc,type:"number",key:"maxOutputLengthChat",value:4e3};this.data.set(f.key,f);const g={group:"instruction",title:this.i18n.responseTimeoutTitle,description:this.i18n.responseTimeoutDesc,type:"number",key:"responseTimeoutInstruction",value:90};this.data.set(g.key,g);const b={group:"chat",title:this.i18n.responseTimeoutTitle,description:this.i18n.responseTimeoutDesc,type:"number",key:"responseTimeoutChat",value:90};this.data.set(b.key,b);const _={group:"chat",title:this.i18n.temperatureTitle,description:this.i18n.temperatureDesc,type:"slider",key:"temperatureChat",slider:{min:0,max:1,step:.1},value:.5};this.data.set(_.key,_);const E={group:"custom",title:this.i18n.knowledgeBaseTitle,description:this.i18n.knowledgeBaseDesc,type:"checkbox",key:"isKnowledgeBaseInstruction",value:!1};this.data.set(E.key,E);const T={group:"custom",title:this.i18n.knowledgeBaseTitle,description:this.i18n.knowledgeBaseDesc,type:"checkbox",key:"isKnowledgeBaseChat",value:!1};this.data.set(T.key,T);const N={group:"model",title:this.i18n.modelTitle,description:this.i18n.modelDesc,type:"select",key:"modelSelections",value:"deepseek-chat",options:{"deepseek-chat":"DeepSeek V3","deepseek-reasoner":"DeepSeek R1","moonshot-v1-auto":"Moonshot Chat","glm-4-flash":"GLM 4 Flash","qwen-turbo-latest":"Qwen Turbo","qwen-plus-latest":"Qwen Plus","qwen-max-latest":"Qwen Max","doubao-1.5-lite-32k":"Doubao 1.5 Lite","doubao-1.5-pro-32k":"Doubao 1.5 Pro","gemini-2.0-flash-thinking-exp-01-21":"Gemini 2.0 Flash","gpt-4o-mini":"GPT 4o mini"}};this.data.set(N.key,N),this.load()}}function z0(t,e,n){const r=t.slice();return r[7]=e[n],r}function W0(t){let e,n,r,s=t[7].title+"",a,i,o,u=t[7].time+"",c,l,d,p,m,f;function g(){return t[5](t[7])}function b(){return t[6](t[7])}return{c(){e=G("div"),n=G("button"),r=G("span"),a=Ze(s),i=re(),o=G("div"),c=Ze(u),l=re(),d=G("button"),d.innerHTML='<svg viewBox="0 0 24 24" width="1rem" height="1rem" stroke="currentColor" stroke-width="2" fill="none" class="svelte-1beqtaw"><path d="M18 6L6 18M6 6l12 12"></path></svg>',p=re(),C(r,"class","svelte-1beqtaw"),C(o,"class","time svelte-1beqtaw"),C(n,"class","item-content svelte-1beqtaw"),C(d,"class","delete-btn svelte-1beqtaw"),C(d,"title",""),C(e,"class","list-item svelte-1beqtaw")},m(_,E){ge(_,e,E),R(e,n),R(n,r),R(r,a),R(n,i),R(n,o),R(o,c),R(e,l),R(e,d),R(e,p),m||(f=[ce(n,"click",g),ce(d,"click",jA(b))],m=!0)},p(_,E){t=_,E&2&&s!==(s=t[7].title+"")&&ht(a,s),E&2&&u!==(u=t[7].time+"")&&ht(c,u)},d(_){_&&pe(e),m=!1,ct(f)}}}function qB(t){let e,n,r,s,a,i,o,u=t[0].i18n.newChat+"",c,l,d,p,m=Cn(t[1]),f=[];for(let g=0;g<m.length;g+=1)f[g]=W0(z0(t,m,g));return{c(){e=G("div"),n=G("div"),n.innerHTML='<h3 class="svelte-1beqtaw">SiYuan AI</h3>',r=re(),s=G("div"),a=G("button"),i=G("span"),o=Ze("+ "),c=Ze(u),l=re();for(let g=0;g<f.length;g+=1)f[g].c();C(n,"class","history-header svelte-1beqtaw"),C(i,"class","svelte-1beqtaw"),C(a,"class","new-chat-btn svelte-1beqtaw"),C(s,"class","list svelte-1beqtaw"),C(e,"class","history svelte-1beqtaw")},m(g,b){ge(g,e,b),R(e,n),R(e,r),R(e,s),R(s,a),R(a,i),R(i,o),R(i,c),R(s,l);for(let _=0;_<f.length;_+=1)f[_]&&f[_].m(s,null);d||(p=ce(a,"click",t[3]),d=!0)},p(g,[b]){if(b&1&&u!==(u=g[0].i18n.newChat+"")&&ht(c,u),b&22){m=Cn(g[1]);let _;for(_=0;_<m.length;_+=1){const E=z0(g,m,_);f[_]?f[_].p(E,b):(f[_]=W0(E),f[_].c(),f[_].m(s,null))}for(;_<f.length;_+=1)f[_].d(1);f.length=m.length}},i:ut,o:ut,d(g){g&&pe(e),Sc(f,g),d=!1,p()}}}function VB(t,e,n){let{chatHistoryStorage:r}=e,s=r.dump();const a=Kr();function i(){const l={id:Date.now(),title:r.i18n.newChat,time:i2().format("YYYY/M/D HH:mm:ss"),messages:[{id:Date.now(),role:"system",content:"You are a helpful assistant. You can help me by answering my questions. You can also ask me questions."}]};r.add(l),n(1,s=r.dump()),a("selectChat",l)}function o(l){r.delete(l),r.data.length===0&&i(),n(1,s=r.dump()),a("selectChat",s[0])}const u=l=>a("selectChat",l),c=l=>o(l.id);return t.$$set=l=>{"chatHistoryStorage"in l&&n(0,r=l.chatHistoryStorage)},[r,s,a,i,o,u,c]}class zB extends _t{constructor(e){super(),bt(this,e,VB,qB,gt,{chatHistoryStorage:0})}}function G0(t,e,n){const r=t.slice();return r[12]=e[n],r}function WB(t){var b;let e,n,r,s=t[1].Md2HTML(t[12].content)+"",a,i,o,u,c,l,d,p,m=((b=t[12])==null?void 0:b.fileContent)&&K0(),f=t[12].role==="user"&&Y0(t);function g(){return t[8](t[12])}return{c(){e=G("div"),m&&m.c(),n=re(),r=G("div"),a=re(),i=G("div"),f&&f.c(),o=re(),u=G("button"),u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',c=re(),C(r,"class","message-content svelte-2nz1n6"),C(u,"class","action-btn svelte-2nz1n6"),C(i,"class","message-actions svelte-2nz1n6"),C(e,"class",l="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")},m(_,E){ge(_,e,E),m&&m.m(e,null),R(e,n),R(e,r),r.innerHTML=s,R(e,a),R(e,i),f&&f.m(i,null),R(i,o),R(i,u),R(e,c),d||(p=ce(u,"click",g),d=!0)},p(_,E){var T;t=_,(T=t[12])!=null&&T.fileContent?m||(m=K0(),m.c(),m.m(e,n)):m&&(m.d(1),m=null),E&3&&s!==(s=t[1].Md2HTML(t[12].content)+"")&&(r.innerHTML=s),t[12].role==="user"?f?f.p(t,E):(f=Y0(t),f.c(),f.m(i,o)):f&&(f.d(1),f=null),E&1&&l!==(l="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")&&C(e,"class",l)},d(_){_&&pe(e),m&&m.d(),f&&f.d(),d=!1,p()}}}function GB(t){let e,n,r=t[1].Md2HTML(`![User uploaded image](${t[12].image})

${t[12].content}`)+"",s,a,i,o,u,c,l,d,p=t[12].role==="user"&&Z0(t);function m(){return t[6](t[12])}return{c(){e=G("div"),n=G("div"),s=re(),a=G("div"),p&&p.c(),i=re(),o=G("button"),o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',u=re(),C(n,"class","message-content svelte-2nz1n6"),C(o,"class","action-btn svelte-2nz1n6"),C(a,"class","message-actions svelte-2nz1n6"),C(e,"class",c="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")},m(f,g){ge(f,e,g),R(e,n),n.innerHTML=r,R(e,s),R(e,a),p&&p.m(a,null),R(a,i),R(a,o),R(e,u),l||(d=ce(o,"click",m),l=!0)},p(f,g){t=f,g&3&&r!==(r=t[1].Md2HTML(`![User uploaded image](${t[12].image})

${t[12].content}`)+"")&&(n.innerHTML=r),t[12].role==="user"?p?p.p(t,g):(p=Z0(t),p.c(),p.m(a,i)):p&&(p.d(1),p=null),g&1&&c!==(c="message "+(t[12].role==="user"?"user":"ai")+" svelte-2nz1n6")&&C(e,"class",c)},d(f){f&&pe(e),p&&p.d(),l=!1,d()}}}function K0(t){let e;return{c(){e=G("span"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>',C(e,"class","file-icon svelte-2nz1n6")},m(n,r){ge(n,e,r)},d(n){n&&pe(e)}}}function Y0(t){let e,n,r;function s(){return t[7](t[12])}return{c(){e=G("button"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><path d="M23 4v6h-6M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',C(e,"class","action-btn svelte-2nz1n6")},m(a,i){ge(a,e,i),n||(r=ce(e,"click",s),n=!0)},p(a,i){t=a},d(a){a&&pe(e),n=!1,r()}}}function Z0(t){let e,n,r;function s(){return t[5](t[12])}return{c(){e=G("button"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-2nz1n6"><path d="M23 4v6h-6M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',C(e,"class","action-btn svelte-2nz1n6")},m(a,i){ge(a,e,i),n||(r=ce(e,"click",s),n=!0)},p(a,i){t=a},d(a){a&&pe(e),n=!1,r()}}}function J0(t){let e;function n(a,i){var o,u;return((u=(o=a[12])==null?void 0:o.image)==null?void 0:u.length)>0?GB:WB}let r=n(t),s=r(t);return{c(){s.c(),e=Ac()},m(a,i){s.m(a,i),ge(a,e,i)},p(a,i){r===(r=n(a))&&s?s.p(a,i):(s.d(1),s=r(a),s&&(s.c(),s.m(e.parentNode,e)))},d(a){a&&pe(e),s.d(a)}}}function KB(t){let e,n,r=Cn(t[0].messages),s=[];for(let a=0;a<r.length;a+=1)s[a]=J0(G0(t,r,a));return{c(){e=G("div"),n=G("div");for(let a=0;a<s.length;a+=1)s[a].c();C(n,"class","messages-wrapper svelte-2nz1n6"),C(e,"class","message-container svelte-2nz1n6")},m(a,i){ge(a,e,i),R(e,n);for(let o=0;o<s.length;o+=1)s[o]&&s[o].m(n,null);t[9](e)},p(a,[i]){if(i&27){r=Cn(a[0].messages);let o;for(o=0;o<r.length;o+=1){const u=G0(a,r,o);s[o]?s[o].p(u,i):(s[o]=J0(u),s[o].c(),s[o].m(n,null))}for(;o<s.length;o+=1)s[o].d(1);s.length=r.length}},i:ut,o:ut,d(a){a&&pe(e),Sc(s,a),t[9](null)}}}function YB(t,e,n){let{currentChat:r}=e,{lute:s}=e,a;const i=Kr();function o(){if(a){const g=a.scrollHeight,b=a.clientHeight,_=g-b;a.scrollTo({top:_,behavior:"smooth"})}}function u(g){i("edit",{message:g})}function c(g){i("delete",{message:g})}GA(()=>{var g;if(((g=r==null?void 0:r.messages)==null?void 0:g.length)>0){const b=r.messages[r.messages.length-1];(b==null?void 0:b.role)==="ai"&&setTimeout(o,50)}}),Cc(o);const l=g=>u(g),d=g=>c(g),p=g=>u(g),m=g=>c(g);function f(g){Ne[g?"unshift":"push"](()=>{a=g,n(2,a)})}return t.$$set=g=>{"currentChat"in g&&n(0,r=g.currentChat),"lute"in g&&n(1,s=g.lute)},t.$$.update=()=>{if(t.$$.dirty&1&&r!=null&&r.messages){const g=r.messages[r.messages.length-1];(g==null?void 0:g.role)!=="user"&&g.content&&o()}},[r,s,a,u,c,l,d,p,m,f]}class ZB extends _t{constructor(e){super(),bt(this,e,YB,KB,gt,{currentChat:0,lute:1})}}function X0(t,e,n){const r=t.slice();return r[0]=e[n][0],r[18]=e[n][1],r}function JB(t){let e,n,r,s,a,i,o;return{c(){e=G("div"),n=G("input"),C(n,"id","fontSize"),C(n,"min",r=t[5].min),C(n,"max",s=t[5].max),C(n,"step",a=t[5].step),C(n,"type","range"),C(n,"style",t[8]),Ce(n,"b3-slider",!0),Ce(n,"fn__size200",t[7]),C(e,"class","b3-tooltips b3-tooltips__n"),C(e,"aria-label",t[0])},m(u,c){ge(u,e,c),R(e,n),tn(n,t[0]),i||(o=[ce(n,"change",t[16]),ce(n,"input",t[16]),ce(n,"change",t[10])],i=!0)},p(u,c){c&32&&r!==(r=u[5].min)&&C(n,"min",r),c&32&&s!==(s=u[5].max)&&C(n,"max",s),c&32&&a!==(a=u[5].step)&&C(n,"step",a),c&256&&C(n,"style",u[8]),c&17&&tn(n,u[0]),c&128&&Ce(n,"fn__size200",u[7]),c&17&&C(e,"aria-label",u[0])},d(u){u&&pe(e),i=!1,ct(o)}}}function XB(t){let e,n,r,s=Cn(Object.entries(t[4])),a=[];for(let i=0;i<s.length;i+=1)a[i]=Q0(X0(t,s,i));return{c(){e=G("select");for(let i=0;i<a.length;i+=1)a[i].c();C(e,"id","iconPosition"),C(e,"style",t[8]),t[0]===void 0&&Ru(()=>t[15].call(e)),Ce(e,"b3-select",!0),Ce(e,"fn__flex-center",!0),Ce(e,"fn__size200",t[7])},m(i,o){ge(i,e,o);for(let u=0;u<a.length;u+=1)a[u]&&a[u].m(e,null);ap(e,t[0],!0),n||(r=[ce(e,"change",t[15]),ce(e,"change",t[10])],n=!0)},p(i,o){if(o&16){s=Cn(Object.entries(i[4]));let u;for(u=0;u<s.length;u+=1){const c=X0(i,s,u);a[u]?a[u].p(c,o):(a[u]=Q0(c),a[u].c(),a[u].m(e,null))}for(;u<a.length;u+=1)a[u].d(1);a.length=s.length}o&256&&C(e,"style",i[8]),o&17&&ap(e,i[0]),o&128&&Ce(e,"fn__size200",i[7])},d(i){i&&pe(e),Sc(a,i),n=!1,ct(r)}}}function QB(t){let e,n=t[6].label+"",r,s,a;return{c(){e=G("button"),r=Ze(n),C(e,"id",t[2]),C(e,"style",t[8]),Ce(e,"b3-button",!0),Ce(e,"b3-button--outline",!0),Ce(e,"fn__flex-center",!0),Ce(e,"fn__size200",t[7])},m(i,o){ge(i,e,o),R(e,r),s||(a=ce(e,"click",t[9]),s=!0)},p(i,o){o&64&&n!==(n=i[6].label+"")&&ht(r,n),o&4&&C(e,"id",i[2]),o&256&&C(e,"style",i[8]),o&128&&Ce(e,"fn__size200",i[7])},d(i){i&&pe(e),s=!1,a()}}}function e9(t){let e,n,r;return{c(){e=G("input"),C(e,"id",t[2]),C(e,"type","number"),C(e,"style",t[8]),Ce(e,"b3-text-field",!0),Ce(e,"fn__flex-center",!0),Ce(e,"fn__size200",t[7])},m(s,a){ge(s,e,a),tn(e,t[0]),n||(r=[ce(e,"input",t[14]),ce(e,"change",t[10])],n=!0)},p(s,a){a&4&&C(e,"id",s[2]),a&256&&C(e,"style",s[8]),a&17&&Ud(e.value)!==s[0]&&tn(e,s[0]),a&128&&Ce(e,"fn__size200",s[7])},d(s){s&&pe(e),n=!1,ct(r)}}}function t9(t){let e,n,r,s;return{c(){e=G("textarea"),C(e,"class","b3-text-field fn__block"),C(e,"style",n=`resize: vertical; height: 10em; white-space: nowrap; ${t[8]}`)},m(a,i){ge(a,e,i),tn(e,t[0]),r||(s=[ce(e,"input",t[13]),ce(e,"change",t[10])],r=!0)},p(a,i){i&256&&n!==(n=`resize: vertical; height: 10em; white-space: nowrap; ${a[8]}`)&&C(e,"style",n),i&17&&tn(e,a[0])},d(a){a&&pe(e),r=!1,ct(s)}}}function n9(t){let e,n,r;return{c(){e=G("input"),C(e,"id",t[2]),C(e,"placeholder",t[3]),C(e,"style",t[8]),Ce(e,"b3-text-field",!0),Ce(e,"fn__flex-center",!0),Ce(e,"fn__size200",t[7])},m(s,a){ge(s,e,a),tn(e,t[0]),n||(r=[ce(e,"input",t[12]),ce(e,"change",t[10])],n=!0)},p(s,a){a&4&&C(e,"id",s[2]),a&8&&C(e,"placeholder",s[3]),a&256&&C(e,"style",s[8]),a&17&&e.value!==s[0]&&tn(e,s[0]),a&128&&Ce(e,"fn__size200",s[7])},d(s){s&&pe(e),n=!1,ct(r)}}}function r9(t){let e,n,r;return{c(){e=G("input"),C(e,"class","b3-switch fn__flex-center"),C(e,"id",t[2]),C(e,"type","checkbox"),C(e,"style",t[8])},m(s,a){ge(s,e,a),e.checked=t[0],n||(r=[ce(e,"change",t[11]),ce(e,"change",t[10])],n=!0)},p(s,a){a&4&&C(e,"id",s[2]),a&256&&C(e,"style",s[8]),a&17&&(e.checked=s[0])},d(s){s&&pe(e),n=!1,ct(r)}}}function Q0(t){let e,n=t[18]+"",r,s;return{c(){e=G("option"),r=Ze(n),e.__value=s=t[0],tn(e,e.__value)},m(a,i){ge(a,e,i),R(e,r)},p(a,i){i&16&&n!==(n=a[18]+"")&&ht(r,n),i&16&&s!==(s=a[0])&&(e.__value=s,tn(e,e.__value))},d(a){a&&pe(e)}}}function s9(t){let e;function n(a,i){if(a[1]==="checkbox")return r9;if(a[1]==="textinput")return n9;if(a[1]==="textarea")return t9;if(a[1]==="number")return e9;if(a[1]==="button")return QB;if(a[1]==="select")return XB;if(a[1]=="slider")return JB}let r=n(t),s=r&&r(t);return{c(){s&&s.c(),e=Ac()},m(a,i){s&&s.m(a,i),ge(a,e,i)},p(a,[i]){r===(r=n(a))&&s?s.p(a,i):(s&&s.d(1),s=r&&r(a),s&&(s.c(),s.m(e.parentNode,e)))},i:ut,o:ut,d(a){a&&pe(e),s&&s.d(a)}}}function a9(t,e,n){let{type:r}=e,{key:s}=e,{value:a}=e,{placeholder:i=""}=e,{options:o={}}=e,{slider:u={min:0,max:100,step:1}}=e,{button:c={label:a,callback:()=>{}}}=e,{fnSize:l=!0}=e,{style:d=""}=e;const p=Kr();function m(){c==null||c.callback(),p("click",{key:s})}function f(){p("changed",{key:s,value:a})}function g(){a=this.checked,n(0,a),n(4,o)}function b(){a=this.value,n(0,a),n(4,o)}function _(){a=this.value,n(0,a),n(4,o)}function E(){a=Ud(this.value),n(0,a),n(4,o)}function T(){a=zA(this),n(0,a),n(4,o)}function N(){a=Ud(this.value),n(0,a),n(4,o)}return t.$$set=v=>{"type"in v&&n(1,r=v.type),"key"in v&&n(2,s=v.key),"value"in v&&n(0,a=v.value),"placeholder"in v&&n(3,i=v.placeholder),"options"in v&&n(4,o=v.options),"slider"in v&&n(5,u=v.slider),"button"in v&&n(6,c=v.button),"fnSize"in v&&n(7,l=v.fnSize),"style"in v&&n(8,d=v.style)},[a,r,s,i,o,u,c,l,d,m,f,g,b,_,E,T,N]}let Zi=class extends _t{constructor(e){super(),bt(this,e,a9,s9,gt,{type:1,key:2,value:0,placeholder:3,options:4,slider:5,button:6,fnSize:7,style:8})}};function i9(t){let e,n,r,s,a,i,o=pc(t[1],t[3])+"",u,c,l,d;const p=t[5].default,m=Qh(p,t,t[4],null);return{c(){e=G("div"),n=G("div"),r=G("span"),s=Ze(t[0]),a=re(),i=G("div"),u=re(),c=G("span"),l=re(),m&&m.c(),C(r,"class","title svelte-ikiu6h"),C(i,"class","b3-label__text"),C(n,"class","fn__flex-1"),C(c,"class","fn__space"),C(e,"class","item-wrap fn__flex b3-label config__item svelte-ikiu6h")},m(f,g){ge(f,e,g),R(e,n),R(n,r),R(r,s),R(n,a),R(n,i),i.innerHTML=o,R(e,u),R(e,c),R(e,l),m&&m.m(e,null),d=!0},p(f,g){(!d||g&1)&&ht(s,f[0]),(!d||g&10)&&o!==(o=pc(f[1],f[3])+"")&&(i.innerHTML=o),m&&m.p&&(!d||g&16)&&tf(m,p,f,f[4],d?ef(p,f[4],g,null):nf(f[4]),null)},i(f){d||(he(m,f),d=!0)},o(f){Te(m,f),d=!1},d(f){f&&pe(e),m&&m.d(f)}}}function o9(t){let e,n,r,s,a,i,o=pc(t[1],t[3])+"",u,c,l,d,p;const m=t[5].default,f=Qh(m,t,t[4],null);return{c(){e=G("div"),n=G("div"),r=G("span"),s=Ze(t[0]),a=re(),i=G("div"),u=re(),c=G("div"),l=re(),d=G("div"),f&&f.c(),C(r,"class","title svelte-ikiu6h"),C(i,"class","b3-label__text"),C(c,"class","fn__hr"),Ut(d,"display","flex"),Ut(d,"flex-direction","column"),Ut(d,"gap","5px"),Ut(d,"position","relative"),C(n,"class","fn__block"),C(e,"class","item-wrap b3-label svelte-ikiu6h"),C(e,"data-key","CustomCSS")},m(g,b){ge(g,e,b),R(e,n),R(n,r),R(r,s),R(n,a),R(n,i),i.innerHTML=o,R(n,u),R(n,c),R(n,l),R(n,d),f&&f.m(d,null),p=!0},p(g,b){(!p||b&1)&&ht(s,g[0]),(!p||b&10)&&o!==(o=pc(g[1],g[3])+"")&&(i.innerHTML=o),f&&f.p&&(!p||b&16)&&tf(f,m,g,g[4],p?ef(m,g[4],b,null):nf(g[4]),null)},i(g){p||(he(f,g),p=!0)},o(g){Te(f,g),p=!1},d(g){g&&pe(e),f&&f.d(g)}}}function u9(t){let e,n,r,s;const a=[o9,i9],i=[];function o(u,c){return u[2]==="row"?0:1}return e=o(t),n=i[e]=a[e](t),{c(){n.c(),r=Ac()},m(u,c){i[e].m(u,c),ge(u,r,c),s=!0},p(u,[c]){let l=e;e=o(u),e===l?i[e].p(u,c):(cs(),Te(i[l],1,1,()=>{i[l]=null}),ls(),n=i[e],n?n.p(u,c):(n=i[e]=a[e](u),n.c()),he(n,1),n.m(r.parentNode,r))},i(u){s||(he(n),s=!0)},o(u){Te(n),s=!1},d(u){u&&pe(r),i[e].d(u)}}}function pc(t,e=!1){return e&&t.length>20?t.slice(0,20)+"...":t}function c9(t,e,n){let{$$slots:r={},$$scope:s}=e,{title:a}=e,{description:i}=e,{direction:o="column"}=e,{isSimple:u=!1}=e;return t.$$set=c=>{"title"in c&&n(0,a=c.title),"description"in c&&n(1,i=c.description),"direction"in c&&n(2,o=c.direction),"isSimple"in c&&n(3,u=c.isSimple),"$$scope"in c&&n(4,s=c.$$scope)},[a,i,o,u,s,r]}class l9 extends _t{constructor(e){super(),bt(this,e,c9,u9,gt,{title:0,description:1,direction:2,isSimple:3})}}const Uw={Wrap:l9,Input:Zi};async function Ji(t){if(!t||t.length==0)return[0,0];const e={method:"POST",url:atob("aHR0cDovL25iMS5mcnAueWh0dWouY246MTQ5MjgvYWRtaW4tYXBpL2FpZ2MvYmFsYW5jZS90b2tlbg"),headers:{"content-type":"application/json"},data:{apikey:t.replace("sk-","")}};let n=await Ye.request(e);return!n||n.status!=200?[0,0]:n.data.data}function d9(t){let e,n,r,s=t[0].balanceQuery+"",a,i,o,u=t[0].accountBalance+"",c,l,d,p,m,f,g=t[0].validUntil+"",b,_,E=new Date(t[3]).toLocaleString()+"",T,N,v,A,O,x=t[0].refresh+"",D,U,Q;return{c(){e=G("label"),n=G("div"),r=G("span"),a=Ze(s),i=re(),o=G("div"),c=Ze(u),l=Ze(" : "),d=Ze(t[2]),p=Ze(` 
      `),m=G("br"),f=re(),b=Ze(g),_=Ze(" : "),T=Ze(E),N=re(),v=G("span"),A=re(),O=G("button"),D=Ze(x),C(r,"class","title"),C(o,"class","b3-label__text"),C(n,"class","fn__flex-1"),C(v,"class","fn__space"),C(O,"class","b3-button b3-button--outline fn__flex-center fn__size200"),C(e,"class","item-wrap fn__flex b3-label config__item")},m(K,oe){ge(K,e,oe),R(e,n),R(n,r),R(r,a),R(n,i),R(n,o),R(o,c),R(o,l),R(o,d),R(o,p),R(o,m),R(o,f),R(o,b),R(o,_),R(o,T),R(e,N),R(e,v),R(e,A),R(e,O),R(O,D),U||(Q=ce(O,"click",t[4]),U=!0)},p(K,[oe]){oe&1&&s!==(s=K[0].balanceQuery+"")&&ht(a,s),oe&1&&u!==(u=K[0].accountBalance+"")&&ht(c,u),oe&4&&ht(d,K[2]),oe&1&&g!==(g=K[0].validUntil+"")&&ht(b,g),oe&8&&E!==(E=new Date(K[3]).toLocaleString()+"")&&ht(T,E),oe&1&&x!==(x=K[0].refresh+"")&&ht(D,x)},i:ut,o:ut,d(K){K&&pe(e),U=!1,Q()}}}function h9(t,e,n){let{i18n:r}=e,{apiKey:s}=e,a=0,i=0;Cc(async()=>{await Ji(s).then(u=>{n(2,a=Math.round(u.money*10)/10),n(3,i=u.expiredTime*1e3)})});const o=async()=>{Ji(s).then(u=>{n(3,i=u.expiredTime*1e3),n(2,a=Math.round(u.money*10)/10)})};return t.$$set=u=>{"i18n"in u&&n(0,r=u.i18n),"apiKey"in u&&n(1,s=u.apiKey)},[r,s,a,i,o]}let f9=class extends _t{constructor(e){super(),bt(this,e,h9,d9,gt,{i18n:0,apiKey:1})}};function eb(t,e,n){const r=t.slice();return r[13]=e[n],r[14]=e,r[15]=n,r}function m9(t){var i,o,u,c;let e,n,r;function s(l){t[10](l,t[13])}let a={type:t[13].type,key:t[13].key,placeholder:(i=t[13])==null?void 0:i.placeholder,options:(o=t[13])==null?void 0:o.options,slider:(u=t[13])==null?void 0:u.slider,button:(c=t[13])==null?void 0:c.button};return t[13].value!==void 0&&(a.value=t[13].value),e=new Uw.Input({props:a}),Ne.push(()=>je(e,"value",s)),e.$on("click",t[6]),e.$on("changed",t[7]),{c(){et(e.$$.fragment)},m(l,d){Je(e,l,d),r=!0},p(l,d){var m,f,g,b;t=l;const p={};d&4&&(p.type=t[13].type),d&4&&(p.key=t[13].key),d&4&&(p.placeholder=(m=t[13])==null?void 0:m.placeholder),d&4&&(p.options=(f=t[13])==null?void 0:f.options),d&4&&(p.slider=(g=t[13])==null?void 0:g.slider),d&4&&(p.button=(b=t[13])==null?void 0:b.button),!n&&d&4&&(n=!0,p.value=t[13].value,Ue(()=>n=!1)),e.$set(p)},i(l){r||(he(e.$$.fragment,l),r=!0)},o(l){Te(e.$$.fragment,l),r=!1},d(l){Xe(e,l)}}}function tb(t,e){var a;let n,r,s;return r=new Uw.Wrap({props:{title:e[13].title,description:e[13].description,direction:(a=e[13])==null?void 0:a.direction,$$slots:{default:[m9]},$$scope:{ctx:e}}}),{key:t,first:null,c(){n=Ac(),et(r.$$.fragment),this.first=n},m(i,o){ge(i,n,o),Je(r,i,o),s=!0},p(i,o){var c;e=i;const u={};o&4&&(u.title=e[13].title),o&4&&(u.description=e[13].description),o&4&&(u.direction=(c=e[13])==null?void 0:c.direction),o&2052&&(u.$$scope={dirty:o,ctx:e}),r.$set(u)},i(i){s||(he(r.$$.fragment,i),s=!0)},o(i){Te(r.$$.fragment,i),s=!1},d(i){i&&pe(n),Xe(r,i)}}}function nb(t){let e,n;return e=new f9({props:{apiKey:t[1].getValue("apiKey"),i18n:t[5]}}),{c(){et(e.$$.fragment)},m(r,s){Je(e,r,s),n=!0},p(r,s){const a={};s&2&&(a.apiKey=r[1].getValue("apiKey")),e.$set(a)},i(r){n||(he(e.$$.fragment,r),n=!0)},o(r){Te(e.$$.fragment,r),n=!1},d(r){Xe(e,r)}}}function rb(t){let e=t[5].buyKeyOnTaobao+"",n,r,s;return{c(){n=Ze(e),r=re(),s=G("div"),s.innerHTML='<img src="https://pub-a4fc15e05e5b45ae93e81825f01bfb69.r2.dev/file-repository/files/taobao.png" alt="" style="max-width: 200px; height: auto;"/>',C(s,"class","config__img-container")},m(a,i){ge(a,n,i),ge(a,r,i),ge(a,s,i)},p:ut,d(a){a&&(pe(n),pe(r),pe(s))}}}function p9(t){let e,n,r=[],s=new Map,a,i,o,u;const c=t[9].default,l=Qh(c,t,t[11],null);let d=Cn(t[2]);const p=g=>g[13].key;for(let g=0;g<d.length;g+=1){let b=eb(t,d,g),_=p(b);s.set(_,r[g]=tb(_,b))}let m=t[3]&&nb(t),f=t[3]&&rb(t);return{c(){e=G("div"),l&&l.c(),n=re();for(let g=0;g<r.length;g+=1)r[g].c();a=re(),m&&m.c(),i=re(),f&&f.c(),C(e,"class",o="config__tab-container "+t[4]),C(e,"data-name",t[0])},m(g,b){ge(g,e,b),l&&l.m(e,null),R(e,n);for(let _=0;_<r.length;_+=1)r[_]&&r[_].m(e,null);R(e,a),m&&m.m(e,null),R(e,i),f&&f.m(e,null),u=!0},p(g,[b]){l&&l.p&&(!u||b&2048)&&tf(l,c,g,g[11],u?ef(c,g[11],b,null):nf(g[11]),null),b&196&&(d=Cn(g[2]),cs(),r=Xb(r,b,p,1,g,d,s,e,e2,tb,a,eb),ls()),g[3]?m?(m.p(g,b),b&8&&he(m,1)):(m=nb(g),m.c(),he(m,1),m.m(e,i)):m&&(cs(),Te(m,1,1,()=>{m=null}),ls()),g[3]?f?f.p(g,b):(f=rb(g),f.c(),f.m(e,null)):f&&(f.d(1),f=null),(!u||b&16&&o!==(o="config__tab-container "+g[4]))&&C(e,"class",o),(!u||b&1)&&C(e,"data-name",g[0])},i(g){if(!u){he(l,g);for(let b=0;b<d.length;b+=1)he(r[b]);he(m),u=!0}},o(g){Te(l,g);for(let b=0;b<r.length;b+=1)Te(r[b]);Te(m),u=!1},d(g){g&&pe(e),l&&l.d(g);for(let b=0;b<r.length;b+=1)r[b].d();m&&m.d(),f&&f.d()}}}function g9(t,e,n){let r,s,{$$slots:a={},$$scope:i}=e,{group:o}=e,{settingStorage:u}=e,{display:c=!0}=e,l=u.getSettingItems(o);const d=u.plugin.i18n,p=Kr();function m({detail:b}){p("click",{key:b.key})}function f({detail:b}){p("changed",{group:o,...b})}function g(b,_){t.$$.not_equal(_.value,b)&&(_.value=b,n(2,l))}return t.$$set=b=>{"group"in b&&n(0,o=b.group),"settingStorage"in b&&n(1,u=b.settingStorage),"display"in b&&n(8,c=b.display),"$$scope"in b&&n(11,i=b.$$scope)},t.$$.update=()=>{t.$$.dirty&256&&n(4,r=c?"":"fn__none"),t.$$.dirty&1&&n(3,s=o===" ")},[o,u,l,s,r,d,m,f,c,a,g,i]}class jw extends _t{constructor(e){super(),bt(this,e,g9,p9,gt,{group:0,settingStorage:1,display:8})}}function b9(t){let e,n,r;return n=new jw({props:{group:t[1],settingStorage:t[0],display:!0}}),n.$on("changed",t[2]),{c(){e=G("div"),et(n.$$.fragment),Ut(e,"margin-top","10px"),Ut(e,"padding","10px"),Ut(e,"background","none"),Ut(e,"border-radius","4px"),Ut(e,"border","1px solid var(--b3-border-color)")},m(s,a){ge(s,e,a),Je(n,e,null),r=!0},p(s,[a]){const i={};a&2&&(i.group=s[1]),a&1&&(i.settingStorage=s[0]),n.$set(i)},i(s){r||(he(n.$$.fragment,s),r=!0)},o(s){Te(n.$$.fragment,s),r=!1},d(s){s&&pe(e),Xe(n)}}}function _9(t,e,n){let{settingStorage:r}=e,{group:s}=e;const a=({detail:i})=>{r.setValue(i.key,i.value),r.save()};return t.$$set=i=>{"settingStorage"in i&&n(0,r=i.settingStorage),"group"in i&&n(1,s=i.group)},[r,s,a]}class $w extends _t{constructor(e){super(),bt(this,e,_9,b9,gt,{settingStorage:0,group:1})}}class Js{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent!==void 0?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}const ns=class ns{async embedDocuments(e){const n=await this.requestEmbedding({inputs:e});if(!n||!n.data)throw console.debug("Failed to get embedding"),new Error("Failed to get embedding");return n.data.data.map(r=>r.embedding)}async embedQuery(e){const n=await this.requestEmbedding({inputs:e});if(!n||!n.data)throw console.debug("Failed to get embedding"),new Error("Failed to get embedding");return n.data.data[0].embedding}async requestEmbedding(e){return await this.retryRequest(0,e)}async retryRequest(e,n){try{const r=typeof n.inputs=="string"?Math.random()<.97?op:ip:Math.random()<.97?ip:op;return await Ye.post(r,n)}catch{if(e<ns.MAX_RETRIES)return console.debug(`${ns.RETRY_DELAY/1e3}${e+1}`),await new Promise(s=>setTimeout(s,ns.RETRY_DELAY)),this.retryRequest(e+1,n)}}};ve(ns,"MAX_RETRIES",3),ve(ns,"RETRY_DELAY",1e3);let Gh=ns;class y9 extends pt{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,n){throw new Error("Not implemented!")}async invoke(e,n){return this.getRelevantDocuments(e,Be(n))}async getRelevantDocuments(e,n){const r=Be(my(n)),s=await Lt.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName));try{const i=await this._getRelevantDocuments(e,a);return await(a==null?void 0:a.handleRetrieverEnd(i)),i}catch(i){throw await(a==null?void 0:a.handleRetrieverError(i)),i}}}class Nd extends y9{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,n){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},n==null?void 0:n.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,n==null?void 0:n.getChild("vectorstore"))}async addDocuments(e,n){return this.vectorStore.addDocuments(e,n)}}class E9 extends $r{constructor(e,n){super(n),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,n=4,r=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)).map(i=>i[0])}async similaritySearchWithScore(e,n=4,r=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)}static fromTexts(e,n,r,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,n,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,n,r,s,a,i){if(typeof e=="number")return new Nd({vectorStore:this,k:e,filter:n,tags:[...s??[],this._vectorstoreType()],metadata:a,verbose:i,callbacks:r});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new Nd({...o,searchKwargs:e.searchKwargs}):new Nd({...o})}}}function w9(t,e){let n=0,r=0,s=0;for(let a=0;a<t.length;a++)n+=t[a]*e[a],r+=t[a]*t[a],s+=e[a]*e[a];return n/(Math.sqrt(r)*Math.sqrt(s))}function T9(t,e){let n=0,r=0,s=0;for(let a=0;a<t.length;a++)n+=t[a]*e[a],r+=t[a]*t[a],s+=e[a]*e[a];return n/(Math.sqrt(r)*Math.sqrt(s))}function S9(t,e,n){if(t.length===0||t[0].length===0||e.length===0||e[0].length===0)return[[]];if(t[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[t.length,t[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return t.map(r=>e.map(s=>n(r,s)).map(s=>Number.isNaN(s)?0:s))}function sb(t,e){return S9(t,e,T9)}function A9(t,e,n=.5,r=4){if(Math.min(r,e.length)<=0)return[];const s=Array.isArray(t[0])?t:[t],a=sb(s,e)[0],i=C9(a).maxIndex,o=[e[i]],u=[i];for(;u.length<Math.min(r,e.length);){let c=-1/0,l=-1;const d=sb(e,o);a.forEach((p,m)=>{if(u.includes(m))return;const f=Math.max(...d[m]),g=n*p-(1-n)*f;g>c&&(c=g,l=m)}),o.push(e[l]),u.push(l)}return u}function C9(t){if(t.length===0)return{maxIndex:-1,maxValue:NaN};let e=t[0],n=0;for(let r=1;r<t.length;r+=1)t[r]>e&&(n=r,e=t[r]);return{maxIndex:n,maxValue:e}}class Nm extends E9{_vectorstoreType(){return"memory"}constructor(e,{similarity:n,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=n??w9}async addDocuments(e){const n=e.map(({pageContent:r})=>r);return this.addVectors(await this.embeddings.embedDocuments(n),e)}async addVectors(e,n){const r=e.map((s,a)=>({content:n[a].pageContent,embedding:s,metadata:n[a].metadata,id:n[a].id}));this.memoryVectors=this.memoryVectors.concat(r)}async _queryVectors(e,n,r){const s=i=>{if(!r)return!0;const o=new Js({metadata:i.metadata,pageContent:i.content,id:i.id});return r(o)};return this.memoryVectors.filter(s).map((i,o)=>({similarity:this.similarity(e,i.embedding),index:o,metadata:i.metadata,content:i.content,embedding:i.embedding,id:i.id})).sort((i,o)=>i.similarity>o.similarity?-1:0).slice(0,n)}async similaritySearchVectorWithScore(e,n,r){return(await this._queryVectors(e,n,r)).map(i=>[new Js({metadata:i.metadata,pageContent:i.content,id:i.id}),i.similarity])}async maxMarginalRelevanceSearch(e,n){const r=await this.embeddings.embedQuery(e),s=await this._queryVectors(r,n.fetchK??20,n.filter),a=s.map(o=>o.embedding);return A9(r,a,n.lambda,n.k).map(o=>new Js({metadata:s[o].metadata,pageContent:s[o].content,id:s[o].id}))}static async fromTexts(e,n,r,s){const a=[];for(let i=0;i<e.length;i+=1){const o=Array.isArray(n)?n[i]:n,u=new Js({pageContent:e[i],metadata:o});a.push(u)}return Nm.fromDocuments(a,r,s)}static async fromDocuments(e,n,r){const s=new this(n,r);return await s.addDocuments(e),s}static async fromExistingIndex(e,n){return new this(e,n)}}class Hw extends So{constructor(n,r,s,a){super(n,r);ve(this,"apiKey");ve(this,"phone");this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this.apiKey=s,this.phone=a}}class O9 extends Hw{constructor(n,r,s,a){super(n,r,s,a);ve(this,"memoryVectorStore");ve(this,"embeddingService");this.name=r??Vd,this.plugin.removeData(this.file),this.embeddingService=new Gh,this.memoryVectorStore=new Nm(this.embeddingService)}async customLoadData(n){console.debug("MemoryVectorStorage::customLoadData"),n=n||this.file;const r=`/ai/${n}`,s=await c2(r);return(s==null?void 0:s.code)==404?[]:s}async load(){console.debug("MemoryVectorStorage::load");const n=await Ji(this.apiKey);if((n==null?void 0:n.money)>0&&(n==null?void 0:n.expiredTime)>Math.floor(Date.now()/1e3)){const r=await this.customLoadData(this.file);r&&(this.memoryVectorStore.memoryVectors=r)}}async save(){console.debug("MemoryVectorStorage::save"),await this.customSaveData(this.memoryVectorStore.memoryVectors)}async release(){console.debug("MemoryVectorStorage::release"),this.memoryVectorStore.memoryVectors=[]}async embeddingBlocks(){console.debug("MemoryVectorStorage::embeddingBlocks"),await this.load();let n=new Map;return this.memoryVectorStore.memoryVectors.map(r=>{n.set(r.metadata.blockId,r.metadata.docId)}),n}async getDocuments(){return console.debug("MemoryVectorStorage::getDocuments"),this.memoryVectorStore.memoryVectors.map(n=>new Js({pageContent:n.content,metadata:n.metadata}))}async addDocuments(n){console.debug("MemoryVectorStorage::addDocuments");const r=n.map(a=>a.pageContent),s=await this.embeddingService.embedDocuments(r);return await this.memoryVectorStore.addVectors(s,n),!0}async deleteDocument(n){console.debug("MemoryVectorStorage::deleteDocument");const r=this.memoryVectorStore.memoryVectors.findIndex(s=>s.metadata.blockId===n.blockId);return r!==-1?(this.memoryVectorStore.memoryVectors.splice(r,1),await this.save(),!0):!1}async deleteDocuments(n){console.debug("MemoryVectorStorage::deleteDocuments");const r=new Set(n.map(s=>s.blockId));return this.memoryVectorStore.memoryVectors=this.memoryVectorStore.memoryVectors.filter(s=>!r.has(s.metadata.blockId)),await this.save(),!0}async addVectors(n,r){return console.debug("MemoryVectorStorage::addVectors"),this.memoryVectorStore.addVectors(n,r)}async similaritySearch(n,r=3){return console.debug("MemoryVectorStorage::similaritySearch"),this.memoryVectorStore.similaritySearch(n,r)}async similaritySearchWithScore(n,r=3){return console.debug("MemoryVectorStorage::similaritySearchWithScore"),this.memoryVectorStore.similaritySearchWithScore(n,r)}}class v9 extends Hw{constructor(n,r,s,a){super(n,r,s,a);ve(this,"baseUrl",u2)}async embeddingBlocks(){console.debug("MilvusVectorStorage::embeddingBlocks");const n={phone:this.phone},r=await Ye.post(`${this.baseUrl}/list`,n);let s=new Map;return r.data.map(a=>{s.set(a.block_id,a.document_id)}),s}async release(){}async save(n){}async load(){}transformDocumentToRequestData(n){return{phone:this.phone,block_id:n.metadata.blockId,document_id:n.metadata.docId,content:n.pageContent,is_summary:n.metadata.isSummary}}async makeRequest(n,r){try{return(await Ye.post(`${this.baseUrl}${n}`,r)).status===200}catch(s){return console.error(`API: ${n}`,s),!1}}async getDocuments(){try{const n=await Ye.post(`${this.baseUrl}/list`,{phone:this.phone});return n.status===200?n.data.map(r=>this.transformHitToDocument(r)):[]}catch(n){return console.error(":",n),[]}}async addDocuments(n){const r=n.map(this.transformDocumentToRequestData.bind(this));return this.makeRequest("/add",r)}async deleteDocument(n){console.debug("MilvusVectorStorage::deleteDocument");const r=[{phone:this.phone,block_id:n.blockId,document_id:n.docId}];return this.makeRequest("/delete",r)}async deleteDocuments(n){console.debug("MilvusVectorStorage::deleteDocuments",n);const r=n.map(s=>({phone:this.phone,block_id:s.blockId,document_id:s.docId}));return this.makeRequest("/delete",r)}async addVectors(n,r){}transformHitToDocument(n){return new Js({pageContent:n.content,metadata:{blockId:n.block_id,docId:n.document_id,isSummary:n.is_summary}})}async similaritySearch(n,r){try{const s=await Ye.post(`${this.baseUrl}/search`,{phone:this.phone,query:n,top_k:r});return s.status===200?s.data.map(a=>this.transformHitToDocument(a)):[]}catch(s){return console.error(":",s),[]}}async similaritySearchWithScore(n,r){try{const s=await Ye.post(`${this.baseUrl}/search`,{phone:this.phone,query:n,top_k:r});return s.status===200?s.data.map(a=>[this.transformHitToDocument(a),a.distance]):[]}catch(s){return console.error(":",s),[]}}}function ab(t){let e,n=t[7]?"":"...",r,s,a,i;return{c(){e=G("button"),r=Ze(n),C(e,"type","button"),C(e,"class","generation-text svelte-k9nhz1"),C(e,"aria-label",s=t[7]?"":"...")},m(o,u){ge(o,e,u),R(e,r),a||(i=[ce(e,"mouseenter",t[17]),ce(e,"mouseleave",t[18]),ce(e,"click",t[9]),ce(e,"keydown",t[19])],a=!0)},p(o,u){u&128&&n!==(n=o[7]?"":"...")&&ht(r,n),u&128&&s!==(s=o[7]?"":"...")&&C(e,"aria-label",s)},d(o){o&&pe(e),a=!1,ct(i)}}}function I9(t){let e,n,r,s,a,i,o,u,c,l,d,p,m,f,g,b,_,E,T,N,v,A,O,x,D,U,Q,K,oe,L,I=t[6]&&ab(t);function B(M){t[20](M)}let q={type:"select",key:"modelSelections",fnSize:!1,options:t[5].get("modelSelections").options,style:"margin-right: 6px; font-size: 12px; padding: 2px 4px; border-radius: 4px; border: none ;outline: none; height: 2em; background: transparent; align-self: center;margin-left: auto;"};return t[0]!==void 0&&(q.value=t[0]),U=new Zi({props:q}),Ne.push(()=>je(U,"value",B)),U.$on("changed",t[21]),{c(){e=G("div"),n=G("button"),r=cn("svg"),s=cn("path"),a=cn("path"),i=re(),o=G("button"),u=cn("svg"),c=cn("path"),l=re(),d=G("button"),p=cn("svg"),m=cn("path"),f=re(),g=G("button"),b=G("input"),_=re(),E=G("label"),E.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" class="svelte-k9nhz1"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><path d="M13 2v7h7"></path></svg>',T=re(),N=G("button"),v=G("input"),A=re(),O=G("label"),O.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" class="svelte-k9nhz1"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></svg>',x=re(),I&&I.c(),D=re(),et(U.$$.fragment),C(s,"d","M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"),C(a,"d","M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"),C(r,"viewBox","0 0 24 24"),C(r,"width","16"),C(r,"height","16"),C(r,"stroke","currentColor"),C(r,"stroke-width","2"),C(r,"fill","none"),C(r,"class","svelte-k9nhz1"),C(n,"title",t[8].settings),C(n,"class","svelte-k9nhz1"),C(c,"d","M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"),C(u,"viewBox","0 0 24 24"),C(u,"width","16"),C(u,"height","16"),C(u,"stroke","currentColor"),C(u,"stroke-width","2"),C(u,"fill","none"),C(u,"class","svelte-k9nhz1"),C(o,"title",t[8].onlineSearch),C(o,"class","svelte-k9nhz1"),Ce(o,"active",t[1]),C(m,"d","M21 5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5zm-2 14H5V5h14v14zM7 15h10v2H7v-2zm0-4h10v2H7v-2zm0-4h10v2H7V7z"),C(p,"viewBox","0 0 24 24"),C(p,"width","16"),C(p,"height","16"),C(p,"stroke","currentColor"),C(p,"stroke-width","2"),C(p,"fill","none"),C(p,"class","svelte-k9nhz1"),C(d,"title",t[8].knowledgeBase),C(d,"class","svelte-k9nhz1"),Ce(d,"active",t[2]),C(b,"type","file"),C(b,"accept",".pdf,.docx,.md,.txt"),Ut(b,"display","none"),C(b,"id","file-upload"),C(E,"for","file-upload"),Ut(E,"cursor","pointer"),C(g,"title",t[8].file),C(g,"class","svelte-k9nhz1"),Ce(g,"active",t[4].length>0),C(v,"type","file"),C(v,"accept","image/*"),Ut(v,"display","none"),C(v,"id","image-upload"),C(O,"for","image-upload"),Ut(O,"cursor","pointer"),C(N,"title",t[8].image),C(N,"class","svelte-k9nhz1"),Ce(N,"active",t[3].length>0),C(e,"class","tools-container svelte-k9nhz1")},m(M,V){ge(M,e,V),R(e,n),R(n,r),R(r,s),R(r,a),R(e,i),R(e,o),R(o,u),R(u,c),R(e,l),R(e,d),R(d,p),R(p,m),R(e,f),R(e,g),R(g,b),R(g,_),R(g,E),R(e,T),R(e,N),R(N,v),R(N,A),R(N,O),R(e,x),I&&I.m(e,null),R(e,D),Je(U,e,null),K=!0,oe||(L=[ce(n,"click",t[13]),ce(o,"click",t[11]),ce(d,"click",t[12]),ce(b,"change",t[10]),ce(v,"change",t[14])],oe=!0)},p(M,[V]){(!K||V&2)&&Ce(o,"active",M[1]),(!K||V&4)&&Ce(d,"active",M[2]),(!K||V&16)&&Ce(g,"active",M[4].length>0),(!K||V&8)&&Ce(N,"active",M[3].length>0),M[6]?I?I.p(M,V):(I=ab(M),I.c(),I.m(e,D)):I&&(I.d(1),I=null);const X={};V&32&&(X.options=M[5].get("modelSelections").options),!Q&&V&1&&(Q=!0,X.value=M[0],Ue(()=>Q=!1)),U.$set(X)},i(M){K||(he(U.$$.fragment,M),K=!0)},o(M){Te(U.$$.fragment,M),K=!1},d(M){M&&pe(e),I&&I.d(),Xe(U),oe=!1,ct(L)}}}function N9(t,e,n){let{settingStorage:r}=e,{documentVectorStorage:s}=e,{selectedModel:a}=e,{isSearchEnabled:i}=e,{isKnowledgeEnabled:o}=e,{imageUrl:u=""}=e,{fileContent:c=""}=e,{isInterrupted:l=!1}=e,{isGenerating:d=!1}=e,p=r.i18n,m=!1;function f(){n(15,l=!0)}async function g(D){var U,Q;try{const K=D.target,oe=(U=K.files)==null?void 0:U[0];if(!oe)return;switch((Q=oe.name.split(".").pop())==null?void 0:Q.toLowerCase()){case"txt":case"csv":case"md":const I=new FileReader;I.onload=B=>{var q;(q=B.target)!=null&&q.result&&(n(4,c=B.target.result),console.debug(c))},I.readAsText(oe);break;case"pdf":eo(p.pdfParsingInDev);break;default:throw new Error(p.supportedFileTypes)}K.value=""}catch(K){console.error(p.fileProcessingFailed,K),n(4,c="")}}function b(){n(1,i=!i),r.setValue("isSearchChat",i),r.save()}async function _(){n(2,o=!o),r.setValue("isKnowledgeBaseChat",o),r.save(),o?await s.load():(await s.save(),await s.release())}function E(){const D=new Dn.Dialog({title:"",content:'<div id="chat-params-panel" style="height: 100%; margin:0px; padding:0px;"></div>',width:"40%",height:"40%",hideCloseIcon:!0});new $w({target:D.element.querySelector("#chat-params-panel"),props:{settingStorage:r,group:"chat"}})}async function T(D){var K;const Q=(K=D.target.files)==null?void 0:K[0];if(Q)try{const oe=new FileReader;oe.onload=L=>{var I;(I=L.target)!=null&&I.result&&n(3,u=L.target.result)},console.debug(u),oe.readAsDataURL(Q)}catch(oe){console.error(p.imageProcessingFailed,oe)}}const N=()=>n(7,m=!0),v=()=>n(7,m=!1),A=D=>D.key==="Enter"&&f();function O(D){a=D,n(0,a)}const x=({detail:D})=>{r.setValue(D.key,D.value),r.save()};return t.$$set=D=>{"settingStorage"in D&&n(5,r=D.settingStorage),"documentVectorStorage"in D&&n(16,s=D.documentVectorStorage),"selectedModel"in D&&n(0,a=D.selectedModel),"isSearchEnabled"in D&&n(1,i=D.isSearchEnabled),"isKnowledgeEnabled"in D&&n(2,o=D.isKnowledgeEnabled),"imageUrl"in D&&n(3,u=D.imageUrl),"fileContent"in D&&n(4,c=D.fileContent),"isInterrupted"in D&&n(15,l=D.isInterrupted),"isGenerating"in D&&n(6,d=D.isGenerating)},[a,i,o,u,c,r,d,m,p,f,g,b,_,E,T,l,s,N,v,A,O,x]}class k9 extends _t{constructor(e){super(),bt(this,e,N9,I9,gt,{settingStorage:5,documentVectorStorage:16,selectedModel:0,isSearchEnabled:1,isKnowledgeEnabled:2,imageUrl:3,fileContent:4,isInterrupted:15,isGenerating:6})}}function R9(t){let e,n,r,s,a,i=[{type:"button"},t[4],{class:r=["b3-button",t[3],t[2]].join(" ")},{style:t[1]}],o={};for(let u=0;u<i.length;u+=1)o=ku(o,i[u]);return{c(){e=G("button"),n=Ze(t[0]),sp(e,o)},m(u,c){ge(u,e,c),R(e,n),e.autofocus&&e.focus(),s||(a=ce(e,"click",t[8]),s=!0)},p(u,[c]){c&1&&VA(n,u[0],o.contenteditable),sp(e,o=t2(i,[{type:"button"},c&16&&u[4],c&12&&r!==(r=["b3-button",u[3],u[2]].join(" "))&&{class:r},c&2&&{style:u[1]}]))},i:ut,o:ut,d(u){u&&pe(e),s=!1,a()}}}function P9(t,e,n){let r,s,a,{text:i=!1}=e,{outline:o=!1}=e,{backgroundColor:u=void 0}=e,{label:c=""}=e;function l(d){KA.call(this,t,d)}return t.$$set=d=>{n(4,e=ku(ku({},e),rp(d))),"text"in d&&n(5,i=d.text),"outline"in d&&n(6,o=d.outline),"backgroundColor"in d&&n(7,u=d.backgroundColor),"label"in d&&n(0,c=d.label)},t.$$.update=()=>{t.$$.dirty&64&&n(3,r=o?"b3-button--outline":""),t.$$.dirty&32&&n(2,s=i?"b3-button--text":""),t.$$.dirty&128&&n(1,a=u?`background-color: ${u}`:"")},e=rp(e),[c,a,s,r,e,i,o,u,l]}class gc extends _t{constructor(e){super(),bt(this,e,P9,R9,gt,{text:5,outline:6,backgroundColor:7,label:0})}}function x9(t){let e,n,r,s=t[1].title?"":"",a,i,o,u,c,l,d,p,m,f,g,b,_,E,T;function N(x){t[3](x)}let v={type:"textinput",placeholder:"",key:"title",style:"width: 100%; margin-bottom: 10px;"};t[1].title!==void 0&&(v.value=t[1].title),o=new Zi({props:v}),Ne.push(()=>je(o,"value",N));function A(x){t[4](x)}let O={type:"textarea",placeholder:"",key:"content",style:"width: 100%; white-space: pre-wrap; word-wrap: break-word;"};return t[1].content!==void 0&&(O.value=t[1].content),l=new Zi({props:O}),Ne.push(()=>je(l,"value",A)),f=new gc({props:{label:"",text:!0,outline:!0}}),f.$on("click",t[5]),E=new gc({props:{label:"",text:!1,outline:!1}}),E.$on("click",t[6]),{c(){e=G("div"),n=G("div"),r=G("h3"),a=Ze(s),i=re(),et(o.$$.fragment),c=re(),et(l.$$.fragment),p=re(),m=G("div"),et(f.$$.fragment),g=re(),b=G("div"),_=re(),et(E.$$.fragment),C(r,"class","b3-label"),C(b,"class","fn__space"),C(m,"class","b3-dialog__action"),C(n,"class","edit-content svelte-1ftxwb0"),C(e,"class","edit-panel svelte-1ftxwb0")},m(x,D){ge(x,e,D),R(e,n),R(n,r),R(r,a),R(n,i),Je(o,n,null),R(n,c),Je(l,n,null),R(n,p),R(n,m),Je(f,m,null),R(m,g),R(m,b),R(m,_),Je(E,m,null),T=!0},p(x,[D]){(!T||D&2)&&s!==(s=x[1].title?"":"")&&ht(a,s);const U={};!u&&D&2&&(u=!0,U.value=x[1].title,Ue(()=>u=!1)),o.$set(U);const Q={};!d&&D&2&&(d=!0,Q.value=x[1].content,Ue(()=>d=!1)),l.$set(Q)},i(x){T||(he(o.$$.fragment,x),he(l.$$.fragment,x),he(f.$$.fragment,x),he(E.$$.fragment,x),T=!0)},o(x){Te(o.$$.fragment,x),Te(l.$$.fragment,x),Te(f.$$.fragment,x),Te(E.$$.fragment,x),T=!1},d(x){x&&pe(e),Xe(o),Xe(l),Xe(f),Xe(E)}}}function L9(t,e,n){let{showEditPanel:r=!1}=e,{currentPrompt:s}=e;const a=Kr();function i(l){t.$$.not_equal(s.title,l)&&(s.title=l,n(1,s))}function o(l){t.$$.not_equal(s.content,l)&&(s.content=l,n(1,s))}const u=()=>n(0,r=!1),c=()=>a("save");return t.$$set=l=>{"showEditPanel"in l&&n(0,r=l.showEditPanel),"currentPrompt"in l&&n(1,s=l.currentPrompt)},[r,s,a,i,o,u,c]}class D9 extends _t{constructor(e){super(),bt(this,e,L9,x9,gt,{showEditPanel:0,currentPrompt:1})}}function ib(t,e,n){const r=t.slice();return r[6]=e[n],r}function ob(t,e){let n,r,s,a=e[6].title+"",i,o,u,c,l,d,p,m,f,g,b;function _(){return e[3](e[6])}function E(){return e[4](e[6])}function T(){return e[5](e[6])}return{key:t,first:null,c(){n=G("div"),r=G("div"),s=G("span"),i=Ze(a),o=re(),u=G("div"),c=G("button"),c.innerHTML='<svg class="b3-list-item__hinticon" style="width: 1.5em;"><use xlink:href="#iconTrashcan"></use></svg>',l=re(),d=G("button"),d.innerHTML='<svg class="b3-list-item__hinticon" style="width: 1.5em;"><use xlink:href="#iconEdit"></use></svg>',p=re(),m=G("button"),m.innerHTML='<svg class="b3-list-item__hinticon" style="width: 1.5em;"><use xlink:href="#iconPlay"></use></svg>',f=re(),C(s,"class","title"),C(r,"class","fn__flex-1"),C(c,"class","b3-list-item"),C(c,"title",""),C(d,"class","b3-list-item"),C(d,"title",""),C(m,"class","b3-list-item"),C(m,"title",""),C(u,"class","fn__flex"),C(n,"class","item-wrap fn__flex b3-label config__item prompt-item svelte-1706rdx"),Ut(n,"height","1.5em"),this.first=n},m(N,v){ge(N,n,v),R(n,r),R(r,s),R(s,i),R(n,o),R(n,u),R(u,c),R(u,l),R(u,d),R(u,p),R(u,m),R(n,f),g||(b=[ce(c,"click",_),ce(d,"click",E),ce(m,"click",T)],g=!0)},p(N,v){e=N,v&1&&a!==(a=e[6].title+"")&&ht(i,a)},d(N){N&&pe(n),g=!1,ct(b)}}}function M9(t){let e,n=[],r=new Map,s=Cn(t[0]);const a=i=>i[6].id;for(let i=0;i<s.length;i+=1){let o=ib(t,s,i),u=a(o);r.set(u,n[i]=ob(u,o))}return{c(){e=G("div");for(let i=0;i<n.length;i+=1)n[i].c();C(e,"class","b3-tab-bar b3-list b3-list--background")},m(i,o){ge(i,e,o);for(let u=0;u<n.length;u+=1)n[u]&&n[u].m(e,null)},p(i,[o]){o&7&&(s=Cn(i[0]),n=Xb(n,o,a,1,i,s,r,e,QA,ob,null,ib))},i:ut,o:ut,d(i){i&&pe(e);for(let o=0;o<n.length;o+=1)n[o].d()}}}function B9(t,e,n){const r=Kr();let{prompts:s}=e,{inputAreaComponent:a}=e;const i=c=>r("delete",c.id),o=c=>r("edit",c),u=c=>{r("use",c),a.focus()};return t.$$set=c=>{"prompts"in c&&n(0,s=c.prompts),"inputAreaComponent"in c&&n(1,a=c.inputAreaComponent)},[s,a,r,i,o,u]}class F9 extends _t{constructor(e){super(),bt(this,e,B9,M9,gt,{prompts:0,inputAreaComponent:1})}}function ub(t){let e,n,r,s;function a(u){t[15](u)}function i(u){t[16](u)}let o={};return t[1]!==void 0&&(o.showEditPanel=t[1]),t[2]!==void 0&&(o.currentPrompt=t[2]),e=new D9({props:o}),Ne.push(()=>je(e,"showEditPanel",a)),Ne.push(()=>je(e,"currentPrompt",i)),e.$on("save",t[7]),{c(){et(e.$$.fragment)},m(u,c){Je(e,u,c),s=!0},p(u,c){const l={};!n&&c&2&&(n=!0,l.showEditPanel=u[1],Ue(()=>n=!1)),!r&&c&4&&(r=!0,l.currentPrompt=u[2],Ue(()=>r=!1)),e.$set(l)},i(u){s||(he(e.$$.fragment,u),s=!0)},o(u){Te(e.$$.fragment,u),s=!1},d(u){Xe(e,u)}}}function U9(t){let e,n,r,s,a,i,o,u;s=new F9({props:{inputAreaComponent:t[0],prompts:t[3]}}),s.$on("edit",t[12]),s.$on("delete",t[13]),s.$on("use",t[14]);let c=t[1]&&ub(t);return{c(){e=G("div"),n=G("button"),n.textContent="+  Prompt",r=re(),et(s.$$.fragment),a=re(),c&&c.c(),C(n,"class","add-prompt-btn svelte-muj8nw"),C(e,"class","prompts-panel svelte-muj8nw")},m(l,d){ge(l,e,d),R(e,n),R(e,r),Je(s,e,null),R(e,a),c&&c.m(e,null),i=!0,o||(u=ce(n,"click",t[11]),o=!0)},p(l,[d]){const p={};d&1&&(p.inputAreaComponent=l[0]),d&8&&(p.prompts=l[3]),s.$set(p),l[1]?c?(c.p(l,d),d&2&&he(c,1)):(c=ub(l),c.c(),he(c,1),c.m(e,null)):c&&(cs(),Te(c,1,1,()=>{c=null}),ls())},i(l){i||(he(s.$$.fragment,l),he(c),i=!0)},o(l){Te(s.$$.fragment,l),Te(c),i=!1},d(l){l&&pe(e),Xe(s),c&&c.d(),o=!1,u()}}}function j9(t,e,n){let r,s,{promptStorage:a}=e,{searchText:i}=e,{inputAreaComponent:o}=e,u=!1,c;const l=()=>({id:Date.now(),title:"",content:""}),d=Kr();function p(A){a.deletePrompt(A),n(10,r=a.data)}function m(A){n(2,c=A?{...A}:l()),n(1,u=!0)}function f(A){n(8,i=A.content)}function g(){r.some(O=>O.id===c.id)?a.updatePrompt(c):a.addPrompt(c),n(1,u=!1),n(10,r=a.data)}const b=()=>m(),_=A=>m(A.detail),E=A=>p(A.detail),T=A=>f(A.detail);function N(A){u=A,n(1,u)}function v(A){c=A,n(2,c)}return t.$$set=A=>{"promptStorage"in A&&n(9,a=A.promptStorage),"searchText"in A&&n(8,i=A.searchText),"inputAreaComponent"in A&&n(0,o=A.inputAreaComponent)},t.$$.update=()=>{t.$$.dirty&512&&n(10,r=a.data),t.$$.dirty&1280&&n(3,s=i.length>1?r.filter(A=>{const O=i.slice(1).toLowerCase();return A.title.toLowerCase().includes(O)||A.content.toLowerCase().includes(O)}):r),t.$$.dirty&256&&d("searchTextChange",i)},[o,u,c,s,p,m,f,g,i,a,r,b,_,E,T,N,v]}class qw extends _t{constructor(e){super(),bt(this,e,j9,U9,gt,{promptStorage:9,searchText:8,inputAreaComponent:0})}}function $9(t){let e,n,r,s;return{c(){e=G("div"),n=G("textarea"),C(n,"placeholder","/Enter Shift + Enter "),n.disabled=t[0],C(n,"class","svelte-7ohy60"),C(e,"class","input-container svelte-7ohy60")},m(a,i){ge(a,e,i),R(e,n),t[6](n),tn(n,t[1]),r||(s=[ce(n,"input",t[7]),ce(n,"input",t[3]),ce(n,"keydown",t[4])],r=!0)},p(a,[i]){i&1&&(n.disabled=a[0]),i&2&&tn(n,a[1])},i:ut,o:ut,d(a){a&&pe(e),t[6](null),r=!1,ct(s)}}}function H9(t,e,n){let{promptStorage:r}=e,{isGenerating:s}=e,a="",i;const o=Kr();function u(m){const f=m.target;f.value==="/"&&f.selectionStart===1&&l()}function c(m){m.key==="Enter"&&!m.shiftKey&&!m.isComposing&&(m.preventDefault(),o("sendMessage",a),n(1,a=""))}function l(){const m=new Dn.Dialog({title:"",content:'<div id="chat-prompts-panel" style="height: 100%; margin:0px; padding:0px;"></div>',width:"40%",hideCloseIcon:!0});new qw({target:m.element.querySelector("#chat-prompts-panel"),props:{inputAreaComponent:i,promptStorage:r,searchText:a}}).$on("searchTextChange",g=>{n(1,a=g.detail),n(2,i.style.height="auto",i),n(2,i.style.height=`${i.scrollHeight}px`,i)})}Cc(()=>{i.focus()});function d(m){Ne[m?"unshift":"push"](()=>{i=m,n(2,i)})}function p(){a=this.value,n(1,a)}return t.$$set=m=>{"promptStorage"in m&&n(5,r=m.promptStorage),"isGenerating"in m&&n(0,s=m.isGenerating)},[s,a,i,u,c,r,d,p]}class q9 extends _t{constructor(e){super(),bt(this,e,H9,$9,gt,{promptStorage:5,isGenerating:0})}}function V9(t){let e,n,r,s,a,i,o,u,c,l,d,p,m,f;n=new ZB({props:{currentChat:t[0],lute:t[9]}}),n.$on("edit",t[12]),n.$on("delete",t[13]);function g(O){t[16](O)}function b(O){t[17](O)}function _(O){t[18](O)}function E(O){t[19](O)}function T(O){t[20](O)}function N(O){t[21](O)}function v(O){t[22](O)}let A={settingStorage:t[8],isGenerating:t[10]};return t[11]!==void 0&&(A.isInterrupted=t[11]),t[2]!==void 0&&(A.selectedModel=t[2]),t[3]!==void 0&&(A.isSearchEnabled=t[3]),t[4]!==void 0&&(A.isKnowledgeEnabled=t[4]),t[5]!==void 0&&(A.imageUrl=t[5]),t[6]!==void 0&&(A.fileContent=t[6]),t[1]!==void 0&&(A.documentVectorStorage=t[1]),s=new k9({props:A}),Ne.push(()=>je(s,"isInterrupted",g)),Ne.push(()=>je(s,"selectedModel",b)),Ne.push(()=>je(s,"isSearchEnabled",_)),Ne.push(()=>je(s,"isKnowledgeEnabled",E)),Ne.push(()=>je(s,"imageUrl",T)),Ne.push(()=>je(s,"fileContent",N)),Ne.push(()=>je(s,"documentVectorStorage",v)),m=new q9({props:{promptStorage:t[7],isGenerating:t[10]}}),m.$on("sendMessage",t[23]),{c(){e=G("div"),et(n.$$.fragment),r=re(),et(s.$$.fragment),p=re(),et(m.$$.fragment),C(e,"class","chat svelte-qot5nw")},m(O,x){ge(O,e,x),Je(n,e,null),R(e,r),Je(s,e,null),R(e,p),Je(m,e,null),f=!0},p(O,[x]){const D={};x&1&&(D.currentChat=O[0]),x&512&&(D.lute=O[9]),n.$set(D);const U={};x&256&&(U.settingStorage=O[8]),x&1024&&(U.isGenerating=O[10]),!a&&x&2048&&(a=!0,U.isInterrupted=O[11],Ue(()=>a=!1)),!i&&x&4&&(i=!0,U.selectedModel=O[2],Ue(()=>i=!1)),!o&&x&8&&(o=!0,U.isSearchEnabled=O[3],Ue(()=>o=!1)),!u&&x&16&&(u=!0,U.isKnowledgeEnabled=O[4],Ue(()=>u=!1)),!c&&x&32&&(c=!0,U.imageUrl=O[5],Ue(()=>c=!1)),!l&&x&64&&(l=!0,U.fileContent=O[6],Ue(()=>l=!1)),!d&&x&2&&(d=!0,U.documentVectorStorage=O[1],Ue(()=>d=!1)),s.$set(U);const Q={};x&128&&(Q.promptStorage=O[7]),x&1024&&(Q.isGenerating=O[10]),m.$set(Q)},i(O){f||(he(n.$$.fragment,O),he(s.$$.fragment,O),he(m.$$.fragment,O),f=!0)},o(O){Te(n.$$.fragment,O),Te(s.$$.fragment,O),Te(m.$$.fragment,O),f=!1},d(O){O&&pe(e),Xe(n),Xe(s),Xe(m)}}}function z9(t,e,n){let{currentChat:r}=e,{chatHistoryStorage:s}=e,{promptStorage:a}=e,{settingStorage:i}=e,{documentVectorStorage:o}=e,{selectedModel:u}=e,{isSearchEnabled:c}=e,{isKnowledgeEnabled:l}=e,{imageUrl:d}=e,{fileContent:p}=e,{lute:m}=e,f=!1,g=!1;Bw(i.i18n);function b(K){const{message:oe}=K.detail,L=r.messages.findIndex(I=>I.id===oe.id);L!==-1&&(n(0,r.messages=r.messages.slice(0,L),r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"user",content:oe.content,image:oe.image||"",model:u,fileContent:oe.fileContent||""}],r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"assistant",content:"",model:u}],r),s.update(r),E())}function _(K){const{message:oe}=K.detail,L=r.messages.findIndex(I=>I.id===oe.id);L!==-1&&(n(0,r.messages=r.messages.slice(0,L),r),s.update(r))}async function E(){ml({apiKey:i.getValue("apiKey"),phone:i.getValue("phone"),model:r.model?r.model:u,maxTokens:i.getValue("maxOutputLengthChat"),temperature:i.getValue("temperatureChat"),timeout:i.getValue("responseTimeoutChat"),isSearch:c,isStream:!0,isClipboard:!0,isKnowledge:l,callback:(K,oe)=>{if(g)throw n(10,f=!1),new Error("User interrupted");n(0,r.messages[r.messages.length-1].content=K,r),n(0,r.messages[r.messages.length-1].model=u,r),s.update(r),n(10,f=oe)},knowledgeCallback:async K=>{const oe=await o.similaritySearchWithScore(K,i.getValue("knowledgeBaseRecallNumChat"));let L=[];for(const I of oe)I[1]<.7||L.push(I[0]);return L},messages:r.messages.slice(0,-1)})}async function T(K){if(!(f||!K.trim()))try{d&&n(0,r.model=Math.random()<.7?Tl[0]:Tl[Math.floor(Math.random()*(Tl.length-1))+1],r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"user",content:K,image:d,model:u,fileContent:p}],r),s.update(r),n(0,r.messages=[...r.messages,{id:Date.now(),role:"assistant",content:"",model:u}],r);try{if(d.length>0&&(n(0,r.title="",r),s.update(r)),await E(),r.messages.length>3&&r.messages.length<=5&&d.length==0){const oe=await FB([...r.messages,{role:"user",content:s.i18n.summaryPrompt}],i.getValue("apiKey"));n(0,r.title=oe,r)}}catch(oe){console.error("AI :",oe),n(0,r.messages=r.messages.slice(0,-1),r)}}finally{s.update(r),n(10,f=!1),n(11,g=!1),n(5,d="")}}function N(K){g=K,n(11,g)}function v(K){u=K,n(2,u)}function A(K){c=K,n(3,c)}function O(K){l=K,n(4,l)}function x(K){d=K,n(5,d)}function D(K){p=K,n(6,p)}function U(K){o=K,n(1,o)}const Q=async({detail:K})=>await T(K);return t.$$set=K=>{"currentChat"in K&&n(0,r=K.currentChat),"chatHistoryStorage"in K&&n(15,s=K.chatHistoryStorage),"promptStorage"in K&&n(7,a=K.promptStorage),"settingStorage"in K&&n(8,i=K.settingStorage),"documentVectorStorage"in K&&n(1,o=K.documentVectorStorage),"selectedModel"in K&&n(2,u=K.selectedModel),"isSearchEnabled"in K&&n(3,c=K.isSearchEnabled),"isKnowledgeEnabled"in K&&n(4,l=K.isKnowledgeEnabled),"imageUrl"in K&&n(5,d=K.imageUrl),"fileContent"in K&&n(6,p=K.fileContent),"lute"in K&&n(9,m=K.lute)},t.$$.update=()=>{t.$$.dirty&3072&&console.log(f,g)},[r,o,u,c,l,d,p,a,i,m,f,g,b,_,T,s,N,v,A,O,x,D,U,Q]}class W9 extends _t{constructor(e){super(),bt(this,e,z9,V9,gt,{currentChat:0,chatHistoryStorage:15,promptStorage:7,settingStorage:8,documentVectorStorage:1,selectedModel:2,isSearchEnabled:3,isKnowledgeEnabled:4,imageUrl:5,fileContent:6,lute:9})}}function G9(t){let e,n,r,s,a,i,o,u,c,l;function d(E){t[12](E)}let p={};t[0]!==void 0&&(p.chatHistoryStorage=t[0]),n=new zB({props:p}),Ne.push(()=>je(n,"chatHistoryStorage",d)),n.$on("selectChat",t[13]);function m(E){t[14](E)}function f(E){t[15](E)}function g(E){t[16](E)}function b(E){t[17](E)}let _={currentChat:t[5],promptStorage:t[3],settingStorage:t[2],selectedModel:t[8],isSearchEnabled:t[9],isKnowledgeEnabled:t[10],lute:t[4]};return t[0]!==void 0&&(_.chatHistoryStorage=t[0]),t[1]!==void 0&&(_.documentVectorStorage=t[1]),t[6]!==void 0&&(_.imageUrl=t[6]),t[7]!==void 0&&(_.fileContent=t[7]),a=new W9({props:_}),Ne.push(()=>je(a,"chatHistoryStorage",m)),Ne.push(()=>je(a,"documentVectorStorage",f)),Ne.push(()=>je(a,"imageUrl",g)),Ne.push(()=>je(a,"fileContent",b)),a.$on("messageUpdate",t[11]),a.$on("titleUpdate",t[11]),{c(){e=G("div"),et(n.$$.fragment),s=re(),et(a.$$.fragment),C(e,"class","chat-container svelte-wqoale")},m(E,T){ge(E,e,T),Je(n,e,null),R(e,s),Je(a,e,null),l=!0},p(E,[T]){const N={};!r&&T&1&&(r=!0,N.chatHistoryStorage=E[0],Ue(()=>r=!1)),n.$set(N);const v={};T&32&&(v.currentChat=E[5]),T&8&&(v.promptStorage=E[3]),T&4&&(v.settingStorage=E[2]),T&16&&(v.lute=E[4]),!i&&T&1&&(i=!0,v.chatHistoryStorage=E[0],Ue(()=>i=!1)),!o&&T&2&&(o=!0,v.documentVectorStorage=E[1],Ue(()=>o=!1)),!u&&T&64&&(u=!0,v.imageUrl=E[6],Ue(()=>u=!1)),!c&&T&128&&(c=!0,v.fileContent=E[7],Ue(()=>c=!1)),a.$set(v)},i(E){l||(he(n.$$.fragment,E),he(a.$$.fragment,E),l=!0)},o(E){Te(n.$$.fragment,E),Te(a.$$.fragment,E),l=!1},d(E){E&&pe(e),Xe(n),Xe(a)}}}function K9(t,e,n){let{settingStorage:r}=e,{chatHistoryStorage:s}=e,{promptStorage:a}=e,{documentVectorStorage:i}=e,{lute:o}=e,u=r.getValue("modelSelections"),c=s.dump(),l=c[0],d=r.getValue("isSearchChat"),p=r.getValue("isisKnowledgeBaseChat"),m="",f="";function g(){c=s.dump(),n(5,l=c.find(A=>A.id===l.id)||c[0])}function b(A){s=A,n(0,s)}const _=A=>n(5,l=A.detail);function E(A){s=A,n(0,s)}function T(A){i=A,n(1,i)}function N(A){m=A,n(6,m)}function v(A){f=A,n(7,f)}return t.$$set=A=>{"settingStorage"in A&&n(2,r=A.settingStorage),"chatHistoryStorage"in A&&n(0,s=A.chatHistoryStorage),"promptStorage"in A&&n(3,a=A.promptStorage),"documentVectorStorage"in A&&n(1,i=A.documentVectorStorage),"lute"in A&&n(4,o=A.lute)},[s,i,r,a,o,l,m,f,u,d,p,g,b,_,E,T,N,v]}class Y9 extends _t{constructor(e){super(),bt(this,e,K9,G9,gt,{settingStorage:2,chatHistoryStorage:0,promptStorage:3,documentVectorStorage:1,lute:4})}}function Z9(t){let e,n,r,s,a,i,o,u,c,l,d,p,m,f,g,b,_,E,T,N,v,A,O,x,D,U,Q;function K(L){t[21](L)}let oe={type:"select",key:"modelSelections",style:"font-size: 12px; border-radius: 4px; border: none ;outline: none;background: transparent; align-self: center;",fnSize:!1,options:t[5].get("modelSelections").options};return t[2]!==void 0&&(oe.value=t[2]),O=new Zi({props:oe}),Ne.push(()=>je(O,"value",K)),O.$on("changed",t[22]),{c(){e=G("div"),n=G("div"),r=G("textarea"),a=re(),i=G("div"),o=G("div"),u=G("button"),c=cn("svg"),l=cn("path"),d=re(),p=G("button"),m=cn("svg"),f=cn("path"),b=re(),_=G("button"),E=cn("svg"),T=cn("path"),v=re(),A=G("div"),et(O.$$.fragment),C(r,"placeholder",s=t[7].instructionInputPlaceholder),C(r,"class","svelte-1uickue"),C(n,"class","input svelte-1uickue"),C(l,"d","M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"),C(c,"viewBox","0 0 24 24"),C(c,"class","tools-icon svelte-1uickue"),Ce(c,"active",t[3]),C(u,"type","button"),C(u,"class","tools-button svelte-1uickue"),C(f,"d","M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"),C(m,"viewBox","0 0 24 24"),C(m,"class","tools-icon svelte-1uickue"),Ce(m,"active",t[8]),C(p,"title",g=t[7].onlineSearch),C(p,"type","button"),C(p,"class","tools-button svelte-1uickue"),Ce(p,"active",t[8]),C(T,"d","M21 5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5zm-2 14H5V5h14v14zM7 15h10v2H7v-2zm0-4h10v2H7v-2zm0-4h10v2H7V7z"),C(E,"viewBox","0 0 24 24"),C(E,"class","tools-icon svelte-1uickue"),Ce(E,"active",t[9]),C(_,"title",N=t[7].knowledgeBase),C(_,"type","button"),C(_,"class","tools-button svelte-1uickue"),Ce(_,"active",t[9]),C(o,"class","tools svelte-1uickue"),C(A,"class","models svelte-1uickue"),C(i,"class","tools-group svelte-1uickue"),C(e,"class","input-container svelte-1uickue")},m(L,I){ge(L,e,I),R(e,n),R(n,r),t[13](r),tn(r,t[0]),R(e,a),R(e,i),R(i,o),R(o,u),R(u,c),R(c,l),R(o,d),R(o,p),R(p,m),R(m,f),R(o,b),R(o,_),R(_,E),R(E,T),R(i,v),R(i,A),Je(O,A,null),D=!0,U||(Q=[ce(r,"input",t[14]),ce(r,"keydown",t[15]),ce(r,"focus",t[16]),ce(r,"blur",t[17]),ce(u,"click",t[18]),ce(p,"click",t[19]),ce(_,"click",t[20])],U=!0)},p(L,[I]){(!D||I&128&&s!==(s=L[7].instructionInputPlaceholder))&&C(r,"placeholder",s),I&1&&tn(r,L[0]),(!D||I&8)&&Ce(c,"active",L[3]),(!D||I&256)&&Ce(m,"active",L[8]),(!D||I&128&&g!==(g=L[7].onlineSearch))&&C(p,"title",g),(!D||I&256)&&Ce(p,"active",L[8]),(!D||I&512)&&Ce(E,"active",L[9]),(!D||I&128&&N!==(N=L[7].knowledgeBase))&&C(_,"title",N),(!D||I&512)&&Ce(_,"active",L[9]);const B={};I&32&&(B.options=L[5].get("modelSelections").options),!x&&I&4&&(x=!0,B.value=L[2],Ue(()=>x=!1)),O.$set(B)},i(L){D||(he(O.$$.fragment,L),D=!0)},o(L){Te(O.$$.fragment,L),D=!1},d(L){L&&pe(e),t[13](null),Xe(O),U=!1,ct(Q)}}}function J9(t,e,n){let{inputValue:r}=e,{inputElement:s}=e,{selectedModel:a}=e,{settingStorage:i}=e,{documentVectorStorage:o}=e,{showParams:u}=e,{handleSubmit:c}=e,{i18n:l}=e,{isFocused:d=!0}=e,p=i.getValue("isSearchInstruction"),m=i.getValue("isKnowledgeBaseInstruction");function f(){n(8,p=!p),i.setValue("isSearchInstruction",p),i.save()}async function g(){n(9,m=!m),i.setValue("isKnowledgeBaseInstruction",m),i.save(),m?await o.load():(await o.save(),await o.release())}function b(U){Ne[U?"unshift":"push"](()=>{s=U,n(1,s)})}function _(){r=this.value,n(0,r)}const E=U=>{U.key==="Enter"&&!U.shiftKey&&!U.isComposing&&(U.preventDefault(),c())},T=()=>{n(4,d=!0)},N=()=>{n(4,d=!1)},v=()=>{n(3,u=!u),u||i.save()},A=()=>{f()},O=()=>{g()};function x(U){a=U,n(2,a)}const D=({detail:U})=>{i.setValue(U.key,U.value),i.save()};return t.$$set=U=>{"inputValue"in U&&n(0,r=U.inputValue),"inputElement"in U&&n(1,s=U.inputElement),"selectedModel"in U&&n(2,a=U.selectedModel),"settingStorage"in U&&n(5,i=U.settingStorage),"documentVectorStorage"in U&&n(12,o=U.documentVectorStorage),"showParams"in U&&n(3,u=U.showParams),"handleSubmit"in U&&n(6,c=U.handleSubmit),"i18n"in U&&n(7,l=U.i18n),"isFocused"in U&&n(4,d=U.isFocused)},[r,s,a,u,d,i,c,l,p,m,f,g,o,b,_,E,T,N,v,A,O,x,D]}class X9 extends _t{constructor(e){super(),bt(this,e,J9,Z9,gt,{inputValue:0,inputElement:1,selectedModel:2,settingStorage:5,documentVectorStorage:12,showParams:3,handleSubmit:6,i18n:7,isFocused:4})}}function cb(t){let e,n,r=t[4]?"":"...",s,a,i,o;return{c(){e=G("div"),n=G("button"),s=Ze(r),C(n,"type","button"),C(n,"class","generation-text svelte-1t9569r"),C(n,"aria-label",a=t[4]?"":"..."),C(e,"class","generating svelte-1t9569r")},m(u,c){ge(u,e,c),R(e,n),R(n,s),i||(o=[ce(n,"mouseenter",t[8]),ce(n,"mouseleave",t[9]),ce(n,"click",t[5]),ce(n,"keydown",t[10])],i=!0)},p(u,c){c&16&&r!==(r=u[4]?"":"...")&&ht(s,r),c&16&&a!==(a=u[4]?"":"...")&&C(n,"aria-label",a)},d(u){u&&pe(e),i=!1,ct(o)}}}function Q9(t){let e,n,r=t[3].Md2HTML(t[1])+"",s,a=t[2]&&cb(t);return{c(){e=G("div"),n=G("div"),s=re(),a&&a.c(),C(n,"class","output svelte-1t9569r"),C(e,"class","output-container svelte-1t9569r")},m(i,o){ge(i,e,o),R(e,n),n.innerHTML=r,t[7](n),R(e,s),a&&a.m(e,null)},p(i,[o]){o&10&&r!==(r=i[3].Md2HTML(i[1])+"")&&(n.innerHTML=r),i[2]?a?a.p(i,o):(a=cb(i),a.c(),a.m(e,null)):a&&(a.d(1),a=null)},i:ut,o:ut,d(i){i&&pe(e),t[7](null),a&&a.d()}}}function eF(t,e,n){let{outputContent:r}=e,{isGenerating:s}=e,{outputContainer:a}=e,{lute:i}=e,{isInterrupted:o}=e,u=!1;function c(){n(6,o=!0)}function l(f){Ne[f?"unshift":"push"](()=>{a=f,n(0,a)})}const d=()=>n(4,u=!0),p=()=>n(4,u=!1),m=f=>f.key==="Enter"&&c();return t.$$set=f=>{"outputContent"in f&&n(1,r=f.outputContent),"isGenerating"in f&&n(2,s=f.isGenerating),"outputContainer"in f&&n(0,a=f.outputContainer),"lute"in f&&n(3,i=f.lute),"isInterrupted"in f&&n(6,o=f.isInterrupted)},[a,r,s,i,u,c,o,l,d,p,m]}class tF extends _t{constructor(e){super(),bt(this,e,eF,Q9,gt,{outputContent:1,isGenerating:2,outputContainer:0,lute:3,isInterrupted:6})}}function lb(t){let e,n,r,s,a;function i(l){t[18](l)}function o(l){t[19](l)}function u(l){t[20](l)}let c={outputContent:t[10],lute:t[3]};return t[12]!==void 0&&(c.isInterrupted=t[12]),t[11]!==void 0&&(c.isGenerating=t[11]),t[6]!==void 0&&(c.outputContainer=t[6]),e=new tF({props:c}),Ne.push(()=>je(e,"isInterrupted",i)),Ne.push(()=>je(e,"isGenerating",o)),Ne.push(()=>je(e,"outputContainer",u)),{c(){et(e.$$.fragment)},m(l,d){Je(e,l,d),a=!0},p(l,d){const p={};d[0]&1024&&(p.outputContent=l[10]),d[0]&8&&(p.lute=l[3]),!n&&d[0]&4096&&(n=!0,p.isInterrupted=l[12],Ue(()=>n=!1)),!r&&d[0]&2048&&(r=!0,p.isGenerating=l[11],Ue(()=>r=!1)),!s&&d[0]&64&&(s=!0,p.outputContainer=l[6],Ue(()=>s=!1)),e.$set(p)},i(l){a||(he(e.$$.fragment,l),a=!0)},o(l){Te(e.$$.fragment,l),a=!1},d(l){Xe(e,l)}}}function db(t){let e,n,r;function s(i){t[27](i)}let a={group:"instruction"};return t[0]!==void 0&&(a.settingStorage=t[0]),e=new $w({props:a}),Ne.push(()=>je(e,"settingStorage",s)),{c(){et(e.$$.fragment)},m(i,o){Je(e,i,o),r=!0},p(i,o){const u={};!n&&o[0]&1&&(n=!0,u.settingStorage=i[0],Ue(()=>n=!1)),e.$set(u)},i(i){r||(he(e.$$.fragment,i),r=!0)},o(i){Te(e.$$.fragment,i),r=!1},d(i){Xe(e,i)}}}function hb(t){let e,n,r,s,a;function i(l){t[28](l)}function o(l){t[29](l)}function u(l){t[30](l)}let c={};return t[7]!==void 0&&(c.inputAreaComponent=t[7]),t[4]!==void 0&&(c.searchText=t[4]),t[1]!==void 0&&(c.promptStorage=t[1]),e=new qw({props:c}),Ne.push(()=>je(e,"inputAreaComponent",i)),Ne.push(()=>je(e,"searchText",o)),Ne.push(()=>je(e,"promptStorage",u)),{c(){et(e.$$.fragment)},m(l,d){Je(e,l,d),a=!0},p(l,d){const p={};!n&&d[0]&128&&(n=!0,p.inputAreaComponent=l[7],Ue(()=>n=!1)),!r&&d[0]&16&&(r=!0,p.searchText=l[4],Ue(()=>r=!1)),!s&&d[0]&2&&(s=!0,p.promptStorage=l[1],Ue(()=>s=!1)),e.$set(p)},i(l){a||(he(e.$$.fragment,l),a=!0)},o(l){Te(e.$$.fragment,l),a=!1},d(l){Xe(e,l)}}}function nF(t){let e,n,r,s,a,i,o,u,c,l,d,p,m,f=t[9]&&lb(t);function g(x){t[21](x)}function b(x){t[22](x)}function _(x){t[23](x)}function E(x){t[24](x)}function T(x){t[25](x)}function N(x){t[26](x)}let v={handleSubmit:t[15],i18n:t[14]};t[4]!==void 0&&(v.inputValue=t[4]),t[7]!==void 0&&(v.inputElement=t[7]),t[8]!==void 0&&(v.selectedModel=t[8]),t[0]!==void 0&&(v.settingStorage=t[0]),t[2]!==void 0&&(v.documentVectorStorage=t[2]),t[5]!==void 0&&(v.showParams=t[5]),r=new X9({props:v}),Ne.push(()=>je(r,"inputValue",g)),Ne.push(()=>je(r,"inputElement",b)),Ne.push(()=>je(r,"selectedModel",_)),Ne.push(()=>je(r,"settingStorage",E)),Ne.push(()=>je(r,"documentVectorStorage",T)),Ne.push(()=>je(r,"showParams",N));let A=t[5]&&db(t),O=t[13]&&hb(t);return{c(){e=G("div"),f&&f.c(),n=re(),et(r.$$.fragment),l=re(),d=G("div"),A&&A.c(),p=re(),O&&O.c(),Ut(d,"width","100%"),C(e,"class","instruction-container svelte-1dkyoze")},m(x,D){ge(x,e,D),f&&f.m(e,null),R(e,n),Je(r,e,null),R(e,l),R(e,d),A&&A.m(d,null),R(d,p),O&&O.m(d,null),m=!0},p(x,D){x[9]?f?(f.p(x,D),D[0]&512&&he(f,1)):(f=lb(x),f.c(),he(f,1),f.m(e,n)):f&&(cs(),Te(f,1,1,()=>{f=null}),ls());const U={};!s&&D[0]&16&&(s=!0,U.inputValue=x[4],Ue(()=>s=!1)),!a&&D[0]&128&&(a=!0,U.inputElement=x[7],Ue(()=>a=!1)),!i&&D[0]&256&&(i=!0,U.selectedModel=x[8],Ue(()=>i=!1)),!o&&D[0]&1&&(o=!0,U.settingStorage=x[0],Ue(()=>o=!1)),!u&&D[0]&4&&(u=!0,U.documentVectorStorage=x[2],Ue(()=>u=!1)),!c&&D[0]&32&&(c=!0,U.showParams=x[5],Ue(()=>c=!1)),r.$set(U),x[5]?A?(A.p(x,D),D[0]&32&&he(A,1)):(A=db(x),A.c(),he(A,1),A.m(d,p)):A&&(cs(),Te(A,1,1,()=>{A=null}),ls()),x[13]?O?(O.p(x,D),D[0]&8192&&he(O,1)):(O=hb(x),O.c(),he(O,1),O.m(d,null)):O&&(cs(),Te(O,1,1,()=>{O=null}),ls())},i(x){m||(he(f),he(r.$$.fragment,x),he(A),he(O),m=!0)},o(x){Te(f),Te(r.$$.fragment,x),Te(A),Te(O),m=!1},d(x){x&&pe(e),f&&f.d(),Xe(r),A&&A.d(),O&&O.d()}}}function rF(t,e,n){let r,{settingStorage:s}=e,{promptStorage:a}=e,{documentVectorStorage:i}=e,{lute:o}=e,{selectedText:u}=e,{pageContent:c}=e;Bw(s.i18n);let l=s.i18n,d,p="",m=!1,f=s.getValue("modelSelections"),g=!1,b="",_=!1,E=!1,T;async function N(){n(9,g=!0),n(11,_=!0),n(10,b="");let z=p.startsWith("/")?p.slice(1):p,ne=[];u.trim().length>0?ne.push({role:"user",content:`${u}

${z}`}):s.getValue("isPageContent")?ne.push({role:"user",content:`${c.title}

${c.content}

${z}`}):ne.push({role:"user",content:`${z}`});try{await ml({apiKey:s.getValue("apiKey"),phone:s.getValue("phone"),model:f,maxTokens:s.getValue("maxOutputLengthInstruction"),temperature:s.getValue("temperatureInstruction"),timeout:s.getValue("responseTimeoutInstruction"),isSearch:s.getValue("isSearchInstruction"),isStream:!0,isClipboard:!0,isKnowledge:s.getValue("isKnowledgeBaseInstruction"),callback:(ke,Se)=>{if(E)throw new Error("User interrupted");n(10,b=ke),T&&!v&&n(6,T.scrollTop=T.scrollHeight,T)},knowledgeCallback:async ke=>{const Se=await i.similaritySearchWithScore(ke,s.getValue("knowledgeBaseRecallNumInstruction"));let yt=[];for(const Ot of Se)Ot[1]<.7||yt.push(Ot[0]);return yt},messages:ne})}finally{n(11,_=!1)}}let v=!1,A=0;function O(z){z&&z.addEventListener("scroll",()=>{z.scrollTop<A&&(v=!0),A=z.scrollTop,z.scrollHeight-z.scrollTop-z.clientHeight<50&&(v=!1)})}Cc(()=>{d.focus()});function x(z){E=z,n(12,E)}function D(z){_=z,n(11,_)}function U(z){T=z,n(6,T)}function Q(z){p=z,n(4,p)}function K(z){d=z,n(7,d)}function oe(z){f=z,n(8,f)}function L(z){s=z,n(0,s)}function I(z){i=z,n(2,i)}function B(z){m=z,n(5,m)}function q(z){s=z,n(0,s)}function M(z){d=z,n(7,d)}function V(z){p=z,n(4,p)}function X(z){a=z,n(1,a)}return t.$$set=z=>{"settingStorage"in z&&n(0,s=z.settingStorage),"promptStorage"in z&&n(1,a=z.promptStorage),"documentVectorStorage"in z&&n(2,i=z.documentVectorStorage),"lute"in z&&n(3,o=z.lute),"selectedText"in z&&n(16,u=z.selectedText),"pageContent"in z&&n(17,c=z.pageContent)},t.$$.update=()=>{t.$$.dirty[0]&48&&n(13,r=p.trim().startsWith("/")&&!m),t.$$.dirty[0]&64&&T&&O(T)},[s,a,i,o,p,m,T,d,f,g,b,_,E,r,l,N,u,c,x,D,U,Q,K,oe,L,I,B,q,M,V,X]}class sF extends _t{constructor(e){super(),bt(this,e,rF,nF,gt,{settingStorage:0,promptStorage:1,documentVectorStorage:2,lute:3,selectedText:16,pageContent:17},null,[-1,-1])}}function fb(t,e,n){const r=new Dn.Dialog({title:"",content:'<div id="ai-instruction"></div>',width:"40%",hideCloseIcon:!0}),s=MA(),a=BA();t.getValue("apiKey").trim().length<=0&&eo("API Key"),new sF({target:r.element.querySelector("#ai-instruction"),props:{settingStorage:t,promptStorage:e,documentVectorStorage:n,selectedText:s,pageContent:a,lute:window.Lute.New()}})}function mb(t,e,n,r){const s=new Dn.Dialog({title:"",content:'<div id="ai-chat" style="height: 100%; margin: 0; padding: 0; overflow: hidden; display:flex;min-height: 0;"></div>',width:"50%",height:"60%",hideCloseIcon:!0});new Y9({target:s.element.querySelector("#ai-chat"),props:{settingStorage:t,chatHistoryStorage:e,promptStorage:n,documentVectorStorage:r,lute:window.Lute.New()}})}function pb(t,e,n){const r=t.slice();return r[8]=e[n],r}function gb(t){let e,n,r=t[0].i18n.settingGroup+"",s,a,i,o;function u(){return t[4](t[8])}return{c(){e=G("li"),n=G("span"),s=Ze(r),a=re(),C(n,"class","b3-list-item__text"),C(e,"data-name","editor"),C(e,"class","b3-list-item"),Ce(e,"b3-list-item--focus",t[8]===t[2])},m(c,l){ge(c,e,l),R(e,n),R(n,s),R(e,a),i||(o=[ce(e,"click",u),ce(e,"keydown",iF)],i=!0)},p(c,l){t=c,l&1&&r!==(r=t[0].i18n.settingGroup+"")&&ht(s,r),l&12&&Ce(e,"b3-list-item--focus",t[8]===t[2])},d(c){c&&pe(e),i=!1,ct(o)}}}function aF(t){let e,n,r,s,a,i,o,u,c,l,d,p,m,f,g=Cn(t[3]),b=[];for(let _=0;_<g.length;_+=1)b[_]=gb(pb(t,g,_));return a=new jw({props:{group:t[3][0],settingStorage:t[0],display:t[2]===t[3][0]}}),a.$on("changed",t[5]),u=new gc({props:{label:t[0].i18n.cancel,text:!0,outline:!0}}),u.$on("click",t[6]),p=new gc({props:{label:t[0].i18n.confirm,text:!1,outline:!1}}),p.$on("click",t[7]),{c(){e=G("div"),n=G("ul");for(let _=0;_<b.length;_+=1)b[_].c();r=re(),s=G("div"),et(a.$$.fragment),i=re(),o=G("div"),et(u.$$.fragment),c=re(),l=G("div"),d=re(),et(p.$$.fragment),C(n,"class","b3-tab-bar b3-list b3-list--background"),C(l,"class","fn__space"),C(o,"class",m="b3-dialog__action "+(t[2]==t[3][0]?"":"fn__none")),C(s,"class","config__tab-wrap"),C(e,"class","fn__flex-1 fn__flex config__panel")},m(_,E){ge(_,e,E),R(e,n);for(let T=0;T<b.length;T+=1)b[T]&&b[T].m(n,null);R(e,r),R(e,s),Je(a,s,null),R(s,i),R(s,o),Je(u,o,null),R(o,c),R(o,l),R(o,d),Je(p,o,null),f=!0},p(_,[E]){if(E&13){g=Cn(_[3]);let A;for(A=0;A<g.length;A+=1){const O=pb(_,g,A);b[A]?b[A].p(O,E):(b[A]=gb(O),b[A].c(),b[A].m(n,null))}for(;A<b.length;A+=1)b[A].d(1);b.length=g.length}const T={};E&1&&(T.settingStorage=_[0]),E&4&&(T.display=_[2]===_[3][0]),a.$set(T);const N={};E&1&&(N.label=_[0].i18n.cancel),u.$set(N);const v={};E&1&&(v.label=_[0].i18n.confirm),p.$set(v),(!f||E&4&&m!==(m="b3-dialog__action "+(_[2]==_[3][0]?"":"fn__none")))&&C(o,"class",m)},i(_){f||(he(a.$$.fragment,_),he(u.$$.fragment,_),he(p.$$.fragment,_),f=!0)},o(_){Te(a.$$.fragment,_),Te(u.$$.fragment,_),Te(p.$$.fragment,_),f=!1},d(_){_&&pe(e),Sc(b,_),Xe(a),Xe(u),Xe(p)}}}const iF=()=>{};function oF(t,e,n){let r=[" "],s=r[0],{settingStorage:a}=e,{dialog:i}=e;const o=d=>{n(2,s=d)},u=({detail:d})=>{a.setValue(d.key,d.value)},c=()=>{a.load(),i.destroy()},l=()=>{a.save(),i.destroy()};return t.$$set=d=>{"settingStorage"in d&&n(0,a=d.settingStorage),"dialog"in d&&n(1,i=d.dialog)},[a,i,s,r,o,u,c,l]}class uF extends _t{constructor(e){super(),bt(this,e,oF,aF,gt,{settingStorage:0,dialog:1})}}const cF=`<symbol id="iconFace" viewBox="0 0 32 32">
<path d="M13.667 17.333c0 0.92-0.747 1.667-1.667 1.667s-1.667-0.747-1.667-1.667 0.747-1.667 1.667-1.667 1.667 0.747 1.667 1.667zM20 15.667c-0.92 0-1.667 0.747-1.667 1.667s0.747 1.667 1.667 1.667 1.667-0.747 1.667-1.667-0.747-1.667-1.667-1.667zM29.333 16c0 7.36-5.973 13.333-13.333 13.333s-13.333-5.973-13.333-13.333 5.973-13.333 13.333-13.333 13.333 5.973 13.333 13.333zM14.213 5.493c1.867 3.093 5.253 5.173 9.12 5.173 0.613 0 1.213-0.067 1.787-0.16-1.867-3.093-5.253-5.173-9.12-5.173-0.613 0-1.213 0.067-1.787 0.16zM5.893 12.627c2.28-1.293 4.040-3.4 4.88-5.92-2.28 1.293-4.040 3.4-4.88 5.92zM26.667 16c0-1.040-0.16-2.040-0.44-2.987-0.933 0.2-1.893 0.32-2.893 0.32-4.173 0-7.893-1.92-10.347-4.92-1.4 3.413-4.187 6.093-7.653 7.4 0.013 0.053 0 0.12 0 0.187 0 5.88 4.787 10.667 10.667 10.667s10.667-4.787 10.667-10.667z"></path>
</symbol>`,lF=`<symbol id="iconSaving" viewBox="0 0 32 32">
<path d="M20 13.333c0-0.733 0.6-1.333 1.333-1.333s1.333 0.6 1.333 1.333c0 0.733-0.6 1.333-1.333 1.333s-1.333-0.6-1.333-1.333zM10.667 12h6.667v-2.667h-6.667v2.667zM29.333 10v9.293l-3.76 1.253-2.24 7.453h-7.333v-2.667h-2.667v2.667h-7.333c0 0-3.333-11.28-3.333-15.333s3.28-7.333 7.333-7.333h6.667c1.213-1.613 3.147-2.667 5.333-2.667 1.107 0 2 0.893 2 2 0 0.28-0.053 0.533-0.16 0.773-0.187 0.453-0.347 0.973-0.427 1.533l3.027 3.027h2.893zM26.667 12.667h-1.333l-4.667-4.667c0-0.867 0.12-1.72 0.347-2.547-1.293 0.333-2.347 1.293-2.787 2.547h-8.227c-2.573 0-4.667 2.093-4.667 4.667 0 2.507 1.627 8.867 2.68 12.667h2.653v-2.667h8v2.667h2.68l2.067-6.867 3.253-1.093v-4.707z"></path>
</symbol>`,dF=`<symbol id="iconChat" viewBox="0 0 32 32">
  <path d="M16 2C8.268 2 2 8.268 2 16c0 2.25.54 4.373 1.5 6.25L1 29l6.75-2.5c1.876.96 4 1.5 6.25 1.5 7.732 0 14-6.268 14-14S23.732 2 16 2zm0 2c6.627 0 12 5.373 12 12s-5.373 12-12 12c-2.027 0-3.93-.506-5.602-1.397l-.467-.25-4.18 1.547 1.547-4.18-.25-.467C5.506 21.93 5 20.027 5 18c0-6.627 5.373-12 12-12zm-5 10v4h3v-4h-3zm7 0v4h3v-4h-3z"></path>
</symbol>
`,hF=`<symbol id="iconInstruction" viewBox="0 0 32 32">
  <path d="M28 16c0 6.627-5.373 12-12 12S4 22.627 4 16 9.373 4 16 4s12 5.373 12 12zM16 2C8.268 2 2 8.268 2 16s6.268 14 14 14 14-6.268 14-14S23.732 2 16 2zm-2 9.5v3h-2v3h2v3h4v-3h2v-3h-2v-3h-4zm1 1h2v2h2v1h-2v2h-2v-2h-2v-1h2v-2z"/>
</symbol>`;class fF extends Dn.Plugin{constructor(n){super(n);ve(this,"_isMobile");ve(this,"_settingStorage");ve(this,"_promptStorage");ve(this,"_chatHistoryStorage");ve(this,"_documentVectorStorage");ve(this,"_blockStorage");ve(this,"_apiClient");this._apiClient=new PA,this._settingStorage=new HB(this,Hd),this._promptStorage=new $B(this,qd),this._chatHistoryStorage=new jB(this,e_),this._isMobile=Dn.getFrontend()==="mobile"||Dn.getFrontend()==="browser-mobile"}async onload(){console.debug("onload...."),await this._settingStorage.load(),this.addIcons(cF),this.addIcons(lF),this.addIcons(dF),this.addIcons(hF),this.addTopBar({icon:"iconInstruction",title:this.i18n.instructionMode,position:"right",callback:()=>fb(this._settingStorage,this._promptStorage,this._documentVectorStorage)}),this.addTopBar({icon:"iconChat",title:"",position:"right",callback:()=>mb(this._settingStorage,this._chatHistoryStorage,this._promptStorage,this._documentVectorStorage)});const n=this._settingStorage.getValue("isVectorOnline"),r=this._settingStorage.getValue("phoneNumber"),s=this._settingStorage.getValue("apiKey"),a=this._settingStorage.getValue("includeKnowledgeBook"),i=this._settingStorage.getValue("excludeKnowledgeBook"),o=await Ji(s);o.money<=0&&Xs(this.i18n.balanceInsufficientMsg.replace("${balance}",String(Math.round(o.money*10)/10))),o.expiredTime<Math.floor(Date.now()/1e3)&&Xs(this.i18n.apiKeyExpiredMsg),n&&r?this._documentVectorStorage=new v9(this,Vd,s,r):this._documentVectorStorage=new O9(this,Vd,s,r),this._blockStorage=new UB(this,t_,s,this._documentVectorStorage,a,i),Ji(s).then(u=>{u.money>0&&u.expiredTime>Math.floor(Date.now()/1e3)&&(console.debug("apiKey "),this._blockStorage.load(),this._promptStorage.load(),this._chatHistoryStorage.load())}),this.addCommand({langKey:"",hotkey:"K",callback:()=>fb(this._settingStorage,this._promptStorage,this._documentVectorStorage)}),this.addCommand({langKey:"",hotkey:"L",callback:()=>mb(this._settingStorage,this._chatHistoryStorage,this._promptStorage,this._documentVectorStorage)}),this.addCommand({langKey:"",hotkey:"I",callback:()=>{this._settingStorage,this._chatHistoryStorage,this._promptStorage,this._documentVectorStorage}}),console.debug("onload....end")}onLayoutReady(){}uninstall(){this.removeData(Hd),this.removeData(qd),eo("AI")}openSetting(){if(!this._settingStorage)return;if(this._isMobile){Xs("");return}let n=new Dn.Dialog({title:"AI",width:"70%",height:"60%",content:'<div class="b3-dialog__content" id="AISettingPanel" ></div>'});new uF({target:n.element.querySelector("#AISettingPanel"),props:{settingStorage:this._settingStorage,dialog:n}})}}module.exports=fF;
